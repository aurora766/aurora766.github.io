<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>AurorağŸ¥</title>
  
  
  <link href="https://www.fomal.cc/atom.xml" rel="self"/>
  
  <link href="https://www.fomal.cc/"/>
  <updated>2024-09-22T07:53:34.231Z</updated>
  <id>https://www.fomal.cc/</id>
  
  <author>
    <name>Aurora ğŸ¥</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ğŸ‰5ã€Podçš„é’©å­å’Œæ¢é’ˆ</title>
    <link href="https://www.fomal.cc/posts/feb758ca.html"/>
    <id>https://www.fomal.cc/posts/feb758ca.html</id>
    <published>2024-09-22T06:46:01.000Z</published>
    <updated>2024-09-22T07:53:34.231Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Podçš„é’©å­å’Œæ¢é’ˆ">Podçš„é’©å­å’Œæ¢é’ˆ</h2><h3 id="1ã€podçš„ç”Ÿå‘½å‘¨æœŸ">1ã€<strong>podçš„ç”Ÿå‘½å‘¨æœŸ</strong></h3><p><img src="../image/study_img/image-20240920083828296.png" alt="image-20240920083828296"></p><p><img src="../image/study_img/image-20240920083900491.png" alt="image-20240920083900491"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ç”Ÿå‘½å‘¨æœŸé‡Œé¢åŒ…å«çš„ä¸œè¥¿</span><br><span class="line">1ã€åˆå§‹åŒ–å®¹å™¨</span><br><span class="line">2ã€2ä¸ªé’©å­</span><br><span class="line">   - start hook</span><br><span class="line">   - stop hook</span><br><span class="line"></span><br><span class="line"><span class="comment">#init container</span></span><br><span class="line">åˆå§‹åŒ–å®¹å™¨çš„ä½œç”¨ï¼šä¸»å®¹å™¨å¯åŠ¨ä¹‹å‰ï¼Œå¯ä»¥è®©ä»–åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚</span><br><span class="line">æ¯”å¦‚ï¼š</span><br><span class="line">1ã€åˆ›å»ºç”¨æˆ·ï¼Œå®¹å™¨çš„ç»Ÿä¸€ç”¨æˆ·</span><br><span class="line">2ã€2ä¸ªå®¹å™¨åšäº†å…±äº«å‚¨å­˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è®©ä»–å…ˆå¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œæ¥å¯¹ç›®å½•è¿›è¡Œæ›´æ”¹å’Œæˆæƒ</span><br><span class="line">3ã€å®¹å™¨éœ€è¦è¿æ¥æ•°æ®åº“ï¼Œå¯ä»¥è®©åˆå§‹åŒ–å®¹å™¨æ£€æµ‹æ•°æ®åº“æ˜¯å¦å¯ä»¥æ­£å¸¸è¿æ¥ï¼Œå¦‚æœå¯ä»¥å†å¯åŠ¨ä¸»å®¹å™¨</span><br><span class="line"></span><br><span class="line"><span class="comment">#hook</span></span><br><span class="line">Poststartï¼šåœ¨å®¹å™¨åˆ›å»ºåï¼Œç«‹å³æ‰§è¡Œï¼Œä½†æ—¶é—´ä¸èƒ½å¤ªä¹…ï¼Œå¦åˆ™å®¹å™¨ä¸ä¼šæ˜¯runningçŠ¶æ€</span><br><span class="line">Prestartï¼šåœ¨å®¹å™¨åœæ­¢å‰ï¼Œæ‰§è¡Œä¸€äº›å‘½ä»¤ï¼Œä¸»è¦ç”¨äºä¼˜é›…å…³é—­è¿›ç¨‹</span><br><span class="line"></span><br><span class="line"><span class="comment">#Liveness probe</span></span><br><span class="line">å­˜æ´»æ¢é’ˆï¼Œç”¨äºå®šä¹‰å®¹å™¨å†…ï¼Œåº”ç”¨æ˜¯å¦æ»¡è¶³æ¢é’ˆçŠ¶æ€</span><br><span class="line"></span><br><span class="line"><span class="comment">#rediness probe</span></span><br><span class="line">å°±ç»ªæ¢é’ˆï¼ŒæŒ‡å®šä½•æ—¶å…è®¸å®¹å™¨è¿›å…¥æµé‡</span><br></pre></td></tr></table></figure><h3 id="2ã€åˆå§‹åŒ–å®¹å™¨">2ã€<strong>åˆå§‹åŒ–å®¹å™¨</strong></h3><ul><li>åˆ©ç”¨åˆå§‹åŒ–å®¹å™¨æ›´æ”¹nginxé¡µé¢</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åˆ©ç”¨åˆå§‹åŒ–å®¹å™¨æ›´æ”¹nginxé¡µé¢</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸»å®¹å™¨å¯åŠ¨ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥è®©ä»–åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œåˆå§‹åŒ–å®¹å™¨æ‰§è¡Œå®Œæˆåå°±ç»“æŸé€€å‡º</span></span><br><span class="line"></span><br><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim init-container.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: init-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">#æŒ‡å®šä¸€ä¸ªåˆå§‹åŒ–å®¹å™¨ï¼šåˆå§‹åŒ–å®¹å™¨çš„å†™æ³•å’Œä¸‹é¢å®¹å™¨çš„å†™æ³•æ˜¯ä¸€æ ·çš„</span></span><br><span class="line">  initContainers:</span><br><span class="line">  - name: initcontainer</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s åˆå§‹åŒ–å®¹å™¨&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">  - name: c7-container</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œå®¹å™¨ï¼ŒæŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f init-container.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -owide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE    IP          NODE</span><br><span class="line">init-pod    2/2     Running   0          2m1s   10.2.2.6    node02</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.2.6</span><br><span class="line"><span class="built_in">test</span> k8s åˆå§‹åŒ–å®¹å™¨</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it init-pod -c c7-container -- /bin/bash</span><br><span class="line">[root@init-pod /]# <span class="built_in">cat</span> /usr/share/nginx/html/index.html </span><br><span class="line"><span class="built_in">test</span> k8s åˆå§‹åŒ–å®¹å™¨</span><br><span class="line"></span><br><span class="line">ç°åœ¨ç›¸å½“äº3ä¸ªå®¹å™¨åŒæ—¶æŒ‚è½½åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼ŒåŒæ—¶ä¹Ÿç›¸å½“äºæŒ‚è½½åˆ°å®¿ä¸»æœºçš„ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼Œä»–ä»¬3çš„ç›®å½•åšäº†å…±äº«</span><br><span class="line"></span><br><span class="line">æ¯”å¦‚è¯´èµ·ä¸ªnginxå’Œphpå®¹å™¨ï¼Œå®¹å™¨çš„æ–‡ä»¶äº’ç›¸éš”ç¦»ï¼Œä»£ç å°±ä¸å…±äº«ï¼Œé‚£ä»£ç éƒ¨ç½²åœ¨å“ªé‡Œå‘¢ï¼Œå¦‚æœéƒ¨ç½²åœ¨nginxä¸Šï¼Œphpæ‰æ˜¯è§£æä»£ç çš„ï¼Œwordpressä¸æ˜¯å‰åç«¯åˆ†ç¦»çš„ï¼Œnginxé…ç½®æ–‡ä»¶å°±ä¸èƒ½ç”¨socketè¿æ¥phpäº†ï¼Œè¦ç”¨fastcgi_pass xx.xx.xx.xx:900,ä»£ç å¿…é¡»2è¾¹éƒ½è¦å­˜</span><br></pre></td></tr></table></figure><h3 id="3ã€é’©å­">3ã€<strong>é’©å­</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¯åŠ¨é’©å­  poststart  å¯åŠ¨ä¹‹å</span></span><br><span class="line">lifecycle: </span><br><span class="line">  preStart: </span><br><span class="line">    <span class="built_in">exec</span>:</span><br><span class="line">    httpGet: </span><br><span class="line">    tcpSocket </span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>ï¼šæ‰§è¡Œå‘½ä»¤</span><br><span class="line">httpGetï¼šæ£€æµ‹HTTPï¼Œæ¯”å¦‚æ£€æµ‹ç½‘ç«™çš„80ï¼Œ443ç«¯å£ï¼Œè¦æ±‚webé¡µé¢çŠ¶æ€ç è¿”å›æ˜¯ä¸æ˜¯404ï¼Œ200ï¼Œä¸€èˆ¬åœ¨æ¢é’ˆé‡Œç”¨</span><br><span class="line">tcpSocketï¼šæ£€æµ‹ç«¯å£é€šä¸é€šï¼Œæ¯”å¦‚æ£€æµ‹æ•°æ®åº“æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¦‚æœç”¨httpgetä¸è¡Œ</span><br><span class="line"></span><br><span class="line"><span class="comment">#åœæ­¢é’©å­   preStop   åœæ­¢ä¹‹å‰</span></span><br><span class="line">lifecycle: </span><br><span class="line">  preStop: </span><br><span class="line">    <span class="built_in">exec</span>:</span><br><span class="line">    httpGet: </span><br><span class="line">    tcpSocket</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨å¯åŠ¨é’©å­åœ¨ä¸€ä¸ªpodé‡Œç»Ÿä¸€å¤šä¸ªå®¹å™¨çš„ç”¨æˆ·</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cp</span> init-container.yml poststart.yml</span><br><span class="line">[root@master01 kubernetes]# vim poststart.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: poststart-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  <span class="comment">#è¿™é‡ŒæŒ‚è½½ç›®å½•å¯ä»¥æ˜¯ä¸´æ—¶çš„</span></span><br><span class="line">  - name: nginx-data</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">  initContainers:</span><br><span class="line">  - name: initcontainer</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s ä½¿ç”¨å¯åŠ¨é’©å­åœ¨ä¸€ä¸ªpodé‡Œç»Ÿä¸€å¤šä¸ªå®¹å™¨çš„ç”¨æˆ·&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="comment">#nginxå¯åŠ¨ä¹‹åçš„é’©å­å†™æ³•:ç»Ÿä¸€å®¹å™¨çš„ç”¨æˆ·</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">     <span class="comment">#nginxé‡Œé¢ä¸€å¼€å§‹å†™useraddå‘½ä»¤åˆ›å»ºç”¨æˆ·ï¼Œä½†æ˜¯è¿™ä¸ªå®¹å™¨é‡Œé¢æ²¡æœ‰useraddå‘½ä»¤ï¼Œä¼šæŠ¥é”™ã€‚æ‰€ä»¥åªèƒ½ç”¨æ”¹ç»„ã€ç”¨æˆ·æœ‰å…³çš„é…ç½®æ–‡ä»¶å»æ·»åŠ ç”¨æˆ·</span></span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;www:x:666&#x27; &gt;&gt; /etc/group &amp;&amp; echo &#x27;www:x:666:666::/home/www:/sbin/nologin&#x27; &gt;&gt; /etc/passwd&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">  - name: c7-container</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line">    <span class="comment">#C7å¯åŠ¨ä¹‹åçš„é’©å­å†™æ³•:ç»Ÿä¸€å®¹å™¨çš„ç”¨æˆ·</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>: </span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;groupadd www -g 666 &amp;&amp; useradd www -u 666 -g 666 -s /sbin/nologin -M&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œå®¹å™¨ï¼ŒæŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f  poststart.yml </span><br><span class="line">pod/poststart-pod created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod poststart-pod -owide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE   IP          NODE  </span><br><span class="line">poststart-pod   2/2     Running   0          33s   10.2.3.33   node03</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.3.33</span><br><span class="line"><span class="built_in">test</span> k8s ä½¿ç”¨å¯åŠ¨é’©å­åœ¨ä¸€ä¸ªpodé‡Œç»Ÿä¸€å¤šä¸ªå®¹å™¨çš„ç”¨æˆ·</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it poststart-pod -c c7-container -- /bin/bash</span><br><span class="line">[root@poststart-pod /]# <span class="built_in">id</span> www</span><br><span class="line">uid=666(www) gid=666(www) <span class="built_in">groups</span>=666(www)</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it poststart-pod -c nginx-container -- /bin/sh</span><br><span class="line">/ <span class="comment"># id www</span></span><br><span class="line">uid=666(www) gid=666 <span class="built_in">groups</span>=666</span><br></pre></td></tr></table></figure><ul><li>åœæ­¢é’©å­  å®¹å™¨åœæ­¢ä¹‹å‰æ‰“å°æŒ‡å®šå†…å®¹åˆ°æ–‡ä»¶  (ä¸å¸¸ç”¨ï¼Œæ²¡ä»€ä¹ˆåº”ç”¨åœºæ™¯)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cp</span> poststart.yml poststop.yml</span><br><span class="line">[root@master01 kubernetes]# vim prestop.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: poststop-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  <span class="comment">#ä¸ºäº†æ»¡è¶³åœæ­¢ä¹‹å‰echoå†…å®¹åˆ°æŒ‚è½½ç›®å½•ï¼Œæ‰€ä»¥è¿™é‡Œçš„æŒ‚è½½ç›®å½•éœ€è¦æŒä¹…åŒ–</span></span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">  initContainers:</span><br><span class="line">  - name: initcontainer</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s ä½¿ç”¨å¯åŠ¨é’©å­åœ¨ä¸€ä¸ªpodé‡Œç»Ÿä¸€å¤šä¸ªå®¹å™¨çš„ç”¨æˆ·&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;www:x:666&#x27; &gt;&gt; /etc/group &amp;&amp; echo &#x27;www:x:666:666::/home/www:/sbin/nologin&#x27; &gt;&gt; /etc/passwd&quot;</span>]</span><br><span class="line"><span class="comment">#å®¹å™¨åœæ­¢ä¹‹å‰åšçš„äº‹æƒ…</span></span><br><span class="line">      preStop:</span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s ä½¿ç”¨åœæ­¢é’©å­ä½¿podåœ¨åœæ­¢ä¹‹å‰æ‰“å°  bye&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">  - name: c7-container</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line">    <span class="comment">#C7å¯åŠ¨ä¹‹åçš„é’©å­å†™æ³•:ç»Ÿä¸€å®¹å™¨çš„ç”¨æˆ·</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>: </span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;groupadd www -g 666 &amp;&amp; useradd www -u 666 -g 666 -s /sbin/nologin -M&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line"> 2ã€æŸ¥çœ‹  </span><br><span class="line">[root@node03 ~]# <span class="built_in">rm</span> -rf /data/nginx/index.html</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod poststop-pod -owide</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP          NODE  </span><br><span class="line">poststop-pod   2/2     Running   0          40s   10.2.3.34   node03</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.3.34</span><br><span class="line"><span class="built_in">test</span> k8s ä½¿ç”¨å¯åŠ¨é’©å­åœ¨ä¸€ä¸ªpodé‡Œç»Ÿä¸€å¤šä¸ªå®¹å™¨çš„ç”¨æˆ·</span><br><span class="line"></span><br><span class="line">3ã€ç°åœ¨curlå‡ºæ¥çš„ç»“æœè¿˜æ²¡æœ‰æ”¹å˜ï¼Œéœ€è¦åˆ é™¤è¿™ä¸ªpodï¼Œæ‰ä¼šå‘ç”Ÿæ”¹å˜ï¼Œåˆ æ‰ä¹‹åå®¹å™¨ä¸åœ¨äº†ï¼Œä¸èƒ½ç”¨curl,åªèƒ½åˆ°æŒ‚è½½ç›®å½•å»çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod poststop-pod</span><br><span class="line"></span><br><span class="line">[root@node03 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s ä½¿ç”¨åœæ­¢é’©å­ä½¿podåœ¨åœæ­¢ä¹‹å‰æ‰“å° <span class="built_in">bye</span></span><br></pre></td></tr></table></figure><h3 id="4ã€æ¢é’ˆ">4ã€<strong>æ¢é’ˆ</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å­˜æ´»æ€§æ¢é’ˆ(å­˜æ´»æ€æ¢é’ˆ) livenessprobe</span></span><br><span class="line">åˆ—å¦‚ï¼š</span><br><span class="line">å½“nginxå®¹å™¨èµ·æ¥åï¼Œå³ä¾¿é¡µé¢æ˜¯404ï¼Œå®¹å™¨ä¼šæ­£å¸¸è¿è¡Œï¼Œ80ç«¯å£ä¹Ÿä¼šæ­£å¸¸å­˜åœ¨ï¼Œk8så°±ä¸ä¼šåšåˆ°é‡æ–°æ‹‰èµ·è¿™ä¸ªå®¹å™¨ï¼Œå­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">æ•°æ®åº“å‡æ­»ï¼Œè¿›ç¨‹å­˜åœ¨ï¼Œå­˜æ´»æ€§æ¢é’ˆå°±å¯ä»¥æ£€æµ‹åº”ç”¨æ˜¯å¦å­˜æ´»ï¼Œä¸å­˜æ´»ä¼šå‡ºç°æ‹‰èµ·æ–°çš„pod</span><br><span class="line"></span><br><span class="line">ç”¨äºå®šä¹‰å®¹å™¨å†…ï¼Œåº”ç”¨æ˜¯å¦æ»¡è¶³æ¢é’ˆæŒ‡å®šçŠ¶æ€ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œåˆ™åˆ é™¤PODé‡æ–°æ‹‰èµ·ä¸€ä¸ªæ–°çš„POD</span><br><span class="line"></span><br><span class="line">å­˜æ´»æ¢é’ˆç®€å•æ¥è¯´å°±æ˜¯ç”¨æ¥æ£€æµ‹å®¹å™¨çš„åº”ç”¨ç¨‹åºæ˜¯å¦è¿˜æ­£å¸¸å·¥ä½œï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸æ­£å¸¸ï¼Œå³ä½¿å®¹å™¨è¿˜æ´»ç€ä¹Ÿæ²¡æœ‰æ„ä¹‰äº†ï¼Œæ‰€ä»¥è¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨å­˜æ´»æ¢é’ˆæ¥æ¢æµ‹ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸æ­£å¸¸ï¼Œå°±é‡å¯PODã€‚</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>ï¼šæ‰§è¡Œå‘½ä»¤</span><br><span class="line">httpGetï¼šæ£€æµ‹HTTP</span><br><span class="line">tcpSocketï¼šæ£€æµ‹ç«¯å£</span><br><span class="line"></span><br><span class="line">ivenessProbe:</span><br><span class="line">httpGet:   <span class="comment">#åŸºäºHTTPè¯·æ±‚èµ„æº</span></span><br><span class="line">path:      <span class="comment">#è¯·æ±‚åœ°å€ï¼Œå¦‚æœè¿™ä¸ªåœ°å€è¿”å›çš„çŠ¶æ€ç åœ¨200~400ä¹‹é—´æ­£å¸¸</span></span><br><span class="line">port:      <span class="comment">#è¯·æ±‚çš„ç«¯å£</span></span><br><span class="line">initialDelaySeconds: 3     <span class="comment">#ç¬¬ä¸€æ¬¡å¯åŠ¨æ¢æµ‹åœ¨å®¹å™¨å¯åŠ¨çš„3såå¼€å§‹</span></span><br><span class="line">periodSeconds: 3           <span class="comment">#å®¹å™¨å¯åŠ¨åæ¯éš”3sæ£€æµ‹ä¸€æ¬¡</span></span><br></pre></td></tr></table></figure><ul><li>1ã€å­˜æ´»æ€§æ¢é’ˆ  execç‰ˆ   åº”ç”¨åœºæ™¯ï¼šæ¯”å¦‚è¯´nfs,æ²¡æœ‰é¡µé¢å’Œç«¯å£ï¼Œå°±å¯ä»¥ç”¨å‘½ä»¤ï¼Œdf -Th|grep æŒ‚è½½ç›®å½•ï¼Œå¦‚æœnfsæŒ‚äº†df -Thä¼šå¡ä¸»ï¼Œä½†æ˜¯ä»–æœ‰ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå¡ä½äº†ï¼Œåˆ°æ—¶å€™è¶…æ—¶äº†å°±è®¤ä¸ºæŒ‚äº†</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>è¿˜å¯ä»¥å†™è„šæœ¬å»æ£€æµ‹æŸä¸ªæœåŠ¡</span><br><span class="line"></span><br><span class="line">1ã€å†™serviceèµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim ivenssprobe-service.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: ivenssprobe-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">  <span class="comment">#è¿™ä¸ªæ ‡ç­¾ä¸€å®šè¦å’Œä¸‹é¢çš„æ ‡ç­¾ä¿æŒä¸€è‡´ï¼Œä¸ç„¶ä¼šcurlæŠ¥é”™</span></span><br><span class="line">    app: ivenssprobe</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">    <span class="comment">#æŠŠ80æ˜ å°„åˆ°å®¿ä¸»æœºçš„30000ç«¯å£</span></span><br><span class="line">    nodePort: 30000</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ç¼–å†™èµ„æºæ¸…å•    åˆ°è¿™é‡Œç›®å‰è¿˜æ²¡æœ‰æ·»åŠ å­˜æ´»æ¢é’ˆçš„åŠŸèƒ½ï¼Œåœ¨åé¢æ·»åŠ </span><br><span class="line">[root@master01 kubernetes]# vim ivenssprobe.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: ivenssprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: ivenssprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å­˜æ´»æ€§æ¢é’ˆ&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">          </span><br><span class="line">2ã€è¿è¡Œ</span><br><span class="line">[root@master01 kubernetes]# kubectl get service</span><br><span class="line">NAME                  TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">ivenssprobe-service   NodePort    10.1.87.209   &lt;none&gt;        80:30000/TCP   25s</span><br><span class="line">kubernetes            ClusterIP   10.1.0.1      &lt;none&gt;        443/TCP        7d5h</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod ivenssprobe-pod -owide</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">ivenssprobe-pod   1/1     Running   0          3m53s   10.2.1.11   node01</span><br><span class="line"></span><br><span class="line">3ã€æ£€æŸ¥</span><br><span class="line">ivenssprobe-serviceè¿™ä¸ªèµ„æºç›¸å½“äºç»™ä»–ä»¬åšäº†è´Ÿè½½å‡è¡¡</span><br><span class="line">[root@master01 kubernetes]# curl 10.1.151.36</span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.1.7 </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line"></span><br><span class="line">ç”±äºåšäº†å®¿ä¸»æœºä¸Šçš„æ˜ å°„ï¼Œå¯ä»¥æµè§ˆå™¨è®¿é—®   10.0.0.201:30000</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240920165623622.png" alt="image-20240920165623622"></p><p>æµ‹è¯•æ¢é’ˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line"></span><br><span class="line">1ã€åˆ é™¤ä¸»é¡µé¢ï¼Œå†æ¬¡æµè§ˆå™¨è®¿é—®ï¼Œå˜æˆ403</span><br><span class="line">[root@node01 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line"></span><br><span class="line">2ã€å†æ¬¡æŸ¥çœ‹ä¸»é¡µé¢ï¼Œè¿˜æ˜¯ç©ºçš„ï¼ŒæŸ¥çœ‹podï¼Œè¿˜æ˜¯runningçŠ¶æ€ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†ç½‘ç«™ç¡®å®æŒ‚äº†ï¼Œpodè™½ç„¶åœ¨è¿è¡Œï¼Œä½†æ˜¯æ²¡å•¥ç”¨äº†ï¼Œè¿˜å ç”¨èµ„æº</span><br></pre></td></tr></table></figure><p>åœ¨èµ„æºæ¸…å•ç¼–å†™å­˜æ´»æ€§æ¢é’ˆçš„æ£€éªŒåŠŸèƒ½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">1ã€åˆ é™¤æ—§çš„pod</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod ivenssprobe-pod </span><br><span class="line"></span><br><span class="line">2ã€åœ¨èµ„æºæ¸…å•æ·»åŠ å­˜æ´»æ€§æ¢é’ˆçš„æ£€éªŒåŠŸèƒ½</span><br><span class="line">[root@master01 kubernetes]# vim ivenssprobe.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: ivenssprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: ivenssprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å­˜æ´»æ€§æ¢é’ˆ&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    livenessProbe:</span><br><span class="line">      <span class="built_in">exec</span>:</span><br><span class="line"><span class="comment">#æ£€æµ‹ä¸»é¡µé¢ï¼Œæ‹¿å‘½ä»¤æ£€æµ‹ï¼Œå½“è¿”å›å€¼ä¸ä¸º0å°±æ˜¯å¤±è´¥</span></span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;cat /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line"><span class="comment">#ä¸€å®šè¦å†™ä¼˜åŒ–å‚æ•°</span></span><br><span class="line">      <span class="comment">#å»¶è¿Ÿæ—¶é—´3s</span></span><br><span class="line">      initialDelaySeconds: 3 </span><br><span class="line">      <span class="comment">#å®¹å™¨æ¯éš”2sæ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">      periodSeconds: 2</span><br><span class="line">      <span class="comment">#è¶…æ—¶æ—¶é—´ 1s</span></span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      <span class="comment">#æˆåŠŸä¹‹å3æ¬¡è¿ç»­å¤±è´¥ï¼Œæ‰æ˜¯çœŸå¤±è´¥ï¼Œç„¶åé‡æ–°å»æ‹‰èµ·ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨çš„æƒ…å†µ</span></span><br><span class="line">      failureThreshold: 3</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line">3ã€æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]#  kubectl apply -f ivenssprobe.yml </span><br><span class="line">pod/ivenssprobe-pod created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod ivenssprobe-pod -owide</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE   IP          NODE  </span><br><span class="line">ivenssprobe-pod   1/1     Running   0          64s   10.2.1.12   node01</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å‚æ•°è§£é‡Šï¼š</span><br><span class="line"></span><br><span class="line">initialDelaySeconds: <span class="comment">#ç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢é’ˆéœ€è¦åœ¨å®¹å™¨å¯åŠ¨åç­‰å¾…çš„æ—¶å€™æ—¶é—´</span></span><br><span class="line">periodSeconds: <span class="comment">#å®¹å™¨å¯åŠ¨åæ¯éš”å¤šå°‘ç§’æ‰§è¡Œä¸€æ¬¡å­˜æ´»æ¢é’ˆ(å¿ƒè·³æ£€æµ‹çš„é—´éš”æ—¶é—´)</span></span><br><span class="line">timeoutSeconds: <span class="comment">#æ¢é’ˆè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤1ç§’ï¼Œæœ€å°1ç§’</span></span><br><span class="line">successThreshold: <span class="comment">#æ¢é’ˆå¤±è´¥åæœ€å°‘è¿ç»­æ¢æµ‹æˆåŠŸå¤šå°‘æ¬¡æ‰è¢«è®¤å®šæˆåŠŸï¼Œé»˜è®¤1æ¬¡ï¼Œå¦‚æœæ˜¯livenesså¿…é¡»ä¸º1(ä¸€å¼€å§‹æ£€æµ‹ä¸€ä¸ªç½‘ç«™æ˜¯403ï¼Œä»£è¡¨ç½‘ç«™å¤±è´¥ï¼Œä¸å¯èƒ½ä¸€å¤±è´¥å°±ç«‹é©¬å»é‡æ–°æ‹‰èµ·pod,éœ€è¦æ£€æŸ¥åˆ°å‡ æ¬¡æˆåŠŸæ‰è®¤ä¸ºæ˜¯æˆåŠŸçš„)</span></span><br><span class="line">failureThreshold: <span class="comment">#æ¢é’ˆæˆåŠŸåè¢«è§†ä¸ºå¤±è´¥çš„æ¢æµ‹çš„æœ€å°è¿ç»­å¤±è´¥æ¬¡æ•°ã€‚é»˜è®¤3æ¬¡ã€‚æœ€å°å€¼ä¸º1(æ¢é’ˆæ£€æµ‹æˆåŠŸå®¹å™¨æ­£å¸¸è¿è¡Œï¼Œé‚£ä¹ˆè¿˜è¦æ£€æµ‹å‡ æ¬¡å¤±è´¥æ‰ä¼šé‡æ–°æ‹‰èµ·è¿™ä¸ªpod)</span></span><br></pre></td></tr></table></figure><p>å†æ¬¡æµ‹è¯•  è®¿é—®ç½‘é¡µ  10.0.0.201:30000  æ¢å¤æ­£å¸¸</p><p><img src="../image/study_img/image-20240920173329296.png" alt="image-20240920173329296"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">[root@node01 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">[root@node01 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">cat</span>: /data/nginx/index.html: No such file or directory</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">cat</span>: /data/nginx/index.html: No such file or directory</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line"></span><br><span class="line">åˆ æ‰ä¸»é¡µé¢ï¼ŒæŸ¥çœ‹ä¸»é¡µé¢å†…å®¹ï¼Œä¼šé‡æ–°æ‹‰èµ·ï¼Œæ‰€ä»¥ä¼šçœ‹åˆ°å†…å®¹</span><br><span class="line"></span><br><span class="line">ä½†æ˜¯<span class="built_in">exec</span>æœ‰ç¼ºé™·ï¼Œä»¥åä»£ç é¡µé¢å¤šï¼Œä¸èƒ½<span class="built_in">cat</span>ï¼Œæ‰€ä»¥Httpgetæ¯”è¾ƒå¥½ç”¨</span><br></pre></td></tr></table></figure><ul><li>2ã€å­˜æ´»æ€§æ¢é’ˆ  httpgetç‰ˆ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">1ã€åˆ é™¤æ—§çš„pod</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod ivenssprobe-pod </span><br><span class="line"></span><br><span class="line">2ã€åœ¨èµ„æºæ¸…å•æ·»åŠ å­˜æ´»æ€§æ¢é’ˆçš„æ£€éªŒåŠŸèƒ½</span><br><span class="line">[root@master01 kubernetes]# vim ivenssprobe.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: ivenssprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: ivenssprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å­˜æ´»æ€§æ¢é’ˆ&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    livenessProbe:</span><br><span class="line">    <span class="comment">#httpç‰ˆæœ¬</span></span><br><span class="line">      httpGet:</span><br><span class="line">      <span class="comment">#hostå°±æ˜¯æœ¬æœºï¼Œä½†æ˜¯å¯ä»¥é»˜è®¤å°±æ˜¯æœ¬æœºï¼Œä¸éœ€è¦å†™</span></span><br><span class="line">        <span class="comment">#host: 127.0.0.1</span></span><br><span class="line"><span class="comment">#pathå°±æ˜¯uri   http://k8s.driverzeng.com/v1.19/,æ¯”å¦‚è¯´è¿™ä¸ªç½‘ç«™çš„uriå°±æ˜¯/v1.19/     http://10.0.0.201:30000/ï¼Œuriå°±æ˜¯/</span></span><br><span class="line">        path: /</span><br><span class="line">      <span class="comment">#è¿˜å¯ä»¥åŠ ä¸Šç«¯å£</span></span><br><span class="line">        port: 80</span><br><span class="line">      </span><br><span class="line"><span class="comment">#ä¸€å®šè¦å†™ä¼˜åŒ–å‚æ•°</span></span><br><span class="line">      <span class="comment">#å»¶è¿Ÿæ—¶é—´3s</span></span><br><span class="line">      initialDelaySeconds: 3 </span><br><span class="line">      <span class="comment">#å®¹å™¨æ¯éš”2sæ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">      periodSeconds: 2</span><br><span class="line">      <span class="comment">#è¶…æ—¶æ—¶é—´ 1s</span></span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      <span class="comment">#æˆåŠŸä¹‹å3æ¬¡è¿ç»­å¤±è´¥ï¼Œæ‰æ˜¯çœŸå¤±è´¥ï¼Œç„¶åé‡æ–°å»æ‹‰èµ·ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨çš„æƒ…å†µ</span></span><br><span class="line">      failureThreshold: 3</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------</span><br><span class="line">ä¸å†™hostæ˜¯å› ä¸ºä¸çŸ¥é“podèµ·æ¥æ˜¯ä»€ä¹ˆip,ä½†ä»¥åå¾—å†™ï¼Œä»¥åä¸å¯èƒ½å§nginxå’Œmysqlèµ·åœ¨ä¸€ä¸ªpod,æ•°æ®åº“è‚¯å®šè¦å•ç‹¬èµ·ä¸€ä¸ªpod</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥è¯¢</span><br><span class="line">[root@master01 kubernetes]#  kubectl delete pod ivenssprobe-pod </span><br><span class="line">pod <span class="string">&quot;ivenssprobe-pod&quot;</span> deleted</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f ivenssprobe.yml </span><br><span class="line">pod/ivenssprobe-pod created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod ivenssprobe-pod -owide</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE   IP          NODE  </span><br><span class="line">ivenssprobe-pod   1/1     Running   0          26s   10.2.1.13   node01</span><br><span class="line"></span><br><span class="line">4ã€#æµ‹è¯•</span><br><span class="line">åˆ°node01åˆ é™¤ä¸»é¡µæ–‡ä»¶</span><br><span class="line">[root@node01 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line">é€Ÿåº¦å¿«ç‚¹ï¼Œåˆ‡æ¢åˆ°æµè§ˆå™¨ç½‘ç«™ï¼Œä¼šçœ‹åˆ°403ï¼Œä¸€ç›´åˆ·æ–°ï¼Œç½‘ç«™å°±ä¼šæ¢å¤åŸæ ·ï¼Œä¸éœ€è¦å»<span class="built_in">cat</span>ä¸»é¡µæ–‡ä»¶äº†</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹ä¸»é¡µæ–‡ä»¶ï¼Œæ¢å¤åŸæ ·</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¥½å¤„æ˜¯ç›‘æµ‹å®ƒçš„80ç«¯å£ï¼Œè®¿é—®è¿™ä¸ªuriï¼Œåªè¦å‡ºç°çŠ¶æ€ç 40å‡ ï¼Œ50å‡ å°±ä¼šé‡æ–°æ‹‰èµ·ï¼Œæƒ³wordpressè¿™ç§ä»£ç å¤šçš„æƒ…å†µä¸‹ï¼Œä¸èƒ½ç”¨catå‘½ä»¤ä¸å¯èƒ½æ¯ä¸ªæ–‡ä»¶éƒ½cat,æ‰€ä»¥httpgetæ˜¯æ£€æµ‹nginxæœ€åçš„æ–¹æ³•</span></span><br></pre></td></tr></table></figure><ul><li>3ã€å­˜æ´»æ€§æ¢é’ˆ  tcpSocketç‰ˆ   åº”ç”¨åœºæ™¯ï¼šæ¯”å¦‚è¯´æ•°æ®åº“ï¼Œåªæœ‰ç«¯å£ï¼Œæ²¡æœ‰ç½‘ç«™</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">åªèƒ½æ£€æµ‹ç«¯å£ï¼Œä¸ä¼šæ£€æµ‹é¡µé¢ï¼Œåˆ æ‰é¡µé¢ï¼Œæ²¡æœ‰ç”¨ï¼Œä¸ä¼šé‡æ–°æ‹‰èµ·ï¼ŒhttpGetå°±ç›¸å½“äºåº•å±‚ä½¿ç”¨curlå‘½ä»¤å»æ£€æµ‹</span><br><span class="line"></span><br><span class="line">tcpSocket: </span><br><span class="line">  host:     <span class="comment">#é»˜è®¤å¯ä»¥ä¸å†™ï¼Œä»–è‡ªå·±çŸ¥é“podçš„ip,æ‰€ä»¥å¯ä»¥ä¸å†™</span></span><br><span class="line">  port:     <span class="comment">#ç«¯å£ã€‚å¦‚æœåªæ£€æµ‹ç«¯å£ï¼Œé¡µé¢åˆ é™¤æ²¡æœ‰æ„ä¹‰ï¼Œä¸ä¼šæ‹‰èµ·</span></span><br><span class="line"></span><br><span class="line">1ã€åœ¨èµ„æºæ¸…å•æ·»åŠ å­˜æ´»æ€§æ¢é’ˆçš„æ£€éªŒåŠŸèƒ½</span><br><span class="line">[root@master01 kubernetes]# vim ivenssprobe.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: ivenssprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: ivenssprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å­˜æ´»æ€§æ¢é’ˆ&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    livenessProbe:</span><br><span class="line">      <span class="comment">#tcpSocketç‰ˆ</span></span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 80</span><br><span class="line">      </span><br><span class="line"><span class="comment">#ä¸€å®šè¦å†™ä¼˜åŒ–å‚æ•°</span></span><br><span class="line">      <span class="comment">#å»¶è¿Ÿæ—¶é—´3s</span></span><br><span class="line">      initialDelaySeconds: 3 </span><br><span class="line">      <span class="comment">#å®¹å™¨æ¯éš”2sæ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">      periodSeconds: 2</span><br><span class="line">      <span class="comment">#è¶…æ—¶æ—¶é—´ 1s</span></span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      <span class="comment">#æˆåŠŸä¹‹å3æ¬¡è¿ç»­å¤±è´¥ï¼Œæ‰æ˜¯çœŸå¤±è´¥ï¼Œç„¶åé‡æ–°å»æ‹‰èµ·ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨çš„æƒ…å†µ</span></span><br><span class="line">      failureThreshold: 3</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">2ã€åˆ é™¤æ—§podï¼Œè¿è¡Œæ–°pod</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod ivenssprobe-pod &amp;&amp; kubectl apply -f ivenssprobe.yml </span><br><span class="line">pod <span class="string">&quot;ivenssprobe-pod&quot;</span> deleted</span><br><span class="line">pod/ivenssprobe-pod created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod ivenssprobe-pod  -owide</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">ivenssprobe-pod   1/1     Running   0          8m58s   10.2.1.14   node01</span><br><span class="line"></span><br><span class="line">3ã€è¿æ¥è¿›å…¥å®¹å™¨ï¼Œæ–­å¼€ç«¯å£</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it ivenssprobe-pod -c nginx-container -- /bin/sh</span><br><span class="line">/ <span class="comment">#  nginx -s stop</span></span><br><span class="line">æ‰§è¡Œä¹‹åå®¹å™¨ä¼šè‡ªåŠ¨é€€å‡ºï¼Œå› ä¸ºå­˜æ´»æ€§æ¢é’ˆæ£€æµ‹åˆ°ç«¯å£ä¸è§äº†ï¼ŒæŠŠå°±å®¹å™¨åˆ é™¤ï¼Œå°±ä¼šè¢«å¼ºåˆ¶è¸¢å‡ºæ¥</span><br></pre></td></tr></table></figure><p>2ã€å°±ç»ªæ€§æ¢é’ˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å°±ç»ªæ€§æ¢é’ˆ(å°±ç»ªæ€æ¢é’ˆ) readnissprobe  </span></span><br><span class="line">å°±ç»ªæ€§æ¢é’ˆé…ç½®è¯­æ³•å’Œå­˜æ´»æ¢é’ˆåŸºæœ¬ä¸€æ ·</span><br><span class="line"></span><br><span class="line">æœ‰æ—¶å€™æˆ‘ä»¬Podæœ¬èº«å·²ç»èµ·æ¥äº†ï¼Œä½†æ˜¯podçš„å®¹å™¨è¿˜æ²¡æœ‰å®Œå…¨å‡†å¤‡å¥½å¯¹å¤–æä¾›æœåŠ¡ï¼Œé‚£ä¹ˆè¿™æ—¶å€™æµé‡è¿›æ¥å°±ä¼šé€ æˆè¯·æ±‚å¤±è´¥çš„æƒ…å†µå‡ºç°ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µk8sæœ‰ä¸€ç§æ¢é’ˆå«å°±ç»ªæ¢é’ˆï¼Œä»–çš„ä½œç”¨å°±æ˜¯è®©k8sçŸ¥é“ä½ çš„Podå†…åº”ç”¨æ˜¯å¦å‡†å¤‡å¥½ä¸ºè¯·æ±‚æä¾›æœåŠ¡ã€‚åªæœ‰å°±ç»ªæ¢é’ˆokäº†æ‰ä¼šæŠŠæµé‡è½¬å‘åˆ°podä¸Šã€‚</span><br><span class="line"></span><br><span class="line">åº”ç”¨åœºæ™¯ï¼šæ¯”å¦‚è¯´æ•°æ®åº“éœ€è¦åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–çš„æ—¶å€™é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œnginxå®¹å™¨èµ·æ¥çš„é€Ÿåº¦å¿«ï¼Œä½†æ˜¯æ•°æ®åº“æ²¡èµ·æ¥ï¼Œè®¿é—®è‚¯å®šæ˜¯502ï¼Œå°±å¥½æ¯”gitlab,nginxèµ·æ¥äº†ï¼Œç»„ä»¶æ²¡èµ·æ¥ï¼Œè®¿é—®æ˜¾ç¤º502ï¼Œå°±ç»ªæ¢é’ˆå°±æ˜¯ç­‰æ•°æ®èµ·æ¥ï¼Œæ‰å¯¹å¤–æä¾›æœåŠ¡(å°±æ˜¯æµè§ˆå™¨æ­£å¸¸è®¿é—®)</span><br><span class="line">ä½†æ˜¯æƒ³è¦æ£€æµ‹ï¼Œå°±è¦ç”¨åˆ°serviceèµ„æº</span><br></pre></td></tr></table></figure><p>ç¼–å†™èµ„æºæ¸…å•ï¼šéœ€æ±‚</p><p>nginxçš„podå¯åŠ¨ï¼Œå‰ææ¡ä»¶æ˜¯æ•°æ®åº“podä¹Ÿå¯åŠ¨èµ·æ¥ï¼Œå¹¶ä¸”æ•°æ®åº“å·²åˆå§‹åŒ–å®Œäº†ï¼Œç„¶åå†å¯¹å¤–æä¾›æœåŠ¡</p><ul><li>å°±ç»ªæ¢é’ˆ  execå‘½ä»¤ç‰ˆ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim readnessprobe.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: readnessprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: readnessprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /</span><br><span class="line">        port: 80</span><br><span class="line"><span class="comment">#å°±ç»ªæ€§æ¢é’ˆå†™æ³•</span></span><br><span class="line">    readinessProbe:</span><br><span class="line">      <span class="built_in">exec</span>:</span><br><span class="line"><span class="comment">#æ£€æµ‹æ–‡ä»¶æ˜¯å¦æœ‰å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰æ–‡ä»¶å°±æ²¡æœ‰å°±ç»ª</span></span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;cat /usr/share/nginx/html/healthy.html&quot;</span>]</span><br><span class="line">      </span><br><span class="line"><span class="comment">#ä¸€å®šè¦å†™ä¼˜åŒ–å‚æ•°</span></span><br><span class="line">      <span class="comment">#å»¶è¿Ÿæ—¶é—´3s</span></span><br><span class="line">      initialDelaySeconds: 3 </span><br><span class="line">      <span class="comment">#å®¹å™¨æ¯éš”2sæ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">      periodSeconds: 2</span><br><span class="line">      <span class="comment">#è¶…æ—¶æ—¶é—´ 1s</span></span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      <span class="comment">#æˆåŠŸä¹‹å3æ¬¡è¿ç»­å¤±è´¥ï¼Œæ‰æ˜¯çœŸå¤±è´¥ï¼Œç„¶åé‡æ–°å»æ‹‰èµ·ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨çš„æƒ…å†µ</span></span><br><span class="line">      failureThreshold: 3</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">ä½†æ˜¯ç°åœ¨æ²¡æœ‰/usr/share/nginx/html/healthy.htmlè¿™ä¸ªæ–‡ä»¶ï¼Œé‚£å®¹å™¨è‚¯å®šæ˜¯ä¸€ç›´ä¸å°±ç»ªçš„</span><br><span class="line"></span><br><span class="line">2ã€åˆ é™¤æ—§pod,åˆ›å»ºæ–°pod</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod ivenssprobe-pod</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f readnessprobe.yml </span><br><span class="line">pod/readnessprobe-pod created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod readnessprobe-pod -owide</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE   IP          NODE </span><br><span class="line">readnessprobe-pod   0/1     Running   0          69s   10.2.1.15   node01</span><br><span class="line"></span><br><span class="line">READYä¸€ç›´æ˜¾ç¤º0/1,ä¸€ç›´ä¸å°±ç»ªï¼Œå°±ä¸å¯¹å¤–æä¾›æµé‡ï¼Œä¸å¯¹å¤–æä¾›æµé‡ï¼Œä½†æ˜¯é¡µé¢å¯ä»¥è®¿é—®</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.1.15</span><br><span class="line"><span class="built_in">test</span> k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯¹å¤–æä¾›æµé‡å‰é¢è¦åŠ è´Ÿè½½å‡è¡¡å’Œç«¯å£æ˜ å°„ï¼Œå¾—ç”¨serviceè´Ÿè½½å‡ºæ¥</span></span><br><span class="line">3ã€ç¼–å†™serviceèµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cp</span> ivenssprobe-service.yml readnessprobe-service.yml</span><br><span class="line">[root@master01 kubernetes]# vim readnessprobe-service.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: readnessprobe-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: readnessprobe</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">    <span class="comment">#ä¸èƒ½ç«¯å£å†²çªï¼Œæ‰€ä»¥ç«¯å£éœ€è¦æ”¹ä¸€ä¸‹</span></span><br><span class="line">    nodePort: 30001</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"></span><br><span class="line">4ã€å¯åŠ¨å¹¶æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f readnessprobe-service.yml</span><br><span class="line">service/readnessprobe-service created</span><br><span class="line">[root@master01 kubernetes]# kubectl get svc</span><br><span class="line">NAME                    TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes              ClusterIP   10.1.0.1      &lt;none&gt;        443/TCP        7d9h</span><br><span class="line">readnessprobe-service   NodePort    10.1.234.20   &lt;none&gt;        80:30001/TCP   17s</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1ã€æµ‹è¯•curl</span><br><span class="line">[root@master01 kubernetes]# curl 10.1.234.20</span><br><span class="line">curl: (7) Failed connect to 10.1.234.20:80; Connection refused</span><br><span class="line">æ²¡æœ‰ç»“æœï¼Œå› ä¸ºå°±ç»ªæ¢é’ˆæ²¡æœ‰å°±ç»ª</span><br><span class="line"></span><br><span class="line">2ã€åœ¨nodeèŠ‚ç‚¹æ˜ å°„çš„å®¿ä¸»æœºç›®å½•åˆ›å»ºå°±ç»ªæ–‡ä»¶</span><br><span class="line">[root@node01 ~]# <span class="built_in">touch</span> /data/nginx/healthy.html</span><br><span class="line"></span><br><span class="line">3ã€åˆ°masteræŸ¥çœ‹å°±ç»ªçŠ¶æ€ï¼Œå·²ç»å˜æˆå°±ç»ªå®Œæˆ</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod readnessprobe-pod -owide</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE   IP          NODE  </span><br><span class="line">readnessprobe-pod   1/1     Running   0          16m   10.2.1.15   node01</span><br><span class="line">[root@master01 kubernetes]#  curl 10.1.234.20</span><br><span class="line"><span class="built_in">test</span> k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe</span><br><span class="line"></span><br><span class="line">4ã€æ£€æŸ¥å·²ç»å¯¹å¤–æä¾›æœåŠ¡äº†</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240920201911358.png" alt="image-20240920201911358"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">5ã€åˆ é™¤å°±ç»ªæ–‡ä»¶ï¼Œcurlå¤±è´¥ï¼Œæœªå°±ç»ªï¼Œç½‘ç«™æ— æ³•è®¿é—®</span><br><span class="line">[root@node01 ~]# <span class="built_in">rm</span> -rf /data/nginx/healthy.html</span><br><span class="line">[root@master01 kubernetes]#  curl 10.1.234.20</span><br><span class="line">curl: (7) Failed connect to 10.1.234.20:80; Connection refused</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod readnessprobe-pod -owide</span><br><span class="line"></span><br><span class="line">podçš„ipå¯ä»¥é€šï¼Œä»£è¡¨å¯¹å†…æä¾›æœåŠ¡</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.1.15</span><br><span class="line"><span class="built_in">test</span> k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¦‚ä¸Šæ˜¯å°±ç»ªæ¢é’ˆçš„ä½¿ç”¨æ–¹æ³•ï¼Œä½†æ˜¯æ­£å¸¸ä¸ä¼šè¿™æ ·å­åšï¼Œå°±åƒèµ·wp,å°±è¦æ£€æµ‹æ•°æ®åº“æœ‰æ²¡æœ‰å‡†å¤‡å¥½</span><br></pre></td></tr></table></figure><p>nginxå’Œmysqlï¼Œæ£€æµ‹mysqlæ˜¯å¦å°±ç»ªï¼Œå°±åƒå°±å¯¹å¤–æä¾›æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 kubernetes]# vim readness-mysql.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: readnessprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: readnessprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /</span><br><span class="line">        port: 80</span><br><span class="line"><span class="comment">#å°±ç»ªæ€§æ¢é’ˆå†™æ³•  #è¦æ£€æµ‹æ•°æ®åªèƒ½ç”¨tcpsocket,é™¤éæ˜¯è¿™ä¸ªç½‘ç«™å¯åŠ¨è¦ä¾èµ–å…¶ä»–ç½‘ç«™å°±ç”¨httpGet:</span></span><br><span class="line">    readinessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 3306</span><br><span class="line">      </span><br><span class="line"><span class="comment">#ä¸€å®šè¦å†™ä¼˜åŒ–å‚æ•°ï¼Œå­˜æ´»æ€§æ¢é’ˆè®¾ç½®çš„é¢‘ç‡è¦æ¯”å°±ç»ªæ¢é’ˆæ…¢ä¸€äº›</span></span><br><span class="line">      <span class="comment">#å»¶è¿Ÿæ—¶é—´3s</span></span><br><span class="line">      initialDelaySeconds: 3 </span><br><span class="line">      <span class="comment">#å®¹å™¨æ¯éš”2sæ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">      periodSeconds: 2</span><br><span class="line">      <span class="comment">#è¶…æ—¶æ—¶é—´ 1s</span></span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      successThreshold: 3</span><br><span class="line">      <span class="comment">#æˆåŠŸä¹‹å3æ¬¡è¿ç»­å¤±è´¥ï¼Œæ‰æ˜¯çœŸå¤±è´¥ï¼Œç„¶åé‡æ–°å»æ‹‰èµ·ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨çš„æƒ…å†µ</span></span><br><span class="line">      failureThreshold: 3</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">  - name: mysql-container</span><br><span class="line">    image: mysql:5.7.44</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">    <span class="comment">#åé¢çš„ä¼˜åŒ–ï¼Œæ¢é’ˆå¯ä»¥ç»§ç»­å†™</span></span><br><span class="line"></span><br><span class="line">2ã€å¯åŠ¨æ£€æŸ¥</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f readness-mysql.yml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod readnessprobe-pod</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">readnessprobe-pod   1/2     Running   0          62s</span><br><span class="line"></span><br><span class="line">1/2æ˜¯å› ä¸ºæ•°æ®åº“æ²¡æœ‰å†™å°±ç»ªæ¢é’ˆï¼Œå¦‚æœå†™äº†ï¼Œå°±æ˜¯0/2,æ•°æ®åº“çš„å°±ç»ªæ¢é’ˆå°±å†™æ£€æµ‹è‡ªå·±çš„3306ç«¯å£</span><br><span class="line">ç­‰å¾…ä¸€ä¼šï¼Œmysqlåˆå§‹åŒ–å®Œæˆå°±ç»ªå®Œæˆ</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod readnessprobe-pod</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">readnessprobe-pod   2/2     Running   0          18s</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl get svc </span><br><span class="line">NAME                    TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes              ClusterIP   10.1.0.1      &lt;none&gt;        443/TCP        7d10h</span><br><span class="line">readnessprobe-service   NodePort    10.1.234.20   &lt;none&gt;        80:30001/TCP   52m</span><br><span class="line">[root@master01 kubernetes]# curl 10.1.234.20</span><br><span class="line"><span class="built_in">test</span> k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å­˜æ´»æ¢é’ˆå’Œå°±ç»ªæ¢é’ˆåŒæ—¶å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œæ•°æ®åº“æ²¡æœ‰å‡†å¤‡å¥½å°±ä¸å°±ç»ªï¼Œé¡µé¢å°±ä¸€ç›´æ˜¯502ï¼Œå‡ºç°502ï¼Œå­˜æ´»æ¢é’ˆé¢‘ç‡é…é«˜äº†ï¼Œæ£€æµ‹åˆ°æœ‰é—®é¢˜å°±ä¼šé‡æ–°æ‹‰èµ·ï¼Œè¿™æ ·å°±è¿›å…¥æ­»å¾ªç¯ï¼Œå¦‚æœ2ä¸ªå®¹å™¨åœ¨ä¸€ä¸ªpodé‡Œï¼Œæ•°æ®æ°¸è¿œèµ·ä¸æ¥ï¼Œå› ä¸ºæŠŠpodåˆ äº†ï¼Œä¼šé‡æ–°åˆ›å»ºï¼Œè¿›å…¥æ­»å¾ªç¯ï¼Œæ‰€ä»¥å­˜æ´»æ¢é’ˆè¦æ¯”å°±ç»ªæ¢é’ˆè®¾ç½®çš„é¢‘ç‡æ…¢</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ä¸€ï¼šwordpressé•œåƒ</span><br><span class="line">åœ¨ä¸€ä¸ªPODé‡Œå¯åŠ¨ä¸¤ä¸ªå®¹å™¨</span><br><span class="line">- wordpress</span><br><span class="line">- mysql5.7</span><br><span class="line">1.å°±ç»ªæ€§æ¢é’ˆ</span><br><span class="line">2.å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">3.å¯åŠ¨é’©å­</span><br><span class="line">4.åœæ­¢é’©å­</span><br><span class="line">5.åˆå§‹åŒ–å®¹å™¨</span><br><span class="line"></span><br><span class="line">äºŒï¼šå°è¯• wordpress å¯åŠ¨ä¸€ä¸ªPOD</span><br><span class="line">MySQLå•ç‹¬å¯åŠ¨åœ¨ä¸€ä¸ªPODé‡Œ,å¦‚ä½•è¿æ¥ï¼Œæ‰èƒ½è®©ç½‘ç«™èƒ½å¤Ÿæ­£å¸¸è®¿é—®</span><br><span class="line"></span><br><span class="line">ä¸‰ï¼šå°è¯• nginx å’Œ phpç¯å¢ƒåˆ†å¼€è£…ï¼Œéƒ¨ç½²ä»£ç </span><br><span class="line">fastcgi_pass unix://dev/shm/php.sock</span><br><span class="line"></span><br><span class="line">ä¸€å¼€å§‹æ˜¯è¿™æ ·å­å†™çš„fastcgi_pass 127.0.0.1:9000ï¼Œä½†æ˜¯ç°åœ¨è¦åˆ†å¼€å®‰è£…ï¼Œå°±è¦å†™å†…å¤–ip  fastcgi_pass 172.16.1.8:9000</span><br><span class="line">æµ‹è¯•ï¼Œä¸Šä¼ å›¾ç‰‡</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ä½¿ç”¨èµ„æºæ¸…å•ç¼–å†™åˆå§‹åŒ–å®¹å™¨ï¼Œé’©å­ï¼Œæ¢é’ˆ</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰4ã€æ ‡ç­¾çš„è®¾ç½®åŠä½¿ç”¨</title>
    <link href="https://www.fomal.cc/posts/4666867d.html"/>
    <id>https://www.fomal.cc/posts/4666867d.html</id>
    <published>2024-09-22T06:45:27.000Z</published>
    <updated>2024-09-22T07:53:34.237Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1ã€æ ‡ç­¾çš„è®¾ç½®åŠä½¿ç”¨">1ã€æ ‡ç­¾çš„è®¾ç½®åŠä½¿ç”¨</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">kubectl get  [èµ„æº] -n [åç§°ç©ºé—´] --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹nodeæ ‡ç­¾</span></span><br><span class="line">[root@master01 ~]# kubectl get nodes --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹podçš„æ ‡ç­¾</span></span><br><span class="line">[root@master01 ~]# kubectl get  pod -n kube-flannel --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç»™nodeæ‰“æ ‡ç­¾</span></span><br><span class="line">[root@master01 ~]# kubectl label node node01 MEM=16G</span><br><span class="line">node/node01 labeled</span><br><span class="line">[root@master01 ~]# kubectl get nodes --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç»™nodeæ‰“è§’è‰²æ ‡ç­¾ï¼šä¸ºäº†åŒºåˆ†é¡¹ç›®åï¼Œæˆ–è€…é…ç½®</span></span><br><span class="line">node-role  è§’è‰²æ ‡ç­¾çš„æ¥å£</span><br><span class="line">node-role.kubernetes.io  æ ‡è¯†è°ƒè§’è‰²æ ‡ç­¾çš„æ¥å£</span><br><span class="line">=å˜æˆ-å·ï¼Œå°±æ˜¯åˆ é™¤è§’è‰²æ ‡ç­¾  node-</span><br><span class="line">node=  ï¼šè¡¨ç¤ºç»™è§’è‰²æ‰“çš„æ ‡ç­¾åå«node</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl label node node01 node-role.kubernetes.io/node=</span><br><span class="line">[root@master01 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS   ROLES    AGE     VERSION</span><br><span class="line">master01   Ready    master   5d23h   v1.19.3</span><br><span class="line">node01     Ready    node     5d23h   v1.19.3</span><br><span class="line">node02     Ready    node     5d23h   v1.19.3</span><br><span class="line">node03     Ready    node     5d23h   v1.19.3</span><br></pre></td></tr></table></figure><p><font color=red><strong>ç»™podæ‰“æ ‡ç­¾çš„æ–¹æ³•ï¼šÂ  Â  å¦‚æœä¸èµ„æºæ¸…å•é‡Œé¢ä¸å†™æ ‡ç­¾ï¼Œèµ·æ¥çš„podå°±æ²¡æœ‰æ ‡ç­¾ï¼Œä¸ä¼šå­˜åœ¨é»˜è®¤æ ‡ç­¾çš„è¯´æ³•ï¼Œæ‰€ä»¥èµ„æºæ¸…å•é‡Œé¢ä¸€å®šè¦å†™æ ‡ç­¾</strong></font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç»™podæ‰“æ ‡ç­¾ä¸ºäº†ä»¥åé€šä¿¡ç”¨</span></span><br><span class="line">æ–¹æ³•ä¸€ï¼š</span><br><span class="line">ä½¿ç”¨å‘½ä»¤æ‰“æ ‡ç­¾ï¼š(ä¸€èˆ¬å¾ˆå°‘ç”¨å‘½ä»¤æ‰“æ ‡ç­¾ï¼Œä»¥åèµ·podæ˜¯ç”¨èµ„æºæ¸…å•çš„ï¼Œæ‰€ä»¥åœ¨èµ„æºæ¸…å•é‡Œé¢æ‰“æ ‡ç­¾æ¯”è¾ƒå¸¸ç”¨)</span><br><span class="line">[root@master01 ~]# kubectl label pod kube-flannel-ds-4ncf5 run=flannel -n kube-flannel </span><br><span class="line">kube-flannel-ds-4ncf5ï¼šPodå</span><br><span class="line">run=flannelï¼šæ ‡ç­¾å</span><br><span class="line">kube-flannelï¼šåç§°ç©ºé—´</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ–¹æ³•äºŒï¼š</span><br><span class="line"><span class="comment">#ç»™Podæ‰“æ ‡ç­¾(ç”¨èµ„æºæ¸…å•æ‰“ï¼Œæ¯”è¾ƒå¸¸ç”¨)</span></span><br><span class="line">[root@master01 kubernetes]# vim nginx-label.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata: </span><br><span class="line">  name: nginx-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    run: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx:alpine</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">è¿è¡Œèµ„æºæ¸…å• </span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-label.yml </span><br><span class="line">æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod --show-labels</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">nginx-pod      1/1     Running   0          23s   run=nginx</span><br></pre></td></tr></table></figure><p>å°†podèµ·åˆ°æŒ‡å®šçš„nodeä¸Š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">ä¸Šé¢æ‰§è¡Œäº†å‘½ä»¤ç»™node01æ‰“MEM=16Gçš„æ ‡ç­¾</span><br><span class="line">[root@master01 ~]# kubectl label node node01 MEM=16G</span><br><span class="line"></span><br><span class="line">å°†podèµ·åœ¨MEM=16çš„èŠ‚ç‚¹ä¸Š</span><br><span class="line"><span class="comment">#å¯åŠ¨podåœ¨æŒ‡å®šæ ‡ç­¾çš„nodeä¸Š</span></span><br><span class="line">[root@master01 kubernetes]# vim nginx2-label.yml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata: </span><br><span class="line">  name: nginx-pod-v2</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    run: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container-v2</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="comment">#å°†podèµ·åœ¨MEM=16çš„èŠ‚ç‚¹ä¸Š</span></span><br><span class="line">  nodeSelector:</span><br><span class="line">    MEM: 16G</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">#(ä¸€èˆ¬æ¥è¯´ä¸å†™å¦‚ä¸‹å†…å®¹ï¼Œå› ä¸ºk8sä¼šåšèµ„æºè®¡ç®—å’Œè°ƒåº¦ï¼Œä½†æ˜¯åœ¨èµ·redisæˆ–è€…æ•°æ®åº“è¿™ç§podçš„æ—¶å€™ï¼Œä»–ä¸¤å¯¹å†…å­˜çš„ä½¿ç”¨æ¯”è¾ƒå¤§ï¼Œå»ºè®®ä¸è¦èµ·åœ¨åŒä¸€ä¸ªæœºå™¨ä¸Šï¼Œè¿™ä¸ªæƒ…å†µå°±è¦ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤äº†ï¼Œé¿å…k8sè‡ªå·±èµ„æºè®¡ç®—ï¼Œå°†redisã€mysqlèµ·åœ¨åŒä¸€ä¸ªæœºå™¨) </span></span><br><span class="line">  nodeSelector:</span><br><span class="line">    MEM: 16G</span><br><span class="line"> </span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx2-label.yml </span><br><span class="line">pod/nginx-pod-v2 created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-pod                1/1     Running   0          17m</span><br><span class="line">nginx-pod-v2             1/1     Running   0          32s</span><br><span class="line">æŸ¥çœ‹èµ·åœ¨node01ä¸Šçš„</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod nginx-pod-v2  -o wide</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE     IP         NODE  </span><br><span class="line">nginx-pod-v2   1/1     Running   0          6m26s   10.2.1.4   node01</span><br></pre></td></tr></table></figure><p>åˆ é™¤æ ‡ç­¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">1ã€å…ˆæŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod --show-labels</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">nginx-pod                1/1     Running   0          31m   run=nginx</span><br><span class="line">nginx-pod-v2             1/1     Running   0          14m   run=nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#åˆ é™¤æ ‡ç­¾</span><br><span class="line">kubectl label [èµ„æº] [èµ„æºå] [æ ‡ç­¾å/æ ‡ç­¾key]-</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl label pod nginx-pod-v2 run-</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod --show-labels</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">nginx-pod                1/1     Running   0          32m   run=nginx</span><br><span class="line">nginx-pod-v2             1/1     Running   0          15m   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ ¹æ®æ ‡ç­¾æŸ¥æ‰¾pod</span></span><br><span class="line">3ã€æŸ¥çœ‹å“ªäº›podæ‰“äº†run=nginxçš„æ ‡ç­¾ï¼Œæ‰“äº†è¿™ä¸ªæ ‡ç­¾çš„éƒ½ä¼šè¢«åˆ—å‡ºæ¥</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -l run=nginx</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-pod   1/1     Running   0          35m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ ¹æ®æ ‡ç­¾åˆ é™¤pod</span></span><br><span class="line">4ã€æ‰“äº†æ ‡ç­¾æ¯”è¾ƒæ–¹ä¾¿ï¼Œå¯ä»¥æ ¹æ®æ ‡ç­¾å»ç­›é€‰ï¼Œè¿˜å¯ä»¥æ ¹æ®æ ‡ç­¾å»åˆ é™¤pod</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod -l run=nginx</span><br><span class="line">pod <span class="string">&quot;nginx-pod&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">  ä½†æ˜¯ä¸€ä¸ªpodé‡Œé¢èµ·2ä¸ªå®¹å™¨æ€ä¹ˆè¿</span><br><span class="line">  -c æ°¸è¿œåªæœ‰3ä¸ªå¼•å·</span><br><span class="line">  é»˜è®¤è¿ç¬¬ä¸€ä¸ªå®¹å™¨</span><br><span class="line">  -cæŒ‡å®šå®¹å™¨å</span><br><span class="line">  <span class="comment">#å½“ä¸€ä¸ªpodä¸­æœ‰å¤šä¸ªå®¹å™¨æ—¶</span></span><br></pre></td></tr></table></figure><p>è¿æ¥åˆ°pod     å®¹å™¨å¯ä»¥ä½¿ç”¨å‘½ä»¤è¿æ¥è¿›å»ï¼Œpodä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤è¿æ¥è¿›å»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¿æ¥åˆ°ä¸€ä¸ªpod</span></span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it  nginx-pod-v2 -- /bin/sh</span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">bin           etc  </span><br><span class="line"></span><br><span class="line">--ï¼šç›¸å½“äºåˆ†éš”ç¬¦,--åé¢çš„æ‰€æœ‰éƒ½æ˜¯å‘½ä»¤</span><br><span class="line"></span><br><span class="line"><span class="comment">#é—®é¢˜ï¼šä¸€ä¸ªpodé‡Œé¢èµ·2ä¸ªå®¹å™¨æ€ä¹ˆè¿ï¼Ÿ</span></span><br><span class="line">1ã€ç¼–å†™ä¸€ä¸ªpodèµ·2ä¸ªå®¹å™¨çš„èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim nginx-busybox.yml</span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox-container</span><br><span class="line">    image: busybox</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line"> <span class="comment">#-cï¼šè¡¨ç¤ºæ°¸è¿œåªæœ‰3ä¸ªå¼•å·ï¼Œç¬¬3ä¸ªå¼•å·å¯ä»¥å†™é•¿çš„å‘½ä»¤</span></span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œpod,å¹¶æŸ¥çœ‹podæ˜¯å¦èµ·æ¥ï¼ŒæŸ¥çœ‹podèµ·åœ¨å“ªä¸ªæœºå™¨</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-busybox.yml </span><br><span class="line">pod/nginx-busybox created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-5f5d9d69c4-d8hvx   1/1     Running   0          19h</span><br><span class="line">nginx-busybox            2/2     Running   0          8s</span><br><span class="line">nginx-pod-v2             1/1     Running   0          43m</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod nginx-busybox -o wide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE     IP         NODE  </span><br><span class="line">nginx-busybox   2/2     Running   0          3m34s   10.2.2.5   node02</span><br><span class="line"></span><br><span class="line">3ã€è¿æ¥è¿›å…¥å®¹å™¨</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it nginx-busybox -- /bin/sh</span><br><span class="line">/ <span class="comment"># ls -l /usr</span></span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x    2 root     root            17 May 18  2023 bin</span><br><span class="line">drwxr-xr-x    2 daemon   daemon           6 May 18  2023 sbin</span><br><span class="line"></span><br><span class="line">è¯¥ç›®å½•æ²¡æœ‰ç«™ç‚¹ç›®å½•ï¼Œæ‰€ä»¥è¿›å»çš„busyboxå®¹å™¨ï¼Œæ‰€ä»¥é»˜è®¤è¿ç¬¬ä¸€ä¸ªå®¹å™¨</span><br><span class="line"></span><br><span class="line">4ã€å¦‚æœéœ€è¦è¿æ¥æŒ‡å®šçš„å®¹å™¨ï¼Œéœ€è¦ä½¿ç”¨é€‰é¡¹-cæŒ‡å®š</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it nginx-busybox -c nginx-container -- /bin/sh</span><br><span class="line">/ <span class="comment"># ls -l /usr/share/nginx/html/</span></span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--    1 root     root           497 Aug 14 06:12 50x.html</span><br><span class="line">-rw-r--r--    1 root     root           615 Aug 14 06:12 index.html</span><br><span class="line"></span><br><span class="line">-cï¼šè¿æ¥åˆ°æŒ‡å®šçš„å®¹å™¨å</span><br><span class="line"></span><br><span class="line">ä½œç”¨ï¼šk8såªéœ€è¦åœ¨masterä¸Šæ“ä½œï¼Œå°±å¯ä»¥è¿åˆ°éœ€è¦è¿çš„å®¹å™¨</span><br></pre></td></tr></table></figure><h2 id="2ã€é‡æ–°è®¤è¯†Pod">2ã€<strong>é‡æ–°è®¤è¯†Pod</strong></h2><p>å…±äº«ç½‘ç»œ</p><p><img src="../image/study_img/image-20240919110354547.png" alt="image-20240919110354547"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1ã€Podå†…çš„å®¹å™¨ä½¿ç”¨Containeræ¨¡å¼å…±äº«æ ¹å®¹å™¨çš„ç½‘ç»œ</span><br><span class="line">2ã€å®¹å™¨çœ‹åˆ°çš„ç½‘ç»œè®¾å¤‡ä¿¡æ¯å’Œæ ¹å®¹å™¨å®Œå…¨ç›¸åŒ</span><br><span class="line">3ã€Podå†…çš„å¤šä¸ªå®¹å™¨å¯ä»¥ä½¿ç”¨localhostè¿›è¡Œç½‘ç»œé€šè®¯</span><br><span class="line">4ã€Podå†…çš„å¤šä¸ªå®¹å™¨ä¸èƒ½ç»‘å®šç›¸åŒçš„ç«¯å£</span><br><span class="line">5ã€Podçš„ç”Ÿå‘½å‘¨æœŸå’Œæ ¹å®¹å™¨ä¸€æ ·ï¼Œå¦‚æœæ ¹å®¹å™¨é€€å‡ºï¼ŒPodå°±é€€å‡º</span><br></pre></td></tr></table></figure><h2 id="3ã€å…±äº«æ–‡ä»¶ç³»ç»Ÿ">3ã€<strong>å…±äº«æ–‡ä»¶ç³»ç»Ÿ</strong></h2><h3 id="1ã€æœ¬åœ°å…±äº«å‚¨å­˜">1ã€<strong>æœ¬åœ°å…±äº«å‚¨å­˜</strong></h3><p><img src="../image/study_img/image-20240919165826698.png" alt="image-20240919165826698"></p><p>ç¬¬ä¸€ç§ï¼šhostPath  æœ¬åœ°çš„æ˜ å°„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim wp.yml</span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: mysql57-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: mysql57</span><br><span class="line">    run: mysql57</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#è®¾ç½®æŒ‚è½½æ˜ å°„çš„å†™æ³•   æŒ‡å®šå®¿ä¸»æœºçš„æŒ‚è½½ç›®å½•</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: mysql-data       <span class="comment">#åå­—ä¸€å®šè¦å†™ï¼Œè®¾ç½®æŒ‚è½½çš„å˜é‡ï¼Œç›¸å½“äºå˜é‡å</span></span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/mysql    <span class="comment">#å®¿ä¸»æœºçš„ç›®å½•ï¼Œç›¸å½“äºå˜é‡å€¼</span></span><br><span class="line">  - name: test-data</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /opt/test</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: mysql57-container</span><br><span class="line">    image: mysql:5.7.44</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line">    - name: MYSQL_DATABASE</span><br><span class="line">      value: <span class="string">&quot;wp_db&quot;</span></span><br><span class="line">    - name: MYSQL_USER</span><br><span class="line">      value: <span class="string">&quot;wp_user&quot;</span></span><br><span class="line">    - name: MYSQL_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="comment">#æŒ‡å®šå­—ç¬¦é›†çš„å†™æ³•</span></span><br><span class="line">    args:</span><br><span class="line">    - --character-set-server=utf8mb4</span><br><span class="line">    - --collation-server=utf8mb4_unicode_ci</span><br><span class="line"><span class="comment">#å®¹å™¨é‡Œé¢çš„ç›®å½•æŒ‚è½½å‡ºæ¥çš„å†™æ³•</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: mysql-data             <span class="comment">#ç°åœ¨å®¹å™¨çš„ç›®å½•è¦æŒ‚åˆ°å®¿ä¸»æœºçš„å“ªä¸ªç›®å½•ï¼Œå°±å†™å®¿ä¸»æœºç›®å½•çš„å˜é‡å</span></span><br><span class="line">      mountPath: /var/lib/mysql    <span class="comment">#è¿™é‡Œå†™å®¹å™¨é‡Œéœ€è¦æŒ‚å‡ºæ¥çš„ç›®å½•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br><span class="line">--xxxä¸€èˆ¬ç”¨args</span><br><span class="line">å¦‚æœæ˜¯ä¸€æ¡å®Œæ•´çš„å‘½ä»¤å°±ç”¨<span class="built_in">command</span></span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œèµ„æºæ¸…å•ï¼Œå¹¶æŸ¥çœ‹podè¿è¡Œçš„node</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f mysql.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">mysql57-pod              1/1     Running   0          3m42s   10.2.3.14   node03</span><br><span class="line"></span><br><span class="line">3ã€åˆ°node03èŠ‚ç‚¹æŸ¥çœ‹ç›®å½•æ˜¯å¦æ˜ å°„</span><br><span class="line">[root@node03 ~]# ll /data/mysql/</span><br><span class="line">-rw-r----- 1 polkitd input       56 Sep 19 18:29 auto.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç›®å½•æ˜ å°„å‡ºæ¥äº†ï¼Œå¦‚æœmysqlæŒ‚äº†ï¼Œå†æ‹‰èµ·ï¼Œæ•°æ®æ˜¯å­˜åœ¨çš„ï¼Œå¦‚æœä¸åšæ˜ å°„ï¼Œk8sè‡ªåŠ¨æ‹‰èµ·ï¼Œæ•°æ®å°±ä¼šå…¨éƒ¨æ²¡æœ‰</span></span><br><span class="line"></span><br><span class="line">å®¹å™¨é‡Œé¢mysqlç”¨æˆ·çš„uid gidéƒ½æ˜¯999ï¼Œå®¿ä¸»æœºä¸Šuidä¸º999çš„æ˜¯polkitd,gidä¸º999çš„æ˜¯inputï¼Œç³»ç»Ÿåªè®¤IDï¼Œä¸è®¤å­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²æ˜¯ç»™äººçœ‹çš„ï¼ŒçŸ¥é“åå­—å°±æ›´å¥½åŒºåˆ†</span><br><span class="line"></span><br><span class="line">4ã€è¿æ¥åˆ°å®¹å™¨é‡Œé¢æ£€æŸ¥</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it pod/mysql57-pod -- /bin/sh</span><br><span class="line">sh-4.2# mysql -uroot -p123</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">mysql&gt; <span class="keyword">select</span> host,user from mysql.user;</span><br><span class="line">mysql&gt; show create database wp_db;</span><br><span class="line">sh-4.2# mysql -uwp_user -p123</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">Value</th><th style="text-align:left">Behavior</th></tr></thead><tbody><tr><td style="text-align:left"><code>â€Œ&quot;&quot;</code></td><td style="text-align:left">é»˜è®¤ä¸éœ€è¦åˆ›å»ºï¼Œä¼šè‡ªåŠ¨åˆ›å»º</td></tr><tr><td style="text-align:left"><code>DirectoryOrCreate</code></td><td style="text-align:left">ç›®å½•å¿…é¡»å­˜åœ¨ï¼Œæƒé™å¿…é¡»æ˜¯755</td></tr><tr><td style="text-align:left"><code>Directory</code></td><td style="text-align:left">ç›®å½•å¿…é¡»å­˜åœ¨</td></tr><tr><td style="text-align:left"><code>FileOrCreate</code></td><td style="text-align:left">æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œæƒé™å¿…é¡»æ˜¯644</td></tr><tr><td style="text-align:left"><code>File</code></td><td style="text-align:left">æ–‡ä»¶å¿…é¡»å­˜åœ¨</td></tr><tr><td style="text-align:left"><code>Socket</code></td><td style="text-align:left">æŒ‚è½½socketæ–‡ä»¶</td></tr><tr><td style="text-align:left"><code>CharDevice</code></td><td style="text-align:left">æŒ‚è½½å­—ç¬¦è®¾å¤‡æ–‡ä»¶ï¼ˆé”®ç›˜ï¼Œé¼ æ ‡ï¼Œç»ˆç«¯â€¦ï¼‰</td></tr><tr><td style="text-align:left"><code>BlockDevice</code></td><td style="text-align:left">æŒ‚è½½å¿«è®¾å¤‡æ–‡ä»¶ï¼ˆç£ç›˜ï¼ŒUç›˜ï¼Œç§»åŠ¨ç¡¬ç›˜â€¦ï¼‰</td></tr></tbody></table><p>ç¬¬äºŒç§ï¼šemptyDir</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim wp.yml</span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: mysql57-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: mysql57</span><br><span class="line">    run: mysql57</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#è®¾ç½®æŒ‚è½½æ˜ å°„çš„å†™æ³•   æŒ‡å®šå®¿ä¸»æœºçš„æŒ‚è½½ç›®å½•</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: mysql-data       <span class="comment">#åå­—ä¸€å®šè¦å†™ï¼Œè®¾ç½®æŒ‚è½½çš„å˜é‡ï¼Œç›¸å½“äºå˜é‡å</span></span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/mysql    <span class="comment">#å®¿ä¸»æœºçš„ç›®å½•ï¼Œç›¸å½“äºå˜é‡å€¼</span></span><br><span class="line">  - name: empty-data</span><br><span class="line">    emptyDir: &#123;&#125;           <span class="comment">#é»˜è®¤æ˜¯ç©ºçš„è¯å°±å†™&#123;&#125;</span></span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: mysql57-container</span><br><span class="line">    image: mysql:5.7.44</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line">    - name: MYSQL_DATABASE</span><br><span class="line">      value: <span class="string">&quot;wp_db&quot;</span></span><br><span class="line">    - name: MYSQL_USER</span><br><span class="line">      value: <span class="string">&quot;wp_user&quot;</span></span><br><span class="line">    - name: MYSQL_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="comment">#æŒ‡å®šå­—ç¬¦é›†çš„å†™æ³•</span></span><br><span class="line">    args:</span><br><span class="line">    - --character-set-server=utf8mb4</span><br><span class="line">    - --collation-server=utf8mb4_unicode_ci</span><br><span class="line"><span class="comment">#å®¹å™¨é‡Œé¢çš„ç›®å½•æŒ‚è½½å‡ºæ¥çš„å†™æ³•</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: empty-data             <span class="comment">#ç°åœ¨å®¹å™¨çš„ç›®å½•è¦æŒ‚åˆ°å®¿ä¸»æœºçš„å“ªä¸ªç›®å½•ï¼Œå°±å†™å®¿ä¸»æœºç›®å½•çš„å˜é‡å</span></span><br><span class="line">      mountPath: /var/lib/mysql    <span class="comment">#è¿™é‡Œå†™å®¹å™¨é‡Œéœ€è¦æŒ‚å‡ºæ¥çš„ç›®å½•</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€åˆ é™¤node03çš„dataç›®å½•</span><br><span class="line">[root@node03 ~]# <span class="built_in">rm</span> -rf /data/mysql/</span><br><span class="line"></span><br><span class="line">3ã€åˆ é™¤ä¸Šä¸€æ¬¡å®éªŒèµ·çš„pod,é‡æ–°è¿è¡Œèµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod  mysql57-pod</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f mysql.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">mysql57-pod              1/1     Running   0          59s     10.2.3.24   node03</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€æŸ¥è¯¢æ˜ å°„çš„datamç›®å½•</span><br><span class="line">[root@node03 ~]# docker inspect 1dd8436185b0</span><br><span class="line"><span class="comment">#æŸ¥æ‰¾Mounts</span></span><br><span class="line"><span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/kubelet/pods/b3994de1-53ba-4ccf-b3b1-a7bdc8f1b08d/volumes/kubernetes.io~empty-dir/empty-data&quot;</span>,</span><br><span class="line"></span><br><span class="line">[root@node03 ~]# ll /var/lib/kubelet/pods/b3994de1-53ba-4ccf-b3b1-a7bdc8f1b08d/volumes/kubernetes.io~empty-dir/empty-data</span><br><span class="line">total 188484</span><br><span class="line">-rw-r----- 1 polkitd input       56 Sep 19 20:05 auto.cnf</span><br><span class="line"></span><br><span class="line">emptyDir: &#123;&#125;</span><br><span class="line">åªæ˜¯ä¸´æ—¶ä½¿ç”¨ï¼šéšæœºçš„ä¸´æ—¶ç›®å½•  å®¹å™¨åˆ é™¤ï¼Œè¿™ä¸ªç›®å½•å°±ä¼šè¢«åˆ é™¤ï¼Œåšä¸åˆ°æŒä¹…åŒ–</span><br><span class="line"></span><br><span class="line">ä½œç”¨ï¼šåœ¨åŒä¸€ä¸ªPodé‡Œ,2ä¸ªå®¹å™¨ä¹‹é—´çš„æ–‡ä»¶æ˜¯äº’ç›¸éš”ç¦»çš„ï¼Œæƒ³è®©ä»–ä»¬äº’é€šæŸä¸ªç›®å½•å°±å¯ä»¥ä½¿ç”¨åˆ°ï¼Œè®©2ä¸ªå®¹å™¨åŒæ—¶éƒ½æŒ‚è½½åˆ°è¿™ä¸ªç›®å½•ï¼Œè¿™æ ·å­è¿™ä¸¤ä¸ªå®¹å™¨å°±æ‰¾åˆ°å…±äº«è¿™ä¸ªç›®å½•</span><br></pre></td></tr></table></figure><p>å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: c7-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: empty-data</span><br><span class="line">    emptyDir: &#123;&#125; </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: empty-data</span><br><span class="line">      mountPath: /usr/share/nginx/html     </span><br><span class="line">      <span class="comment">#è®©busyboxæŒ‚åˆ°å®¿ä¸»æœºçš„éšæœºç›®å½•</span></span><br><span class="line"> </span><br><span class="line">  - name: c7-container</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: empty-data</span><br><span class="line">      mountPath: /opt/html    </span><br><span class="line">      <span class="comment">#è®©c7æŒ‚åˆ°å®¿ä¸»æœºçš„éšæœºç›®å½•</span></span><br><span class="line">      <span class="comment">#éƒ½æ˜¯æŒ‚åˆ°å®¿ä¸»æœºçš„ä¸´æ—¶ç›®å½•ï¼Œè¿™ä¸¤ä¸ªç›®å½•é‡Œé¢çš„æ–‡ä»¶è‚¯å®šæ˜¯äº’é€šçš„</span></span><br><span class="line">      </span><br><span class="line">2ã€è¿è¡Œèµ„æºæ¸…å•ï¼Œå¹¶æŸ¥çœ‹podè¿è¡Œçš„node</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f c7-busybox-emptyDir.yml </span><br><span class="line">pod/c7-nginx created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">c7-nginx                 2/2     Running   0          5s      10.2.3.30   node03</span><br><span class="line"></span><br><span class="line">3ã€æµ‹è¯•2ä¸ªå®¹å™¨æ˜¯å¦å…±äº«äº†ç›®å½•</span><br><span class="line">[root@node03 ~]# docker inspect dbb9f576eacd</span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/kubelet/pods/bed3c777-7aff-4593-a7bc-f2bc3ed47827/volumes/kubernetes.io~empty-dir/empty-data&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/opt/html&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;rprivate&quot;</span></span><br><span class="line">                </span><br><span class="line">4ã€æŸ¥çœ‹æŒ‚è½½çš„éšæœºç›®å½•ï¼Œæ˜¯ç©ºçš„               </span><br><span class="line">[root@node03 ~]# ll /var/lib/kubelet/pods/bed3c777-7aff-4593-a7bc-f2bc3ed47827/volumes/kubernetes.io~empty-dir/empty-data</span><br><span class="line">total 0     </span><br><span class="line"></span><br><span class="line">5ã€è¿è¿›å®¹å™¨é‡Œé¢æŸ¥çœ‹æŒ‚è½½ç›®å½•ï¼Œæ˜¯ç©ºçš„  </span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it c7-nginx -c nginx-container -- /bin/sh</span><br><span class="line">/ <span class="comment"># ls -l /usr/share/nginx/html/</span></span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl <span class="built_in">exec</span> -it c7-nginx -c c7-container -- /bin/bash</span><br><span class="line">[root@c7-nginx /]# <span class="built_in">ls</span> -l /opt/html/</span><br><span class="line">total 0</span><br><span class="line"></span><br><span class="line">6ã€è¿›å…¥éšæœºç›®å½•ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ–‡ä»¶</span><br><span class="line">[root@node03 ~]# <span class="built_in">cd</span> /var/lib/kubelet/pods/bed3c777-7aff-4593-a7bc-f2bc3ed47827/volumes/kubernetes.io~empty-dir/empty-data</span><br><span class="line">[root@node03 empty-data]# <span class="built_in">echo</span> <span class="string">&quot;test å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•&quot;</span> &gt; index.html</span><br><span class="line"></span><br><span class="line">7ã€è¿›å…¥å®¹å™¨ï¼ŒæŸ¥çœ‹æ–‡ä»¶å¯ä»¥çœ‹åˆ°2ä¸ªå®¹å™¨éƒ½å¯ä»¥çœ‹åˆ°åˆ›å»ºçš„æ–‡ä»¶å†…å®¹</span><br><span class="line">/ <span class="comment"># cat /usr/share/nginx/html/index.html </span></span><br><span class="line"><span class="built_in">test</span> å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•</span><br><span class="line">/ <span class="comment"># curl 127.0.0.1</span></span><br><span class="line"><span class="built_in">test</span> å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•</span><br><span class="line"></span><br><span class="line">[root@c7-nginx /]# <span class="built_in">cat</span> /opt/html/index.html </span><br><span class="line"><span class="built_in">test</span> å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•</span><br><span class="line">[root@c7-nginx /]# curl 127.0.0.1</span><br><span class="line"><span class="built_in">test</span> å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å½“Podç»“æŸäº†ï¼Œå…±äº«å°±ç»“æŸäº†ï¼Œå¦‚æœæ•°æ®å¾ˆé‡è¦ï¼Œéœ€è¦æŒä¹…åŒ–ï¼ŒemptyDirå°±ä¸å»ºè®®ä½¿ç”¨ï¼Œå°±ä½¿ç”¨Hostoath</span></span><br><span class="line"></span><br><span class="line">ä¸€ä¸ªpodèµ·åœ¨node02,ä¸€ä¸ªèµ·åœ¨node03,åªèƒ½ç”¨nfså…±äº«</span><br><span class="line"></span><br><span class="line"><span class="built_in">command</span>åé¢çš„å‘½ä»¤ä¼šè®©å®¹å™¨æŠŠåé¢çš„å‘½ä»¤å½“åˆPIDä¸º1çš„è¿›ç¨‹ï¼Œé‚£æ¡å‘½ä»¤ç»“æŸï¼Œè¿›ç¨‹å°±ç»“æŸäº†</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">æ¯”å¦‚è¯´æƒ³æ”¹nginxç«¯å£ï¼Œæƒ³ç”¨8080ï¼Œç”¨èµ„æºæ¸…å•æ€ä¹ˆæ”¹é…ç½®æ–‡ä»¶</span><br><span class="line">podä¸èƒ½è‡ªåŠ¨æ‹‰å–</span><br><span class="line">podåˆå§‹åŒ–å®¹å™¨ï¼Œæƒ³ä¸´æ—¶æ”¹é‡Œé¢æŸäº›ä¸œè¥¿ï¼Œæ¯”å¦‚è¯´æ·»åŠ wwwç”¨æˆ·ï¼Œç»Ÿä¸€ç”¨æˆ·</span><br><span class="line"></span><br><span class="line">é’©å­ å¯åŠ¨é’©å­ï¼šå¯åŠ¨ä¹‹å‰è®©ä»–åšä¸€äº›äº‹æƒ…</span><br><span class="line">åœæ­¢é’©å­ï¼špodç»“æŸäº†å°±åœæ­¢é’©å­ï¼Œç»“æŸä¹‹å‰æƒ³è®©ä»–å‘é‚®ä»¶å‘Šè­¦</span><br><span class="line">æ¢é’ˆï¼šk8sæŒ‚äº†å¯ä»¥é‡æ–°æ‹‰èµ·ï¼Œé‚£ä¹ˆpodæ²¡æŒ‚ï¼Œä½†æ˜¯ç½‘ç«™æ˜¯404æˆ–è€…50å‡ ï¼Œç½‘ç«™ä¸èƒ½æ­£å¸¸è®¿é—®ï¼Œä½†æ˜¯k8såªæ£€æµ‹podæœ‰æ²¡æœ‰æŒ‚æˆ–è€…è¢«åˆ é™¤ï¼Œä½†æ˜¯10ä¸ªpodéƒ½æ˜¯404ï¼Œpodåœ¨ï¼Œä¸ä¼šé‡æ–°æ‹‰èµ·ï¼Œå°±è¦ç”¨æ¢é’ˆ</span><br><span class="line">å­˜æ´»æ¢é’ˆ æ•‘ç»­æ¢é’ˆ  è‡ªåŠ¨æ‰©ç¼©å®¹</span><br></pre></td></tr></table></figure><p><strong>wordpressé•œåƒ</strong></p><p>åœ¨ä¸€ä¸ªPODé‡Œå¯åŠ¨ä¸¤ä¸ªå®¹å™¨ wordpresså’Œmysql5.7ï¼Œç”¨æˆ·ä¸Šä¼ æ•°æ®çš„ç›®å½•åšæŒä¹…åŒ–ï¼Œè¯¥æ‰“æ ‡ç­¾çš„æ‰“æ ‡ç­¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œwordpresså®¹å™¨</span></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wp_db \</span><br><span class="line">-d wordpress-df:v2 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# vim wp.yml</span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Namespace&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: wp</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: wp-pod</span><br><span class="line">  namespace: wp</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: wp-containers</span><br><span class="line">    image: wordpress-df:v2</span><br><span class="line">    imagePullPolicy: Never</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: WORDPRESS_DB_HOST</span><br><span class="line">      value: <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    - name: WORDPRESS_DB_USER</span><br><span class="line">      value: <span class="string">&quot;wp_user&quot;</span></span><br><span class="line">    - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line">    - name: WORDPRESS_DB_NAME</span><br><span class="line">      value: <span class="string">&quot;wp_db&quot;</span></span><br><span class="line"></span><br><span class="line">  - name: mysql-containers</span><br><span class="line">    image: mysql:5.7.44</span><br><span class="line">    imagePullPolicy: Never</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 3306</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line">    - name: MYSQL_DATABASE</span><br><span class="line">      value: <span class="string">&quot;wp_db&quot;</span></span><br><span class="line">    - name: MYSQL_USER</span><br><span class="line">      value: <span class="string">&quot;wp_user&quot;</span></span><br><span class="line">    - name: MYSQL_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: db</span><br><span class="line">      mountPath: /var/lib/mysql</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ç»™podæ‰“æ ‡ç­¾ä»¥åŠå…±äº«æ–‡ä»¶ç³»ç»Ÿ</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰3ã€PODèµ„æº</title>
    <link href="https://www.fomal.cc/posts/763f53e4.html"/>
    <id>https://www.fomal.cc/posts/763f53e4.html</id>
    <published>2024-09-22T06:44:58.000Z</published>
    <updated>2024-09-22T07:53:34.233Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PODèµ„æºçš„ä»‹ç»">PODèµ„æºçš„ä»‹ç»</h2><h3 id="1ã€kubernetesèµ„æºå¯¹è±¡æ“ä½œ">1ã€<strong>kubernetesèµ„æºå¯¹è±¡æ“ä½œ</strong></h3><table><thead><tr><th>èµ„æºå¯¹è±¡</th><th>å¢</th><th>åˆ </th><th>æ”¹</th><th>æŸ¥</th></tr></thead><tbody><tr><td>nodes</td><td></td><td>kubectl delete node</td><td></td><td>kubectl get nodes</td></tr><tr><td>namespace</td><td>kubectl create ns  [èµ„æºå]</td><td>kubectl delete ns  [èµ„æºå]</td><td>kubectl edit ns  [èµ„æºå]</td><td>kubectl get ns</td></tr><tr><td>pod</td><td>kubectl create deployment [èµ„æºå]</td><td>kubectl delete pod  [podå]</td><td></td><td>kubectl get pod</td></tr></tbody></table><p>1ã€nodes</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">å¢</span><br><span class="line"><span class="comment">#å¿˜è®°nodeåŠ å…¥masteré›†ç¾¤å‘½ä»¤,é‚£ä¹ˆéœ€è¦é‡æ–°æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</span></span><br><span class="line">[root@master01 ~]# kubeadm token create --print-join-command</span><br><span class="line"></span><br><span class="line">åˆ </span><br><span class="line">kubectl delete node</span><br><span class="line"></span><br><span class="line">æŸ¥</span><br><span class="line"><span class="comment">#æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">[root@master01 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS   ROLES    AGE    VERSION</span><br><span class="line">master01   Ready    master   5d2h   v1.19.3</span><br><span class="line">node01     Ready    &lt;none&gt;   5d2h   v1.19.3</span><br><span class="line">node02     Ready    &lt;none&gt;   5d2h   v1.19.3</span><br><span class="line">node03     Ready    &lt;none&gt;   5d2h   v1.19.3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹åç§°ç©ºé—´</span></span><br><span class="line">[root@master01 ~]# kubectl get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   5d2h</span><br><span class="line">kube-flannel      Active   5d1h</span><br><span class="line">kube-node-lease   Active   5d2h</span><br><span class="line">kube-public       Active   5d2h</span><br><span class="line">kube-system       Active   5d2h</span><br></pre></td></tr></table></figure><p>2ã€namespace</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å¢</span><br><span class="line">kubectl create ns  [èµ„æºå]</span><br><span class="line"></span><br><span class="line">åˆ </span><br><span class="line">kubectl delete ns  [èµ„æºå]</span><br><span class="line"></span><br><span class="line">æ”¹</span><br><span class="line">kubectl edit ns  [èµ„æºå]</span><br><span class="line"></span><br><span class="line">æŸ¥</span><br><span class="line">kubectl get ns </span><br></pre></td></tr></table></figure><p>3ã€pod</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥</span><br><span class="line"><span class="comment">#æŸ¥çœ‹pod(é»˜è®¤æŸ¥çœ‹defaultåç§°ç©ºé—´)</span></span><br><span class="line">[root@master01 ~]# kubectl get pod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹pod(æŸ¥çœ‹æŒ‡å®šçš„åç§°ç©ºé—´)</span></span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å¸®åŠ©</span></span><br><span class="line">[root@master01 ~]# kubectl get pod --<span class="built_in">help</span></span><br><span class="line">-oæˆ–è€…--outputï¼šæŒ‡å®šè¾“å‡ºæ ¼å¼</span><br><span class="line">jsonï¼šè¾“å‡ºjsonæ ¼å¼</span><br><span class="line">yamlï¼šè¾“å‡ºyamlæ ¼å¼</span><br><span class="line">wideï¼šè¾“å‡ºè¯¦ç»†ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">-nï¼šæŒ‡å®šåç§°ç©ºé—´</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŒ‡å®šè¾“å‡ºæ ¼å¼</span></span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel -o json</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel </span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-4ncf5   1/1     Running   0          5d2h</span><br><span class="line">kube-flannel-ds-7dnxx   1/1     Running   1          5d2h</span><br><span class="line">kube-flannel-ds-dpzqp   1/1     Running   0          5d2h</span><br><span class="line">kube-flannel-ds-knmch   1/1     Running   0          5d2h</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel kube-flannel-ds-4ncf5 -o json</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æŒ‡å®šçš„pod</span></span><br><span class="line">[root@master01 ~]# kubectl get pod nginx-5f5d9d69c4-pk4c4 -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¾“å‡ºpodè¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel -o wide</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-flannel-ds-4ncf5   1/1     Running   0          5d2h   10.0.0.203   node03     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-7dnxx   1/1     Running   1          5d2h   10.0.0.200   master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-dpzqp   1/1     Running   0          5d2h   10.0.0.201   node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-knmch   1/1     Running   0          5d2h   10.0.0.202   node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¢</span><br><span class="line"><span class="comment">#åˆ›å»ºpod(é»˜è®¤åˆ›å»ºåœ¨defaultåç§°ç©ºé—´)</span></span><br><span class="line">kubectl create deployment podå --image=é•œåƒ:ç‰ˆæœ¬</span><br><span class="line">[root@master01 ~]# kubectl create deployment nginx --image=nginx:alpine</span><br><span class="line"></span><br><span class="line">åˆ </span><br><span class="line"><span class="comment">#åˆ é™¤pod</span></span><br><span class="line">[root@master01 ~]# kubectl delete pod nginx-65cc99f84f-8k9rj</span><br><span class="line"></span><br><span class="line">æ”¹</span><br><span class="line"><span class="comment">#å½“åˆ›å»ºpodï¼Œé•œåƒåå†™é”™äº†ï¼Œéœ€è¦ä¿®æ”¹æ—¶</span></span><br><span class="line">[root@master01 ~]# kubectl edit deployment nginx </span><br><span class="line">å°±ä¼šè¿›å…¥åƒviç¼–è¾‘å™¨ä¸€æ ·çš„ä¸œè¥¿ï¼Œæ‰¾åˆ°imageï¼Œæ”¹åé¢çš„é•œåƒå</span><br><span class="line"></span><br><span class="line">ç­‰å¾…ä¸€ä¼šï¼Œè¿™æ¬¡æŸ¥çœ‹pod,å°±ä¼šæ­£å¸¸è¿è¡Œ</span><br><span class="line">[root@master01 ~]#  kubectl get pod</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-5f5d9d69c4-pk4c4   1/1     Running   0          8m14s</span><br></pre></td></tr></table></figure><h3 id="2ã€PODçš„èµ„æºæ¸…å•">2ã€<strong>PODçš„èµ„æºæ¸…å•</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# vim nginx.yaml </span><br><span class="line">apiVersion: v1                        <span class="comment">## K8Sèµ„æºæ¥å£</span></span><br><span class="line">kind: Pod                             <span class="comment">## èµ„æºç±»å‹</span></span><br><span class="line">metadata:                             <span class="comment">## èµ„æºçš„å…ƒæ•°æ®</span></span><br><span class="line">  name: nginx-pod                     <span class="comment">## PODåå­—</span></span><br><span class="line">  namespace: default                  <span class="comment">## èµ„æºå¯åŠ¨åœ¨å“ªä¸ªåç§°ç©ºé—´</span></span><br><span class="line">spec:                                 <span class="comment">## å®¹å™¨ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">  containers:                         <span class="comment">## å®¹å™¨ä¿¡æ¯</span></span><br><span class="line">  - image: nginx:alpine               <span class="comment">## æŒ‡å®šå®¹å™¨çš„é•œåƒ</span></span><br><span class="line">    imagePullPolicy: IfNotPresent     <span class="comment">## é•œåƒæ‹‰å–è§„åˆ™  IfNotPresentï¼šä¸å­˜åœ¨åˆ™æ‹‰å–</span></span><br><span class="line">    name: nginx-containers            <span class="comment">## å®¹å™¨åå­—</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">Alwaysï¼šæ€»æ˜¯æ‹‰å–ï¼Œä¸ç®¡å½“å‰æœºå™¨ä¸Šæ˜¯å¦æœ‰æ”¹é•œåƒéƒ½æ‹‰å–</span><br><span class="line">Neverï¼šä»ä¸æ‹‰å–é•œåƒï¼Œéœ€è¦æå‰docker pull</span><br><span class="line">IfNotPresentï¼šä¸å­˜åœ¨åˆ™æ‹‰å–</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#K8Sèµ„æºæ¥å£ï¼š</span></span><br><span class="line">apiVersion: v1  </span><br><span class="line">å¯ä»¥ç†è§£ä¸ºhttps://masterçš„ip:6443/pod/v1ä¸€å¼€å§‹initåˆå§‹åŒ–çš„æ—¶å€™å°±å†™äº†masterçš„ipä¸º10.0.0.200ï¼Œä¼šè‡ªåŠ¨è¡¥å…¨ï¼Œå¯ä»¥ç†è§£ä¸ºå‰é¢å¯ä»¥ä¸å†™ï¼Œä¼šè‡ªåŠ¨è¡¥å…¨,è¿™äº›æ¥å£å…¨éƒ½æ³¨å†Œåœ¨etcdé‡Œé¢</span><br><span class="line">https://10.0.0.200:6443/pod/v1</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240918150439792.png" alt="image-20240918150439792"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¯åŠ¨pod</span></span><br><span class="line">[root@master01 ~]# kubectl create -f nginx.yml </span><br><span class="line">pod/nginx-pod created</span><br><span class="line">[root@master01 ~]# kubectl get pod</span><br><span class="line">nginx-pod                0/1     ContainerCreating   0          13s</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹è¿™ä¸ªpodèµ·åœ¨å“ªä¸ªnode</span></span><br><span class="line">[root@master01 ~]# kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS             RESTARTS   AGE     IP         NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-pod                0/1     ImagePullBackOff   0          4m49s   10.2.3.6   node03   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="3ã€æ‰‹å†™èµ„æºæ¸…å•">3ã€<strong>æ‰‹å†™èµ„æºæ¸…å•</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å‚è€ƒç½‘å€ï¼šhttp://k8s.driverzeng.com/v1.19/</span><br><span class="line">è¿™4ä¸ªå¿…å†™çš„</span><br><span class="line"></span><br><span class="line">objectæ•°æ®ç±»å‹å†™æ³•ï¼šç›´æ¥å›è½¦ï¼Œå’Œä¸Šä¸€ä¸ªç¼©è¿›å†™key: valueçš„å½¢å¼</span><br><span class="line">[]åˆ—è¡¨æ•°æ®ç±»å‹å†™æ³•ï¼šå›è½¦ä¹‹åå†™ä¸€ä¸ªå‡å·-ï¼Œå†ç©ºæ ¼</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240918153235543.png" alt="image-20240918153235543"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•  <span class="comment"># è¿™é‡Œæœ‰å‘ï¼Œéœ€è¦ç»§ç»­å¾€ä¸‹æŸ¥çœ‹æ›´æ–°åçš„èµ„æºæ¸…å•</span></span><br><span class="line">[root@master01 ~]# vim busybox.yml</span><br><span class="line"><span class="comment">#å¦‚æœåé¢è¦æŒ‡å®šåç§°ç©ºé—´ï¼Œå°±è¦å…ˆåˆ›å»ºåç§°ç©ºé—´</span></span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Namespace&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: aaa</span><br><span class="line"><span class="comment">#åˆ†éš”ç¬¦ï¼Œåˆ†éš”ä¸Šé¢å’Œä¸‹é¢çš„èµ„æº</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#è¿™ä¸ªæ˜¯1ä¸ªpodé‡Œé¢èµ·2ä¸ªå®¹å™¨</span></span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: busybox-pod</span><br><span class="line">  namespace: aaa</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox-containers</span><br><span class="line">    image: busybox</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"> </span><br><span class="line">  - name: nginx-containers</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    </span><br><span class="line">2ã€å¯åŠ¨èµ„æº</span><br><span class="line">[root@master01 ~]# kubectl apply -f busybox.yml </span><br><span class="line">namespace/aaa created</span><br><span class="line">pod/busybox-pod created</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹åç§°ç©ºé—´é‡Œé¢èµ·çš„èµ„æºï¼Œåªçœ‹åˆ°ä¸€ä¸ª</span><br><span class="line">[root@master01 ~]# kubectl get pod -n aaa</span><br><span class="line">NAME          READY   STATUS             RESTARTS   AGE</span><br><span class="line">busybox-pod   1/2     CrashLoopBackOff   3          94s</span><br><span class="line"></span><br><span class="line">4ã€ç”±äºåç§°ç©ºé—´é‡Œé¢èµ·çš„èµ„æºï¼Œåªçœ‹åˆ°ä¸€ä¸ªï¼Œæ‰€ä»¥æœ‰é—®é¢˜ï¼Œè¦æ£€æŸ¥åŸå› æ’é”™</span><br><span class="line"><span class="comment">#æ’æŸ¥å‘½ä»¤</span></span><br><span class="line"><span class="comment">#kubectl describe [èµ„æº] [èµ„æºå] [-n åç§°ç©ºé—´]</span></span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl describe pod busybox-pod -n aaa</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl describe namespace  aaa</span><br><span class="line"></span><br><span class="line">å…¶å®åŸå› å°±æ˜¯busyboxæ²¡å¡ä½ï¼Œè¿™ä¸ªæ˜¯ç½‘ç»œç›¸å…³çš„é•œåƒï¼Œéœ€è¦åŠ å‘½ä»¤å¡ä½</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">5ã€æ›´æ–°èµ„æºæ¸…å•</span><br><span class="line">[root@master01 ~]# vim busybox.yml</span><br><span class="line"><span class="comment">#å¦‚æœåé¢è¦æŒ‡å®šåç§°ç©ºé—´ï¼Œå°±è¦å…ˆåˆ›å»ºåç§°ç©ºé—´</span></span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Namespace&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: aaa</span><br><span class="line"><span class="comment">#åˆ†éš”ç¬¦ï¼Œåˆ†éš”ä¸Šé¢å’Œä¸‹é¢çš„èµ„æº</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#è¿™ä¸ªæ˜¯1ä¸ªpodé‡Œé¢èµ·2ä¸ªå®¹å™¨</span></span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: busybox-pod</span><br><span class="line">  namespace: aaa</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox-containers</span><br><span class="line">    image: busybox</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="comment">#åŠ å…¥å¡ä½çš„å‘½ä»¤</span></span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/tail&quot;</span>,<span class="string">&quot;-f&quot;</span>,<span class="string">&quot;/etc/hosts&quot;</span>]</span><br><span class="line"> </span><br><span class="line">  - name: nginx-containers</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    </span><br><span class="line">6ã€åˆ é™¤å°±å¾—pod</span><br><span class="line">[root@master01 ~]# kubectl delete -f busybox.yml</span><br><span class="line"></span><br><span class="line">7ã€å†æ¬¡åˆ›å»ºpod,å¹¶æŸ¥çœ‹</span><br><span class="line">[root@master01 ~]# kubectl apply -f busybox.yml </span><br><span class="line">[root@master01 ~]# kubectl get pod -n aaa</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">busybox-pod   2/2     Running   0          13s</span><br><span class="line"><span class="comment">#æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">[root@master01 ~]# kubectl get pod -n aaa -o wide</span><br></pre></td></tr></table></figure><h3 id="4ã€ä½¿ç”¨VScodeç¼–å†™èµ„æºæ¸…å•">4ã€<strong>ä½¿ç”¨VScodeç¼–å†™èµ„æºæ¸…å•</strong></h3><p>1ã€é…ç½®VScode</p><p>å…ˆè¿œç¨‹è¿æ¥ä¸»èŠ‚ç‚¹</p><p><img src="../image/study_img/image-20240918170551193.png" alt="image-20240918170551193"></p><p>ç»Ÿä¸€èµ„æºæ¸…å•çš„ä½ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# <span class="built_in">mkdir</span> /opt/kubernetes</span><br><span class="line">[root@master01 ~]# <span class="built_in">mv</span> *.yml /opt/kubernetes</span><br></pre></td></tr></table></figure><p>è¿æ¥æˆåŠŸï¼Œæ‰“å¼€åˆ›å»ºçš„/opt/kubernetesç›®å½•</p><p><img src="../image/study_img/image-20240918171056628.png" alt="image-20240918171056628"></p><p><img src="../image/study_img/image-20240918171219206.png" alt="image-20240918171219206"></p><p>é…ç½®æ¢¯å­åŠ é€Ÿä¸‹è½½ï¼Œå®‰è£…kubernetesæ’ä»¶ï¼Œå®‰è£…æ’ä»¶å¯èƒ½éœ€è¦7åˆ†é’Ÿå·¦å³</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# vim ~/.bashrc </span><br><span class="line"><span class="built_in">export</span> https_proxy=https://192.168.10.200:7890</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# <span class="built_in">source</span> .bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä½¿ç”¨å®Œæˆåï¼Œæ‰§è¡Œå¦‚ä¸‹ï¼š</span></span><br><span class="line">[root@master01 ~]# vim ~/.bashrc </span><br><span class="line"><span class="comment">#export https_proxy=https://192.168.10.200:7890</span></span><br><span class="line"></span><br><span class="line">[root@master01 ~]# <span class="built_in">unset</span> https_proxy</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240918172406539.png" alt="image-20240918172406539"></p><p><img src="../image/study_img/image-20240918173241749.png" alt="image-20240918173241749"></p><p>å®‰è£…æ’ä»¶å¯èƒ½éœ€è¦7åˆ†é’Ÿå·¦å³ï¼Œå®‰è£…å®Œæˆ</p><p><img src="../image/study_img/image-20240918174036219.png" alt="image-20240918174036219"></p><p>2ã€ä½¿ç”¨æ’ä»¶</p><p>æŸ¥çœ‹é•œåƒçš„çŠ¶æ€å’Œip</p><p><img src="../image/study_img/image-20240918174854465.png" alt="image-20240918174854465"></p><p>ç¼–å†™èµ„æºæ¸…å•</p><p><img src="../image/study_img/image-20240918175229795.png" alt="image-20240918175229795"></p><p><img src="../image/study_img/image-20240918175420732.png" alt="image-20240918175420732"></p><p><img src="../image/study_img/image-20240918175433243.png" alt="image-20240918175433243"></p><p>æ ¹æ®æ¨¡ç‰ˆä¿®æ”¹å†…å®¹    èµ„æºé™åˆ¶ä¸éœ€è¦ï¼Œæ‰€ä»¥åˆ é™¤ï¼Œåˆ é™¤ä¹‹åæœ‰é»„çº¿ï¼Œä¸ç”¨ç®¡</p><p><img src="../image/study_img/image-20240918175813043.png" alt="image-20240918175813043"></p>]]></content>
    
    
    <summary type="html">ç¼–å†™podèµ„æºæ¸…å•ï¼Œä½¿ç”¨ä¸€ä¸ªå¾ˆå¥½ç”¨çš„å·¥å…·VScodeç¼–å†™èµ„æºæ¸…å•ï¼Œæœ¬æ–‡æœ‰å†™æ“ä½œæ–¹æ³•å“¦ï¼Œéå¸¸å®ç”¨</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰2ã€kubernetså®‰è£…éƒ¨ç½²v1.19-æºç å®‰è£…</title>
    <link href="https://www.fomal.cc/posts/8b2778bc.html"/>
    <id>https://www.fomal.cc/posts/8b2778bc.html</id>
    <published>2024-09-22T06:44:18.000Z</published>
    <updated>2024-09-22T07:53:34.235Z</updated>
    
    <content type="html"><![CDATA[<h2 id="kubernetså®‰è£…éƒ¨ç½²v1-19-æºç å®‰è£…">kubernetså®‰è£…éƒ¨ç½²v1.19  (æºç å®‰è£…)</h2><h3 id="1ã€k8sçš„å®‰è£…æ–¹å¼">1ã€<strong>k8sçš„å®‰è£…æ–¹å¼</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## K8Sçš„æ–¹å¼æœ‰ä¸€å †</span></span><br><span class="line">äºŒè¿›åˆ¶å®‰è£…  ç”Ÿäº§æ¨è</span><br><span class="line">kubeadm    ç”Ÿäº§æ¨è</span><br><span class="line">Ansible    äºŒè¿›åˆ¶å®‰è£…</span><br><span class="line">Rancher    è™½ç„¶k8sæ˜¯æœ‰è‡ªå¸¦çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œä½†åœ¨ä¼ä¸šé‡Œé¢ç”¨Rancherçš„è¿˜æ˜¯æ¯”è¾ƒå¤š</span><br><span class="line">é˜¿é‡Œäº‘ACK</span><br><span class="line">äºšé©¬é€Šäº‘EKS</span><br><span class="line"></span><br><span class="line">å®‰è£…k8s1.19ç‰ˆï¼Œk8sä¸­å°ç‰ˆæœ¬å˜äº†å½±å“å¾ˆå¤§ï¼Œæ¥å£æ˜¯ä¸ä¸€æ ·çš„</span><br></pre></td></tr></table></figure><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th><th>é…ç½®</th><th>é…ç½®</th></tr></thead><tbody><tr><td>master01</td><td>10.0.0.200  /  172.16.1.200</td><td>master</td><td>kubectl,apiserver,scheduler,controller,<br>etcd,kubelet,kube-proxy</td><td>1h2G</td></tr><tr><td>node01</td><td>10.0.0.201  /  172.16.1.201</td><td>node</td><td>kubectlï¼Œapiserver,<br>kube-proxy</td><td>1h2G</td></tr><tr><td>node02</td><td>10.0.0.202  /  172.16.1.202</td><td>node</td><td>kubectlï¼Œapiserver,<br>kube-proxy</td><td>1h2G</td></tr><tr><td>node03</td><td>10.0.0.203  /  172.16.1.203</td><td>node</td><td>kubectlï¼Œapiserver,<br>kube-proxy</td><td>2h4G</td></tr></tbody></table><p>IPè§„åˆ’</p><p>ä¸ºä»€ä¹ˆè§„åˆ’IP?  å› ä¸ºæ‰€æœ‰çš„PODèµ·æ¥åº”è¯¥åœ¨åŒä¸€ä¸ªç½‘æ®µï¼ŒCluster IPä¹Ÿåœ¨åŒä¸€ä¸ªç½‘æ®µ</p><table><thead><tr><th>ä¸‰ç§service</th><th>IP</th></tr></thead><tbody><tr><td>POD IP</td><td>10.2.0.0</td></tr><tr><td>Cluster IP</td><td>10.1.0.0</td></tr><tr><td>Node IP</td><td>10.0.0.0</td></tr></tbody></table><p>æ³¨æ„ï¼šå¦‚æœæ˜¯äºŒè¿›åˆ¶å®‰è£…ï¼Œé»˜è®¤çš„pod IPæ˜¯10.0.0.0ç½‘æ®µï¼Œå®¿ä¸»æœºçš„ç½‘æ®µå’Œpod ipÂ·ä¸èƒ½ä¸€æ ·</p><p><strong>â‘ ã€éƒ¨ç½²å‰çš„ç¯å¢ƒä¼˜åŒ–</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######4å°æœºå™¨éƒ½æ‰§è¡Œ   </span></span><br><span class="line"><span class="comment">#(kubelet:æ§åˆ¶å®¹å™¨è¿è¡Œæ—¶å¯åŠ¨å®¹å™¨çš„ä¸œè¥¿,è¦æŠŠmasterå½“ä½œnodeèŠ‚ç‚¹ï¼Œæ‰€ä»¥masterä¹Ÿè¦å®‰è£…)</span></span><br><span class="line">1ã€é…ç½®kubleté…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„Cgroupé©±åŠ¨å’Œç¦ç”¨swap     </span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/sysconfig/kubelet &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">KUBELET_CGROUP_ARGS=&quot;--cgroup-driver=systemd&quot;</span></span><br><span class="line"><span class="string">KUBELET_EXTRA_ARGS=&quot;--fail-swap-on=false&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è®©kubeletä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„Cgroupé©±åŠ¨ </span></span><br><span class="line">KUBELET_CGROUP_ARGS=<span class="string">&quot;--cgroup-driver=systemd&quot;</span></span><br><span class="line"><span class="comment">#è®©kubeletç¦æ­¢ä½¿ç”¨swap(è™šæ‹Ÿå†…å­˜) </span></span><br><span class="line">KUBELET_EXTRA_ARGS=<span class="string">&quot;--fail-swap-on=false&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€å†…å‚æ•°è°ƒä¼˜ï¼Œè¦æŠŠiptableåŠŸèƒ½å¼€å¯(å› ä¸ºåº•å±‚ç«¯å£çš„è½¬å‘ç«¯å£æ˜ å°„éƒ½æ˜¯é˜²ç«å¢™åšçš„)</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">vm.swappiness=0</span></span><br><span class="line"><span class="string">fs.file-max=52706963</span></span><br><span class="line"><span class="string">fs.nr_open=52706963</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¼€å¯iptablesåŠŸèƒ½   ipv4</span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line"><span class="comment">#å¼€å¯iptablesåŠŸèƒ½   ipv6</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="comment">#å¼€å¯å†…æ ¸è½¬å‘</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="comment">#å†…æ ¸å‚æ•°ç¦ç”¨swap</span></span><br><span class="line">vm.swappiness=0</span><br><span class="line"><span class="comment">#æ–‡ä»¶æè¿°ç¬¦æ–‡ä»¶æœ€å¤§å€¼</span></span><br><span class="line">fs.file-max=52706963</span><br><span class="line"><span class="comment">#æ–‡ä»¶æè¿°ç¬¦å¼€å¯æ•°é‡</span></span><br><span class="line">fs.nr_open=52706963</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€æ£€æŸ¥æ˜¯å¦é…ç½®æˆåŠŸ</span><br><span class="line">sysctl --system</span><br><span class="line">æ‰§è¡Œä¹‹åè¾“å‡ºç»“æœå€’æ•°çš„è¡Œä¼šæ˜¾ç¤ºç¬¬2æ­¥é…ç½®çš„å†…å®¹</span><br><span class="line">* Applying /etc/sysctl.d/k8s.conf ...</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">vm.swappiness = 0</span><br><span class="line">fs.file-max = 52706963</span><br><span class="line">fs.nr_open = 52706963</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€æ›´æ”¹dockeræº</span><br><span class="line">[root@master01 ~]# <span class="built_in">cat</span> &gt; /etc/yum.repos.d/docker-ce.repo &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[docker-ce-stable]</span></span><br><span class="line"><span class="string">name=Docker CE Stable - $basearch</span></span><br><span class="line"><span class="string">baseurl=https://download.docker.com/linux/centos/7/x86_64/stable</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://download.docker.com/linux/centos/gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">[root@master01 ~]# sed -i <span class="string">&#x27;s+download.docker.com+mirrors.huaweicloud.com/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line">5ã€å®‰è£…æ—¶é—´åŒæ­¥æœåŠ¡ (è¿™ä¸ªä¸éœ€è¦å†™åœ¨å®šæ—¶ä»»åŠ¡é‡Œé¢)</span><br><span class="line">yum install -y chrony</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl <span class="built_in">enable</span> chronyd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6ã€å…³é—­swap</span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;/swap/d&#x27;</span> /etc/fstab</span><br><span class="line">free -m</span><br><span class="line">[root@master01 ~]# free -m</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           1846         100        1271           9         474        1564</span><br><span class="line">Swap:             0           0           0#å˜æˆ0å°±æ˜¯å…³é—­äº†</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸´æ—¶å…³é—­swap</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="comment">#æ°¸ä¹…å…³é—­swap</span></span><br><span class="line">sed -i <span class="string">&#x27;/swap/d&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7ã€åŠ è½½ipvsæ¨¡å—   åšk8sï¼Œåº•å±‚æœ‰è½¬å‘ï¼Œéœ€è¦é…åˆipvsæ¨¡å—æ‰å¯ä»¥</span><br><span class="line"><span class="built_in">cat</span>  &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">modprobe -- ip_vs</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_rr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_wrr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_sh</span></span><br><span class="line"><span class="string">modprobe -- nf_conntrack_ipv4</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="built_in">source</span> /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">lsmod|grep -e <span class="string">&#x27;ip_vs&#x27;</span> -e <span class="string">&#x27;nf_conntrack_ipv&#x27;</span>  </span><br><span class="line"><span class="comment">#è¿‡æ»¤å‡ºip_vsæ¨¡å—å°±åŠ è½½å‡ºæ¥äº†</span></span><br><span class="line"></span><br><span class="line">ipvs:LVSåšå››å±‚è´Ÿè½½,ä¸éœ€è¦è£…ä»»ä½•è½¯ä»¶,éœ€è¦ä¸‹è½½ipvsadmå‘½ä»¤,ç”¨ipvsadmè¿™ä¸ªå‘½ä»¤å»æ”¹ä¸»æœºçš„è·¯ç”±ã€è·¯ç”±è¡¨ã€ç½‘ç»œç›¸å…³çš„ä¸œè¥¿æ”¹æ‰,æŠŠè¿™ä¸ªä¸»æœºå½“æˆå››å±‚è´Ÿè½½çš„æœºå™¨,åº•å±‚è¦åšè½¬å‘çš„ï¼ŒLVSè¿™ä¸ªæœåŠ¡æ¯”è¾ƒç‹¬ç‰¹çš„ï¼Œæ²¡æœ‰ä¸“é—¨çš„åº”ç”¨ï¼Œä¸åƒnginxã€HAproxyåšè´Ÿè½½å‡è¡¡éœ€è¦å®‰è£…nginxã€HAproxy,LVSæ²¡æœ‰æœåŠ¡å®‰è£…ï¼Œéœ€è¦å®‰è£…ipvsadm,ç”¨è¿™ä¸ªå‘½ä»¤å»ä¿®æ”¹è·¯ç”±ä¿®æ”¹è½¬å‘è¿™äº›ä¸œè¥¿ï¼Œè®©æ•´ä¸ªç‰©ç†æœºå˜æˆè½¬å‘çš„æœºå™¨</span><br></pre></td></tr></table></figure><p><strong>â‘¡ã€å®‰è£…dockeræŒ‡å®šç‰ˆæœ¬</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######4å°æœºå™¨éƒ½æ‰§è¡Œ ####</span></span><br><span class="line">1ã€æŸ¥è¯¢dockerç‰ˆæœ¬  </span><br><span class="line"><span class="comment">#(åªæ˜¾ç¤ºyumä»“åº“é‡Œçš„æœ€æ–°ç‰ˆ)</span></span><br><span class="line">yum list docker-ce </span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æ‰€æœ‰çš„ç‰ˆæœ¬</span></span><br><span class="line">yum list docker-ce --showduplicates</span><br><span class="line"></span><br><span class="line">2ã€å®‰è£…docke 19.03.15ç‰ˆæœ¬ï¼Œå› ä¸ºè¿™ä¸ªç‰ˆæœ¬æ¯”è¾ƒç¨³å®š</span><br><span class="line">yum install -y docker-ce-19.03.15 docker-ce-cli-19.03.15 containerd.io</span><br><span class="line">systemctl start docker &amp;&amp; systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">containerd.ioï¼šå®¹å™¨è¿è¡Œæ—¶ï¼Œç”¨k8sæ–°ç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥æ— ç—•ä»dockeå¯¹æ¥åˆ°containerdï¼Œé»˜è®¤å®‰è£…æœ€æ–°ç‰ˆ</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹æ˜¯å¦å‡ºç°è­¦å‘Šï¼Œå†çœ‹ä¸€ä¸‹æ˜¾ç¤ºçš„ç‰ˆæœ¬æ˜¯å¦å¯¹çš„ä¸Š</span><br><span class="line">[root@node01 ~]# docker info</span><br><span class="line">Client:</span><br><span class="line">...</span><br><span class="line"> Server Version: 19.03.15</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">#ç”Ÿäº§ä¸­å†åŠ 2ä¸ªæ­¥éª¤ï¼š</span></span><br><span class="line"><span class="comment">#4ã€ä¿®æ”¹æ•°æ®ç›®å½•</span></span><br><span class="line"><span class="comment">#5ã€dockerå›¾å½¢åŒ–ç•Œé¢</span></span><br><span class="line"> </span><br><span class="line">4ã€é…ç½®é•œåƒåŠ é€Ÿå’ŒCgroupé©±åŠ¨</span><br><span class="line"> <span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [</span></span><br><span class="line"><span class="string">  &quot;https://docker.1panel.live&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://dockercf.jsdelivr.fyi&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker-cf.registry.cyou&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.chenby.cn&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.jsdelivr.fyi&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.m.daocloud.io&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.m.daocloud.io&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.mirrors.sjtug.sjtu.edu.cn&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.nju.edu.cn&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://dockerproxy.com&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.rainbond.cc&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.registry.cyou&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://dockertest.jsdelivr.fyi&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://hub-mirror.c.163.com&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://hub.rat.dev/&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://mirror.aliyuncs.com&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://mirror.baidubce.com&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://mirror.iscas.ac.cn&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://registry.docker-cn.com&quot;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€æµ‹è¯•æ‹‰å–</span><br><span class="line">[root@node01 ~]# docker pull busybox</span><br><span class="line">[root@node01 ~]# docker images</span><br></pre></td></tr></table></figure><p><strong>â‘¢ã€å®‰è£…kubeadm</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######4å°æœºå™¨éƒ½æ‰§è¡Œ ####</span></span><br><span class="line">1ã€æ›´æ¢åä¸ºæº</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.huaweicloud.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.huaweicloud.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.huaweicloud.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">2ã€å®‰è£…kubelet nodeèŠ‚ç‚¹å®¹å™¨è¿è¡Œæ—¶çš„æ§åˆ¶å™¨ kubeadmåšk8sé›†ç¾¤ kubectlæ˜¯k8sçš„å®¢æˆ·ç«¯å‘½ä»¤ ipvsadmåŠ è½½jpvsæ¨¡å—</span><br><span class="line">yum install kubelet-1.19.3 kubeadm-1.19.3  kubectl-1.19.3  ipvsadm -y</span><br><span class="line"></span><br><span class="line">systemctl start kubelet.service &amp;&amp; systemctl <span class="built_in">enable</span> kubelet.service </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubelet-1.19.3 ï¼šæ§åˆ¶å®¹å™¨è¿è¡Œæ—¶</span><br><span class="line">kubeadm-1.19.3  ï¼šç±»ä¼¼äºstream</span><br><span class="line">kubectl-1.19.3  ï¼šæ‰§è¡Œk8så‘½ä»¤éœ€è¦çš„å®¢æˆ·ç«¯</span><br><span class="line">ipvsadmï¼šä¸Šé¢é…ç½®IPVSæ¨¡å—ï¼Œéœ€è¦ä½¿ç”¨è¿™ä¸ªå‘½ä»¤</span><br></pre></td></tr></table></figure><p><strong>â‘£ã€master01åˆå§‹åŒ–é›†ç¾¤</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#####å¦‚ä¸‹æ“ä½œåªèƒ½master01æ‰§è¡Œ(masterèŠ‚ç‚¹æ‰§è¡Œ)ï¼Œå…¶ä»–æœºå™¨ä¸è¦æ‰§è¡Œ</span></span><br><span class="line">1ã€åˆå§‹åŒ–é›†ç¾¤   å¤§æ¦‚è¦ç­‰å¾…å‡ åˆ†é’Ÿ</span><br><span class="line">[root@master01 ~]# kubeadm init \</span><br><span class="line">--apiserver-advertise-address=10.0.0.200 \</span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers  \</span><br><span class="line">--kubernetes-version=v1.19.3 \</span><br><span class="line">--service-cidr=10.1.0.0/16 \</span><br><span class="line">--pod-network-cidr=10.2.0.0/16 \</span><br><span class="line">--service-dns-domain=cluster.local \</span><br><span class="line">--ignore-preflight-errors=Swap \</span><br><span class="line">--ignore-preflight-errors=NumCPU</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#åªæœ‰ä¸€ä¸ªmasterçš„å†™æ³•</span></span><br><span class="line">--apiserver-advertise-address=masterçš„ip \</span><br><span class="line"><span class="comment">#é•œåƒä»“åº“çš„åœ°å€ é˜¿é‡Œäº‘çš„è°·æ­Œå®¹å™¨çš„</span></span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers  \</span><br><span class="line">--kubernetes-version=v1.19.3 \</span><br><span class="line"><span class="comment">#serviceèµ„æºï¼Œè®¾ç½®cluster ipç½‘æ®µ</span></span><br><span class="line">--service-cidr=10.1.0.0/16 \</span><br><span class="line"><span class="comment">#è®¾ç½®pod ipçš„ç½‘æ®µ</span></span><br><span class="line">--pod-network-cidr=10.2.0.0/16 \</span><br><span class="line"><span class="comment">#ä½¿ç”¨æœ¬åœ°çš„dns</span></span><br><span class="line">--service-dns-domain=cluster.local \</span><br><span class="line"><span class="comment">#å¿½ç•¥swapçš„æŠ¥é”™</span></span><br><span class="line">--ignore-preflight-errors=Swap \</span><br><span class="line"><span class="comment">#å¿½ç•¥cpuçš„æŠ¥é”™</span></span><br><span class="line">--ignore-preflight-errors=NumCPU</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ä¿å­˜æœ€åå‡ è¡Œå†…å®¹</span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line">  <span class="comment">#å…¶ä»–nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤</span></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line">kubeadm <span class="built_in">join</span> 10.0.0.200:6443 --token cgex1m.9ck6cjchon5xn4j5 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:273cdce81c642065666a2d0eb4fd0c3097df69e984fa50836b8daf2ed10de18a </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¿»è¯‘</span></span><br><span class="line">æ‚¨çš„Kubernetesæ§åˆ¶å¹³é¢å·²æˆåŠŸåˆå§‹åŒ–ï¼</span><br><span class="line">è¦å¼€å§‹ä½¿ç”¨é›†ç¾¤ï¼Œæ‚¨éœ€è¦ä»¥æ™®é€šç”¨æˆ·èº«ä»½è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</span><br><span class="line">mkdir-p<span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">sudo</span> cp-i/etc/kubernetes/admin.conf<span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span>$ï¼ˆid-uï¼‰ï¼š$ï¼ˆid-gï¼‰<span class="variable">$HOME</span>/.kube/config</span><br><span class="line">ç°åœ¨ï¼Œæ‚¨åº”è¯¥å°†podç½‘ç»œéƒ¨ç½²åˆ°é›†ç¾¤ã€‚</span><br><span class="line">ä½¿ç”¨ä»¥ä¸‹åˆ—å‡ºçš„é€‰é¡¹ä¹‹ä¸€è¿è¡Œâ€œkubectl apply-f[podnetwork].yamlâ€ï¼š</span><br><span class="line">https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line">ç„¶åï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥rootèº«ä»½åœ¨æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åŠ å…¥ä»»æ„æ•°é‡çš„å·¥ä½œèŠ‚ç‚¹ï¼š</span><br><span class="line">kubeadm <span class="built_in">join</span> 10.0.0.200:6443 --token cgex1m.9ck6cjchon5xn4j5 \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:273cdce81c642065666a2d0eb4fd0c3097df69e984fa50836b8daf2ed10de18a</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">3ã€å¯ä»¥çœ‹åˆ°å¤šäº†å¥½å‡ ä¸ªé•œåƒï¼Œè¯´æ˜åˆšæ‰çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œæ‹‰å–äº†éœ€è¦çš„é•œåƒ</span><br><span class="line">[root@master01 ~]# docker images</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">4ã€æ‰§è¡Œè¿™å‡ ä¸ªå‘½ä»¤   åˆ›å»ºéšè—ç›®å½•ï¼Œæ‹·è´é…ç½®æ–‡ä»¶ï¼Œæˆæƒ</span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€æŸ¥çœ‹k8sé›†ç¾¤èŠ‚ç‚¹ï¼Œ ä¼šçœ‹åˆ°masterä¸»èŠ‚ç‚¹</span><br><span class="line">[root@master01 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS     ROLES    AGE     VERSION</span><br><span class="line">master01   NotReady   master   4m32s   v1.19.3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###############nodeèŠ‚ç‚¹æ“ä½œç¬¬6æ­¥  node01 node02 node03</span></span><br><span class="line">6ã€ç›®å‰åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¦å°†å…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</span><br><span class="line"><span class="comment">##æ³¨æ„ï¼šè¿™ä¸ªå‘½ä»¤è¦ä¿å­˜å¥½ï¼Œå› ä¸ºæ¨ªå‘æ‰©å±•ï¼Œå°†èŠ‚ç‚¹åŠ å…¥é›†ç¾¤éœ€è¦ä½¿ç”¨</span></span><br><span class="line">[root@master01 ~]# kubeadm <span class="built_in">join</span> 10.0.0.200:6443 --token cgex1m.9ck6cjchon5xn4j5 \</span><br><span class="line">--discovery-token-ca-cert-hash</span><br><span class="line">sha256:273cdce81c642065666a2d0eb4fd0c3097df69e984fa50836b8daf2ed10de18a </span><br><span class="line"><span class="comment">##########################################  </span></span><br><span class="line">  </span><br><span class="line">7ã€åŠ å…¥é›†ç¾¤å‘½ä»¤æ‰§è¡Œä¹‹åï¼Œæœ€åä¸€è¡Œä¿¡æ¯æ˜¾ç¤ºå¦‚ä¸‹</span><br><span class="line">Run <span class="string">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class="built_in">join</span> the cluster.</span><br><span class="line">åœ¨æ§åˆ¶å¹³é¢ä¸Š(master)è¿è¡Œâ€œkubectl get nodesâ€ä»¥æŸ¥çœ‹æ­¤èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">8ã€#åˆ°master01æ‰§è¡Œkubectl get nodes</span><br><span class="line">[root@master01 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS     ROLES    AGE     VERSION</span><br><span class="line">master01   NotReady   master   9m33s   v1.19.3</span><br><span class="line">node01     NotReady   &lt;none&gt;   3m48s   v1.19.3</span><br><span class="line">node02     NotReady   &lt;none&gt;   118s    v1.19.3</span><br><span class="line">node03     NotReady   &lt;none&gt;   106s    v1.19.3</span><br><span class="line"></span><br><span class="line">ç°åœ¨çš„çŠ¶æ€æ˜¯NotReadyæ²¡æœ‰å‡†å¤‡å¥½çš„ï¼Œå› ä¸ºç½‘ç»œè¿˜æ²¡é…</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">9ã€è®¾ç½®kube-proxyä½¿ç”¨ipvsæ¨¡å¼</span><br><span class="line">k8sé»˜è®¤ä½¿ç”¨çš„æ˜¯iptablesé˜²ç«å¢™ï¼Œå¯ä»¥ä¿®æ”¹æˆæ€§èƒ½æ›´é«˜çš„ipvsæ¨¡å¼ï¼Œè¯¥æ¨¡å¼LVSä¹Ÿåœ¨ä½¿ç”¨</span><br><span class="line">[root@master01 ~]# kubectl edit cm kube-proxy -n kube-system</span><br><span class="line"> 44è¡Œ     </span><br><span class="line"> mode: <span class="string">&quot; &quot;</span> æ”¹ä¸º mode: <span class="string">&quot;ipvs&quot;</span></span><br><span class="line"> </span><br><span class="line">10ã€æŸ¥çœ‹åç§°ç©ºé—´</span><br><span class="line">[root@master01 ~]# kubectl get ns</span><br><span class="line">æˆ–è€…</span><br><span class="line">[root@master01 ~]# kubectl get namespace</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   45m</span><br><span class="line">kube-node-lease   Active   45m</span><br><span class="line">kube-public       Active   45m</span><br><span class="line">kube-system       Active   45m</span><br><span class="line"></span><br><span class="line">11ã€æŸ¥çœ‹æŒ‡å®šåç§°ç©ºé—´ä¸­çš„podä¿¡æ¯</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-system</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d56c8448f-85k2r           0/1     Pending   0          46m <span class="comment">#DNSæœåŠ¡å™¨</span></span><br><span class="line">coredns-6d56c8448f-cn2t9           0/1     Pending   0          46m <span class="comment">#DNSæœåŠ¡å™¨</span></span><br><span class="line">etcd-master01                      1/1     Running   0          46m <span class="comment">#æ•°æ®åº“etcd</span></span><br><span class="line">kube-apiserver-master01            1/1     Running   0          46m <span class="comment">#å¸ä»¤éƒ¨ipserver</span></span><br><span class="line">kube-controller-manager-master01   1/1     Running   0          46m <span class="comment">#æ§åˆ¶å™¨controller</span></span><br><span class="line">kube-proxy-2wfhq                   1/1     Running   0          38m <span class="comment">#ç½‘ç»œã€ç«¯å£æ˜ å°„å°„kube-proxy  æœ‰4ä¸ªæ˜¯å› ä¸ºè¿™ä¸ªé›†ç¾¤é‡Œé¢æœ‰4å°æœºå™¨</span></span><br><span class="line">kube-proxy-8tmqx                   1/1     Running   0          40m <span class="comment">#ç½‘ç»œã€ç«¯å£æ˜ å°„å°„kube-proxy</span></span><br><span class="line">kube-proxy-fr9dl                   1/1     Running   0          39m <span class="comment">#ç½‘ç»œã€ç«¯å£æ˜ å°„å°„kube-proxy</span></span><br><span class="line">kube-proxy-pz4ms                   1/1     Running   0          46m <span class="comment">#ç½‘ç»œã€ç«¯å£æ˜ å°„å°„kube-proxy</span></span><br><span class="line">kube-scheduler-master01            1/1     Running   0          46m <span class="comment">#èµ„æºè°ƒåº¦scheduler</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">12ã€æŸ¥çœ‹æŒ‡å®šåç§°ç©ºé—´ä¸­podçš„è¯¦ç»†ä¿¡æ¯  å¯ä»¥çœ‹åˆ°èµ·åœ¨å“ªå°æœºå™¨ä¸Š</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-system -o wide</span><br><span class="line"></span><br><span class="line">ç”¨çš„DaemonSetæ§åˆ¶å™¨ï¼Œæ¯å°æœ‰ä¸”åªèƒ½èµ·ä¸€ä¸ª</span><br><span class="line"></span><br><span class="line">13ã€é‡å¯pod</span><br><span class="line">æŠŠä»–åˆ æ‰ï¼Œå°±ä¼šè‡ªåŠ¨æ‹‰èµ·ï¼Œä»¥åæœ‰å“ªä¸ªç»„ä»¶åäº†ï¼Œå°±åˆ æ‰é‡æ–°æ‹‰èµ·</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-system|grep <span class="string">&#x27;kube-proxy&#x27;</span>|awk <span class="string">&#x27;&#123;print &quot;kubectl delete pod -n kube-system &quot;$1&#125;&#x27;</span>|bash</span><br></pre></td></tr></table></figure><p>**â‘¤ã€master é…ç½®flanale **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#éƒ¨ç½²ç½‘ç»œæ’ä»¶flanaleï¼Œè®©æ‰€æœ‰èŠ‚ç‚¹ç½‘ç»œæ‰“é€š</span></span><br><span class="line"><span class="comment">##############master01æ‰§è¡Œ#####</span></span><br><span class="line">é“¾æ¥åœ°å€ï¼š</span><br><span class="line">https://github.com/flannel-io/flannel/blob/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line">1ã€ä¸‹è½½èµ„æºæ¸…å•</span><br><span class="line">[root@master01 ~]# wget https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ä¿®æ”¹flannelèµ„æºæ¸…å•</span><br><span class="line">[root@master01 ~]# vim  kube-flannel.yml </span><br><span class="line">       <span class="comment">#æœç´¢net-conf.jsonï¼Œä¿®æ”¹ç½‘æ®µä¸ºè§„åˆ’çš„pod ip  </span></span><br><span class="line">      <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;10.2.0.0/16&quot;</span>,</span><br><span class="line">      ......</span><br><span class="line">      .....</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        <span class="comment">#æœç´¢ containersï¼Œæ–°å¢ä½¿ç”¨çš„ç½‘å¡</span></span><br><span class="line">        - --iface=eth0</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">#æœç´¢containersï¼Œå¦‚æœå‡ºç°è¿™ä¸ªæ ‡ç­¾ï¼Œå°±æŠŠè¿™ä¸ªæ ‡ç­¾é‡Œé¢çš„3è¡Œå†…å®¹åˆ æ‰</span></span><br><span class="line">        spec:</span><br><span class="line">          selector:  <span class="comment">#åˆ æ‰</span></span><br><span class="line">            matchLabels:  <span class="comment">#åˆ æ‰</span></span><br><span class="line">            app: flannel  <span class="comment">#åˆ æ‰</span></span><br><span class="line"></span><br><span class="line">app: flannelæ˜¯ä¸€ä¸ªæ ‡ç­¾é€‰æ‹©å™¨ï¼Œåªæœ‰æ‰“äº†appæ ‡ç­¾çš„nodeï¼Œæ‰ä¼šå®‰è£…flannel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€åªè¦ä¿®æ”¹äº†flannelèµ„æºæ¸…å•ï¼Œå°±è¦æ‰§è¡Œåº”ç”¨flannelèµ„æºæ¸…å•</span><br><span class="line">[root@master01 ~]# kubectl apply -f kube-flannel.yml</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">4ã€#æ£€æŸ¥è¿™å‡ ä¸ªçŠ¶æ€</span><br><span class="line">â‘ ã€æ£€æŸ¥flannelçš„podæ˜¯å¦å¯åŠ¨æˆåŠŸ   4ä¸ªSTATUSæ˜¾ç¤ºRunningå°±æ˜¯æˆåŠŸ</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-4ncf5   1/1     Running   0          4m20s</span><br><span class="line">kube-flannel-ds-7dnxx   1/1     Running   0          4m20s</span><br><span class="line">kube-flannel-ds-dpzqp   1/1     Running   0          4m20s</span><br><span class="line">kube-flannel-ds-knmch   1/1     Running   0          4m20s</span><br><span class="line"></span><br><span class="line">â‘¡ã€æ£€æŸ¥k8sé›†ç¾¤èŠ‚ç‚¹çŠ¶æ€    STATUSæ˜¾ç¤ºReadyå°±æ˜¯å‡†å¤‡å¥½çš„ï¼Œé›†ç¾¤ä¹‹é—´èµ·çš„podå°±å¯ä»¥äº’ç›¸é€šä¿¡äº†</span><br><span class="line">[root@master01 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS   ROLES    AGE   VERSION</span><br><span class="line">master01   Ready    master   81m   v1.19.3</span><br><span class="line">node01     Ready    &lt;none&gt;   75m   v1.19.3</span><br><span class="line">node02     Ready    &lt;none&gt;   73m   v1.19.3</span><br><span class="line">node03     Ready    &lt;none&gt;   73m   v1.19.3</span><br><span class="line"></span><br><span class="line">â‘¢ã€æ£€æŸ¥corednsæ˜¯å¦æ­£å¸¸è¿è¡Œ   åªè¦ç½‘ç»œé…å¥½ï¼Œdnså°±okäº†ï¼ŒSTATUSæ˜¾ç¤ºRunningçŠ¶æ€</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-system</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d56c8448f-85k2r           1/1     Running   0          81m</span><br><span class="line">coredns-6d56c8448f-cn2t9           1/1     Running   0          81m</span><br><span class="line">etcd-master01                      1/1     Running   0          81m</span><br><span class="line">kube-apiserver-master01            1/1     Running   0          81m</span><br><span class="line">kube-controller-manager-master01   1/1     Running   0          81m</span><br><span class="line">kube-proxy-2skng                   1/1     Running   0          30m</span><br><span class="line">kube-proxy-fxwbg                   1/1     Running   0          30m</span><br><span class="line">kube-proxy-w6v6r                   1/1     Running   0          30m</span><br><span class="line">kube-proxy-zng7l                   1/1     Running   0          30m</span><br><span class="line">kube-scheduler-master01            1/1     Running   0          81m</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nodeè®¾ç½®è§’è‰²ä¿¡æ¯   </span></span><br><span class="line"> kubectl label node node01 node-role.kubernetes.io/node=</span><br><span class="line"> kubectl label node node02 node-role.kubernetes.io/node=</span><br><span class="line"> kubectl label node node03 node-role.kubernetes.io/node=</span><br></pre></td></tr></table></figure><h3 id="2ã€å®‰è£…kubectlå‘½ä»¤è¡¥å…¨é»‘ç§‘æŠ€">2ã€<strong>å®‰è£…kubectlå‘½ä»¤è¡¥å…¨é»‘ç§‘æŠ€</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¯ä»¥tabè¡¥å…¨çš„å·¥å…·</span></span><br><span class="line"></span><br><span class="line">yum install -y bash-completion</span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion </span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash) </span><br><span class="line">kubectl completion bash &gt; /etc/bash_completion.d/kubectl</span><br><span class="line"></span><br><span class="line">å®‰è£…å®Œæˆéœ€è¦é€€å‡ºåœ¨é‡æ–°è¿æ¥</span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl ap æŒ‰tabå¯ä»¥è¡¥å…¨äº†</span><br><span class="line">api-resources  api-versions   apply          </span><br><span class="line">[root@master01 ~]# kubectl get namespaces æŒ‰tabå¯ä»¥è¡¥å…¨äº†</span><br><span class="line">default          kube-flannel     kube-node-lease  kube-public      kube-system  </span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">è¿™ç¯‡æ–‡ç« å†™äº†éƒ¨ç½²k8sï¼Œè¶…çº§è¯¦ç»†ï¼Œæœ‰éœ€è¦çš„å°ä¼™ä¼´å¯ä»¥æŸ¥çœ‹</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰1ã€K8såŸºç¡€å’Œèµ„æºä»‹ç»</title>
    <link href="https://www.fomal.cc/posts/4b5e2999.html"/>
    <id>https://www.fomal.cc/posts/4b5e2999.html</id>
    <published>2024-09-22T06:42:38.000Z</published>
    <updated>2024-09-22T07:53:34.221Z</updated>
    
    <content type="html"><![CDATA[<h2 id="K8såŸºç¡€å’Œèµ„æºä»‹ç»">K8såŸºç¡€å’Œèµ„æºä»‹ç»</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">k8æ˜¯å¯¹å®¹å™¨çš„ç¼–æ’å·¥å…·ï¼Œä¹‹å‰ä½¿ç”¨çš„docker-composeæ˜¯å•æœºç¼–æ’</span><br><span class="line"></span><br><span class="line">k8såŸç”Ÿçš„è¯­è¨€ï¼šgoè¯­è¨€</span><br><span class="line"></span><br><span class="line">ç®¡ç†k8sé›†ç¾¤å·¥å…·ï¼š</span><br><span class="line">1ã€vsocde</span><br><span class="line">2ã€rancherï¼ˆwebå›¾å½¢åŒ–ç•Œé¢ï¼‰</span><br><span class="line">3ã€k9s</span><br><span class="line"></span><br><span class="line"><span class="comment">#å’Œk8sç±»ä¼¼çš„ç¼–æ’å·¥å…·</span></span><br><span class="line">borg   </span><br><span class="line">swarm(dockerå†™çš„)</span><br><span class="line">mesos </span><br><span class="line">è¿™äº›éƒ½åœ¨ä¹‹å‰ä½¿ç”¨çš„ç¼–æ’å·¥å…·ï¼Œä½†ç°åœ¨k8sç«èµ·æ¥äº†ï¼Œä»–ä»¬å°±ä¸æ€ä¹ˆç”¨äº†</span><br></pre></td></tr></table></figure><h3 id="1ã€K8så‚è€ƒç½‘ç«™">1ã€<strong>K8så‚è€ƒç½‘ç«™</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å®˜ç½‘ï¼šhttps://kubernetes.io</span><br><span class="line">å®˜æ–¹æ–‡æ¡£ï¼šhttps://kubernetes.io/zh-cn/docs/home/</span><br><span class="line">kubeadmå®˜æ–¹æ–‡æ¡£ï¼šhttps://kubernetes.io/zh-cn/docs/setup/production-environment/tools/</span><br><span class="line">dockerå®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.docker.com/</span><br><span class="line">prometheuså®˜æ–¹æ–‡æ¡£ï¼šhttps://prometheus.io/docs/introduction/overview/</span><br><span class="line">ansibleå®‰è£…k8sé¡¹ç›®ï¼šhttps://github.com/easzlab/kubeasz?tab=readme-ov-file</span><br><span class="line">é˜¿é‡Œäº‘ACKï¼šhttps://www.aliyun.com/product/kubernetes</span><br><span class="line">äºšé©¬é€Šäº‘EKSï¼šhttps://aws.amazon.com/cn/eks/?nc2=h_ql_prod_ct_eks</span><br></pre></td></tr></table></figure><h3 id="2ã€K8sçš„2å¤§ç»„ä»¶">2ã€<strong>K8sçš„2å¤§ç»„ä»¶</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c/sç»“æ„çš„</span><br><span class="line"></span><br><span class="line">1ã€masterç»„ä»¶(æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl Plane Componentsï¼‰)</span><br><span class="line"></span><br><span class="line">2ã€nodeç»„ä»¶</span><br></pre></td></tr></table></figure><ul><li><strong>1ã€masterç»„ä»¶    (æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl Plane Componentsï¼‰)</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1ã€kube-apiserver(apiserver)ï¼šç±»ä¼¼äºå¸ä»¤éƒ¨ï¼Œæ‰€æœ‰masterä¸Šçš„ç»„ä»¶å·¥ä½œéƒ½è¦ç»è¿‡apiserver</span><br><span class="line">(å½“åœ¨å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤æˆ–è€…åœ¨UIç•Œé¢æ“ä½œèµ·ä¸€ä¸ªå®¹å™¨éƒ½éœ€è¦ç»è¿‡api,ä»–ä¼šé€šçŸ¥å…¶ä»–ç»„ä»¶ï¼Œæ‰€æœ‰ç»„ä»¶è°ƒç”¨ä»€ä¹ˆä¸œè¥¿æˆ–è€…è®¡ç®—ä»€ä¹ˆä¸œè¥¿éƒ½è¦ç»è¿‡ä»–)</span><br><span class="line"></span><br><span class="line">2ã€etcdï¼šæ‰€æœ‰ç»„ä»·äº§ç”Ÿçš„æ•°æ®å­˜æ”¾ä½ç½®ï¼Œå‚¨å­˜æ‰€æœ‰å‘½ä»¤ã€èµ„æºæ¸…å•ã€è¯ä¹¦ä¿¡ä»»ã€webæ“ä½œåŠå…¶ä»–ç»„ä»¶æ•°æ®</span><br><span class="line">(å¦‚æœè¿™ä¸ªå®•äº†ï¼Œè¿™ä¸€å¥—é›†ç¾¤å°±åºŸäº†ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™å¥—é›†ç¾¤éœ€è¦é‡æ–°æ­å»ºï¼Œè€Œä¸æ˜¯ä¿®å¤ä¸€å°etcd)</span><br><span class="line"></span><br><span class="line">3ã€kube-scheduler(scheduler  æ—¶è¯¥ä¸¢äº†å„¿)ï¼šèµ„æºè®¡ç®—ã€èµ„æºè°ƒåº¦</span><br><span class="line">(æ¯”å¦‚è¯´åœ¨å‘½ä»¤è¡Œæ‰§è¡Œåˆ›å»º10å°å®¹å™¨ï¼Œå…ˆç»è¿‡ä»–apiserverï¼Œä¼šæŠŠæœŸæœ›å€¼å­˜æ¡£etcd,ç„¶åé€šçŸ¥schedulerå»etcdæŠŠæ•°æ®å–å‡ºæ¥)</span><br><span class="line"></span><br><span class="line">4ã€kube-controller-manager(controller  æŠ—æŠ½äº†å„¿)ï¼šæ§åˆ¶å™¨ï¼Œæ§åˆ¶nodeç»„ä»¶å¯åŠ¨å®¹å™¨</span><br><span class="line">(scheduleåšå®Œèµ„æºçš„è®¡ç®—è°ƒåº¦,æ•°æ®å­˜æ¡£etcdäº†,controlleré€šè¿‡apiserveræ‹¿åˆ°æ•°æ®ï¼Œä¼šæ§åˆ¶nodeç»„ä»¶å¯åŠ¨)</span><br></pre></td></tr></table></figure><ul><li><strong>2ã€nodeç»„ä»¶</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1ã€kubeletï¼šæ§åˆ¶dockerå¯åŠ¨å®¹å™¨(æ§åˆ¶å®¹å™¨è¿æ—¶ï¼Œå¯åŠ¨æŒ‡å®šå®¹å™¨)</span><br><span class="line">(æ¯ä¸€ä¸ªnodeéƒ½è¦è£…)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer runtimeï¼‰</span><br><span class="line"> (æ¯ä¸€ä¸ªnodeèŠ‚ç‚¹ä¸Šå¾—è£…ä¸€ä¸ªå®¹å™¨è¿è¡Œæ—¶)</span><br><span class="line">    - containerd</span><br><span class="line">    - CRI-O</span><br><span class="line">    - Docker Engine</span><br><span class="line">    - Mirantis Container Runtime</span><br><span class="line"></span><br><span class="line">3ã€kube-proxyï¼ˆå¯é€‰ï¼‰ï¼šPODç«¯å£æ˜ å°„ï¼Œç½‘ç»œç›¸å…³</span><br><span class="line">å¯ä»¥ç†è§£ä¸ºpodå°±æ˜¯å®¹å™¨</span><br><span class="line">èµ·podéœ€è¦åšç«¯å£æ˜ å°„ï¼Œä»–å°±æ˜¯åšç«¯å£æ˜ å°„çš„å·¥å…·</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#k8sä¸‰å¤§æ¥å£APIäºŒæ¬¡å¼€å‘ï¼Œè°ƒç”¨æ¥å£</span></span><br><span class="line">CRIï¼šruntimeï¼Œå®¹å™¨æ“ä½œæ¥å£</span><br><span class="line">CNIï¼šnetworkï¼Œç½‘ç»œæ“ä½œæ¥å£</span><br><span class="line">CSIï¼šstorageï¼Œå‚¨å­˜æ“ä½œæ¥å£</span><br></pre></td></tr></table></figure><h3 id="3ã€K8sæ¶æ„">3ã€<strong>K8sæ¶æ„</strong></h3><p>å•æœºèŠ‚ç‚¹æ¶æ„</p><p><img src="../image/study_img/image-20240912101412211.png" alt="image-20240912101412211"></p><p>é«˜å¯ç”¨æ¶æ„</p><p><img src="../image/study_img/image-20240912163330677.png" alt="image-20240912163330677"></p><p><img src="../image/study_img/image-20240912102531543.png" alt="image-20240912102531543"></p><p>podåˆ›å»ºæµç¨‹</p><p><img src="../image/study_img/image-20240912103904760.png" alt="image-20240912103904760"></p><p><img src="../image/study_img/image-20240912173745374.png" alt="image-20240912173745374"></p><h3 id="4ã€k8sæ ¸å¿ƒèµ„æº-æ“ä½œå¯¹è±¡">4ã€<strong>k8sæ ¸å¿ƒèµ„æº(æ“ä½œå¯¹è±¡)</strong></h3><p><strong>â‘ ã€podèµ„æº</strong></p><p>â‘ ä»€ä¹ˆæ˜¯pod<br>1ã€Podæ˜¯K8sçš„æœ€å°å•ä½<br>2ã€Podçš„IPåœ°å€æ˜¯éšæœºçš„ï¼Œåˆ é™¤Podä¼šæ”¹å˜IP<br>3ã€Podéƒ½æœ‰ä¸€ä¸ªæ ¹å®¹å™¨<br>4ã€ä¸€ä¸ªPodå†…å¯ä»¥ç”±ä¸€ä¸ªå®¹å™¨æˆ–å¤šä¸ªå®¹å™¨ç»„æˆ<br>5ã€ä¸€ä¸ªPodå†…çš„å®¹å™¨å…±äº«æ ¹å®¹å™¨çš„ç½‘ç»œã€åç§°ç©ºé—´ã€å’Œæ–‡ä»¶ç³»ç»Ÿå·    (æ¯”å¦‚è¯´èµ·ä¸€ä¸ªnginxçš„pod,ä»–ä¼šå’Œæ ¹å®¹å™¨å…±äº«ç½‘ç»œã€åç§°ç©ºé—´ã€å’Œæ–‡ä»¶ç³»ç»Ÿã€‚åŸç†æ˜¯ï¼šæ ¹å®¹å™¨é‡Œé¢çš„ç½‘ç»œæ¨¡å¼ç”¨çš„æ˜¯dockerç½‘ç»œæ¨¡å¼ä¸­çš„Containeræ¨¡å¼)<br>6ã€ä¸€ä¸ªPodå†…çš„ç½‘ç»œåœ°å€ç”±æ ¹å®¹å™¨æä¾›</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¯·é—®è´µå…¬å¸k8sæ¶æ„ä¸€ä¸ªpodé‡Œé¢èµ·å‡ ä¸ªå®¹å™¨</span><br><span class="line"></span><br><span class="line"> ç­”ç²¾ç¡®çš„æ•°å­—å°±æ˜¯é”™è¯¯çš„ï¼Œé¦–å…ˆåº”è¯¥podé‡Œé¢èµ·å‡ ä¸ªå®¹å™¨å–å†³äºé¡¹ç›®</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240912104532405.png" alt="image-20240912104532405"></p><p>â‘¡podè¿è¡ŒçŠ¶æ€ï¼Œåªè¦è®°ä½ä¸æ˜¯runingçŠ¶æ€å°±æ˜¯æœ‰é—®é¢˜çš„</p><table><thead><tr><th>çŠ¶æ€</th><th>æè¿°</th></tr></thead><tbody><tr><td>Pendingï¼ˆç­‰å¾…ï¼‰</td><td>Podå·²ç»è¢«K8Sç³»ç»Ÿæ¥å—ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ï¼Œå°šæœªåˆ›å»ºï¼Œäº¦æœªè¿è¡Œã€‚æ­¤é˜¶æ®µåŒ…æ‹¬ç­‰å¾…Podè¢«è°ƒåº¦çš„æ—¶é—´å’Œé€šè¿‡ç½‘ç»œä¸‹è½½é•œåƒçš„æ—¶é—´</td></tr><tr><td>Runningï¼ˆè¿è¡Œï¼‰</td><td>Podå·²ç»ç»‘å®šåˆ°æŸä¸ªèŠ‚ç‚¹(node)ï¼ŒPodä¸­æ‰€æœ‰å®¹å™¨éƒ½å·²è¢«åˆ›å»ºï¼Œè‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ä»åœ¨è¿è¡Œï¼Œæˆ–è€…å¤„äºå¯åŠ¨æˆ–é‡å¯çŠ¶æ€</td></tr><tr><td>Succeededï¼ˆæˆåŠŸï¼‰</td><td>Podä¸­æ‰€æœ‰å®¹å™¨éƒ½å·²æˆåŠŸç»ˆæ­¢ï¼Œå¹¶ä¸”ä¸ä¼šå†é‡å¯</td></tr><tr><td>Failedï¼ˆå¤±è´¥ï¼‰</td><td>Podä¸­æ‰€æœ‰å®¹å™¨éƒ½å·²æˆåŠŸç»ˆæ­¢ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå®¹å™¨æ˜¯å› ä¸ºå¤±è´¥è€Œç»ˆæ­¢</td></tr><tr><td>Unknownï¼ˆæœªçŸ¥ï¼‰</td><td>å› ä¸ºæŸäº›åŸå› æ— æ³•è·å–PodçŠ¶æ€ï¼Œè¿™ç§æƒ…å†µï¼Œé€šå¸¸æ˜¯å› ä¸ºä¸Podæ‰€åœ¨ä¸»æœºé€šä¿¡å¤±è´¥</td></tr></tbody></table><p><strong>â‘¡ã€serviceèµ„æº</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serviceä¹Ÿæ˜¯k8sæ ¸å¿ƒèµ„æºä¹‹ä¸€ï¼Œserviceå®šä¹‰äº†æœåŠ¡çš„å…¥å£åœ°å€ï¼Œç”¨æ¥å°†åç«¯çš„podæœåŠ¡æš´éœ²ç»™å¤–éƒ¨çš„ç”¨æˆ·è®¿é—®</span><br></pre></td></tr></table></figure><p>serviceæä¾›äº†2ç§ç½‘ç»œèµ„æº</p><p><img src="../image/study_img/image-20240912180101026.png" alt="image-20240912180101026"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€ç§ï¼šNodePort  å®¿ä¸»æœºç«¯å£æ˜ å°„clusteripç«¯å£ï¼Œå¯¹å¤–æä¾›æœåŠ¡</span><br><span class="line"></span><br><span class="line">ç¬¬äºŒç§ï¼šClusterIP  podçš„è´Ÿè½½å‡è¡¡(èµ·10ä¸ªpod,clusteripå¯ä»¥ç»™è¿™äº›podè´Ÿè½½ï¼Œä½†æ˜¯clusteripæ˜¯å†…ç½‘ipï¼Œå®¿ä¸»æœºè¿˜æ˜¯ä¸èƒ½è®¿é—®ï¼Œæ‰€ä»¥serviceåˆæä¾›äº†nodeport)</span><br><span class="line"></span><br><span class="line"><span class="comment">#é—®é¢˜ï¼šPODçš„IPæ˜¯éšæœºçš„ï¼Œå¦‚æœä¸€ä¸ªPODå®•æœºäº†ï¼Œk8sä¼šè‡ªåŠ¨æ‹‰èµ·ä¸€ä¸ªæ–°çš„pod,ipå˜äº†å¦‚ä½•åŠ å…¥åˆ°ClusterIPè¿™ä¸ªè´Ÿè½½å‡è¡¡é›†ç¾¤ä¸­ï¼Ÿ</span></span><br><span class="line">è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨DNSè§£æPODçš„IPåˆ°ä¸€ä¸ª<span class="string">&#x27;å­—ç¬¦ä¸²ä¸Š&#x27;</span>(æ¯ä¸ªpodå¯åŠ¨éƒ½è¦åˆ°æ ‡ç­¾app:nginx)</span><br><span class="line">DNSçš„æœåŠ¡ï¼š</span><br><span class="line">    - coreDNS(k8sç”¨è¿™ä¸ª)</span><br><span class="line">    - bind9(æ¯”è¾ƒéº»çƒ¦)</span><br><span class="line">    - dnsmsq(å†…å¤–çš„dnsç”¨)</span><br></pre></td></tr></table></figure><p><strong>â‘¢ã€labelæ ‡ç­¾èµ„æº</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Labelæ ‡ç­¾æ˜¯K8Sä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªå±æ€§ï¼ŒLabelæ ‡ç­¾å°±åƒèº«ä»½è¯ä¸€æ ·ï¼Œå¯ä»¥ç”¨æ¥è¯†åˆ«K8Sçš„å¯¹è±¡ã€‚</span><br><span class="line">ä¼ ç»Ÿæ¶æ„ä¸­ï¼Œä¸åŒçš„æœåŠ¡åº”ç”¨ä¹‹é—´é€šè®¯ï¼Œéƒ½æ˜¯é€šè¿‡IPå’Œç«¯å£ï¼Œä½†æ˜¯åœ¨K8Sä¸­å¾ˆå¤šåŒ¹é…å…³ç³»éƒ½æ˜¯é€šè¿‡æ ‡ç­¾æ¥æ‰¾ã€‚</span><br></pre></td></tr></table></figure><p><strong>â‘£ã€Namespaceèµ„æº</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Namespaceï¼ˆåç§°ç©ºé—´ï¼‰æ˜¯K8Sä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼ŒNamespaceå°†é›†ç¾¤å†…éƒ¨çš„èµ„æºè¿›è¡Œéš”ç¦»åˆ’åˆ†ã€‚</span><br><span class="line">åœ¨Namespaceä¸­ï¼Œå½¢æˆé€»è¾‘ä¸Šçš„ä¸åŒé¡¹ç›®ç»„æˆ–ç”¨æˆ·ç»„ã€‚</span><br></pre></td></tr></table></figure><p><strong>â‘¤ã€Controlleræ§åˆ¶å™¨èµ„æº</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Controllerç”¨æ¥ç®¡ç†Podã€‚</span></span><br><span class="line"><span class="comment">## Podæ§åˆ¶å™¨çš„ç§ç±»æœ‰å¾ˆå¤šï¼š</span></span><br><span class="line">  - RCèµ„æºï¼šå¯ä»¥åšçš„è‡ªåŠ¨æ‹‰èµ·ï¼Œæ§åˆ¶å¤šä¸ªå‰¯æœ¬ï¼Œä½†ç°åœ¨ä¸ç”¨äº†</span><br><span class="line">  - RS   RCæ§åˆ¶å™¨çš„å‡çº§ç‰ˆï¼Œå¯ä»¥è‡ªåŠ¨æ‹‰èµ·å®•æœºçš„POD</span><br><span class="line">  - Deployment  ç”Ÿäº§ä¸­å¸¸ç”¨çš„æ§åˆ¶å™¨ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼ŒåŒ…å«äº†RSæ§åˆ¶å™¨ï¼Œå¯¹é•œåƒåšç‰ˆæœ¬ç®¡ç†(æ¯”è¾ƒå¸¸ç”¨)</span><br><span class="line">  - DaemonSet   ä¿è¯æ‰€æœ‰nodeèŠ‚ç‚¹ä¸Šï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªpodè¿è¡Œ</span><br><span class="line">  - Staefulset  æœ‰çŠ¶æ€çš„åº”ç”¨(å¦‚mysqlçš„ä¸»ä»å¤åˆ¶)ï¼Œä¸ºpodæä¾›å”¯ä¸€æ ‡è¯†</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  åé¢èµ·podä¼šå†™èµ„æºæ¸…å•èµ·10ä¸ªnginxï¼ŒæŒ‚äº†ä¸€å°å°±ç›´æ¥æŒ‚äº†ï¼Œpodä¸ä¼šå†èµ·ä¸€å°ï¼Œè€Œèƒ½å¤Ÿæ‹‰èµ·çš„æ˜¯controllerèµ„æºï¼Œä»–ä¼šæ£€æµ‹èµ„æºæ¸…å•æ˜¯ä¸æ˜¯10ä¸ªpodéƒ½åœ¨ï¼Œå¦‚æœå°‘ä¸€ä¸ªï¼Œæ§åˆ¶å™¨ä¼šé‡æ–°æ‹‰èµ·ä¸€ä¸ªå†åŠ å…¥é›†ç¾¤</span><br></pre></td></tr></table></figure><p><strong>pod RC Service çš„å…³ç³»</strong></p><p><img src="../image/study_img/image-20240912120405666.png" alt="image-20240912120405666"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è‡ªåŠ¨æ‰©ç¼©å®¹ï¼š</span><br><span class="line">æ¯”å¦‚è¯´ç°åœ¨æœ‰10å°nginx,åŒåä¸€æµé‡ä¸Šæ¥äº†ï¼Œ10å°ä¸å¤Ÿç”¨ï¼Œæ€ä¹ˆåŠï¼Ÿ</span><br><span class="line">k8sæœ‰ä¸€ä¸ªèµ„æºï¼Œä¸€å¼€å§‹10ä¸ªnginxå°±å¤Ÿäº†ï¼Œæµé‡ä¸Šæ¥äº†ä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œæµé‡ä¸‹å»äº†ä¼šè‡ªåŠ¨ç¼©å®¹ï¼Œè€Œä¸”æ‰©å‡ºæ¥çš„podå’Œä¹‹å‰çš„podä¸€æ¨¡ä¸€æ ·</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å¼€å§‹å†™k8sçš„åŸºç¡€ä»‹ç»å•¦</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>åä¸€ã€ğŸ¡Cgroupèµ„æºæ§åˆ¶/æ·»åŠ ç£ç›˜</title>
    <link href="https://www.fomal.cc/posts/cb5f694f.html"/>
    <id>https://www.fomal.cc/posts/cb5f694f.html</id>
    <published>2024-09-22T06:33:37.000Z</published>
    <updated>2024-09-22T07:53:34.218Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Cgroup-èµ„æºæ§åˆ¶-æ·»åŠ ç£ç›˜">Cgroup(èµ„æºæ§åˆ¶)/æ·»åŠ ç£ç›˜</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1ã€#dockerå¦‚ä½•åšèµ„æºé™åˆ¶çš„(æ¯”å¦‚è¯´å†…å­˜çš„é™åˆ¶)</span><br><span class="line">docker run -m å»é™åˆ¶å†…å­˜</span><br><span class="line"></span><br><span class="line">2ã€#åŸç†æ˜¯ä»€ä¹ˆ</span><br><span class="line">-mæŒ‡å®šé™åˆ¶å†…å­˜çš„æ•°é‡ï¼Œdockeré€šè¿‡å†…æ ¸å‚æ•°ï¼Œä¹Ÿå°±æ˜¯Cgroupå¯¹èµ„æºè¿›è¡Œé™åˆ¶</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#Cgroupçš„ä½œç”¨</span><br><span class="line">åœ¨æ“ä½œç³»ç»Ÿè§£å†³äº†èµ„æºç›¸ä¸éš”ç¦»çš„é—®é¢˜ä»¥åï¼Œè¿˜éœ€è¦è§£å†³èµ„æºé™åˆ¶çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯é¿å…åœ¨åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿä¸­ï¼Œé˜²æ­¢æœ‰äº›èµ„æºæ¶ˆè€—è¾ƒå¤§çš„å®¹å™¨ï¼Œå°†æ•´ä¸ªç‰©ç†æœºå™¨(å®¿ä¸»æœº)çš„ç¡¬ä»¶èµ„æº(CPU,Memory)å æ»¡ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">åœ¨Linux ç³»ç»Ÿä¸­èƒ½å¤Ÿæ§åˆ¶çš„èµ„æºåˆ—è¡¨å¦‚ä¸‹</span><br><span class="line">memory      <span class="comment">#å†…å­˜é™åˆ¶</span></span><br><span class="line">hugetlb     <span class="comment">#huge pages ä½¿ç”¨é‡</span></span><br><span class="line">cpu         <span class="comment">#é™åˆ¶CPUä½¿ç”¨ç‡</span></span><br><span class="line">cpuacct     <span class="comment">#ç»Ÿè®¡cgroupsä¸­çš„è¿›ç¨‹çš„CPUä½¿ç”¨æŠ¥å‘Š</span></span><br><span class="line">cpuset      <span class="comment">#ç»‘å®šcgroupsåˆ°æŒ‡å®š CPUså’Œ NUMAèŠ‚ç‚¹</span></span><br><span class="line">innodb_lock_wait_timeout  <span class="comment">#blockè®¾å¤‡çš„I0é€Ÿåº¦</span></span><br><span class="line">not_cls     <span class="comment">#ç½‘ç»œæ¥å£è®¾ç½®ä¼˜å…ˆçº§</span></span><br><span class="line">devices     <span class="comment">#mknodeè®¿é—®è®¾å¤‡æƒé™</span></span><br><span class="line">freezer     <span class="comment">#suspendå’Œrestore cgroups è¿›ç¨‹</span></span><br><span class="line">perf_event  <span class="comment">#æ€§èƒ½ç›‘æ§</span></span><br><span class="line">pids        <span class="comment">#é™åˆ¶å­æ ‘ cgroups æ€»è¿›ç¨‹æ•°</span></span><br><span class="line"></span><br><span class="line">4ã€#å®¹å™¨ä¸å®¹å™¨ä¹‹é—´çš„èµ„æºå¦‚ä½•éš”ç¦»ï¼Ÿ</span><br><span class="line">Namespace  åç§°ç©ºé—´éš”ç¦»</span><br><span class="line"></span><br><span class="line">5ã€#ä¸ºä»€ä¹ˆå®¹å™¨ä¹‹é—´çš„èµ„æºå¯ä»¥é€šè¿‡nsè¿›è¡Œéš”ç¦»ï¼Ÿ</span><br><span class="line">å› ä¸ºdockerå®¹å™¨è¿è¡Œèµ·æ¥æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œæ¯ä¸€ä¸ªå®¹å™¨éƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹ä¹‹é—´ç”¨æ¥èµ„æºéš”ç¦»çš„å°±æ˜¯Namespace</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ç³»ç»Ÿå®ç°çš„é™åˆ¶èµ„æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 node]# <span class="built_in">cat</span> /proc/cgroups </span><br><span class="line"><span class="comment">#subsys_name    hierarchy       num_cgroups     enabled</span></span><br><span class="line">cpuset  11      7       1</span><br><span class="line">cpu     3       77      1</span><br><span class="line">cpuacct 3       77      1</span><br><span class="line">memory  7       77      1</span><br><span class="line">devices 5       77      1</span><br><span class="line">freezer 10      7       1</span><br><span class="line">net_cls 2       7       1</span><br><span class="line">blkio   9       77      1</span><br><span class="line">perf_event      4       7       1</span><br><span class="line">hugetlb 6       7       1</span><br><span class="line">pids    8       77      1</span><br><span class="line">net_prio        2       7       1</span><br></pre></td></tr></table></figure><h3 id="1ã€æ¡ˆä¾‹ï¼šé™åˆ¶SSHå†…å­˜ä½¿ç”¨">1ã€<strong>æ¡ˆä¾‹ï¼šé™åˆ¶SSHå†…å­˜ä½¿ç”¨</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1ã€é™åˆ¶ç³»ç»ŸæœåŠ¡å†…å­˜</span><br><span class="line">[root@docker01 node]# <span class="built_in">cd</span> /sys/fs/cgroup/memory/system.slice/sshd.service/</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹å†…å­˜æœåŠ¡é™åˆ¶(byte)</span><br><span class="line">[root@docker01 sshd.service]# <span class="built_in">cat</span> memory.limit_in_bytes </span><br><span class="line">9223372036854771712</span><br><span class="line"></span><br><span class="line">3ã€è®¡ç®—ä¸€ä¸‹ï¼Œå¤§æ¦‚æ˜¯7G,è¿™ä¸ªæ˜¯é»˜è®¤å€¼ï¼Œä¸ç®¡ç³»ç»Ÿå†…å­˜å¤šå¤§ï¼Œæ¯ä¸ªè¿›ç¨‹é»˜è®¤æœ€å¤§ä½¿ç”¨7G,è¿™æ ·å°±ç›¸å½“äºæ²¡æœ‰åšä»»ä½•é™åˆ¶Â·</span><br><span class="line">[root@docker01 sshd.service]# python</span><br><span class="line">&gt;&gt;&gt; 9223372036854771712/1024/1024/1024/1024/1024/1024</span><br><span class="line">7</span><br><span class="line"></span><br><span class="line">4ã€sshæœåŠ¡ä¸æ˜¯æ‹¿å®¹å™¨èµ·èµ·æ¥çš„ï¼Œå¦‚æœæƒ³ç»™ä»–é™åˆ¶ï¼Œå°±éœ€è¦æ”¹æ–‡ä»¶é‡Œé¢çš„æ•°å­—å¤§å°</span><br><span class="line">è®¾ç½®é™åˆ¶å†…å­˜</span><br><span class="line">[root@docker01 sshd.service]# <span class="built_in">echo</span> 64K &gt; memory.limit_in_bytes </span><br><span class="line">æ‰§è¡Œä¹‹åï¼Œsshå°±ç«‹é©¬ç«¯å£è¿æ¥äº†ï¼Œåªå†™1ä¸ªå­—èŠ‚ï¼Œæ ¹æœ¬å°±è¿ä¸ä¸Šssh</span><br><span class="line"></span><br><span class="line">5ã€åˆ°è™šæ‹Ÿæœºé‡Œé¢æŸ¥çœ‹æ—¥å¿—</span><br><span class="line">tailf /var/log/messages</span><br><span class="line"></span><br><span class="line">6ã€å¯ä»¥å‘ç°ï¼Œè¿œç¨‹è¿æ¥æ—¶ï¼Œä¼šæ€è¿›ç¨‹ï¼Œå› ä¸ºè¿œç¨‹è¿æ¥ä¼šäº§ç”Ÿä¸€ä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯sshè¢«åšäº†é™åˆ¶</span><br><span class="line">ï¼Œä¼šæ€æ‰è¿æ¥çš„è¿›ç¨‹</span><br><span class="line"></span><br><span class="line">Cgroupè°ƒç”¨å†…æ ¸å‚æ•°ï¼Œå¦‚æœåšé™åˆ¶ï¼Œå°±æ”¹memory.limit_in_bytesæ–‡ä»¶ï¼Œå†…æ ¸æ¥è¯»å–è¿™ä¸ªæ–‡ä»¶æ¥è¿›è¡Œé™åˆ¶</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240912151039561.png" alt="image-20240912151039561"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 sshd.service]# <span class="built_in">echo</span> 9223372036854771712 &gt; memory.limit_in_bytes</span><br><span class="line"></span><br><span class="line">[root@docker01 sshd.service]# <span class="built_in">cat</span> memory.limit_in_bytes</span><br><span class="line">9223372036854771712</span><br></pre></td></tr></table></figure><h3 id="2ã€OverlayFS">2ã€<strong>OverlayFS</strong></h3><p><strong>OverlayFS</strong> <strong>å®ç°æ–¹å¼</strong></p><p>OverlayFSé€šè¿‡ä¸‰ä¸ªç›®å½•ï¼šlowerç›®å½•ã€upperç›®å½•ã€ä»¥åŠworkç›®å½•å®ç°,å…¶ä¸­lowerç›®å½•å¯ä»¥æ˜¯å¤šä¸ª,upperç›®å½•ä¸ºå¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œçš„ç›®å½•, workç›®å½•ä¸ºå·¥ä½œåŸºç¡€ç›®å½•,æŒ‚è½½åå†…å®¹ä¼šè¢«æ¸…ç©º,ä¸”åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å…¶å†…å®¹ç”¨æˆ·ä¸å¯è§,æœ€åè”åˆæŒ‚è½½å®Œæˆç»™ç”¨æˆ·å‘ˆç°çš„ç»Ÿä¸€è§†å›¾ç§°ä¸ºmergedç›®å½•ã€‚</p><p><img src="../image/study_img/image-20240913170119816.png" alt="image-20240913170119816"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ¨¡æ‹Ÿoverlayfså­˜å‚¨æ–¹å¼</span></span><br><span class="line">1.åˆ›å»ºæ–‡ä»¶</span><br><span class="line">[root@k8s01 ~]# <span class="built_in">mkdir</span> /lower&#123;1..3&#125;</span><br><span class="line">[root@k8s01 ~]# <span class="built_in">mkdir</span> /upper /work /merged</span><br><span class="line"></span><br><span class="line">2.æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">[root@k8s01 ~]# mount -t overlay overlay -o</span><br><span class="line">lowerdir=/lower1:/lower2:/lower3,upperdir=/upper,workdir=/work /merged</span><br><span class="line"></span><br><span class="line">3.æŸ¥çœ‹æŒ‚è½½</span><br><span class="line">[root@k8s01 ~]# mount | grep merged</span><br><span class="line"></span><br><span class="line">4.åœ¨/upper ç›®å½•ä¸­å†™å…¥æ–‡ä»¶,åœ¨mergedä¸­å¯ä»¥æ˜¾ç¤º</span><br><span class="line">[root@k8s01 /]# <span class="built_in">touch</span> /upper/upper.txt</span><br><span class="line">[root@k8s01 /]# ll /merged/</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar 14 02:17 upper.txt</span><br><span class="line"></span><br><span class="line">5. åœ¨mergedä¸­å†™å…¥æ–‡ä»¶, å®é™…å­˜å‚¨åˆ°äº†/uppper</span><br><span class="line">[root@k8s01 /]# <span class="built_in">touch</span> /merged/d.txt</span><br><span class="line">[root@k8s01 /]# ll /upper/</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar 14 02:19 d.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ³¨:å¦‚æœæ²¡æœ‰upperdirï¼Œ mergedæ˜¯åªè¯»çš„</span><br><span class="line">[root@node-2 overlay2]# umount /merged</span><br><span class="line">[root@node-2 overlay2]# mount -t overlay overlay -o lowerdir=/lower1:/lower2 /merged</span><br><span class="line">[root@k8s01 /]# <span class="built_in">touch</span> /merged/c.txt</span><br><span class="line"><span class="built_in">touch</span>: cannot <span class="built_in">touch</span> â€˜/merged/c.txtâ€™: Read-only file system</span><br></pre></td></tr></table></figure><h3 id="3ã€æ‰©å±•æ·»åŠ ç£ç›˜å’Œæ›´æ”¹dockeré»˜è®¤æ•°æ®ç›®å½•">3ã€<strong>æ‰©å±•æ·»åŠ ç£ç›˜å’Œæ›´æ”¹dockeré»˜è®¤æ•°æ®ç›®å½•</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1ã€å…ˆå…³æœº</span><br><span class="line"></span><br><span class="line">2ã€æ·»åŠ ç£ç›˜</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240913172422996.png" alt="image-20240913172422996"></p><p><img src="../image/study_img/image-20240913172442557.png" alt="image-20240913172442557"></p><p><img src="../image/study_img/image-20240913172500576.png" alt="image-20240913172500576"></p><p><img src="../image/study_img/image-20240913172538917.png" alt="image-20240913172538917"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">3ã€æŸ¥çœ‹æ·»åŠ çš„ç£ç›˜</span><br><span class="line">[root@docker01 ~]# fdisk -l</span><br><span class="line">Disk /dev/sda: 21.5 GB, 21474836480 bytes, 41943040 sectors</span><br><span class="line">......</span><br><span class="line">.....</span><br><span class="line"><span class="comment">#/dev/sdbæ˜¯æ–°æ·»åŠ çš„ç£ç›˜</span></span><br><span class="line">Disk /dev/sdb: 10.7 GB, 10737418240 bytes, 20971520 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line">4ã€åˆ›å»ºåˆ†åŒº</span><br><span class="line">[root@docker01 ~]# fdisk /dev/sdb</span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition <span class="built_in">type</span>: <span class="comment">## é€‰æ‹©ä¸»åˆ†åŒºè¿˜æ˜¯æ‰©å±•åˆ†åŒº</span></span><br><span class="line">    p primary (0 primary, 0 extended, 4 free)</span><br><span class="line">    e extended</span><br><span class="line">Select (default p): p <span class="comment"># ä¸»åˆ†åŒº</span></span><br><span class="line">Partition number (1-4, default 1): 1 <span class="comment"># ä¸€ä¸ªåˆ†åŒº</span></span><br><span class="line">First sector (2048-104857599, default 2048): <span class="comment">## è®¾ç½®å¼€å¤´æ‰‡åŒºå¤§å°ï¼Œæˆ‘é€‰æ‹©é»˜è®¤</span></span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (2048-104857599, default 104857599): <span class="comment">## è®¾ç½®æœ€åæ‰‡åŒºå¤§å°ï¼Œæˆ‘é€‰æ‹©é»˜è®¤</span></span><br><span class="line">Partition 1 of <span class="built_in">type</span> Linux and of size 50 GiB is <span class="built_in">set</span>  <span class="comment">## åˆ†åŒºæˆåŠŸ</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w <span class="comment">## é€€å‡º</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€å†æ¬¡æŸ¥çœ‹ç£ç›˜</span><br><span class="line">[root@docker01 ~]# fdisk -l</span><br><span class="line">.....</span><br><span class="line">Disk /dev/sdb: 10.7 GB, 10737418240 bytes, 20971520 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0x481c9cdc</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sdb1            2048    20971519    10484736   83  Linux</span><br><span class="line"><span class="comment">#æ–°åˆ†åŒº /dev/sdb1 </span></span><br><span class="line"></span><br><span class="line">5ã€æ ¼å¼åŒ–åˆ†åŒº</span><br><span class="line">[root@docker01 ~]# mkfs.xfs /dev/sdb1</span><br><span class="line"></span><br><span class="line">6ã€æŸ¥çœ‹åˆ†åŒºçš„UUID</span><br><span class="line">[root@docker01 ~]# blkid /dev/sdb1</span><br><span class="line">/dev/sdb1: UUID=<span class="string">&quot;65cdcede-223b-40ad-aa68-6165b7606b71&quot;</span> TYPE=<span class="string">&quot;xfs&quot;</span> </span><br><span class="line"></span><br><span class="line">7ã€#è®¾ç½®æ°¸ä¹…æŒ‚è½½</span><br><span class="line">æ–¹æ³•ä¸€ï¼šè¿™ä¸ªæ–¹æ³•å¦‚æœå†™é”™ä¸€ä¸ªå­—æ¯ï¼Œå¾ˆå¯èƒ½é€ æˆç³»ç»Ÿèµ·ä¸æ¥ï¼Œæ‰€ä»¥å†™å®Œäº†è¦ä»”ç»†æ£€æŸ¥</span><br><span class="line">[root@docker01 ~]# vim /etc/fstab </span><br><span class="line"><span class="comment">#æŠŠå†…å®¹åŠ å…¥æœ€åä¸€è¡Œ</span></span><br><span class="line">UUID=65cdcede-223b-40ad-aa68-6165b7606b71   /docker_data  xfs     defaults        0 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ–¹æ³•äºŒï¼šå†™å…¥è‡ªå¯åŠ¨æ–‡ä»¶   è¿™ä¸ªå†™é”™äº†ä¸ä¼šé€ æˆç³»ç»Ÿèµ·ä¸æ¥çš„æƒ…å†µ</span><br><span class="line">vim /root/.bashrc </span><br><span class="line">mount -t xfs /dev/sdb1 /docker_data </span><br><span class="line">ä¸è¦å½±å“æ–‡ä»¶åŸå…ˆçš„å†…å®¹</span><br><span class="line"></span><br><span class="line">8ã€ä¸´æ—¶æŒ‚è½½</span><br><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> /docker_data</span><br><span class="line">[root@docker01 ~]# mount -a</span><br><span class="line"></span><br><span class="line">9ã€æŸ¥çœ‹ç£ç›˜åˆ†åŒº</span><br><span class="line">[root@docker01 ~]# <span class="built_in">df</span> -Th</span><br><span class="line">Filesystem              Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/centos-root xfs        19G   14G  5.1G  73% /</span><br><span class="line">devtmpfs                devtmpfs  1.6G     0  1.6G   0% /dev</span><br><span class="line">tmpfs                   tmpfs     1.6G     0  1.6G   0% /dev/shm</span><br><span class="line">tmpfs                   tmpfs     1.6G   12M  1.6G   1% /run</span><br><span class="line">tmpfs                   tmpfs     1.6G     0  1.6G   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1               xfs       497M  126M  372M  26% /boot</span><br><span class="line">tmpfs                   tmpfs     318M     0  318M   0% /run/user/0</span><br><span class="line">/dev/sdb1               xfs        10G   33M   10G   1% /docker_data</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹æ­¥éª¤å¯ä»¥ä¸éœ€è¦æ“ä½œï¼Œå¦‚æœä¸æ›´æ”¹dockeré»˜è®¤æ•°æ®ç›®å½•çš„è¯ï¼Œä¸éœ€è¦æ“ä½œï¼Œå¦‚æœæ›´æ”¹äº†æ•°æ®ç›®å½•ï¼Œä¹‹å‰æ‹‰çš„é•œåƒå°±éœ€è¦é‡æ–°æ‹‰å–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¿®æ”¹dockeré»˜è®¤æ•°æ®ç›®å½•çš„æ“ä½œ</span></span><br><span class="line"></span><br><span class="line">1ã€åœ¨é…ç½®æ–‡ä»¶é‡Œé¢æ·»åŠ ç›®å½•ä¿¡æ¯</span><br><span class="line">[root@docker01 docker_data]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.105&quot;</span>,<span class="string">&quot;http://172.16.1.101:5000&quot;</span>],</span><br><span class="line"><span class="string">&quot;data-root&quot;</span>: <span class="string">&quot;/docker_data&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">[root@docker01 docker_data]# systemctl daemon-reload</span><br><span class="line">[root@docker01 docker_data]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹dockerä¿¡æ¯</span><br><span class="line">[root@docker01 docker_data]# docker info</span><br><span class="line">Docker Root Dir: /docker_data</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">dockeråšèµ„æºé™åˆ¶çš„æ–¹æ³•</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>åã€ğŸ¡å®¹å™¨åŒ–ç›‘æ§Prometheus</title>
    <link href="https://www.fomal.cc/posts/f75a8470.html"/>
    <id>https://www.fomal.cc/posts/f75a8470.html</id>
    <published>2024-09-22T06:12:54.000Z</published>
    <updated>2024-09-22T07:53:34.216Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å®¹å™¨åŒ–ç›‘æ§Promethues">å®¹å™¨åŒ–ç›‘æ§Promethues</h2><h3 id="1ã€Dockerè‡ªå¸¦çš„ç›‘æ§å‘½ä»¤">1ã€<strong>Dockerè‡ªå¸¦çš„ç›‘æ§å‘½ä»¤</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 ~]# docker ps</span><br><span class="line">[root@docker02 ~]# docker top mysql80</span><br><span class="line">[root@docker02 ~]# docker top jenkins</span><br><span class="line">[root@docker02 ~]# docker stats</span><br></pre></td></tr></table></figure><p>æœ‰äº†ä¸Šé¢çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨zabbixæ¥ç›‘æ§dockerå®¹å™¨äº†ï¼Œä½†æ˜¯é—®é¢˜å°±æ˜¯ï¼Œ zabbix-agent çš„ç«¯å£ï¼Œæˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Šåªèƒ½æ˜ å°„å‡ºæ¥ä¸€ä¸ªã€‚<br><strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>1.èµ·å¤šå—ç½‘å¡<br>2.æ¯ä¸ªå®¹å™¨è£…ä¸€ä¸ªzabbix-server<br>3.ä¿®æ”¹ä¸åŒå®¹å™¨çš„agentç«¯å£<br>4.æ˜ å°„å®¹å™¨çš„ç›¸å…³æ–‡ä»¶ï¼Œç„¶åç›‘æ§å®¿ä¸»æœºä¸Šçš„å¯¹åº”æ–‡ä»¶<br>5.ä¸ç”¨zabbix</p><h3 id="2ã€ç›‘æ§è½¯ä»¶çš„ä»‹ç»">2ã€<strong>ç›‘æ§è½¯ä»¶çš„ä»‹ç»</strong></h3><p><em>æœåŠ¡ç«¯</em></p><p>prometheusï¼šç±»ä¼¼äºzabbix-serveræœåŠ¡ç«¯ï¼Œè´Ÿè´£æ”¶é›†å®¢æˆ·ç«¯ç›‘æ§æŒ‡æ ‡(Metrics)</p><p><em>å®¢æˆ·ç«¯</em></p><p>cAdvisorï¼šç±»ä¼¼ zabbix-agent å®¢æˆ·ç«¯ï¼Œç”¨æ¥æ”¶é›†å®¹å™¨é‡Œé¢çš„ç›‘æ§æŒ‡æ ‡<br>node_exporterï¼šç±»ä¼¼ zabbix-agent å®¢æˆ·ç«¯ï¼Œç”¨æ¥æ”¶é›†å®¿ä¸»æœºçš„ç›‘æ§æŒ‡æ ‡</p><p><em>ç»„ä»¶</em></p><p>Grafanaï¼šå‡ºå›¾å·¥å…·</p><p>1ã€cAdvisorä»‹ç»     å‡¯å¾—æ­ªçƒ­å„¿</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cAdvisorä»‹ç»</span><br><span class="line">cAdvisoræ˜¯è°·æ­Œå¼€å‘çš„å®¹å™¨ç›‘æ§å·¥å…·ï¼ŒcAdvisorä¼šæ˜¾ç¤ºå½“å‰hostèµ„æºä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬CPUã€å†…å­˜ã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç­‰ã€‚</span><br><span class="line"></span><br><span class="line">ä¸è¿‡cAdvisoræä¾›çš„æ“ä½œç•Œé¢ç•¥æ˜¾ç®€é™‹ï¼Œè€Œä¸”è¦åœ¨ä¸åŒçš„é¡µé¢ä¹‹é—´è·³è½¬ï¼Œå¹¶ä¸”åªèƒ½ç›‘æ§ä¸€ä¸ªhostï¼Œä¸å…è®©äººè´¨ç–‘å®ƒçš„å®ç”¨æ€§ï¼Œä½†æ˜¯cAdvisoræœ‰ä¸€ä¸ªäº®ç‚¹ï¼Œå°±æ˜¯å°†ç›‘æ§æ•°æ®å¯¼å‡ºç»™å…¶ä»–ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œè€Œä¸”å®ƒå…¼å®¹å¾ˆå¤šç¬¬ä¸‰æ–¹å·¥å…·ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒå®šä½æˆæ˜¯ä¸€ä¸ª ç›‘æ§æ•°æ®æ”¶é›†å™¨ ï¼Œæ”¶é›†å’Œå¯¼å‡ºæ˜¯å®ƒçš„å¼ºé¡¹ï¼Œè€Œéå±•ç¤º</span><br><span class="line"></span><br><span class="line">dokcer stats å¯ä»¥æŸ¥çœ‹è¿è¡Œçš„ Docker é•œåƒçš„è¿è¡ŒçŠ¶æ€ï¼Œä¾‹å¦‚ï¼šè¿™ç§æ–¹å¼æ¯”è¾ƒåŸå§‹ï¼Œå› ä¸ºä½ æ— æ³•é€šè¿‡http çš„æ–¹å¼æ¥è·å–æ•°æ®ï¼Œè€Œä¸”æ²¡æœ‰ç•Œé¢ï¼Œæ•°æ®å¯è§†åŒ–è¿˜éœ€è¦åšå¤§é‡çš„å·¥ä½œã€‚</span><br><span class="line"></span><br><span class="line">ç”±äº dokcer stats æœ‰è¿™äº›é—®é¢˜ï¼Œæ‰€ä»¥ cadvisor è¯ç”Ÿäº†ã€‚ cadvisor ä¸ä»…å¯ä»¥æœé›†ä¸€å°æœºå™¨ä¸Šæ‰€æœ‰è¿è¡Œçš„å®¹å™¨ä¿¡æ¯è¿˜æä¾›åŸºç¡€æŸ¥è¯¢ç•Œé¢å’Œ http æ¥å£ï¼Œæ–¹ä¾¿ Prometheus è¿›è¡Œæ•°æ®æŠ“å–ã€‚</span><br></pre></td></tr></table></figure><p>2ã€grafanaä»‹ç»<br>grafanaæ˜¯ä¸€ä¸ªæ”¯æŒå¤šç§æ•°æ®æºçš„å›¾å½¢å±•ç¤ºå·¥å…·</p><p>3ã€prometheusä»‹ç»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">promethueså®˜ç½‘ï¼šhttps://prometheus.io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">prometheusæ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„ç›‘æ§å·¥å…·ï¼Œæä¾›äº†ç›‘æ§æ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€å¤„ç†ã€å¯è§†åŒ–ã€å’Œå‘Šè­¦ç­‰ä¸€ç³»åˆ—å®Œæ•´çš„ç›‘æ§ä½“ç³»ã€‚</span><br><span class="line"></span><br><span class="line">ç»„ä»¶åŒ…å«ï¼š</span><br><span class="line">Node Exporterï¼šè´Ÿè´£æ”¶é›†hostç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿæ•°æ®ï¼Œä»¥å®¹å™¨çš„å½¢å¼è¿è¡Œåœ¨æ‰€æœ‰çš„hostä¸Šã€‚</span><br><span class="line">cAdvisorï¼šè´Ÿè´£æ”¶é›†å®¹å™¨æ•°æ®ï¼Œä»¥å®¹å™¨çš„å½¢å¼è¿è¡Œåœ¨æ‰€æœ‰çš„hostä¸Šã€‚</span><br><span class="line"></span><br><span class="line">zabbixæ˜¯åœ¨å®¢æˆ·ç«¯é…æœåŠ¡ç«¯çš„åœ°å€ï¼Œæ‰€ä»¥æ•°æ®èƒ½ä»å®¢æˆ·ç«¯æ¨é€ç»™æœåŠ¡ç«¯</span><br><span class="line"></span><br><span class="line">prometheusæ•°æ®è·å–çš„æ¥æºï¼š</span><br><span class="line">æœåŠ¡ç«¯é…å®¢æˆ·ç«¯çš„åœ°å€ï¼Œprometheus-serverå»å…¶ä»–å®¢æˆ·ç«¯æ‹‰è¿‡æ¥çš„æ•°æ®ï¼Œåªæœ‰å‘Šè­¦æ˜¯æ¨çš„</span><br><span class="line">è®¾ç½®è§¦å‘å™¨å‡ºç°å‘Šè­¦äº†ï¼Œå‡ºå‘å‘Šè­¦æ–¹å¼ï¼Œæ‰ä¼šæ¨é€æ•°æ®</span><br></pre></td></tr></table></figure><p>æ”¯æŒï¼š<br>1ã€MySQLã€Oracleã€Postgreã€esç­‰æ•°æ®åº“<br>2ã€zabbixã€prometheusç­‰ç›‘æ§ç³»ç»Ÿ</p><h3 id="3ã€Prometheusæ¶æ„">3ã€<strong>Prometheusæ¶æ„</strong></h3><p><img src="../image/study_img/image-20240911085025512.png" alt="image-20240911085025512"></p><p>TSDBï¼šæ—¶åºæ•°æ®åº“ï¼Œå’Œæ—¶é—´è½´æœ‰å…³çš„</p><p>influxDBï¼šæ—¶åºæ•°æ®åº“</p><h3 id="4ã€éƒ¨ç½²Prometheus">4ã€<strong>éƒ¨ç½²Prometheus</strong></h3><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th><th>åº”ç”¨</th></tr></thead><tbody><tr><td>docker01</td><td>10.0.0.101  /  172.16.1.101</td><td>è¢«ç›‘æ§ç«¯</td><td>cadvisorã€node_exporter</td></tr><tr><td>docker02</td><td>10.0.0.102  /  172.16.1.102</td><td>è¢«ç›‘æ§ç«¯</td><td>cadvisorã€node_exporter</td></tr><tr><td>docker03</td><td>10.0.0.103  /  172.16.1.103</td><td>è¢«ç›‘æ§ç«¯</td><td>cadvisorã€node_exporter</td></tr><tr><td>elk01</td><td>10.0.0.76  /  172.16.1.76</td><td>ç›‘æ§ç«¯ã€æœåŠ¡ç«¯</td><td>prometheusã€grafanaã€cadvisor</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## docker runå‘½ä»¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨node-exporter</span></span><br><span class="line">docker run -d -p 9100:9100 -v <span class="string">&quot;/:/host:ro,rslave&quot;</span> --name=node_exporter</span><br><span class="line">quay.io/prometheus/node-exporter --path.rootfs /host</span><br><span class="line"></span><br><span class="line">-v <span class="string">&quot;/:/hostï¼šç›¸å½“äºç›‘æ§å®¿ä¸»æœº</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># å¯åŠ¨cadvisor</span></span><br><span class="line"><span class="string">docker run --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --</span></span><br><span class="line"><span class="string">volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro -p 8080:8080 -d --name=cadvisor google/cadvisor:latest</span></span><br></pre></td></tr></table></figure><p>1ã€elkæœºå™¨ éƒ¨ç½²docker compose</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">1ã€å‡†å¤‡å·¥ä½œç›®å½•</span><br><span class="line">[root@elk1 ~]# <span class="built_in">mkdir</span> prometheus &amp;&amp; <span class="built_in">cd</span> prometheus/</span><br><span class="line"></span><br><span class="line">2ã€å‡†å¤‡promethuesé…ç½®æ–‡ä»¶</span><br><span class="line">[root@elk1 prometheus]# vim prometheus.yml</span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: cadvisor</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.101:8080</span><br><span class="line">    - 10.0.0.102:8080</span><br><span class="line">    - 10.0.0.103:8080</span><br><span class="line"></span><br><span class="line">- job_name: prometheus</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.76:9090</span><br><span class="line"></span><br><span class="line">- job_name: node_exporter</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.101:9100</span><br><span class="line">    - 10.0.0.102:9100</span><br><span class="line">    - 10.0.0.103:9100</span><br><span class="line"></span><br><span class="line">3ã€ç¼–å†™docker-compose</span><br><span class="line">[root@elk1 prometheus]# vim pro-docker-compose.yml </span><br><span class="line">version: <span class="string">&#x27;3.2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  prometheus:</span><br><span class="line">    image: prom/prometheus:latest</span><br><span class="line">    container_name: prometheus</span><br><span class="line">    ports:</span><br><span class="line">      - 9090:9090</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - --config.file=/etc/prometheus/prometheus.yml</span><br><span class="line">    volumes:</span><br><span class="line">      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">  grafana:</span><br><span class="line">    image: grafana/grafana:latest</span><br><span class="line">    container_name: grafana</span><br><span class="line">    ports:</span><br><span class="line">      - 3000:3000</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">  cadvisor:</span><br><span class="line">    image: google/cadvisor:latest</span><br><span class="line">    container_name: cadvisor</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">    volumes:</span><br><span class="line">      - /:/rootfs:ro</span><br><span class="line">      - /var/run:/var/run:rw</span><br><span class="line">      - /sys:/sys:ro</span><br><span class="line">      - /var/lib/docker:/var/lib/docker:ro</span><br><span class="line">    restart: always</span><br><span class="line">      </span><br><span class="line">  node-exporter:</span><br><span class="line">    image: prom/node-exporter:latest</span><br><span class="line">    container_name: node_exporter</span><br><span class="line">    ports:</span><br><span class="line">      - 9100:9100</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">[root@elk1 promethenus]# docker-compose -f pro-docker-compose.yml up -d</span><br></pre></td></tr></table></figure><p>2ã€docker01 02 03</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 node]# <span class="built_in">mkdir</span> node &amp;&amp; <span class="built_in">cd</span> node</span><br><span class="line">[root@docker01 node]# vim node-docker-compose.yml </span><br><span class="line">version: <span class="string">&#x27;3.2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  node-exporter:</span><br><span class="line">    image: prom/node-exporter:latest</span><br><span class="line">    container_name: node_exporter</span><br><span class="line">    ports:</span><br><span class="line">      - 9100:9100</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">  cadvisor:</span><br><span class="line">    image: google/cadvisor:latest</span><br><span class="line">    container_name: cadvisor</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">    volumes:</span><br><span class="line">      - /:/rootfs:ro</span><br><span class="line">      - /var/run:/var/run:rw</span><br><span class="line">      - /sys:/sys:ro</span><br><span class="line">      - /var/lib/docker:/var/lib/docker:ro</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">[root@docker02 node]# docker-compose -f node-docker-compose.yml up</span><br></pre></td></tr></table></figure><p>3ã€è®¿é—®ç½‘é¡µ 10.0.0.76:9090ï¼Œå¯ä»¥çœ‹åˆ°ç›‘æ§çš„å…¶ä»–å®¢æˆ·ç«¯</p><p><img src="../image/study_img/image-20240911093304356.png" alt="image-20240911093304356"></p><p><img src="../image/study_img/image-20240911163131170.png" alt="image-20240911163131170"></p><p>æ”¶é›†åˆ°çš„æ•°æ®æŒ‡æ ‡æ˜¯Key:valueçš„æ ¼å¼</p><p>æ•°æ®æŸ¥è¯¢æ“ä½œ</p><p><img src="../image/study_img/image-20240911163606439.png" alt="image-20240911163606439"></p><p><img src="../image/study_img/image-20240911163702757.png" alt="image-20240911163702757"></p><p>å¦‚æœåªæƒ³çœ‹101çš„æ•°æ®  ï¼š  å°±ç”¨{ }èŠ±æ‹¬å·é‡Œé¢å†™æƒ³è¦æŸ¥çœ‹çš„å­—æ®µ  èŠ±æ‹¬å·é‡Œé¢çš„å­—æ®µç›¸å½“äºè¿‡æ»¤</p><p><img src="../image/study_img/image-20240911170150515.png" alt="image-20240911170150515"></p><p>4ã€è®¿é—®cadvisoré¡µé¢ 10.0.0.101:8080</p><p><img src="../image/study_img/image-20240911165134739.png" alt="image-20240911165134739"></p><p><img src="../image/study_img/image-20240911165240850.png" alt="image-20240911165240850"></p><p><img src="../image/study_img/image-20240911165311636.png" alt="image-20240911165311636"></p><p>5ã€grafanaæ¨¡ç‰ˆå‡ºå›¾</p><p>ç™»å½•è‡ªå·±æ­å»ºçš„grafana ï¼š10.0.0.76:3000/</p><p><img src="../image/study_img/image-20240911160356809.png" alt="image-20240911160356809"></p><p>è¿›å…¥grafanaå®˜ç½‘ï¼š<a href="https://grafana.com/">https://grafana.com/</a>     è¿›å…¥å®˜ç½‘é¦–é¡µï¼Œæ¥åˆ°é¦–é¡µçš„é¡µé¢æœ€åº•ä¸‹</p><p><img src="../image/study_img/image-20240911170835247.png" alt="image-20240911170835247"></p><p><img src="../image/study_img/image-20240911171206521.png" alt="image-20240911171206521"></p><p>é€‰æ‹©ä¸€ä¸ªè‡ªå·±æƒ³è¦çš„æ¨¡ç‰ˆç‚¹å‡»è¿›å»ï¼Œè‡ªåŠ¨ä»–çš„IDï¼Œä¹‹åæ·»åŠ </p><p><img src="../image/study_img/image-20240911171354848.png" alt="image-20240911171354848"></p><p>â‘ ã€å›åˆ°è‡ªå·±æ­å»ºçš„grafana</p><p><img src="../image/study_img/image-20240911171850344.png" alt="image-20240911171850344"></p><p>â‘¡ã€æ‰¾åˆ°prometheusçš„å›¾æ ‡ï¼ŒåŒå‡»è¿›å»ï¼Œæ·»åŠ prometheusçš„URL,ç„¶åç‚¹å‡»æœ€ä¸‹é¢çš„save &amp; test  å¯çœ‹åˆ°Successfullyæ·»åŠ æˆåŠŸçš„ä¿¡æ¯</p><p><img src="../image/study_img/image-20240911172651580.png" alt="image-20240911172651580"></p><p>â‘¢æµ‹è¯•ï¼š  å†ç‚¹å‡»å·¦è¾¹çš„æ•°æ®æºæ  å¯çœ‹åˆ°æ·»åŠ æˆåŠŸï¼Œä¹‹åæ·»åŠ æ¨¡ç‰ˆ</p><p><img src="../image/study_img/image-20240911173117487.png" alt="image-20240911173117487"></p><p><img src="../image/study_img/image-20240911173228995.png" alt="image-20240911173228995"></p><p><img src="../image/study_img/image-20240911173445043.png" alt="image-20240911173445043"></p><p>æ¨¡ç‰ˆé‡Œé¢å¯ä»¥ç‚¹å‡»è¿›å»çœ‹çœ‹ï¼Œæœ‰çš„æœ‰æ•°æ®ï¼Œæœ‰çš„æ²¡æœ‰æ•°æ®</p><p><img src="../image/study_img/image-20240911173624110.png" alt="image-20240911173624110"></p><p>å…¶å®å¯ä»¥æŠŠåˆšåˆšæ·»åŠ çš„3ä¸ªæ¨¡ç‰ˆåˆ é™¤ï¼Œå› ä¸ºä¸æ˜¯æˆ‘éœ€è¦çš„ï¼Œæ¥ä¸‹æ¥ä¼šæ·»åŠ éœ€è¦çš„æ¨¡ç‰ˆ</p><p>â‘£ã€æ·»åŠ cAdcisorçš„æ¨¡ç‰ˆ</p><p><img src="../image/study_img/image-20240911174519155.png" alt="image-20240911174519155"></p><p>8919    11277  è¿™ä¸¤ä¸ªIDæ¯”è¾ƒå¸¸ç”¨</p><p><img src="../image/study_img/image-20240911174945815.png" alt="image-20240911174945815"></p><p><img src="../image/study_img/image-20240911175011030.png" alt="image-20240911175011030"></p><p><img src="../image/study_img/image-20240911175141393.png" alt="image-20240911175141393"></p><p>å¯ä»¥çœ‹åˆ°æ•°æ®ï¼Œä½†æ˜¯ç›®å‰é»˜è®¤æ˜¯çœ‹101çš„æ•°æ®ï¼Œé¡¹ç›®å’Œä¸»æœºéƒ½æ˜¯ç©ºçš„ï¼Œæƒ³çœ‹æŒ‡å®šä¸»æœºçš„æ•°æ®æ²¡æœ‰ï¼Œæ‰€ä»¥éœ€è¦æ”¹æ¨¡ç‰ˆ</p><p><img src="../image/study_img/image-20240911175238626.png" alt="image-20240911175238626"></p><p><em>6ã€ä¿®æ”¹æ¨¡ç‰ˆ</em></p><p>éœ€è¦ä½¿ç”¨prometheusæŸ¥è¯¢æ•°æ®çš„è¯­å¥ ï¼špromeQL</p><p><img src="../image/study_img/image-20240911181443564.png" alt="image-20240911181443564"></p><p><img src="../image/study_img/image-20240911181734944.png" alt="image-20240911181734944"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1ã€project</span><br><span class="line">label_values(container_last_seen, project)</span><br><span class="line"></span><br><span class="line">2ã€server</span><br><span class="line">label_values(container_last_seen&#123;project=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>&#125;, server)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€instance</span><br><span class="line">label_values(container_last_seen&#123;project=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>,server=~<span class="string">&quot;<span class="variable">$server</span>&quot;</span>&#125;, instance)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1ã€project</span><br><span class="line">label_values(container_last_seen, project)</span><br><span class="line">è·å–çš„æ˜¯container_last_seené‡Œé¢çš„projectï¼Œå»prometheusé‡Œé¢å»æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰è¿™ä¸ªå€¼</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240911192227950.png" alt="image-20240911192227950"></p><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªç‰ˆæœ¬çš„projecté¡¹ç›®åå«jobï¼Œæ‰€ä»¥projectåº”è¯¥æ”¹æˆjob</p><p><img src="../image/study_img/image-20240911194340683.png" alt="image-20240911194340683"></p><p>æŠŠprojectä¿®æ”¹æˆjobæˆåŠŸ</p><p><img src="../image/study_img/image-20240911194429236.png" alt="image-20240911194429236"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2ã€server</span><br><span class="line">label_values(container_last_seen&#123;project=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>&#125;, server)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢åªè¦instanceå’Œjob,æ²¡æœ‰server,æ‰€ä»¥æŠŠserveråˆ é™¤</p><p><img src="../image/study_img/image-20240911194700416.png" alt="image-20240911194700416"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">3ã€instance</span><br><span class="line">label_values(container_last_seen&#123;project=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>,server=~<span class="string">&quot;<span class="variable">$server</span>&quot;</span>&#125;, instance)</span><br><span class="line">serveræ²¡æœ‰ï¼Œä¸è¦ï¼Œå¯ä»¥åˆ é™¤</span><br><span class="line"></span><br><span class="line">label_values(container_last_seen&#123;job=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>&#125;, instance)</span><br><span class="line"></span><br><span class="line"><span class="variable">$project</span>è¿™ä¸ªè¡¨ç¤ºè·å–projecté‡Œé¢çš„å˜é‡</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240911200218534.png" alt="image-20240911200218534"></p><p><img src="../image/study_img/image-20240911195320041.png" alt="image-20240911195320041"></p><p>ä¿®æ”¹å®Œæˆï¼Œä¿å­˜</p><p><img src="../image/study_img/image-20240911195411815.png" alt="image-20240911195411815"></p><p><img src="../image/study_img/image-20240911200333043.png" alt="image-20240911200333043"></p><p>æŸ¥çœ‹æ²¡æœ‰æ•°æ®ï¼Œæ·»åŠ æ•°æ®</p><p><img src="../image/study_img/image-20240911200507280.png" alt="image-20240911200507280"></p><p><img src="../image/study_img/image-20240911200625330.png" alt="image-20240911200625330"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">count(container_last_seen&#123;project=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>,instance=~<span class="string">&quot;<span class="variable">$instance</span>&quot;</span>,image!=<span class="string">&quot;&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">æŠŠå˜é‡å’Œjobæ¢ä¸€ä¸‹</span><br><span class="line">count(container_last_seen&#123;job=~<span class="string">&quot;cadvisor&quot;</span>,instance=~<span class="string">&quot;10.0.0.101:8080&quot;</span>,image!=<span class="string">&quot;&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><p>å¯ä»¥è·å–åˆ°æ•°æ®</p><p><img src="../image/study_img/image-20240911200945018.png" alt="image-20240911200945018"></p><p><img src="../image/study_img/image-20240911201650404.png" alt="image-20240911201650404"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å› ä¸ºprometheusé‡Œé¢æŸ¥å‡ºæ¥çš„æ²¡æœ‰projectæ ‡ç­¾ï¼Œåªæœ‰jobæ ‡ç­¾</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">container_last_seen&#123;<span class="built_in">id</span>=<span class="string">&quot;/&quot;</span>, instance=<span class="string">&quot;10.0.0.101:8080&quot;</span>, job=<span class="string">&quot;cadvisor&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>ç›®å‰åªæ”¹äº†ä¸€ä¸ªæ•°æ®ï¼Œä½†æ˜¯ä¸å¯èƒ½ä¸€ä¸ªä¸€ä¸ªå»ä¿®æ”¹ï¼Œæ‰€ä»¥éœ€è¦æ‰¹é‡ä¿®æ”¹</p><p><img src="../image/study_img/image-20240911201813116.png" alt="image-20240911201813116"></p><p>è¿™ä¸ªjsonæ–‡ä»¶å°±æ˜¯æ¨¡ç‰ˆï¼Œä½†å¾€ä¸‹çœ‹ï¼Œè¿™ä¸ªjsonæ–‡ä»¶é‡Œé¢è¿˜æ˜¯projectï¼Œå¯ä»¥å¤åˆ¶å‡ºæ¥ï¼Œæ‰¹é‡æ›¿æ¢æˆjob</p><p><img src="../image/study_img/image-20240911201937730.png" alt="image-20240911201937730"></p><p><img src="../image/study_img/image-20240911202129508.png" alt="image-20240911202129508"></p><p>æŠŠæ›¿æ¢åçš„jsonæ–‡ä»¶ç²˜è´´</p><p><img src="../image/study_img/image-20240911202309412.png" alt="image-20240911202309412"></p><p>ä¿å­˜ä¹‹åï¼Œé‡æ–°è¿›å…¥ï¼ŒæŸ¥çœ‹æ•°æ®</p><p><img src="../image/study_img/image-20240911202434264.png" alt="image-20240911202434264"></p><p><img src="../image/study_img/image-20240911202449993.png" alt="image-20240911202449993"></p><p>â‘¤ã€æ·»åŠ node_exporterçš„æ¨¡ç‰ˆ</p><p>åœ¨å®˜ç½‘æœç´¢æ¨¡ç‰ˆID</p><p><img src="../image/study_img/image-20240911215221833.png" alt="image-20240911215221833"></p><p><img src="../image/study_img/image-20240911215237958.png" alt="image-20240911215237958"></p><p>å›åˆ°è‡ªå·±å®‰è£…çš„grafanaï¼Œæ·»åŠ æ¨¡ç‰ˆ</p><p><img src="../image/study_img/image-20240911215341094.png" alt="image-20240911215341094"></p><p><img src="../image/study_img/image-20240911215432195.png" alt="image-20240911215432195"></p><p><img src="../image/study_img/image-20240911215458213.png" alt="image-20240911215458213"></p><p>æ•°æ®ç”Ÿæˆ</p><p><img src="../image/study_img/image-20240911215516206.png" alt="image-20240911215516206"></p><p><img src="../image/study_img/image-20240911215800737.png" alt="image-20240911215800737"></p><p><img src="../image/study_img/image-20240911215816266.png" alt="image-20240911215816266"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">node_filesystem_size_bytes&#123;instance=<span class="string">&quot;<span class="variable">$node</span>&quot;</span>,job=<span class="string">&quot;<span class="variable">$job</span>&quot;</span>,mountpoint=<span class="string">&quot;/&quot;</span>,fstype!=<span class="string">&quot;rootfs&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">æƒ³è¦å±•ç¤ºæ•°æ®å°±æŠŠ,fstype!=<span class="string">&quot;rootfs&quot;</span>åˆ æ‰</span><br><span class="line">node_filesystem_size_bytes&#123;instance=<span class="string">&quot;<span class="variable">$node</span>&quot;</span>,job=<span class="string">&quot;<span class="variable">$job</span>&quot;</span>,mountpoint=<span class="string">&quot;/&quot;</span>,fstype!=<span class="string">&quot;rootfs&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240911215845909.png" alt="image-20240911215845909"></p><p>æƒ³è¦å±•ç¤ºæ•°æ®å°±æŠŠ,fstype!=&quot;rootfs&quot;åˆ æ‰</p><p><img src="../image/study_img/image-20240911220402516.png" alt="image-20240911220402516"></p><p><img src="../image/study_img/image-20240911220531172.png" alt="image-20240911220531172"></p><p>å†æŸ¥çœ‹æ²¡æ•°æ®çš„æ¡†ï¼ŒæŸ¥çœ‹æ²¡æ•°æ®çš„åŸå› ï¼Œå¹¶ä¿®æ”¹</p><p><img src="../image/study_img/image-20240911220656392.png" alt="image-20240911220656392"></p><p>æ— æ³•æŸ¥è¯¢æ•°æ®ï¼ŒCPUæ²¡æœ‰ç­‰å¾…æ—¶é—´ï¼ŒæŸ¥è¯¢ä¸å‡ºæ•°æ®ï¼Œæ‰€ä»¥æ²¡æœ‰æ•°æ®æ²¡å…³ç³»</p><p><img src="../image/study_img/image-20240911221251157.png" alt="image-20240911221251157"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irate(node_pressure_cpu_waiting_seconds_total&#123;instance=<span class="string">&quot;<span class="variable">$node</span>&quot;</span>,job=<span class="string">&quot;<span class="variable">$job</span>&quot;</span>&#125;[<span class="variable">$__rate_interval</span>])</span><br></pre></td></tr></table></figure><p>å†ç»§ç»­æ’æŸ¥ä¸‹ä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„åŸå› ï¼Œå¹¶ä¿®æ”¹</p><p><img src="../image/study_img/image-20240911221454957.png" alt="image-20240911221454957"></p><p><img src="../image/study_img/image-20240911221632432.png" alt="image-20240911221632432"></p><p><img src="../image/study_img/image-20240911222204013.png" alt="image-20240911222204013"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æ²¡æœ‰æ•°æ®å°±å»prometheusé‡Œé¢æŸ¥ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ç›¸å…³å­—æ®µ</span><br><span class="line"></span><br><span class="line">æ¯”è¾ƒå¥½ç”¨çš„æ¨¡ç‰ˆæœ‰</span><br><span class="line">11277</span><br><span class="line">8919</span><br></pre></td></tr></table></figure><p>8919çš„æ¨¡ç‰ˆå›¾</p><p><img src="../image/study_img/image-20240911224138667.png" alt="image-20240911224138667"></p>]]></content>
    
    
    <summary type="html">ä¸ä»…ä¸šåŠ¡æœåŠ¡å™¨å¯ä»¥ç›‘æ§ï¼Œå®¹å™¨ä¹Ÿå¯ä»¥ç›‘æ§ï¼Œæœ¬æ–‡ä½¿ç”¨Promethueså¯¹å®¹å™¨è¿›è¡Œç›‘æ§ï¼Œå·²ç»ä½¿ç”¨Grafanaå‡ºå¥½çœ‹çš„</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ä¹ã€ğŸ¡dockerçš„èµ„æºé™åˆ¶</title>
    <link href="https://www.fomal.cc/posts/79ab352e.html"/>
    <id>https://www.fomal.cc/posts/79ab352e.html</id>
    <published>2024-09-22T06:03:04.000Z</published>
    <updated>2024-09-22T07:53:34.203Z</updated>
    
    <content type="html"><![CDATA[<h2 id="dockerçš„èµ„æºé™åˆ¶">dockerçš„èµ„æºé™åˆ¶</h2><h3 id="1ã€dockerèµ„æºé™åˆ¶ä»‹ç»"><strong>1ã€dockerèµ„æºé™åˆ¶ä»‹ç»</strong></h3><p>å®˜ç½‘ï¼š <a href="https://docs.docker.com/engine/containers/resource_constraints/">https://docs.docker.com/engine/containers/resource_constraints/</a></p><p>å¸¦æœ‰å†…å­˜ã€CPU å’Œ GPU çš„è¿è¡Œæ—¶é€‰é¡¹<br>é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨æ²¡æœ‰èµ„æºé™åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ä¸»æœºå†…æ ¸è°ƒåº¦ç¨‹åºå…è®¸çš„å°½å¯èƒ½å¤šçš„ç»™å®šèµ„æºã€‚Docker æä¾›äº†æ§åˆ¶å®¹å™¨å¯ä»¥ä½¿ç”¨å¤šå°‘å†…å­˜æˆ– CPU çš„æ–¹æ³•ï¼Œè®¾ç½®docker runå‘½ä»¤çš„è¿è¡Œæ—¶é…ç½®æ ‡å¿—ã€‚æœ¬èŠ‚æä¾›æœ‰å…³ä½•æ—¶åº”è¯¥è®¾ç½®æ­¤ç±»é™åˆ¶ä»¥åŠè®¾ç½®è¿™äº›é™åˆ¶çš„å¯èƒ½å½±å“çš„è¯¦ç»†ä¿¡æ¯ã€‚</p><p>å…¶ä¸­è®¸å¤šåŠŸèƒ½éœ€è¦æ‚¨çš„å†…æ ¸æ”¯æŒ Linux åŠŸèƒ½ã€‚è¦æ£€æŸ¥æ”¯æŒï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¥ docker infoå‘½ä»¤ã€‚å¦‚æœæ‚¨çš„å†…æ ¸ä¸­ç¦ç”¨äº†æŸä¸ªåŠŸèƒ½ï¼Œæ‚¨å¯èƒ½ä¼šåœ¨è¾“å‡ºçš„æœ«å°¾çœ‹åˆ°å¦‚ä¸‹è­¦å‘Šï¼š<br>WARNING: no swap limit support</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">é˜¿é‡Œäº‘ä¸Šé¢æ²¡æœ‰swapç©ºé—´ï¼Œå› ä¸ºswapæ˜¯è™šæ‹Ÿçš„ï¼Œé˜¿é‡Œäº‘ä¹Ÿæ˜¯è™šæ‹Ÿçš„</span><br><span class="line">docker k8séƒ½ä¸è¦æswap,æœ¬æ¥å°±æ˜¯è™šæ‹ŸåŒ–çš„äº§å“ï¼ŒæŠŠè™šæ‹Ÿç£ç›˜å†å˜æˆè™šæ‹Ÿå†…å­˜ï¼Œæ€§èƒ½æ›´ä½</span><br><span class="line"></span><br><span class="line">å½“ç£ç›˜è¢«æ²¾æ»¡äº†ï¼Œä¼šå†…å­˜æº¢å‡ºï¼Œä¼šå¯åŠ¨OOM <span class="built_in">kill</span>,ä¼šæ€è¿›ç¨‹</span><br></pre></td></tr></table></figure><h4 id="Dokcerå†…å­˜é™åˆ¶"><strong>Dokcerå†…å­˜é™åˆ¶</strong></h4><p>Dockeré™åˆ¶å†…å­˜çš„ç›¸å…³å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–å‹æµ‹å·¥å…·çš„é•œåƒ</span><br><span class="line">[root@docker03 ~]# docker pull akarshes/docker-stress-ng:latest</span><br><span class="line"></span><br><span class="line">2ã€# å†…å­˜é™åˆ¶æµ‹è¯•</span><br><span class="line"><span class="comment"># æ²¡æœ‰å†…å­˜é™åˆ¶</span></span><br><span class="line">[root@docker02 ~]# docker run --name mem_test -it --<span class="built_in">rm</span> akarshes/docker-stress-ng --vm 8</span><br><span class="line">[root@docker03 ~]# docker stats</span><br><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O         BLOCK I/O         PIDS</span><br><span class="line">9450d02cb9a1   mem_test          234.65%   2.006GiB / 2.885GiB   69.55%    586B / 0B       5.55MB / 0B       17</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯¹å®¹å™¨åšèµ„æºé™åˆ¶</span></span><br><span class="line">[root@docker03 ~]# docker run --name mem_test -it --<span class="built_in">rm</span>  -m 200m akarshes/docker-stress-ng --vm 8</span><br><span class="line">[root@docker03 ~]# docker stats</span><br><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O          BLOCK I/O         PIDS</span><br><span class="line">7870345de325   mem_test          136.94%   193.2MiB / 200MiB     96.59%    656B / 0B        59.7MB / 7.41GB   15</span><br><span class="line"></span><br><span class="line">-mï¼šå…è®¸å®¹å™¨ä½¿ç”¨çš„æœ€å¤§å†…å­˜ï¼Œå•ä½ï¼škã€mã€g</span><br><span class="line">--oom-kill-disable</span><br><span class="line"><span class="comment">#æŸ¥çœ‹å‘½ä»¤çš„å¸®åŠ©</span></span><br><span class="line">docker run --name mem_test -it --<span class="built_in">rm</span> akarshes/docker-stress-ng --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Example: stress-ng --cpu 8 --io 4 --vm 2 --vm-bytes 128M --fork 4 --<span class="built_in">timeout</span> 10s</span><br></pre></td></tr></table></figure><h4 id="Dokceré™åˆ¶CPU"><strong>Dokceré™åˆ¶CPU</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ²¡åšCPUé™åˆ¶</span></span><br><span class="line">[root@docker02 ~]# docker run --name mem_test -it --<span class="built_in">rm</span> akarshes/docker-stress-ng --cpu 4</span><br><span class="line">[root@docker03 ~]# docker stats</span><br><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O         BLOCK I/O         PIDS</span><br><span class="line">3c74f649be1e   mem_test          214.19%   25.6MiB / 2.885GiB    0.87%     656B / 0B       0B / 0B           9</span><br><span class="line"><span class="comment">#cpuæ•°æ®ä¸€ç›´å¢åŠ ï¼Œåœ¨è¶…è½½</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é™åˆ¶CPU</span></span><br><span class="line">[root@docker02 ~]# docker run --name mem_test -it --<span class="built_in">rm</span> --cpus 0.5 akarshes/docker-stress-ng -cpu 8</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬èµ„æºé™åˆ¶ä¸æ˜¯ç›®çš„ï¼Œç›®çš„æ˜¯æˆ‘ä»¬è¦éšæ—¶ç›‘æ§åˆ°æˆ‘ä»¬çš„èµ„æºï¼Œèƒ½çœ‹åˆ°å®¹å™¨å¯¹å®¿ä¸»æœºèµ„æºçš„ä½¿ç”¨ï¼Œæ‰èƒ½æ›´å¥½çš„åšé™åˆ¶ï¼Œä¸è¦ç›²ç›®é™åˆ¶ï¼Œä¸çŸ¥é“èµ„æºä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œå°±å¯¹å®¹å™¨èµ„æºé™åˆ¶ï¼Œæ˜¯å¾ˆå±é™©çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å¯¹å®¹å™¨è¿›è¡Œç›‘æ§ï¼Œå¦‚æœä¸ç›‘æ§ã€‚å®¹å™¨è¶…è½½äº†å°±ä¼šå‡ºç°OMMå†…å­˜æº¢å‡ºï¼Œæ€è¿›ç¨‹çš„æƒ…å†µ</p>]]></content>
    
    
    <summary type="html">dockerèµ„æºé™åˆ¶ä»‹ç»</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>å…«ã€ğŸ¡dockerå®¹å™¨è·¨ä¸»æœºé€šä¿¡</title>
    <link href="https://www.fomal.cc/posts/f36f1204.html"/>
    <id>https://www.fomal.cc/posts/f36f1204.html</id>
    <published>2024-09-22T05:57:59.000Z</published>
    <updated>2024-09-22T07:53:34.229Z</updated>
    
    <content type="html"><![CDATA[<h2 id="dockerå®¹å™¨è·¨ä¸»æœºé€šä¿¡">dockerå®¹å™¨è·¨ä¸»æœºé€šä¿¡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">èµ·é‚£ä¹ˆå¤šå°dockerï¼Œæƒ³åšé›†ç¾¤ï¼Œå°±è¦è®©å®¹å™¨ä¹‹é—´äº’ç›¸é€šä¿¡ï¼Œç„¶ååšæˆä¸€ä¸ªæ¶æ„</span><br><span class="line"></span><br><span class="line"><span class="comment">#docker-composå¤šæœºç¼–æ’ï¼Œéœ€è¦é…åˆdocker-swarm</span></span><br><span class="line"></span><br><span class="line">ç°åœ¨èµ·ä¸€ä¸ªå®¹å™¨è‡ªå·±å†³å®šèµ·åœ¨å“ªä¸€å°ä¸Šï¼Œæ²¡æœ‰å¯¹è¿™å°çš„èµ„æºè¿›è¡Œè®¡ç®—</span><br><span class="line">å¤šæœºç¼–æ’å·¥å…·å¯ä»¥è®¡ç®—å“ªå°æœºå™¨é€‚åˆæŠŠæœåŠ¡èµ·åœ¨å“ªå°æœºå™¨</span><br></pre></td></tr></table></figure><p><strong>Dockerè·¨ä¸»æœºç½‘ç»œç±»å‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1ã€é™æ€è·¯ç”±</span><br><span class="line">2ã€flannel (k8sé‡Œé¢ç”¨çš„æ¯”è¾ƒå¤š)</span><br><span class="line">3ã€overlay</span><br><span class="line">4ã€macvlan</span><br><span class="line">5ã€calico</span><br></pre></td></tr></table></figure><h3 id="1ã€é™æ€è·¯ç”±æ¨¡å¼"><strong>1ã€é™æ€è·¯ç”±æ¨¡å¼</strong></h3><p><img src="C:%5CUsers%5CMac%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240910090901456.png" alt="image-20240910090901456"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">é™æ€è·¯ç”±åšèµ·æ¥ç®€å•ï¼Œä½†æ˜¯é˜¿é‡Œäº‘ä¸è®©æ·»åŠ è·¯ç”±</span><br><span class="line"></span><br><span class="line">1. æ·»åŠ ä¸€æ¡åˆ°è¾¾ç½‘ç»œ192.168.1.0/24çš„è·¯ç”±ï¼Œç½‘å…³ä¸º192.168.0.1ï¼Œè·ç¦»å€¼ä¸º10ï¼š</span><br><span class="line">route add -net 192.168.1.0 netmask 255.255.255.0 gw 192.168.0.1 metric 10</span><br><span class="line"></span><br><span class="line">2. æ·»åŠ ä¸€æ¡åˆ°è¾¾ä¸»æœº192.168.1.100çš„è·¯ç”±ï¼Œç½‘å…³ä¸º192.168.0.1ï¼š</span><br><span class="line">route add -host 192.168.1.100 gw 192.168.0.1</span><br><span class="line"></span><br><span class="line">3. æ·»åŠ ä¸€æ¡åˆ°è¾¾ç½‘ç»œ192.168.0.0/16çš„è·¯ç”±ï¼Œç½‘å…³ä¸º192.168.1.1ï¼Œè·ç¦»å€¼ä¸º20ï¼Œç»è¿‡eth0æ¥å£ï¼š</span><br><span class="line">route add -net 192.168.0.0 netmask 255.255.0.0 gw 192.168.1.1 metric 20 dev eth0</span><br></pre></td></tr></table></figure><p>2ã€flannel (k8sé‡Œé¢ç”¨çš„æ¯”è¾ƒå¤š)</p><p><img src="C:%5CUsers%5CMac%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240910091610337.png" alt="image-20240910091610337"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flannelå›¾å½¢åŒ–ç•Œé¢éœ€è¦é…ç½®è¯ä¹¦</span><br></pre></td></tr></table></figure><h3 id="2ã€flanneç½‘ç»œæ¨¡å¼çš„éƒ¨ç½²"><strong>2ã€flanneç½‘ç»œæ¨¡å¼çš„éƒ¨ç½²</strong></h3><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th><th>åº”ç”¨</th></tr></thead><tbody><tr><td>docker01</td><td>10.0.0.101  /  172.16.1.101</td><td>äº’ç›¸é€šä¿¡çš„å®¹å™¨</td><td>flanne</td></tr><tr><td>docker02</td><td>10.0.0.102  /  172.16.1.102</td><td>äº’ç›¸é€šä¿¡çš„å®¹å™¨</td><td>flanne</td></tr><tr><td>docker03</td><td>10.0.0.103  /  172.16.1.103</td><td>äº’ç›¸é€šä¿¡çš„å®¹å™¨</td><td>flanne</td></tr><tr><td>elk01</td><td>10.0.0.76  /  172.16.1.76</td><td>å‚¨å­˜æ•°æ®çš„ä¸­ä»‹</td><td>ETCD</td></tr></tbody></table><p>1ã€éƒ¨ç½²ETCD</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1ã€å®‰è£…etcd</span><br><span class="line">[root@elk1 ~]# yum -y install etcd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ä¿®æ”¹etcdé…ç½®æ–‡ä»¶</span><br><span class="line">[root@elk1 ~]# vim /etc/etcd/etcd.conf </span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=default</span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://172.16.1.76:2379,http://127.0.0.1:2379&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://172.16.1.76:2379&quot;</span></span><br><span class="line"></span><br><span class="line">3ã€å¯åŠ¨etcdå¹¶åŠ å…¥å¼€æœºè‡ªå¯</span><br><span class="line">[root@elk1 ~]# systemctl start etcd</span><br><span class="line">[root@elk1 ~]# systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">æŸ¥çœ‹ç«¯å£ 2380æ˜¯å›¾å½¢åŒ–ç•Œé¢è¿æ¥çš„ç«¯å£</span><br></pre></td></tr></table></figure><p>ETCDçš„åŸºç¡€æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-c  è°ƒæ¥å£</span><br><span class="line"></span><br><span class="line">1ã€æ£€æŸ¥é›†ç¾¤çš„å¥åº·çŠ¶æ€</span><br><span class="line">[root@elk1 ~]# etcdctl -C http://127.0.0.1:2379 cluster-health</span><br><span class="line"></span><br><span class="line">2ã€å†™å…¥æ•°æ®</span><br><span class="line">[root@elk1 ~]# etcdctl -C http://127.0.0.1:2379 <span class="built_in">set</span> /testdir/testkey <span class="string">&quot;hello world&quot;</span></span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹æ•°æ®</span><br><span class="line">[root@elk1 ~]# etcdctl -C http://127.0.0.1:2379 get /testdir/testkey </span><br></pre></td></tr></table></figure><p>2ã€3å°æœºå™¨å®‰è£…é…ç½®flannel</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1ã€3å°æœºå™¨å®‰è£…flannel</span><br><span class="line">[root@docker01 ~]# yum -y install flannel</span><br><span class="line">[root@docker02 ~]# yum -y install flannel</span><br><span class="line">[root@docker02 ~]# yum -y install flannel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€3å°æœºå™¨ä¿®æ”¹flannleé…ç½®æ–‡ä»¶</span><br><span class="line">[root@docker02 ~]# vim /etc/sysconfig/flanneld</span><br><span class="line"><span class="comment">#å†™etcdç«¯çš„ip</span></span><br><span class="line">FLANNEL_ETCD_ENDPOINTS=<span class="string">&quot;http://172.16.1.76:2379&quot;</span></span><br><span class="line"><span class="comment">#è¿™æ®µæ˜¯é»˜è®¤çš„ï¼Œä¸éœ€è¦ä¿®æ”¹ï¼Œä¸€ä¼šè¦åœ¨æ”¹ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶</span></span><br><span class="line">FLANNEL_ETCD_PREFIX=<span class="string">&quot;/atomic.io/network&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€åˆ›å»ºflannelæ•°æ®å†etcdä¸­</span><br><span class="line">[root@elk1 ~]# etcdctl mk /atomic.io/network/config <span class="string">&#x27;&#123;&quot;Network&quot;:&quot;192.168.0.0/16&quot;&#125;&#x27;</span></span><br><span class="line">&#123;<span class="string">&quot;Network&quot;</span>:<span class="string">&quot;192.168.0.0/16&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">[root@elk1 ~]# etcdctl -C http://127.0.0.1:2379 <span class="built_in">set</span> /atomic.io/network/config <span class="string">&#x27;&#123;&quot;Network&quot;:&quot;192.168.0.0/16&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">4ã€3å°æœºå™¨å¯åŠ¨flannel</span><br><span class="line">[root@docker01 ~]# systemctl start flanneld &amp;&amp; systemctl <span class="built_in">enable</span> flanneld</span><br><span class="line"></span><br><span class="line">5ã€3å°æœºå™¨æŸ¥çœ‹flannel0ç½‘å¡ä¿¡æ¯</span><br><span class="line">[root@docker01 ~]# ifconfig</span><br><span class="line">flannel0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1472</span><br><span class="line">        inet 192.168.54.0  netmask 255.255.0.0  destination 192.168.54.0</span><br></pre></td></tr></table></figure><p>3ã€å…³è”flannelå’Œdocker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">1ã€3å°æœºå™¨æŸ¥çœ‹æ”¹æ–‡ä»¶ï¼Œä¸€ä¼šä¼šåœ¨å¯åŠ¨è„šæœ¬é‡Œé¢åŠ ä¿¡æ¯</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> /run/flannel/docker </span><br><span class="line">DOCKER_OPT_BIP=<span class="string">&quot;--bip=192.168.22.1/24&quot;</span></span><br><span class="line">DOCKER_OPT_IPMASQ=<span class="string">&quot;--ip-masq=true&quot;</span></span><br><span class="line">DOCKER_OPT_MTU=<span class="string">&quot;--mtu=1472&quot;</span></span><br><span class="line">DOCKER_NETWORK_OPTIONS=<span class="string">&quot; --bip=192.168.22.1/24 --ip-masq=true --mtu=1472&quot;</span></span><br><span class="line"></span><br><span class="line">2ã€3å°æœºå™¨ä¿®æ”¹dockerå¯åŠ¨è„šæœ¬</span><br><span class="line">[root@docker02 ~]# vim /usr/lib/systemd/system/docker.service</span><br><span class="line">[Service]</span><br><span class="line"><span class="comment">#æ·»åŠ è¿™è¡Œè¯»å–ç¯å¢ƒå˜é‡æ–‡ä»¶</span></span><br><span class="line">EnviromentFile=/run/flannel/docker </span><br><span class="line"><span class="comment">#åœ¨æœ€åé¢æ·»åŠ å˜é‡</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line"></span><br><span class="line">[root@docker03 ~]# systemctl daemon-reload &amp;&amp; systemctl restart flanneld</span><br><span class="line"></span><br><span class="line">3ã€3å°æœºå™¨å¼€å¯å†…æ ¸è½¬å‘</span><br><span class="line">[root@docker03 ~]# <span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.ip_forward=1&#x27;</span>  &gt;&gt; /etc/sysctl.conf </span><br><span class="line"></span><br><span class="line">4ã€3å°æœºå™¨å¼€åšå¦‚ä¸‹æ“ä½œ</span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line">[root@docker01 ~]# systemctl start firewalld</span><br><span class="line">[root@docker01 ~]# systemctl stop firewalld</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# systemctl start firewalld &amp;&amp; systemctl stop firewalld</span><br><span class="line">[root@docker01 ~]#  systemctl restart network</span><br><span class="line">[root@docker01 ~]#  systemctl restart flanneld </span><br><span class="line">[root@docker01 ~]#  systemctl restart docker</span><br><span class="line"></span><br><span class="line">------------æ³¨æ„---------------------</span><br><span class="line">1ã€# æ‰§è¡Œdocker info å‡ºç°è­¦å‘Š</span><br><span class="line"><span class="comment">#éœ€è¦é…ç½®å†…æ ¸è½¬å‘æ”¯æŒiptables</span></span><br><span class="line">WARNING: bridge-nf-call-iptables is disabled</span><br><span class="line">WARNING: bridge-nf-call-ip6tables is disabled</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/docker.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">[root@docker01 ~]#  systemctl restart network</span><br><span class="line">[root@docker01 ~]#  systemctl restart flanneld </span><br><span class="line">[root@docker01 ~]#  systemctl restart docker</span><br></pre></td></tr></table></figure><p>3ã€æµ‹è¯•æ˜¯å¦å¯ä»¥é€šä¿¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1ã€è¿›å»æŸ¥çœ‹3å°æœºå™¨çš„ip,ç„¶åå†äº’ç›¸ping  IPï¼Œå¦‚æœå¯ä»¥pingé€šåˆ™ok</span><br><span class="line">[root@docker01 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:C0:A8:36:02  </span><br><span class="line">          inet addr:192.168.54.2  Bcast:192.168.54.255  Mask:255.255.255.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@docker02 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:C0:A8:16:05  </span><br><span class="line">          inet addr:192.168.22.5  Bcast:192.168.22.255  Mask:255.255.255.0</span><br><span class="line">          </span><br><span class="line">[root@docker03 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:C0:A8:39:05  </span><br><span class="line">          inet addr:192.168.57.5  Bcast:192.168.57.255  Mask:255.255.255.0</span><br></pre></td></tr></table></figure><h3 id="3ã€overlayè·¨ä¸»æœºé€šä¿¡"><strong>3ã€overlayè·¨ä¸»æœºé€šä¿¡</strong></h3><p><img src="C:%5CUsers%5CMac%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240910144826332.png" alt="image-20240910144826332"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">http://www.cnblogs.com/CloudMan6/p/7270551.html</span><br><span class="line"></span><br><span class="line">docker03ä¸Šï¼š consulå­˜å‚¨ipåœ°å€çš„åˆ†é…</span><br><span class="line">docker run -d -p 8500:8500 -h consul --name consul progrium/consul -server -bootstrap</span><br><span class="line"></span><br><span class="line">è®¾ç½®å®¹å™¨çš„ä¸»æœºå</span><br><span class="line">consulï¼škvç±»å‹çš„å­˜å‚¨æ•°æ®åº“ï¼ˆkey:valueï¼‰</span><br><span class="line">docker01ã€02ä¸Šï¼š</span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;cluster-store&quot;</span>: <span class="string">&quot;consul://10.0.0.13:8500&quot;</span>,</span><br><span class="line"><span class="string">&quot;cluster-advertise&quot;</span>: <span class="string">&quot;10.0.0.11:2376&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vim /usr/lib/systemd/system/docker.service</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line">2ï¼‰åˆ›å»ºoverlayç½‘ç»œ</span><br><span class="line">docker network create -d overlay --subnet 172.16.2.0/24 --gateway 172.16.2.254 ol1</span><br><span class="line"></span><br><span class="line">3ï¼‰å¯åŠ¨å®¹å™¨æµ‹è¯•</span><br><span class="line">docker run -it --network ol1 --name oldboy01 busybox /bin/sh</span><br><span class="line">æ¯ä¸ªå®¹å™¨æœ‰ä¸¤å—ç½‘å¡,eth0å®ç°å®¹å™¨é—´çš„é€šè®¯,eth1å®ç°å®¹å™¨è®¿é—®å¤–ç½‘</span><br></pre></td></tr></table></figure><h3 id="4ã€macvlan"><strong>4ã€macvlan</strong></h3><p>é»˜è®¤ä¸€ä¸ªç‰©ç†ç½‘å¡ï¼Œåªæœ‰ä¸€ä¸ªç‰©ç†macåœ°å€ï¼Œè™šæ‹Ÿå¤šä¸ªmacåœ°å€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ›å»ºmacvlanç½‘ç»œ</span></span><br><span class="line">docker network create --driver macvlan --subnet 10.0.0.0/24 --gateway 10.0.0.254 -o parent=eth0 macvlan_1</span><br><span class="line"></span><br><span class="line"><span class="comment">## è®¾ç½®eth0çš„ç½‘å¡ä¸ºæ··æ‚æ¨¡å¼</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 promisc on</span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ›å»ºä½¿ç”¨macvlanç½‘ç»œçš„å®¹å™¨</span></span><br><span class="line">docker run -it --network macvlan_1 --ip=10.0.0.200 busybox</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Dockerè·¨ä¸»æœºç½‘ç»œæ¨¡å¼çš„ä»‹ç»</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ä¸ƒã€ğŸ¡DOckerå•æœºç¼–æ’å·¥å…·</title>
    <link href="https://www.fomal.cc/posts/c7b1e5e1.html"/>
    <id>https://www.fomal.cc/posts/c7b1e5e1.html</id>
    <published>2024-09-22T05:54:39.000Z</published>
    <updated>2024-09-22T07:53:34.205Z</updated>
    
    <content type="html"><![CDATA[<h2 id="DOckerå•æœºç¼–æ’å·¥å…·">DOckerå•æœºç¼–æ’å·¥å…·</h2><h3 id="1ã€docker-composeçš„ä»‹ç»">1ã€<strong>docker-composeçš„ä»‹ç»</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Composeæ˜¯ç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨Dockeråº”ç”¨å·¥å…·é€šè¿‡Compose å¯ä»¥ä½¿ç”¨YMLæ–‡ä»¶æ¥é…ç½®åº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„æ‰€æœ‰æœåŠ¡ï¼Œç”¨æ¥ç®¡ç†å®¹å™¨çš„èµ·åœï¼ŒæŸ¥çœ‹å®¹å™¨çš„æ—¥å¿—ï¼Œæ¯”è¾ƒæ–¹ä¾¿</span><br><span class="line">ä¸åƒdocker runå‘½ä»¤æ¯”è¾ƒé•¿ï¼Œè€Œä¸”æ˜¯ä¸´æ—¶æ‰§è¡Œçš„</span><br><span class="line"></span><br><span class="line">DockerComposeä½¿ç”¨çš„ä¸‰æ­¥:</span><br><span class="line">1.ä½¿ç”¨docker file å®šä¹‰åº”ç”¨ç¨‹åºçš„ç¯å¢ƒé•œåƒ</span><br><span class="line">2.docker-composeå®šä¹‰æ„æˆåº”ç”¨ç¨‹åºçš„æœåŠ¡</span><br><span class="line">3.å¯åŠ¨Composeï¼Œå°±ç›¸å½“äºå¯åŠ¨åº”ç”¨</span><br></pre></td></tr></table></figure><p><strong>ç‰ˆæœ¬</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">composeæ–‡ä»¶ç‰ˆæœ¬ï¼šversion: <span class="string">&#x27;2.3&#x27;</span></span><br><span class="line"></span><br><span class="line">docker-composeç¨‹åºå®‰è£…çš„ç‰ˆæœ¬ï¼š</span><br><span class="line">[root@harbor harbor]# docker-compose --version</span><br><span class="line">docker-compose version 1.18.0, build 8dd22a9</span><br><span class="line"></span><br><span class="line">dockerç‰ˆæœ¬ï¼š</span><br><span class="line">[root@harbor harbor]# docker --version</span><br><span class="line">Docker version 26.1.4, build 5650f9b</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240909134745384.png" alt="image-20240909134745384"></p><h3 id="2ã€å®‰è£…bocker-compose">2ã€<strong>å®‰è£…bocker-compose</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ–¹æ³•ä¸€ï¼šç‰ˆæœ¬ä¸å¯æ§ï¼Œå®‰è£…çš„ç‰ˆæœ¬ç¨å¾®åè€  1.18çš„</span></span><br><span class="line">1ã€å®‰è£…bocker-compose </span><br><span class="line">[root@docker01 ~]# yum install -y docker-compose</span><br><span class="line">[root@docker01 ~]# docker-compose --version</span><br><span class="line">docker-compose version 1.18.0, build 8dd22a9</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€æ–¹æ³•äºŒ  å¯èƒ½è¦å¼€ä»£ç†ä¸‹è½½</span><br><span class="line">[root@docker02 bin]# curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/v2.29.2/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/2.29.2/dockercompose-Linux-x86_64&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# <span class="built_in">mv</span> docker-compose-linux-x86_64\ \(2\)  docker-compose</span><br><span class="line">[root@docker01 ~]# <span class="built_in">mv</span> docker-compose /usr/local/bin/</span><br><span class="line">[root@docker01 ~]# <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose    </span><br><span class="line">[root@docker01 ~]# docker-compose  --version</span><br><span class="line">Docker Compose version v2.29.2</span><br><span class="line"></span><br><span class="line"><span class="comment">#æƒ³è¦å…¶ä»–æœºå™¨èƒ½å¤Ÿä½¿ç”¨docker-composeå‘½ä»¤,å¯ä»¥æŠŠè¿™ä¸ªæ–‡ä»¶scpè¿‡å»</span></span><br><span class="line">scp /usr/local/bin/docker-compose 10.0.0.102:/usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="3ã€docker-composeçš„æ¨¡ç‰ˆ">3ã€<strong>docker-composeçš„æ¨¡ç‰ˆ</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;ç‰ˆæœ¬å·&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  æœåŠ¡åç§°1:</span><br><span class="line">    image: å®¹å™¨é•œåƒ</span><br><span class="line">    container_name: å®¹å™¨åç§°(å®¹å™¨åç§°å’ŒæœåŠ¡åç§°ä¿æŒä¸€è‡´)</span><br><span class="line">    environment:</span><br><span class="line">      - ç¯å¢ƒå˜é‡1=å€¼1</span><br><span class="line">      - ç¯å¢ƒå˜é‡2=å€¼2</span><br><span class="line">    volumes:</span><br><span class="line">      - å®¿ä¸»æœºæ•°æ®ç›®å½•:å®¹å™¨å†…æ•°æ®ç›®å½•</span><br><span class="line">    ports:</span><br><span class="line">      - å®¿ä¸»æœºç«¯å£:å®¹å™¨å†…æ˜ å°„ç«¯å£</span><br><span class="line">    networks:</span><br><span class="line">      - è‡ªå®šä¹‰ç½‘ç»œåç§°</span><br><span class="line">    links:</span><br><span class="line">      - namenode</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - æ•°æ®åº“ä½¿ç”¨å­—ç¬¦é›†å˜é‡æ—¶å¯ä»¥ç”¨</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  æœåŠ¡åç§°2:</span><br><span class="line">    image: å®¹å™¨é•œåƒ</span><br><span class="line">    container_name: å®¹å™¨åç§°(å®¹å™¨åç§°å’ŒæœåŠ¡åç§°ä¿æŒä¸€è‡´)</span><br><span class="line">    environment:</span><br><span class="line">      - ç¯å¢ƒå˜é‡1=å€¼1</span><br><span class="line">      - ç¯å¢ƒå˜é‡2=å€¼2</span><br><span class="line">    user: å®¿ä¸»æœºç”¨æˆ·:å®¹å™¨ç”¨æˆ·</span><br><span class="line">    volumes:</span><br><span class="line">      - å®¿ä¸»æœºæ•°æ®ç›®å½•:å®¹å™¨å†…æ•°æ®ç›®å½•</span><br><span class="line">    ports:</span><br><span class="line">      - å®¿ä¸»æœºç«¯å£:å®¹å™¨å†…æ˜ å°„ç«¯å£</span><br><span class="line">    networks:</span><br><span class="line">      - è‡ªå®šä¹‰ç½‘ç»œåç§°</span><br><span class="line">    links:</span><br><span class="line">      - namenode</span><br><span class="line">    depends_on:</span><br><span class="line">      - ä¾èµ–æœåŠ¡</span><br><span class="line">    restart: always</span><br><span class="line"> </span><br><span class="line"><span class="comment">#å¦‚æœæ²¡æœ‰ç½‘ç»œï¼Œå°±ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">networks:</span><br><span class="line">  default:</span><br><span class="line">  externnal: <span class="literal">true</span></span><br><span class="line">  name: è‡ªå®šä¹‰ç½‘ç»œåç§°</span><br></pre></td></tr></table></figure><h3 id="4ã€docker-composeâ€”â€”å•æœºç¼–æ’mysql">4ã€<strong>docker-composeâ€”â€”å•æœºç¼–æ’mysql</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">1ã€#æ‰¾åˆ°è¿è¡Œmysqlçš„å‘½ä»¤</span><br><span class="line">docker run \</span><br><span class="line">--name mysql80 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=zabbix \</span><br><span class="line">-e MYSQL_USER=zabbix \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:8.0 \</span><br><span class="line">--character-set-server=utf8mb4 \</span><br><span class="line">--collation-server=utf8mb4_bin \</span><br><span class="line">--log_bin_trust_function_creators</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#ç¼–å†™docker-compose</span><br><span class="line">å¦‚æœä¹‹å‰è¿è¡Œæœ‰å…¶ä»–ç‰ˆæœ¬çš„mysqlï¼Œéœ€è¦æ¸…é™¤ç›®å½•</span><br><span class="line">[root@docker01 mysql]# <span class="built_in">rm</span> -rf /data/</span><br><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> mysql</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cd</span> mysql/</span><br><span class="line">[root@docker01 mysql]# vim mysql-compose.yml    (åå­—æœ€å¥½å«docker-compose.yml)</span><br><span class="line">version: <span class="string">&#x27;2.0&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  mysql80:</span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    container_name: mysql80</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=123</span><br><span class="line">      - MYSQL_DATABASE=zabbix</span><br><span class="line">      - MYSQL_USER=zabbix</span><br><span class="line">      - MYSQL_PASSWORD=123</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/mysql:/var/lib/mysql</span><br><span class="line">    ports:</span><br><span class="line">      - 3306:3306</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - --character-set-server=utf8mb4</span><br><span class="line">      - --collation-server=utf8mb4_bin</span><br><span class="line">      - --log_bin_trust_function_creators</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#ç¬¬ä¸€æ¬¡å¯åŠ¨ä½¿ç”¨up,ä¼šåˆ›å»ºå®¹å™¨å¹¶å¯åŠ¨å®¹å™¨,å‰å°è¾“å‡ºæ—¥å¿—</span><br><span class="line">å¦‚æœåˆ›å»ºçš„æ–‡ä»¶åå«docker-compose.ymlï¼Œå¯åŠ¨å‘½ä»¤æ˜¯ï¼š</span><br><span class="line">      docker-compose up</span><br><span class="line">      </span><br><span class="line">å¦‚æœåˆ›å»ºçš„æ–‡ä»¶åä¸å«docker-compose.ymlï¼Œå¯åŠ¨å‘½ä»¤æ˜¯ï¼š</span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml up</span><br><span class="line"></span><br><span class="line">æ£€æŸ¥æ²¡é—®é¢˜å°±ctrl+c</span><br></pre></td></tr></table></figure><p>docker-composeçš„æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€æ¬¡å¯åŠ¨åˆ›å»ºå®¹å™¨å¹¶å‰å°è¾“å‡ºæ—¥å¿—</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml up</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœæ—¥å¿—æ²¡æœ‰æŠ¥é”™ï¼Œç›´æ¥åå°å¯åŠ¨</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœæ­¢å®¹å™¨</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨å®¹å™¨</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml start</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯å®¹å™¨</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¯¥composeä¸­çš„æ‰€æœ‰å®¹å™¨è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤composeä¸­çš„å®¹å™¨</span></span><br><span class="line">[root@docker01 mysql]# docker-compose <span class="built_in">rm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ—¥å¿—</span></span><br><span class="line">[root@docker01 mysql]# docker-compose logs</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šæœåŠ¡å¯åœ</span></span><br><span class="line">[root@harbor harbor]# docker-compose start proxy</span><br></pre></td></tr></table></figure><h3 id="5ã€docker-composeâ€”â€”å•æœºç¼–æ’zabbix">5ã€<strong>docker-composeâ€”â€”å•æœºç¼–æ’zabbix</strong></h3><p>1ã€æ‰¾åˆ°è¿è¡Œzabbixçš„dockerå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">mysqlè¦åˆå§‹åŒ–ã€‚æ‰€ä»¥web-serverè¦åå¯åŠ¨  å†™æˆ=å¦‚æœæŠ¥é”™ã€‚å°±è¦å†™æˆkey: value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€#æ‰¾åˆ°è¿è¡Œmysqlçš„å‘½ä»¤</span><br><span class="line">docker run \</span><br><span class="line">--name mysql80 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=zabbix \</span><br><span class="line">-e MYSQL_USER=zabbix \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:8.0 \</span><br><span class="line">--character-set-server=utf8mb4 \</span><br><span class="line">--collation-server=utf8mb4_bin \</span><br><span class="line">--log_bin_trust_function_creators</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œå®¹å™¨åŒ–zabbix-server</span><br><span class="line">docker run \</span><br><span class="line">--<span class="built_in">link</span> mysql80 \</span><br><span class="line">--name zabbix-server \</span><br><span class="line">-p 10051:10051 \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">&quot;mysql80&quot;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&quot;123&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-server-mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€å®¹å™¨åŒ–zabbix-web</span><br><span class="line">docker run \</span><br><span class="line">--<span class="built_in">link</span> zabbix-server \</span><br><span class="line">--<span class="built_in">link</span> mysql80 \</span><br><span class="line">--name zabbix-web \</span><br><span class="line">-p 80:8080 \</span><br><span class="line">-p 8443:8443 \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">&quot;mysql80&quot;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&quot;123&quot;</span> \</span><br><span class="line">-e ZBX_SERVER_HOST=<span class="string">&quot;zabbix-server&quot;</span> \</span><br><span class="line">-e PHP_TZ=<span class="string">&quot;Asia/Shanghai&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-web-nginx-mysql</span><br></pre></td></tr></table></figure><p>2ã€ç¼–å†™zabbixçš„docker-compose</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# <span class="built_in">rm</span> -rf /data/</span><br><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> zabbix</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cd</span> zabbix/</span><br><span class="line">[root@docker01 zabbix]# vim docker-compose.yml</span><br><span class="line">version: <span class="string">&#x27;2.0&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  mysql80:</span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    container_name: mysql80</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=123</span><br><span class="line">      - MYSQL_DATABASE=zabbix</span><br><span class="line">      - MYSQL_USER=zabbix</span><br><span class="line">      - MYSQL_PASSWORD=123</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/mysql:/var/lib/mysql</span><br><span class="line">    ports:</span><br><span class="line">      - 3306:3306</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - --character-set-server=utf8mb4</span><br><span class="line">      - --collation-server=utf8mb4_bin</span><br><span class="line">      - --log_bin_trust_function_creators</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  zabbix-server:</span><br><span class="line">    image: zabbix/zabbix-server-mysql</span><br><span class="line">    container_name: zabbix-server</span><br><span class="line">    environment:</span><br><span class="line">      - DB_SERVER_HOST=mysql80</span><br><span class="line">      - MYSQL_USER=zabbix</span><br><span class="line">      - MYSQL_PASSWORD=123</span><br><span class="line">    ports:</span><br><span class="line">      - 10051:10051</span><br><span class="line">    links:</span><br><span class="line">      - mysql80</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">  zabbix-web:</span><br><span class="line">    image: zabbix/zabbix-web-nginx-mysql</span><br><span class="line">    container_name: zabbix-web</span><br><span class="line">    environment:</span><br><span class="line">      - DB_SERVER_HOST=mysql80</span><br><span class="line">      - MYSQL_USER=zabbix</span><br><span class="line">      - MYSQL_PASSWORD=123</span><br><span class="line">      - ZBX_SERVER_HOST=zabbix-server</span><br><span class="line">      - PHP_TZ=Asia/Shanghai</span><br><span class="line">    ports:</span><br><span class="line">      - 80:8080</span><br><span class="line">      - 443:8443</span><br><span class="line">    links:</span><br><span class="line">      - mysql80</span><br><span class="line">      - zabbix-server</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line"><span class="comment">#  networks:</span></span><br><span class="line"><span class="comment">#    default:</span></span><br><span class="line"><span class="comment">#      externnal: true</span></span><br><span class="line"><span class="comment">#      name: zabbix-net</span></span><br><span class="line"><span class="comment">#åŸºäºé»˜è®¤çš„default-bridgeç±»å‹åˆ›å»ºä¸€ä¸ªbridgeç±»å‹çš„ç½‘æ¡¥</span></span><br></pre></td></tr></table></figure><p>####æŠ¥é”™</p><p><img src="../image/study_img/image-20240909153932154.png" alt="image-20240909153932154"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## å¦‚æœæœ‰ç¯å¢ƒå˜é‡çš„æŠ¥é”™ï¼Œå°±å–æ¶ˆå•å¼•å·è¯•ä¸€ä¸‹ï¼Œä¸è¡Œå†æ¢æˆkey:valueæ ¼å¼</span></span><br><span class="line">environment:</span><br><span class="line">- DB_SERVER_HOST: <span class="string">&#x27;mysql80&#x27;</span></span><br><span class="line">- MYSQL_USER: <span class="string">&#x27;zabbix&#x27;</span></span><br><span class="line">- MYSQL_PASSWORD: <span class="string">&#x27;zabbix&#x27;</span></span><br></pre></td></tr></table></figure><p>3ã€å¯åŠ¨zabbix</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1ã€å‰å°æ£€æŸ¥æ˜¯å¦æœ‰æŠ¥é”™</span><br><span class="line">[root@docker01 zabbix]# docker-compose up </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€æ²¡æœ‰æŠ¥é”™å°±æ”¾åå°è¿è¡Œ</span><br><span class="line">[root@docker01 zabbix]# docker-compose up -d</span><br><span class="line"></span><br><span class="line">3ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.101</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240909154947402.png" alt="image-20240909154947402"></p><h3 id="6ã€docker-composeâ€”â€”å•æœºç¼–æ’jenkins">6ã€<strong>docker-composeâ€”â€”å•æœºç¼–æ’jenkins</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">1ã€gitlabé•œåƒ</span><br><span class="line">docker run \</span><br><span class="line">--hostname 10.0.0.102 \</span><br><span class="line">--<span class="built_in">env</span> GITLAB_OMNIBUS_CONFIG=<span class="string">&quot;external_url &#x27;http://10.0.0.102&#x27;&quot;</span> \</span><br><span class="line">-p 443:443 -p 80:80 -p 2222:22 \</span><br><span class="line">--name gitlab \</span><br><span class="line">--restart always \</span><br><span class="line">-v /data/gitlab/config:/etc/gitlab \</span><br><span class="line">-v /data/gitlab/logs:/var/log/gitlab \</span><br><span class="line">-v /data/gitlab/data:/var/opt/gitlab \</span><br><span class="line">-d gitlab/gitlab-ce</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œjenkinså®¹å™¨</span><br><span class="line">docker run \</span><br><span class="line">--name jenkins \</span><br><span class="line">--privileged \</span><br><span class="line">--user=root \</span><br><span class="line">--restart=always \</span><br><span class="line">-v /data/jenkins/:/var/jenkins_home \</span><br><span class="line">-v /usr/bin/docker:/usr/bin/docker \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">-v /root/.ssh/:/root/.ssh/ \</span><br><span class="line">-v /root/.docker/config.json:/root/.docker/config.json \</span><br><span class="line">-p 8080:8080 \</span><br><span class="line">-p 5000:5000 \</span><br><span class="line">-d jenkins/jenkins:2.422</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> jenkins &amp;&amp; <span class="built_in">cd</span> jenkins</span><br><span class="line">[root@docker01 jenkins]# vim jenkins-docker-compose.yml</span><br><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    image: gitlab/gitlab-ce</span><br><span class="line">    container_name: gitlab</span><br><span class="line">    hostname: 10.0.0.102</span><br><span class="line">    environment:</span><br><span class="line">      GITLAB_OMNIBUS_CONFIG: |</span><br><span class="line">        external_url <span class="string">&#x27;http://10.0.0.102</span></span><br><span class="line"><span class="string">        gitlab_rails[&#x27;</span>gitlab_shell_ssh_port<span class="string">&#x27;] = 2222 </span></span><br><span class="line"><span class="string">        alertmanager[&#x27;</span><span class="built_in">enable</span><span class="string">&#x27;] = false</span></span><br><span class="line"><span class="string">        node_exporter[&#x27;</span><span class="built_in">enable</span><span class="string">&#x27;] = false</span></span><br><span class="line"><span class="string">        redis_exporter[&#x27;</span><span class="built_in">enable</span><span class="string">&#x27;] = false</span></span><br><span class="line"><span class="string">        postgres_exporter[&#x27;</span><span class="built_in">enable</span><span class="string">&#x27;] = false</span></span><br><span class="line"><span class="string">    volumes:</span></span><br><span class="line"><span class="string">      - /data/gitlab/config:/etc/gitlab </span></span><br><span class="line"><span class="string">      - /data/gitlab/logs:/var/log/gitlab </span></span><br><span class="line"><span class="string">      - /data/gitlab/data:/var/opt/gitlab</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - 443:443 </span></span><br><span class="line"><span class="string">      - 80:80 </span></span><br><span class="line"><span class="string">      - 2222:22</span></span><br><span class="line"><span class="string">    restart: always</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">  jenkins:</span></span><br><span class="line"><span class="string">    image: jenkins/jenkins:2.422</span></span><br><span class="line"><span class="string">    container_name: jenkins</span></span><br><span class="line"><span class="string">    user: root</span></span><br><span class="line"><span class="string">    privileged: ture</span></span><br><span class="line"><span class="string">    volumes:</span></span><br><span class="line"><span class="string">      - /data/jenkins/:/var/jenkins_home</span></span><br><span class="line"><span class="string">      - /usr/bin/docker:/usr/bin/docker</span></span><br><span class="line"><span class="string">      - /var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line"><span class="string">      - /root/.ssh/:/root/.ssh/</span></span><br><span class="line"><span class="string">      - /root/.docker/config.json:/root/.docker/config.json</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - 8080:8080 </span></span><br><span class="line"><span class="string">      - 5000:5000 </span></span><br><span class="line"><span class="string">    restart: always</span></span><br></pre></td></tr></table></figure><h3 id="7ã€docker-composeâ€”â€”å•æœºç¼–æ’wordpress">7ã€<strong>docker-composeâ€”â€”å•æœºç¼–æ’wordpress</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œwordpresså®¹å™¨</span></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wp_db \</span><br><span class="line">-d wordpress-df:v1 </span><br></pre></td></tr></table></figure><p>2ã€ç¼–å†™docker-compos</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> wp</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cd</span> wp/</span><br><span class="line">[root@docker01 wp]# vim wp-docker-compose.yml</span><br><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  mysql57:</span><br><span class="line">    image: mysql:5.7.44</span><br><span class="line">    container_name: mysql57</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=123</span><br><span class="line">      - MYSQL_DATABASE=wp_db</span><br><span class="line">      - MYSQL_USER=wp_user</span><br><span class="line">      - MYSQL_PASSWORD=123</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/mysql:/var/lib/mysql</span><br><span class="line">    ports:</span><br><span class="line">      - 3306:3306</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  wp:</span><br><span class="line">    image:  wordpress-df:v2</span><br><span class="line">    container_name: wp</span><br><span class="line">    environment:</span><br><span class="line">      - WORDPRESS_DB_HOST=mysql57</span><br><span class="line">      - WORDPRESS_DB_USER=wp_user</span><br><span class="line">      - WORDPRESS_DB_PASSWORD=123</span><br><span class="line">      - WORDPRESS_DB_NAME=wp_db</span><br><span class="line">    ports:</span><br><span class="line">      - 80:80</span><br><span class="line">    links:</span><br><span class="line">      - mysql57</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">[root@docker01 wp]# docker-compose -f wp-docker-compose.yml up -d</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ä½¿ç”¨docker-composeç†å®¹å™¨çš„èµ·åœ</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>å…­ã€ğŸ¡dockerçš„å®¹å™¨åŒ–ä»£ç ä¸Šçº¿</title>
    <link href="https://www.fomal.cc/posts/93124e7b.html"/>
    <id>https://www.fomal.cc/posts/93124e7b.html</id>
    <published>2024-09-22T05:24:52.000Z</published>
    <updated>2024-09-25T13:48:36.333Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å®¹å™¨åŒ–ä»£ç ä¸Šçº¿">å®¹å™¨åŒ–ä»£ç ä¸Šçº¿</h2><h3 id="1ã€å®¹å™¨åŒ–gitlab"><strong>1ã€å®¹å™¨åŒ–gitlab</strong></h3><p>ç¯å¢ƒå‡†å¤‡  å…ˆæ£€æŸ¥å¯ä»¥å†…å­˜Avail(æœ€å°‘è¿˜æœ‰10G)æ¯”è¾ƒå¤šçš„æœºå™¨ï¼Œå»æ‹‰å–gitlabï¼Œä¸ç„¶ä¼šæ‹‰å–å¤±è´¥</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th><th>å†…å­˜</th></tr></thead><tbody><tr><td>docker03</td><td>10.0.0.102  /  172.16.1.102</td><td>éƒ¨ç½²å®¹å™¨åŒ–gitlab</td><td>8G</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®¹å™¨åŒ–ä»£ç ä¸Šçº¿å‘ï¼š</span></span><br><span class="line">1.gitlabå¦‚ä½•ä½¿ç”¨é22ç«¯å£æ‹‰ä»£ç </span><br><span class="line">2.jenkinså®¹å™¨å¦‚ä½•ä½¿ç”¨dockerå‘½ä»¤</span><br><span class="line">3.jenkinsçš„å¯†é’¥ä¸Šä¼ åˆ°gitlab</span><br><span class="line">4.jenkinså¦‚ä½•ç™»å½• harbor</span><br><span class="line"></span><br><span class="line">å¼€å‘æŠŠä»£ç æäº¤åˆ°gitlabï¼Œjekinså»æ‹‰å–ä»£ç åˆ°å®¹å™¨é‡Œé¢</span><br></pre></td></tr></table></figure><p>å®¹å™¨åŒ–ä»£ç ä¸Šçº¿æµç¨‹å›¾</p><p><img src="../image/study_img/image-20240905093733661.png" alt="image-20240905093733661"></p><p>1ã€å»å®˜ç½‘æŸ¥æ‰¾è¿è¡Œå®¹å™¨çš„ä»£ç   <a href="https://about.gitlab.com/">https://about.gitlab.com/</a></p><p><img src="../image/study_img/image-20240907130711368.png" alt="image-20240907130711368"></p><p>å¾€ä¸‹æ»‘ æ‰¾åˆ°å®¹å™¨å®‰è£…</p><p><img src="../image/study_img/image-20240907130745739.png" alt="image-20240907130745739"></p><p><img src="../image/study_img/image-20240907131037286.png" alt="image-20240907131037286"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–é•œåƒ   Git-ce æ˜¯ç¤¾åŒºç‰ˆï¼Œgitlab-eeæ˜¯ä¼ä¸šç‰ˆï¼Œæ”¶è´¹çš„ã€‚</span><br><span class="line">[root@docker02 ~]# docker pull gitlab/gitlab-ce:latest</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œé•œåƒ</span><br><span class="line">docker run \</span><br><span class="line">--hostname 10.0.0.102 \</span><br><span class="line">--<span class="built_in">env</span> GITLAB_OMNIBUS_CONFIG=<span class="string">&quot;external_url &#x27;http://10.0.0.102&#x27;&quot;</span> \</span><br><span class="line">-p 443:443 -p 80:80 -p 2222:22 \</span><br><span class="line">--name gitlab \</span><br><span class="line">--restart always \</span><br><span class="line">-v /data/gitlab/config:/etc/gitlab \</span><br><span class="line">-v /data/gitlab/logs:/var/log/gitlab \</span><br><span class="line">-v /data/gitlab/data:/var/opt/gitlab \</span><br><span class="line">-d gitlab/gitlab-ce</span><br><span class="line"></span><br><span class="line">-p 2222:22  å®¿ä¸»æœºçš„22ç«¯å£è¢«å ç”¨äº†ï¼Œæ‰€æœ‰ä½¿ç”¨å®¿ä¸»æœºçš„2222ç«¯å£</span><br><span class="line">--detach=-d</span><br><span class="line"></span><br><span class="line">3ã€è¿è¡Œä¹‹åï¼Œæ‰§è¡Œ</span><br><span class="line">[root@docker02 ~]# docker ps</span><br><span class="line">å¯èƒ½ä¸€å¼€å§‹çœ‹ä¸åˆ°è¿è¡Œç»“æœï¼Œå› ä¸ºé•œåƒæ¯”è¾ƒå¤§ï¼Œè¿è¡Œèµ·æ¥æ¯”è¾ƒæ…¢ï¼Œåé¢è¿˜è¦åšä¼˜åŒ–ï¼Œå…ˆè¿›å…¥å®¹å™¨é‡Œé¢ï¼ŒæŸ¥çœ‹å¯åŠ¨çŠ¶æ€</span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it gitlab /bin/bash</span><br><span class="line">root@10:/# gitlab-ctl status</span><br><span class="line">run: alertmanager: (pid 1281) 314s; run: <span class="built_in">log</span>: (pid 1008) 429s</span><br><span class="line">run: gitaly: (pid 1231) 318s; run: <span class="built_in">log</span>: (pid 559) 642s</span><br><span class="line">run: gitlab-exporter: (pid 1219) 319s; run: <span class="built_in">log</span>: (pid 939) 448s</span><br><span class="line">run: gitlab-kas: (pid 751) 626s; run: <span class="built_in">log</span>: (pid 768) 623s</span><br><span class="line">run: gitlab-workhorse: (pid 1155) 321s; run: <span class="built_in">log</span>: (pid 885) 461s</span><br><span class="line">run: logrotate: (pid 502) 655s; run: <span class="built_in">log</span>: (pid 514) 653s</span><br><span class="line">run: nginx: (pid 1169) 320s; run: <span class="built_in">log</span>: (pid 917) 455s</span><br><span class="line">run: postgres-exporter: (pid 1289) 314s; run: <span class="built_in">log</span>: (pid 1032) 420s</span><br><span class="line">run: postgresql: (pid 583) 632s; run: <span class="built_in">log</span>: (pid 594) 631s</span><br><span class="line">run: prometheus: (pid 1238) 318s; run: <span class="built_in">log</span>: (pid 984) 437s</span><br><span class="line">run: puma: (pid 835) 474s; run: <span class="built_in">log</span>: (pid 842) 473s</span><br><span class="line">run: redis: (pid 519) 649s; run: <span class="built_in">log</span>: (pid 532) 647s</span><br><span class="line">run: redis-exporter: (pid 1221) 319s; run: <span class="built_in">log</span>: (pid 968) 441s</span><br><span class="line">run: sidekiq: (pid 852) 468s; run: <span class="built_in">log</span>: (pid 860) 467s</span><br><span class="line">run: sshd: (pid 37) 676s; run: <span class="built_in">log</span>: (pid 36) 676s</span><br><span class="line"></span><br><span class="line">4ã€çœ‹åˆ°nginxæœåŠ¡èµ·æ¥äº†ï¼Œå°±å¯ä»¥è®¿é—®ç½‘é¡µ</span><br><span class="line">10.0.0.102</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907152247060.png" alt="image-20240907152247060"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç™»å½•çš„ç”¨æˆ·åæ˜¯root</span><br><span class="line"></span><br><span class="line">5ã€æŸ¥çœ‹gitlabçš„åˆå§‹å¯†ç </span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it gitlab grep <span class="string">&#x27;Password:&#x27;</span> /etc/gitlab/initial_root_password</span><br><span class="line">Password: dUs0tOCn+nDOkWoShlwCvYYWlnIZUwaiBujL9BkO2TU=</span><br></pre></td></tr></table></figure><p>6ã€åˆ›å»ºä¸€ä¸ªé¡¹ç›®</p><p><img src="../image/study_img/image-20240907153032437.png" alt="image-20240907153032437"></p><p><img src="../image/study_img/image-20240907153123588.png" alt="image-20240907153123588"></p><p><img src="../image/study_img/image-20240907155134996.png" alt="image-20240907155134996"></p><p>7ã€æ‹‰å–ä»£ç ï¼šç›®å‰é¡¹ç›®åˆ›å»ºå®Œæˆåï¼Œä½¿ç”¨å…¶ä»–æœºå™¨æ‹‰å–ä»£ç ï¼Œæ— æ³•æ‹‰å–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–ä»£ç çš„æœºå™¨éœ€è¦å®‰è£…git</span><br><span class="line">[root@docker01 ~]# yum -y install git</span><br><span class="line"></span><br><span class="line">2ã€ç”Ÿæˆå¯†é’¥å¯¹ï¼Œé…ç½®åˆ°gitlabä»“åº“</span><br><span class="line">[root@docker01 ~]# ssh-keygen</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cat</span> ~/.ssh/id_rsa.pub </span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDQrHuOoZahkYpkUthbzbVLMH3ijST4TSPGuKWm77QBIredxGGKpoq2TN71pysOPUiGUKpBQnttyfo5AOealp0knNFuxqiShcRa8IlJQMX6mJfVFrY6jI5g/AnDvIayurVVBsf6T7h6sQNV8Pj4bzGpO8PXi8Z8GGslZ2LbmqA+LsfLLX/KR3BJce4JC/0PsK4DqAVO/WVYd7H0qeSUK5arrnpt7ncYVx02k63KI47Tb4W+nyqhlChwxD55V3ArzbvVpQy3BnRoOQQ5cr7le6HP+kl27jHTxCNJ7bf5uU1O4Polc3ODBkq2gZC9JaN6O8RuyB2UeCe5odVYOmxb5IKJ root@docker01</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907154118623.png" alt="image-20240907154118623"></p><p><img src="../image/study_img/image-20240907154153334.png" alt="image-20240907154153334"></p><p><img src="../image/study_img/image-20240907154228630.png" alt="image-20240907154228630"></p><p>ä¿®æ”¹ä¸ºä¸­æ–‡å­—ä½“ï¼Œå†åˆ·æ–°</p><p><img src="../image/study_img/image-20240907154846257.png" alt="image-20240907154846257"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä½¿ç”¨è¿™ä¸ªå‘½ä»¤æ‹‰å–ä»£ç æ—¶ï¼Œè¿˜éœ€è¦è¾“å…¥å¯†ç ï¼Œæ‰€ä»¥é…ç½®çš„sshå¯†é’¥å¯¹åˆ°gitlabæ—¶æ˜¯ä¸å¤ªè¡Œçš„</span><br><span class="line">[root@docker01 ~]# git <span class="built_in">clone</span> git@10.0.0.102:root/web.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#gitlabä½¿ç”¨é22ç«¯å£æ‹‰ä»£ç </span><br><span class="line">[root@docker01 ~]# git <span class="built_in">clone</span> ssh://git@10.0.0.102:2222/root/web.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€ç”±äºæ¯æ¬¡æ‹‰å–ä»£ç éƒ½è¦è¾“å…¥åè®®å’Œç«¯å£ï¼Œæ•ˆç‡ä¸é«˜ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶è®¾ç½®è‡ªåŠ¨å‡ºç°åè®®å’Œç«¯å£ï¼Œç›´æ¥å¤åˆ¶</span><br><span class="line"><span class="comment">#ä¿®æ”¹é…ç½®æ–‡ä»¶å’Œåšgitlabçš„ä¼˜åŒ–</span></span><br><span class="line">ç”±äºé…ç½®æ–‡ä»¶å·²ç»æ˜ å°„å‡ºæ¥äº†ï¼Œç›´æ¥ä¿®æ”¹</span><br><span class="line">[root@docker02 ~]# vim /data/gitlab/config/gitlab.rb</span><br><span class="line"><span class="comment">#32è¡Œï¼šurlçš„é…ç½®</span></span><br><span class="line">external_url <span class="string">&#x27;http://10.0.0.102&#x27;</span>  </span><br><span class="line"><span class="comment"># 698è¡Œï¼šç«¯å£çš„é…ç½®</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 2222 </span><br><span class="line"><span class="comment">###ä¼˜åŒ–å†…å®¹  æŠŠè¿™å‡ è¡ŒåŠ å…¥é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">#å‘Šè­¦å…³é—­</span></span><br><span class="line">alertmanager[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"><span class="comment">#å…³é—­å‰ç«¯çš„nodeåŠŸèƒ½</span></span><br><span class="line">node_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"><span class="comment">#å…³é—­redisåŠŸèƒ½</span></span><br><span class="line">redis_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"><span class="comment">#å…³é—­postgreåŠŸèƒ½</span></span><br><span class="line">postgres_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€é‡æ–°åŠ è½½gitlabé…ç½®æ–‡ä»¶ï¼Œéœ€è¦ç­‰å¾…3åˆ†é’Ÿå·¦å³</span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it gitlab gitlab-ctl reconfigure</span><br><span class="line">reconfigureç›¸å½“äºnginxçš„reloadï¼Œè¿˜æ˜¯å¯ä»¥æ­£å¸¸è®¿é—®ç½‘é¡µçš„</span><br><span class="line"></span><br><span class="line">5ã€å†æ¬¡è®¿é—®ç½‘é¡µï¼Œåˆ·æ–°é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°æä¾›çš„åœ°å€æ˜¯ç›´æ¥å¯ä»¥ä½¿ç”¨çš„åœ°å€</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907162925699.png" alt="image-20240907162925699"></p><h3 id="2ã€å®¹å™¨åŒ–jenkins"><strong>2ã€å®¹å™¨åŒ–jenkins</strong></h3><p>è®¿é—®å®˜ç½‘ï¼Œæ‰¾åˆ°å¯åŠ¨å®¹å™¨çš„å‘½ä»¤ï¼š<a href="https://www.jenkins.io/">https://www.jenkins.io/</a></p><p><img src="../image/study_img/image-20240907163455778.png" alt="image-20240907163455778"></p><p><img src="../image/study_img/image-20240907163613722.png" alt="image-20240907163613722"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">--name jenkins-docker \</span><br><span class="line">--<span class="built_in">rm</span> \</span><br><span class="line">--detach \</span><br><span class="line">--privileged \</span><br><span class="line">--network jenkins \    <span class="comment">#ç½‘ç»œæ²¡æœ‰é…ç½®ï¼Œéœ€è¦åˆ é™¤</span></span><br><span class="line">--network-alias docker \ <span class="comment">#ç½‘ç»œæ²¡æœ‰é…ç½®ï¼Œéœ€è¦åˆ é™¤</span></span><br><span class="line">--<span class="built_in">env</span> DOCKER_TLS_CERTDIR=/certs \  <span class="comment">#æ²¡æœ‰è¯ä¹¦ï¼Œéœ€è¦åˆ é™¤</span></span><br><span class="line">--volume jenkins-docker-certs:/certs/client \ <span class="comment">#æ²¡æœ‰è¯ä¹¦ï¼Œéœ€è¦åˆ é™¤</span></span><br><span class="line">--volume jenkins-data:/var/jenkins_home \  <span class="comment">#æ˜ å°„çš„jenkinsç›®å½•</span></span><br><span class="line">--publish 2376:2376 \</span><br><span class="line">docker:dind \</span><br><span class="line">--storage-driver overlay2</span><br></pre></td></tr></table></figure><p>åˆ°dockerå®˜ç½‘ï¼Œæ‰¾åˆ°jenkinsé•œåƒ  <a href="https://hub.docker.com/">https://hub.docker.com/</a></p><p><img src="../image/study_img/image-20240907164947184.png" alt="image-20240907164947184"></p><p><img src="../image/study_img/image-20240907165448303.png" alt="image-20240907165448303"></p><p><img src="../image/study_img/image-20240907165642490.png" alt="image-20240907165642490"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–2.422ç‰ˆæœ¬çš„é•œåƒ</span><br><span class="line">[root@docker02 ~]# docker pull jenkins/jenkins:2.422</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œjenkinså®¹å™¨</span><br><span class="line">docker run \</span><br><span class="line">--name jenkins \</span><br><span class="line">--privileged \</span><br><span class="line">--user=root \</span><br><span class="line">--restart=always \</span><br><span class="line">-v /data/jenkins/:/var/jenkins_home \</span><br><span class="line">-v /usr/bin/docker:/usr/bin/docker \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">-v /root/.ssh/:/root/.ssh/ \</span><br><span class="line">-v /root/.docker/config.json:/root/.docker/config.json \</span><br><span class="line">-p 8080:8080 \</span><br><span class="line">-p 5000:5000 \</span><br><span class="line">-d jenkins/jenkins:2.422</span><br><span class="line"></span><br><span class="line">--<span class="built_in">rm</span>ï¼šåªè¦å®¹å™¨åœæ­¢å°±ä¼šåˆ æ‰</span><br><span class="line">--user=rootï¼šjenkinséœ€è¦rootç”¨æˆ·å»å¯åŠ¨ï¼Œä¸ç„¶è¿è¡Œä¹‹ådocker <span class="built_in">log</span> -f jenkinsæŸ¥çœ‹æ—¥å¿—éƒ½ä¼šæ²¡æœ‰æƒé™</span><br><span class="line">--privilegedï¼šç›¸å½“äºzabbixéœ€è¦ç›‘æ§å®¿ä¸»æœºï¼Œæƒ³è¦æœ‰æƒé™å°±éœ€è¦è¿™ä¸ªå‚æ•°ï¼Œè¿˜å¯ä»¥è®©å®¹å™¨æœ‰æƒé™èƒ½ä½¿ç”¨å®¿ä¸»æœºä¸Šçš„dockerå‘½ä»¤</span><br><span class="line">dockerå®¹å™¨æƒ³è¦ä½¿ç”¨å®¿ä¸»æœºçš„å‘½ä»¤å°±æ˜¯docker <span class="keyword">in</span> docker</span><br><span class="line">-v /usr/bin/dockerï¼šå°†å®¿ä¸»æœºçš„dockerå‘½ä»¤æ˜ å°„ï¼Œå®¹å™¨é‡Œé¢å°±å¯ä»¥æ‰§è¡Œdocker ps..</span><br><span class="line">-v /var/run/docker.sockï¼šdockerçš„å‘½ä»¤é€šè¿‡socktè¿æ¥çš„ï¼Œéœ€è¦æ˜ å°„sockæ–‡ä»¶ï¼Œç”±äºå®¹å™¨é‡Œé¢æ²¡æœ‰sockæ–‡ä»¶ï¼Œä¸ç„¶æ‰§è¡Œdockerå‘½ä»¤ä¼šæŠ¥é”™</span><br><span class="line"><span class="comment">#è§£å†³jenkinsç”Ÿæˆå¯†é’¥åˆ°gitlab,å¦‚æœåœ¨å®¹å™¨é‡Œé¢ç”Ÿæˆå¯†é’¥å¯¹ï¼Œä¸‡ä¸€jenkinså®•æœºäº†ï¼Œåœ¨é‡æ–°ç”Ÿæˆå¯†é’¥å¯¹ï¼Œä¹‹å‰æ”¾åˆ°gitlabé‡Œé¢çš„å¯†é’¥å¯¹å°±ä¸èƒ½ä½¿ç”¨äº†ï¼Œä¸ºäº†å¯†é’¥å¯¹æŒä¹…åŒ–ï¼Œéœ€è¦åœ¨å®¿ä¸»æœºä¸Šç”Ÿæˆå¯†é’¥å¯¹ï¼Œæ˜ å°„åˆ°å®¹å™¨</span></span><br><span class="line">[root@docker02 ~]# ssh-keygen</span><br><span class="line">-v /root/.sshï¼šå°†å®¿ä¸»æœºçš„å¯†é’¥å¯¹æ˜ å°„åˆ°å®¹å™¨</span><br><span class="line">-v /root/.docker/config.jsonï¼šå°†ç™»å½•harborçš„è®¤è¯ä¿¡æ¯æ˜ å°„ï¼Œå®¹å™¨å°±å¯ä»¥æ¨é€é•œåƒåˆ°harbor</span><br><span class="line"></span><br><span class="line">3ã€ä¸Šä¼ æ’ä»¶</span><br><span class="line"></span><br><span class="line">4ã€è§£å‹æ’ä»¶</span><br><span class="line">[root@docker02 ~]# tar xf jenkins_plugins_2.422.tgz -C /data/jenkins/</span><br><span class="line"></span><br><span class="line">5ã€å†é‡æ–°å¯åŠ¨jenkins</span><br><span class="line">[root@docker02 ~]# docker restart jenkins</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6ã€æµè§ˆå™¨è®¿é—®ç½‘é¡µ</span><br><span class="line">10.0.0.102:8080</span><br><span class="line"></span><br><span class="line">7ã€æŸ¥çœ‹å¯†ç </span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it jenkins <span class="built_in">cat</span> /var/jenkins_home/secrets/initialAdminPassword</span><br><span class="line">3766efc193fe418f9256897f39840929</span><br><span class="line"></span><br><span class="line">ç”±äº/var/jenkins_homeç›®å½•å·²ç»æ˜ å°„å‡ºæ¥åœ¨å®¿ä¸»æœºä¸Šå·²ç»æŒä¹…åŒ–äº†ï¼Œè¿˜å¯ä»¥è¿™æ ·æŸ¥çœ‹å¯†ç æ–‡ä»¶</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> /data/jenkins/secrets/initialAdminPassword </span><br><span class="line">3766efc193fe418f9256897f39840929</span><br><span class="line"></span><br><span class="line">ç„¶åå‡ºç°å®‰è£…jenkinsæ’ä»¶çš„é¡µé¢ä¹‹é—´ï¼Œä¸è¦å®‰è£…æ’ä»¶ï¼Œç›´æ¥ç‚¹å‡»å³ä¸Šè§’çš„Ã—â€”â€”&gt;ç‚¹å‡»å¼€å§‹ä½¿ç”¨jenkins</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907175615967.png" alt="image-20240907175615967"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">8ã€å°†æ­å»ºäº†jenkinsæœåŠ¡å™¨çš„å…¬é’¥æ”¾åˆ°gitlabæœåŠ¡å™¨</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> .ssh/id_rsa.pub </span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDPOMkDhGerkcJCwv55/6B4vTtzY0gxDKDYibzGUHX18AKgN8eZUBQVyub/mLmhBYlPWBIlb8x1xzNqH6N+kt/aIp03KheYAJBk26Npc8vtVEh009kf9DU3q4QopDrbKOmaF21/0LZ+ZVsAT0AmPKVH8pWodOv9O8aoXoVZe+uxAD+nItopJ6bnDzalKLEeVadtGZqm4k+AZRY2W7bZFUlss6WEKB2DLWfnf4FkIkDBQqLTPOS8ovB4U9gEBqN0vRFGI9qa1dDE4I9bK3ISKWBLR1yzV5wA4ARszXuj4t/nEP71qWfdi3vi9xdYvWStGdWa487nIFgi7s96ix9g8QBD root@docker02</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907182329531.png" alt="image-20240907182329531"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">9ã€jenkinsæœºå™¨æ‹‰å–gitlabé‡Œé¢çš„ä»£ç </span><br><span class="line">è¿›å…¥jenkinså®¹å™¨</span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it jenkins /bin/bash</span><br><span class="line"></span><br><span class="line">10ã€æ‹‰å–ä»£ç </span><br><span class="line">root@126b61b9d225:/# git <span class="built_in">clone</span> ssh://git@10.0.0.102:2222/root/web.git</span><br><span class="line">è¾“å…¥<span class="built_in">yes</span>ï¼Œä¸éœ€è¦è¾“å…¥å¯†ç ï¼Œç›´æ¥å…å¯†æ‹‰å–ä»£ç </span><br></pre></td></tr></table></figure><h3 id="3ã€æµ‹è¯•å°†jenkinsé‡Œé¢çš„é•œåƒæ¨é€åˆ°Harborå›¾å½¢åŒ–é•œåƒä»“åº“"><strong>3ã€æµ‹è¯•å°†jenkinsé‡Œé¢çš„é•œåƒæ¨é€åˆ°Harborå›¾å½¢åŒ–é•œåƒä»“åº“</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">1ã€è¿›å…¥jenkinså®¹å™¨</span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it jenkins /bin/bash</span><br><span class="line">root@126b61b9d225:/# docker images</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€å°†é•œåƒæ”¹å</span><br><span class="line">root@126b61b9d225:/# docker tag wordpress:v7 172.16.1.76/wordpress/wordpress-jenkins-harbor:v7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€æ¨é€é•œåƒ   æŠ¥é”™ï¼Œæ˜¯å› ä¸ºéœ€è¦ç™»å½•ï¼Œä½†æ˜¯æ¯æ¬¡é‡å¯éƒ½éœ€è¦ç™»å½•</span><br><span class="line">root@126b61b9d225:/# docker push 172.16.1.76/wordpress/wordpress-jenkins-harbor:v7</span><br><span class="line">unauthorized: unauthorized to access repository: wordpress/wordpress-jenkins-harbor, action: push: unauthorized to access repository: wordpress/wordpress-jenkins-harbor, action: push</span><br><span class="line"></span><br><span class="line">4ã€æ£€æŸ¥å®¿ä¸»æœºæ˜¯å¦èƒ½å¤Ÿæ¨é€</span><br><span class="line">[root@docker02 ~]# docker push 172.16.1.76/wordpress/wordpress-jenkins-harbor:v7</span><br><span class="line">unauthorized: unauthorized to access repository: wordpress/wordpress-jenkins-harbor, action: push: unauthorized to access repository: wordpress/wordpress-jenkins-harbor, action: push</span><br><span class="line"></span><br><span class="line">5ã€å®¿ä¸»æœºä¸èƒ½æ¨é€ï¼Œéœ€è¦ç™»å½•harbor</span><br><span class="line">[root@docker01 ~]# docker login 172.16.1.76</span><br><span class="line">Username: admin</span><br><span class="line">Password:  <span class="comment">#å¯†ç ï¼šHarbor12345</span></span><br><span class="line">......</span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">6ã€å®¿ä¸»æœºæ­£å¸¸æ¨é€  æ¨é€æˆåŠŸ</span><br><span class="line">[root@docker02 ~]# docker push 172.16.1.76/wordpress/wordpress-jenkins-harbor:v7</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907210452739.png" alt="image-20240907210452739"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">7ã€å®¿ä¸»æœºèƒ½å¤Ÿæ¨é€é•œåƒï¼Œä½†æ˜¯å®¹å™¨ä¸ä¸€å®šèƒ½æ¨ï¼Œå› ä¸ºå®¹å™¨ä¹Ÿæ˜¯éœ€è¦loginç™»å½•çš„ï¼Œä½†æ˜¯è¿™é‡Œä¸éœ€è¦å®¹å™¨ç™»å½•</span><br><span class="line">å®¿ä¸»æœºç™»å½•äº†ä¹‹åï¼Œä¼šæœ‰ä¸€ä¸ªè®¤è¯ä¿¡æ¯åšå‡ºä¸€ä¸ªæ–‡ä»¶ä¿å­˜åˆ°~/.docker/config.json</span><br><span class="line">[root@docker02 ~]# ll -a ~/.docker/config.json </span><br><span class="line">-rw------- 1 root root 139 Sep  7 21:02 /root/.docker/config.json</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> ~/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;auths&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;10.0.0.76&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;auth&quot;</span>: <span class="string">&quot;YWRtaW46SGFyYm9yMTIzNDU=&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;172.16.1.76&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;auth&quot;</span>: <span class="string">&quot;YWRtaW46SGFyYm9yMTIzNDU=&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">#æ‰€ä»¥ï¼Œæ˜¯éœ€è¦åœ¨å¯åŠ¨jenkinsçš„æ—¶å€™ï¼Œå°†è®¤è¯ä¿¡æ¯çš„æ–‡ä»¶æ˜ å°„ï¼Œè¿™æ ·jenkinså®¹å™¨å°±å¯ä»¥æ¨é€é•œåƒåˆ°Harborä»åº“ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™æˆ‘å·²ç»åŠ ä¸Šè¿™ä¸ªæ–‡ä»¶æ˜ å°„äº†çš„ï¼Œåªè¦æˆ‘çš„å®¿ä¸»æœºç™»å½•è¿‡ï¼Œæˆ‘çš„jenkinså®¹å™¨å¯ä»¥æ¨é€</span></span><br></pre></td></tr></table></figure><h3 id="4ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”è‡ªç”±é£æ ¼"><strong>4ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”è‡ªç”±é£æ ¼</strong></h3><p>1ã€æµ‹è¯•æ„å»º</p><p><img src="../image/study_img/image-20240907230455222.png" alt="image-20240907230455222"></p><p><img src="../image/study_img/image-20240907234349843.png" alt="image-20240907234349843"></p><p>å¤åˆ¶ä»£ç åœ°å€</p><p><img src="../image/study_img/image-20240907234446792.png" alt="image-20240907234446792"></p><p><img src="../image/study_img/image-20240907234558247.png" alt="image-20240907234558247"></p><p><img src="../image/study_img/image-20240908000318150.png" alt="image-20240908000318150"></p><p>æ‰§è¡Œæ„å»ºï¼Œæ„å»ºæˆåŠŸ</p><p><img src="../image/study_img/image-20240908000821406.png" alt="image-20240908000821406"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1ã€#æ‹‰å–åä»£ç å­˜æ”¾çš„ç›®å½•</span><br><span class="line">[root@docker02 ~]# ll /data/jenkins/workspace/web-frestlye/</span><br><span class="line">-rw-r--r-- 1 root root    7 Sep  8 00:06 index.html</span><br><span class="line">-rw-r--r-- 1 root root 6141 Sep  8 00:06 README.md</span><br><span class="line"></span><br><span class="line">2ã€#å…å¯†webæœåŠ¡å™¨</span><br><span class="line">[root@docker02 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.101</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;WORKSPACE&#125;</span></span><br><span class="line">/var/jenkins_home/workspace/web-frestlye</span><br></pre></td></tr></table></figure><p>2ã€å†™è„šæœ¬æ„å»º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">harbor_ip=172.16.1.76</span><br><span class="line">web_ip=172.16.1.101</span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$&#123;WORKSPACE&#125;</span>/Dockerfile &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">FROM nginx:alpine</span></span><br><span class="line"><span class="string">#å°†ç½‘é¡µä»£ç å¤åˆ¶åˆ°nginxçš„ç«™ç‚¹ç›®å½•ä¸‹</span></span><br><span class="line"><span class="string">COPY index.html /usr/share/nginx/html/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">#è¿›å…¥å·¥ä½œç›®å½•æ„å»ºé•œåƒ</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;WORKSPACE&#125;</span> &amp;&amp; \</span><br><span class="line">docker build -t <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:v1 .</span><br><span class="line"><span class="comment">#æ‰“å®Œé•œåƒåæ¨é€åˆ°Harborä»“åº“</span></span><br><span class="line">docker push <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:v1</span><br><span class="line"><span class="comment">#è¿æ¥åˆ°webæœåŠ¡å™¨æŠŠé•œåƒä»harboræ‹‰ä¸‹æ¥,æ³¨æ„jenkinsæœºå™¨è¦å’Œwebå…å¯†</span></span><br><span class="line">ssh root@<span class="variable">$&#123;web_ip&#125;</span> <span class="string">&quot;docker pull <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:v1&quot;</span></span><br><span class="line"><span class="comment">#åˆ é™¤ä¹‹å‰æ—§çš„webé•œåƒ</span></span><br><span class="line">ssh root@<span class="variable">$&#123;web_ip&#125;</span> <span class="string">&quot;docker rm -f web&quot;</span></span><br><span class="line"><span class="comment">#åœ¨webæœåŠ¡å™¨éƒ¨ç½²nginxç½‘é¡µä»£ç </span></span><br><span class="line">ssh root@<span class="variable">$&#123;web_ip&#125;</span> <span class="string">&quot;docker run --name web -p 80:80 -d <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:v1&quot;</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240908230050715.png" alt="image-20240908230050715"></p><p><img src="../image/study_img/image-20240908230246558.png" alt="image-20240908230246558"></p><h3 id="5ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”å‚æ•°åŒ–æ„å»º"><strong>5ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”å‚æ•°åŒ–æ„å»º</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¬¬ä¸€ç‰ˆ</span><br><span class="line">[root@docker02 ~]# <span class="built_in">mkdir</span> /web</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cd</span> /web</span><br><span class="line">[root@docker02 web]# git init /web</span><br><span class="line">[root@docker02 web]# vim index.html</span><br><span class="line">[root@docker02 web]# vim src.js</span><br><span class="line">[root@docker02 web]# git add .</span><br><span class="line">[root@docker02 web]#  git config --global user.email <span class="string">&quot;you@example.com&quot;</span></span><br><span class="line">[root@docker02 web]# git config --global user.name <span class="string">&quot;Your Name&quot;</span></span><br><span class="line">[root@docker02 web]# git commit -m <span class="string">&#x27;å®˜ç½‘v1.0&#x27;</span></span><br><span class="line">[root@docker02 web]#  git tag -a <span class="string">&#x27;v1&#x27;</span>  -m <span class="string">&quot;å®˜ç½‘v1.0&quot;</span></span><br><span class="line">[root@docker02 web]# git remote add origin ssh://git@10.0.0.102:2222/root/web-website.git</span><br><span class="line">[root@docker02 web]# git push --all</span><br><span class="line">[root@docker02 web]# git push --tag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ç¬¬äºŒç‰ˆ</span><br><span class="line">[root@docker02 web]# vim src.js</span><br><span class="line">[root@docker02 web]# git add .</span><br><span class="line">[root@docker02 web]# git commit -m <span class="string">&#x27;å®˜ç½‘v2.0&#x27;</span></span><br><span class="line">[root@docker02 web]# git tag -a <span class="string">&#x27;v2&#x27;</span>  -m <span class="string">&quot;å®˜ç½‘v2.0&quot;</span></span><br><span class="line">[root@docker02 web]# git push --all</span><br><span class="line">[root@docker02 web]# git push --tag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ä»£ç ä¸éœ€è¦è½¯è¿æ¥äº†ã€‚å·²ç»å®¹å™¨éƒ¨ç½²äº†ï¼Œä»£ç å¯ä»¥éšä¾¿åˆ é™¤</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240909172701792.png" alt="image-20240909172701792"></p><p><img src="../image/study_img/image-20240909224852871.png" alt="image-20240909224852871"></p><p><img src="../image/study_img/image-20240909224914742.png" alt="image-20240909224914742"></p><p><img src="../image/study_img/image-20240909224936189.png" alt="image-20240909224936189"></p><p><img src="../image/study_img/image-20240909225006620.png" alt="image-20240909225006620"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">harbor_ip=172.16.1.76</span><br><span class="line">project_name=<span class="string">&#x27;wordpress&#x27;</span></span><br><span class="line">pkg_name=<span class="string">&#x27;$&#123;harbor_ip&#125;/$&#123;project_name&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$&#123;WORKSPACE&#125;</span>/Dockerfile &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">FROM nginx:alpine</span></span><br><span class="line"><span class="string">#å°†ç½‘é¡µä»£ç å¤åˆ¶åˆ°nginxçš„ç«™ç‚¹ç›®å½•ä¸‹</span></span><br><span class="line"><span class="string">COPY ./* /usr/share/nginx/html/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿›å…¥å·¥ä½œç›®å½•æ„å»ºé•œåƒ</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;WORKSPACE&#125;</span> &amp;&amp; \</span><br><span class="line">docker build -t <span class="variable">$&#123;pkg_name&#125;</span>/web-frestlye:<span class="variable">$&#123;git_tag&#125;</span> .</span><br><span class="line"><span class="comment">#æ‰“å®Œé•œåƒåæ¨é€åˆ°Harborä»“åº“</span></span><br><span class="line">docker push <span class="variable">$pkg_name</span>&#125;/web-frestlye:<span class="variable">$&#123;git_tag&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">deploy</span></span> () &#123;</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="variable">$@</span> ;<span class="keyword">do</span></span><br><span class="line"><span class="comment">#è¿æ¥åˆ°webæœåŠ¡å™¨æŠŠé•œåƒä»harboræ‹‰ä¸‹æ¥,æ³¨æ„jenkinsæœºå™¨è¦å’Œwebå…å¯†</span></span><br><span class="line">ssh root@172.16.1.<span class="variable">$&#123;n&#125;</span> <span class="string">&quot;docker pull <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:<span class="variable">$&#123;git_tag&#125;</span>&quot;</span></span><br><span class="line"><span class="comment">#åˆ é™¤ä¹‹å‰æ—§çš„webé•œåƒ</span></span><br><span class="line">ssh root@172.16.1.<span class="variable">$&#123;n&#125;</span> <span class="string">&quot;docker rm -f web&quot;</span></span><br><span class="line"><span class="comment">#åœ¨webæœåŠ¡å™¨éƒ¨ç½²nginxç½‘é¡µä»£ç </span></span><br><span class="line">ssh root@172.16.1.<span class="variable">$&#123;n&#125;</span> <span class="string">&quot;docker run --name web -p 80:80 -d <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:<span class="variable">$&#123;git_tag&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$env</span> <span class="keyword">in</span></span><br><span class="line">dev)</span><br><span class="line"><span class="comment">#ç»™å‡½æ•°ä¼ å‚æ•° ä¼ é€’æœºå™¨çš„ip</span></span><br><span class="line">   deploy 101</span><br><span class="line">   ;;</span><br><span class="line">prod)</span><br><span class="line">   deploy 103</span><br><span class="line">   ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240909225041225.png" alt="image-20240909225041225"></p><h3 id="6ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”MAVENé¡¹ç›®æ„å»º"><strong>6ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”MAVENé¡¹ç›®æ„å»º</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1ã€å“ªå°æœºå™¨éœ€è¦éƒ¨ç½²javaä»£ç ï¼Œåˆ°dockerå®˜ç½‘æ‹‰å–tomcat</span><br><span class="line">docker pull tomcat:alpine </span><br><span class="line">éœ€è¦å…ˆæ‰‹åŠ¨ç¼–è¯‘ä»£ç ï¼Œä¸‹è½½maven</span><br><span class="line">yum -y install maven</span><br><span class="line"></span><br><span class="line">2ã€ä¸‹è½½javaä»£ç helloword</span><br><span class="line"></span><br><span class="line">3ã€è¿è¡Œtmocat</span><br><span class="line">docker run -p 8080:8080 -d tomcat:alpine </span><br><span class="line"></span><br><span class="line">æ”¹Mavenæºã€‚æ¢æˆé˜¿é‡Œäº‘çš„æº</span><br><span class="line">vim</span><br><span class="line"></span><br><span class="line">æ„å»º  æ„å»ºå®Œæˆä¹‹åä¼šç”Ÿæˆä¸€ä¸ªtargetç›®å½•</span><br><span class="line">maven pakage</span><br><span class="line"><span class="built_in">cd</span> target/hellowrd</span><br><span class="line">tar zcf hello-1.0.0.tgz</span><br><span class="line"></span><br><span class="line">vim Dockerfile</span><br><span class="line">FROM tomcat:alpine </span><br><span class="line">RUN <span class="built_in">rm</span> -rf /usr/local/tomcat/webapps/ROOT/*</span><br><span class="line">ADD hello-1.0.0.tgz /usr/local/tomcat/webapps/ROOT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker build -t 172.16.1.76/wordpress/hello:v1 .</span><br><span class="line">docker run -p 8080:8080 -d 172.16.1.76/wordpress/hello:v1</span><br><span class="line"></span><br><span class="line">ç›®å‰è®¿é—®çš„æ—¶å€™è¦åŠ ä¸Šç›®å½•ï¼Œtomcatå‰é¢ä¼šåŠ ä¸Šnginxåšä»£ç†ï¼Œä»£ç†è¿™ä¸ªç›®å½•</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240909092954321.png" alt="image-20240909092954321"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#jenkinsæœºå™¨</span></span><br><span class="line">èµ·å®¿ä¸»æœºæŠŠmavenæ˜ å°„è¿›å»  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Jenkinsæ—¶åŒºä¸å¯¹ï¼Œå·®8ä¸ªå°æ—¶ï¼Œè§£å†³æ–¹æ¡ˆ</span><br><span class="line"><span class="comment"># è¿›å…¥å®¹å™¨</span></span><br><span class="line">docker <span class="built_in">exec</span> -it -u root jenkins bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹å®¹å™¨æ—¶åŒº</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">&#x27;Asia/Shanghai&#x27;</span> &gt; /etc/timezone</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¿®æ”¹åçš„å®¹å™¨æ—¶åŒº</span></span><br><span class="line"><span class="built_in">cat</span> /etc/timezone</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯jenkinså®¹å™¨</span></span><br><span class="line">docker restart jenkins</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¦‚æœè§‰å¾—Jenkinså ç”¨å†…å­˜è¿‡å¤§,æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸‹é¢çš„æ–¹å¼é™åˆ¶ienkinså ç”¨å†…å­˜å¤§å°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># dockeré™åˆ¶å†…å­˜å¤§å°</span></span><br><span class="line">docker update jenkins -m 3g --memory-swap -1</span><br><span class="line"></span><br><span class="line">--memory æˆ–-m é™åˆ¶å®¹å™¨çš„å†…å­˜ä½¿ç”¨é‡</span><br><span class="line">--memory-swap é™åˆ¶å†…å­˜å’Œswapçš„æ€»å’Œï¼Œä¸è®¾ç½®çš„è¯é»˜è®¤ä¸º--memoryçš„ä¸¤å€</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ä½¿ç”¨å®¹å™¨åŒ–çš„jenkinséƒ¨ç½²ä»£ç ï¼Œå¤šç§æ–¹æ³•ä»£ç ä¸Šçº¿</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>äº”ã€ğŸ¡Dockerçš„å›¾å½¢åŒ–Portainer</title>
    <link href="https://www.fomal.cc/posts/812941c2.html"/>
    <id>https://www.fomal.cc/posts/812941c2.html</id>
    <published>2024-09-22T05:20:28.000Z</published>
    <updated>2024-09-22T07:53:34.212Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Dockerçš„å›¾å½¢åŒ–Portainer">Dockerçš„å›¾å½¢åŒ–Portainer</h3><p>å¯åŠ¨Portainer     å¡æ³°äº†</p><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th></tr></thead><tbody><tr><td>elk1</td><td>10.0.0.76  /  172.16.1.76</td><td>å›¾å½¢åŒ–portainer</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@elk1 harbor]# docker run -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock --restart=always --name portainer portainer/portainer</span><br><span class="line"></span><br><span class="line">2ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">http://10.0.0.76:9000/</span><br><span class="line"></span><br><span class="line">3ã€ç™»å½•è¿›å»å¯èƒ½å›æç¤ºportainerè¶…æ—¶ï¼Œéœ€è¦é‡å¯</span><br><span class="line">[root@elk1 harbor]# docker restart  portainer</span><br><span class="line">portainer</span><br><span class="line"></span><br><span class="line">4ã€é‡å¯ä¹‹åå†è®¿é—®é¡µé¢ï¼Œè¿›å»åˆ·æ–°ï¼Œè®¾ç½®åˆå§‹å¯†ç  12ä½çš„</span><br><span class="line">aaaaaa111111</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240906175708573.png" alt="image-20240906175708573"></p><p>5ã€æŸ¥çœ‹æœ¬åœ°çš„docker</p><p><img src="../image/study_img/image-20240906175929805.png" alt="image-20240906175929805"></p><p><img src="../image/study_img/image-20240906180028688.png" alt="image-20240906180028688"></p><p>æ­¤å¤„å¯ä»¥å¯åŠ¨å®¹å™¨</p><p><img src="../image/study_img/image-20240906180212414.png" alt="image-20240906180212414"></p><p>6ã€æµ‹è¯•æ‹‰å–ä¸€ä¸ªé•œåƒå¹¶å¯åŠ¨</p><p><img src="../image/study_img/image-20240906180900453.png" alt="image-20240906180900453"></p><p><img src="../image/study_img/image-20240906180924462.png" alt="image-20240906180924462"></p><p>ç­‰å¾…ä¸€ä¼šï¼Œæ˜¾ç¤ºæ‹‰å–é•œåƒå¹¶å¯åŠ¨æˆåŠŸï¼Œè·³è½¬åˆ°å®¹å™¨å¯åŠ¨çš„é¡µé¢ï¼Œå¹¶ä¸”åœ¨å‘½ä»¤è¡Œä¸»å¯ä»¥æŸ¥çœ‹åˆ°å·²æ‹‰å–æˆåŠŸï¼Œå¯åŠ¨æˆåŠŸ</p><p><img src="../image/study_img/image-20240906181242551.png" alt="image-20240906181242551"></p><p><img src="../image/study_img/image-20240906181309969.png" alt="image-20240906181309969"></p><p>7ã€æŸ¥çœ‹æ‰€æœ‰é•œåƒ</p><p><img src="../image/study_img/image-20240906181607353.png" alt="image-20240906181607353"></p><p>8ã€æµ‹è¯•æ‹‰å–é•œåƒ</p><p><img src="../image/study_img/image-20240906181951743.png" alt="image-20240906181951743"></p><p>9ã€æŒ‚è½½ç›®å½•çš„é¡µé¢</p><p><img src="../image/study_img/image-20240906182154901.png" alt="image-20240906182154901"></p><p>10ã€äº‹ä»¶çš„æŸ¥çœ‹ï¼Œå“ªä¸ªå®¹å™¨é€€å‡ºäº†ï¼ŒæŸ¥çœ‹æ—¥å¿—</p><p><img src="../image/study_img/image-20240906182246878.png" alt="image-20240906182246878"></p><p>12ã€æŸ¥çœ‹ç‰©ç†æœºçš„ä¿¡æ¯</p><p><img src="../image/study_img/image-20240906182322538.png" alt="image-20240906182322538"></p><p>13ã€æ·»åŠ è‡ªå·±çš„é•œåƒä»“åº“ã€‚æ‹‰å–å®¹å™¨çš„æ—¶å€™å°±å»è‡ªå·±åˆ›å»ºçš„ä»“åº“é‡Œé¢æ‹‰å–</p><p><img src="../image/study_img/image-20240906182455490.png" alt="image-20240906182455490"></p><p><img src="../image/study_img/image-20240906182652673.png" alt="image-20240906182652673"></p><p>æ·»åŠ ä¹‹åï¼Œå¦‚æœæƒ³æ‹‰å–è‡ªå·±ä»“åº“é‡Œé¢çš„å®¹å™¨ï¼Œå°±è¿™æ ·é€‰æ‹©</p><p><img src="../image/study_img/image-20240906182823018.png" alt="image-20240906182823018"></p><p>æ‹‰å–harboré‡Œé¢çš„å®¹å™¨</p><p><img src="../image/study_img/image-20240906182929405.png" alt="image-20240906182929405"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#portaineréœ€è¦ä¿¡ä»»harborçš„åœ°å€</span></span><br><span class="line">[root@elk1 harbor]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>, <span class="string">&quot;https://hub.rat.dev/&quot;</span>, <span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>],</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.76&quot;</span>,<span class="string">&quot;http://172.16.1.101:5000&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@elk1 harbor]# systemctl restart docker</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240906183541971.png" alt="image-20240906183541971"></p><p>14ã€ç®¡ç†docker01 ~ 03æœºå™¨çš„é•œåƒ</p><p><img src="../image/study_img/image-20240906183926754.png" alt="image-20240906183926754"></p><p><img src="../image/study_img/image-20240906184008628.png" alt="image-20240906184008628"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åœ¨æƒ³è¦ç®¡ç†çš„dockeræœºå™¨æ‰§è¡Œè¿™ä¸ªå‘½ä»¤</span></span><br><span class="line">docker run -d \</span><br><span class="line">  -p 9001:9001 \</span><br><span class="line">  --name portainer_agent \</span><br><span class="line">  --restart=always \</span><br><span class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  -v /var/lib/docker/volumes:/var/lib/docker/volumes \</span><br><span class="line">  portainer/agent:2.16.2</span><br><span class="line">  </span><br><span class="line"><span class="comment">#é‡å¯docker</span></span><br><span class="line">  systemctl restart docker</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240906185043251.png" alt="image-20240906185043251"></p><p><img src="../image/study_img/image-20240906185302712.png" alt="image-20240906185302712"></p>]]></content>
    
    
    <summary type="html">éƒ¨ç½²Dockerçš„å›¾å½¢åŒ–Portainer</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>å››ã€ğŸ¡dockerçš„ç½‘ç»œä¸Harboré•œåƒä»“åº“</title>
    <link href="https://www.fomal.cc/posts/5c6d7d69.html"/>
    <id>https://www.fomal.cc/posts/5c6d7d69.html</id>
    <published>2024-09-22T05:07:23.000Z</published>
    <updated>2024-09-22T07:53:34.223Z</updated>
    
    <content type="html"><![CDATA[<h2 id="dockerçš„ç½‘ç»œä¸Harboré•œåƒä»“åº“">dockerçš„ç½‘ç»œä¸Harboré•œåƒä»“åº“</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">101ä¸Šèµ·çš„å®¹å™¨å’Œ103ä¸Šèµ·çš„å®¹å™¨ä¸èƒ½é€šä¿¡</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å®¹å™¨çš„ip</span></span><br><span class="line"><span class="comment">#101èµ·centos</span></span><br><span class="line">[root@docker01 ~]# docker run --<span class="built_in">link</span> mysql80 -it centos:7 /bin/bash</span><br><span class="line">[root@56db98b318bb /]# ping mysql80</span><br><span class="line">PING mysql80 (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from mysql80 (172.17.0.2): icmp_seq=1 ttl=64 time=0.271 ms</span><br><span class="line"></span><br><span class="line">mysql80å®¹å™¨çš„ipæ˜¯ï¼š172.17.0.2</span><br><span class="line"></span><br><span class="line"><span class="comment">#102èµ·centos</span></span><br><span class="line">[root@bdc4ac174cb6 /]# ping 172.17.0.2</span><br><span class="line">PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">å¯ä»¥å‘ç°æ˜¯pingä¸é€šçš„ï¼Œå¦‚æœå¼€å¯å†…æ ¸è½¬ï¼Œå°±å¯ä»¥é€šä¿¡ï¼ŒAè™šæ‹Ÿæœºé‡Œé¢èµ·çš„å®¹å™¨å°±ä¸Bè™šæ‹Ÿæœºå¯ä»¥é€šä¿¡</span><br></pre></td></tr></table></figure><h3 id="1ã€Bridgeæ¡¥æ¥æ¨¡å¼-docker-é»˜è®¤çš„ç½‘ç»œæ¨¡å¼"><strong>1ã€Bridgeæ¡¥æ¥æ¨¡å¼  (docker é»˜è®¤çš„ç½‘ç»œæ¨¡å¼)</strong></h3><p>Bridgeï¼šDockerè®¾è®¡çš„NATç½‘ç»œæ¨¡å‹ é»˜è®¤ç±»å‹ï¼Œç±»ä¼¼äºè™šæ‹Ÿæœºé‡Œé¢çš„NATæ¨¡å¼</p><p><img src="../image/study_img/image-20240905150011381.png" alt="image-20240905150011381"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">ä½ çš„å®¹å™¨æ¡¥æ¥åˆ°docker0é‚£ä¸ªç½‘å¡ï¼Œå®¹å™¨çš„ç½‘å¡å’Œdocker0é‚£ä¸ªç½‘å¡åœ¨åŒä¸€ç½‘æ®µ</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å½“å‰è™šæ‹Ÿæœºçš„ç½‘ç»œç±»å‹</span></span><br><span class="line">[root@docker02 ~]# docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">870935df49b1   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">a7fce1fe694d   host      host      <span class="built_in">local</span></span><br><span class="line">d7fe2c2b78e7   none      null      <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ¡¥æ¥æ¨¡å¼çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">[root@docker01 ~]# docker network inspect bridge</span><br><span class="line"></span><br><span class="line"><span class="comment">## å®‰è£…bridge-utils æŸ¥çœ‹</span></span><br><span class="line">[root@docker01 ~]# brctl show</span><br><span class="line">bridge name bridge <span class="built_in">id</span> STP enabled interfaces</span><br><span class="line">docker0 8000.0242eca7bc4c no</span><br><span class="line"></span><br><span class="line"><span class="comment">#è°ƒè¯•ç½‘ç»œä¸“ç”¨é•œåƒ</span></span><br><span class="line">[root@docker01 ~]# docker run -it -d  busybox  /bin/sh</span><br><span class="line"></span><br><span class="line">å…¬å¸æœ‰è§„å®š å†…ç½‘çš„ipè§„å®š192æˆ–è€…168çš„ç½‘æ®µ</span><br><span class="line"><span class="comment">#ä¿®æ”¹æ¡¥æ¥æ¨¡å¼çš„ç½‘æ®µ</span></span><br><span class="line">æ–¹æ³•1ï¼šä¿®æ”¹dockerçš„å¯åŠ¨è„šæœ¬</span><br><span class="line">[root@docker01 ~]# vim /lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line">--bip=192.168.10.1/24</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# systemctl daemon-reload</span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0 Link encap:Ethernet HWaddr 02:42:C0:A8:0A:03</span><br><span class="line">     inet addr:192.168.10.3 Bcast:192.168.10.255 Mask:255.255.255.0</span><br><span class="line">     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">     RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">     TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">     collisions:0 txqueuelen:0</span><br><span class="line">     RX bytes:656 (656.0 B) TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">[root@docker02 ~]# docker run -it busybox /bin/sh</span><br><span class="line"><span class="comment">#è¿™ä¸ªæ˜¯ä¸“é—¨çš„ç½‘ç»œå·¥å…·ï¼Œç½‘ç»œç›¸å…³çš„å‘½ä»¤éƒ½æ”¯æŒ</span></span><br><span class="line"></span><br><span class="line">æ–¹æ³•2ï¼šä¿®æ”¹dockerçš„é…ç½®æ–‡ä»¶</span><br><span class="line">[root@docker01 ~]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;bip&quot;</span>: <span class="string">&quot;192.168.30.1/24&quot;</span>,</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>,<span class="string">&quot;https://hub.rat.dev/&quot;</span>,</span><br><span class="line"><span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">## æˆ–è€…</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>,<span class="string">&quot;https://hub.rat.dev/&quot;</span>,</span><br><span class="line"><span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>],</span><br><span class="line"><span class="string">&quot;bip&quot;</span>: <span class="string">&quot;192.168.30.1/24&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# systemctl daemon-reload</span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line">[root@docker01 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0 Link encap:Ethernet HWaddr 02:42:C0:A8:14:03</span><br><span class="line">     inet addr:192.168.20.3 Bcast:192.168.20.255 Mask:255.255.255.0</span><br><span class="line">     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">     RX packets:6 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">     TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">     collisions:0 txqueuelen:0</span><br><span class="line">     RX bytes:516 (516.0 B) TX bytes:0 (0.0 B)</span><br><span class="line">     </span><br><span class="line">è¿™æ ·å­å°±å¯ä»¥å®šä¹‰å®¹å™¨çš„ç½‘æ®µäº†</span><br></pre></td></tr></table></figure><h3 id="2ã€Hostæ¨¡å¼">**2ã€Hostæ¨¡å¼   **</h3><p>hostï¼šä¸å®¿ä¸»æœºå…±äº«Network Namespaceï¼Œâ€“network=host æ€§èƒ½æœ€é«˜</p><p><img src="../image/study_img/image-20240905151204236.png" alt="image-20240905151204236"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# docker run --network=host -d nginx:alpine</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker run -it --network=host nginx:alpine /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">docker0 Link encap:Ethernet HWaddr 02:42:77:C6:BE:B9</span><br><span class="line">        inet addr:192.168.20.1 Bcast:192.168.20.255 Mask:255.255.255.0</span><br><span class="line">        inet6 addr: fe80::42:77ff:fec6:beb9/64 Scope:Link</span><br><span class="line">        UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">        RX packets:3150 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">        TX packets:2794 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">        collisions:0 txqueuelen:0</span><br><span class="line">        RX bytes:7792958 (7.4 MiB) TX bytes:1119887 (1.0 MiB)</span><br><span class="line"></span><br><span class="line">eth0    Link encap:Ethernet HWaddr 00:0C:29:1A:2F:80</span><br><span class="line">        inet addr:10.0.0.101 Bcast:10.0.0.255 Mask:255.255.255.0</span><br><span class="line">        inet6 addr: fe80::20c:29ff:fe1a:2f80/64 Scope:Link</span><br><span class="line"></span><br><span class="line">å’Œä¸»æœºå…±äº«ç½‘å¡çš„æ¨¡å¼ï¼Œä¸€èˆ¬èµ·å®¹å™¨ä¸ä¼šç”¨åˆ°è¿™ä¸ªæ¨¡å¼</span><br></pre></td></tr></table></figure><h3 id="3ã€containeræ¨¡å¼"><strong>3ã€containeræ¨¡å¼</strong></h3><p>Containerï¼šä¸å¦ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨å…±äº«Network Namespaceï¼Œâ€“net=container:containerIDï¼ˆK8Sï¼‰</p><p><img src="../image/study_img/image-20240905114345031.png" alt="image-20240905114345031"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0 Link encap:Ethernet HWaddr 02:42:C0:A8:14:03</span><br><span class="line">     inet addr:192.168.20.3 Bcast:192.168.20.255 Mask:255.255.255.0</span><br><span class="line">     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">     RX packets:6 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">     TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">     collisions:0 txqueuelen:0</span><br><span class="line">     RX bytes:516 (516.0 B) TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker run -it --network=container:763cd9e2da94 centos:7 /bin/bash</span><br><span class="line">[root@docker01 ~]# docker run -it --network=container:763cd9e2da94 nginx:alpine /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0 Link encap:Ethernet HWaddr 02:42:C0:A8:14:03</span><br><span class="line">     inet addr:192.168.20.3 Bcast:192.168.20.255 Mask:255.255.255.0</span><br><span class="line">     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">     RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">     TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">     collisions:0 txqueuelen:0</span><br><span class="line">     RX bytes:656 (656.0 B) TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure><h3 id="4ã€Noneæ¨¡å¼"><strong>4ã€Noneæ¨¡å¼</strong></h3><p>None:ä¸ä¸ºå®¢å™¨é…ç½®ä»»ä½•ç½‘ç»œåŠŸèƒ½ï¼Œâ€“net=none   æ²¡æœ‰ç½‘ç»œçš„æ¨¡å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å¯åŠ¨çš„æ—¶å€™æŒ‡å®š  </span><br><span class="line">[root@docker01 ~]# docker run -it --network=none busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">lo   Link encap:Local Loopback</span><br><span class="line">     inet addr:127.0.0.1 Mask:255.0.0.0</span><br><span class="line">     inet6 addr: ::1/128 Scope:Host</span><br><span class="line">     UP LOOPBACK RUNNING MTU:65536 Metric:1</span><br><span class="line">     RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">     TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">     collisions:0 txqueuelen:1000</span><br><span class="line">     RX bytes:0 (0.0 B) TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905113318250.png" alt="image-20240905113318250"></p><h3 id="5ã€Dockerè‡ªå®šä¹‰ç½‘ç»œæ¨¡å¼"><strong>5ã€Dockerè‡ªå®šä¹‰ç½‘ç»œæ¨¡å¼</strong></h3><p>åŸºäºä»¥ä¸Š4ç§æ¨¡å¼åˆ›å»ºç½‘ç»œ</p><p><img src="../image/study_img/image-20240905113509543.png" alt="image-20240905113509543"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è‡ªå®šä¹‰ç½‘ç»œ</span></span><br><span class="line">docker network create -d &lt;mode&gt; --subnet &lt;CIDR&gt; --gateway &lt;ç½‘å…³&gt; &lt;è‡ªå®šä¹‰ç½‘è·¯åç§°&gt;</span><br><span class="line">åˆ›å»º</span><br><span class="line">docker network create -d bridge --subnet 192.168.100.0/24 --gateway 192.168.100.1 abc-net</span><br><span class="line"></span><br><span class="line"><span class="comment">## å¼•ç”¨è‡ªå®šä¹‰ç½‘ç»œ</span></span><br><span class="line">[root@docker01 ~]# docker run -it --network=abc-net busybox /bin/sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å°±ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªäº¤æ¢æœº</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è‡ªå®šä¹‰ç½‘ç»œ</span></span><br><span class="line">[root@docker01 ~]# docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID NAME DRIVER SCOPE</span><br><span class="line">2b0a232f6643 bridge bridge <span class="built_in">local</span></span><br><span class="line">168f91213e19 host host <span class="built_in">local</span></span><br><span class="line">4de4c2edcb74 none null <span class="built_in">local</span></span><br><span class="line">7a7b8742e475 abc-net bridge <span class="built_in">local</span></span><br><span class="line">[root@docker01 ~]# docker network <span class="built_in">rm</span> abc-net</span><br><span class="line">abc-net</span><br><span class="line">[root@docker01 ~]# docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID NAME DRIVER SCOPE</span><br><span class="line">2b0a232f6643 bridge bridge <span class="built_in">local</span></span><br><span class="line">168f91213e19 host host <span class="built_in">local</span></span><br><span class="line">4de4c2edcb74 none null <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">åˆ›å»ºäº†ç½‘ç»œå°±åˆ›å»ºäº†ä¸€ä¸ªæ¡¥æ¥çš„ç½‘å¡ï¼Œç›¸å½“äºä¸€ä¸ªç½‘å¡å°±æ˜¯ä¸€ä¸ªäº¤æ¢æœº</span><br><span class="line">dockeré»˜è®¤å°±æ˜¯bridgeæ¨¡å¼ï¼Œå½“æœ‰ä¸åŒçš„Â·é¡¹ç›®å°±è¦è‡ªå·±åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼ŒæŠŠä¸åŒé¡¹ç›®çš„ä¸»æœºæ”¾åˆ°è¿™ä¸ªæ¨¡å¼é‡Œé¢</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905113639559.png" alt="image-20240905113639559"></p><h3 id="6ã€Dockerç§æœ‰åˆ›å»ºHarbor">6ã€<strong>Dockerç§æœ‰åˆ›å»ºHarbor</strong></h3><p>Harbor æ˜¯ä¸ºä¼ä¸šç”¨æˆ·è®¾è®¡çš„å®¹å™¨é•œåƒä»“åº“å¼€æºé¡¹ç›®ï¼ŒåŒ…æ‹¬äº†æƒé™ç®¡ç†(RBAC)ã€+DAPã€å®¡è®¡ã€å®‰å…¨æ¼æ´æ‰«æã€é•œåƒéªŒçœŸã€ç®¡ç†ç•Œé¢ã€è‡ªæˆ‘æ³¨å†Œã€HA ç­‰ä¼ä¸šå¿…éœ€çš„åŠŸèƒ½ï¼ŒåŒæ—¶é’ˆå¯¹ä¸­å›½ç”¨æˆ·çš„ç‰¹ç‚¹ï¼Œè®¾è®¡é•œåƒå¤åˆ¶å’Œä¸­æ–‡æ”¯æŒç­‰åŠŸèˆ±   <a href="https://goharbor.io/">https://goharbor.io/</a></p><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th></tr></thead><tbody><tr><td>elk1</td><td>10.0.0.76  /  172.16.1.76</td><td>Harborå›¾å½¢åŒ–ä»“åº“</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">harbor å›¾å½¢åŒ–ç•Œé¢çš„  https://goharbor.io/</span><br><span class="line">registry å‘½ä»¤è¡Œæ“ä½œçš„</span><br><span class="line"></span><br><span class="line">ä¸‹è½½harborå¸¦offlineæ ‡ç­¾çš„ï¼Œæ‰€æœ‰çš„é•œåƒï¼Œå®‰è£…åŒ…é‡Œé¢éƒ½åœ¨ä¸€èµ·çš„æ‰€ä»¥æ¯”è¾ƒå¤§</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€#å®‰è£…dockerç¯å¢ƒ</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">sed -i <span class="string">&quot;s@http://mirrors.aliyun.com@https://mirrors.huaweicloud.com@g&quot;</span> /etc/yum.repos.d/epel.repo</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/docker-ce.repo &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[docker-ce-stable]</span></span><br><span class="line"><span class="string">name=Docker CE Stable - $basearch</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.huaweicloud.com/docker-ce/linux/centos/7/x86_64/stable</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.huaweicloud.com/docker-ce/linux/centos/gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sed -i <span class="string">&#x27;s+download.docker.com+mirrors.huaweicloud.com/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">yum install -y docker-ce docker-ce-cli containerd.io</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;ï¼š[&quot;https://docker.1panel.live&quot;,&quot;https://hub.rat.dev/&quot;,&quot;https://docker.chenby.cn&quot;, &quot;https://docker.m.daocloud.io&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.ä¸‹è½½harbor</span><br><span class="line">[root@harbor ~]# wget https://github.com/goharbor/harbor/releases/download/v2.11.1/harbor-offline-installer-v2.11.1.tgz</span><br><span class="line"></span><br><span class="line"> 3.è§£å‹</span><br><span class="line">[root@harbor ~]# tar xf harbor-offline-installer-v2.11.1.tgz </span><br><span class="line"></span><br><span class="line">4.è¿›å…¥harborç›®å½•</span><br><span class="line">[root@harbor harbor]# <span class="built_in">cd</span> /root/harbor/</span><br><span class="line">[root@elk1 harbor]# ll</span><br><span class="line">total 646848</span><br><span class="line">-rw-r--r-- 1 root root      3646 Aug 15 18:07 common.sh</span><br><span class="line">-rw-r--r-- 1 root root 662330539 Aug 15 18:07 harbor.v2.11.1.tar.gz#harborçš„æ‰€æœ‰é•œåƒ</span><br><span class="line">-rw-r--r-- 1 root root     14270 Aug 15 18:07 harbor.yml.tmpl</span><br><span class="line">-rwxr-xr-x 1 root root      1975 Aug 15 18:07 install.sh</span><br><span class="line">-rw-r--r-- 1 root root     11347 Aug 15 18:07 LICENSE</span><br><span class="line">-rwxr-xr-x 1 root root      1882 Aug 15 18:07 prepare</span><br><span class="line"></span><br><span class="line">5.æ”¹é…ç½®æ–‡ä»¶å</span><br><span class="line">[root@harbor harbor]# <span class="built_in">cp</span> /root/harbor/harbor.yml.tmpl /root/harbor/harbor.yml</span><br><span class="line"></span><br><span class="line">6.ä¿®æ”¹é…ç½®æ–‡ä»¶ (æ³¨é‡ŠHTTPSçš„é…ç½®)</span><br><span class="line">[root@harbor harbor]# vim harbor.yml</span><br><span class="line">ç¬¬5è¡Œ æ”¹æˆå½“å‰ä¸»æœºçš„ip</span><br><span class="line">hostname: 10.0.0.105</span><br><span class="line">47è¡Œï¼šå…ˆè®°å½•harborçš„å¯†ç </span><br><span class="line">harbor_admin_password: Harbor12345</span><br><span class="line"></span><br><span class="line">7.æ‰§è¡Œå®‰è£…è„šæœ¬</span><br><span class="line">[root@harbor harbor]# ./install.sh</span><br><span class="line">âœ” ----Harbor has been installed and started successfully.----#å‡ºç°è¿™ä¸ªå°±å®‰è£…æˆåŠŸ</span><br><span class="line"></span><br><span class="line">[root@harbor harbor]# docker images</span><br><span class="line">ä¼šçœ‹åˆ°harborè‡ªåŠ¨å®‰è£…çš„é•œåƒ</span><br><span class="line">[root@harbor harbor]# netstat -lntup</span><br><span class="line">ä¼šçœ‹åˆ°80ç«¯å£</span><br><span class="line"></span><br><span class="line">8ã€æµè§ˆå™¨è®¿é—®å½“å‰ä¸»æœºçš„IP</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905171032747.png" alt="image-20240905171032747"></p><p>1ã€åˆ›å»ºé¡¹ç›®     -1 å°±æ˜¯æ— é™å¤§</p><p><img src="../image/study_img/image-20240905171320050.png" alt="image-20240905171320050"></p><p>2ã€ä¸Šä¼ é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¸Šä¼ é•œåƒçš„éœ€æ±‚</span></span><br><span class="line">éœ€è¦ä¿®æ”¹é•œåƒåç§°ï¼šå‘½åè§„åˆ™</span><br><span class="line">harborçš„IPåœ°å€/é¡¹ç›®åç§°/é•œåƒåç§°:æ ‡ç­¾</span><br><span class="line"></span><br><span class="line">1ã€å°†é•œåƒé‡æ–°å‘½å</span><br><span class="line">[root@docker02 ~]# docker tag wordpress:v7 10.0.0.76/wordpress/wordpress:v7</span><br><span class="line"></span><br><span class="line">2ã€æ¨é€é•œåƒ  æŠ¥é”™</span><br><span class="line">[root@docker02 ~]# docker push 10.0.0.76/wordpress/wordpress:v7</span><br><span class="line">The push refers to repository [10.0.0.76/wordpress/wordpress]</span><br><span class="line">Get <span class="string">&quot;https://10.0.0.76/v2/&quot;</span>: dial tcp 10.0.0.76:443: connect: connection refused</span><br><span class="line">åŸå› æ˜¯æ²¡æœ‰ä¿¡ä»»ä¸å®‰å…¨çš„è¿æ¥</span><br><span class="line"></span><br><span class="line">3ã€ä¿®æ”¹dockeré…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ä¿¡ä»»ä¸å®‰å…¨çš„é•œåƒä»“åº“é…ç½®</span><br><span class="line">[root@docker02 ~]# vim /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>, <span class="string">&quot;https://hub.rat.dev/&quot;</span>, <span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>],</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.76&quot;</span>]#å°±æ˜¯åŠ è¿™ä¸ªé…ç½®ï¼Œæ³¨æ„ï¼Œéœ€è¦åœ¨ä¸Šä¸€è¡Œç»“æŸä½ç½®åŠ ,é€—å·</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">é‡å¯docker</span><br><span class="line">[root@docker02 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">4ã€å†æ¬¡æ¨é€ æŠ¥é”™</span><br><span class="line">[root@docker02 ~]# docker push 10.0.0.76/wordpress/wordpress:v7</span><br><span class="line">unauthorized: unauthorized to access repository: wordpress/wordpress, action: push: unauthorized to access repository: wordpress/wordpress, action: push</span><br><span class="line">ä»“åº“æ²¡æœ‰åšè®¤è¯</span><br><span class="line"></span><br><span class="line">5ã€å‘½ä»¤è¡Œç™»å½•Harborè¿›è¡Œè®¤è¯</span><br><span class="line">[root@docker02 ~]# docker login 10.0.0.76</span><br><span class="line">Username: admin</span><br><span class="line">Password:  <span class="comment">#å¯†ç ï¼šHarbor12345</span></span><br><span class="line">......</span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">6ã€è¿™æ¬¡æ¨é€é•œåƒæˆåŠŸï¼Œè¿›å…¥webé¡µé¢ï¼Œåˆ·æ–°ä¸€ä¸‹æŸ¥çœ‹</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905173214933.png" alt="image-20240905173214933"></p><p><img src="../image/study_img/image-20240905173246328.png" alt="image-20240905173246328"></p><p><img src="../image/study_img/image-20240905173324730.png" alt="image-20240905173324730"></p><p>3ã€ä¸‹è½½Harborä»“åº“é‡Œé¢çš„é•œåƒ</p><p><img src="../image/study_img/image-20240905181051876.png" alt="image-20240905181051876"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨10.0.0.101ä¸‹è½½é•œåƒ</span><br><span class="line"><span class="comment">#10.0.0.101æ“ä½œå¦‚ä¸‹</span></span><br><span class="line">1ã€ä¿®æ”¹dockeré…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ä¿¡ä»»ä¸å®‰å…¨çš„é•œåƒä»“åº“é…ç½®</span><br><span class="line">[root@docker01 ~]# vim /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>, <span class="string">&quot;https://hub.rat.dev/&quot;</span>, <span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>],</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.76&quot;</span>]#å°±æ˜¯åŠ è¿™ä¸ªé…ç½®ï¼Œæ³¨æ„ï¼Œéœ€è¦åœ¨ä¸Šä¸€è¡Œç»“æŸä½ç½®åŠ ,é€—å·</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">2ã€ç™»å½•harbor</span><br><span class="line">[root@docker01 ~]# docker login 10.0.0.76</span><br><span class="line">Username: admin</span><br><span class="line">Password:  <span class="comment">#å¯†ç ï¼šHarbor12345</span></span><br><span class="line">......</span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">3ã€ä¸‹è½½é•œåƒ</span><br><span class="line">[root@docker01 ~]# docker pull 10.0.0.76/wordpress/wordpress@sha256:c23f172bdd40059652c0a45affd4c0d1740fa8578c56e0209316e43516560050</span><br><span class="line">æˆ–è€…</span><br><span class="line">[root@docker01 ~]# docker pull 10.0.0.76/wordpress/wordpress:v7</span><br></pre></td></tr></table></figure><h3 id="7ã€é•œåƒä»“åº“registry">7ã€<strong>é•œåƒä»“åº“registry</strong></h3><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th></tr></thead><tbody><tr><td>docker01</td><td>10.0.0.101  /  172.16.1.101</td><td>registryå‘½ä»¤è¡Œä»“åº“</td></tr></tbody></table><p>1ã€ä½¿ç”¨10.0.0.101åœ°å€çš„æœºå™¨æ­å»ºä»“åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ­å»ºä»“åº“</span><br><span class="line">[root@docker01 ~]# docker run -d -p 5000:5000 --restart=always --name registry -v /opt/myregistry:/var/lib/registry registry</span><br><span class="line"></span><br><span class="line">[root@docker01 wordpress]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS         PORTS                                                  NAMES</span><br><span class="line">356673cd10da   registry          <span class="string">&quot;/entrypoint.sh /etcâ€¦&quot;</span>   11 seconds ago   Up 9 seconds   0.0.0.0:5000-&gt;5000/tcp, :::5000-&gt;5000/tcp              registry</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™ä¸ªæ˜¯httpçš„80ç«¯å£ï¼Œä¸€èˆ¬åœ¨ä¼ä¸šä¸­ï¼Œä¼šåœ¨ä»–å‰é¢åŠ nginxä»£ç†ï¼Œç”¨nginx80ä»£ç†ä»–çš„5000ç«¯å£ï¼Œnginxä¸Šé…ç½®åŸŸåæˆ–è€…ip</span></span><br><span class="line">regsitryåšé›†ç¾¤å¯ä»¥æŒ‚è½½è¿™ä¸ªç›®å½•/opt/myregistry/docker/registry/v2/repositories/</span><br><span class="line"></span><br><span class="line">Harborï¼šä»–æœ¬æ¥å°±æ˜¯http,å¦‚æœæƒ³ç»™harboråšé›†ç¾¤,å¯ä»¥å¤šèµ·å‡ ä¸ªharbor,å‰é¢åŠ ä¸ªè´Ÿè½½å‡è¡¡ï¼Œè™½ç„¶æ•°æ®ä¸æ˜¯ç»Ÿä¸€çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨NFSæŒ‚è½½ï¼Œnginxè´Ÿè½½å‡è¡¡å¯ä»¥è§£å†³æ•°æ®ç»Ÿä¸€çš„é—®é¢˜ï¼Œä¸€å°ä¸Šé¢å®‰è£…rsyncï¼Œå…¶ä»–2å°å®æ—¶åŒæ­¥ä¹Ÿå¯ä»¥ï¼Œæ‰€æœ‰æœºå™¨éƒ½è¦å®‰è£…rsync,seysync</span><br><span class="line"></span><br><span class="line">registryå¯ä»¥ä½¿ç”¨nginxä»£ç†</span><br><span class="line">haborä¸å¯ä»¥ä½¿ç”¨nginxä»£ç†</span><br></pre></td></tr></table></figure><p>2ã€ä¸Šä¼ é•œåƒåˆ°ä»“åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç»™é•œåƒæ‰“tagæ ‡ç­¾ï¼Œè¦å†™å…¨ä»“åº“åœ°å€    åœ°å€:ç«¯å£/é•œåƒå:ç‰ˆæœ¬å·</span><br><span class="line">[root@docker02 ~]# docker tag wordpress-manual:v1 172.16.1.101:5000/wordpress-manual:v1</span><br><span class="line">[root@docker02 ~]# docker tag nginx:alpine 172.16.1.101:5000/nginx:alpine</span><br><span class="line">[root@docker02 ~]# docker tag busybox:latest  172.16.1.101:5000/busybox:latest</span><br><span class="line"></span><br><span class="line">2ã€å…¶ä»–æœºå™¨éœ€è¦å°†ä»£ç ä¸Šä¼ åˆ°ä»“åº“çš„æœºå™¨é…ç½®æ–‡ä»¶ï¼Œæ”¹æœºå™¨å°±è¦ä¿¡ä»»ä»“åº“åœ°å€</span><br><span class="line">[root@docker03 ~]# vim /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>, <span class="string">&quot;https://hub.rat.dev/&quot;</span>, <span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>],</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.76&quot;</span>,<span class="string">&quot;http://172.16.1.101:5000&quot;</span>]#å°±æ˜¯åŠ è¿™ä¸ªé…ç½®ï¼Œæ³¨æ„ï¼Œéœ€è¦åœ¨ä¸Šä¸€è¡Œç»“æŸä½ç½®åŠ ,é€—å·ï¼Œåœ°å€å†™å†…å¤–æ¨é€ä¼šæ¯”è¾ƒå¿«ï¼Œå¦‚æœå†™å†…å¤–ï¼Œå‘½åå°±è¦ç”¨å†…å¤–å‘½å</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">3ã€é‡å¯Docker</span><br><span class="line">[root@docker03 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">4ã€æ¨é€é•œåƒ</span><br><span class="line">[root@docker02 ~]# docker push 172.16.1.101:5000/wordpress-manual:v1</span><br><span class="line">[root@docker02 ~]# docker push 172.16.1.101:5000/nginx:alpine</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3ã€æŸ¥çœ‹ç§æœ‰æŸ¥çœ‹é•œåƒåˆ—è¡¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1ã€éšä¾¿åœ¨å“ªå°æœºå™¨æŸ¥çœ‹éƒ½è¡Œï¼Œåªè¦å’ŒregistreæŸ¥çœ‹çš„æœºå™¨é€šï¼ŒæŸ¥çœ‹æ‰€æœ‰é•œåƒä»“åº“</span><br><span class="line">[root@docker02 ~]# curl http://172.16.1.101:5000/v2/_catalog</span><br><span class="line">&#123;<span class="string">&quot;repositories&quot;</span>:[<span class="string">&quot;busybox&quot;</span>,<span class="string">&quot;nginx&quot;</span>,<span class="string">&quot;wordpress-manual&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹æŒ‡å®šä»“åº“çš„tagæ ‡ç­¾</span><br><span class="line">[root@docker02 ~]# curl http://172.16.1.101:5000/v2/nginx/tags/list</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;nginx&quot;</span>,<span class="string">&quot;tags&quot;</span>:[<span class="string">&quot;alpine&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line">3ã€æ ¼å¼åŒ–è¾“å‡ºjsonæ ¼å¼ä¿¡æ¯</span><br><span class="line">[root@docker02 ~]# yum -y install jq</span><br><span class="line">[root@docker02 ~]#  curl -s http://172.16.1.101:5000/v2/_catalog|jq</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;repositories&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;busybox&quot;</span>,</span><br><span class="line">    <span class="string">&quot;nginx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wordpress-manual&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4ã€åˆ é™¤ç§æœ‰ä»“åº“ä¸­çš„é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">1ã€æŸ¥çœ‹æ˜ å°„çš„ç›®å½•</span><br><span class="line">[root@docker01 ~]# docker inspect registry</span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/opt/myregistry&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/var/lib/registry&quot;</span>,</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹/opt/myregistryç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šä¼ åˆ°çš„é•œåƒ</span><br><span class="line">[root@docker01 ~]# ll /opt/myregistry/docker/registry/v2/repositories/</span><br><span class="line">drwxr-xr-x 5 root root 55 Sep  6 16:40 busybox</span><br><span class="line">drwxr-xr-x 5 root root 55 Sep  6 16:32 nginx</span><br><span class="line">drwxr-xr-x 5 root root 55 Sep  6 16:17 wordpress-manual</span><br><span class="line"></span><br><span class="line">3ã€ç”±äºåšäº†æ˜ å°„ï¼Œå°±ä¸éœ€è¦è¿åˆ°å®¹å™¨é‡Œé¢ï¼Œç›´æ¥åœ¨å®¿ä¸»æœºä¸Šåˆ é™¤</span><br><span class="line">[root@docker01 ~]# <span class="built_in">rm</span> -rf /opt/myregistry/docker/registry/v2/repositories/busybox</span><br><span class="line">[root@docker01 ~]# ll /opt/myregistry/docker/registry/v2/repositories/</span><br><span class="line">drwxr-xr-x 5 root root 55 Sep  6 16:32 nginx</span><br><span class="line">drwxr-xr-x 5 root root 55 Sep  6 16:17 wordpress-manual</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# curl -s http://172.16.1.101:5000/v2/_catalog|jq</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;repositories&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;nginx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wordpress-manual&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">4ã€æŸ¥çœ‹æ˜¯å¦ç”ŸæˆblobäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚æœæœ‰å°±åˆ é™¤ï¼Œæ²¡æœ‰ç”Ÿæˆå°±ä¸ç”¨ç®¡</span><br><span class="line">[root@docker01 ~]# ll /etc/docker</span><br><span class="line">-rw-r--r-- 1 root root 219 Sep  6 16:52 daemon.json</span><br><span class="line"></span><br><span class="line">åˆ é™¤æ–¹æ³•ï¼š</span><br><span class="line">registry garbage-collect /etc/docker/registry/config.yml</span><br></pre></td></tr></table></figure><p>5ã€æ‹‰å–é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@docker03 ~]# docker pull 172.16.1.101:5000/wordpress-manual:v1</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ±‡æ€»dockerçš„ç½‘ç»œçš„æ¨¡å¼ï¼Œéƒ¨ç½²å›¾å½¢åŒ–çš„é•œåƒä»“åº“Harborï¼Œå¯¹ä»“åº“è¿›è¡Œä¸€äº›åŸºæœ¬æ“ä½œï¼›éƒ¨ç½²å‘½ä»¤è¡Œçš„ç§æœ‰ä»“åº“registry</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ä¸‰ã€ğŸ¡Dockeråˆ¶ä½œé•œåƒ</title>
    <link href="https://www.fomal.cc/posts/eb54e23d.html"/>
    <id>https://www.fomal.cc/posts/eb54e23d.html</id>
    <published>2024-09-22T05:00:48.000Z</published>
    <updated>2024-09-22T07:53:34.208Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Dockeråˆ¶ä½œé•œåƒ">Dockeråˆ¶ä½œé•œåƒ</h2><p>Docker å®¹å™¨æ“ä½œçš„é€‰é¡¹</p><table><thead><tr><th>é€‰é¡¹</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>â€“name</td><td>è‡ªå®šä¹‰å®¹å™¨å</td></tr><tr><td>-d</td><td>å°†å®¹å™¨æ”¾åå°å¯åŠ¨</td></tr><tr><td>-it   (input   TTY)</td><td>åˆ†é…ä¸€ä¸ªäº¤äº’å¼çš„ç»ˆç«¯</td></tr><tr><td>-p</td><td>ç«¯å£æ˜ å°„</td></tr><tr><td>-P</td><td>æ˜ å°„éšæœºç«¯å£</td></tr><tr><td>-v</td><td>æ•°æ®å·æ˜ å°„</td></tr><tr><td>-e</td><td>env  æŒ‡å®šç¯å¢ƒå˜é‡</td></tr><tr><td>â€“restart=always</td><td>è®¾ç½®å®¹å™¨å¼€æœºè‡ªå¯ï¼Œdockerå¯åŠ¨å°±è·Ÿç€è‡ªåŠ¨å¯åŠ¨</td></tr><tr><td>â€“link=mysql57</td><td>æŒ‡å®šå¦ä¸€ä¸ªå®¹å™¨çš„åå­—ï¼Œå°±å¯ä»¥å’ŒæŒ‡å®šçš„å®¹å™¨é€šä¿¡</td></tr></tbody></table><p>è¿è¡Œmysqlå®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–mysql5.7.44é•œåƒ</span><br><span class="line">root@docker01 ~]# docker pull mysql:5.7.44</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹å·¥ä½œç›®å½•å’Œç«¯å£</span><br><span class="line">[root@docker01 ~]# docker inspect mysql:5.7.44</span><br><span class="line">            <span class="string">&quot;ExposedPorts&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;3306/tcp&quot;</span>: &#123;&#125;,</span><br><span class="line">                <span class="string">&quot;33060/tcp&quot;</span>: &#123;&#125;</span><br><span class="line">                </span><br><span class="line">            <span class="string">&quot;Volumes&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;/var/lib/mysql&quot;</span>: &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="comment">#rootå¯†ç </span></span><br><span class="line">MYSQL_ROOT_PASSWORD</span><br><span class="line"></span><br><span class="line"><span class="comment"># å»ºåº“</span></span><br><span class="line">MYSQL_DATABASE</span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ›å»ºç”¨æˆ·</span></span><br><span class="line">MYSQL_USER</span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ›å»ºæ™®é€šç”¨æˆ·çš„å¯†ç </span></span><br><span class="line">MYSQL_PASSWORD</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œé•œåƒ</span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wordpress \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line">-v <span class="comment">#æ˜ å°„é…ç½®æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run \</span><br><span class="line">-name some-mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=my-secret-pw \</span><br><span class="line">-d mysql:tag \</span><br><span class="line">--character-set-server=utf8mb4 \</span><br><span class="line">--collation-server=utf8mb4_unicode_ci</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-v /data/wp:/var/www/html \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wordpress \</span><br><span class="line">-d wordpress</span><br><span class="line">ä¸€èˆ¬éƒ½æ˜¯åˆ›å»ºæ™®é€šç”¨æˆ·ï¼Œåšäº†ç«¯å£æ˜ å°„å®¿ä¸»æœºä¹Ÿèƒ½è¿æ¥</span><br><span class="line"></span><br><span class="line">3ã€è¿æ¥è¿›å»</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">exec</span> -it eedc00b /bin/bash</span><br><span class="line">bash-4.2# </span><br><span class="line">bash-4.2# mysql -uroot -p123</span><br><span class="line"></span><br><span class="line">4ã€æŸ¥çœ‹åˆ›å»ºçš„åº“å’Œç”¨æˆ·</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wordpress          |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host from mysql.user;</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| root          | %         |</span><br><span class="line">| wp_user       | %         | <span class="comment">#å®¹å™¨çš„ipæ˜¯å†…å¤–ip,ä¸æŠŠç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šå°±æ²¡äº‹</span></span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">+---------------+-----------+</span><br><span class="line"></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> wp_user@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> wp_user@%                                   |</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;wp_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                    |</span><br><span class="line">| GRANT ALL PRIVILEGES ON `wordpress`.* TO <span class="string">&#x27;wp_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">4ã€æ˜ å°„çš„ç›®å½•é‡Œé¢æœ‰æ•°æ®</span><br><span class="line">[root@docker01 ~]# ll /data/mysql/</span><br></pre></td></tr></table></figure><h3 id="1ã€æ‰‹åŠ¨åˆ¶ä½œWordPressé•œåƒ">1ã€<strong>æ‰‹åŠ¨åˆ¶ä½œWordPressé•œåƒ</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¸‹è½½wordpressä»£ç åŒ…</span><br><span class="line">[root@docker01 ~]# wget https://cn.wordpress.org/wordpress-5.9.10-zh_CN.tar.gz</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œä¸€ä¸ªåŸºç¡€å®¹å™¨</span><br><span class="line">[root@docker01 ~]# docker run --name wp_base -it  centos:7 /bin/bash</span><br><span class="line"></span><br><span class="line">3ã€æ¢æº</span><br><span class="line">[root@3dcd1060f3ab /]#  curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo</span><br><span class="line">[root@3dcd1060f3ab /]#  curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">[root@3dcd1060f3ab /]#sed -i <span class="string">&quot;s@http://mirrors.aliyun.com@https://mirrors.huaweicloud.com@g&quot;</span> /etc/yum.repos.d/epel.repo</span><br><span class="line"></span><br><span class="line">4ã€æ¢phpæº</span><br><span class="line">[root@3dcd1060f3ab /]# <span class="built_in">cat</span> &gt; /etc/yum.repos.d/php.repo &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[php-webtatic]</span></span><br><span class="line"><span class="string">name = PHP Repository</span></span><br><span class="line"><span class="string">baseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/</span></span><br><span class="line"><span class="string">gpgcheck = 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> -e  <span class="string">&quot;[php-webtatic]\nname = PHP Repository\nbaseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/\ngpgcheck = 0&quot;</span>&gt; /etc/yum.repos.d/php.repo</span><br><span class="line"></span><br><span class="line">5ã€å®‰è£…phpã€mysqlã€nginx</span><br><span class="line">[root@nginx ~]# yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb mariadb-server nginx</span><br><span class="line"></span><br><span class="line">6ã€åˆ›å»ºnginxå¯åŠ¨ç”¨æˆ·</span><br><span class="line">[root@3dcd1060f3ab code]# groupadd -g 666 www</span><br><span class="line">[root@3dcd1060f3ab code]# useradd -u 666 -g 666 -s /sbin/nologin -M www</span><br><span class="line"></span><br><span class="line">7ã€ä¼˜åŒ–nginx  php ç»Ÿä¸€ç”¨æˆ·</span><br><span class="line">ä¸»é…ç½®æ–‡ä»¶   (å¦‚æœæ˜¯nginxXå®˜æ–¹æºä¸‹è½½çš„nginxï¼Œå°±ä¸ç”¨ä¼˜åŒ–)</span><br><span class="line">[root@3dcd1060f3ab /]# vi /etc/nginx/nginx.conf</span><br><span class="line">user www;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 4096;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@3dcd1060f3ab ~]# sed -i <span class="string">&#x27;s#user = apache#user = www#g&#x27;</span> /etc/php-fpm.d/www.conf</span><br><span class="line">[root@3dcd1060f3ab ~]# sed -i <span class="string">&#x27;s#group = apache#group = www#g&#x27;</span> /etc/php-fpm.d/www.conf </span><br><span class="line"></span><br><span class="line">8ã€ç¼–å†™ç½‘ç«™ä¸»é…ç½®æ–‡ä»¶</span><br><span class="line">[root@3dcd1060f3ab /]# vi /etc/nginx/conf.d/wp.conf</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name _;</span><br><span class="line">        root /code/wordpress;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">        </span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">             fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">             fastcgi_param SCRIPT_FILENAME $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">             include fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">9ã€åˆ›å»ºç«™ç‚¹ç›®å½•ï¼Œå®¿ä¸»æœºæ–°å¼€çª—å£ä¸Šä¼ ä»£ç åˆ°ç«™ç‚¹ç›®å½•ï¼Œå¹¶è§£å‹ï¼Œæˆæƒ</span><br><span class="line">[root@3dcd1060f3ab /]# <span class="built_in">mkdir</span> /code</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> wordpress-5.9.10.tar.gz  wp_base:/code</span><br><span class="line"></span><br><span class="line">[root@3dcd1060f3ab /]# <span class="built_in">cd</span> /code</span><br><span class="line">[root@3dcd1060f3ab code]# tar xf wordpress-5.9.10.tar.gz </span><br><span class="line">[root@3dcd1060f3ab code]# <span class="built_in">chown</span> -R  www.www /code/</span><br><span class="line"></span><br><span class="line">10ã€å¯åŠ¨æ•°æ®åº“</span><br><span class="line">è™½ç„¶æ˜¯ä¸èƒ½systemdå¯åŠ¨ï¼Œä½†æ˜¯mariadbçš„å¯åŠ¨è„šæœ¬è¿˜æ˜¯åœ¨çš„</span><br><span class="line">[root@3dcd1060f3ab code]# <span class="built_in">cat</span> /usr/lib/systemd/system/mariadb.service </span><br><span class="line"> 35è¡Œï¼šå¯åŠ¨ä¹‹å‰è¦åšåˆå§‹åŒ–ï¼Œæ‰¾åˆ°åˆå§‹åŒ–å‘½ä»¤ </span><br><span class="line"> ExecStartPre=/usr/libexec/mariadb-prepare-db-dir %n</span><br><span class="line"> 38è¡Œï¼šå¯åŠ¨å‘½ä»¤</span><br><span class="line"> ExecStart=/usr/bin/mysqld_safe --basedir=/usr   (å¯ä»¥å¡ä¸»)</span><br><span class="line"> </span><br><span class="line"> [root@3dcd1060f3ab code]# /usr/libexec/mariadb-prepare-db-dir %n</span><br><span class="line"> [root@3dcd1060f3ab code]# /usr/bin/mysqld_safe --basedir=/usr &amp;</span><br><span class="line"> </span><br><span class="line"> 11ã€è¿›å»æ•°æ®åº“åˆ›å»ºåº“ ç”¨æˆ·</span><br><span class="line">[root@3dcd1060f3ab code]# mysql</span><br><span class="line">MariaDB [(none)]&gt; create database wordpress;</span><br><span class="line">MariaDB [(none)]&gt; grant all on *.* to wp_user@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line">12ã€æµ‹è¯•ç”¨æˆ·æ˜¯å¦å¯ä»¥è¿æ¥</span><br><span class="line">[root@3dcd1060f3ab code]# mysql -uwp_user -p123 -h127.0.0.1</span><br><span class="line"></span><br><span class="line">13ã€å¯åŠ¨nginx</span><br><span class="line">[root@3dcd1060f3ab code]# nginx</span><br><span class="line"></span><br><span class="line">14ã€å¯åŠ¨php</span><br><span class="line">æ‰¾åˆ°å¯åŠ¨è„šæœ¬é‡Œé¢çš„å¯åŠ¨å‘½ä»¤</span><br><span class="line">[root@3dcd1060f3ab code]# vi /usr/lib/systemd/system/php-fpm.service </span><br><span class="line"> 9è¡Œ</span><br><span class="line"> ExecStart=/usr/sbin/php-fpm --nodaemonize --fpm-config /etc/php-fpm.conf</span><br><span class="line"> </span><br><span class="line"> --nodaemonizeï¼šå¯ä»¥å¡ä½ï¼Œä¸åŠ å°±æ”¾åå°</span><br><span class="line">[root@3dcd1060f3ab code]# /usr/sbin/php-fpm  --fpm-config /etc/php-fpm.conf</span><br><span class="line"> </span><br><span class="line"> 15ã€curlä¸€ä¸‹ï¼Œèƒ½å¤Ÿæ­£å¸¸è®¿é—®</span><br><span class="line"> [root@3dcd1060f3ab code]# curl -L 127.0.0.1</span><br><span class="line"> ....</span><br><span class="line"> &lt;p&gt;Welcome to WordPress. Before getting started, we need some information on the database. You will need to know the following items before proceeding.&lt;/p&gt;</span><br><span class="line">&lt;ol&gt;</span><br><span class="line">        &lt;li&gt;Database name&lt;/li&gt;     <span class="comment">#å¡«å†™æ•°æ®åº“ä¿¡æ¯çš„é¡µé¢</span></span><br><span class="line">        &lt;li&gt;Database username&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;Database password&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;Database host&lt;/li&gt;</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">16ã€å°†3ä¸ªæœåŠ¡å†™è„šæœ¬å¯åŠ¨ï¼Œå°±ä¸ç”¨ä¸€ä¸ªä¸€ä¸ªå¯åŠ¨äº†</span><br><span class="line">[root@3dcd1060f3ab code]# <span class="built_in">cd</span> ~</span><br><span class="line">[root@3dcd1060f3ab ~]# vi start.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">/sbin/nginx</span><br><span class="line">/usr/sbin/php-fpm  --fpm-config /etc/php-fpm.conf</span><br><span class="line"><span class="comment">#è„šæœ¬é‡Œé¢éœ€è¦å¡ä¸»ä¸€ä¸ªå°±å¯ä»¥ï¼ŒæŠŠmysqlå¡ä½</span></span><br><span class="line">/usr/bin/mysqld_safe --basedir=/usr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">17ã€è¾“å…¥æ­¤æ—¶å¯ä»¥æ‰“åŒ…äº†ï¼Œä½†æ˜¯æ‰“åŒ…å‡ºæ¥çš„é•œåƒå¾ˆå¤§ï¼Œéœ€è¦ä¼˜åŒ–ä¸€ä¸‹</span><br><span class="line">[root@3dcd1060f3ab ~]# <span class="built_in">rm</span> -rf /code/wordpress-5.9.10.tar.gz</span><br><span class="line">[root@3dcd1060f3ab ~]# yum clean all</span><br><span class="line">åˆ é™¤æ‰€æœ‰yumæºï¼Œä»¥åç”¨ä¸åˆ°çš„ï¼Œè¿™ä¸ªå°±æ˜¯wordpress</span><br><span class="line">[root@3dcd1060f3ab ~]# <span class="built_in">rm</span> -rf /etc/yum.repos.d/* </span><br><span class="line">å¦‚æœæœ‰ä¸‹è½½wgetä¸‹è½½ä¸œè¥¿ï¼Œéƒ½è¦å¸è½½æ‰ï¼Œä»¥åç”¨ä¸åˆ°çš„</span><br><span class="line"></span><br><span class="line">18ã€æ‰“å¼€æ–°çª—å£ï¼Œå°†å®¹å™¨æ‰“åŒ…</span><br><span class="line">[root@docker01 ~]# docker commit wp_base wordpress:v1</span><br><span class="line">[root@docker01 ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">wordpress    v1        26586db1eda4   9 seconds ago   615MB</span><br><span class="line"></span><br><span class="line">19ã€è¿è¡Œè¿™ä¸ªå®¹å™¨ï¼Œæµ‹è¯•æ˜¯å¦èƒ½å¤Ÿåœ¨ç½‘é¡µé‡Œé¢è®¿é—®</span><br><span class="line">[root@docker01 ~]# docker run -p 80:80 -d wordpress:v1  /bin/sh ~/start.sh</span><br><span class="line">è„šæœ¬åœ¨å®¹å™¨é‡Œé¢çš„ç»å¯¹è·¯å¾„</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS        PORTS                               NAMES</span><br><span class="line">720febe29da7   wordpress:v1   <span class="string">&quot;/bin/sh /root/startâ€¦&quot;</span>   2 seconds ago   Up 1 second   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   hopeful_wing</span><br><span class="line"></span><br><span class="line">20ã€æµè§ˆå™¨è®¿é—®10.0.0.101</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240904155106974.png" alt="image-20240904155106974"></p><p><img src="../image/study_img/image-20240905192409386.png" alt="image-20240905192409386"></p><p><img src="../image/study_img/image-20240904160154137.png" alt="image-20240904160154137"></p><p><img src="../image/study_img/image-20240904160307363.png" alt="image-20240904160307363"></p><p><img src="../image/study_img/image-20240904160327203.png" alt="image-20240904160327203"></p><p><img src="../image/study_img/image-20240904160430589.png" alt="image-20240904160430589"></p><p><img src="../image/study_img/image-20240904162155815.png" alt="image-20240904162155815"></p><h3 id="2ã€ä½¿ç”¨å®˜æ–¹çš„wordpresså®¹å™¨">2ã€<strong>ä½¿ç”¨å®˜æ–¹çš„wordpresså®¹å™¨</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–wordpresså®¹å™¨</span><br><span class="line">[root@docker02 ~]# docker pull wordpress</span><br><span class="line"></span><br><span class="line">2ã€æ‹‰å–æ•°æ®åº“</span><br><span class="line">[root@docker02 ~]# docker pull mysql:5.7.44</span><br><span class="line"></span><br><span class="line">3ã€#å®˜æ–¹wpå®¹å™¨çš„å¯åŠ¨æ–¹æ³•</span><br><span class="line">[root@docker02 ~]# docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-v /data/wp:/var/www/html \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wordpress \</span><br><span class="line">-d wordpress</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®˜æ–¹mysqlå®¹å™¨çš„å¯åŠ¨æ–¹æ³•</span></span><br><span class="line">[root@docker02 ~]# docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wordpress \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line">4ã€æµè§ˆå™¨è®¿é—®10.0.0.102</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240904164056259.png" alt="image-20240904164056259"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰å¡«å†™æ•°æ®åº“ä¿¡æ¯çš„é˜¶æ®µï¼Œå› ä¸ºåœ¨å¯åŠ¨æ•°æ®åº“ä¹‹å‰å·²ç»ä½¿ç”¨å‚æ•°ä¼ é€’è¿›å»äº†ï¼Œè€Œä¸”ä¸ä¼šå‡ºç°é”™è¯¯ï¼Œä¸ä¼šå‡ºç°ç ´å›¾ï¼Œè¿™ä¸ªæ‰æ˜¯ç”Ÿäº§ä¸­éœ€è¦çš„æ•ˆæœï¼Œéœ€è¦å˜é‡ä¼ é€’å‚æ•°</p><p><img src="../image/study_img/image-20240904164144932.png" alt="image-20240904164144932"></p><h3 id="3ã€æ„å»ºå¯ä»¥ä¼ é€’å‚æ•°çš„é•œåƒ-ï¼ˆæ¨¡æ‹Ÿå®˜æ–¹æ‰“wordpressé•œåƒï¼‰">3ã€<strong>æ„å»ºå¯ä»¥ä¼ é€’å‚æ•°çš„é•œåƒ    ï¼ˆæ¨¡æ‹Ÿå®˜æ–¹æ‰“wordpressé•œåƒï¼‰</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å…ˆäº†è§£è¯»å–ç³»ç»Ÿç¯å¢ƒå˜é‡çš„å‘½ä»¤ï¼šenvsubst</span></span><br><span class="line">[root@docker02 ~]# <span class="built_in">export</span> wp_db_name=wp</span><br><span class="line">[root@docker02 ~]# <span class="built_in">export</span> wp_db_user=wp_user</span><br><span class="line">[root@docker02 ~]# <span class="built_in">echo</span> <span class="variable">$wp_db_name</span></span><br><span class="line">wp</span><br><span class="line">[root@docker02 ~]# <span class="built_in">echo</span> <span class="variable">$wp_db_user</span></span><br><span class="line">wp_user</span><br><span class="line">[root@docker02 ~]# vim 1.txt</span><br><span class="line">define( <span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;$wp_db_name&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;$wp_db_user&#x27;</span> );</span><br><span class="line"></span><br><span class="line">æ‹¿ç¯å¢ƒå˜é‡å»æ¸²æŸ“è¿™ä¸ªæ–‡ä»¶,1.txtä¼šå˜æˆç©ºæ–‡ä»¶</span><br><span class="line">envsubstè¯»å–1.txté‡Œé¢çš„å˜é‡ï¼ŒåŒ¹é…ç¯å¢ƒå˜é‡é‡Œé¢æœ‰æ²¡æœ‰ï¼Œæœ‰çš„è¯ï¼Œè¾“å‡ºæ¸²æŸ“åˆ°2.txt</span><br><span class="line">[root@docker02 ~]# envsubst &lt; 1.txt &gt; 2.txt</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> 2.txt </span><br><span class="line">define( <span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;wp&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;wp_user&#x27;</span> );</span><br><span class="line"></span><br><span class="line">æŒ‡å®šåªæ¸²æŸ“ä¸€ä¸ªå˜é‡ï¼Œæ²¡è¢«æ¸²æŸ“çš„å˜é‡å°±æ˜¯é»˜è®¤çš„</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> 1.txt </span><br><span class="line">define( <span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;$wp_db_name&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;$wp_db_user&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_PASS&#x27;</span>, <span class="string">&#x27;$wp_db_pass&#x27;</span> );</span><br><span class="line">[root@docker02 ~]# envsubst <span class="string">&#x27;$wp_db_name&#x27;</span> &lt; 1.txt &gt;2.txt </span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> 2.txt </span><br><span class="line">define( <span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;wp&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;$wp_db_user&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_PASS&#x27;</span>, <span class="string">&#x27;$wp_db_pass&#x27;</span> );</span><br><span class="line"></span><br><span class="line">å®¹å™¨é‡Œé¢æ²¡æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œå…ˆæŸ¥è¯¢ä¸€ä¸ªå±äºå“ªä¸ªåŒ…ï¼Œåœ¨å®¹å™¨é‡Œé¢å®‰è£…æœåŠ¡çš„æ—¶å€™ä¸€èµ·å®‰è£…</span><br><span class="line">[root@docker02 ~]# yum provides envsbet</span><br><span class="line">gettext-0.19.8.1-3.el7.x86_64 : GNU libraries and utilities <span class="keyword">for</span> producing multi-lingual messages</span><br></pre></td></tr></table></figure><p>åœ¨docker02    10.0.0.102 æ„å»º     éœ€è¦æŠŠä¹‹å‰å…è®¸çš„å®¹å™¨å…³é—­ï¼Œéœ€è¦æ‰“nginxã€php</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¸‹è½½wordpressä»£ç åŒ…</span><br><span class="line">[root@docker01 ~]# wget https://cn.wordpress.org/wordpress-5.9.10-zh_CN.tar.gz</span><br><span class="line"></span><br><span class="line">1ã€è¿è¡Œä¸€ä¸ªåŸºç¡€å®¹å™¨</span><br><span class="line">[root@docker01 ~]# docker run --name wp_base -it  centos:7 /bin/bash</span><br><span class="line"></span><br><span class="line">2ã€æ¢æº</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">sed -i <span class="string">&quot;s@http://mirrors.aliyun.com@https://mirrors.huaweicloud.com@g&quot;</span> /etc/yum.repos.d/epel.repo</span><br><span class="line"></span><br><span class="line">3ã€æ¢phpæº</span><br><span class="line">[root@3dcd1060f3ab /]# <span class="built_in">cat</span> &gt; /etc/yum.repos.d/php.repo &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[php-webtatic]</span></span><br><span class="line"><span class="string">name = PHP Repository</span></span><br><span class="line"><span class="string">baseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/</span></span><br><span class="line"><span class="string">gpgcheck = 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> -e  <span class="string">&quot;[php-webtatic]\nname = PHP Repository\nbaseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/\ngpgcheck = 0&quot;</span>&gt; /etc/yum.repos.d/php.repo</span><br><span class="line"></span><br><span class="line">4ã€å®‰è£…phpã€nginxã€envsubstå‘½ä»¤</span><br><span class="line">[root@nginx ~]# yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb nginx  gettext</span><br><span class="line"></span><br><span class="line">5ã€åˆ›å»ºnginxå¯åŠ¨ç”¨æˆ·</span><br><span class="line">groupadd -g 666 www</span><br><span class="line">useradd -u 666 -g 666 -s /sbin/nologin -M www</span><br><span class="line"></span><br><span class="line">6ã€ä¼˜åŒ–nginx  php ç»Ÿä¸€ç”¨æˆ·</span><br><span class="line">ä¸»é…ç½®æ–‡ä»¶   (å¦‚æœæ˜¯nginxXå®˜æ–¹æºä¸‹è½½çš„nginxï¼Œå°±ä¸ç”¨ä¼˜åŒ–)</span><br><span class="line">[root@3dcd1060f3ab /]# vi /etc/nginx/nginx.conf</span><br><span class="line">user www;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 4096;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@3dcd1060f3ab ~]# sed -i <span class="string">&#x27;s#user = apache#user = www#g&#x27;</span> /etc/php-fpm.d/www.conf</span><br><span class="line">sed -i <span class="string">&#x27;s#group = apache#group = www#g&#x27;</span> /etc/php-fpm.d/www.conf </span><br><span class="line"></span><br><span class="line">7ã€ç¼–å†™ç½‘ç«™ä¸»é…ç½®æ–‡ä»¶</span><br><span class="line">[root@3dcd1060f3ab /]# vi /etc/nginx/conf.d/wp.conf</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name _;</span><br><span class="line">        root /code/wordpress;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">        </span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">             fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">             fastcgi_param SCRIPT_FILENAME $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">             include fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">8ã€åˆ›å»ºç«™ç‚¹ç›®å½•ï¼Œå®¿ä¸»æœºæ–°å¼€çª—å£ä¸Šä¼ ä»£ç åˆ°ç«™ç‚¹ç›®å½•ï¼Œå¹¶è§£å‹ï¼Œæˆæƒ</span><br><span class="line">[root@3dcd1060f3ab /]# <span class="built_in">mkdir</span> /code</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> wordpress-5.9.10.tar.gz  wp_base:/code</span><br><span class="line">[root@3dcd1060f3ab code]# <span class="built_in">cd</span> /code</span><br><span class="line">[root@3dcd1060f3ab code]# tar xf wordpress-5.9.10.tar.gz </span><br><span class="line">[root@3dcd1060f3ab code]# <span class="built_in">chown</span> -R  www.www /code/</span><br><span class="line"><span class="built_in">chown</span> -R www.www /var/lib/nginx/</span><br><span class="line"></span><br><span class="line">9ã€å¯åŠ¨nginx</span><br><span class="line">[root@3dcd1060f3ab code]# nginx</span><br><span class="line"></span><br><span class="line">10ã€å¯åŠ¨php</span><br><span class="line">æ‰¾åˆ°å¯åŠ¨è„šæœ¬é‡Œé¢çš„å¯åŠ¨å‘½ä»¤</span><br><span class="line">[root@3dcd1060f3ab code]# vi /usr/lib/systemd/system/php-fpm.service </span><br><span class="line"> 9è¡Œ</span><br><span class="line"> ExecStart=/usr/sbin/php-fpm --nodaemonize --fpm-config /etc/php-fpm.conf</span><br><span class="line"> </span><br><span class="line"> --nodaemonizeï¼šå¯ä»¥å¡ä½ï¼Œä¸åŠ å°±æ”¾åå°</span><br><span class="line">[root@3dcd1060f3ab code]# /usr/sbin/php-fpm  --fpm-config /etc/php-fpm.conf</span><br><span class="line"> </span><br><span class="line"> 11ã€curlä¸€ä¸‹ï¼Œèƒ½å¤Ÿæ­£å¸¸è®¿é—®</span><br><span class="line"> [root@3dcd1060f3ab code]# curl -L 127.0.0.1</span><br><span class="line"> ....    <span class="comment">#å¯ä»¥çœ‹åˆ°é€‰ä¸­è¯­è¨€çš„ç•Œé¢</span></span><br><span class="line">&lt;option value=<span class="string">&quot;zh_HK&quot;</span> lang=<span class="string">&quot;zh&quot;</span> data-continue=<span class="string">&quot;ç¹¼çºŒ&quot;</span>&gt;é¦™æ¸¯ä¸­æ–‡&lt;/option&gt;</span><br><span class="line">&lt;option value=<span class="string">&quot;zh_CN&quot;</span> lang=<span class="string">&quot;zh&quot;</span> data-continue=<span class="string">&quot;ç»§ç»­&quot;</span>&gt;ç®€ä½“ä¸­æ–‡&lt;/option&gt;</span><br><span class="line">&lt;option value=<span class="string">&quot;zh_TW&quot;</span> lang=<span class="string">&quot;zh&quot;</span> data-continue=<span class="string">&quot;ç¹¼çºŒ&quot;</span>&gt;ç¹é«”ä¸­æ–‡&lt;/option&gt;</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">12ã€ä¼ å‚ï¼Œä¸è¦æ•°æ®çš„é¡µé¢ï¼Œéœ€è¦ä½¿ç”¨è¯»å–ç³»ç»Ÿç¯å¢ƒå˜é‡çš„å‘½ä»¤envsubst</span><br><span class="line">å°†é…ç½®æ–‡ä»¶æ”¹æˆæ¨¡ç‰ˆæ–‡ä»¶</span><br><span class="line">[root@1925f5794372 code]# vi /code/wordpress/wp-config-sample.php</span><br><span class="line">......</span><br><span class="line"><span class="comment">#æŠŠè¿™å‡ è¡Œæ”¹æˆå˜é‡</span></span><br><span class="line">     23 define( <span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;$WORDPRESS_DB_NAME&#x27;</span> );</span><br><span class="line">     24 </span><br><span class="line">     25 /** Database username */</span><br><span class="line">     26 define( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;$WORDPRESS_DB_USER&#x27;</span> );</span><br><span class="line">     27 </span><br><span class="line">     28 /** Database password */</span><br><span class="line">     29 define( <span class="string">&#x27;DB_PASSWORD&#x27;</span>, <span class="string">&#x27;$WORDPRESS_DB_PASSWORD&#x27;</span> );</span><br><span class="line">     30 </span><br><span class="line">     31 /** Database hostname */</span><br><span class="line">     32 define( <span class="string">&#x27;DB_HOST&#x27;</span>, <span class="string">&#x27;$WORDPRESS_DB_HOST&#x27;</span> );</span><br><span class="line">     </span><br><span class="line"> </span><br><span class="line">sed -i <span class="string">&#x27;s#database_name_here#$WORDPRESS_DB_NAME#g&#x27;</span> /code/wordpress/wp-config-sample.php</span><br><span class="line">sed -i <span class="string">&#x27;s#username_here#$WORDPRESS_DB_USER#g&#x27;</span> /code/wordpress/wp-config-sample.php</span><br><span class="line">sed -i <span class="string">&#x27;s#password_here#$WORDPRESS_DB_PASSWORD#g&#x27;</span> /code/wordpress/wp-config-sample.php</span><br><span class="line">sed -i <span class="string">&#x27;s#localhost#$WORDPRESS_DB_HOST#g&#x27;</span> /code/wordpress/wp-config-sample.php</span><br><span class="line"></span><br><span class="line">13ã€å°†2ä¸ªæœåŠ¡å†™è„šæœ¬å¯åŠ¨ï¼Œå°±ä¸ç”¨ä¸€ä¸ªä¸€ä¸ªå¯åŠ¨äº†</span><br><span class="line">[root@3dcd1060f3ab ~]# vi /start.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#æ¸²æŸ“å˜é‡åˆ°wp-config.php</span></span><br><span class="line">envsubst <span class="string">&#x27;$WORDPRESS_DB_NAME $WORDPRESS_DB_USER $WORDPRESS_DB_PASSWORD $WORDPRESS_DB_HOST&#x27;</span> &lt; /code/wordpress/wp-config-sample.php &gt; /code/wordpress/wp-config.php</span><br><span class="line"><span class="built_in">chown</span> -R  www.www /code/</span><br><span class="line">/usr/sbin/php-fpm  --fpm-config /etc/php-fpm.conf</span><br><span class="line"><span class="comment">#è„šæœ¬é‡Œé¢å¿…é¡»æœ‰ä¸€ä¸ªå¡åœ¨ï¼Œå“ªä¸ªå¡åœ¨éƒ½å¯ä»¥</span></span><br><span class="line">/sbin/nginx -g <span class="string">&#x27;daemon off;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">14ã€è¾“å…¥æ­¤æ—¶å¯ä»¥æ‰“åŒ…äº†ï¼Œä½†æ˜¯æ‰“åŒ…å‡ºæ¥çš„é•œåƒå¾ˆå¤§ï¼Œéœ€è¦ä¼˜åŒ–ä¸€ä¸‹</span><br><span class="line">[root@3dcd1060f3ab ~]# <span class="built_in">rm</span> -rf /code/wordpress-5.9.10.tar.gz</span><br><span class="line">[root@3dcd1060f3ab ~]# yum clean all</span><br><span class="line">åˆ é™¤æ‰€æœ‰yumæºï¼Œä»¥åç”¨ä¸åˆ°çš„ï¼Œè¿™ä¸ªå°±æ˜¯wordpress</span><br><span class="line">[root@3dcd1060f3ab ~]# <span class="built_in">rm</span> -rf /etc/yum.repos.d/* </span><br><span class="line">å¦‚æœæœ‰ä¸‹è½½wgetä¸‹è½½ä¸œè¥¿ï¼Œéƒ½è¦å¸è½½æ‰ï¼Œä»¥åç”¨ä¸åˆ°çš„</span><br><span class="line"></span><br><span class="line">15ã€æ‰“å¼€æ–°çª—å£ï¼Œå°†å®¹å™¨æ‰“åŒ…</span><br><span class="line">[root@docker01 ~]# docker commit wp_base wordpress:v1</span><br><span class="line">[root@docker02 ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">wordpress    v1        23e066cac691   2 seconds ago   586MB</span><br><span class="line"></span><br><span class="line">16ã€åˆ é™¤æ•°æ®åº“æ•°æ®ç›®å½•ï¼Œä¸ç„¶ç¬¬äºŒæ¬¡å¯åŠ¨ä¸èƒ½å»ºåº“ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡çš„æ•°æ®å·²ç»æŒä¹…åŒ–äº†</span><br><span class="line">[root@docker02 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line"></span><br><span class="line">17ã€è¿è¡Œå¸¦å˜é‡çš„å®¹å™¨</span><br><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œwordpresså®¹å™¨</span></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wp_db \</span><br><span class="line">-d wordpress:v3 /bin/sh /start.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„é•œåƒ</span></span><br><span class="line">[root@docker02 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED             STATUS             PORTS                                                  NAMES</span><br><span class="line">71439bdb8066   wordpress:v5   <span class="string">&quot;/bin/sh /start.sh&quot;</span>      5 seconds ago       Up 4 seconds       0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp                      wp</span><br><span class="line">c6eefe3b5358   mysql:5.7.44   <span class="string">&quot;docker-entrypoint.sâ€¦&quot;</span>   49 minutes ago      Up 49 minutes      0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp   mysql57</span><br><span class="line">4f798d07ace2   centos:7       <span class="string">&quot;/bin/bash&quot;</span>              About an hour ago   Up About an hour                                                          wp_base</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">18ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.102</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240904193619359.png" alt="image-20240904193619359"></p><p>é€šè¿‡å¡«å†™æ•°æ®åº“ä¿¡æ¯çš„é¡µé¢ï¼Œç›´æ¥æ¥çš„ä¸»ä»é¡µé¢</p><p><img src="../image/study_img/image-20240904194031698.png" alt="image-20240904194031698"></p><p><strong>æŠ¥é”™é—®é¢˜</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1ã€dockeræ­£å¸¸å¯åŠ¨ï¼Œå®¹å™¨é‡Œé¢çš„æœåŠ¡éƒ½æ­£å¸¸å¯åŠ¨,ç«¯å£æ˜ å°„ä¹Ÿæ²¡é—®é¢˜ï¼Œè®¿é—®ç½‘é¡µæ‰¾ä¸åˆ°é¡µé¢</span></span><br><span class="line">æ˜¯å› ä¸ºå¤–é¢çš„è¯·æ±‚ä¸èƒ½åˆ°åº•å®¹å™¨</span><br><span class="line"></span><br><span class="line"><span class="comment">#è§£å†³åŠæ³•ï¼š</span></span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line">systemctl restart network</span><br><span class="line"></span><br><span class="line"><span class="comment">#2ã€wpç ´å›¾</span></span><br><span class="line">1ã€æŸ¥çœ‹é”™è¯¯æ—¥å¿—</span><br><span class="line">[root@1a60046efc86 wordpress]# tailf /var/log/nginx/error.log </span><br><span class="line">2024/09/05 12:45:49 [crit] 16#16: *432 open() <span class="string">&quot;/var/lib/nginx/tmp/fastcgi/8/01/0000000018&quot;</span> failed (13: Permission denied) <span class="keyword">while</span> reading upstream, client: 10.0.0.1, server: _, request: <span class="string">&quot;GET /wp-admin/site-editor.php?postType=wp_template&amp;postId=twentytwentytwo%2F%2Fhome HTTP/1.1&quot;</span>, upstream: <span class="string">&quot;fastcgi://127.0.0.1:9000&quot;</span>, host: <span class="string">&quot;10.0.0.102&quot;</span>, referrer: <span class="string">&quot;http://10.0.0.102/&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Nginx ä¿®æ”¹äº†é»˜è®¤é…ç½®ï¼Œä¸æ˜¯ä»¥ nginx æˆ– root ç”¨æˆ·æ¥è¿è¡Œ Nginxï¼ˆä¸»è¦çš„åŸå› ï¼‰</span><br><span class="line">è¿™ä¸ªç›®å½•æ²¡æœ‰æƒé™å»è®¿é—®ï¼š/var/lib/nginx/tmp ç›®å½•ä¸»è¦æ˜¯ç”¨æ¥å­˜æ”¾ä¸´æ—¶çš„ç¼“å­˜æ–‡ä»¶ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯ Nginx çš„åå‘ä»£ç†ï¼Œå½“æˆ‘ä»¬ä¸Šä¼ æ–‡ä»¶çš„æ—¶å€™ä¼šå…ˆæŠŠæ–‡ä»¶å†™å…¥ Nginx çš„ /var/lib/nginx/tmp/client_body ç›®å½•ï¼Œç„¶åå†é€šè¿‡ä»£ç†è½¬å‘åˆ°ç›®æ ‡ç³»ç»Ÿã€‚</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹ /var/lib/nginx/tmp çš„æƒé™ï¼Œä¼šå‘ç°è¿™ä¸ªç›®å½•é»˜è®¤çš„æ‰€æœ‰è€…æ˜¯ nginx:</span><br><span class="line">[root@1a60046efc86 wordpress]# ll /var/lib</span><br><span class="line">.....</span><br><span class="line">drwxr-xr-x 2 root root   6 Apr 11  2018 misc</span><br><span class="line">drwxrwx--- 3 nginx root  17 Sep  5 11:52 nginx <span class="comment">#æƒé™ä¸å¯¹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€ä¿®æ”¹æƒé™</span><br><span class="line">[root@1a60046efc86 wordpress]# <span class="built_in">chown</span> -R www.www /var/lib/nginx/</span><br><span class="line">[root@1a60046efc86 wordpress]# ll /var/lib</span><br><span class="line">......</span><br><span class="line">drwxrwx--- 1 www  www   17 Sep  5 11:52 nginx</span><br><span class="line"></span><br><span class="line">4ã€å†æ¬¡è®¿é—®ï¼Œåˆ·æ–°æ…¢ä¸€ç‚¹ï¼ŒåŠ é‡ä¸€ä¸‹ï¼Œå°±ä¸ä¼šç ´å›¾äº†</span><br></pre></td></tr></table></figure><h3 id="4ã€Dockerè‡ªåŠ¨åŒ–æ„å»ºé•œåƒ">4ã€<strong>Dockerè‡ªåŠ¨åŒ–æ„å»ºé•œåƒ</strong></h3><p>æ‰‹åŠ¨æ„å»ºé•œåƒçš„ç¼ºé™·<br>1.ä½“ç§¯å¤ªå¤§<br>2.å¯åŠ¨ä¸æ–¹ä¾¿<br>3.æ— æ³•ç›´æ¥ä¿®æ”¹CMD<br>4.æ²¡æœ‰å£°æ˜ç«¯å£<br>5ã€æ²¡æœ‰å£°æ˜å¯æ˜ å°„ç›®å½•</p><h3 id="5ã€Dockerfileçš„ä»‹ç»">5ã€<strong>Dockerfileçš„ä»‹ç»</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Dockerile æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºé•œåƒçš„æ–‡æœ¬æ–‡ä»¶ï¼Œæ–‡æœ¬å†…å®¹åŒ…å«äº†ä¸€æ¡æ¡æ„å»ºé•œåƒæ‰€éœ€çš„æŒ‡ä»¤å’Œè¯´æ˜ã€‚å£°æ˜å¼çš„è„šæœ¬ï¼Œå°†é•œåƒæ„å»ºå†…å®¹ï¼Œå†™å…¥è„šæœ¬ä¸­å³å¯ã€‚</span><br><span class="line"></span><br><span class="line">é•œåƒ:ä¸­è¯</span><br><span class="line">dockerfileï¼šé…æ–¹</span><br><span class="line">dockerfileï¼šå¸¸ç”¨æŒ‡ä»¤</span><br></pre></td></tr></table></figure><p>dockerfileçš„æŒ‡ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FROMï¼šæŒ‡å®šä¸€ä¸ªåŸºç¡€é•œåƒ</span><br><span class="line">RUNï¼š æŒ‡å®šç³»ç»Ÿå‘½ä»¤</span><br><span class="line">CMDï¼š æŒ‡å®šè¿è¡Œå®¹å™¨PIDä¸º1çš„è¿›ç¨‹å‘½ä»¤   </span><br><span class="line">ENTRYPOINTï¼šæŒ‡å®šè¿è¡Œå®¹å™¨PIDä¸º1çš„è¿›ç¨‹å‘½ä»¤ /bin/sh /start.sh</span><br><span class="line"></span><br><span class="line">ADDï¼š å°†å®¿ä¸»æœºä¸Šé¢çš„æ–‡ä»¶docker <span class="built_in">cp</span>åˆ°å®¹å™¨ä¸­(ä¼šè‡ªåŠ¨è§£å‹ï¼Œä¸€èˆ¬ä¼ å‹ç¼©åŒ…,é‡Œé¢ä¸ä¼šä¼ å‹ç¼©åŒ…ï¼Œä¹‹åä¼ è§£å‹åçš„åŒ…)</span><br><span class="line">COPYï¼šå°†å®¿ä¸»æœºä¸Šé¢çš„æ–‡ä»¶docker <span class="built_in">cp</span>åˆ°å®¹å™¨ä¸­(ä¸ä¼šè‡ªåŠ¨å‹ï¼Œä¸€èˆ¬ä¼ é…ç½®æ–‡ä»¶)</span><br><span class="line">WORKDIRï¼šæŒ‡å®šä¸€ä¸ªå·¥ä½œç›®å½•ï¼Œdocker <span class="built_in">exec</span>è¿æ¥è¿›å»æ—¶ï¼Œè‡ªåŠ¨è¿›å…¥è¯¥ç›®å½•ä¸‹</span><br><span class="line">EXPOSEï¼šå£°æ˜é•œåƒè¦æš´éœ²çš„ç«¯å£</span><br><span class="line">VOLUMEï¼š å£°æ˜å¯æ˜ å°„çš„æ•°æ®å·</span><br><span class="line">ENVï¼šå£°æ˜é»˜è®¤ç¯å¢ƒå˜é‡(sshçš„å¯†ç ,æ•°æ®åº“çš„å¯†ç )é•œåƒçš„å±æ€§æ ‡ç­¾</span><br><span class="line"></span><br><span class="line">LABELï¼šæ‰“æ ‡ç­¾</span><br><span class="line">MAINTAINERï¼šå£°æ˜ç®¡ç†è€…æ ‡è¯†</span><br></pre></td></tr></table></figure><h3 id="6ã€è‡ªåŠ¨åŒ–æ„å»ºwordpress">6ã€<strong>è‡ªåŠ¨åŒ–æ„å»ºwordpress</strong></h3><p>1ã€å‡†å¤‡éœ€è¦çš„é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1ã€è¿è¡Œå¸¦æœ‰é…ç½®æ–‡ä»¶çš„å®¹å™¨ï¼Œè¿›å…¥å®¹å™¨ï¼Œå°†éœ€è¦çš„é…ç½®æ–‡ä»¶æ‹‰å‡ºå»</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">exec</span> -it 40b99669a1 /bin/bash</span><br><span class="line"></span><br><span class="line">2ã€åˆ›å»ºæ‰€éœ€æ–‡ä»¶å­˜æ”¾çš„ç›®å½•</span><br><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> -p /code/wordpress/</span><br><span class="line"></span><br><span class="line">3ã€æ‹‰å–å®¹å™¨é‡Œé¢çš„é…ç½®æ–‡ä»¶</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> 40b99669a160:/etc/nginx/nginx.conf /code/wordpress/</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> 40b99669a160:/etc/nginx/conf.d/wp.conf /code/wordpress/ </span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> 40b99669a160:/etc/php-fpm.d/www.conf /code/wordpress/</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> 40b99669a160:/code/wordpress/wp-config-sample.php /code/wordpress/</span><br><span class="line"></span><br><span class="line">4ã€å‡†å¤‡è¿™äº›æ–‡ä»¶,æ£€æŸ¥é…ç½®æ–‡ä»¶éƒ½å®‰è£…æ‰€éœ€è¦æ±‚æ›´æ”¹ok</span><br><span class="line">[root@docker01 ~]# ll /code/wordpress/</span><br><span class="line">-rw-r--r-- 1 root root  724 Sep  5 23:31 nginx.conf</span><br><span class="line">-rw-r--r-- 1 root root  278 Sep  5 20:12 start.sh</span><br><span class="line">-rw-rw-rw- 1 root root  18M Sep  5 23:24 wordpress-5.9.10.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root  324 Sep  5 19:53 wp.conf</span><br><span class="line">-rw-r--r-- 1 root root 3.0K Sep  5 21:39 wp-config-sample.php</span><br><span class="line">-rw-r--r-- 1 root root  18K Sep  5 23:32 www.conf</span><br></pre></td></tr></table></figure><p>2ã€ç¼–å†™Dockerfile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™DockerFile</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cd</span> /code/wordpress/</span><br><span class="line">[root@docker01 wordpress]# vim Dockerfile</span><br><span class="line">FROM centos:7</span><br><span class="line">RUN  curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo</span><br><span class="line">RUN  curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">RUN  sed -i <span class="string">&quot;s@http://mirrors.aliyun.com@https://mirrors.huaweicloud.com@g&quot;</span> /etc/yum.repos.d/epel.repo</span><br><span class="line">RUN  <span class="built_in">echo</span> -e  <span class="string">&quot;[php-webtatic]\nname = PHP Repository\nbaseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/\ngpgcheck = 0&quot;</span>&gt; /etc/yum.repos.d/php.repo</span><br><span class="line">RUN  yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb nginx  gettext</span><br><span class="line">RUN  groupadd -g 666 www</span><br><span class="line">RUN  useradd -u 666 -g 666 -s /sbin/nologin -M www</span><br><span class="line">RUN  <span class="built_in">mkdir</span> /code</span><br><span class="line">COPY nginx.conf /etc/nginx/nginx.conf</span><br><span class="line">COPY www.conf /etc/php-fpm.d/www.conf</span><br><span class="line">COPY wp.conf /etc/nginx/conf.d/wp.conf</span><br><span class="line">ADD  wordpress-5.9.10.tar.gz  /code</span><br><span class="line">COPY wp-config-sample.php /code/wordpress/wp-config-sample.php</span><br><span class="line">RUN  <span class="built_in">chown</span> -R  www.www /code</span><br><span class="line">RUN  <span class="built_in">chown</span> -R www.www /var/lib/nginx</span><br><span class="line">COPY start.sh /start.sh</span><br><span class="line">RUN  <span class="built_in">rm</span> -rf /code/wordpress-5.9.10.tar.gz</span><br><span class="line">RUN  yum clean all</span><br><span class="line">RUN  <span class="built_in">rm</span> -rf /etc/yum.repos.d/* </span><br><span class="line">CMD  [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;/start.sh&quot;</span>]</span><br><span class="line">EXPOSE 80/tcp 8080/tcp</span><br><span class="line">WORKDIR /code/wordpress</span><br><span class="line">VOLUME  /code/wordpress</span><br><span class="line">ENV  WORDPRESS_DB_NAME=wp_db</span><br><span class="line">ENV  WORDPRESS_DB_USER=wp_user</span><br><span class="line">ENV  WORDPRESS_DB_PASSWORD=123</span><br><span class="line">ENV  WORDPRESS_DB_HOST=localhost</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#æ„å»º</span><br><span class="line">[root@docker01 wordpress]# docker build -t wordpress-df:v1 .</span><br><span class="line">[root@docker01 ~]# docker images</span><br><span class="line">REPOSITORY                      TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">wordpress-df                    v1        e389c28d9b3b   14 hours ago    831MB</span><br><span class="line"></span><br><span class="line">3ã€åˆ é™¤æ•°æ®åº“æ•°æ®ç›®å½•ï¼Œä¸ç„¶ç¬¬äºŒæ¬¡å¯åŠ¨ä¸èƒ½å»ºåº“ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡çš„æ•°æ®å·²ç»æŒä¹…åŒ–äº†</span><br><span class="line">[root@docker02 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line"></span><br><span class="line">4ã€è¿è¡Œå¸¦å˜é‡çš„å®¹å™¨</span><br><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œwordpresså®¹å™¨</span></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wp_db \</span><br><span class="line">-d wordpress-df:v1 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.101</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240906135218039.png" alt="image-20240906135218039"></p><p>3ã€ä¼˜åŒ–Dockerfileçš„åŸåˆ™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¼˜åŒ–åŸåˆ™:æ„å»ºçš„é•œåƒå°½å¯èƒ½å°,æ„å»ºé€Ÿåº¦å°½å¯èƒ½å¿«</span></span><br><span class="line">a: ä½¿ç”¨ä½“ç§¯å°çš„linuxé•œåƒalpineä½œä¸ºåŸºç¡€é•œåƒ</span><br><span class="line">bï¼šå°½å¯èƒ½çš„æ¸…ç†æ— ç”¨çš„ç¼“å­˜æ–‡ä»¶ï¼ˆå°½å¯èƒ½æŠŠå¤šä¸ªRUNåˆå¹¶ï¼‰</span><br><span class="line">cï¼šä¿®æ”¹dockerfileçš„æ—¶å€™ï¼Œå°½å¯èƒ½æŠŠä¿®æ”¹çš„å†…å®¹æ”¾åœ¨æœ€å</span><br><span class="line">dï¼šä½¿ç”¨.dockerignoreå¿½ç•¥æ„å»ºdockeré•œåƒæ—¶ï¼Œä¸éœ€è¦çš„æ–‡ä»¶</span><br><span class="line">f:ä½¿ç”¨\å‡å°‘ä¸å¿…è¦çš„æ–‡ä»¶RUNæˆ–ADD</span><br><span class="line"></span><br><span class="line">å±‚æ•°å¤šä¸ä»£è¡¨ä½“ç§¯å¤§ï¼Œå±‚æ•°å¤šå’Œé•œåƒé‡Œé¢çš„æœåŠ¡ï¼Œå‘½ä»¤ï¼Œå®‰è£…åŒ…æœ‰å…³ï¼Œå±‚æ•°å¤šæ˜¯å‘½ä»¤å¤šï¼Œä¸ä¼šè®©æ–‡ä»¶æ•°é‡ï¼Œæ–‡ä»¶å¤§å°å¢åŠ </span><br></pre></td></tr></table></figure><p>4ã€ä¼˜åŒ–Dockerfile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¼˜åŒ–DockerFile</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cd</span> /code/wordpress/</span><br><span class="line">[root@docker01 wordpress]# vim Dockerfile</span><br><span class="line">FROM centos:7</span><br><span class="line">RUN  curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo &amp;&amp; \</span><br><span class="line">sed -i <span class="string">&quot;s@http://mirrors.aliyun.com@https://mirrors.huaweicloud.com@g&quot;</span> /etc/yum.repos.d/epel.repo &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> -e  <span class="string">&quot;[php-webtatic]\nname = PHP Repository\nbaseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/\ngpgcheck = 0&quot;</span>&gt; /etc/yum.repos.d/php.repo &amp;&amp; \</span><br><span class="line">yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb nginx  gettext &amp;&amp; \</span><br><span class="line">groupadd -g 666 www &amp;&amp; \</span><br><span class="line">useradd -u 666 -g 666 -s /sbin/nologin -M www &amp;&amp; \</span><br><span class="line"><span class="built_in">mkdir</span> /code &amp;&amp; \</span><br><span class="line">yum clean all &amp;&amp; \</span><br><span class="line"><span class="built_in">rm</span> -rf /etc/yum.repos.d/*</span><br><span class="line">COPY nginx.conf /etc/nginx/nginx.conf</span><br><span class="line">COPY www.conf /etc/php-fpm.d/www.conf</span><br><span class="line">COPY wp.conf /etc/nginx/conf.d/wp.conf</span><br><span class="line">ADD  wordpress-5.9.10.tar.gz  /code</span><br><span class="line">COPY wp-config-sample.php /code/wordpress/wp-config-sample.php</span><br><span class="line">RUN  <span class="built_in">chown</span> -R  www.www /code &amp;&amp; \</span><br><span class="line"><span class="built_in">chown</span> -R www.www /var/lib/nginx</span><br><span class="line">COPY start.sh /start.sh</span><br><span class="line">CMD  [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;/start.sh&quot;</span>]</span><br><span class="line">EXPOSE 80/tcp 8080/tcp</span><br><span class="line">WORKDIR /code/wordpress</span><br><span class="line">VOLUME  /code/wordpress</span><br><span class="line">ENV  WORDPRESS_DB_NAME=wp_db</span><br><span class="line">ENV  WORDPRESS_DB_USER=wp_user</span><br><span class="line">ENV  WORDPRESS_DB_PASSWORD=123</span><br><span class="line">ENV  WORDPRESS_DB_HOST=localhost</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#æ„å»º</span><br><span class="line">[root@docker01 wordpress]# docker build -t wordpress-df:v1 .</span><br><span class="line">[root@docker01 ~]# docker images</span><br><span class="line">REPOSITORY                      TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">wordpress-df                    v2        1a14add5916b   11 seconds ago   530MB</span><br><span class="line"></span><br><span class="line">3ã€åˆ é™¤æ•°æ®åº“æ•°æ®ç›®å½•ï¼Œä¸ç„¶ç¬¬äºŒæ¬¡å¯åŠ¨ä¸èƒ½å»ºåº“ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡çš„æ•°æ®å·²ç»æŒä¹…åŒ–äº†</span><br><span class="line">[root@docker02 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line"></span><br><span class="line">4ã€è¿è¡Œå¸¦å˜é‡çš„å®¹å™¨</span><br><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œwordpresså®¹å™¨</span></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wp_db \</span><br><span class="line">-d wordpress-df:v2 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.101</span><br></pre></td></tr></table></figure><h3 id="7ã€åˆ¶ä½œzabbixé•œåƒ">7ã€<strong>åˆ¶ä½œzabbixé•œåƒ</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–ç›¸å…³é•œåƒ</span><br><span class="line">[root@docker01 ~]#  docker pull zabbix/zabbix-server-mysql</span><br><span class="line">[root@docker01 ~]#  docker pull zabbix/zabbix-web-nginx-mysql</span><br><span class="line">[root@docker01 ~]#  docker pull mysql:8.0</span><br><span class="line"></span><br><span class="line">2ã€#è¿è¡Œæ•°æ®åº“</span><br><span class="line">æ³¨æ„ï¼šå†æ¬¡å¯åŠ¨æ•°æ®åº“ä¹‹å‰å…ˆæ¸…ç©ºdataç›®å½•</span><br><span class="line"><span class="built_in">rm</span> -rf /data/mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run \</span><br><span class="line">--name mysql80 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=zabbix \</span><br><span class="line">-e MYSQL_USER=zabbix \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:8.0 \</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--character-set-server=utf8mb4 </span><br><span class="line">--collation-server=utf8mb4_bin </span><br><span class="line">--log_bin_trust_function_creators</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€yunxå®¹å™¨åŒ–zabbix-server</span><br><span class="line">docker run \</span><br><span class="line">--<span class="built_in">link</span> mysql80 \</span><br><span class="line">--name zabbix-server \</span><br><span class="line">-p 10051:10051 \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">&quot;mysql80&quot;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&quot;123&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-server-mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€å®¹å™¨åŒ–zabbix-web</span><br><span class="line">docker run \</span><br><span class="line">--<span class="built_in">link</span> zabbix-server \</span><br><span class="line">--<span class="built_in">link</span> mysql80 \</span><br><span class="line">--name zabbix-web \</span><br><span class="line">-p 80:8080 \</span><br><span class="line">-p 8443:8443 \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">&quot;mysql80&quot;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&quot;123&quot;</span> \</span><br><span class="line">-e ZBX_SERVER_HOST=<span class="string">&quot;zabbix-server&quot;</span> \</span><br><span class="line">-e PHP_TZ=<span class="string">&quot;Asia/Shanghai&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-web-nginx-mysql</span><br><span class="line"></span><br><span class="line">5ã€æ£€æŸ¥3ä¸ªå®¹å™¨æ˜¯å¦èµ·æ¥</span><br><span class="line">[root@docker01 ~]# docker ps </span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905101309249.png" alt="image-20240905101309249"></p><p><img src="../image/study_img/image-20240905100315171.png" alt="image-20240905100315171"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å‡ºç°ä»¥ä¸ŠæŠ¥é”™å°±æ˜¯mysql8.0å¯åŠ¨å‘½ä»¤åŠ å‚æ•°</span><br><span class="line">--log_bin_trust_funetion</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905143325160.png" alt="image-20240905143325160"></p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡æ±‡æ€»å¯¹é•œåƒçš„å¤šç§åˆ¶ä½œæ–¹æ³•ï¼Œè¿˜æ±‡æ€»ä½¿ç”¨dockerfileæ„å»ºé•œåƒï¼Œå¯¹é•œåƒçš„ä¼˜åŒ–</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>äºŒã€ğŸ¡Dockerå¯¹è±¡æ“ä½œ</title>
    <link href="https://www.fomal.cc/posts/8f4c40fd.html"/>
    <id>https://www.fomal.cc/posts/8f4c40fd.html</id>
    <published>2024-09-22T04:55:08.000Z</published>
    <updated>2024-09-22T07:53:34.214Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Dockerå¯¹è±¡æ“ä½œ">Dockerå¯¹è±¡æ“ä½œ</h2><h3 id="1ã€Dockeré•œåƒçš„æ“ä½œ"><strong>1ã€Dockeré•œåƒçš„æ“ä½œ</strong></h3><p>dockerå®˜ç½‘å¯»æ‰¾é•œåƒï¼š<a href="https://hub.docker.com/">https://hub.docker.com/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æœç´¢é•œåƒ  (é€‰é¡¹imageå¯ä»¥çœç•¥)</span></span><br><span class="line">[root@docker01 ~]# docker search nginx</span><br><span class="line">æˆ–è€…</span><br><span class="line">[root@docker01 ~]# docker image search nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ˜¾ç¤ºé•œåƒçš„å…³é”®è¿‡ç¨‹</span></span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">history</span> alpine</span><br><span class="line">IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT</span><br><span class="line">324bc02ae123   6 weeks ago   /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/bin/sh&quot;]              0B        </span></span><br><span class="line">&lt;missing&gt;      6 weeks ago   /bin/sh -c <span class="comment">#(nop) ADD file:99093095d62d04215â€¦   7.8MB  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‹‰å–é•œåƒï¼š (é€‰é¡¹imageå¯ä»¥çœç•¥)</span></span><br><span class="line">docker pull ä»åº“å:æ ‡ç­¾å   (ä¸åŠ æ ‡ç­¾é»˜è®¤æ‹‰å–latestç‰ˆæœ¬çš„)</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker pull nginx:alpine </span><br><span class="line">æˆ–è€…</span><br><span class="line">[root@docker01 ~]# docker image pull nginx:alpine</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker pull nginx:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æ‹‰å–åˆ°çš„é•œåƒ</span></span><br><span class="line">[root@docker01 ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">nginx        alpine    0f0eda053dc5   2 weeks ago     43.3MB</span><br><span class="line">nginx        latest    5ef79149e0ec   2 weeks ago     188MB</span><br><span class="line">alpine       latest    324bc02ae123   6 weeks ago     7.8MB</span><br><span class="line">busybox      latest    87ff76f62d36   15 months ago   4.26MB</span><br><span class="line">centos       6         5bf9684f4720   2 years ago     194MB</span><br><span class="line">centos       7         eeb6ee3f44bd   2 years ago     204MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ é™¤é•œåƒ  rmi     (ä¸åŠ æ ‡ç­¾ï¼Œé»˜è®¤åˆ é™¤latest)</span></span><br><span class="line">[root@docker01 ~]# docker rmi centos:6  </span><br><span class="line">æˆ–è€…</span><br><span class="line">[root@docker01 ~]# docker image <span class="built_in">rm</span> centos:6 </span><br><span class="line">æˆ–è€…</span><br><span class="line">[root@docker01 ~]# docker rmi 5bf9684f4720</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯¼å‡ºé•œåƒ(ä¸€æ¬¡åªèƒ½å¯¼å‡ºä¸€ä¸ª)</span></span><br><span class="line">[root@docker01 ~]# docker save centos:7 -o /tmp/c7.tgz</span><br><span class="line">-oï¼šoutput è¾“å‡º</span><br><span class="line">æˆ–è€…</span><br><span class="line">[root@docker01 ~]# docker save centos:7 &gt; /tmp/c7_2.tgz</span><br><span class="line">&gt;ï¼šé‡å®šå‘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# ll /tmp/ -h</span><br><span class="line">-rw-r--r-- 1 root root 202M Sep  3 14:22 c7_2.tgz</span><br><span class="line">-rw------- 1 root root 202M Sep  3 14:21 c7.tgz</span><br><span class="line">-rw------- 1 root root 202M Sep  3 14:35 eeb6ee3f44bd.tgz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯¼å…¥é•œåƒ</span></span><br><span class="line">[root@docker01 ~]# scp /tmp/c7.tgz  172.16.1.102:/tmp</span><br><span class="line"></span><br><span class="line">[root@docker02 ~]# docker image load -i /tmp/c7.tgz</span><br><span class="line">-iï¼šinput è¾“å…¥</span><br><span class="line">æˆ–è€…  &lt;ï¼šæ ‡æ³¨è¾“å…¥</span><br><span class="line">[root@docker02 ~]# docker image load &lt; /tmp/c7.tgz</span><br><span class="line"></span><br><span class="line">é•œåƒå±‚æ•°æ˜¯åˆ†å±‚çš„ï¼Œé•œåƒæœ‰ç›¸åŒçš„å±‚æ•°ï¼Œä¸ä¼šå ç”¨ç£ç›˜ç©ºé—´ï¼Œå†æ¬¡æŠŠc7_2.tgzå¯¼è¿›å»ä¸ä¼šé‡å¤ï¼Œä¸ä¼šå ç”¨ç£ç›˜ç©ºé—´ï¼Œä»–ä¼šè‡ªåŠ¨è¯†åˆ«åˆ°æ˜¯åŒä¸€ä¸ªå±‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æˆ–è€…ä½¿ç”¨IDæ¥å¯¼å‡º(ä¸æ¨èï¼Œå› ä¸ºå¯¼å…¥åˆ°æ–°ç¯å¢ƒçš„æ—¶å€™æ²¡æœ‰åå­—)</span><br><span class="line">[root@docker01 ~]# docker save  eeb6ee3f44bd -o /tmp/eeb6ee3f44bd.tgz</span><br><span class="line">[root@docker01 ~]# scp /tmp/eeb6ee3f44bd.tgz 172.16.1.103:/tmp</span><br><span class="line"></span><br><span class="line">[root@docker03 ~]# docker image load -i /tmp/eeb6ee3f44bd.tgz </span><br><span class="line">[root@docker03 ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">&lt;none&gt;       &lt;none&gt;    eeb6ee3f44bd   2 years ago   204MB</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç»™é•œåƒåŠ æ ‡ç­¾(æ”¹å)</span></span><br><span class="line">docker tag IDå· é•œåƒå:æ ‡ç­¾</span><br><span class="line"></span><br><span class="line">[root@docker03 ~]# docker tag eeb6ee3f44bd centos:7</span><br><span class="line">[root@docker03 ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">centos       7         eeb6ee3f44bd   2 years ago   204MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹é•œåƒçš„è¯¦ç»†ä¿¡æ¯(å¸¸ç”¨)</span></span><br><span class="line">[root@docker02 ~]# docker inspect nginx:alpine</span><br></pre></td></tr></table></figure><h3 id="2ã€Dockerå®¹å™¨çš„æ“ä½œ"><strong>2ã€Dockerå®¹å™¨çš„æ“ä½œ</strong></h3><p>Docker å®¹å™¨æ“ä½œçš„é€‰é¡¹</p><table><thead><tr><th>é€‰é¡¹</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>â€“name</td><td>è‡ªå®šä¹‰å®¹å™¨å</td></tr><tr><td>-d</td><td>å°†å®¹å™¨æ”¾åå°å¯åŠ¨</td></tr><tr><td>-it   (input   TTY)</td><td>åˆ†é…ä¸€ä¸ªäº¤äº’å¼çš„ç»ˆç«¯</td></tr><tr><td>-p</td><td>ç«¯å£æ˜ å°„</td></tr><tr><td>-P</td><td>æ˜ å°„éšæœºç«¯å£</td></tr><tr><td>-v</td><td>æ•°æ®å·æ˜ å°„</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®¹å™¨è¿è¡Œçš„åŸåˆ™ï¼š</span></span><br><span class="line">1ã€ä¸€ä¸ªå®¹å™¨æœ€å¥½åªåšä¸€ä»¶äº‹</span><br><span class="line">(æ¯”å¦‚è¯´æ­wp,æœ€ånginxè·‘ä¸€ä¸ªå®¹å™¨,mysqlè·‘ä¸€ä¸ªå®¹å™¨,phpè·‘ä¸€ä¸ªå®¹å™¨,æœ€å¥½åˆ†å¼€ï¼Œå¦‚æœæƒ³è¦ä¸€ä¸ªå®¹å™¨è·‘å¤šä¸ªåº”ç”¨ï¼Œéœ€è¦è§£å†³æ¨ªå‘æ‰©å±•çš„é—®é¢˜)</span><br><span class="line">2ã€å®¹å™¨è¿è¡Œå¿…é¡»ä¿è¯å®¹å™¨å†…PIDä¸º1çš„è¿›ç¨‹ä¸€ç›´å­˜åœ¨</span><br><span class="line"></span><br><span class="line">PIDä¸º1çš„è¿›ç¨‹æ˜¯è°å†³å®šçš„ï¼š</span><br><span class="line">1ã€docker runè¿è¡Œå®¹å™¨ååŠ çš„å‘½ä»¤</span><br><span class="line">2ã€å¦‚æœåœ¨è¿è¡Œå®¹å™¨æ—¶æ²¡æœ‰åŠ ä»»ä½•å‘½ä»¤ï¼Œåˆ™ä»¥å®¹å™¨é•œåƒä¸­çš„CMDä¸­çš„å‘½ä»¤ä½œä¸ºPIDä¸º1çš„</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€#è¿è¡Œalpineå®¹å™¨</span><br><span class="line">[root@docker03 ~]# docker run alpine /bin/echo <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨</span><br><span class="line">[root@docker02 ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">1ed0569ef98e   alpine    <span class="string">&quot;/bin/echo &#x27;hello woâ€¦&quot;</span>   9 seconds ago    Exited (0) 9 seconds ago             affectionate_curie</span><br><span class="line">a1b13ddd5328   alpine    <span class="string">&quot;echo hello world&quot;</span>       19 seconds ago   Created                              goofy_bartik</span><br><span class="line">-aï¼šæŸ¥çœ‹æ‰€æœ‰å®¹å™¨</span><br><span class="line">[root@docker02 ~]# docker ps -aq</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œä¸€ä¸ªå®¹å™¨</span></span><br><span class="line">docker run [1ä¸ªæˆ–è€…å¤šä¸ªé€‰é¡¹]  é•œåƒ [<span class="built_in">command</span>]</span><br><span class="line">[root@docker02 ~]# docker run centos:7 /bin/bash</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker run -it -d  busybox  /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#è®©å®¹å™¨åœ¨åå°è¿è¡Œ</span></span><br><span class="line">[root@docker03 ~]# docker run -d centos:7 tailf /etc/passwd</span><br><span class="line"></span><br><span class="line">[root@docker03 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE      COMMAND               CREATED          STATUS          PORTS     NAMES</span><br><span class="line">29d1fc5f02e3   centos:7   <span class="string">&quot;tailf /etc/passwd&quot;</span>   28 seconds ago   Up 28 seconds             vibrant_ritchie</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œå®¹å™¨æ—¶ç»™å®¹å™¨èµ·ä¸€ä¸ªåå­—</span></span><br><span class="line">[root@docker03 ~]# docker run --name wordpress -d nginx:alpine</span><br><span class="line">[root@docker03 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">c13fdc5ac70e   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   18 seconds ago   Up 17 seconds   80/tcp    wordpress</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œä¸€ä¸ªé•œåƒå¹¶è¿è¿›å»</span></span><br><span class="line">[root@docker03 ~]# docker run -it centos:7 /bin/bash</span><br><span class="line"></span><br><span class="line">3ã€#è¿æ¥ä¸€ä¸ªå®¹å™¨</span><br><span class="line">å¦‚æœ/bin/bashä¸èƒ½è¿æ¥è¿›å»ï¼Œå°±æ¢æˆ/bin/sh</span><br><span class="line">[root@docker03 ~]# docker <span class="built_in">exec</span> -it 29d1fc5f02e3 /bin/bash</span><br><span class="line">æŸ¥çœ‹PIDä¸º1çš„è¿›ç¨‹</span><br><span class="line">[root@29d1fc5f02e3 /]# ps -aux</span><br><span class="line">USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root          1  0.0  0.0   4364   584 ?        Ss   07:11   0:00 tailf /etc/passwd</span><br><span class="line"></span><br><span class="line">--------docker run å¸®æˆ‘ä»¬åšäº†å“ªäº›äº‹-----</span><br><span class="line">[root@docker02 ~]# docker run nginx:alpine</span><br><span class="line"></span><br><span class="line">1ã€æ‹‰é•œåƒ</span><br><span class="line">docker pull nginx:alpine</span><br><span class="line">2ã€åˆ›å»ºå®¹å™¨</span><br><span class="line">docker create nginx:alpine</span><br><span class="line">3ã€å¯åŠ¨å®¹å™¨</span><br><span class="line">docker start 29d1fc5f02e3</span><br><span class="line">--------------------------------</span><br><span class="line"></span><br><span class="line">4ã€#åœæ­¢å®¹å™¨</span><br><span class="line">[root@docker03 ~]# docker ps</span><br><span class="line">[root@docker03 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE      COMMAND               CREATED          STATUS          PORTS     NAMES</span><br><span class="line">29d1fc5f02e3   centos:7   <span class="string">&quot;tailf /etc/passwd&quot;</span>   17 minutes ago   Up 17 minutes             vibrant_ritchie</span><br><span class="line"></span><br><span class="line">åŠ åå­—</span><br><span class="line">[root@docker03 ~]# docker stop vibrant_ritchie</span><br><span class="line">vibrant_ritchie</span><br><span class="line">æˆ–è€… åŠ ID</span><br><span class="line">[root@docker03 ~]# docker stop 29d1fc5f02e3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€#åˆ é™¤å®¹å™¨</span><br><span class="line">docker <span class="built_in">rm</span> -f [container <span class="built_in">id</span>]    </span><br><span class="line"></span><br><span class="line">[root@docker03 ~]# docker <span class="built_in">rm</span> 29d1fc5f02e3</span><br><span class="line">[root@docker03 ~]# docker <span class="built_in">rm</span> -f 29d1fc5f02e3</span><br><span class="line"><span class="comment">#(å¼ºåˆ¶åˆ é™¤  -f )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰¹é‡åˆ é™¤</span></span><br><span class="line">[root@docker03 ~]# docker <span class="built_in">rm</span> -f $(docker ps -q)</span><br><span class="line">æ‰¹é‡åˆ é™¤åœæ­¢è¿è¡Œçš„å®¹å™¨ -aq</span><br><span class="line">[root@docker03 ~]# docker <span class="built_in">rm</span> -f $(docker ps -aq)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6ã€#ä»£ç çš„ä¸Šä¼ å’Œæ‹‰å–</span><br><span class="line"><span class="comment">#å°†ä»£ç ä¸Šä¼ åˆ°å®¹å™¨</span></span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> 1.txt 74ce711a7128:/root</span><br><span class="line"></span><br><span class="line"><span class="comment">#å°†å®¹å™¨é‡Œé¢çš„ä»£ç ä¸‹è½½åˆ°æœ¬åœ°</span></span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> 74ce711a7128:/etc/passwd ./</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ä½¿ç”¨å‘½ä»¤å°†nginxå¯åŠ¨å¹¶ä¸”å¡ä½ï¼Œå®¹å™¨å°±ä¸ä¼šç»“æŸ</span><br><span class="line">[root@docker03 ~]# nginx -g <span class="string">&#x27;daemon off;&#x27;</span></span><br></pre></td></tr></table></figure><p>æŠ¥é”™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1ã€æŸ¥çœ‹é•œåƒ</span><br><span class="line">[root@docker02 ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">alpine       latest    324bc02ae123   6 weeks ago   7.8MB</span><br><span class="line"></span><br><span class="line">2ã€åˆ é™¤é•œåƒï¼ŒæŠ¥é”™</span><br><span class="line">[root@docker02 ~]# docker rmi 324bc02ae123</span><br><span class="line">Error response from daemon: conflict: unable to delete 324bc02ae123 (must be forced) - image is being used by stopped container a1b13ddd5328</span><br><span class="line"></span><br><span class="line">3ã€åˆ é™¤ä¾èµ–çš„å®¹å™¨</span><br><span class="line">[root@docker02 ~]# docker ps -a | grep <span class="string">&quot;alpine&quot;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs docker <span class="built_in">rm</span></span><br><span class="line">1ed0569ef98e</span><br><span class="line">a1b13ddd5328</span><br><span class="line"></span><br><span class="line">4ã€åˆ é™¤é•œåƒ</span><br><span class="line">[root@docker02 ~]# docker rmi 324bc02ae123</span><br></pre></td></tr></table></figure><h3 id="3ã€å®¹å™¨çš„ç«¯å£æ˜ å°„">3ã€<strong>å®¹å™¨çš„ç«¯å£æ˜ å°„</strong></h3><p>å®¹å™¨éœ€è¦åšç«¯å£æ˜ å°„æ‰èƒ½è®©å¤–ç•Œè®¿é—®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ç«¯å£æ˜ å°„</span><br><span class="line">   -p å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£</span><br><span class="line">   -P å®¿ä¸»æœºIP:å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£  (å¤šä¸ªå®¹å™¨éƒ½æƒ³ä½¿ç”¨80ç«¯å£)</span><br><span class="line">   -p å®¿ä¸»æœºIP::å®¹å™¨ç«¯å£(éšæœºç«¯å£)</span><br><span class="line">   -p å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£/udp (ä½†æ˜¯ä¸€èˆ¬TCPçš„æ¯”è¾ƒå¤š)</span><br><span class="line">   -p å®¿ä¸»æœºIP::å®¹å™¨ç«¯å£/udpä½¿ç”¨å®¿ä¸»æœºçš„10.0.8.183è¿™ä¸ªipåœ°å€çš„éšæœºç«¯å£çš„udpåè®®æ˜ å°„å®¹å™¨çš„udp53ç«¯å£</span><br><span class="line">   -p 81:80 -p 443:443 å¯ä»¥æŒ‡å®šå¤šä¸ª-p</span><br><span class="line">   -p 80-88:80-88 ç«¯å£èŒƒå›´æ˜ å°„</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">1ã€#  -pï¼šæŠŠå®¹å™¨çš„80ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„80ç«¯å£</span><br><span class="line">[root@docker03 ~]# docker run -p80:80 -d nginx:alpine</span><br><span class="line"></span><br><span class="line">[root@docker03 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                               NAMES</span><br><span class="line">92e2dbca064e   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   9 seconds ago    Up 8 seconds    0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   adoring_hertz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æµè§ˆå™¨è®¿é—®10.0.0.103ï¼Œå°±å¯ä»¥è®¿é—®nginxé¡µé¢</span><br><span class="line"></span><br><span class="line">2ã€</span><br><span class="line">[root@docker03 ~]# docker run -p8080:80 -p90:90 -d nginx:alpine</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹å®¿ä¸»æœºä¸Šæœ‰8080å’Œ90ç«¯å£</span><br></pre></td></tr></table></figure><p>-P å®¿ä¸»æœºIP:å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£    (é’ˆå¯¹ä¸åŒçš„IPï¼Œè®¿é—®ä¸åŒçš„å®¹å™¨ï¼Œå¤šä¸ªå®¹å™¨éƒ½æƒ³ä½¿ç”¨80ç«¯å£)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1ã€å…ˆæ¸…æ¥šä¹‹å‰å…è®¸çš„docker</span><br><span class="line">[root@docker03 ~]# docker <span class="built_in">rm</span> -f $(docker ps -q)</span><br><span class="line"></span><br><span class="line">2ã€ç«¯å£æ˜ å°„</span><br><span class="line">[root@docker03 ~]# docker run -p10.0.0.103:80:80 -d nginx:alpine</span><br><span class="line">[root@docker03 ~]# docker run -p172.16.1.103:80:80 -d nginx:alpine</span><br><span class="line">[root@docker03 ~]# docker run -p127.0.0.1:80:80 -d nginx:alpine</span><br><span class="line"></span><br><span class="line">[root@docker03 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                     NAMES</span><br><span class="line">7a87c542db29   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   25 seconds ago   Up 24 seconds   127.0.0.1:80-&gt;80/tcp      kind_mahavira</span><br><span class="line">a2d578ffff01   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   47 seconds ago   Up 46 seconds   172.16.1.103:80-&gt;80/tcp   interesting_joliot</span><br><span class="line">98e6d6611bd6   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   59 seconds ago   Up 58 seconds   10.0.0.103:80-&gt;80/tcp     interesting_jennings</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸åŒçš„ç½‘å¡ï¼Œä¸åŒçš„ip,è®¿é—®æ–¹å¼ä¸ä¸€æ ·</span></span><br><span class="line">æŸ¥çœ‹å®¹å™¨æ—¥å¿—</span><br><span class="line">[root@docker03 ~]# docker logs -f å®¹å™¨ID</span><br><span class="line">[root@docker03 ~]# docker logs -f å®¹å™¨å</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹10.0.0.103:80-&gt;80/tcpå®¹å™¨çš„è®¿é—®æ—¥å¿—</span><br><span class="line">[root@docker03 ~]# docker logs -f 98e6d6611bd6</span><br><span class="line">æµè§ˆå™¨è®¿é—®10.0.0.103ï¼Œå¯ä»¥çœ‹åˆ°æ—¥å¿—å˜åŒ–ï¼Œè¯·æ±‚è¿‡æ¥äº†</span><br><span class="line"></span><br><span class="line">4ã€æŸ¥çœ‹172.16.1.103:80-&gt;80/tcpå®¹å™¨çš„è®¿é—®æ—¥å¿—</span><br><span class="line">[root@docker03 ~]# docker logs -f a2d578ffff01</span><br><span class="line"></span><br><span class="line">æ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯ï¼Œä½¿ç”¨curlå‘½ä»¤è®¿é—®ï¼Œçœ‹åˆ°æ—¥å¿—æœ‰è¯·æ±‚å°±è®¿é—®æˆåŠŸ</span><br><span class="line">[root@docker03 ~]# curl 172.16.1.103</span><br><span class="line"></span><br><span class="line">5ã€æŸ¥çœ‹127.0.0.1:80-&gt;80/tcpå®¹å™¨çš„è®¿é—®æ—¥å¿—</span><br><span class="line">[root@docker03 ~]# docker logs  -f 7a87c542db29</span><br><span class="line">æ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯ï¼Œä½¿ç”¨curlå‘½ä»¤è®¿é—®ï¼Œçœ‹åˆ°æ—¥å¿—æœ‰è¯·æ±‚å°±è®¿é—®æˆåŠŸ</span><br><span class="line">[root@docker03 ~]# curl 127.0.0.1</span><br></pre></td></tr></table></figure><p>-p å®¿ä¸»æœºIP::å®¹å™¨ç«¯å£(éšæœºç«¯å£)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1ã€åœ¨å®¿ä¸»æœºä¸Šèµ·5ä¸ªéšæœºç«¯å£</span><br><span class="line">[root@docker03 ~]# docker run -p10.0.0.103::80 -d nginx:alpine</span><br><span class="line">[root@docker03 ~]# docker run -p10.0.0.103::80 -d nginx:alpine</span><br><span class="line">[root@docker03 ~]# docker run -p10.0.0.103::80 -d nginx:alpine</span><br><span class="line">[root@docker03 ~]# docker run -p10.0.0.103::80 -d nginx:alpine</span><br><span class="line">[root@docker03 ~]# docker run -p10.0.0.103::80 -d nginx:alpine</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹ç«¯å£</span><br><span class="line">[root@docker03 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED              STATUS              PORTS                      NAMES</span><br><span class="line">57ae53de8781   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   About a minute ago   Up About a minute   10.0.0.103:32776-&gt;80/tcp   distracted_tharp</span><br><span class="line">fe081b7a25ac   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   About a minute ago   Up About a minute   10.0.0.103:32775-&gt;80/tcp   kind_knuth</span><br><span class="line">2ed44ac6261f   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   About a minute ago   Up About a minute   10.0.0.103:32774-&gt;80/tcp   clever_sinoussi</span><br><span class="line">c009cf3348ff   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   About a minute ago   Up About a minute   10.0.0.103:32773-&gt;80/tcp   inspiring_hawking</span><br><span class="line">fe02a74ce3d2   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   About a minute ago   Up About a minute   10.0.0.103:32772-&gt;80/tcp   keen_yonath</span><br><span class="line"></span><br><span class="line">3ã€æµè§ˆå™¨è®¿é—®è¿™äº›é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°nginxæµ‹è¯•é¡µ</span><br><span class="line">10.0.0.103:32776</span><br><span class="line">10.0.0.103:32775</span><br><span class="line">10.0.0.103:32774</span><br><span class="line">10.0.0.103:32773</span><br><span class="line">10.0.0.103:32772</span><br></pre></td></tr></table></figure><p>-p 80-88:80-88 ç«¯å£èŒƒå›´æ˜ å°„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@docker03 ~]# docker run  -p81-85:81-85 -d nginx:alpine</span><br><span class="line"></span><br><span class="line">[root@docker03 ~]# netstat -lntup|grep <span class="string">&#x27;\b8[0-9]\b&#x27;</span></span><br><span class="line">tcp        0      0 0.0.0.0:81              0.0.0.0:*</span><br><span class="line">tcp        0      0 0.0.0.0:82              0.0.0.0:*</span><br><span class="line">tcp        0      0 0.0.0.0:83              0.0.0.0:*</span><br><span class="line">tcp        0      0 0.0.0.0:84              0.0.0.0:*</span><br><span class="line">tcp        0      0 0.0.0.0:85              0.0.0.0:*</span><br><span class="line">tcp6       0      0 :::81                   :::*     </span><br><span class="line">tcp6       0      0 :::82                   :::*     </span><br><span class="line">tcp6       0      0 :::83                   :::*     </span><br><span class="line">tcp6       0      0 :::84                   :::*     </span><br><span class="line">tcp6       0      0 :::85                   :::*     </span><br></pre></td></tr></table></figure><h3 id="4ã€æ¡ˆä¾‹ï¼šè¿è¡Œå®¹å™¨ï¼Œéƒ¨ç½²æ¸¸æˆä»£ç ">4ã€<strong>æ¡ˆä¾‹ï¼šè¿è¡Œå®¹å™¨ï¼Œéƒ¨ç½²æ¸¸æˆä»£ç </strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¸‹è½½ä»£ç </span><br><span class="line">[root@docker01 ~]# wget http://test.driverzeng.com/Nginx_Code/h5_games.zip</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œnginxå®¹å™¨</span><br><span class="line">[root@docker01 ~]# docker run -p80:80 -d nginx:alpine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹è¿è¡Œçš„PID</span><br><span class="line">[root@docker01 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED              STATUS              PORTS                               NAMES</span><br><span class="line">74ce711a7128   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   About a minute ago   Up About a minute   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   zealous_shaw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€æŸ¥çœ‹æ˜¯å¦å­˜åœ¨å·¥ä½œç›®å½•     çœ‹åˆ°ä¸å­˜åœ¨å·¥ä½œç›®å½•</span><br><span class="line">[root@docker01 ~]# docker inspect nginx:alpine</span><br><span class="line"></span><br><span class="line">5ã€è¿æ¥åˆ°å®¹å™¨é‡Œé¢ï¼ŒæŸ¥çœ‹ç«™ç‚¹ç›®å½•</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">exec</span> -it 74ce711a7128 /bin/sh</span><br><span class="line">/ <span class="comment"># vi /etc/nginx/conf.d/default.conf </span></span><br><span class="line"> root   /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">6ã€å°†ä»£ç ä¸Šä¼ </span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> h5_games.zip 74ce711a7128:/usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">7ã€è¿™æ¬¡è¿æ¥åˆ°å®¹å™¨é‡Œé¢</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">exec</span> -it 74ce711a7128 /bin/sh</span><br><span class="line">/ <span class="comment"># </span></span><br><span class="line">/ <span class="comment"># cd /usr/share/nginx/html/</span></span><br><span class="line">/usr/share/nginx/html <span class="comment"># unzip h5_games.zip </span></span><br><span class="line"></span><br><span class="line">/usr/share/nginx/html <span class="comment"># ls</span></span><br><span class="line">50x.html      __MACOSX      h5_games      h5_games.zip  index.html</span><br><span class="line"></span><br><span class="line">8ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.101/h5_games</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240903120700780.png" alt="image-20240903120700780"></p><p>ä»¥ä¸Šæ“ä½œéƒ½æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”å¦‚æœè¿™ä¸ªå®¹å™¨åäº†ï¼Œèµ·ä¸æ¥äº†ï¼Œéœ€è¦é‡å¤æ‰§è¡Œä»€ä¹ˆçš„æ“ä½œï¼Œ</p><p>æ–¹æ³•ä¸€ï¼šæŠŠæ­£åœ¨è¿è¡Œçš„å®¹å™¨æ‰“æˆä¸€ä¸ªé•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ–°å¼€ä¸€ä¸ªçª—å£æ“ä½œ</span><br><span class="line">[root@docker01 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                               NAMES</span><br><span class="line">76a4b880872b   nginx:alpine   <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   22 minutes ago   Up 22 minutes   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   funny_sinoussi</span><br><span class="line"></span><br><span class="line">2ã€#æŠŠæ­£åœ¨è¿è¡Œçš„å®¹å™¨æ‰“æˆä¸€ä¸ªé•œåƒ</span><br><span class="line">[root@docker01 ~]# docker commit 76a4b880872b h5:v1</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">h5           v1        6fcc45b1c065   51 seconds ago   89.9MB</span><br><span class="line"></span><br><span class="line">3ã€æŠŠæ­£åœ¨è¿è¡Œçš„å®¹å™¨åˆ é™¤</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">rm</span> -f $(docker ps -qa)</span><br><span class="line">76a4b880872b</span><br><span class="line"></span><br><span class="line">4ã€ç°åœ¨æ²¡æœ‰ä»»ä½•å®¹å™¨è¿è¡Œï¼Œå°†æ‰“çš„é•œåƒå¯¼å…¥</span><br><span class="line">å¯¼å…¥åœ¨æœ¬åœ°è¿è¡Œï¼šdocker run -p80:80 -d h5:v1</span><br><span class="line">å¯¼å‡ºåˆ°å…¶ä»–æœºå™¨è¿è¡Œï¼š</span><br><span class="line">docker save h5:v1 -o /tmp/h5.tgz</span><br><span class="line">scp /tmp/h5.tgz 10.0.0.102:/tmp</span><br><span class="line">docker load &lt; /tmp/h5.tgz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€è¿è¡Œå¯¼å…¥çš„å®¹å™¨</span><br><span class="line">[root@docker02 ~]# docker run -p80:80 -d h5:v1</span><br><span class="line"></span><br><span class="line">6ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.102/h5_games</span><br></pre></td></tr></table></figure><p>æ–¹æ³•äºŒï¼šå¯ä»¥ä½¿ç”¨æ–‡ä»¶æ˜ å°„</p><h3 id="5ã€Dockerå®¹å™¨æ–‡ä»¶æ˜ å°„">5ã€<strong>Dockerå®¹å™¨æ–‡ä»¶æ˜ å°„</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">-v ï¼šæ•°æ®å·æ˜ å°„ </span><br><span class="line">-v ï¼šå®¿ä¸»æœºç»å¯¹è·¯å¾„:å®¹å™¨ç»å¯¹è·¯å¾„  (å¸¸ç”¨)</span><br><span class="line">-v ï¼šå®¹å™¨ç›®å½•     <span class="comment">#åˆ›å»ºä¸€ä¸ªéšæœºå·,æ¥æŒä¹…åŒ–å®¹å™¨çš„ç›®å½•ä¸‹çš„æ•°æ®ï¼Œé€‚åˆä¿å­˜å˜åŒ–çš„æ•°æ®</span></span><br><span class="line">-v ï¼šå·å:å®¹å™¨ç›®å½• <span class="comment">#åˆ›å»ºä¸€ä¸ªå›ºå®šåå­—çš„å·,æ¥æŒä¹…åŒ–å®¹å™¨çš„ç›®å½•ä¸‹çš„æ•°æ®ï¼Œé€‚åˆæ•°æ®å…±äº«</span></span><br><span class="line"></span><br><span class="line">1ã€#åˆ¶ä½œä¸€ä¸ªæ•°æ®å·æ˜ å°„</span><br><span class="line">[root@docker02 ~]# docker run --name h5 -p 80:80 -v  /code/h5_games:/usr/share/nginx/html -d nginx:alpine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€codeç›®å½•ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œåªéœ€è¦å°†ä»£ç è§£å‹åˆ°codeç›®å½•</span><br><span class="line">[root@docker02 ~]# unzip h5_games.zip -d /code/</span><br><span class="line">[root@docker02 ~]# <span class="built_in">ls</span> /code/h5_games/</span><br><span class="line">ceshi  game  img  index.html  readme.txt</span><br><span class="line"></span><br><span class="line">3ã€è¿æ¥è¿›å»,å¹¶æŸ¥çœ‹ç«™ç‚¹ç›®å½•æ˜¯å¦å­˜åœ¨ä»£ç </span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it h5 /bin/sh</span><br><span class="line">/ <span class="comment"># ls /usr/share/nginx/html</span></span><br><span class="line">ceshi       game        img         index.html  readme.txt</span><br><span class="line"></span><br><span class="line">4ã€è®¿é—®ç½‘é¡µ</span><br><span class="line">10.0.0.102   å‡ºç°å°æ¸¸æˆçš„é¡µé¢å°±æ˜ å°„å®Œæˆ</span><br></pre></td></tr></table></figure><h3 id="6ã€æ‰‹åŠ¨åˆ¶ä½œh5å°æ¸¸æˆçš„é•œåƒ">6ã€<strong>æ‰‹åŠ¨åˆ¶ä½œh5å°æ¸¸æˆçš„é•œåƒ</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">1ã€è¿è¡Œä¸€ä¸ªåŸºç¡€é•œåƒå¹¶è¿è¿›å»</span><br><span class="line">[root@docker01 ~]# docker run -it centos:7 /bin/bash</span><br><span class="line"></span><br><span class="line">2ã€å› ä¸ºä½¿ç”¨centosé•œåƒï¼Œé‡Œé¢æ²¡æœ‰nginx,éœ€è¦å®‰è£…nginx</span><br><span class="line">[root@afc3071510f6 /]#  yum -y install nginx</span><br><span class="line">å‘ç°æ²¡æœ‰æº</span><br><span class="line"></span><br><span class="line">3ã€æ¢æº</span><br><span class="line">[root@afc3071510f6 /]#  curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo</span><br><span class="line">[root@afc3071510f6 /]#  curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"></span><br><span class="line">4ã€ä¼˜åŒ–æº</span><br><span class="line">[root@afc3071510f6 /]# vi /etc/yum.repos.d/CentOS-Base.repo  </span><br><span class="line">[updates]</span><br><span class="line">....</span><br><span class="line">enabled=0</span><br><span class="line"></span><br><span class="line">5ã€ä¸‹è½½nginx</span><br><span class="line">[root@afc3071510f6 /]# yum -y install nginx</span><br><span class="line"></span><br><span class="line">6ã€æ¸…ç©ºç«™ç‚¹ç›®å½•</span><br><span class="line">[root@afc3071510f6 /]# <span class="built_in">rm</span> -rf /usr/share/nginx/html/*</span><br><span class="line"></span><br><span class="line">7ã€æ–°å¼€ä¸€ä¸ªçª—å£ï¼Œå°†è§£å‹ä»£ç ä¸Šä¼ åˆ°å®¹å™¨çš„ç«™ç‚¹ç›®å½•</span><br><span class="line">root@docker01 ~]# unzip h5_games.zip </span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> h5_games afc3071510f6:/usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">8ã€å®¹å™¨æŸ¥çœ‹ä»£ç ä¸Šä¼ æˆåŠŸï¼Œå¹¶æŠŠä»£ç ç§»åŠ¨åˆ°ç«™ç‚¹ç›®å½•</span><br><span class="line">[root@afc3071510f6 /]# <span class="built_in">mv</span> /usr/share/nginx/html/h5_games/* /usr/share/nginx/html/</span><br><span class="line">[root@afc3071510f6 /]# <span class="built_in">ls</span> /usr/share/nginx/html/</span><br><span class="line">ceshi  game  h5_games  img  index.html  readme.txt</span><br><span class="line"></span><br><span class="line">9ã€å¯åŠ¨nginx  curlä¸€ä¸‹æ˜¯å¦æˆåŠŸ</span><br><span class="line">[root@afc3071510f6 /]# nginx</span><br><span class="line">[root@afc3071510f6 /]# curl 127.0.0.1</span><br><span class="line"></span><br><span class="line">10ã€å¦‚æœç°åœ¨é€€å‡ºè¿›è¡Œï¼Œè¿™ä¸ªå®¹å™¨å°±ä¼šé€€å‡ºï¼Œnginxå°±ä¼šç»“æŸï¼Œè¿™ä¸ªé•œåƒç›¸å½“äºæ²¡èµ·nginx,æ²¡æœ‰åŠæ³•è®©è¿™ä¸ªå®¹å™¨èµ·æ¥</span><br><span class="line">[root@docker01 ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE      COMMAND       CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">afc3071510f6   centos:7   <span class="string">&quot;/bin/bash&quot;</span>   24 minutes ago   Exited (0) 8 seconds ago             friendly_wozniak</span><br><span class="line"></span><br><span class="line">11ã€æ‰“é•œåƒ</span><br><span class="line">[root@docker01 ~]# docker commit afc3071510f6 h5_game:v2</span><br><span class="line"></span><br><span class="line">12ã€è¿è¡Œè¿™ä¸ªé•œåƒ</span><br><span class="line">[root@docker01 ~]# docker run --name h5 -p 80:80 -d h5_game:v2 /sbin/nginx -g <span class="string">&#x27;daemon off;&#x27;</span></span><br><span class="line"></span><br><span class="line">/sbin/nginxï¼šnginxå¯åŠ¨</span><br><span class="line">daemon off;ï¼šå¡ä¸»</span><br><span class="line"></span><br><span class="line">13ã€æµè§ˆå™¨è®¿é—®ç½‘é¡µ</span><br><span class="line"></span><br><span class="line">ç¼ºç‚¹ï¼š</span><br><span class="line">1.ä½“ç§¯å¤ªå¤§</span><br><span class="line">2.å¯åŠ¨ä¸æ–¹ä¾¿</span><br><span class="line">3.æ— æ³•ç›´æ¥ä¿®æ”¹CMD</span><br><span class="line">4.æ²¡æœ‰å£°æ˜ç«¯å£</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240903185831846.png" alt="image-20240903185831846"></p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡æ±‡æ€»å¯¹é•œåƒå’Œå®¹å™¨çš„ä¸€äº›åŸºæœ¬æ“ä½œï¼Œå¸Œæœ›å°ä¼™ä¼´å¯ä»¥è·Ÿç€æ–‡ç« ç»ƒä¹ åï¼Œä¼šå¯¹é•œåƒå’Œå®¹å™¨æœ‰ä¸€å®šçš„äº†è§£</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ä¸€ã€ğŸ¡Dockerå®¹å™¨çš„ä»‹ç»å’Œéƒ¨ç½²</title>
    <link href="https://www.fomal.cc/posts/a56cb35d.html"/>
    <id>https://www.fomal.cc/posts/a56cb35d.html</id>
    <published>2024-09-22T04:51:53.000Z</published>
    <updated>2024-09-22T07:53:34.195Z</updated>
    
    <content type="html"><![CDATA[<h2 id="dockerå®¹å™¨">dockerå®¹å™¨</h2><p>Dockerä¾¿ç”¨G00g1eå…¬å¸æ¨å‡ºWG0è¯­è¨€è¿›è¡Œå¼€å‹å®ç°ï¼ŒåŸºäºæ“ä½œæ¡ç»Ÿå†…å­©ä¸­æ—¶Cgroup(è´·æºæ§åˆ¶)NameSpace(èµ„æºéš”ç¦»)ä¸0verlayFS(æ•°æ®å­˜å‚¨)ç­‰æŠ€æœ¯ï¼Œå®ç°åŸºäºæ“ä½œç³»ç»Ÿå±‚é¢çš„(åº”ç”¨)è™šæ‹ŸåŒ–æŠ€æœ¯,<br>æœ€åˆå®ç°æ˜¯åŸºäºLXCæŠ€æœ¯ï¼Œä»0.7ç‰ˆæœ¬ä»¥åå¼€å§‹å»é™¤LXCï¼Œè½¬è€Œä½¿ç”¨è‡ªè¡Œå¼€å‘çš„libcontainer(å®¹å™¨ç®¡ç†æŠ€æœ¯)ã€‚</p><p>å®¹å™¨æŠ€æœ¯å‘å±•æ¶æ„å›¾ï¼š</p><p><img src="../image/study_img/image-20240902083945201.png" alt="image-20240902083945201"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ä¸ºä»€ä¹ˆæœ‰äº‘å¹³å°ï¼šå› ä¸ºæ–¹ä¾¿å¿«æ·ï¼Œè¿˜ä¾¿å®œ</span><br><span class="line">è´­ä¹°ç‰©ç†æœºï¼Œä¸ä»…è¿˜è¦ä¹°æœåŠ¡å™¨ï¼Œè¿˜è¦ç§Ÿæœºæˆ¿</span><br><span class="line"></span><br><span class="line">VMware Workstation:è™šæ‹ŸåŒ–å·¥å…·ï¼Œå¯åŠ¨è™šæ‹Ÿæœºçš„ï¼Œä½¿ç”¨çš„ç¼–æ’å·¥å…·æ˜¯çš„ï¼šVcenter server</span><br><span class="line">KVMï¼šè™šæ‹ŸåŒ–å·¥å…·ï¼Œå¯åŠ¨è™šæ‹Ÿæœºçš„    ä½¿ç”¨çš„ç¼–æ’å·¥å…·æ˜¯çš„ï¼šOpenStack</span><br><span class="line">Dockerï¼šå®¹å™¨åŒ–å·¥å…·ï¼Œå®¹å™¨è¿è¡Œæ—¶   ä½¿ç”¨çš„ç¼–æ’å·¥å…·æ˜¯çš„ï¼š(dockerè‡ªå·±å†™çš„ç¼–æ’å·¥å…·)Docker-swarmã€mesosã€kubernetes(æœ€çµæ´»çš„,å¸¸ç”¨çš„)</span><br><span class="line">K8s,è°·æ­Œçš„äº§å“</span><br><span class="line"></span><br><span class="line">ç¼–æ’å·¥å…·çš„ä½œç”¨ï¼šä½¿éƒ¨ç½²è™šæ‹ŸåŒ–çš„äº§å“å˜æˆä¸€ä¸ªé›†ç¾¤</span><br><span class="line"></span><br><span class="line">ä¸‹è½½ä¸€ä¸ªå·¥å…· tightVNC ,å°±å¯ä»¥è¿æ¥è™šæ‹Ÿæœºé‡Œé¢åˆ›å»ºçš„è™šæ‹Ÿæœºäº†</span><br></pre></td></tr></table></figure><p>å®¹å™¨ä¸è™šæ‹Ÿæœºå¯¹æ¯”<br>ä¼ ç»Ÿè™šæ‹ŸåŒ–å’Œdockeråˆ†å±‚å¯¹æ¯”</p><p><img src="../image/study_img/image-20240902092008550.png" alt="image-20240902092008550"></p><p>å®¹å™¨åŒ–äº§å“æ¦‚å¿µ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å†…æ ¸çš„æŠ€æœ¯  (ç³»ç»Ÿæ˜¯åœ¨å†…æ ¸çš„åŸºç¡€ä¸Šå°è£…å‡ºæ¥çš„)</span></span><br><span class="line">Namespaceï¼šåç§°ç©ºé—´ï¼Œå‘½åç©ºé—´(ä½œç”¨æ˜¯ï¼šèµ„æºéš”ç¦»)èµ·ä¸€ä¸ªå®¹å™¨å°±æ˜¯èµ·ä¸€ä¸ªè¿›ç¨‹ï¼Œç„¶åå†åšèµ„æºéš”ç¦»</span><br><span class="line">Cgroupï¼šèµ„æºæ§åˆ¶ã€èµ„æºè®¡ç®—</span><br><span class="line"></span><br><span class="line">dockeræ˜¯è°ƒç”¨å†…æ ¸æ¥å£çš„å·¥å…·</span><br></pre></td></tr></table></figure><p>VMè™šæ‹ŸåŒ–å’ŒDockerç‰¹æ€§å¯¹æ¯”</p><table><thead><tr><th>ç‰¹æ€§</th><th>Docker</th><th>VM</th></tr></thead><tbody><tr><td>å¯åŠ¨é€Ÿåº¦</td><td>ç§’çº§</td><td>åˆ†é’Ÿçº§</td></tr><tr><td>ç¡¬ç›˜ä½¿ç”¨</td><td>ä¸€èˆ¬ä¸ºMB</td><td>ä¸€èˆ¬ä¸ºGB</td></tr><tr><td>æ€§èƒ½</td><td>æ¥è¿‘åŸç”Ÿå•æœºæ”¯æŒä¸Šåƒä¸ªå®¹å™¨</td><td>å¼±äºåŸç”Ÿ</td></tr><tr><td>ç³»ç»Ÿæ”¯æŒé‡</td><td>å•æœºæ”¯æŒä¸Šåƒä¸ªå®¹å™¨</td><td>ä¸€èˆ¬å‡ åä¸ª</td></tr><tr><td>éš”ç¦»æ€§</td><td>å®‰å…¨éš”ç¦»</td><td>å®Œå…¨éš”ç¦»</td></tr></tbody></table><p>å®¹å™¨åŒ–äº§å“çš„æ¦‚å¿µ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Container Runtimeï¼šå®¹å™¨è¿è¡Œæ—¶</span></span><br><span class="line">- docker</span><br><span class="line">- CRI-O</span><br><span class="line">- containerd</span><br><span class="line"></span><br><span class="line"><span class="comment">## å†…æ ¸æŠ€æœ¯</span></span><br><span class="line">Namespaceï¼šåç§°ç©ºé—´ï¼Œå‘½åç©ºé—´ï¼ˆèµ„æºéš”ç¦»ï¼‰https://man7.org/linux/man-pages/man7/namespaces.7.html</span><br><span class="line"></span><br><span class="line">Cgroupï¼šèµ„æºæ§åˆ¶ã€èµ„æºè®¡ç®— https://man7.org/linux/man-pages/man7/cgroups.7.html</span><br><span class="line"></span><br><span class="line">èµ„æºé™åˆ¶ï¼šä¾‹å¦‚è®¾å®šä»»åŠ¡æŒ‡å®šå†…å­˜</span><br><span class="line">ä¼˜å…ˆçº§åˆ†é…ï¼šæ¯”å¦‚è·Ÿä»»åŠ¡åˆ†é…çš„CPUæ—¶é—´ï¼Œç‰‡æ•°ï¼Œç£ç›˜IOï¼Œå¸¦å®½å¤§å°æ¥æ§åˆ¶ä»»åŠ¡çš„ä¼˜å…ˆçº§</span><br><span class="line">èµ„æºç»Ÿè®¡ï¼šç»Ÿè®¡CPUï¼Œå†…å­˜ï¼ŒIOç­‰èµ„æºä½¿ç”¨æ—¶é•¿ï¼Œè¯¥åŠŸèƒ½æ¯”è¾ƒé€‚åˆç”¨äºè®¡è´¹</span><br><span class="line">ä»»åŠ¡æ§åˆ¶ï¼šcgroupå¯ä»¥å¯¹ä»»åŠ¡è¿›è¡Œ è¿è¡Œï¼ŒæŒ‚èµ·ï¼Œæ¢å¤ç­‰æ“ä½œ</span><br></pre></td></tr></table></figure><h3 id="1ã€Dockerçš„ä¸‰ä¸ªæ¦‚å¿µ">1ã€<strong>Dockerçš„ä¸‰ä¸ªæ¦‚å¿µ</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#images(é•œåƒ)</span></span><br><span class="line">Dockeré•œåƒå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿï¼Œé™¤äº†æä¾›å®¹å™¨è¿è¡Œæ—¶æ‰€éœ€è¦çš„ç¨‹åºã€åº“ã€èµ„æºã€é…ç½®æ–‡ä»¶ä»¥å¤–ï¼Œè¿˜åŒ…åˆäº†ä¸€äº›ä¸ºè¿è¡Œæ—¶ï¼Œå‡†å¤‡çš„é…ç½®å‚æ•°(åŒ¿åå·ï¼Œç¯å¢ƒå˜é‡ï¼Œç”¨æˆ·...),é•œåƒæ˜¯ä¸å¯æ›´æ”¹çš„</span><br><span class="line">Dockerå®¹å™¨çš„å‚¨å­˜æ–¹å¼ï¼šé€šè¿‡overlayFSæ–‡ä»¶ç³»ç»Ÿè¿›è¡Œå‚¨å­˜</span><br><span class="line">upper</span><br><span class="line">lower</span><br><span class="line">merge</span><br><span class="line"></span><br><span class="line">ä¸ºäº†ç¯å¢ƒçš„ç»Ÿä¸€ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç®¡ç†</span><br><span class="line"></span><br><span class="line"><span class="comment">#Container(å®¹å™¨)</span></span><br><span class="line">å®¹å™¨çš„å®šä¹‰å’Œé•œåƒï¼Œå‡ ä¹æ˜¯ä¸€æ¨¡ä¸€æ ·ï¼Œå”¯ä¸€åŒºåˆ«åœ¨äºå®¹å™¨çš„æœ€ä¸Šé¢é‚£ä¸€å±‚æ˜¯å¯è¯»å¯å†™çš„ã€‚</span><br><span class="line">(ç±»ä¼¼äºç”¨Docker1èµ·çš„ä¸€å°è™šæ‹Ÿæœº)</span><br><span class="line">ç†è§£ï¼šä¸€ä¸ªå®¹å™¨å°±æ˜¯ä¸€å°è™šæ‹Ÿæœº</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Repository(ä»“åº“)</span></span><br><span class="line">ä¸Šä¼ é•œåƒï¼Œå­˜æ”¾é•œåƒ</span><br><span class="line"></span><br><span class="line">ä»“åº“æ˜¯Dockerç”¨æ¥å­˜æ”¾é•œåƒçš„åœ°æ–¹ï¼Œç±»ä¼¼äºæˆ‘ä»¬ä¹‹å‰å¸¸ç”¨çš„ä»£ç ä»“åº“ã€‚</span><br><span class="line">é€šå¸¸ä¸€ä¸ªä»“åº“ä¼šåŒ…å«ï¼ŒåŒä¸€ä¸ªè½¯ä»¶ï¼Œä¸åŒç‰ˆæœ¬çš„é•œåƒ</span><br><span class="line">æˆ‘ä»¬å¯ä»¥é€šè¿‡&lt;ä»“åº“å&gt;:&lt;æ ‡ç­¾&gt;æ ¼å¼æ¥æŒ‡å®šå…·ä½“ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„é•œåƒï¼Œå¦‚æœä¸ç»™æ ‡ç­¾ï¼Œé‚£ä¹ˆé»˜è®¤ä»¥Latestä½œä¸ºé»˜è®¤æ ‡ç­¾</span><br><span class="line"></span><br><span class="line"><span class="comment">#dockerçš„ä»“åº“æœ‰2ç§</span></span><br><span class="line">1ã€Harbor   å›¾å½¢åŒ–ä»“åº“</span><br><span class="line">2ã€Registry å‘½ä»¤è¡Œä»“åº“</span><br></pre></td></tr></table></figure><h3 id="2ã€Dockerçš„ç»„æˆ">2ã€<strong>Dockerçš„ç»„æˆ</strong></h3><p>Dockeræ˜¯C/Sç»“æ„çš„æœåŠ¡    <code>docker client</code> å’Œ <code>docker server</code></p><p>Dockerå®¢æˆ·ç«¯æ˜¯Dockerç”¨æˆ·ä¸Dockeräº¤äº’çš„ä¸»è¦æ–¹å¼<br>å½“ä½¿ç”¨Dockerå‘½ä»¤è¡Œè¿è¡Œå‘½ä»¤æ—¶ï¼ŒDockerå®¢æˆ·ç«¯å°†è¿™äº›å‘½ä»¤å‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ‰§è¡Œè¿™äº›å‘½ä»¤Dockerå‘½ä»¤ä½¿ç”¨DockerAPI<br>Dockerå®¢æˆ·ç«¯å¯ä»¥ä¸å¤šä¸ªæœåŠ¡ç«¯è¿›è¡Œé€šè®¯</p><p><img src="../image/study_img/image-20240902110827668.png" alt="image-20240902110827668"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Dockerçš„å®¢æˆ·ç«¯ï¼š</span><br><span class="line">- å‘½ä»¤è¡Œ docker</span><br><span class="line">- å›¾å½¢åŒ– dashboard(UIç•Œé¢)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç”¨æˆ·â€”â€”â€”&gt;ä½¿ç”¨dockerå®¢æˆ·ç«¯â€”â€”â€”&gt;è°ƒç”¨DOckerçš„æ¥å£â€”â€”â€”&gt;è¿æ¥åˆ°DOcker serverâ€”â€”&gt;è°ƒç”¨å†…æ ¸Namespaceã€cgroup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¨³å®šçš„ç‰ˆæœ¬</span></span><br><span class="line">docker 19.3</span><br><span class="line">k8 1.19</span><br><span class="line"></span><br><span class="line">ä¸ºä»€ä¹ˆ</span><br><span class="line">ä¸‹äº†ä¸€ä¸ªnginxå®¹å™¨ï¼Œæƒ³è®©ä»–å˜æˆwebæœåŠ¡å™¨</span><br></pre></td></tr></table></figure><h3 id="3ã€éƒ¨ç½²DOcker">3ã€<strong>éƒ¨ç½²DOcker</strong></h3><p>1ã€å®‰è£…docker-ce</p><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th></tr></thead><tbody><tr><td>docker01</td><td>10.0.0.101  /  172.16.1.101</td><td></td></tr><tr><td>docker02</td><td>10.0.0.102  /  172.16.1.102</td><td></td></tr><tr><td>docker03</td><td>10.0.0.103  /  172.16.1.103</td><td></td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1ã€å¸è½½ä¹‹å‰å®‰è£…çš„DOcker</span><br><span class="line">yum remove docker \</span><br><span class="line">docker-client \</span><br><span class="line">docker-client-latest \</span><br><span class="line">docker-common \</span><br><span class="line">docker-latest \</span><br><span class="line">docker-latest-logrotate \</span><br><span class="line">docker-logrotate \</span><br><span class="line">docker-engine</span><br><span class="line"></span><br><span class="line">2ã€æ¢æº</span><br><span class="line">[root@docker01 ~]# vim /etc/yum.repos.d/docker-ce.repo </span><br><span class="line">[docker-ce-stable]</span><br><span class="line">name=Docker CE Stable - <span class="variable">$basearch</span></span><br><span class="line">baseurl=https://download.docker.com/linux/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/stable</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://download.docker.com/linux/centos/gpg</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# sed -i <span class="string">&#x27;s+download.docker.com+mirrors.huaweicloud.com/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line">3ã€ä¸‹è½½docker</span><br><span class="line">[root@docker01 ~]# yum install -y docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸‹è½½çš„æ…¢ï¼ŒæŠŠbaseæºé‡Œé¢çš„updatå…³é—­</p><p>[root@docker03 ~]# vim /etc/yum.repos.d/CentOS-Base.repo</p><p><img src="../image/study_img/image-20240902114920501.png" alt="image-20240902114920501"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">4ã€å¯åŠ¨</span><br><span class="line">[root@docker01 ~]# systemctl start docker</span><br><span class="line">[root@docker01 ~]# systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line">5ã€æŸ¥çœ‹dockerä¿¡æ¯</span><br><span class="line">[root@docker01 ~]# docker info</span><br><span class="line"></span><br><span class="line">Docker Root Dir: /var/lib/docker  <span class="comment">#Dockerçš„å‚¨å­˜ç›®å½•(å·¥ä½œç›®å½•)</span></span><br><span class="line"></span><br><span class="line">6ã€å¯åŠ¨dockerå°±ä¼šç”Ÿæˆä¸€ä¸ªsocketæ–‡ä»¶</span><br><span class="line">[root@docker01 ~]# ll /var/run/docker.sock </span><br><span class="line">srw-rw---- 1 root docker 0 Sep  2 12:17 /var/run/docker.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7ã€åŠ é€Ÿé•œåƒ</span><br><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">[root@docker01 ~]# <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;dns&quot;</span>: [<span class="string">&quot;8.8.8.8&quot;</span>, <span class="string">&quot;8.8.4.4&quot;</span>],</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://dockerproxy.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.nju.edu.cn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://registry.docker-cn.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://hub-mirror.c.163.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://mirror.baidubce.com&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¤‡ç”¨åŠ é€Ÿï¼š</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>:[<span class="string">&quot;https://docker.1panel.live&quot;</span>, <span class="string">&quot;https://hub.rat.dev/&quot;</span>, <span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# systemctl daemon-reload</span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">8ã€æµ‹è¯•æ‹‰å–nginxé•œåƒ</span><br><span class="line">[root@docker02 ~]# docker pull nginx</span><br><span class="line">ç­‰å¾…2åˆ†é’Ÿæ‰æ‹‰å–çš„ä¸‹æ¥</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker pull nginx:alpine     (æœ€å°çš„æ“ä½œç³»ç»Ÿalpine)</span><br><span class="line">[root@docker01 ~]# docker pull nginx:latest</span><br><span class="line">[root@docker01 ~]# docker pull busybox</span><br><span class="line"></span><br><span class="line">9ã€æŸ¥çœ‹æ‹‰å–çš„é•œåƒ</span><br><span class="line">[root@docker01 ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">nginx        alpine    0f0eda053dc5   2 weeks ago     43.3MB</span><br><span class="line">nginx        latest    5ef79149e0ec   2 weeks ago     188MB</span><br><span class="line">busybox      latest    87ff76f62d36   15 months ago   4.26MB</span><br><span class="line">centos       7         eeb6ee3f44bd   2 years ago     204MB</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">è®¤è¯†docker,éƒ¨ç½²docker</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>MHAé«˜å¯ç”¨</title>
    <link href="https://www.fomal.cc/posts/74c516b4.html"/>
    <id>https://www.fomal.cc/posts/74c516b4.html</id>
    <published>2024-09-21T09:46:27.000Z</published>
    <updated>2024-09-22T04:28:07.157Z</updated>
    
    <content type="html"><![CDATA[<h2 id="MHAé«˜å¯ç”¨">MHAé«˜å¯ç”¨</h2><h3 id="1ã€MHAè½¯ä»¶ä»‹ç»"><strong>1ã€MHAè½¯ä»¶ä»‹ç»</strong></h3><p><font color=red>åŸç†ï¼šå½“Masterå‡ºç°æ•…éšœæ—¶ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨å°†æœ€æ–°æ•°æ®çš„Slaveæå‡ä¸ºæ–°çš„Master,ç„¶åå°†æ‰€æœ‰å…¶ä»–çš„Slaveé‡æ–°æŒ‡å‘æ–°çš„Masterã€‚</font></p><p>MHAèƒ½å¤Ÿåœ¨è¾ƒçŸ­çš„æ—¶é—´å†…å®ç°è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ•…éšœè½¬ç§»ï¼Œé€šå¸¸åœ¨10-30ç§’ä»¥å†…;åœ¨å¤åˆ¶æ¡†æ¶ä¸­ï¼ŒMHAèƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³å¤åˆ¶è¿‡ç¨‹ä¸­çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œç”±äºä¸éœ€è¦åœ¨ç°æœ‰çš„replicationä¸­æ·»åŠ é¢å¤–çš„æœåŠ¡å™¨ï¼Œä»…éœ€è¦ä¸€ä¸ªmanagerèŠ‚ç‚¹ï¼Œè€Œä¸€ä¸ªManagerèƒ½ç®¡ç†å¤šå¥—å¤åˆ¶ï¼Œæ‰€ä»¥èƒ½å¤§å¤§åœ°èŠ‚çº¦æœåŠ¡å™¨çš„æ•°é‡;å¦å¤–ï¼Œå®‰è£…ç®€å•ï¼Œæ— æ€§èƒ½æŸè€—ï¼Œä»¥åŠä¸éœ€è¦ä¿®æ”¹ç°æœ‰çš„å¤åˆ¶éƒ¨ç½²ä¹Ÿæ˜¯å®ƒçš„ä¼˜åŠ¿ä¹‹å¤„ã€‚</p><p><img src="../image/study_img/image-20240827090218613.png" alt="image-20240827090218613"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ä»åº“ä¸æ›´æ–°binlog,åªæ›´æ–°relay-log,è¿™ä¸ªå¯ä»¥è§£å†³çš„ï¼Œå¯ä»¥é…ç½®è®©ä»–æ›´æ–°binlog,åŠ å‚æ•°</span><br><span class="line"></span><br><span class="line">Rvså°±æ˜¯é˜¿é‡Œäº‘ä¸Šçš„æ•°æ®åº“ï¼Œecsæ˜¯äº‘ä¸»æœº</span><br><span class="line"></span><br><span class="line">Heartbeat+DRBD  ä¹Ÿæ˜¯åšé«˜å¯ç”¨çš„ å¿ƒè·³æ£€æµ‹</span><br><span class="line"></span><br><span class="line">MHAçš„manageræœ€å¥½ä¸è¦å®‰è£…åœ¨ä¸»åº“ä¸Šï¼Œå°±æ€•æ–­ç”µäº†ï¼Œmhaä¸èƒ½å·¥ä½œï¼Œå®‰è£…åœ¨3å°ä»åº“ä¸Šå¯ä»¥ï¼Œæˆ–è€…é‡æ–°æ‰¾ä¸€å°æ–°æœºå™¨å®‰è£…MHA(MHAå°±æ˜¯ä¸€ä¸ªç›‘æ§è½¯ä»¶ã€‚ç›‘æ§ä¸»åº“å¿ƒè·³çš„)</span><br></pre></td></tr></table></figure><p><strong>å·¥ä½œæµç¨‹</strong></p><p>1)æŠŠå®•æœºçš„masteräºŒè¿›åˆ¶æ—¥å¿—ä¿å­˜ä¸‹æ¥ã€‚<br>2)æ‰¾åˆ°binlogä½ç½®ç‚¹æœ€æ–°çš„slaveã€‚<br>3)åœ¨binlogä½ç½®ç‚¹æœ€æ–°çš„slaveä¸Šç”¨relay logï¼ˆå·®å¼‚æ—¥å¿—ï¼‰ä¿®å¤å…¶å®ƒslaveã€‚<br>4)å°†å®•æœºçš„masterä¸Šä¿å­˜ä¸‹æ¥çš„äºŒè¿›åˆ¶æ—¥å¿—æ¢å¤åˆ°å«æœ‰æœ€æ–°ä½ç½®ç‚¹çš„slaveä¸Šã€‚<br>5)å°†å«æœ‰æœ€æ–°ä½ç½®ç‚¹binlogæ‰€åœ¨çš„slaveæå‡ä¸ºmasterã€‚<br>6)å°†å…¶å®ƒslaveé‡æ–°æŒ‡å‘æ–°æå‡çš„masterï¼Œå¹¶å¼€å¯ä¸»ä»å¤åˆ¶ã€‚</p><p><img src="../image/study_img/image-20240827093920829.png" alt="image-20240827093920829"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">keepalivedæœ‰å±€é™æ€§ï¼Œä»–æ€ä¹ˆçŸ¥é“å“ªå°æœºå™¨çš„æ•°æ®æœ€æ–°ï¼Ÿ</span><br><span class="line"></span><br><span class="line">MHAåšå®Œåˆ‡æ¢ï¼Œè¿ç»´æ— æ„ŸçŸ¥ï¼Œéœ€è¦æœ‰ä¸€ä¸ªé€šçŸ¥ï¼ŒMHAè‡ªå¸¦ä¸€ä¸ªé€šçŸ¥å·¥å…·</span><br><span class="line"></span><br><span class="line">é—®é¢˜ï¼š</span><br><span class="line">1ã€binlogçš„ä¿å­˜ä½ç½®åœ¨å“ª       (è°è¢«æå‡ä¸ºä¸»åº“å°±å‘ç¼ºå¤±æ•°æ®é€ç»™è°)</span><br><span class="line">2ã€downæœºçš„ä¸»åº“ä¿®å¤å¥½ä¹‹åï¼Œå¦‚ä½•åŠ å…¥é›†ç¾¤ï¼Ÿ</span><br><span class="line">3ã€downæœºçš„ä¸»åº“ä¿®å¤å¥½ä¹‹åï¼ŒåŠ å…¥é›†ç¾¤çš„è§’è‰²æ˜¯ä»€ä¹ˆï¼Ÿ</span><br></pre></td></tr></table></figure><h3 id="2ã€MHAæ¶æ„å›¾"><strong>2ã€MHAæ¶æ„å›¾</strong></h3><p><img src="../image/study_img/image-20240827101716633.png" alt="image-20240827101716633"></p><p><strong>MHAçš„å·¥å…·</strong></p><p>MHA nodeçš„å·¥å…·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@dbe1 bin]# 11</span><br><span class="line">-rwxrwxr-x1 root root 17639 Mar 23 2018 apply_diff relay_logs      <span class="comment">#å¯¹æ¯”relay log,æ‰¾åˆ°æ–°ä¸»åº“</span></span><br><span class="line">-rwxrwxr-x 1 root root 4807 Mar 23 2018 filter mysqlbinlog         <span class="comment">#æˆªå–binlog</span></span><br><span class="line">-rwxrwxr-x 1 root root 8337 Mar 23 2018 purge_relay_logs           <span class="comment">#åˆ é™¤relay log</span></span><br><span class="line">-rwxrwxr-x 1 root root 7525 Mar 23 2018 save binary logs           <span class="comment">#ä¿å­˜binlog</span></span><br></pre></td></tr></table></figure><p>MHA manager</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  manageré‡Œé¢çš„å·¥å…·ç¨‹åºä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">[root@dbe1 bin]# 11</span><br><span class="line">-rwxrwxr-x 1 root root 1995 Mar 232018 masterha_check_repl          <span class="comment">#æ£€æµ‹ä¸»ä»å¤åˆ¶</span></span><br><span class="line">-rwxrwxr-x 1 root root 1779 Mar 232018 masterha_check_ssh           <span class="comment">#æ£€æµ‹sshå…å¯†</span></span><br><span class="line">-rwxrwxr-x 1 root root 1865 Mar 232018 masterha_check_status        <span class="comment">#æ£€æµ‹mhaçš„è¿è¡ŒçŠ¶æ€(ç›¸å½“äºsystemctl status mha)</span></span><br><span class="line">-rwxrwxr-x 1 root root 3201 Mar 232018 masterha_conf_host           <span class="comment">#mhaè™šæ‹Ÿä¸»æœºé…ç½®(MHAåšå®Œåˆ‡æ¢åï¼Œä¼šå°†å®•æœºä¸»åº“ä»é…ç½®æ–‡ä»¶ä¸­æ‘˜é™¤)</span></span><br><span class="line">-rwxrwxr-x 1 root root 2517 Mar 232018 masterha_manager             <span class="comment">#MHAçš„å¯åŠ¨å‘½ä»¤(ç›¸å½“äºsystemctl start mha)</span></span><br><span class="line">-rwxrwxr-x 1 root root 2165 Mar 232018 masterha_master_monitor      <span class="comment">#æ£€æµ‹ä¸»åº“å¿ƒè·³</span></span><br><span class="line">-rwxrwxr-x 1 root root 2373 Mar 232018 masterha_master_switch       <span class="comment">#åˆ‡æ¢å·¥å…·</span></span><br><span class="line">-rwxrwxr-x 1 root root 5172 Mar 232018 masterha_secondary_check     <span class="comment">#æ£€æµ‹ICP/IPè¿æ¥</span></span><br><span class="line">-rwxrwxr-x 1 root root 1739 Mar 232018 masterha_stop                <span class="comment">#åœæ­¢MHAçš„å‘½ä»¤(ç›¸å½“äºsystemctl stop mha)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#/root/mha4mysgl-manager-0.58/samples/scripts</span></span><br><span class="line">-rwxrwxr-x 1 root root  3648 Mar 23 2018 master_ip_failover</span><br><span class="line">-rwxrwxr-x 1 root root  9870 Mar 23 2018 master_ip_online_change</span><br><span class="line">-rwxrwxr-x 1 root root 11867 Mar 23 2018 power_manager</span><br><span class="line">-rwxrwxr-x 1 root root  1360 Mar 23 2818 send_report</span><br></pre></td></tr></table></figure><p>MHAä¼˜ç‚¹æ€»ç»“</p><p>1ï¼‰Masterfailover and slave promotion can be done very quickly<br>è‡ªåŠ¨æ•…éšœè½¬ç§»å¿«</p><p>2ï¼‰Mastercrash does not result in data inconsistency<br>ä¸»åº“å´©æºƒä¸å­˜åœ¨æ•°æ®ä¸€è‡´æ€§é—®é¢˜</p><p>3ï¼‰Noneed to modify current MySQL settings (MHA works with regular MySQL)<br>ä¸éœ€è¦å¯¹å½“å‰mysqlç¯å¢ƒåšé‡å¤§ä¿®æ”¹</p><p>4ï¼‰Noneed to increase lots of servers<br>ä¸éœ€è¦æ·»åŠ é¢å¤–çš„æœåŠ¡å™¨(ä»…ä¸€å°managerå°±å¯ç®¡ç†ä¸Šç™¾ä¸ªreplication)</p><p>5ï¼‰Noperformance penalty<br>æ€§èƒ½ä¼˜ç§€ï¼Œå¯å·¥ä½œåœ¨åŠåŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶ï¼Œå½“ç›‘æ§mysqlçŠ¶æ€æ—¶ï¼Œä»…éœ€è¦æ¯éš”Nç§’å‘masterå‘é€pingåŒ…(é»˜è®¤3ç§’)ï¼Œæ‰€ä»¥å¯¹æ€§èƒ½æ— å½±å“ã€‚ä½ å¯ä»¥ç†è§£ä¸ºMHAçš„æ€§èƒ½å’Œç®€å•çš„ä¸»ä»å¤åˆ¶æ¡†æ¶æ€§èƒ½ä¸€æ ·ã€‚</p><p>6ï¼‰Works with any storage engine<br>åªè¦replicationæ”¯æŒçš„å­˜å‚¨å¼•æ“ï¼ŒMHAéƒ½æ”¯æŒï¼Œä¸ä¼šå±€é™äºinnodb</p><h3 id="3ã€éƒ¨ç½²MHA"><strong>3ã€éƒ¨ç½²MHA</strong></h3><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th><th>åº”ç”¨</th></tr></thead><tbody><tr><td>db01</td><td>10.0.0.51  /  172.16.1.51</td><td>æš‚æ—¶çš„ä¸»åº“ã€MHAå®¢æˆ·ç«¯</td><td>mysql 5.6ã€MHA node</td></tr><tr><td>db02</td><td>10.0.0.52  /  172.16.1.52</td><td>æš‚æ—¶çš„ä»åº“ã€MHAå®¢æˆ·ç«¯</td><td>mysql 5.6ã€MHA node</td></tr><tr><td>db03</td><td>10.0.0.53  /  172.16.1.53</td><td>æš‚æ—¶çš„ä»åº“ã€MHAå®¢æˆ·ç«¯</td><td>mysql 5.6ã€MHA node</td></tr><tr><td>db04</td><td>10.0.0.54 /  172.16.1.54</td><td>æš‚æ—¶çš„ä»åº“ã€MHAå®¢æˆ·ç«¯</td><td>mysql 5.6ã€MHA node</td></tr><tr><td>lb01</td><td>10.0.0.5 /  172.16.1.5</td><td>MHAçš„ç®¡ç†ç«¯</td><td>MHA managerã€mariadb</td></tr></tbody></table><p>1ã€MHAå…ˆå†³æ¡ä»¶ï¼Œéœ€è¦å…ˆéƒ¨ç½²ä¸»ä»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¼ ç»Ÿä¸»ä»å¤åˆ¶</span></span><br><span class="line">1ã€ä¸»åº“å¼€å¯binlog,ä¸»åº“ä¸å¼€</span><br><span class="line">2ã€ä¸»åº“å’Œä»åº“server_idä¸åŒï¼Œä»åº“ä¹‹é—´å¯ä»¥ç›¸åŒ</span><br><span class="line">3ã€ä¸»åº“è¦åˆ›å»ºä¸»ä»å¤åˆ¶ç”¨æˆ·ï¼Œä»åº“å¯ä»¥ä¸åˆ›å»º</span><br><span class="line"></span><br><span class="line"><span class="comment">#åŸºäºMHAçš„ä¸»ä»å¤åˆ¶</span></span><br><span class="line">1ã€ä¸»åº“ã€ä»åº“ä¹Ÿè¦å¼€å¯binlog</span><br><span class="line">2ã€ä¸»åº“ã€ä»åº“server_idä¸åŒï¼Œä»åº“ä¹‹é—´ä¹Ÿä¸èƒ½ç›¸åŒ</span><br><span class="line">3ã€ä¸»åº“ã€ä»åº“å¿…é¡»åˆ›å»ºä¸»ä»å¤åˆ¶ç”¨æˆ·</span><br><span class="line">4ã€å…³é—­åªè¯»</span><br><span class="line"></span><br><span class="line">1ã€ä¸»åº“é…ç½®æ–‡ä»¶</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/app/mysql-5.6.50</span><br><span class="line">datadir=/app/mysql-5.6.50/data</span><br><span class="line">log_bin=mysql-bin</span><br><span class="line">server_id=1</span><br><span class="line">lower_case_table=1</span><br><span class="line">innodb_data_file_path=ibdata1:76M;ibdata2:50M:autoextend</span><br><span class="line">binlog_format=row</span><br><span class="line"><span class="comment">#æŒ‡å®šæ˜¯å¦å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—</span></span><br><span class="line">slow_query_log=1</span><br><span class="line"><span class="comment">#æŒ‡å®šæ…¢æ—¥å¿—æ–‡ä»¶å­˜æ”¾ä½ç½®ï¼ˆé»˜è®¤åœ¨dataï¼‰</span></span><br><span class="line">slow_query_log_file=/app/mysql-5.6.50/data/db01-slow.log</span><br><span class="line"><span class="comment">#è®¾å®šæ…¢æŸ¥è¯¢çš„é˜€å€¼(é»˜è®¤10s)</span></span><br><span class="line">long_query_time=0.05</span><br><span class="line"><span class="comment">#ä¸ä½¿ç”¨ç´¢å¼•çš„æ…¢æŸ¥è¯¢è¯­å¥æ˜¯å¦è®°å½•åˆ°æ—¥å¿—</span></span><br><span class="line">log_queries_not_using_indexes</span><br><span class="line"><span class="comment">#æŸ¥è¯¢æ£€æŸ¥è¿”å›å°‘äºè¯¥å‚æ•°æŒ‡å®šè¡Œçš„SQLä¸è¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—  ï¼ˆé¸¡è‚‹ï¼‰</span></span><br><span class="line">min_examined_row_limit=100</span><br><span class="line">skip_name_resolve</span><br><span class="line">relay_log_purge = 0</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">prompt=<span class="string">&quot;\\u@\\h:\\d &gt; &quot;</span></span><br><span class="line"></span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld restart</span><br><span class="line">åˆ›å»ºç”¨æˆ·</span><br><span class="line">grant replication slave on *.* to rep@<span class="string">&#x27;172.16.1.5%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ä»åº“é…ç½®æ–‡ä»¶</span><br><span class="line"><span class="comment">#db02</span></span><br><span class="line">[root@db02 data]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/app/mysql-5.6.50</span><br><span class="line">datadir=/app/mysql-5.6.50/data</span><br><span class="line">log_bin=mysql-bin</span><br><span class="line">server_id=2</span><br><span class="line">lower_case_table=1</span><br><span class="line"><span class="comment">#innodb_data_file_path=ibdata1:12M;ibdata2:50M:autoextend</span></span><br><span class="line">binlog_format=row</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">skip-name-resolve</span><br><span class="line">relay_log_purge = 0</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt=<span class="string">&quot;\\u@\\h:\\d &gt; &quot;</span></span><br><span class="line"></span><br><span class="line">[root@db02 data]#  /etc/init.d/mysqld restart</span><br><span class="line">åˆ›å»ºç”¨æˆ·</span><br><span class="line">grant replication slave on *.* to rep@<span class="string">&#x27;172.16.1.5%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#db03</span></span><br><span class="line">[root@db03 data]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/app/mysql-5.6.50</span><br><span class="line">datadir=/app/mysql-5.6.50/data</span><br><span class="line">log_bin=mysql-bin</span><br><span class="line">server_id=3</span><br><span class="line">lower_case_table=1</span><br><span class="line"><span class="comment">#innodb_data_file_path=ibdata1:12M;ibdata2:50M:autoextend</span></span><br><span class="line">binlog_format=row</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">skip-name-resolve</span><br><span class="line">relay_log_purge = 0</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt=<span class="string">&quot;\\u@\\h:\\d &gt; &quot;</span></span><br><span class="line"></span><br><span class="line">[root@db03 data]#  /etc/init.d/mysqld restart</span><br><span class="line">åˆ›å»ºç”¨æˆ·</span><br><span class="line">grant replication slave on *.* to rep@<span class="string">&#x27;172.16.1.5%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#db04</span></span><br><span class="line">[root@db04 data]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/app/mysql-5.6.50</span><br><span class="line">datadir=/app/mysql-5.6.50/data</span><br><span class="line">log_bin=mysql-bin</span><br><span class="line">server_id=4</span><br><span class="line">lower_case_table=1</span><br><span class="line"><span class="comment">#innodb_data_file_path=ibdata1:12M;ibdata2:50M:autoextend</span></span><br><span class="line">binlog_format=row</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">skip-name-resolve</span><br><span class="line">relay_log_purge = 0</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt=<span class="string">&quot;\\u@\\h:\\d &gt; &quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db04 data]#  /etc/init.d/mysqld restart</span><br><span class="line">åˆ›å»ºç”¨æˆ·</span><br><span class="line">grant replication slave on *.* to rep@<span class="string">&#x27;172.16.1.5%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#3å°ä»åº“è®¾ç½®åªè¯»ï¼Œ(åœ¨å‘½ä»¤è¡Œä¸´æ—¶è®¾ç½®)ï¼Œä¸èƒ½åœ¨é…ç½®æ–‡ä»¶è®¾ç½®ï¼Œ(mhaåˆ‡æ¢çš„æ—¶å€™ä¼šé‡å¯mysql,è®©åªè¯»é‡å¯å¤±æ•ˆï¼Œä¸´æ—¶è®¾ç½®é‡å¯ä¼šå¤±æ•ˆ)</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> global read_only=1;</span><br><span class="line"></span><br><span class="line">4ã€#4å°æ•°æ®åº“å…³é—­relay-logè‡ªåŠ¨åˆ é™¤åŠŸèƒ½(ä¸´æ—¶ç”Ÿæ•ˆ)</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> global relay_log_purge = 0;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸´æ—¶+æ°¸ä¹…ï¼Œä¸ç”¨é‡å¯    (æ°¸ä¹…ç”Ÿæ•ˆ)</span></span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">relay_log_purge=0</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">relay_log_purge=0</span><br><span class="line"></span><br><span class="line">[root@db03 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">relay_log_purge=0</span><br><span class="line"></span><br><span class="line">[root@db04 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">relay_log_purge=0</span><br></pre></td></tr></table></figure><p>2ã€å®‰è£…nodeã€managerã€sshå…å¯†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql5.6ç‰ˆæœ¬ä½¿ç”¨ 0.56ç‰ˆæœ¬çš„mha</span></span><br><span class="line">wget http://test.driverzeng.com/MySQL_plugins/mha4mysql-manager-0.56-0.el6.noarch.rpm</span><br><span class="line"></span><br><span class="line">wget http://test.driverzeng.com/MySQL_plugins/mha4mysql-node-0.56-0.el6.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#mysql5.7ç‰ˆæœ¬ä½¿ç”¨ 0.58ç‰ˆæœ¬çš„mha</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€æ¨é€nodeåŒ…åœ¨å„å°æœºå™¨</span><br><span class="line">[root@db01 ~]# <span class="keyword">for</span> i <span class="keyword">in</span> 5 52 53 54;<span class="keyword">do</span> scp mha4mysql-node-0.56-0.el7.centos.noarch.rpm 172.16.1.<span class="variable">$i</span>:/root;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">2ã€5å°æœºå™¨å®‰è£…node</span><br><span class="line">[root@db03 ~]# yum -y localinstall mha4mysql-node-0.56-0.el6.noarch.rpm </span><br><span class="line"></span><br><span class="line">3ã€(lb01) mhaç®¡ç†æœºå®‰è£…manager</span><br><span class="line">[root@lb01 ~]# yum -y localinstall mha4mysql-manager-0.56-0.el6.noarch.rpm</span><br><span class="line"></span><br><span class="line">[root@lb01 ~]# rpm -qa |grep mha</span><br><span class="line">mha4mysql-manager-0.56-0.el6.noarch</span><br><span class="line">mha4mysql-node-0.56-0.el6.noarch</span><br><span class="line"></span><br><span class="line">4ã€4å°æœºå™¨åšè½¯è¿æ¥</span><br><span class="line">[root@db01 ~]# <span class="built_in">ln</span> -s /app/mysql-5.6.50/bin/mysqlbinlog  /usr/bin/mysqlbin;<span class="built_in">ln</span> -s /app/mysql-5.6.50/bin/mysql  /usr/bin/mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€5å°æœºå™¨åšå…å¯†ï¼Œè‡ªå·±ä¹Ÿè¦ç»™è‡ªå·±åšå…å¯†</span><br><span class="line"><span class="comment">#ç”Ÿæˆå¯†é’¥å¯¹</span></span><br><span class="line">ssh-keygen -t dsa -P <span class="string">&#x27;&#x27;</span> -f ~/.ssh/id_dsa &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¨é€å…¬é’¥</span></span><br><span class="line">[root@db01 ~]# ssh-copy-id -i ~/.ssh/id_dsa.pub root@172.16.1.5</span><br><span class="line">[root@db01 ~]# ssh-copy-id -i ~/.ssh/id_dsa.pub root@172.16.1.51</span><br><span class="line">[root@db01 ~]# ssh-copy-id -i ~/.ssh/id_dsa.pub root@172.16.1.52</span><br><span class="line">[root@db01 ~]# ssh-copy-id -i ~/.ssh/id_dsa.pub root@172.16.1.53</span><br><span class="line">[root@db01 ~]# ssh-copy-id -i ~/.ssh/id_dsa.pub root@172.16.1.54</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ£€æµ‹æ˜¯å¦å…å¯†æˆåŠŸ</span></span><br><span class="line">[root@db01 ~]# <span class="keyword">for</span> i <span class="keyword">in</span> 5 51 52 53 54;<span class="keyword">do</span> ssh root@172.16.1.<span class="variable">$i</span> <span class="string">&quot;ifconfig|awk &#x27;NR==2&#123;print <span class="variable">$2</span>&#125;&#x27;&quot;</span>;<span class="keyword">done</span></span><br><span class="line">è¾“å‡ºä¿¡æ¯å°±å…å¯†æˆåŠŸ</span><br><span class="line">        inet 10.0.0.5  netmask 255.255.255.0  broadcast 10.0.0.255</span><br><span class="line">        inet 10.0.0.51  netmask 255.255.255.0  broadcast 10.0.0.255</span><br><span class="line">        inet 10.0.0.52  netmask 255.255.255.0  broadcast 10.0.0.255</span><br><span class="line">        inet 10.0.0.53  netmask 255.255.255.0  broadcast 10.0.0.255</span><br><span class="line">        inet 10.0.0.54  netmask 255.255.255.0  broadcast 10.0.0.255</span><br></pre></td></tr></table></figure><p>3ã€é…ç½®MHA</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">1ã€åˆ›å»ºMHAé…ç½®æ–‡ä»¶å­˜æ”¾ç›®å½•</span><br><span class="line">[root@lb01 ~]# <span class="built_in">mkdir</span> /etc/mha</span><br><span class="line"></span><br><span class="line">2ã€ç¼–å†™é…ç½®æ–‡ä»¶      <span class="comment">#app1æ˜¯é¡¹ç›®å</span></span><br><span class="line">[root@lb01 ~]# vim /etc/mha/app1.cnf    </span><br><span class="line">[server default]</span><br><span class="line">manager_log=/etc/mha/logs/manager.log</span><br><span class="line">manager_workdir=/etc/mha/app1</span><br><span class="line">master_binlog_dir=/app/mysql-5.6.50/data</span><br><span class="line">user=mha</span><br><span class="line">password=mha</span><br><span class="line"><span class="comment">#å¿ƒè·³æ£€æµ‹é—´éš”æ—¶é—´2sæ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">ping_interval=2</span><br><span class="line">repl_password=123</span><br><span class="line">repl_user=rep</span><br><span class="line">ssh_user=root</span><br><span class="line">ssh_port=22</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=172.16.1.51</span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line"><span class="comment">#candidate_master=1</span></span><br><span class="line"><span class="comment">#check_repl_delay=0</span></span><br><span class="line">hostname=172.16.1.52</span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">[server3]</span><br><span class="line">hostname=172.16.1.53</span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">[server4]</span><br><span class="line">hostname=172.16.1.54</span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">3ã€db01ä¸»åº“åˆ›å»ºmhaçš„ç®¡ç†ç”¨æˆ·,å…¶ä»–ä»åº“åšäº†ä¸»ä»å¤åˆ¶ï¼Œä¼šæŠŠè¿™ä¸ªç”¨æˆ·å¤åˆ¶è¿‡å»</span><br><span class="line">grant all on *.* to mha@<span class="string">&#x27;172.16.1.%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line">4ã€åˆ›å»ºå·¥ä½œç›®å½•ã€æ—¥å¿—ç›®å½•</span><br><span class="line">[root@lb01 ~]# <span class="built_in">mkdir</span> /etc/mha/&#123;logs,app1&#125;</span><br><span class="line">[root@lb01 ~]# ll /etc/mha/</span><br><span class="line">drwxr-xr-x 2 root root   6 Aug 27 20:20 app1</span><br><span class="line">-rw-r--r-- 1 root root 449 Aug 27 20:17 app1.cnf</span><br><span class="line">drwxr-xr-x 2 root root   6 Aug 27 20:20 logs</span><br><span class="line"></span><br><span class="line">4ã€æ£€æµ‹MHAçš„SSHå…å¯†</span><br><span class="line">[root@lb01 ~]#  masterha_check_ssh --conf=/etc/mha/app1.cnf</span><br><span class="line"></span><br><span class="line">5ã€æ¯æ¬¡å¯åŠ¨å‰å…ˆæ£€æµ‹mhaçš„ä¸»ä»å¤åˆ¶</span><br><span class="line">[root@lb01 ~]#  masterha_check_repl --conf=/etc/mha/app1.cnf</span><br></pre></td></tr></table></figure><p>æ£€æµ‹å…å¯†ç»“æœæ˜¾ç¤ºæˆåŠŸ</p><p><img src="../image/study_img/image-20240827150707399.png" alt="image-20240827150707399"></p><p>æ£€æµ‹mhaçš„ä¸»ä»å¤åˆ¶OK</p><p><img src="../image/study_img/image-20240827150324053.png" alt="image-20240827150324053"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">7ã€å¯åŠ¨MHA</span><br><span class="line">[root@lb01 ~]# <span class="built_in">nohup</span> masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /etc/mha/logs/manager.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">masterha_managerï¼š         å¯åŠ¨å‘½ä»¤</span><br><span class="line">--conf=/etc/mha/app1.cnfï¼š æŒ‡å®šé…ç½®æ–‡ä»¶</span><br><span class="line">--remove_dead_master_confï¼šåšå®Œåˆ‡æ¢åï¼Œä»é…ç½®æ–‡ä»¶ä¸­æ‘˜é™¤å®•æœºçš„ä¸»åº“</span><br><span class="line">--ignore_last_failoverï¼š   å¿½ç•¥ä¸Šä¸€æ¬¡åˆ‡æ¢(åˆ‡æ¢å®Œäº†ï¼Œä¸ç”Ÿäº§é”æ–‡ä»¶)</span><br><span class="line"></span><br><span class="line"><span class="comment">#MHAåˆ‡æ¢æœºåˆ¶ï¼š</span></span><br><span class="line">1).MHAåœ¨åšä¸€æ¬¡åˆ‡æ¢åï¼Œä¼šç”Ÿæˆä¸€ä¸ªé”æ–‡ä»¶ï¼ˆapp1.failover.completeï¼‰åœ¨å·¥ä½œç›®å½•ï¼Œ8ä¸ªå°æ—¶ä¹‹å†…ï¼Œæ— æ³•åšç¬¬äºŒæ¬¡åˆ‡æ¢    ç”Ÿæˆé”æ–‡ä»¶çš„ç›®çš„(ä¸‹ä¸€æ¬¡åˆ‡æ¢çš„æ—¶å€™ä¼šçœ‹ä¸€ä¸‹è¿™ä¸ªé”æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œé”æ–‡ä»¶å­˜åœ¨ä¸åˆ‡æ¢ï¼Œè¿™ä¸ªé”æ–‡ä»¶ä¼šå­˜åœ¨8å°æ—¶)</span><br><span class="line">2).MHAåˆ‡æ¢å®Œæˆåï¼Œä¼šè‡ªåŠ¨ç»“æŸMHAçš„è¿›ç¨‹</span><br><span class="line">[root@lb01 ~]# ll /etc/mha/app1</span><br><span class="line">-rw-r--r-- 1 root root    0 Aug 28 11:25 app1.failover.complete</span><br><span class="line"><span class="comment">#é€‰ä¸»æœºåˆ¶</span></span><br><span class="line">1).åœ¨æ‰€æœ‰ä»åº“ç›¸åŒæ—¶ï¼ŒMHAä¼šé€‰æ‹©é…ç½®æ–‡ä»¶ä¸­serveræ ‡ç­¾<span class="built_in">id</span>æœ€å°çš„ä½œä¸ºä¸»åº“</span><br><span class="line"></span><br><span class="line">8ã€å¯åŠ¨åæ£€æŸ¥</span><br><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">æ˜¾ç¤ºç»“æœå°±OKï¼š</span><br><span class="line">app1 (pid:18582) is running(0:PING_OK), master:172.16.1.51</span><br><span class="line"><span class="comment">#é¡¹ç›®(é…ç½®æ–‡ä»¶å)                         ä¸»åº“IP</span></span><br></pre></td></tr></table></figure><p>4ã€ä½¿ç”¨systemdç®¡ç†MHA</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1ã€åœæ­¢mha</span><br><span class="line">[root@lb01 ~]# masterha_stop --conf=/etc/mha/app1.cnf</span><br><span class="line"></span><br><span class="line">2ã€ä½¿ç”¨systemctlç®¡ç†</span><br><span class="line">[root@lb01 ~]# vim /usr/lib/systemd/system/mha.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=MHA</span><br><span class="line">After=network.target sshd-keygen.service</span><br><span class="line">Wants=sshd-keygen.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=sample</span><br><span class="line">ExecStart=/usr/bin/masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &gt; /etc/mha/logs/manager.log</span><br><span class="line">ExecStop=/usr/bin/masterha_stop --conf=/etc/mha/app1.cnf</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@lb01 ~]# systemctl daemon-reload</span><br><span class="line">[root@lb01 ~]# systemctl start mha</span><br><span class="line">[root@lb01 ~]# systemctl <span class="built_in">enable</span> mha</span><br><span class="line"></span><br><span class="line">3ã€å¯åŠ¨åæ£€æŸ¥</span><br><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:19243) is running(0:PING_OK), master:172.16.1.51</span><br></pre></td></tr></table></figure><h3 id="4ã€MHAæ—¥å¿—åˆ†æ"><strong>4ã€MHAæ—¥å¿—åˆ†æ</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# tailf -100 /etc/mha/logs/manager.log</span><br><span class="line"></span><br><span class="line"><span class="comment">#GITDä¸»ä»æ²¡æœ‰å¼€å¯</span></span><br><span class="line">GTID failover mode = 0</span><br><span class="line">Starting Non-GTID based failover.</span><br><span class="line"></span><br><span class="line"><span class="comment"># VIPæ¼‚ç§»çš„è„šæœ¬æ²¡æœ‰è®¾ç½®</span></span><br><span class="line">master_ip_failover_script is not <span class="built_in">set</span>. Skipping invalidating dead master IP address.</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ²¡æœ‰é…ç½® Candidate masters</span></span><br><span class="line">Candidate masters from the configuration file:</span><br><span class="line">Non-candidate masters:</span><br><span class="line"></span><br><span class="line">candidate_master=1 // è®¾ç«‹å¤ªå­ï¼Œä½†æ˜¯å¦‚æœå¤ªå­è½åå…¶ä»–æœºå™¨æ•°æ®è¶…è¿‡100Mï¼Œå°±åºŸå‚¨</span><br><span class="line">check_repl_delay=0 // å…³é—­å¯¹å¤ªå­è½åçš„æ£€æµ‹</span><br><span class="line"></span><br><span class="line"><span class="comment"># change masterè¯­å¥</span></span><br><span class="line">All other slaves should start replication from here. Statement should be:</span><br><span class="line">CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;172.16.1.54&#x27;</span>, MASTER_PORT=3306,</span><br><span class="line">MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000003&#x27;</span>, MASTER_LOG_POS=878597, MASTER_USER=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br></pre></td></tr></table></figure><p>MHAæ—¥å¿—æ–‡ä»¶é‡Œé¢çš„ç›¸å…³å·¥å…·å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">save_binary_logs</span><br><span class="line">--<span class="built_in">command</span>=save</span><br><span class="line">--start_file=mysql-bin.000001</span><br><span class="line">--start_pos=878597</span><br><span class="line">--binlog_dir=/app/mysql/data</span><br><span class="line">--output_file=/var/tmp/saved_master_binlog_from_172.16.1.52_3306_20240827154042.binlog</span><br><span class="line">--handle_raw_binlog=1</span><br><span class="line">--disable_log_bin=0</span><br><span class="line">--manager_version=0.58</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pply_diff_relay_logs</span><br><span class="line">--<span class="built_in">command</span>=apply</span><br><span class="line">--slave_user=<span class="string">&#x27;mha&#x27;</span></span><br><span class="line">--slave_host=172.16.1.54</span><br><span class="line">--slave_ip=172.16.1.54</span><br><span class="line">--slave_port=3306</span><br><span class="line">--</span><br><span class="line">apply_files=/var/tmp/saved_master_binlog_from_172.16.1.52_3306_20240827154042.binlog</span><br><span class="line">--workdir=/var/tmp</span><br><span class="line">--target_version=5.7.42-<span class="built_in">log</span></span><br><span class="line">--timestamp=20240827154042</span><br><span class="line">--handle_raw_binlog=1</span><br><span class="line">--disable_log_bin=0</span><br><span class="line">--manager_version=0.58</span><br><span class="line">--slave_pass=xxx</span><br></pre></td></tr></table></figure><p>MHAæ—¥å¿—æ–‡ä»¶é‡Œé¢çš„binlogçš„è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å…ˆå°†binlogä¿å­˜åœ¨å®•æœºä¸»åº“çš„ /var/tmp/</span></span><br><span class="line">[root@db02 ~]# ll /var/tmp/saved_master_binlog_from_172.16.1.52_3306_20240827154042.binlog</span><br><span class="line">-rw-r--r-- 1 root root 177 Aug 27 15:40</span><br><span class="line">/var/tmp/saved_master_binlog_from_172.16.1.52_3306_20240827154042.binlog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.å°†binlogä»å®•æœºä¸»åº“ä¿å­˜åˆ°manageræ‰€åœ¨çš„æœºå™¨</span></span><br><span class="line">[root@mha-manager ~]# ll /etc/mha/app1/saved_master_binlog_from_172.16.1.52_3306_20240827154042.binlog</span><br><span class="line">-rw-r--r-- 1 root root 177 Aug 27 15:40 /etc/mha/app1/saved_master_binlog_from_172.16.1.52_3306_20240827154042.binlog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.å°†binlogä»manageræ‰€åœ¨çš„æœºå™¨å‘é€ç»™æ–°ä¸»åº“</span></span><br><span class="line">[root@db04 ~]# ll /var/tmp/saved_master_binlog_from_172.16.1.52_3306_20240827154042.binlog</span><br><span class="line">-rw-r--r-- 1 root root 177 Aug 27 15:40</span><br><span class="line">/var/tmp/saved_master_binlog_from_172.16.1.52_3306_20240827154042.binlog</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240828202522903.png" alt="image-20240828202522903"></p><p><img src="../image/study_img/image-20240827195935226.png" alt="image-20240827195935226"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mhaé…ç½®æ–‡ä»¶ä»¥è¦†ç›–çš„å½¢å¼æ‘˜é™¤</span><br></pre></td></tr></table></figure><h3 id="5ã€MHAé›†ç¾¤çš„æ¢å¤"><strong>5ã€MHAé›†ç¾¤çš„æ¢å¤</strong></h3><p>1ã€å®•æ‰db01ä¸»åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">1ã€åœæ­¢mysql</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld stop</span><br><span class="line"></span><br><span class="line">2ã€db02</span><br><span class="line">root@localhost:(none) &gt; show slave status\G</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">3ã€db03  <span class="comment">#çœ‹åˆ°ä¸»åº“å·²å˜æˆdb02äº†</span></span><br><span class="line">root@localhost:(none) &gt;  show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.1.52</span><br><span class="line">                  Master_User: rep</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000008</span><br><span class="line">          Read_Master_Log_Pos: 120</span><br><span class="line">               Relay_Log_File: db03-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 283</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000008</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">            </span><br><span class="line">4ã€db04  <span class="comment">#çœ‹åˆ°ä¸»åº“å·²å˜æˆdb02äº†</span></span><br><span class="line">root@localhost:(none) &gt;  show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.1.52</span><br><span class="line">                  Master_User: rep</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000008</span><br><span class="line">          Read_Master_Log_Pos: 120</span><br><span class="line">               Relay_Log_File: db04-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 283</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000008</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">            </span><br><span class="line">5ã€æŸ¥çœ‹lb01MHAç®¡ç†æœºå™¨çš„é…ç½®æ–‡ä»¶ï¼Œå·²æ‘˜é™¤db01çš„serveræ ‡ç­¾</span><br></pre></td></tr></table></figure><p>2ã€ä¿®å¤å®•æœºçš„ä¸»åº“ï¼Œå¹¶åŠ å…¥é›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">1ã€#ä¿®å¤å®•æœºçš„ä¸»åº“(db01)</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line">2ã€#æ‰¾åˆ°æœ€åä¸€ä¸ªchange masterè¯­å¥ï¼Œåˆ°å®•æœºçš„ä¸»åº“æ‰§è¡Œ</span><br><span class="line">[root@lb01 ~]# grep -i <span class="string">&#x27;change master to&#x27;</span> /etc/mha/logs/manager.log|<span class="built_in">tail</span> -1</span><br><span class="line">CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;172.16.1.52&#x27;</span>, MASTER_PORT=3306, MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000008&#x27;</span>, MASTER_LOG_POS=120, MASTER_USER=<span class="string">&#x27;rep&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line">3ã€#db01æ‰§è¡Œchange msater è¯­å¥,å¯åŠ¨ä¸»ä»å¤åˆ¶</span><br><span class="line">root@localhost:(none) &gt; CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;172.16.1.52&#x27;</span>, MASTER_PORT=3306, MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000008&#x27;</span>, MASTER_LOG_POS=120, MASTER_USER=<span class="string">&#x27;rep&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; start slave;</span><br><span class="line">root@localhost:(none) &gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.1.52</span><br><span class="line">                  Master_User: rep</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000008</span><br><span class="line">          Read_Master_Log_Pos: 120</span><br><span class="line">               Relay_Log_File: db01-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 283</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000008</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">4ã€#MHAä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå°†db01çš„ä¿¡æ¯åŠ å…¥mhaé…ç½®æ–‡ä»¶</span><br><span class="line">[root@lb01 ~]# vim /etc/mha/app1.cnf </span><br><span class="line">.....</span><br><span class="line">[server1]</span><br><span class="line">hostname=172.16.1.51</span><br><span class="line">port=3306</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€#å¯åŠ¨mha</span><br><span class="line">[root@lb01 ~]# systemctl start mha</span><br><span class="line"></span><br><span class="line">6ã€æ£€æŸ¥è°æ˜¯ä¸»åº“ï¼Œä¼šæŠ¥é”™ï¼Œéœ€è¦å®‰è£…mysqlå‘½ä»¤</span><br><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line"></span><br><span class="line">7ã€å®‰è£…mysqlå‘½ä»¤</span><br><span class="line">å®‰è£…mysqlæº</span><br><span class="line">[root@lb01 ~]# rpm -ivh https://dev.mysql.com/get/mysql84-community-release-el7-1.noarch.rpm</span><br><span class="line"></span><br><span class="line">[root@lb01 ~]# vim /etc/yum.repos.d/mysql-community.repo </span><br><span class="line"><span class="comment">#å°±ä¿®æ”¹è¿™ä¸ªæ ‡ç­¾,å…¶ä»–çš„åˆ é™¤ï¼Œæ–‡ä»¶é‡Œé¢å°±ä¿ç•™è¿™å‡ è¡Œ</span></span><br><span class="line">[mysql56-community]</span><br><span class="line">name=MySQL 5.6 Community Server</span><br><span class="line">baseurl=http://repo.mysql.com/yum/mysql-5.6-community/el/7/<span class="variable">$basearch</span></span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[root@lb01 ~]# yum -y install mysql</span><br><span class="line"></span><br><span class="line">8ã€å†æ¬¡æ‰§è¡Œ</span><br><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:27835) is running(0:PING_OK), master:172.16.1.51</span><br></pre></td></tr></table></figure><h3 id="6ã€å†™è„šæœ¬æ¢å¤é›†ç¾¤ï¼Œæ”¾åˆ°mhaæœºå™¨">6ã€<strong>å†™è„šæœ¬æ¢å¤é›†ç¾¤ï¼Œæ”¾åˆ°mhaæœºå™¨</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:27835) is running(0:PING_OK), master:172.16.1.51</span><br><span class="line"></span><br><span class="line">2ã€å†™è„šæœ¬æ¢å¤ï¼Œæ”¾åˆ°mhaæœºå™¨</span><br><span class="line">[root@lb01 ~]# vim recover.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#è„šæœ¬åŠŸèƒ½ï¼šé›†ç¾¤æ¢å¤è„šæœ¬</span></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">log_file=<span class="string">&#x27;/etc/mha/logs/manager.log&#x27;</span></span><br><span class="line">mha_conf=<span class="string">&#x27;/etc/mha/app1.cnf&#x27;</span></span><br><span class="line">repl_pass=<span class="string">&#x27;123&#x27;</span></span><br><span class="line">mha_user=$(awk -F= <span class="string">&#x27;/^user/&#123;print $2&#125;&#x27;</span> <span class="variable">$&#123;mha_conf&#125;</span>)</span><br><span class="line">mha_password=$(awk -F= <span class="string">&#x27;/^password/&#123;print $2&#125;&#x27;</span> <span class="variable">$&#123;mha_conf&#125;</span>)</span><br><span class="line"><span class="comment">#å®•æœºçš„ä¸»åº“æ˜¯å“ªä¸€å°</span></span><br><span class="line">dowm_master=$(sed -nr <span class="string">&#x27;s#^Master (.*)\(.*\).*!$#\1#gp&#x27;</span> <span class="variable">$&#123;log_file&#125;</span>|<span class="built_in">tail</span> -1)</span><br><span class="line"><span class="comment">#æŸ¥æ‰¾change master è¯­å¥</span></span><br><span class="line">change_master=$(grep -i <span class="string">&#x27;change master to&#x27;</span> <span class="variable">$&#123;log_file&#125;</span>|<span class="built_in">tail</span> -1|awk -F: <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>|sed <span class="string">&quot;s#xxx#<span class="variable">$&#123;repl_pass&#125;</span>#g&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯åŠ¨  éœ€è¦å†™è„šæœ¬æ£€æŸ¥æ˜¯å¦å¯åŠ¨æˆåŠŸ</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æ­£åœ¨ä¿®å¤ä¸»åº“.....&quot;</span></span><br><span class="line">ssh <span class="variable">$&#123;dowm_master&#125;</span> <span class="string">&#x27;/etc/init.d/mysqld start&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line">      mysqladmin -u<span class="variable">$&#123;mha_user&#125;</span> -p<span class="variable">$&#123;mha_password&#125;</span> -h<span class="variable">$&#123;dowm_master&#125;</span> ping &amp;&gt;/dev/null</span><br><span class="line">      <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">           <span class="comment">#æ‰§è¡Œchange masterè¯­å¥</span></span><br><span class="line">           mysql -u<span class="variable">$&#123;mha_user&#125;</span> -p<span class="variable">$&#123;mha_password&#125;</span> -h<span class="variable">$&#123;dowm_master&#125;</span> -e <span class="string">&quot;<span class="variable">$&#123;change_master&#125;</span>;start slave&quot;</span></span><br><span class="line">           <span class="built_in">echo</span> <span class="string">&quot;ä¸»åº“ä¿®å¤å®Œæˆ.....&quot;</span></span><br><span class="line">           <span class="built_in">break</span></span><br><span class="line">     <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æ­£åœ¨è¡¥å…¨MHAé…ç½®æ–‡ä»¶...&quot;</span></span><br><span class="line"><span class="comment">#è¦†ç›–é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">#cat &gt; $&#123;mha_conf&#125; &lt;&lt;-EOF  è¿™æ ·å­å†™ï¼Œcaté‡Œé¢çš„å†…å®¹å°±ä¸ç”¨é¡¶æ ¼å†™</span></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$&#123;mha_conf&#125;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[server default]</span></span><br><span class="line"><span class="string">manager_log=/etc/mha/logs/manager.log</span></span><br><span class="line"><span class="string">manager_workdir=/etc/mha/app1</span></span><br><span class="line"><span class="string">master_binlog_dir=/app/mysql-5.6.50/data</span></span><br><span class="line"><span class="string">master_ip_failover_script=/etc/mha/app1/master_ip_failover</span></span><br><span class="line"><span class="string">password=$&#123;mha_password&#125;</span></span><br><span class="line"><span class="string">ping_interval=2</span></span><br><span class="line"><span class="string">repl_password=123</span></span><br><span class="line"><span class="string">repl_user=rep</span></span><br><span class="line"><span class="string">ssh_port=22</span></span><br><span class="line"><span class="string">ssh_user=root</span></span><br><span class="line"><span class="string">user=$&#123;mha_user&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[server1]</span></span><br><span class="line"><span class="string">hostname=172.16.1.51</span></span><br><span class="line"><span class="string">port=3306</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[server2]</span></span><br><span class="line"><span class="string">hostname=172.16.1.52</span></span><br><span class="line"><span class="string">port=3306</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[server3]</span></span><br><span class="line"><span class="string">hostname=172.16.1.53</span></span><br><span class="line"><span class="string">port=3306</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[server4]</span></span><br><span class="line"><span class="string">hostname=172.16.1.54</span></span><br><span class="line"><span class="string">port=3306</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#[binlog1]</span></span><br><span class="line"><span class="string">#(è¿™ä¸ªé…ç½®äº†ï¼Œå°±æ°¸è¿œä¸ä¼šæå‡ä¸ºä¸»åº“)</span></span><br><span class="line"><span class="string">#no_master=1 </span></span><br><span class="line"><span class="string">#hostname=172.16.1.5</span></span><br><span class="line"><span class="string">#master_binlog_dir=/data/mysql/binlog</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯åŠ¨mha</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æ­£åœ¨å¯åŠ¨MHA.....&quot;</span></span><br><span class="line">systemctl start mha</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line">        masterha_check_status --conf=<span class="variable">$&#123;mha_conf&#125;</span> &amp;&gt;/dev/null</span><br><span class="line">        <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">              action <span class="string">&quot;MHA managerå¯åŠ¨&quot;</span> /bin/true</span><br><span class="line">              <span class="built_in">break</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#æ‰§è¡Œè„šæœ¬</span><br><span class="line">sh -x recover.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€vipçš„æ¼‚ç§»</span><br><span class="line">2ã€é…åˆzabbixçš„è‡ªæ„ˆæ¨¡å¼ï¼Œè¦ç­‰åˆ‡æ¢å®Œæ‰å¯ä»¥æ‰§è¡Œè„šæœ¬  </span><br><span class="line">ä¸Šä¸€æ¬¡å®•æœºçš„ä¸»åº“ï¼Œå’Œè¿™ä¸€æ¬¡çš„æ–°ä¸»åº“ï¼Œéƒ½è¦è®°å½•ä¸€ä¸‹ï¼Œå†åˆ¤æ–­è¿™ä¸ªæ—¥å¿—é‡Œé¢ï¼Œè¿™ä¸€æ¬¡å®•æœºçš„ä¸»åº“ï¼Œæ˜¯ä¸æ˜¯ä¸Šä¸€æ¬¡å®•æœºçš„ä¸»åº“  è¦åœ¨è„šæœ¬å‰é¢åˆ¤æ–­ä¸Šä¸€æ¬¡åˆ‡æ¢æ˜¯å¦å®Œæˆï¼Œå°±æ˜¯çœ‹æŠ¥å‘Šæ˜¯å¦å‡ºæ¥</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•ï¼šæ ¹æ®æ•°æ®æœ€æ–°çš„æå‡ä¸ºä¸»åº“</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç›®å‰ç¯å¢ƒï¼š </span></span><br><span class="line">ä¸»åº“ï¼šdb01</span><br><span class="line">ä»åº“ï¼šdb02ã€db03ã€db04</span><br><span class="line"></span><br><span class="line"><span class="comment">#éœ€æ±‚ï¼šæƒ³è®©db03çš„æ•°æ®æœ€æ–°ï¼Œå…¶ä»–2ä¸ªçš„æ•°æ®è½åï¼Œdb03çš„æ•°æ®æœ€æ–°ï¼Œå°±ä¼šåˆ‡ä¸ºä¸»åº“</span></span><br><span class="line"></span><br><span class="line">1ã€#å½“ä¸çŸ¥é“è°æ˜¯ä¸»åº“æ—¶ï¼Œæ‰§è¡Œè¿™æ¡å‘½ä»¤</span><br><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:27835) is running(0:PING_OK), master:172.16.1.51</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#db01æ‰§è¡Œè„šæœ¬</span><br><span class="line">[root@db01 ~]# sh insert.sh </span><br><span class="line"></span><br><span class="line">3ã€#æƒ³è®©db03æ•°æ®æœ€æ–°ï¼Œå¾—è®©å…¶ä»–2ä¸ªåº“çš„relaylogè½å</span><br><span class="line">(db02)</span><br><span class="line">root@localhost:(none) &gt; stop slave io_thread;</span><br><span class="line">(db04)</span><br><span class="line">root@localhost:(none) &gt; stop slave io_thread;</span><br><span class="line"></span><br><span class="line">æ£€æŸ¥æ•°æ®æ˜¯å¦è½å</span><br><span class="line"><span class="keyword">select</span> * from prod.prod</span><br><span class="line"></span><br><span class="line">4ã€#åœæ­¢ä¸»åº“db01,åœæ­¢è„šæœ¬</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld stop</span><br><span class="line">[root@db01 ~]# sh insert.sh ^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€#db02ã€db04æ£€æŸ¥ä¸»ä»çŠ¶æ€,å·²ç»å˜æˆä¸»åº“</span><br><span class="line">root@localhost:(none) &gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.1.53</span><br><span class="line">                  </span><br><span class="line">6ã€#æ‰§è¡Œè„šæœ¬ï¼Œå°†å®•æ‰çš„db01åŠ å…¥é›†ç¾¤ï¼ŒæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼Œé›†ç¾¤çš„ä¸»åº“å˜æˆdb03</span><br><span class="line">[root@lb01 ~]#  sh recover.sh </span><br><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:31397) is running(0:PING_OK), master:172.16.1.53</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">è„šæœ¬é‡Œé¢çš„ï¼šstart slave ä¼šæŠŠsqlã€ioçº¿ç¨‹èµ·æ¥</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•ï¼šè®¾ç½®å‚¨å›å‚æ•°(å°†æŸå°æ•°æ®åº“çš„æ•°æ®ä¸€ç›´è½å)ï¼Œé€‰ä¸»æ—¶ï¼Œè¯¥æ•°æ®åº“è¢«é€‰ä¸ºä¸»åº“</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è®¾ç«‹å¤ªå­ï¼Œä½†æ˜¯å¦‚æœå¤ªå­è½åå…¶ä»–æœºå™¨æ•°æ®è¶…è¿‡100Mï¼Œå°±åºŸå‚¨</span></span><br><span class="line">candidate_master=1 </span><br><span class="line"><span class="comment">#å…³é—­å¯¹å¤ªå­è½åçš„æ£€æµ‹</span></span><br><span class="line">check_repl_delay=0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#è®©db02æ•°æ®è½åï¼Œé€‰ä¸»æ—¶ï¼Œå¼ºè¡Œè¢«é€‰ä¸ºä¸»åº“</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€ä¿®æ”¹mhaé…ç½®æ–‡ä»¶</span><br><span class="line">[root@lb01 ~]# vim /etc/mha/app1.cnf </span><br><span class="line">.....</span><br><span class="line">[server2]</span><br><span class="line"><span class="comment">#è®¾ç«‹å¤ªå­ï¼Œä½†æ˜¯å¦‚æœå¤ªå­è½åå…¶ä»–æœºå™¨æ•°æ®è¶…è¿‡100Mï¼Œå°±åºŸå‚¨</span></span><br><span class="line">candidate_master=1</span><br><span class="line"><span class="comment">#å…³é—­å¯¹å¤ªå­è½åçš„æ£€æµ‹</span></span><br><span class="line">check_repl_delay=0 </span><br><span class="line">hostname=172.16.1.52</span><br><span class="line">port=3306</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">2ã€é‡å¯mha</span><br><span class="line">[root@lb01 ~]# systemctl restart mha</span><br><span class="line"></span><br><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:31957) is running(0:PING_OK), master:172.16.1.53</span><br><span class="line"></span><br><span class="line">3ã€ä¸»åº“db03æ‰§è¡Œå†™å…¥æ•°æ®è„šæœ¬</span><br><span class="line">[root@db03 ~]# sh insert.sh </span><br><span class="line"></span><br><span class="line">4ã€è®¾ç½®db02æ•°æ®è½å </span><br><span class="line">root@localhost:(none) &gt; stop slave io_thread;</span><br><span class="line">æ­¤æ—¶ï¼Œdb02çš„æ•°æ®è‚¯å®šè½å</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€åœæ­¢db03æ•°æ®åº“ï¼Œåœæ­¢è„šæœ¬</span><br><span class="line">[root@db03 ~]# /etc/init.d/mysqld stop</span><br><span class="line"></span><br><span class="line">[root@db03 ~]# sh insert.sh ^C</span><br><span class="line"></span><br><span class="line">6ã€æŸ¥çœ‹db01ã€db04ä¸»ä»çŠ¶æ€ï¼Œä¸»åº“å¼ºåˆ¶å˜æˆäº†db02</span><br><span class="line">root@localhost:(none) &gt;  show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.1.52</span><br></pre></td></tr></table></figure><h3 id="7ã€-MHAçš„vipæ¼‚ç§»">7ã€ MHAçš„vipæ¼‚ç§»</h3><p>VIPæ¼‚ç§»çš„ä¸¤ç§æ–¹å¼<br>1ï¼‰é€šè¿‡keepalivedçš„æ–¹å¼ï¼Œç®¡ç†è™šæ‹ŸIPçš„æ¼‚ç§»<br>2ï¼‰é€šè¿‡MHAè‡ªå¸¦è„šæœ¬æ–¹å¼ï¼Œç®¡ç†è™šæ‹ŸIPçš„æ¼‚ç§»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#MHA + keepalivedæ–¹æ¡ˆ</span></span><br><span class="line"></span><br><span class="line">1ã€keepalivedå¦‚ä½•å¯ä»¥æ‰¾åˆ°æœ€æ–°çš„ä»åº“</span><br><span class="line">2ã€è¦å†™4ä¸ªè„šæœ¬ï¼Œæ¯å°æœºå™¨æ”¾ä¸€ä¸ªï¼Œåˆ‡æ¢çš„æ—¶å€™å®¹æ˜“å‡ºç°è„‘è£‚</span><br><span class="line">3ã€éœ€è¦ç­‰å¾…MHAåˆ‡æ¢å®Œæˆå†æ¼‚ç§»VIP</span><br><span class="line">4ã€å¤šä¸ªè„šæœ¬åŒæ—¶æ‰§è¡Œï¼Œéœ€è¦å»æ£€æµ‹ä¸åŒæœºå™¨ä¸Šslaveçš„å¤åˆ¶æƒ…å†µ</span><br><span class="line">5ã€ç½‘ä¸Šçš„æ–‡æ¡£å°±2å°ä¹‹é—´æ¼‚ç§»ï¼Œä¸ä¼šåš4å°ï¼Œå¦‚æœ2å°åˆ‡æ¢ï¼Œå¦‚ä½•ä¿è¯åˆ‡åˆ°çš„æ•°æ®æœ€æ–°å‘¢(åšåŠåŒæ­¥å¯ä»¥è§£å†³)</span><br><span class="line">6ã€åŠåŒæ­¥é˜»å¡æ•°æ®å†™å…¥ï¼Œå½±å“ä¸»åº“æ€§èƒ½(è¿™ä¸ªæœºå™¨ä¸æä¾›æœåŠ¡å°±å¯ä»¥è§£å†³)</span><br><span class="line">7ã€äº’ç›¸åˆ‡æ¢çš„2å°ä¸»åº“å‡é…ç½®ï¼Œ(51 51å‡é…ï¼Œ53 54ä¸å‡é…ç½®)</span><br><span class="line"></span><br><span class="line">6ã€7 è¿™2ç‚¹å°±æ˜¯åœ¨ç ¸é’±</span><br><span class="line"></span><br><span class="line">mhaå¯ä»¥æ‰¾åˆ°æœ€æ–°çš„ä»åº“æ›¿æ¢ä¸ºä¸»åº“</span><br></pre></td></tr></table></figure><p><strong>é…ç½®MHA + master_ip_failover  (MHAè‡ªå¸¦è„šæœ¬æ–¹å¼çš„VIPæ¼‚ç§»)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ›´æ”¹MHAçš„é…ç½®æ–‡ä»¶</span><br><span class="line">[root@lb01 ~]# vim /etc/mha/app1/master_ip_failover </span><br><span class="line">master_ip_failover_script=/etc/mha/app1/master_ip_failover</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ä¸‹è½½å†™å¥½çš„å°†è„šæœ¬æ”¾åˆ°å·¥ä½œç›®å½•</span><br><span class="line">[root@lb01 ~]# wget http://test.driverzeng.com/MySQL_File/master_ip_failover</span><br><span class="line"><span class="comment">#ifconfig eth1:1 172.16.1.55/24</span></span><br><span class="line"><span class="comment">#å°±æ˜¯åœ¨è„šæœ¬ä¸­æ·»åŠ VIPçš„å®šä¹‰</span></span><br><span class="line">my <span class="variable">$vip</span> = <span class="string">&#x27;172.16.1.55/24&#x27;</span>;</span><br><span class="line">my <span class="variable">$key</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">my <span class="variable">$ssh_start_vip</span> = <span class="string">&quot;/sbin/ifconfig eth1:<span class="variable">$key</span> <span class="variable">$vip</span>&quot;</span>;</span><br><span class="line">my <span class="variable">$ssh_stop_vip</span> = <span class="string">&quot;/sbin/ifconfig eth1:<span class="variable">$key</span> down&quot;</span>;</span><br><span class="line"></span><br><span class="line">[root@lb01 ~]# <span class="built_in">mv</span> master_ip_failover  /etc/mha/app1</span><br><span class="line"></span><br><span class="line">3ã€æ£€æµ‹MHAçŠ¶æ€</span><br><span class="line">[root@lb01 ~]#  masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:32555) is running(0:PING_OK), master:172.16.1.52</span><br><span class="line"></span><br><span class="line">3ã€æ‰‹åŠ¨åœ¨ä¸»åº“ä¸Šç»‘å®šVIP</span><br><span class="line">[root@db02 ~]# ifconfig eth1:1 172.16.1.55/24</span><br><span class="line"></span><br><span class="line">4ã€ç»™è„šæœ¬æ‰§è¡Œæƒé™</span><br><span class="line">[root@lb01 ~]# <span class="built_in">chmod</span> +x /etc/mha/app1/master_ip_failover</span><br><span class="line"></span><br><span class="line">5ã€é‡å¯mha</span><br><span class="line">[root@lb01 ~]# systemctl stop mha</span><br><span class="line">[root@lb01 ~]# systemctl start mha</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ·»åŠ è„šæœ¬é…ç½®æ–‡ä»¶ï¼ŒæœåŠ¡å¯ä¸æ¥</span></span><br><span class="line">1.æƒé™é—®é¢˜</span><br><span class="line">2ã€è¯­æ³•é—®é¢˜</span><br><span class="line">3ã€æ ¼å¼é—®é¢˜   dos2nuix /etc/mha/app1/master_ip_failover</span><br><span class="line">[root@lb01 ~]#  dos2unix /etc/mha/app1/master_ip_failover</span><br><span class="line">dos2unix: converting file /etc/mha/app1/master_ip_failover to Unix format ...</span><br><span class="line"></span><br><span class="line">5ã€é‡å¯mha</span><br><span class="line">[root@lb01 ~]# systemctl stop mha</span><br><span class="line">[root@lb01 ~]# systemctl start mha</span><br><span class="line"></span><br><span class="line">6ã€æŠŠæ·»åŠ çš„é…ç½®å†™åˆ°è„šæœ¬é‡Œé¢ï¼Œä»¥åè„šæœ¬æœ‰ä»€ä¹ˆæ”¹åŠ¨ï¼Œå°±è¦å†™åœ¨è„šæœ¬é‡Œ</span><br><span class="line">MHAèƒ½å¤Ÿæ‰¾åˆ°æœ€æ–°æ•°æ®çš„ä»åº“</span><br></pre></td></tr></table></figure><p>VIPæ¼‚ç§»åˆ‡æ¢æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">æ—¢ç„¶æœ‰äº†VIP,é‚£ä¹ˆä»¥åç¨‹åºå°±å¾€VIPé‡Œé¢å†™æ•°æ®ï¼Œç°åœ¨è¦æ›´æ”¹å†™æ•°æ®çš„è„šæœ¬</span><br><span class="line"></span><br><span class="line">1ã€æ£€æµ‹ç›®å‰è°æ˜¯ä¸»åº“</span><br><span class="line">[root@lb01 ~]#  masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:51306) is running(0:PING_OK), master:172.16.1.51</span><br><span class="line"></span><br><span class="line">2ã€å…ˆå®æ—¶è¿½è¸ªæ—¥å¿—</span><br><span class="line">[root@lb01 ~]# tailf  /etc/mha/logs/manager.log</span><br><span class="line"></span><br><span class="line">3ã€æ¯ä¸ªæœºå™¨ä¸Šéƒ½ä¿®æ”¹å†™å…¥æ•°æ®çš„è„šæœ¬</span><br><span class="line">[root@db01 ~]# vim insert.sh </span><br><span class="line"><span class="comment">#ä¿®æ”¹ä¸ºVIP</span></span><br><span class="line">master_ip=172.16.1.55</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€æ‰§è¡Œè„šæœ¬</span><br><span class="line">[root@db02 ~]# sh insert.sh </span><br><span class="line"></span><br><span class="line">5ã€åœæ­¢å½“å‰çš„ä¸»åº“</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld stop</span><br><span class="line"></span><br><span class="line">6ã€å¯çœ‹åˆ°å†™å…¥æ•°æ®çš„ç¨‹åºå¼€å§‹æŠ¥é”™</span><br><span class="line">ERROR 2003 (HY000): Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span>172.16.1.55<span class="string">&#x27; (111)</span></span><br><span class="line"><span class="string">Warning: Using a password on the command line interface can be insecure.</span></span><br><span class="line"><span class="string">ERROR 2003 (HY000): Can&#x27;</span>t connect to MySQL server on <span class="string">&#x27;172.16.1.55&#x27;</span> (111)</span><br><span class="line">Warning: Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">ERROR 2003 (HY000): Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span>172.16.1.55<span class="string">&#x27; (111)</span></span><br><span class="line"><span class="string">Warning: Using a password on the command line interface can be insecure.</span></span><br><span class="line"><span class="string">ERROR 2003 (HY000): Can&#x27;</span>t connect to MySQL server on <span class="string">&#x27;172.16.1.55&#x27;</span> (111)</span><br><span class="line"></span><br><span class="line">7ã€çœ‹åˆ°æ—¥å¿—å¼€å§‹æœ‰æ•°æ®è¾“å‡ºï¼Œå¼€å§‹å°†VIPæ¼‚ç§»åˆ°æ–°ä¸»åº“</span><br><span class="line"></span><br><span class="line">8ã€æŸ¥çœ‹db01çš„å†™å…¥æ•°æ®è„šæœ¬å¼€å§‹æ¢å¤æ•°æ®å†™å…¥ï¼Œè¯´æ˜æ•°æ®å†™å…¥åˆ°æ–°ä¸»åº“db02</span><br><span class="line">[root@lb01 ~]# systemctl start mha</span><br><span class="line">[root@lb01 ~]#  masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:55464) is running(0:PING_OK), master:172.16.1.52</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# ifconfig</span><br><span class="line">......</span><br><span class="line">eth1:1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.16.1.55  netmask 255.255.255.0  broadcast </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment">#9ã€æƒ³è¦æŠŠå®•æœºçš„db01æ¢å¤åˆ°é›†ç¾¤ä½œä¸ºä»åº“ï¼Œå°±æ‰§è¡Œæ¢å¤è„šæœ¬</span></span><br></pre></td></tr></table></figure><h3 id="8ã€MYSQL-binlogå®æ—¶åŒæ­¥">8ã€MYSQL binlogå®æ—¶åŒæ­¥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sersync + rsync</span></span><br><span class="line">1ã€åŒæ­¥åˆ°rsyncæœåŠ¡ç«¯çš„å“ªä¸ªç›®å½•</span><br><span class="line">2ã€MHAå‡­ä»€ä¹ˆå»rsyncæœåŠ¡ç«¯çš„backupç›®å½•ä¸‹æ‰¾   (åœ¨mhaçš„é…ç½®æ–‡ä»¶é‡Œé¢é…ç½®)</span><br><span class="line">3ã€ä¸»åº“å˜æˆä»åº“äº†ï¼Œæ€ä¹ˆåŠ(æ¯å°ä»åº“éƒ½å®‰è£…sersync,ä½†ä¸èƒ½å…¨éƒ¨èµ·)</span><br><span class="line">è¿™ä¸ªæ–¹æ¡ˆå¯ä»¥å®æ–½ï¼Œä½†æ˜¯éå¸¸éº»çƒ¦ï¼Œå°±æ€•mysqlå¾ˆåƒå†…å­˜ï¼Œå°±æ€•ç»™rsyncæ€äº†ï¼Œä½†æ˜¯rsyncå¾ˆè½»é‡çº§</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ³¨æ„ï¼Œå¦‚æœä½¿ç”¨sersync,è„šæœ¬é‡Œé¢çš„systemdå†™ç»å¯¹è·¯å¾„</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240828105224674.png" alt="image-20240828105224674"></p><p><strong>ä½¿ç”¨mysqlbinlogåŒæ­¥binlog</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">1ã€MHA é…ç½®binlog server,éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶,åŒæ­¥æ˜¯å¾€MHAç®¡ç†æœºåŒæ­¥</span><br><span class="line">[root@lb01 ~]# vim /etc/mha/app1.cnf</span><br><span class="line">....</span><br><span class="line">[binlog1]</span><br><span class="line"><span class="comment">#(å½“mysqå’Œmhaå®‰è£…åœ¨åŒä¸€ä¸ªæœºå™¨é‡Œé¢,è¿™ä¸ªé…ç½®äº†,å°±æ°¸è¿œä¸ä¼šæå‡ä¸ºä¸»åº“)</span></span><br><span class="line"><span class="comment">#no_master=1 </span></span><br><span class="line">hostname=172.16.1.5</span><br><span class="line">master_binlog_dir=/data/mysql/binlog</span><br><span class="line"></span><br><span class="line">2ã€åœ¨è„šæœ¬é‡Œé¢æ›´æ–°ä¸Šè¿™ä¸ªé…ç½®</span><br><span class="line"></span><br><span class="line">2ã€åˆ›å»ºbinlogç›®å½•</span><br><span class="line">[root@lb01 ~]# <span class="built_in">mkdir</span> -p /data/mysql/binlog</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹ä¸»åº“æ˜¯è°</span><br><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:36583) is running(0:PING_OK), master:172.16.1.51</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€ä¸€å®šè¦å…ˆè¿›å…¥ç›®å½•å†ï¼Œå®æ—¶åŒæ­¥binlog</span><br><span class="line">[root@lb01 ~]# <span class="built_in">cd</span> /data/mysql/binlog/</span><br><span class="line">[root@lb01 binlog]# mysqlbinlog -R --host=172.16.1.51 --user=mha --password=123 --raw --stop-never mysql-bin.000001 &amp;</span><br><span class="line">è¾“å…¥å›è½¦</span><br><span class="line">[1] 60923</span><br><span class="line"><span class="comment">#--host=ä¸»åº“IP</span></span><br><span class="line"></span><br><span class="line">5ã€æŸ¥çœ‹172.16.1.51çš„binlogæ˜¯å¦åŒæ­¥è¿‡æ¥</span><br><span class="line">[root@lb01 binlog]# <span class="built_in">pwd</span></span><br><span class="line">/data/mysql/binlog</span><br><span class="line">[root@lb01 binlog]# ll</span><br><span class="line">total 12016</span><br><span class="line">-rw-rw---- 1 root root     440 Aug 29 18:20 mysql-bin.000001</span><br><span class="line">-rw-rw---- 1 root root     143 Aug 29 18:20 mysql-bin.000002</span><br><span class="line"></span><br><span class="line">6ã€éªŒè¯æ˜¯å¦å®æ—¶åŒæ­¥</span><br><span class="line">172.16.1.51 db01æ‰§è¡Œè„šæœ¬</span><br><span class="line">[root@db01 ~]# sh insert.sh </span><br><span class="line">[root@lb01 binlog]# ll /data/mysql/binlog/</span><br><span class="line">total 12016</span><br><span class="line">-rw-rw---- 1 root root     440 Aug 29 18:20 mysql-bin.000001</span><br><span class="line">-rw-rw---- 1 root root     143 Aug 29 18:20 mysql-bin.000002</span><br><span class="line"><span class="comment">#æŸ¥çœ‹æœ€åä¸€ä¸ªbinlogçš„Â·å¤§å°æ˜¯å¦å˜åŒ–ï¼Œå˜åŒ–åˆ™å®æ—¶åŒæ­¥binlog,å†å’Œdb01ä¸»åº“çš„binlogå¯¹æ¯”ï¼ŒæŸ¥çœ‹å¤§å°æ˜¯å¦ä¸€æ ·ï¼Œä¸€æ ·åˆ™åŒæ­¥æˆåŠŸ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ·æ–°binlog  å†åˆ°mhaç®¡ç†æœºä¸ŠæŸ¥çœ‹æ˜¯å¦æœ‰æ–°çš„binlog</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot -p123 flush-log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7ã€å½“db02å˜æˆä»åº“æ—¶ï¼Œå°±ä¸èƒ½ç”¨ä¸Šæ¡å‘½ä»¤å»æ‹‰å–binlog,æ‰€ä»¥hostè¦æ”¹æˆvipï¼Œå°±æ¯”è¾ƒæ–¹ä¾¿</span><br><span class="line">[root@lb01 binlog]# <span class="built_in">kill</span> %1     </span><br><span class="line">æˆ–è€…killall  mysqlbinlog</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä½¿ç”¨VIPæ‹‰å–binlog</span></span><br><span class="line">[root@lb01 ~]# <span class="built_in">cd</span> /data/mysql/binlog/</span><br><span class="line">[root@lb01 binlog]# mysqlbinlog -R --host=172.16.1.55 --user=mha --password=123 --raw --stop-never mysql-bin.000001 &amp;</span><br><span class="line">è¾“å…¥å›è½¦</span><br><span class="line">[1] 60923</span><br><span class="line"><span class="comment">#--host=VIP</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# vim /root/failover_status</span><br><span class="line">new_master=$(sed -nr <span class="string">&#x27;s#^app1.*failover (.*)\(.*\) to (.*)\(.*\) succeeded$#\2#gp&#x27;</span> /etc/mha/logs/manager.log|<span class="built_in">tail</span> -1)</span><br><span class="line">old_master=$(sed -nr <span class="string">&#x27;s#^app1.*failover (.*)\(.*\) to (.*)\(.*\) succeeded$#\1#gp&#x27;</span> /etc/mha/logs/manager.log|<span class="built_in">tail</span> -1)</span><br><span class="line"><span class="comment">#app1: MySQL Master failover 172.16.1.51(172.16.1.51:3306) to 172.16.1.52(172.16.1.52:3306) succeeded</span></span><br><span class="line"></span><br><span class="line">[root@lb01 ~]# vim vip-recover.sh </span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">. /root/failover_status</span><br><span class="line">log_file=<span class="string">&#x27;/etc/mha/logs/manager.log&#x27;</span></span><br><span class="line">mha_conf=<span class="string">&#x27;/etc/mha/app1.cnf&#x27;</span></span><br><span class="line">repl_pass=<span class="string">&#x27;123&#x27;</span></span><br><span class="line">mha_user=$(awk -F= <span class="string">&#x27;/^user/&#123;print $2&#125;&#x27;</span> <span class="variable">$&#123;mha_conf&#125;</span>)</span><br><span class="line">mha_password=$(awk -F= <span class="string">&#x27;/^password/&#123;print $2&#125;&#x27;</span> <span class="variable">$&#123;mha_conf&#125;</span>)</span><br><span class="line"><span class="comment">#å®•æœºçš„ä¸»åº“æ˜¯å“ªä¸€å°</span></span><br><span class="line">dowm_master=$(sed -nr <span class="string">&#x27;s#^Master (.*)\(.*\).*!$#\1#gp&#x27;</span> <span class="variable">$&#123;log_file&#125;</span>|<span class="built_in">tail</span> -1)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line"><span class="comment">#çœ‹çœ‹down_masterå’Œæ–‡ä»¶é‡Œé¢æ—§ä¸»åº“æ˜¯å¦ä¸€è‡´</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;dowm_master&#125;</span> == <span class="variable">$&#123;old_master&#125;</span> ];<span class="keyword">then</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥æ‰¾change master è¯­å¥</span></span><br><span class="line">change_master=$(grep -i <span class="string">&#x27;change master to&#x27;</span> <span class="variable">$&#123;log_file&#125;</span>|<span class="built_in">tail</span> -1|awk -F: <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>|sed <span class="string">&quot;s#xxx#<span class="variable">$&#123;repl_pass&#125;</span>#g&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯åŠ¨  éœ€è¦å†™è„šæœ¬æ£€æŸ¥æ˜¯å¦å¯åŠ¨æˆåŠŸ</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æ­£åœ¨ä¿®å¤ä¸»åº“.....&quot;</span></span><br><span class="line">ssh <span class="variable">$&#123;dowm_master&#125;</span> <span class="string">&#x27;/etc/init.d/mysqld start&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line">      mysqladmin -u<span class="variable">$&#123;mha_user&#125;</span> -p<span class="variable">$&#123;mha_password&#125;</span> -h<span class="variable">$&#123;dowm_master&#125;</span> ping &amp;&gt;/dev/null</span><br><span class="line">      <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">           <span class="comment">#æ‰§è¡Œchange masterè¯­å¥</span></span><br><span class="line">           mysql -u<span class="variable">$&#123;mha_user&#125;</span> -p<span class="variable">$&#123;mha_password&#125;</span> -h<span class="variable">$&#123;dowm_master&#125;</span> -e <span class="string">&quot;<span class="variable">$&#123;change_master&#125;</span>;start slave&quot;</span></span><br><span class="line">           <span class="built_in">echo</span> <span class="string">&quot;ä¸»åº“ä¿®å¤å®Œæˆ.....&quot;</span></span><br><span class="line">           <span class="built_in">break</span></span><br><span class="line">     <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æ­£åœ¨è¡¥å…¨MHAé…ç½®æ–‡ä»¶...&quot;</span></span><br><span class="line"><span class="comment">#è¦†ç›–é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">#cat &gt; $&#123;mha_conf&#125; &lt;&lt;-EOF  è¿™æ ·å­å†™ï¼Œcaté‡Œé¢çš„å†…å®¹å°±ä¸ç”¨é¡¶æ ¼å†™</span></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$&#123;mha_conf&#125;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[server default]</span></span><br><span class="line"><span class="string">manager_log=/etc/mha/logs/manager.log</span></span><br><span class="line"><span class="string">manager_workdir=/etc/mha/app1</span></span><br><span class="line"><span class="string">master_binlog_dir=/app/mysql-5.6.50/data</span></span><br><span class="line"><span class="string">master_ip_failover_script=/etc/mha/app1/master_ip_failover</span></span><br><span class="line"><span class="string">password=$&#123;mha_password&#125;</span></span><br><span class="line"><span class="string">ping_interval=2</span></span><br><span class="line"><span class="string">repl_password=123</span></span><br><span class="line"><span class="string">repl_user=rep</span></span><br><span class="line"><span class="string">ssh_port=22</span></span><br><span class="line"><span class="string">ssh_user=root</span></span><br><span class="line"><span class="string">user=$&#123;mha_user&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[server1]</span></span><br><span class="line"><span class="string">hostname=172.16.1.51</span></span><br><span class="line"><span class="string">port=3306</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[server2]</span></span><br><span class="line"><span class="string">hostname=172.16.1.52</span></span><br><span class="line"><span class="string">port=3306</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[server3]</span></span><br><span class="line"><span class="string">hostname=172.16.1.53</span></span><br><span class="line"><span class="string">port=3306</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[server4]</span></span><br><span class="line"><span class="string">hostname=172.16.1.54</span></span><br><span class="line"><span class="string">port=3306</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[binlog1]</span></span><br><span class="line"><span class="string">#(è¿™ä¸ªé…ç½®äº†ï¼Œå°±æ°¸è¿œä¸ä¼šæå‡ä¸ºä¸»åº“)</span></span><br><span class="line"><span class="string">#no_master=1 </span></span><br><span class="line"><span class="string">hostname=172.16.1.5</span></span><br><span class="line"><span class="string">master_binlog_dir=/data/mysql/binlog</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯åŠ¨mha</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æ­£åœ¨å¯åŠ¨MHA.....&quot;</span></span><br><span class="line">systemctl start mha</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line">        masterha_check_status --conf=<span class="variable">$&#123;mha_conf&#125;</span> &amp;&gt;/dev/null</span><br><span class="line">        <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">              action <span class="string">&quot;MHA managerå¯åŠ¨&quot;</span> /bin/true</span><br><span class="line">              <span class="built_in">exit</span> 0</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"> <span class="keyword">else</span> </span><br><span class="line">     <span class="built_in">continue</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="9ã€åŸºäºGTIDçš„ä¸»ä»å¤åˆ¶"><strong>9ã€åŸºäºGTIDçš„ä¸»ä»å¤åˆ¶</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åœæ­¢mha</span></span><br><span class="line">[root@lb01 ~]# systemctl stop mha</span><br><span class="line">å› ä¸ºåœä¸»åº“çš„æ—¶å€™é˜²æ­¢MHAåˆ‡æ¢</span><br><span class="line"></span><br><span class="line">å› ä¸ºMHAå•¥æ ·çš„ä¸»ä»å¤åˆ¶éƒ½å¯ä»¥ç»“åˆï¼Œä¸éœ€è¦å¯¹å½“å‰çš„ä¸»ä»å¤åˆ¶åšä»»ä½•æ”¹åŠ¨ï¼Œç°åœ¨æ­å»ºGTIDçš„ä¸»ä»å¤åˆ¶ï¼Œçœ‹çœ‹MHAæ˜¯å¦ç»“åˆå…¼å®¹æ‰€æœ‰çš„ä¸»ä»å¤åˆ¶</span><br></pre></td></tr></table></figure><p><strong>ä»€ä¹ˆæ˜¯GTID</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GTIDï¼šäº‹åŠ¡æäº¤åšçš„ä¸»ä»å¤åˆ¶(å…¨å±€äº‹åŠ¡æ ‡è¯†ç¬¦)</span><br><span class="line">æ ‡è¯†ç¬¦æ˜¯ç”±UUID + TIDç»„æˆ</span><br><span class="line">UUIDï¼šä¸»åº“çš„èº«ä»½è¯å·</span><br><span class="line">TIDï¼šäº‹åŠ¡æäº¤å·</span><br></pre></td></tr></table></figure><p>GTIDç‰¹æ€§<br>(1).æ”¯æŒå¤šçº¿ç¨‹å¤åˆ¶ï¼šäº‹å®ä¸Šæ˜¯é’ˆå¯¹æ¯ä¸ªdatabaseå¼€å¯ç›¸åº”çš„ç‹¬ç«‹çº¿ç¨‹,å³æ¯ä¸ªåº“æœ‰ä¸€ä¸ªå•ç‹¬çš„(sqlthread).<br>(2).æ”¯æŒå¯ç”¨GTID,åœ¨é…ç½®ä¸»ä»å¤åˆ¶,ä¼ ç»Ÿçš„æ–¹å¼é‡Œ,ä½ éœ€è¦æ‰¾åˆ°binlogå’ŒPOSç‚¹,ç„¶åchange master toæŒ‡å‘.<br>åœ¨mysql5.6é‡Œ,æ— é¡»å†çŸ¥é“binlogå’ŒPOSç‚¹,åªéœ€è¦çŸ¥é“masterçš„IP/ç«¯å£/è´¦å·å¯†ç å³å¯,å› ä¸ºåŒæ­¥å¤åˆ¶æ˜¯è‡ªåŠ¨çš„,MySQLé€šè¿‡å†…éƒ¨æœºåˆ¶GTIDè‡ªåŠ¨æ‰¾ç‚¹åŒæ­¥.<br>(3).åŸºäºRowå¤åˆ¶åªä¿å­˜æ”¹å˜çš„åˆ—,å¤§å¤§èŠ‚çœDisk Space/Network resourceså’ŒMemory usage.<br>(4).æ”¯æŒæŠŠMaster å’ŒSlaveçš„ç›¸å…³ä¿¡æ¯è®°å½•åœ¨Tableä¸­åŸæ¥æ˜¯è®°å½•åœ¨æ–‡ä»¶é‡Œ,è®°å½•åœ¨è¡¨é‡Œ,å¢å¼ºå¯ç”¨æ€§<br>(5).æ”¯æŒå»¶è¿Ÿå¤åˆ¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">1ã€è¿æ¥è¿›å»å…³é—­ä¹‹å‰çš„ä¸»ä»å¤åˆ¶</span><br><span class="line">stop slave;reset slave all;show slave status\G</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">################# ä¼ ç»Ÿä¸»ä»å¤åˆ¶æ­¥éª¤</span></span><br><span class="line"><span class="comment"># 1.ä¿®æ”¹ä¸»åº“é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=1</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.ä¿®æ”¹ä»åº“é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=2</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=3</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=4</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.åœ¨ä¸»åº“ä¸Šåˆ›å»ºä¸»ä»å¤åˆ¶ç”¨æˆ·</span></span><br><span class="line">grant replication slave on *.* to rep@<span class="string">&#x27;172.16.1.5%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.ä¸»åº“æŸ¥çœ‹binlogå’Œä½ç½®ç‚¹</span></span><br><span class="line">mysql&gt; show master status;</span><br><span class="line">+------------------+----------+</span><br><span class="line">| File             | Position |</span><br><span class="line">+------------------+----------+</span><br><span class="line">| mysql-bin.000012 | 154      |</span><br><span class="line">+------------------+----------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.ä»åº“change master</span></span><br><span class="line">change master to</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file=<span class="string">&#x27;mysql-bin.000012&#x27;</span>,</span><br><span class="line">master_log_pos=154;</span><br><span class="line"><span class="comment"># 6.å¼€å¯ä¸»ä»å¤åˆ¶</span></span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure><p>åŸºäºGTIDçš„ä¸»ä»å¤åˆ¶</p><p><em>å…ˆå†³æ¡ä»¶</em><br>1ï¼‰ä¸»åº“å’Œä»åº“éƒ½è¦å¼€å¯binlog<br>2ï¼‰ä¸»åº“å’Œä»åº“server-idä¸åŒ<br>3ï¼‰è¦æœ‰ä¸»ä»å¤åˆ¶ç”¨æˆ·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">1ã€è¿æ¥è¿›å»å…³é—­ä¹‹å‰çš„ä¸»ä»å¤åˆ¶</span><br><span class="line">stop slave;reset slave all;show slave status\G</span><br><span class="line"></span><br><span class="line">2ã€ä¿®æ”¹ä¸»åº“é…ç½®æ–‡ä»¶</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=1</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">3ã€ä¿®æ”¹ä»åº“é…ç½®æ–‡ä»¶</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=2</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=3</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id=4</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">4ã€åœ¨ä¸»åº“ä¸Šåˆ›å»ºä¸»ä»å¤åˆ¶ç”¨æˆ·</span><br><span class="line">grant replication slave on *.* to rep@<span class="string">&#x27;172.16.1.%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line">åŸºäºGTIDçš„ä¸»ä»å¤åˆ¶ä¸ç”¨å»è®°ä½ç½®ç‚¹ï¼Œä»–ä¼šæ ¹æ®äº‹åŠ¡å»æ‰¾ä½ç½®ç‚¹</span><br><span class="line"></span><br><span class="line">5ã€ä»åº“æ‰§è¡Œchange masterè¯­å¥</span><br><span class="line">change master to</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_auto_position=1;</span><br><span class="line"></span><br><span class="line"><span class="comment">## ##æŠ¥é”™ï¼š</span></span><br><span class="line">mysql&gt; change master to</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_auto_position=1;</span><br><span class="line">ERROR 1777 (HY000): CHANGE MASTER TO MASTER_AUTO_POSITION = 1 cannot be executed because @@GLOBAL.GTID_MODE = OFF.</span><br><span class="line">(#GLOBAL.GTID_MODE = OFF GTIDçš„æ¨¡å¼æ²¡æœ‰å¼€)</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; show variables like <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line">+---------------------------------+-----------+</span><br><span class="line">| Variable_name                   | Value     |</span><br><span class="line">+---------------------------------+-----------+</span><br><span class="line">| binlog_gtid_simple_recovery     | ON        |</span><br><span class="line">| enforce_gtid_consistency        | OFF       |</span><br><span class="line">| gtid_executed                   | 1000      |</span><br><span class="line">| gtid_mode                       | OFF       |#GTIDçš„æ¨¡å¼æ²¡æœ‰å¼€</span><br><span class="line">| gtid_next                       | AUTOMATIC |</span><br><span class="line">| gtid_owned                      |           |</span><br><span class="line">| gtid_purged                     |           |</span><br><span class="line">| simplified_binlog_gtid_recovery | OFF       |</span><br><span class="line">+---------------------------------+-----------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#########    MySQL5.6å¼€å¯GTID  ######</span></span><br><span class="line">6ã€4å°MYSQLæœºå™¨ [mysqld]æ ‡ç­¾ é…ç½®æ–‡ä»¶åŠ å…¥è¿™å‡ ä¸ªé…ç½®</span><br><span class="line"><span class="comment">#è¿™ä¸ªé…ç½®å°±åœ¨é…ç½®æ–‡ä»¶é‡Œé¢ï¼Œä¸ç”¨åˆ é™¤ï¼Œå³ä½¿ä½¿ç”¨ä¼ ç»Ÿçš„ä¹Ÿä¸å½±å“</span></span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[root@db03 ~]# vim /etc/my.cnf</span><br><span class="line">[root@db04 ~]# vim /etc/my.cnf</span><br><span class="line">.....</span><br><span class="line"><span class="comment">#å¼€GTIDæ¨¡å—</span></span><br><span class="line">gtid_mode=ON</span><br><span class="line"><span class="comment">#ä¿è¯GTIDæ•°æ®å¼ºä¸€è‡´æ€§</span></span><br><span class="line">enforce_gtid_consistency</span><br><span class="line"><span class="comment">#ä»åº“æ—¥å¿—çš„æ›´æ–°ï¼ˆ1.åŸºäºGTIDçš„ä¸»ä»å¤åˆ¶ 2.åŒä¸»+keepalived 3.çº§è”å¤åˆ¶ï¼‰</span></span><br><span class="line">log-slave-updates</span><br><span class="line"><span class="comment">#å¼€å¯binlog</span></span><br><span class="line">log_bin=mysql-bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#########    MySQL5.7å¼€å¯GTID  ######</span></span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency</span><br></pre></td></tr></table></figure><p>[root@db02 ~]# tailf -100 /app/mysql-5.6.50/data/db02.err</p><p><img src="../image/study_img/image-20240828121147681.png" alt="image-20240828121147681"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">7ã€é‡å¯</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line">8ã€è¿æ¥è¿›å»ä»åº“ï¼Œä»åº“æ‰§è¡Œchange masterè¯­å¥</span><br><span class="line">change master to</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_auto_position=1;</span><br><span class="line"></span><br><span class="line">9ã€å¼€å¯ä¸»ä»å¤åˆ¶ï¼Œå¹¶æŸ¥çœ‹çŠ¶æ€</span><br><span class="line">start slave;show slave status\G</span><br><span class="line"></span><br><span class="line"> Auto_Position: 1</span><br><span class="line"> </span><br><span class="line"> 10ã€MHAåˆ‡æ¢ä¸»ä»çš„æ—¶å€™è„šæœ¬é‡Œé¢ä¼šæ‰§è¡Œchange masterè¯­å¥ï¼Œé‚£ä¸ªè„šæœ¬é‡Œé¢çš„ä¹Ÿæ˜¯æ‰§è¡Œmaster_auto_position=1;</span><br><span class="line"> </span><br><span class="line"> 11ã€ä¸»åº“åˆ›å»ºä¸€ä¸ªåº“</span><br><span class="line"> root@localhost:(none) &gt; create database gtid;</span><br><span class="line"> root@localhost:(none) &gt; show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+-----------------------------------------------------------------------------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                       |</span><br><span class="line">+------------------+----------+--------------+------------------+-----------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000048 |   221998 |              |                  | a45796f8-61ca-11ef-808a-000c29688028:1-1058,</span><br><span class="line">df4b2d8a-54d3-11ef-ac00-000c29d088a4:1-564 |</span><br><span class="line">+------------------+----------+--------------+------------------+-----------------------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> 12ã€ä»åº“æŸ¥çœ‹çŠ¶æ€</span><br><span class="line"> *************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.1.51</span><br><span class="line">                  Master_User: rep</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                  .......</span><br><span class="line">Retrieved_Gtid_Set: df4b2d8a-54d3-11ef-ac00-000c29d088a4:563-564 Executed_Gtid_Set: a45796f8-61ca-11ef-808a-000c29688028:1-1058</span><br></pre></td></tr></table></figure><p>ç»™åŸºäºGTIDçš„ä¸»ä»å¤åˆ¶ç»‘å®šVIP,å®ç°VIPæ¼‚ç§»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1ã€æŸ¥çœ‹ä¹‹å‰ç»‘å®šçš„VIPåœ¨å“ªï¼Œå‘ç°åœ¨db02ä¸Šé¢ï¼Œéœ€è¦è§£ç»‘vip</span><br><span class="line">[root@db02 ~]# ifconfig eth1:1 down</span><br><span class="line"></span><br><span class="line">2ã€æˆ‘æƒ³è®©db01ä½œä¸ºä¸»åº“ï¼Œéœ€è¦åœ¨ä¸»åº“ä¸Šé¢ç»‘å®šVIP</span><br><span class="line">[root@db01 ~]# ifconfig eth1:1 172.16.1.55/24</span><br><span class="line"></span><br><span class="line">3ã€å…ˆæ£€æŸ¥æ‹‰å–binlogçš„å‘½ä»¤æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæ²¡æœ‰å¯åŠ¨ï¼Œå°±å¯åŠ¨</span><br><span class="line">[root@lb01 binlog]# <span class="built_in">jobs</span></span><br><span class="line">[2]+  Running                 mysqlbinlog -R --host=172.16.1.55 --user=mha --password=123 --raw --stop-never mysql-bin.000001 &amp;</span><br><span class="line"></span><br><span class="line">4ã€MHAç®¡ç†æœºæ£€æµ‹repl</span><br><span class="line">[root@lb01 ~]# masterha_check_repl --conf=/etc/mha/app1.cnf</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">5ã€å¯åŠ¨mha,æ£€æµ‹å½“å‰çš„ä¸»åº“</span><br><span class="line">[root@lb01 ~]# systemctl start mha</span><br><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:76089) is running(0:PING_OK), master:172.16.1.51</span><br><span class="line"></span><br><span class="line">6ã€æµ‹è¯•ï¼Œdb01æ‰§è¡Œè„šæœ¬</span><br><span class="line">[root@db01 ~]# sh insert.sh</span><br><span class="line"></span><br><span class="line">7ã€å®æ—¶è¿½è¸ªmhaæ—¥å¿—æ–‡ä»¶</span><br><span class="line">[root@lb01 ~]# tailf /etc/mha/logs/manager.log</span><br><span class="line"></span><br><span class="line">8ã€ç­‰å¾…ä¸€ä¼šï¼Œåœæ­¢db01æ•°æ®åº“</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld stop</span><br><span class="line"></span><br><span class="line">9ã€å†™å…¥æ•°æ®çš„è„šæœ¬å¼€å§‹æ‰§è¡Œé”™è¯¯ï¼Œç­‰å¾…ä¸€ä¼šï¼Œè„šæœ¬æ¢å¤æ­£å¸¸å†™å…¥ï¼Œè¯´æ˜vipæ¼‚ç§»åˆ°db02æœºå™¨</span><br></pre></td></tr></table></figure><p><strong>æŠ¥é”™è§£å†³</strong></p><p>æŠ¥é”™1ã€downæ‰ä¸»åº“ï¼Œvipåˆ‡æ¢äº†ï¼Œæƒ³è¦å°†å®•æ‰çš„ä¸»åº“åŠ å…¥é›†ç¾¤ï¼Œæ£€æµ‹replæ˜¯å¦å¥åº·ï¼Œå‡ºç°æŠ¥é”™</p><p><img src="../image/study_img/image-20240830001104977.png" alt="image-20240830001104977"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1ã€å…ˆæ£€æŸ¥mysqlbinlogæ˜¯å¦è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¿è¡Œå°±å…ˆè¿è¡Œ</span><br><span class="line">[root@db02 ~]# <span class="built_in">jobs</span></span><br><span class="line">[1]+  Running                 mysqlbinlog -R --host=172.16.1.55 --user=mha --password=123 --raw --stop-never mysql-bin.000001 &amp;</span><br><span class="line"></span><br><span class="line">2ã€æ£€æŸ¥vipæ˜¯å¦å­˜åœ¨åœ¨æŸä¸ªæ•°æ®åº“ä¸Šé¢ï¼Œå¦‚æœåœ¨ï¼Œé‚£ä¹ˆæœ‰vipçš„å°†ä½œä¸ºä¸»åº“ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç»™ä¸»åº“ç»‘å®švip</span><br><span class="line"></span><br><span class="line">3ã€æ£€æŸ¥ä¸»ä»å¤åˆ¶æ˜¯å¦æ­£å¸¸ï¼Œå¦‚æœæ¯ä¸ªæœºå™¨çš„ä¸»ä»å¤åˆ¶éƒ½ä¸æ­£å¸¸ï¼Œä»åº“éœ€è¦é‡æ–°æ‰§è¡Œchange master è¯­å¥</span><br><span class="line">stop slave;</span><br><span class="line"></span><br><span class="line">change master to</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_auto_position=1;</span><br><span class="line">    </span><br><span class="line">stop slave; start slave;show slave status\G </span><br><span class="line"></span><br><span class="line">4ã€æŸ¥çœ‹ä¸»ä»å¤åˆ¶æ¢å¤æ­£å¸¸ä¹‹åï¼Œæ£€æŸ¥å¥åº·çŠ¶æ€ï¼Œå¦‚æœæ£€æŸ¥çŠ¶æ€æ²¡é—®é¢˜ï¼Œå°±å¯åŠ¨mha</span><br></pre></td></tr></table></figure><p>æŠ¥é”™2ï¼šåŸºäºä¼ ç»Ÿå¤åˆ¶çš„åŸºç¡€ä¸Šåšäº†GTIDä¸»ä»å¤åˆ¶ä¹‹åï¼Œå½“ä¸»ä»å‡ºç°æ•°æ®ä¸ä¸€è‡´çš„ç°è±¡ï¼Œéœ€è¦å¯¹ä¸»åº“è¿›è¡Œå…¨å¤‡ï¼Œä½†æ˜¯å…¨å¤‡çš„binlogé‡Œé¢åŒ…å«ä¼ ç»Ÿçš„ä¸»ä»å¤åˆ¶binlog,å¯¼å…¥æ•°æ®æ—¶æŠ¥é”™ï¼ŒSQLçº¿ç¨‹æŠ¥é”™</p><p><img src="../image/study_img/image-20240902214618651.png" alt="image-20240902214618651"></p><p><img src="../image/study_img/image-20240902214644529.png" alt="image-20240902214644529"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è§£å†³åŠæ³•ï¼š</span></span><br><span class="line"></span><br><span class="line">1ã€ä»åº“å…³é—­ä¸»ä»å¤åˆ¶ï¼Œå…³é—­è‡ªåŠ¨æŸ¥æ‰¾ä½ç½®ç‚¹</span><br><span class="line">root@localhost:(none) &gt; STOP SLAVE;</span><br><span class="line">root@localhost:(none) &gt; change master to master_auto_position=0;</span><br><span class="line"></span><br><span class="line">2ã€ä¸»åº“æ‰“ç‚¹å…¨å¤‡ï¼Œåœ¨æ¢å¤æ—¶å…³é—­GTIDå‚æ•°</span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 -A -R --triggers --master-data=1 --single-transaction --set-gtid-purged=off|gzip &gt; /tmp/full.sql.gz</span><br><span class="line"></span><br><span class="line">3ã€ä¸»åº“å°†å…¨å¤‡çš„æ•°æ®å‘ç»™å…¶ä»–ä»åº“</span><br><span class="line">[root@db02 ~]# <span class="keyword">for</span> i <span class="keyword">in</span> 51 53 54 ;<span class="keyword">do</span> scp /tmp/full.sql.gz 172.16.1.<span class="variable">$i</span>:/tmp;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">4ã€ä»åº“å¯¼å…¥å…¨å¤‡æ•°æ®</span><br><span class="line">[root@db01 ~]# zcat /tmp/full.sql.gz |mysql -uroot -p123</span><br><span class="line">[root@db03 ~]# zcat /tmp/full.sql.gz |mysql -uroot -p123</span><br><span class="line">[root@db04 ~]# zcat /tmp/full.sql.gz |mysql -uroot -p123</span><br><span class="line"></span><br><span class="line">5ã€æŸ¥çœ‹æ‰“ç‚¹çš„ä½ç½®ç‚¹</span><br><span class="line">[root@db01 ~]# zcat /tmp/full.sql.gz |<span class="built_in">head</span>  -25</span><br><span class="line">CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000001&#x27;</span>, MASTER_LOG_POS=151;</span><br><span class="line"></span><br><span class="line">6ã€æ‰€æœ‰ä»åº“æ‰§è¡Œchange masterè¯­å¥ï¼Œé‡å¯ä¸»ä»å¤åˆ¶</span><br><span class="line">change master to</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.52&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file=<span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">master_log_pos=151,</span><br><span class="line">master_port=3306;</span><br><span class="line"></span><br><span class="line">start slave;show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.1.52</span><br><span class="line">                  Master_User: rep</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 151</span><br><span class="line">               Relay_Log_File: db01-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 314</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">            </span><br><span class="line"><span class="comment">#æ­¤æ—¶è™½ç„¶çœ‹åˆ°å˜æˆä¼ ç»Ÿçš„ä¸»ä»å¤åˆ¶ï¼Œä½†æ˜¯åªè¦é…ç½®æ–‡ä»¶é‡Œé¢å†™äº†å¼€å¯GTIDçš„Â·1é…ç½®ï¼Œå¾€æ•°æ®åº“é‡Œé¢å†™æ•°æ®ï¼Œå°±ä¼šå˜æˆCTIDä¸»ä»å¤åˆ¶ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">change master to</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.52&#x27;</span>,</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_auto_position=1;</span><br><span class="line">    </span><br><span class="line">stop slave; start slave;show slave status\G </span><br></pre></td></tr></table></figure><h3 id="10ã€Mysqlçš„è¯»å†™åˆ†ç¦»">10ã€<strong>Mysqlçš„è¯»å†™åˆ†ç¦»</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¯»å†™åˆ†ç¦»è½¯ä»¶</span><br><span class="line">1.mysql-proxy</span><br><span class="line">2.Atlas  360å†™çš„</span><br><span class="line">3.MyCat (é‡é‡çº§ï¼Œæ¯”è¾ƒå èµ„æº)</span><br></pre></td></tr></table></figure><p>Atlasç®€ä»‹<br>Atlasæ˜¯ç”± Qihoo 360å…¬å¸Webå¹³å°éƒ¨åŸºç¡€æ¶æ„å›¢é˜Ÿå¼€å‘ç»´æŠ¤çš„ä¸€ä¸ªåŸºäºMySQLåè®®çš„æ•°æ®ä¸­é—´å±‚é¡¹ç›®ã€‚å®ƒåœ¨MySQLå®˜æ–¹æ¨å‡ºçš„MySQL-Proxy 0.8.2ç‰ˆæœ¬çš„åŸºç¡€ä¸Šï¼Œä¿®æ”¹äº†å¤§é‡bugï¼Œæ·»åŠ äº†å¾ˆå¤šåŠŸèƒ½ç‰¹æ€§ã€‚å®ƒåœ¨MySQLå®˜æ–¹æ¨å‡ºçš„MySQL-Proxy 0.8.2ç‰ˆæœ¬çš„åŸºç¡€ä¸Šï¼Œä¿®æ”¹äº†å¤§é‡bugï¼Œæ·»åŠ äº†å¾ˆå¤šåŠŸèƒ½ç‰¹æ€§ã€‚</p><p>Atlasä¸»è¦åŠŸèƒ½<br>1.è¯»å†™åˆ†ç¦»<br>2.ä»åº“è´Ÿè½½å‡è¡¡<br>3.IPè¿‡æ»¤<br>4.è‡ªåŠ¨åˆ†è¡¨(å…¬å¸æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œè¡¨æ˜¯ä¼šè¢«é€»è¾‘æ‹†åˆ†çš„ï¼Œæ°´å¹³æ‹†åˆ†è¿˜åœ¨å‚ç›´æ‹†åˆ†)<br>5.DBAå¯å¹³æ»‘ä¸Šä¸‹çº¿DB<br>6.è‡ªåŠ¨æ‘˜é™¤å®•æœºçš„DB</p><p>Atlasç›¸å¯¹äºå®˜æ–¹MySQL-Proxyçš„ä¼˜åŠ¿</p><p>1.å°†ä¸»æµç¨‹ä¸­æ‰€æœ‰Luaä»£ç ç”¨Cé‡å†™ï¼ŒLuaä»…ç”¨äºç®¡ç†æ¥å£<br>2.é‡å†™ç½‘ç»œæ¨¡å‹ã€çº¿ç¨‹æ¨¡å‹<br>3.å®ç°äº†çœŸæ­£æ„ä¹‰ä¸Šçš„è¿æ¥æ± <br>4.ä¼˜åŒ–äº†é”æœºåˆ¶ï¼Œæ€§èƒ½æé«˜æ•°åå€</p><p><img src="../image/study_img/image-20240828155022313.png" alt="image-20240828155022313"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">é˜¿é‡Œäº‘ä¸èƒ½ç»‘å®šVIPï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¼¹æ€§å…¬ç½‘IP</span><br><span class="line"></span><br><span class="line">vim 1.per</span><br><span class="line"><span class="comment">#!/user/bin/env prel</span></span><br><span class="line">system (<span class="string">&#x27;echo 123&#x27;</span>);</span><br><span class="line">system (<span class="string">&#x27;ifconfig&#x27;</span>);</span><br><span class="line"></span><br><span class="line">chmode +x 1.prel</span><br></pre></td></tr></table></figure><h3 id="11ã€å®‰è£…é…ç½®Atlasï¼ˆç‹¬ç«‹çš„æœºå™¨ï¼‰">11ã€<strong>å®‰è£…é…ç½®Atlasï¼ˆç‹¬ç«‹çš„æœºå™¨ï¼‰</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">1ã€æŸ¥çœ‹å½“å‰ä¸»ä»ä¿¡æ¯</span><br><span class="line">[root@lb01 binlog]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:125895) is running(0:PING_OK), master:172.16.1.51</span><br><span class="line"></span><br><span class="line">2ã€ä¸‹è½½atlas</span><br><span class="line">[root@lb01 ~]# wget http://test.driverzeng.com/MySQL_plugins/Atlas-2.2.1.el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line">3ã€å®‰è£…atlas</span><br><span class="line">[root@lb01 ~]# rpm -ivh Atlas-2.2.1.el6.x86_64.rpm </span><br><span class="line"></span><br><span class="line">4ã€æŸ¥çœ‹å®‰è£…å®Œçš„ç¨‹åºç›¸å…³æ–‡ä»¶</span><br><span class="line">[root@lb01 ~]# ll /usr/local/mysql-proxy/</span><br><span class="line">drwxr-xr-x 2 root root  75 Aug 28 15:57 bin       <span class="comment">#ç¨‹åºç›¸å…³å‘½ä»¤</span></span><br><span class="line">drwxr-xr-x 2 root root  22 Aug 28 15:57 conf      <span class="comment">#ç¨‹åºç›¸å…³é…ç½®</span></span><br><span class="line">drwxr-xr-x 3 root root 331 Aug 28 15:57 lib       <span class="comment">#ç¨‹åºç›¸å…³åˆ›å»º</span></span><br><span class="line">drwxr-xr-x 2 root root   6 Dec 17  2014 <span class="built_in">log</span>       <span class="comment">#ç¨‹åºç›¸å…³æ—¥å¿—</span></span><br><span class="line"></span><br><span class="line">5ã€åŠ å¯†å¯†ç </span><br><span class="line">[root@lb01 ~]# <span class="built_in">cd</span> /usr/local/mysql-proxy/bin</span><br><span class="line">[root@lb01 bin]# ./encrypt 123</span><br><span class="line">3yb5jEku5h4=</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6ã€ä¿®æ”¹é…ç½®æ–‡ä»¶</span><br><span class="line">[root@lb01 ~]# vim /usr/local/mysql-proxy/conf/test.cnf </span><br><span class="line">[mysql-proxy]</span><br><span class="line"><span class="comment">#å¸¦#å·çš„ä¸ºéå¿…éœ€çš„é…ç½®é¡¹ç›®</span></span><br><span class="line"><span class="comment">#ç®¡ç†æ¥å£çš„ç”¨æˆ·å</span></span><br><span class="line">admin-username = user</span><br><span class="line"><span class="comment">#ç®¡ç†æ¥å£çš„å¯†ç </span></span><br><span class="line">admin-password = <span class="built_in">pwd</span></span><br><span class="line"><span class="comment">#Atlasåç«¯è¿æ¥çš„MySQLä¸»åº“çš„IPå’Œç«¯å£ï¼Œå¯è®¾ç½®å¤šé¡¹ï¼Œç”¨é€—å·åˆ†éš”(å¯ä»¥å†™VIP,ä¹Ÿå¯ä»¥å†™ä¸»åº“IP)</span></span><br><span class="line">proxy-backend-addresses = 172.16.1.55:3306</span><br><span class="line"><span class="comment">#Atlasåç«¯è¿æ¥çš„MySQLä»åº“çš„IPå’Œç«¯å£ï¼Œ@åé¢çš„æ•°å­—ä»£è¡¨æƒé‡ï¼Œç”¨æ¥ä½œè´Ÿè½½å‡è¡¡ï¼Œè‹¥çœç•¥åˆ™é»˜è®¤ä¸º1ï¼Œå¯è®¾ç½®å¤šé¡¹ï¼Œç”¨é€—å·åˆ†éš”</span></span><br><span class="line">proxy-read-only-backend-addresses = 172.16.1.52:3306,172.16.1.53:3306,172.16.1.54:3306</span><br><span class="line"><span class="comment">#ç”¨æˆ·åä¸å…¶å¯¹åº”çš„åŠ å¯†è¿‡çš„MySQLå¯†ç ï¼Œå¯†ç ä½¿ç”¨PREFIX/binç›®å½•ä¸‹çš„åŠ å¯†ç¨‹åºencryptåŠ å¯†ï¼Œä¸‹è¡Œçš„user1å’Œuser2ä¸ºç¤ºä¾‹ï¼Œå°†å…¶æ›¿æ¢ä¸ºä½ çš„MySQLçš„ç”¨æˆ·åå’ŒåŠ å¯†å¯†ç ï¼(æ­¤å¤„æœ€åä¸è¦ç”¨root,rottçš„æƒé™éå¸¸å¤§,è¯»å†™åˆ†ç¦»å¯¹ä»–ä¸èµ·ä½œç”¨)</span></span><br><span class="line">pwds = mha:3yb5jEku5h4=,root:3yb5jEku5h4=</span><br><span class="line"><span class="comment">#è®¾ç½®Atlasçš„è¿è¡Œæ–¹å¼ï¼Œè®¾ä¸ºtrueæ—¶ä¸ºå®ˆæŠ¤è¿›ç¨‹æ–¹å¼ï¼Œè®¾ä¸ºfalseæ—¶ä¸ºå‰å°æ–¹å¼ï¼Œä¸€èˆ¬å¼€å‘è°ƒè¯•æ—¶è®¾ä¸ºfalseï¼Œçº¿ä¸Šè¿è¡Œæ—¶è®¾ä¸ºtrue,trueåé¢ä¸èƒ½æœ‰ç©ºæ ¼ã€‚</span></span><br><span class="line">daemon = <span class="literal">true</span></span><br><span class="line"><span class="comment">#è®¾ç½®Atlasçš„è¿è¡Œæ–¹å¼ï¼Œè®¾ä¸ºtrueæ—¶Atlasä¼šå¯åŠ¨ä¸¤ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªä¸ºmonitorï¼Œä¸€ä¸ªä¸ºworkerï¼Œmonitoråœ¨workeræ„å¤–é€€å‡ºåä¼šè‡ªåŠ¨å°†å…¶é‡å¯ï¼Œè®¾ä¸ºfalseæ—¶åªæœ‰workerï¼Œæ²¡æœ‰monitorï¼Œä¸€èˆ¬å¼€å‘è°ƒè¯•æ—¶è®¾ä¸ºfalseï¼Œçº¿ä¸Šè¿è¡Œæ—¶è®¾ä¸ºtrue,trueåé¢ä¸èƒ½æœ‰ç©ºæ ¼ã€‚</span></span><br><span class="line">keepalive = <span class="literal">true</span></span><br><span class="line"><span class="comment">#å·¥ä½œçº¿ç¨‹æ•°ï¼Œå¯¹Atlasçš„æ€§èƒ½æœ‰å¾ˆå¤§å½±å“ï¼Œå¯æ ¹æ®æƒ…å†µé€‚å½“è®¾ç½®</span></span><br><span class="line">event-threads = 8</span><br><span class="line"><span class="comment">#æ—¥å¿—çº§åˆ«ï¼Œåˆ†ä¸ºmessageã€warningã€criticalã€errorã€debugäº”ä¸ªçº§åˆ«</span></span><br><span class="line">log-level = error</span><br><span class="line"><span class="comment">#æ—¥å¿—å­˜æ”¾çš„è·¯å¾„</span></span><br><span class="line">log-path = /usr/local/mysql-proxy/log</span><br><span class="line"><span class="comment">#SQLæ—¥å¿—çš„å¼€å…³ï¼Œå¯è®¾ç½®ä¸ºOFFã€ONã€REALTIMEï¼ŒOFFä»£è¡¨ä¸è®°å½•SQLæ—¥å¿—ï¼ŒONä»£è¡¨è®°å½•SQLæ—¥å¿—ï¼ŒREALTIMEä»£è¡¨è®°å½•SQLæ—¥å¿—ä¸”å®æ—¶å†™å…¥ç£ç›˜ï¼Œé»˜è®¤ä¸ºOFF</span></span><br><span class="line">sql-log = ON</span><br><span class="line"><span class="comment">#æ…¢æ—¥å¿—è¾“å‡ºè®¾ç½®ã€‚å½“è®¾ç½®äº†è¯¥å‚æ•°æ—¶ï¼Œåˆ™æ—¥å¿—åªè¾“å‡ºæ‰§è¡Œæ—¶é—´è¶…è¿‡sql-log-slowï¼ˆå•ä½ï¼šms)çš„æ—¥å¿—è®°å½•ã€‚ä¸è®¾ç½®è¯¥å‚æ•°åˆ™è¾“å‡ºå…¨éƒ¨æ—¥å¿—ã€‚</span></span><br><span class="line">sql-log-slow = 10</span><br><span class="line"><span class="comment">#å®ä¾‹åç§°ï¼Œç”¨äºåŒä¸€å°æœºå™¨ä¸Šå¤šä¸ªAtlaså®ä¾‹é—´çš„åŒºåˆ†</span></span><br><span class="line">instance = <span class="built_in">test</span></span><br><span class="line"><span class="comment">#Atlasç›‘å¬çš„å·¥ä½œæ¥å£IPå’Œç«¯å£</span></span><br><span class="line">proxy-address = 0.0.0.0:3306</span><br><span class="line"><span class="comment">#Atlasç›‘å¬çš„ç®¡ç†æ¥å£IPå’Œç«¯å£</span></span><br><span class="line">admin-address = 0.0.0.0:2345</span><br><span class="line"><span class="comment">#åˆ†è¡¨è®¾ç½®ï¼Œæ­¤ä¾‹ä¸­personä¸ºåº“åï¼Œmtä¸ºè¡¨åï¼Œidä¸ºåˆ†è¡¨å­—æ®µï¼Œ3ä¸ºå­è¡¨æ•°é‡ï¼Œå¯è®¾ç½®å¤šé¡¹ï¼Œä»¥é€—å·åˆ†éš”ï¼Œè‹¥ä¸åˆ†è¡¨åˆ™ä¸éœ€è¦è®¾ç½®è¯¥é¡¹</span></span><br><span class="line"><span class="comment">#tables = person.mt.id.3</span></span><br><span class="line"><span class="comment">#é»˜è®¤å­—ç¬¦é›†ï¼Œè®¾ç½®è¯¥é¡¹åå®¢æˆ·ç«¯ä¸å†éœ€è¦æ‰§è¡ŒSET NAMESè¯­å¥</span></span><br><span class="line">charset = utf8</span><br><span class="line"><span class="comment">#å…è®¸è¿æ¥Atlasçš„å®¢æˆ·ç«¯çš„IPï¼Œå¯ä»¥æ˜¯ç²¾ç¡®IPï¼Œä¹Ÿå¯ä»¥æ˜¯IPæ®µï¼Œä»¥é€—å·åˆ†éš”ï¼Œè‹¥ä¸è®¾ç½®è¯¥é¡¹åˆ™å…è®¸æ‰€æœ‰IPè¿æ¥ï¼Œå¦åˆ™åªå…è®¸åˆ—è¡¨ä¸­çš„IPè¿æ¥</span></span><br><span class="line">client-ips = 127.0.0.1, 172.16.1</span><br><span class="line"><span class="comment">#Atlaså‰é¢æŒ‚æ¥çš„LVSçš„ç‰©ç†ç½‘å¡çš„IP(æ³¨æ„ä¸æ˜¯è™šIP)ï¼Œè‹¥æœ‰LVSä¸”è®¾ç½®äº†client-ipsåˆ™æ­¤é¡¹å¿…é¡»è®¾ç½®ï¼Œå¦åˆ™å¯ä»¥ä¸è®¾ç½®</span></span><br><span class="line"><span class="comment">#lvs-ips = 192.168.1.1</span></span><br><span class="line"></span><br><span class="line">7ã€å¯åŠ¨</span><br><span class="line">[root@lb01 ~]# /usr/local/mysql-proxy/bin/mysql-proxyd <span class="built_in">test</span> start</span><br><span class="line">OK: MySQL-Proxy of <span class="built_in">test</span> is started</span><br><span class="line"></span><br><span class="line">8ã€åœæ­¢</span><br><span class="line">[root@lb01 ~]# /usr/local/mysql-proxy/bin/mysql-proxyd <span class="built_in">test</span> stop</span><br><span class="line">OK: MySQL-Proxy of <span class="built_in">test</span> is stopped</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">9ã€å¦‚æœæƒ³è¦è®©å®ä¾‹åä¸€æ ·ï¼Œå°±ä¿®æ”¹é…ç½®æ–‡ä»¶</span><br><span class="line">[root@lb01 ~]# vim /usr/local/mysql-proxy/conf/test.cnf </span><br><span class="line">42è¡Œï¼š instance = app1</span><br><span class="line">[root@lb01 binlog]# <span class="built_in">mv</span> /usr/local/mysql-proxy/conf/&#123;<span class="built_in">test</span>,app1&#125;.cnf</span><br><span class="line"></span><br><span class="line">10ã€å¯åŠ¨</span><br><span class="line">[root@lb01 binlog]# /usr/local/mysql-proxy/bin/mysql-proxyd app1 start</span><br><span class="line">OK: MySQL-Proxy of app1 is started</span><br><span class="line">[root@lb01 binlog]# netstat -lntup</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:2345            0.0.0.0:*               LISTEN      127355/mysql-proxy  </span><br><span class="line">tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN      127355/mysql-proxy </span><br><span class="line"><span class="comment">#çœ‹åˆ°3306ç«¯å£ï¼Œ2345ç«¯å£èµ·æ¥äº†å°±ok</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=========================è®°å½•ä¸€ä¸‹</span><br><span class="line"><span class="comment">#ç®¡ç†æ¥å£çš„ç”¨æˆ·å</span></span><br><span class="line">admin-username = user</span><br><span class="line"><span class="comment">#ç®¡ç†æ¥å£çš„å¯†ç </span></span><br><span class="line">admin-password = <span class="built_in">pwd</span></span><br><span class="line"><span class="comment">#Atlasç›‘å¬çš„ç®¡ç†æ¥å£IPå’Œç«¯å£</span></span><br><span class="line">admin-address = 0.0.0.0:2345</span><br><span class="line">================================</span><br></pre></td></tr></table></figure><p>Atlasç®¡ç†æ¥å£ä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">1ã€è¿æ¥ç®¡ç†æ¥å£ç™»å½•</span><br><span class="line">[root@lb01 ~]# mysql -uuser -ppwd -h127.0.0.1 -P2345</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">ERROR 1105 (07000): use <span class="string">&#x27;SELECT * FROM help&#x27;</span> to see the supported commands</span><br><span class="line">MySQL [(none)]&gt; <span class="keyword">select</span> * from <span class="built_in">help</span>;</span><br><span class="line">+----------------------------+---------------------------------------------------------+</span><br><span class="line">| <span class="built_in">command</span>                    | description                                             |</span><br><span class="line">+----------------------------+---------------------------------------------------------+</span><br><span class="line">| SELECT * FROM <span class="built_in">help</span>         | shows this <span class="built_in">help</span>                                         |#æŸ¥çœ‹å¸®åŠ©</span><br><span class="line">| SELECT * FROM backends     | lists the backends and their state                      |#æŸ¥çœ‹åç«¯æ•°æ®åº“</span><br><span class="line">| SET OFFLINE <span class="variable">$backend_id</span>    | <span class="built_in">set</span> offline 2;         | <span class="comment">#å¹³æ»‘ä¸‹çº¿æ•°æ®åº“</span></span><br><span class="line">| SET ONLINE <span class="variable">$backend_id</span>     | <span class="built_in">set</span> online 2;           |#å¹³æ»‘ä¸Šçº¿æ•°æ®åº“</span><br><span class="line">| ADD MASTER <span class="variable">$backend</span>        | example: <span class="string">&quot;add master 172.16.1.88:3306;&quot;</span>, ...               |#æ·»åŠ ä¸€ä¸ªä¸»åº“</span><br><span class="line">| ADD SLAVE <span class="variable">$backend</span>         | example: <span class="string">&quot;add slave 172.16.1.77:3306;&quot;</span>, ...                |#æ·»åŠ ä¸€ä¸ªä»åº“</span><br><span class="line">| REMOVE BACKEND <span class="variable">$backend_id</span> | example: <span class="string">&quot;remove backend 2;&quot;</span>, ...                        |#åˆ é™¤åç«¯æ•°æ®åº“</span><br><span class="line">| SELECT * FROM clients      | <span class="keyword">select</span> * from clients                                       |#æŸ¥çœ‹å¯è¿æ¥çš„å®¢æˆ·ç«¯</span><br><span class="line">| ADD CLIENT <span class="variable">$client</span>         | example: <span class="string">&quot;add client 10.0.0;&quot;</span>, ...                  |#æ·»åŠ ä¸€ä¸ªå…è®¸è¿æ¥çš„å®¢æˆ·ç«¯</span><br><span class="line">| REMOVE CLIENT <span class="variable">$client</span>      | example: <span class="string">&quot;remove client 10.0.0&quot;</span>, ...               |#åˆ é™¤å¯è¿æ¥çš„å®¢æˆ·ç«¯</span><br><span class="line">| SELECT * FROM pwds         | <span class="keyword">select</span> * from pwds;                                          |#æŸ¥çœ‹åœ¨é…ç½®æ–‡ä»¶é‡Œé¢è®¾ç½®çš„ç”¨æˆ·å’ŒåŠ å¯†çš„å¯†ç </span><br><span class="line">| ADD PWD <span class="variable">$pwd</span>               | example: <span class="string">&quot;add pwd user:raw_password&quot;</span>, ...               |#æ·»åŠ ä¸€ä¸ªæ˜æ–‡çš„å¯†ç ç”¨æˆ·</span><br><span class="line">| ADD ENPWD <span class="variable">$pwd</span>             | example: <span class="string">&quot;add enpwd user:encrypted_password&quot;</span>, ...       |#æ·»åŠ ä¸€ä¸ªåŠ å¯†åçš„ç”¨æˆ·å¯†ç </span><br><span class="line">| REMOVE PWD <span class="variable">$pwd</span>            | example: <span class="string">&quot;remove pwd user&quot;</span>, ...                         |#åˆ é™¤ç”¨æˆ·</span><br><span class="line">| SAVE CONFIG                | save the backends to config file                        |#ç›´æ¥ä¿æŒé…ç½®æ–‡ä»¶</span><br><span class="line">| SELECT VERSION             | display the version of Atlas                            |#æŸ¥çœ‹atlasç‰ˆæœ¬å·</span><br><span class="line">+----------------------------+---------------------------------------------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹åç«¯æ•°æ®åº“</span></span><br><span class="line">MySQL [(none)]&gt; SELECT * FROM backends;</span><br><span class="line">+-------------+------------------+-------+------+</span><br><span class="line">| backend_ndx | address          | state | <span class="built_in">type</span> |</span><br><span class="line">+-------------+------------------+-------+------+</span><br><span class="line">|           1 | 172.16.1.51:3306 | up    | rw   |</span><br><span class="line">|           2 | 172.16.1.52:3306 | up    | ro   |</span><br><span class="line">|           3 | 172.16.1.53:3306 | up    | ro   |</span><br><span class="line">|           4 | 172.16.1.54:3306 | up    | ro   |</span><br><span class="line">+-------------+------------------+-------+------+</span><br></pre></td></tr></table></figure><p>é€šè¿‡altasä»£ç†å†™å…¥æ•°æ®</p><p><img src="../image/study_img/image-20240830223037955.png" alt="image-20240830223037955"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">atlasä½œä¸ºä»£ç†ï¼Œç»™(VIP)172.16.1.55ä»£ç†ï¼Œæ‰€æœ‰atlasçš„é…ç½®æ–‡ä»¶é‡Œé¢éœ€è¦æ”¹æˆä»£ç†çš„vip</span><br><span class="line"></span><br><span class="line">1ã€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå°†vipæ·»åŠ </span><br><span class="line">[root@lb01 ~]# vim /usr/local/mysql-proxy/conf/app1.cnf </span><br><span class="line">12è¡Œ  <span class="comment">#ä»£è¡¨ä¸»åº“æ°¸è¿œæ˜¯55</span></span><br><span class="line">proxy-backend-addresses = 172.16.1.55:3306</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###è¿™è¡Œæš‚æ—¶ä¸è¦ä¿®æ”¹</span></span><br><span class="line"><span class="comment">#è¿™ä¸€è¡Œï¼Œå‡å¦‚52å˜æˆä¸»åº“ï¼Œvipåœ¨52ä¸Šé¢ï¼Œå°±æŠŠ52çš„ipå»æ‰ï¼Œå½“51å˜æˆä»åº“ï¼Œå°±æŠŠ51çš„ipæ·»åŠ è¿›æ¥</span></span><br><span class="line">proxy-read-only-backend-addresses = 172.16.1.52:3306,172.16.1.53:3306,172.16.1.54:3306</span><br><span class="line"></span><br><span class="line">2ã€é‡å¯</span><br><span class="line">[root@lb01 ~]# /usr/local/mysql-proxy/bin/mysql-proxyd app1 restart</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€å°†å†™å…¥æ•°æ®çš„è„šæœ¬é‡Œé¢çš„ipä¿®æ”¹æˆä»£ç†ip</span><br><span class="line">[root@db01 ~]# vim insert.sh </span><br><span class="line">master_ip=172.16.1.5</span><br><span class="line"><span class="comment">#æ³¨æ„ï¼Œè„šæœ¬é‡Œé¢è¿œç¨‹ç™»å½•çš„ç”¨æˆ·ï¼Œå¿…é¡»åœ¨atlasé…ç½®æ–‡ä»¶é‡Œé¢å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±ä¸èƒ½å†™å…¥æ•°æ®</span></span><br><span class="line"></span><br><span class="line">4ã€æ£€æŸ¥ä¸»ä»çŠ¶æ€ï¼Œç°åœ¨ä¸»åº“æ˜¯51</span><br><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:125895) is running(0:PING_OK), master:172.16.1.51</span><br><span class="line"></span><br><span class="line">5ã€æ‰§è¡Œè„šæœ¬ï¼ŒæŸ¥çœ‹æ˜¯å¦èƒ½å¤Ÿå†™å…¥æ•°æ®ï¼Œå¹¶æ£€æŸ¥æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|       28 |</span><br><span class="line">+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸€ä¸ªæœºå™¨å®‰è£…atlasï¼Œå°±è¦åšatlasçš„é«˜å¯ç”¨ï¼Œä¸‡ä¸€atlaså®•æœºäº†ï¼Œä¸»åº“ï¼Œä»åº“å°±ä¸èƒ½å†™æ•°æ®äº†ï¼Œè¿˜ä¸å¦‚æ¯ä¸ªæœºå™¨éƒ½å®‰è£…ï¼Œæ‰€ä»¥ä¸‹é¢ä¼šéƒ¨ç½²å¤šå°æœºå™¨éƒ¨ç½²atlas</span></span><br></pre></td></tr></table></figure><h3 id="12ã€å¤šå°æœºå™¨éƒ¨ç½²Atlas">12ã€<strong>å¤šå°æœºå™¨éƒ¨ç½²Atlas</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">1ã€åœæ­¢lb01æœºå™¨ä¸Šé¢çš„atlasæœåŠ¡</span><br><span class="line">[root@lb01 ~]#  /usr/local/mysql-proxy/bin/mysql-proxyd app1 stop</span><br><span class="line"></span><br><span class="line">2ã€å°†atlasåŒ…ã€é…ç½®æ–‡ä»¶å‘é€ç»™å…¶ä»–4å°æ•°æ®åº“</span><br><span class="line">[root@lb01 ~]# <span class="keyword">for</span> i <span class="keyword">in</span> 51 52 53 54;<span class="keyword">do</span> scp Atlas-2.2.1.el6.x86_64.rpm 172.16.1.<span class="variable">$&#123;i&#125;</span>:/root;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[root@lb01 ~]# <span class="keyword">for</span> i <span class="keyword">in</span> 51 52 53 54;<span class="keyword">do</span> scp /usr/local/mysql-proxy/conf/app1.cnf 172.16.1.<span class="variable">$&#123;i&#125;</span>:/usr/local/mysql-proxy/conf/;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">3ã€4ä¸ªåº“å®‰è£…atlas</span><br><span class="line">[root@lb01 ~]# <span class="keyword">for</span> i <span class="keyword">in</span> 51 52 53 54;<span class="keyword">do</span> ssh root@172.16.1.<span class="variable">$&#123;i&#125;</span> <span class="string">&quot;rpm -ivh Atlas-2.2.1.el6.x86_64.rpm&quot;</span>;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">4ã€æŸ¥çœ‹é…ç½®æ–‡ä»¶æ˜¯å¦æ”¶åˆ°</span><br><span class="line">[root@db01 ~]# ll /usr/local/mysql-proxy/conf/</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 1 root root 2832 Aug 31 14:30 app1.cnf</span><br><span class="line">-rw-r--r-- 1 root root 2810 Dec 17  2014 test.cnf</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# rpm -aq |grep Atlas</span><br><span class="line">Atlas-2.2.1-1.x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€ç›®å‰3306ç«¯å£æ•°æ®åº“åœ¨è¿è¡Œï¼Œæ‰€ä»¥æ”¹mysqlç«¯å£ä¸å¤ªè¡Œï¼Œæ‰€ä»¥å…ˆæ›´æ”¹atlasç«¯å£ï¼Œæ”¹æˆ3307</span><br><span class="line">ï¼Œå¦‚æœæœ‰ç”Ÿäº§ç¯å¢ƒï¼Œè¿™ä¸ªç«¯å£ä¼šæå‰é…ç½®å¥½ï¼Œä»–å°±æ˜¯3306ï¼Œæ”¹æ•°æ®åº“çš„ç«¯å£å°±å¥½</span><br><span class="line">[root@db01 ~]# vim /usr/local/mysql-proxy/conf/app1.cnf </span><br><span class="line"><span class="comment">#Atlasç›‘å¬çš„å·¥ä½œæ¥å£IPå’Œç«¯å£    45è¡Œ</span></span><br><span class="line">proxy-address = 0.0.0.0:3307</span><br><span class="line"></span><br><span class="line">sed -i  <span class="string">&#x27;s#proxy-address = 0.0.0.0:3306#proxy-address = 0.0.0.0:3307#g&#x27;</span>  /usr/local/mysql-proxy/conf/app1.cnf  </span><br><span class="line"></span><br><span class="line">5ã€4å°æ•°æ®åº“å¯åŠ¨atlas,å¹¶ä¸”æ£€æŸ¥ç«¯å£ 2345  3307ç«¯å£</span><br><span class="line">/usr/local/mysql-proxy/bin/mysql-proxyd app1 start</span><br><span class="line"></span><br><span class="line">[root@db04 ~]# netstat -lntup</span><br><span class="line"></span><br><span class="line">6ã€atlaséœ€è¦ä½¿ç”¨systemdç®¡ç†ï¼Œä¸ç„¶æ²¡æ³•åŠ å…¥å¼€æœºè‡ªå¯åŠ¨</span><br><span class="line"></span><br><span class="line">7ã€æ›´æ”¹ç¨‹åºå†™æ•°æ®çš„è„šæœ¬ï¼Œè¿˜å¾—åŠ å‚æ•°-P3307,å¾€atlasé‡Œé¢å†™æ•°æ®</span><br><span class="line">[root@db01 ~]# vim insert.sh</span><br><span class="line"><span class="comment">#ç”¨vipï¼Œè¿˜æ˜¯å¾€ä¸»åº“çš„altlasé‡Œé¢å†™æ•°æ®ï¼Œå³ä¾¿æ˜¯vipæ¼‚ç§»äº†ï¼Œè¿˜æ˜¯å¾€atlasé‡Œé¢å†™ï¼Œæ¯”å¦‚è¯´51æŒ‚äº†ï¼Œvipæ¼‚åˆ°53ï¼Œè¿˜æ˜¯å¾€55çš„3307é‡Œé¢å†™æ•°æ®ï¼Œè¿™æ ·å°±ä¸è¦ä½¿ç”¨keepalivedç»™atlasåšé«˜å¯ç”¨äº†</span></span><br><span class="line">master_ip=172.16.1.55</span><br><span class="line">mysql_cli=<span class="string">&quot;mysql -uroot -p123 -h<span class="variable">$&#123;master_ip&#125;</span> -P3307&quot;</span></span><br><span class="line"></span><br><span class="line">8ã€æ‰§è¡Œè„šæœ¬</span><br><span class="line">[root@db01 ~]# sh insert.sh      </span><br><span class="line"><span class="comment">#å¯ä»¥å¾€é‡Œé¢å†™æ•°æ®</span></span><br><span class="line">Warning: Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">Warning: Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br></pre></td></tr></table></figure><p>atlasç»“åˆMHAè„šæœ¬ä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ£€æŸ¥MHAæ˜¯å¦å¯åŠ¨</span><br><span class="line">[root@lb01 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:125895) is running(0:PING_OK), master:172.16.1.51</span><br><span class="line"></span><br><span class="line"><span class="comment">#MHAåˆ‡æ¢å®Œäº†ï¼Œatlasé…ç½®æ–‡ä»¶é‡Œé¢çš„ä»åº“ipä¹Ÿè¦æ”¹ï¼Œæœ‰ä¸€ä¸ªhmaçš„åˆ‡æ¢è„šæœ¬ï¼Œå•¥æ—¶å€™æ¼‚VIPï¼Œå°±å•¥æ—¶å€™æ”¹atlasé…ç½®æ–‡ä»¶ï¼Œè€Œä¸”4å°atlasé…ç½®æ–‡ä»¶è¦ä¸€è‡´</span></span><br><span class="line"></span><br><span class="line">2ã€åœ¨ä¸»ä»æœåŠ¡å™¨ä¸Šç¼–å†™è„šæœ¬</span><br><span class="line">[root@db01 ~]# vim atlas_mha.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">mha_log=<span class="string">&quot;/etc/mha/logs/manager.log&quot;</span></span><br><span class="line"><span class="comment">#å®•æœºçš„master</span></span><br><span class="line">down_master=$(grep <span class="string">&#x27;(current master)&#x27;</span> <span class="variable">$&#123;mha_log&#125;</span>|awk -F <span class="string">&#x27;(&#x27;</span>  <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>|<span class="built_in">tail</span> -1)</span><br><span class="line"><span class="comment">#down_master=$(sed -nr &#x27;s#(.*)\(.*\) \(current master\)$#\1#gp&#x27; $&#123;mha_log&#125;|tail -1)</span></span><br><span class="line"><span class="comment">#æ–°çš„master</span></span><br><span class="line">new_master=$(grep <span class="string">&#x27;(new master)&#x27;</span> <span class="variable">$&#123;mha_log&#125;</span>|awk -F <span class="string">&#x27;(&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>|<span class="built_in">tail</span> -1)</span><br><span class="line"><span class="comment">#new_master=$(sed -nr &#x27;s#(.*)\(.*\) \(new master\)$#\1#gp&#x27; $&#123;mha_log&#125;|tail -1)</span></span><br><span class="line"><span class="comment">#æ“ä½œç®¡ç†æ¥å£   #mysql -uuser -ppwd  -P2345 -h172.16.1.51</span></span><br><span class="line"><span class="comment">#atlasé…ç½®æ–‡ä»¶ç®¡ç†æ¥å£çš„ç”¨æˆ·å</span></span><br><span class="line">atlas_user=<span class="string">&#x27;user&#x27;</span></span><br><span class="line"><span class="comment">#atlasé…ç½®æ–‡ä»¶ç®¡ç†æ¥å£çš„å¯†ç </span></span><br><span class="line">atlas_password=<span class="string">&#x27;pwd&#x27;</span></span><br><span class="line"><span class="comment">##atlasé…ç½®æ–‡ä»¶ç®¡ç†æ¥å£çš„ç«¯å£</span></span><br><span class="line">atlas_port=<span class="string">&#x27;2345&#x27;</span></span><br><span class="line">atlas_conn=<span class="string">&#x27;mysql -u$&#123;atlas_user&#125; -p$&#123;atlas_password&#125; -P$&#123;atlas_port&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è·å–down_masterçš„backend_id,51ä¸»åº“è¦åšçš„æ“ä½œæ˜¯åˆ é™¤è¢«æå‡ä¸ºä¸»åº“çš„new_master</span></span><br><span class="line"><span class="keyword">for</span> atlas_ip <span class="keyword">in</span> 51 52 53 54;<span class="keyword">do</span></span><br><span class="line">      down_master_backend_id=$(<span class="variable">$&#123;atlas_conn&#125;</span> -h172.16.1.<span class="variable">$&#123;atlas_ip&#125;</span> -e <span class="string">&#x27;select * from backends&#x27;</span>| grep <span class="string">&quot;<span class="variable">$&#123;new_master&#125;</span>&quot;</span>|awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">      <span class="variable">$&#123;atlas_conn&#125;</span> -h172.16.1.<span class="variable">$&#123;atlas_ip&#125;</span> -e <span class="string">&#x27;remove backend $&#123;down_master_backend_id&#125;&#x27;</span></span><br><span class="line">      <span class="variable">$&#123;atlas_conn&#125;</span> -h172.16.1.<span class="variable">$&#123;atlas_ip&#125;</span> -e <span class="string">&#x27;add slave $&#123;down_master&#125;:3306;save config&#x27;</span></span><br><span class="line"><span class="keyword">done</span> </span><br><span class="line"></span><br><span class="line">3ã€è„šæœ¬ç»“åˆMHAä¸€èµ·ä½¿ç”¨ï¼Œä¿®æ”¹MHAvipæ¼‚ç§»çš„è„šæœ¬  åœ¨mhaæœºå™¨ä¸Šä¿®æ”¹  </span><br><span class="line">[root@lb01 ~]# vim /etc/mha/app1/master_ip_failover</span><br><span class="line">sub <span class="function"><span class="title">start_vip</span></span>() &#123;</span><br><span class="line">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$new_master_host</span> \&quot; <span class="variable">$ssh_start_vip</span> \&quot;`;</span><br><span class="line">    `/bin/sh -x \&quot;/root/atlas_mha.sh\&quot;`;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#-x å°†è„šæœ¬çš„æ‰§è¡Œè¿‡ç¨‹è¾“å‡ºåˆ°æ—¥å¿—é‡Œé¢</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ£€æŸ¥ä¸»ä»ï¼Œå¹¶ä¸”æ£€æŸ¥vipåœ¨ä¸»åº“ä¸Šé¢</span><br><span class="line">[root@lb01 ~]#  masterha_check_status --conf=/etc/mha/app1.cnf</span><br><span class="line">app1 (pid:125895) is running(0:PING_OK), master:172.16.1.51</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# ip a</span><br><span class="line"></span><br><span class="line">2ã€æ‰§è¡Œå†™å…¥æ•°æ®çš„è„šæœ¬</span><br><span class="line">[root@db01 ~]# sh insert.sh</span><br><span class="line"></span><br><span class="line">3ã€å…ˆå®æ—¶è¿½è¸ªæ—¥å¿—</span><br><span class="line">[root@lb01 ~]# tailf  /etc/mha/logs/manager.log</span><br><span class="line"></span><br><span class="line">4ã€å‡†å¤‡åˆ‡æ¢ï¼Œåœæ­¢ä¸»åº“æ•°æ®åº“</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld stop</span><br><span class="line"> change master to</span><br><span class="line">    master_host=<span class="string">&#x27;172.16.1.52&#x27;</span>,</span><br><span class="line">    master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">    master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">    master_auto_position=1;</span><br><span class="line"> start slave;show slave status\G</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> STOP SLAVE;RESET SLAVE ALL;change master to</span><br><span class="line">    master_host=<span class="string">&#x27;172.16.1.52&#x27;</span>,</span><br><span class="line">    master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">    master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">    master_auto_position=1;start slave;show slave status\G</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">mysqlçš„MHAé«˜å¯ç”¨çš„éƒ¨ç½²ï¼Œè¶…çº§è¯¦ç»†çš„</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>mysqlä¸»ä»å¤åˆ¶</title>
    <link href="https://www.fomal.cc/posts/106fae33.html"/>
    <id>https://www.fomal.cc/posts/106fae33.html</id>
    <published>2024-09-21T09:45:49.000Z</published>
    <updated>2024-09-21T10:42:01.989Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1ã€-mysqlä¸»ä»å¤åˆ¶">1ã€ mysqlä¸»ä»å¤åˆ¶</h3><p><strong>ä¸ºä»€ä¹ˆè¦åšä¸»ä»å¤åˆ¶</strong><br>1ã€ä¸ºäº†åšé«˜å¯ç”¨<br>2ã€ä¸ºäº†è§£å†³MySQLçš„å•ç‚¹æ•…éšœ<br>3ã€åˆ†æ‘Šä¸»åº“çš„å‹åŠ›<br>4ã€åšå¤‡ä»½çš„æƒ…å†µ(å»¶è¿Ÿä»åº“)</p><p><strong>Mysqlä¸»ä»å¤åˆ¶åŸç†</strong></p><p><img src="../image/study_img/image-20240823161157907.png" alt="image-20240823161157907"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">åŒæ­¥ï¼šIOçº¿ç¨‹æ‹¿åˆ°æ•°æ®äº¤ç»™SQLçº¿ç¨‹ï¼Œsqlçº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼ŒIOçº¿ç¨‹å†å»è¦ä¸‹ä¸€æ¡æ•°æ®(ç±»ä¼¼äºæˆ‘ç»™ä½ ä¼ æ–‡ä»¶ï¼Œæˆ‘è¦ç­‰ä½ æ¥æ”¶å®Œ)</span><br><span class="line">å¼‚æ­¥ï¼šIOçº¿ç¨‹æŠŠæ•°æ®æ”¾åˆ°ç¼“å­˜é‡Œ,ä¸ç®¡SQLçº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œï¼ŒIOçº¿ç¨‹éƒ½ä¼šå»è¦ä¸‹ä¸€æ¡æ•°æ®</span><br><span class="line"></span><br><span class="line">å¦‚æœçœ‹åˆ°SQLæ˜¾ç¤ºNO,å¯èƒ½æ˜¯æ•°æ®çš„é—®é¢˜ï¼Œå¯èƒ½ä¸»åº“å’Œä»åº“æ•°æ®ä¸ä¸€è‡´</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">master.info å‚¨å­˜ä¸»åº“ä¿¡æ¯çš„æ–‡ä»¶</span><br><span class="line">relay-log  ä¸­ç»§æ—¥å¿—ï¼Œä¹Ÿå«å·®å¼‚æ—¥å¿—(ä¸»åº“é‡Œæœ‰ï¼Œä»åº“é‡Œæ²¡æœ‰ï¼Œè¿˜éœ€è¦ä»åº“æ‰§è¡Œçš„è¯­å¥ï¼Œä¹Ÿå°±æ˜¯ä¸»åº“å’Œä»åº“çš„æ•°æ®å·®å¼‚çš„)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#åŸç†</span></span><br><span class="line">1ï¼‰é€šè¿‡change master toè¯­å¥å‘Šè¯‰ä»åº“ä¸»åº“çš„ipï¼Œportï¼Œuserï¼Œpasswordï¼Œfileï¼Œpos</span><br><span class="line">2ï¼‰ä»åº“é€šè¿‡start slaveå‘½ä»¤å¼€å¯å¤åˆ¶å¿…è¦çš„IOçº¿ç¨‹å’ŒSQLçº¿ç¨‹</span><br><span class="line">3ï¼‰ä»åº“é€šè¿‡IOçº¿ç¨‹æ‹¿ç€change master toç”¨æˆ·å¯†ç ç›¸å…³ä¿¡æ¯ï¼Œè¿æ¥ä¸»åº“ï¼ŒéªŒè¯åˆæ³•æ€§</span><br><span class="line">4ï¼‰ä»åº“è¿æ¥æˆåŠŸåï¼Œä¼šæ ¹æ®binlogçš„posé—®ä¸»åº“ï¼Œæœ‰æ²¡æœ‰æ¯”è¿™ä¸ªæ›´æ–°çš„</span><br><span class="line">5ï¼‰ä¸»åº“æ¥æ”¶åˆ°ä»åº“è¯·æ±‚åï¼Œæ¯”è¾ƒä¸€ä¸‹binlogä¿¡æ¯ï¼Œå¦‚æœæœ‰å°±å°†æœ€æ–°æ•°æ®é€šè¿‡dumpçº¿ç¨‹ç»™ä»åº“IOçº¿ç¨‹</span><br><span class="line">6ï¼‰ä»åº“é€šè¿‡IOçº¿ç¨‹æ¥æ”¶åˆ°ä¸»åº“å‘æ¥çš„binlogäº‹ä»¶ï¼Œå­˜å‚¨åˆ°TCP/IPç¼“å­˜ä¸­ï¼Œå¹¶è¿”å›ACKæ›´æ–°master.info</span><br><span class="line">7ï¼‰å°†TCP/IPç¼“å­˜ä¸­çš„å†…å®¹å­˜åˆ°relay-logä¸­</span><br><span class="line">8ï¼‰SQLçº¿ç¨‹è¯»å–relay-log.infoï¼Œè¯»å–åˆ°ä¸Šæ¬¡å·²ç»æ‰§è¡Œè¿‡çš„relay-logä½ç½®ç‚¹ï¼Œç»§ç»­æ‰§è¡Œåç»­çš„relay-logæ—¥å¿—ï¼Œæ‰§è¡Œå®Œæˆåï¼Œæ›´æ–°relay-log.info</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">change master to</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_passwd=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file=<span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">master_log_pos=446</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#MySQLä¸»ä»å¤åˆ¶å’Œ3ä¸ªçº¿ç¨‹ï¼Œ4ä¸ªæ–‡ä»¶æœ‰å…³ç³»</span></span><br><span class="line">1ã€#3ä¸ªçº¿ç¨‹ï¼š</span><br><span class="line">      - ä»åº“ä¸Šçš„IOçº¿ç¨‹ï¼š(å’Œä¸»åº“å»ºç«‹è¿æ¥ï¼Œæ¥æ”¶ä¸»åº“çš„æ•°æ®)</span><br><span class="line">      - ä»åº“ä¸Šçš„SQLçº¿ç¨‹ï¼š(å°†IOçº¿ç¨‹å–å‡ºçš„æ•°æ®åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œä¸€éï¼Œä»–ä¸¤ä¹‹å‰æ˜¯å¼‚æ­¥çš„)</span><br><span class="line">      </span><br><span class="line">      - ä¸»åº“ä¸Šçš„dumpçº¿ç¨‹ï¼š(æ¥å—IOçº¿ç¨‹çš„è¯·æ±‚ï¼Œä»binlogä¸­å–å‡ºæ•°æ®è¿”å›ç»™IOçº¿ç¨‹)</span><br><span class="line">      </span><br><span class="line">2ã€#4ä¸ªæ–‡ä»¶</span><br><span class="line">      - ä»åº“ï¼šmaster.info(å­˜ä¸Šä¸€æ¬¡ä¸»åº“binlogçš„åå­—å’Œä½ç½®ç‚¹)ï¼šæ‰§è¡Œstart slaveä¼šæŠŠä¸»åº“ä¿¡æ¯è®°å½•åœ¨master.info,æ–¹ä¾¿ä¸‹ä¸€æ¬¡å–æ•°æ®</span><br><span class="line">      - ä»åº“ï¼šrelay-log.infoï¼š(è®°å½•sqlè¯­å¥ä¸Šä¸€å›æ‰§è¡Œåˆ°ä¸­ç»§æ—¥å¿—çš„ä½ç½®ç‚¹ï¼Œä¸‹å›å†æ‰§è¡Œçš„æ—¶å€™å°±ä»è¿™ä¸ªä½ç½®ç‚¹å¾€åæ‰§è¡Œ)</span><br><span class="line">      - ä»åº“ï¼šrelay-logï¼š(å­˜å‚¨binlogä¸­æ–°å¢çš„æ•°æ®ï¼ˆä¸æ˜¯ä¸€ç›´å­˜åœ¨çš„ï¼‰å¤åˆ¶SQLçº¿ç¨‹åœ¨æ‰§è¡Œå®Œæ–‡ä»¶ä¸­çš„æ‰€æœ‰äº‹ä»¶å¹¶ä¸”ä¸å†éœ€è¦å®ƒåï¼Œä¼šè‡ªåŠ¨åˆ é™¤æ¯ä¸ªä¸­ç»§æ—¥å¿—æ–‡ä»¶)</span><br><span class="line">      </span><br><span class="line">      - ä¸»åº“ï¼šbin-log(äºŒè¿›åˆ¶æ—¥å¿—è®°å½•ä¸»åº“æ‰€æœ‰å¯¹æ•°æ®è¡¨å‘ç”Ÿå˜åŒ–çš„è¯­å¥)</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"><span class="comment">#é—®é¢˜ï¼šrelay-logä¼šä¸€ç›´å­˜åœ¨å—,å¦‚æœä¸æ˜¯ï¼Œä¼šå­˜åœ¨å¤šä¹…ï¼Ÿ</span></span><br><span class="line">å®˜ç½‘ç»™çš„ç­”æ¡ˆï¼š</span><br><span class="line">https://dev.mysql.com/doc/refman/5.7/en/replica-logs-relaylog.html</span><br><span class="line"></span><br><span class="line">The replication SQL thread automatically deletes each relay <span class="built_in">log</span> file after it has executed all events <span class="keyword">in</span> the file and no longer needs it. There is no explicit mechanism <span class="keyword">for</span> deleting relay logs because the replication SQL thread takes care of doing so. However, FLUSH LOGS rotates relay logs, <span class="built_in">which</span> influences when the replication SQL thread deletes them.</span><br><span class="line">(å¤åˆ¶SQLçº¿ç¨‹åœ¨æ‰§è¡Œå®Œæ–‡ä»¶ä¸­çš„æ‰€æœ‰äº‹ä»¶å¹¶ä¸”ä¸å†éœ€è¦å®ƒåï¼Œä¼šè‡ªåŠ¨åˆ é™¤æ¯ä¸ªä¸­ç»§æ—¥å¿—æ–‡ä»¶ã€‚æ²¡æœ‰æ˜ç¡®çš„æœºåˆ¶æ¥åˆ é™¤ä¸­ç»§æ—¥å¿—ï¼Œå› ä¸ºå¤åˆ¶SQLçº¿ç¨‹ä¼šè´Ÿè´£è¿™æ ·åšã€‚ä½†æ˜¯ï¼ŒFLUSH logsä¼šè½®æ¢ä¸­ç»§æ—¥å¿—ï¼Œè¿™ä¼šå½±å“å¤åˆ¶SQLçº¿ç¨‹ä½•æ—¶åˆ é™¤å®ƒä»¬ã€‚)</span><br><span class="line">ä¹Ÿå°±æ˜¯è¯´SQLçº¿ç¨‹æ‰§è¡Œå®Œrelay-logçš„æ‰€æœ‰äº‹ä»¶ä¹‹åï¼Œä¼šå®šæœŸçš„åˆ é™¤relay-logï¼Œä½†æ˜¯ä¸çŸ¥é“å¤šä¹…åˆ é™¤ä¸€æ¬¡ï¼Œå®˜æ–¹æ²¡æœ‰ç»™å‡ºæ˜ç¡®çš„æ—¶é—´</span><br><span class="line"></span><br><span class="line">æ¶‰åŠåˆ°3ä¸ªçº¿ç¨‹ 4ä¸ªæ–‡ä»¶</span><br><span class="line"><span class="comment">#ä»ï¼šmaster inifo  </span></span><br><span class="line">relay.loh  </span><br><span class="line">relayï¼šè®°å½•sqlè¯­å¥ä¸Šä¸€å›æ‰§è¡Œåˆ°ä¸­ç»§æ—¥å¿—çš„é‚£ä¸ªä½ç½®ç‚¹äº†</span><br></pre></td></tr></table></figure><p><strong>éƒ¨ç½²ä¼ ç»Ÿä¸»ä»å¤åˆ¶</strong></p><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th><th>åº”ç”¨</th></tr></thead><tbody><tr><td>db01</td><td>10.0.0.51  /  172.16.1.51</td><td><strong>ä¸»åº“</strong></td><td>mysql 5.6</td></tr><tr><td>db02</td><td>10.0.0.52  /  172.16.1.52</td><td>ä»åº“</td><td>mysql 5.6</td></tr><tr><td>db03</td><td>10.0.0.53  /  172.16.1.53</td><td>ä»åº“</td><td>mysql 5.6</td></tr><tr><td>db04</td><td>10.0.0.54 /  172.16.1.54</td><td>ä»åº“</td><td>mysql 5.6</td></tr></tbody></table><p>1ã€ä¸»åº“æ“ä½œdb01</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">1ã€#ä¸»åº“æ“ä½œ</span><br><span class="line"><span class="comment">#ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/app/mysql-5.6.50</span><br><span class="line">datadir=/app/mysql-5.6.50/data</span><br><span class="line">log_bin=mysql-bin</span><br><span class="line">server_id=1</span><br><span class="line">lower_case_table=1</span><br><span class="line"><span class="comment">#innodb_data_file_path=ibdata1:12M;ibdata2:50M:autoextend</span></span><br><span class="line">binlog_format=row</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">skip-name-resolve</span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt=<span class="string">&quot;\\u@\\h:\\d &gt; &quot;</span></span><br><span class="line"></span><br><span class="line">2ã€#é‡å¯</span><br><span class="line">[root@db04 ~]#  /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line">3ã€#åˆ›å»ºä¸€ä¸ªä¸»ä»å¤åˆ¶çš„ç”¨æˆ·</span><br><span class="line">grant replication slave on *.* to rep@<span class="string">&#x27;172.16.1.5%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line">4ã€#æŸ¥çœ‹binlog(master)çš„ä¿¡æ¯</span><br><span class="line">root@localhost:(none) &gt; show master status;</span><br><span class="line">+------------------+----------+</span><br><span class="line">| File             | Position |</span><br><span class="line">+------------------+----------+</span><br><span class="line">| mysql-bin.000016 |      327 |</span><br><span class="line">+------------------+----------+</span><br></pre></td></tr></table></figure><p>2ã€ä»åº“æ“ä½œ   å…ˆé…ç½®db02  db03</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">1ã€#ä¿®æ”¹é…ç½®æ–‡ä»¶</span><br><span class="line">[root@db03 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/app/mysql-5.6.50</span><br><span class="line">datadir=/app/mysql-5.6.50/data</span><br><span class="line">ä»åº“binlogä¸éœ€è¦å¼€å¯</span><br><span class="line"><span class="comment">#log_bin=mysql-bin</span></span><br><span class="line"><span class="comment">#server_idä¸ä¸€æ ·</span></span><br><span class="line">server_id=1</span><br><span class="line">lower_case_table=1</span><br><span class="line"><span class="comment">#innodb_data_file_path=ibdata1:12M;ibdata2:50M:autoextend</span></span><br><span class="line">binlog_format=row</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">skip-name-resolve</span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt=<span class="string">&quot;\\u@\\h:\\d &gt; &quot;</span></span><br><span class="line"></span><br><span class="line">2ã€#é‡å¯</span><br><span class="line">[root@db03 ~]# /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line">3ã€#æ‰§è¡Œmasterè¯­å¥</span><br><span class="line">change master to</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_user=<span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file=<span class="string">&#x27;mysql-bin.000016&#x27;</span>,</span><br><span class="line">master_log_pos=327,</span><br><span class="line">master_port=3306;</span><br><span class="line"></span><br><span class="line">4ã€#å¼€å¯ä¸»ä»å¤åˆ¶</span><br><span class="line">mysql&gt; start slave;</span><br><span class="line"></span><br><span class="line">5ã€#æŸ¥çœ‹ä¸»ä»å¤åˆ¶çŠ¶æ€</span><br><span class="line">mysql&gt; show slave status\G</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000016</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">            </span><br><span class="line">           <span class="comment">#2ä¸ªyeså°±OK</span></span><br></pre></td></tr></table></figure><p><strong>ä¸»ä»å¤åˆ¶æ•…éšœå¤„ç†</strong></p><p>IOçº¿ç¨‹æ•…éšœ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¤§æ¦‚ç‡æ˜¯è¿æ¥å‡ºé—®é¢˜</span></span><br><span class="line">change master to</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_user=<span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file=<span class="string">&#x27;mysql-bin.000016&#x27;</span>,</span><br><span class="line">master_log_pos=327,</span><br><span class="line">master_port=3306;</span><br><span class="line"></span><br><span class="line">1ã€#æ£€æŸ¥IPæ˜¯å¦æ­£å¸¸(å’Œchange masterçš„IPä¸€æ ·ï¼Œä¸è¦å†™å¤–ç½‘IP)</span><br><span class="line">ping 172.16.1.51</span><br><span class="line"></span><br><span class="line">2ã€#æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£å¸¸(å’Œchange masterçš„IPä¸€æ ·ï¼Œä¸è¦å†™å¤–ç½‘IP)</span><br><span class="line">telent 172.16.1.51 3306</span><br><span class="line">ç«¯å£ä¸é€šï¼š</span><br><span class="line">      - é˜²ç«å¢™ selinux</span><br><span class="line">      - æœåŠ¡æ²¡æœ‰èµ·</span><br><span class="line">      - æ²¡æœ‰åˆ›å»ºè¿œç¨‹è¿æ¥çš„ç”¨æˆ·</span><br><span class="line">      </span><br><span class="line">3ã€#æ£€æµ‹ç”¨æˆ·åå’Œå¯†ç   ä»åº“ç”¨repç”¨æˆ·è¿æ¥åˆ°ä¸»åº“</span><br><span class="line">[root@db03 ~]# mysql -urep -p123 -h172.16.1.51</span><br><span class="line"></span><br><span class="line">4ã€#ä¸»åº“æ£€æŸ¥binglogåå­—å’Œä½ç½®ç‚¹æ˜¯å¦æ­£ç¡®(ä½ç½®ç‚¹å¯ä»¥å°‘ï¼Œä¸èƒ½å¤šï¼Œå¤šäº†æ‰¾ä¸åˆ°é‚£ä¸ªç‚¹)</span><br><span class="line">root@localhost:(none) &gt; show master status;</span><br><span class="line">+------------------+----------+-</span><br><span class="line">| File             | Position | </span><br><span class="line">+------------------+----------+-</span><br><span class="line">| mysql-bin.000016 |    32858 | </span><br><span class="line">+------------------+----------+-</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240823175441790.png" alt="image-20240823175441790"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠ¥é”™åŸå› ï¼š</span></span><br><span class="line">ä¸»åº“å’Œä»åº“çš„server_idç›¸åŒ</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240823175520693.png" alt="image-20240823175520693"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠ¥é”™åŸå› ï¼š</span></span><br><span class="line">ä¸»åº“å’Œä»åº“çš„UUIDç›¸åŒ</span><br></pre></td></tr></table></figure><p>SQLçº¿ç¨‹æ•…éšœ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ ¹æœ¬åŸå› ï¼šä¸»åº“å’Œä»åº“æ•°æ®ä¸ä¸€è‡´</span></span><br><span class="line"></span><br><span class="line">1ã€ä¸»åº“çš„æ•°æ®æ¯”ä»åº“å¤š(ä¸»åº“é‡Œé¢æœ‰ä¸€ä¸ªjiaoyiè¡¨ï¼Œä»åº“æ²¡æœ‰ï¼Œæˆ‘åœ¨ä¸»åº“é‡Œé¢çš„jiaoyiè¡¨æ’å…¥æ•°æ®ï¼Œä»åº“SQLçº¿ç¨‹å°±ä¼šæŠ¥é”™)</span><br><span class="line"></span><br><span class="line">2ã€ä»åº“çš„æ•°æ®æ¯”ä¸»åº“å¤š(ä»åº“å·²ç»å­˜åœ¨ä¸€ä¸ªtabl1è¡¨ï¼Œå½“ä¸»åº“åˆ›å»ºtable1è¡¨æ—¶ï¼Œä»åº“QLçº¿ç¨‹å°±ä¼šæŠ¥é”™)</span><br></pre></td></tr></table></figure><p>1ã€ä¸»åº“çš„æ•°æ®æ¯”ä»åº“å¤š  æŠ¥é”™</p><p><img src="../image/study_img/image-20240823160331343.png" alt="image-20240823160331343"></p><p>2ã€ä»åº“çš„æ•°æ®æ¯”ä¸»åº“å¤š  æŠ¥é”™</p><p><img src="../image/study_img/image-20240823180522184.png" alt="image-20240823180522184"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è§£å†³æ–¹æ³•ï¼š</span></span><br><span class="line"></span><br><span class="line">æ–¹æ³•1ï¼š:ä¸æ¨è  ä¸´æ—¶çš„è§£å†³æ–¹æ³•  </span><br><span class="line">(è·³è¿‡è¿™ä¸ªæŠ¥é”™çš„æŒ‡é’ˆ)</span><br><span class="line"><span class="comment"># ä¸´æ—¶åœæ­¢åŒæ­¥</span></span><br><span class="line">mysql&gt; stop slave;</span><br><span class="line"><span class="comment"># å°†åŒæ­¥æŒ‡é’ˆå‘ä¸‹ç§»åŠ¨ä¸€ä¸ªï¼ˆå¯é‡å¤æ“ä½œï¼‰</span></span><br><span class="line">mysql&gt; <span class="built_in">set</span> global sql_slave_skip_counter=1;</span><br><span class="line"><span class="comment"># å¼€å¯åŒæ­¥</span></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ–¹æ³•2ï¼šä¸æ¨è  ä¸´æ—¶çš„è§£å†³æ–¹æ³•</span><br><span class="line">(åœ¨mysqlæ ‡ç­¾ä¸»æ·»åŠ è·³è¿‡é”™è¯¯ä»£ç çš„é…ç½®)</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line"><span class="comment">#åœ¨[mysqld]æ ‡ç­¾ä¸‹æ·»åŠ ä»¥ä¸‹å‚æ•°</span></span><br><span class="line">slave-skip-errors=1032,1062,1007,1146</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä½†æ˜¯ä»¥ä¸Šæ“ä½œéƒ½æ˜¯æœ‰é£é™©å­˜åœ¨çš„,å¯¼è‡´ä»åº“æ•°æ®ç¼ºå¤±ï¼Œè¿™ä¸ªæ•°æ®ä»åº“é‡Œé¢æ°¸è¿œæ²¡æœ‰ï¼ŒæŸ¥ä¸åˆ°æ•°æ®ï¼Œä»–è·³è¿‡è¿™ä¸ªé”™è¯¯ï¼Œé…ç½®æ–‡ä»¶é‡Œé¢å†™äº†ï¼Œæ•°æ®ä¸å¤åˆ¶,è¿™ä¸ªåªæ˜¯è¡¨é¢ä¸Šçœ‹åˆ°yes,å®é™…ä¸Šæ²¡æœ‰æ„ä¹‰ï¼Œè·³è¿‡ç›¸å½“äºä»åº“å°‘æ•°æ®</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ•°æ®ä¸ä¸€è‡´çš„åŸå› å¯èƒ½å¦‚ä¸‹ï¼š</span></span><br><span class="line">1ã€åœ¨ç”Ÿäº§ä¸­è¿è¡Œå·²æœ‰çš„æ•°æ®åº“çš„ä¸»åº“ï¼Œæ–°ä»åº“ç›´æ¥ä»å½“å‰ä½ç½®ç‚¹å¤åˆ¶</span><br><span class="line">è§£å†³æ–¹æ³•ï¼šç»™ä¸»åº“å…¨å¤‡ï¼Œå¯¼å…¥åˆ°æ–°ä»åº“ä¸­ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§</span><br><span class="line"></span><br><span class="line">2ã€ç›´æ¥åœ¨ä»åº“ä¸­æ“ä½œæ•°æ®åº“</span><br><span class="line">è§£å†³æ–¹æ³•ï¼šä»åº“è®¾ç½®ä¸å…è®¸å†™å…¥ ï¼Œä»åº“è®¾ç½®ä¸ºåªè¯»(è¯»å†™åˆ†ç¦»)</span><br><span class="line"><span class="comment"># åœ¨å‘½ä»¤è¡Œä¸´æ—¶è®¾ç½®</span></span><br><span class="line"><span class="built_in">set</span> global read_only=1;</span><br><span class="line"><span class="comment"># åœ¨é…ç½®æ–‡ä»¶ä¸­æ°¸ä¹…ç”Ÿæ•ˆ</span></span><br><span class="line">read_only=1</span><br><span class="line">å‘½ä»¤è¡Œ+é…ç½®æ–‡ä»¶ ä¸éœ€è¦é‡å¯å°±æ˜¯æ°¸ä¹…å¤±æ•ˆ</span><br><span class="line"><span class="comment">#ä½†æ˜¯ç”¨rootç”¨æˆ·ï¼Œå¯¹rootä¸ç”Ÿæ•ˆ</span></span><br></pre></td></tr></table></figure><p>3ã€</p><p><img src="../image/study_img/image-20240826150832618.png" alt="image-20240826150832618"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è§£å†³åŠæ³•</span></span><br><span class="line">1ã€ä¸»åº“åœæ­¢ä¸»ä»å¤åˆ¶</span><br><span class="line">root@localhost:(none) &gt; stop slave;</span><br><span class="line"></span><br><span class="line">2ã€åœ¨ä¸»åº“ä¸ŠæŸ¥çœ‹å½“å‰ä½ç½®ç‚¹</span><br><span class="line">root@localhost:(none) &gt; show master status;</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB |</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line">| mysql-bin.000016 |  5235939 |              |</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line"></span><br><span class="line">3ã€ä»åº“æ‰“ç‚¹å…¨å¤‡ï¼Œåˆ°ä»åº“ï¼Œ</span><br><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -A -R --triggers --master-data=1 --single-transaction|gzip &gt; /tmp/full.sql.gz</span><br><span class="line">[root@db01 ~]# scp /tmp/full.sql.gz 172.16.1.52:/tmp</span><br><span class="line"></span><br><span class="line">4ã€ä»åº“å†ä»å½“å‰ä½ç½®ç‚¹å¼€å§‹å¤åˆ¶</span><br><span class="line">[root@db02 ~]# zcat /tmp/full.sql.gz |mysql -uroot -p123</span><br><span class="line">[root@db02 ~]# mysql -uroot -p123</span><br><span class="line"></span><br><span class="line">5ã€#ä»åº“æ‰§è¡Œchange mater è¯­å¥</span><br><span class="line">change master to</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file=<span class="string">&#x27;mysql-bin.000016&#x27;</span>,</span><br><span class="line">master_log_pos=5235939,</span><br><span class="line">master_port=3306;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6ã€#ä»åº“å¼€å¯ä¸»ä»å¤åˆ¶</span><br><span class="line">root@localhost:(none) &gt; start slave;</span><br><span class="line">æŸ¥çœ‹æ•°æ®æ˜¯å¦åŒæ­¥</span><br><span class="line">root@localhost:(none) &gt; show slave status\G</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><p><strong>ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚ä½•æ·»åŠ ä¸€å°ä»åº“</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ–°ä»åº“ç¯å¢ƒåˆå§‹åŒ–  (db04)</span></span><br><span class="line">ç›®å‰db01ä¸»åº“å·²ç»æœ‰ä¸€äº›æ•°æ®äº†ï¼Œå‡è®¾db01æ˜¯ç”Ÿäº§ç¯å¢ƒçš„ä¸»åº“ï¼Œè¿˜æœ‰æ•°æ®åœ¨ç½‘é‡Œé¢å†™å…¥</span><br><span class="line">è¿è¡Œè„šæœ¬</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line">[root@db02 ~]# <span class="built_in">rm</span> -rf /app/mysql-5.6.50/data</span><br><span class="line">é…ç½®æ–‡ä»¶å’Œæ—§ç¯å¢ƒå¤§éƒ¨åˆ†ä¿æŒä¸€è‡´</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[root@db02 ~]# /app/mysql-5.6.50/scripts/mysql_install_db --user=mysql --basedir=/app/mysql-5.6.50 --datadir=/app/mysql-5.6.50/data</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start; mysqladmin -uroot -p password <span class="string">&#x27;123&#x27;</span></span><br><span class="line"></span><br><span class="line">1ã€#ä¸»åº“æ‰“ç‚¹å…¨å¤‡(çƒ­å¤‡ ä¸é”è¡¨)</span><br><span class="line">[root@db01 ~]#  mysqldump -uroot -p123 -A -R --triggers --master-data=1 --single-transaction|gzip &gt; /tmp/full.sql.gz</span><br><span class="line"></span><br><span class="line">ä½†æ˜¯zcatçš„æ–‡ä»¶é‡Œé¢æœ‰loca table ä¸ºä»€ä¹ˆé”è¡¨å‘¢ï¼Ÿ</span><br><span class="line">å®ƒæ˜¯ç”¨è¿™ä¸ªæ–‡ä»¶å¾€é‡Œæ¢å¤æ•°æ®çš„æ—¶å€™é”è¡¨ï¼Œæ–‡ä»¶æ˜¾ç¤ºçš„æ˜¯æ¢å¤è¿‡ç¨‹ï¼Œå¤‡ä»½çš„æ—¶å€™ä¸é”è¡¨çš„ï¼Œä¸æ˜¯å¤‡ä»½çš„è¿‡ç¨‹ï¼Œæ˜¯åœ¨æ¢å¤çš„æ—¶å€™é”ä½</span><br><span class="line"></span><br><span class="line">2ã€#ä»åº“æ¢å¤ä¸»åº“å…¨å¤‡æ•°æ®</span><br><span class="line">[root@db01 ~]# scp /tmp/full.sql.gz 172.16.1.54:/tmp</span><br><span class="line"></span><br><span class="line">[root@db04 ~]# zcat /tmp/full.sql.gz |mysql -uroot -p123</span><br><span class="line"></span><br><span class="line">3ã€#ä»æŸ¥çœ‹æ•°æ®å°‘äº†ï¼ŒæŸ¥çœ‹ç‚¹ä½ï¼Œç›´æ¥ä»æ‰“ç‚¹çš„ä½ç½®å¼€å§‹å¤åˆ¶</span><br><span class="line">[root@db01 ~]# zcat /tmp/full.sql.gz |<span class="built_in">head</span> -25</span><br><span class="line">CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000016&#x27;</span>, MASTER_LOG_POS=984578;</span><br><span class="line"></span><br><span class="line">5ã€#ä»åº“æ‰§è¡Œchange mater è¯­å¥</span><br><span class="line">change master to</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file=<span class="string">&#x27;mysql-bin.000016&#x27;</span>,</span><br><span class="line">master_log_pos=984578,</span><br><span class="line">master_port=3306;</span><br><span class="line"></span><br><span class="line">6ã€#ä»åº“å¼€å¯ä¸»ä»å¤åˆ¶</span><br><span class="line">root@localhost:(none) &gt; start slave;</span><br><span class="line">æŸ¥çœ‹æ•°æ®æ˜¯å¦åŒæ­¥</span><br><span class="line">root@localhost:(none) &gt; show slave status\G</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><h3 id="2ã€å»¶æ—¶å¤åˆ¶">2ã€å»¶æ—¶å¤åˆ¶</h3><p><strong>ä¼ ç»Ÿä¸»ä»å¤åˆ¶çš„ç¼ºé™·</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¼ ç»Ÿä¸»ä»å¤åˆ¶æ— æ³•å¤‡ä»½</span><br><span class="line">2ã€ä¼ ç»Ÿä¸»ä»å¤åˆ¶æ— æ³•è¿‡æ»¤å¤åˆ¶</span><br><span class="line">3ã€ä¼ ç»Ÿä¸»ä»å¤åˆ¶é€Ÿåº¦ç›¸å¯¹æ¥è¯´æ¯”è¾ƒæ…¢</span><br><span class="line">4ã€ä¼ ç»Ÿä¸»ä»å¤åˆ¶æ˜¯å¼‚æ­¥å¤åˆ¶ï¼Œä»åº“æ•°æ®å»¶è¿Ÿ(æ¯å°ä»åº“æ•°æ®ä¸æ˜¯ç™¾åˆ†ç™¾ä¸€è‡´ï¼Œæ¯å°ä»åº“çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†è¿™ä¸ªæ˜¯ä¸å¯é¿å…çš„ï¼Œåœ¨ç”Ÿäº§ä¸­ä¸€å®šæœ‰å»¶è¿Ÿ)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant replication slave on prod.* to slave@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">ERROR 1221 (HY000): Incorrect usage of DB GRANT and GLOBAL PRIVILEGES</span><br><span class="line"><span class="comment">#replication è¿™æ˜¯ä¸€ä¸ªå…¨å±€çš„æƒé™</span></span><br></pre></td></tr></table></figure><p><strong>å»¶æ—¶ä»åº“</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¼ä¸šä¸€èˆ¬ä¼šå»¶æ—¶3~6å°æ—¶</span></span><br><span class="line">1ã€åšå»¶æ—¶ä»åº“çš„æœåŠ¡å™¨æ— æ³•åœ¨ç”Ÿäº§ä¸­æä¾›æœåŠ¡(è¿™ä¸ªæœºå™¨å°±æ˜¯ä¸€ä¸ªå¤‡æœº)</span><br><span class="line">2ã€å¤‡ä»½</span><br><span class="line">3ã€æ¢å¤æ•°æ®é€Ÿåº¦æ›´å¿«</span><br><span class="line">4ã€å»¶æ—¶ä»åº“ä¸å½±å“é«˜å¯ç”¨</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å»¶æ—¶ä»åº“çš„åŸç†ï¼šåœ¨SQLçº¿ç¨‹åšæ‰‹è„šï¼ŒIOçº¿ç¨‹ç»§ç»­æ‹¿æ•°æ®ï¼ŒSQLçº¿ç¨‹åœ¨æŒ‡å®šæ—¶é—´åï¼Œå»¶æ—¶æ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">(æ€ä¹ˆåšï¼Œæ‰èƒ½è®©ä»–å»¶è¿Ÿ3~6å°æ—¶ï¼Ÿ)</span><br><span class="line"><span class="comment">#ä¼šè®¾ç½®SQLçº¿ç¨‹åœ¨æŒ‡å®šçš„æ—¶é—´åå†æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p>å»¶æ—¶ä»åº“çš„åŸç†</p><p><img src="../image/study_img/image-20240826144421626.png" alt="image-20240826144421626"></p><p><strong>é…ç½®å»¶æ—¶ä»åº“</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å‘½ä»¤ï¼šé‡ç½®ä¸»ä»å¤åˆ¶ :ä»–ä¼šæŠŠæ‰€æœ‰ç›¸å…³æ–‡ä»¶é‡ç½®</span></span><br><span class="line">éœ€è¦ä¿®æ”¹æŸäº›å‚æ•°çš„æ—¶å€™æ‰ç”¨(æ¯”å¦‚è¯´ä½ç½®ç‚¹å†™é”™äº†ï¼Œå¯†ç å†™é”™äº†)</span><br><span class="line">mysql&gt; change master to</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,master_user=<span class="string">&#x27;rep&#x27;</span>,master_password=<span class="string">&#x27;123&#x27;</span>,master_log_file=<span class="string">&#x27;mysql-bin.000003&#x27;</span>,master_log_pos=154;</span><br><span class="line"></span><br><span class="line">reset slave;     ä¼šä¿ç•™ä¹‹å‰chang masetrçš„ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">reset slave all;  (å®Œå…¨é‡ç½®ä¸»ä»ï¼Œä¿ç•™ä»»ä½•ä¿¡æ¯ï¼Œå–æ¶ˆä»åº“èº«ä»½çš„æ—¶å€™)</span><br><span class="line"></span><br><span class="line"><span class="comment">#åœæ­¢ä¸»ä»å¤åˆ¶</span></span><br><span class="line">stop slave;  </span><br><span class="line"></span><br><span class="line"><span class="comment">#å°±æ˜¯åœ¨SQL-DelayåŠ å»¶è¿Ÿæ—¶é—´</span></span><br><span class="line"><span class="comment">#å°†db04å˜æˆå»¶æ—¶ä»åº“</span></span><br><span class="line"></span><br><span class="line">1ã€#åœæ­¢ä¸»ä»å¤åˆ¶</span><br><span class="line">root@localhost:(none) &gt; stop slave;</span><br><span class="line"></span><br><span class="line">2ã€#é‡ç½®ä¸»ä»ä¿¡æ¯</span><br><span class="line">root@localhost:(none) &gt; reset salve;</span><br><span class="line"></span><br><span class="line">3ã€#é…ç½®SQLçº¿ç¨‹å»¶è¿Ÿå¤åˆ¶æ—¶é—´   180 3min</span><br><span class="line">root@localhost:(none) &gt; chang master to master_delay=180;</span><br><span class="line"></span><br><span class="line">4ã€#å¼€å¯ä¸»ä»å¤åˆ¶ï¼Œå¹¶æŸ¥çœ‹çŠ¶æ€</span><br><span class="line">root@localhost:(none) &gt; start slave;</span><br><span class="line">root@localhost:(none) &gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: </span><br><span class="line">               Master_Host: 172.16.1.51</span><br><span class="line">               ......</span><br><span class="line">               SQL_Delay: 180</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#é…ç½®å»¶æ—¶ä»åº“ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œå½“è®©æ•°æ®ä¸€è‡´çš„è§£å†³åŠæ³•</span></span><br><span class="line">1ã€#ä»åº“æ“ä½œ</span><br><span class="line">root@localhost:(none) &gt; stop slave;</span><br><span class="line">root@localhost:(none) &gt; reset slave;</span><br><span class="line">root@localhost:(none) &gt; change master to master_delay=0;</span><br><span class="line"></span><br><span class="line">2ã€ä¸»åº“æ“ä½œ</span><br><span class="line">[root@db01 ~]#  mysqldump -A -uroot -p123 &gt; /tmp/full.sql</span><br><span class="line">[root@db01 ~]# scp /tmp/full.sql.gz 172.16.1.52:/tmp</span><br><span class="line"></span><br><span class="line">3ã€ä»åº“æ¢å¤æ•°æ®</span><br><span class="line">root@localhost:world &gt; <span class="built_in">source</span> /tmp/full.sql;</span><br><span class="line"></span><br><span class="line">4ã€ä¸»åº“æŸ¥çœ‹ä½ç½®ç‚¹</span><br><span class="line">root@localhost:(none) &gt; show master status;</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB |</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line">| mysql-bin.000016 |  5366820 |              |</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line"></span><br><span class="line">5ã€#ä»åº“æ‰§è¡Œchange mater è¯­å¥</span><br><span class="line">change master to</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file=<span class="string">&#x27;mysql-bin.000016&#x27;</span>,</span><br><span class="line">master_log_pos=5366820,</span><br><span class="line">master_port=3306;</span><br><span class="line"></span><br><span class="line">root@localhost:world &gt; start slave;</span><br><span class="line">root@localhost:world &gt; show slave status\G</span><br></pre></td></tr></table></figure><p><strong>å»¶æ—¶ä»åº“æ¢å¤æ¡ˆä¾‹</strong></p><p>æ€»æ•°æ®é‡çº§500Gï¼Œæ­£å¸¸å¤‡ä»½å»æ¢å¤éœ€è¦1.5-2å°æ—¶<br>1ï¼‰é…ç½®å»¶æ—¶3600ç§’<br>mysql&gt;CHANGE MASTER TO MASTER_DELAY = 3600;</p><p>2ï¼‰ä¸»åº“<br>drop database db;</p><p>3ï¼‰æ€ä¹ˆåˆ©ç”¨å»¶æ—¶ä»åº“ï¼Œæ¢å¤æ•°æ®ï¼Ÿ</p><p>1ã€æ¨¡æ‹Ÿæ•°æ®å‡†å¤‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">1ã€#ä¸»åº“db01æ‰§è¡Œå†™å…¥æ•°æ®çš„è„šæœ¬</span><br><span class="line">[root@db01 ~]# sh insert.sh </span><br><span class="line"></span><br><span class="line">2ã€å…ˆä¿è¯å…¶ä»–ä»åº“çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œä¸»ä»åŒæ­¥æ²¡é—®é¢˜</span><br><span class="line"></span><br><span class="line">3ã€ä¸»åº“åˆ›å»ºä¸€ä¸ªåº“ï¼Œå†™å…¥æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; create database asm;</span><br><span class="line">root@localhost:(none) &gt; flush logs;</span><br><span class="line">root@localhost:(none) &gt; use asm</span><br><span class="line">root@localhost:(none) &gt; create table asm(<span class="built_in">id</span> int);</span><br><span class="line">root@localhost:(none) &gt; insert into asm values(1),(2),(3);</span><br><span class="line">root@localhost:(none) &gt; update asm <span class="built_in">set</span> <span class="built_in">id</span>=10 <span class="built_in">where</span> <span class="built_in">id</span>=1;</span><br><span class="line"></span><br><span class="line">4ã€ä¸»åº“æ‰“ç‚¹å…¨å¤‡</span><br><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -A -R --triggers --master-data=2 --single-transaction  &gt; /tmp/full.sql.gz</span><br><span class="line">[root@db01 ~]# scp /tmp/full.sql.gz 172.16.1.52:/tmp</span><br><span class="line"></span><br><span class="line">5ã€ä»åº“ä»åº“ä½ç½®ç‚¹</span><br><span class="line">[root@db02 ~]# <span class="built_in">head</span> -25 /tmp/full.sql.gz </span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000017&#x27;</span>, MASTER_LOG_POS=99930;</span><br><span class="line">[root@db02 ~]#  mysql -uroot -p123 &lt; /tmp/full.sql.gz </span><br><span class="line"></span><br><span class="line">6ã€è®©ä»åº“db02å˜æˆä¸€ä¸ªå»¶æ—¶ä»åº“</span><br><span class="line">root@localhost:world &gt; <span class="keyword">select</span> * from asm.asm;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|   10 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line">root@localhost:world &gt; stop slave;</span><br><span class="line">root@localhost:world &gt; reset slave all;</span><br><span class="line"></span><br><span class="line">7ã€ä»åº“æ‰§è¡Œchange mater è¯­å¥</span><br><span class="line">change master to</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file=<span class="string">&#x27;mysql-bin.000017&#x27;</span>,</span><br><span class="line">master_log_pos=99930,</span><br><span class="line">master_port=3306,</span><br><span class="line">master_delay=180;</span><br><span class="line"></span><br><span class="line">root@localhost:world &gt; start slave;</span><br><span class="line">root@localhost:world &gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           Slave_IO_Running: Yes</span><br><span class="line">          Slave_SQL_Running: Yes</span><br><span class="line">          .........</span><br><span class="line">          SQL_Delay: 180</span><br><span class="line">          SQL_Remaining_Delay: 0</span><br><span class="line">          </span><br><span class="line"></span><br><span class="line">8ã€ä¸»åº“é‡Œé¢å†å†™ç‚¹æ•°æ®ï¼Œä»åº“é‡Œé¢æŸ¥çœ‹ç°åœ¨æ•°æ®è¿˜æ²¡æœ‰å†™è¿‡æ¥ï¼ŒæŠŠä¸»åº“çš„åº“åˆ é™¤</span><br><span class="line">root@localhost:asm &gt; insert into asm values(4),(5),(6);</span><br><span class="line">root@localhost:asm &gt; <span class="keyword">select</span> * from asm.asm;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|   10 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">|    5 |</span><br><span class="line">|    6 |</span><br><span class="line">+------+      </span><br><span class="line">root@localhost:(none) &gt; drop database asm;</span><br></pre></td></tr></table></figure><p>2ã€æ¢å¤æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">(ä¼ä¸šä¸­çš„ç›˜)SAS  Flash(æœ€æ¥è¿‘å†…å­˜æ€§èƒ½çš„ç›˜) </span><br><span class="line">SATA(ç”µè„‘çš„ç›˜)</span><br><span class="line">mysq1&gt; change master to master_delay=0;  å–æ¶ˆå»¶æ—¶å¤åˆ¶</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¢å¤æ€è·¯    ç”¨db02åšå»¶æ—¶ä»åº“</span></span><br><span class="line">1ã€#åœæ­¢db02å»¶æ—¶ä»åº“çš„SQLçº¿ç¨‹</span><br><span class="line">root@localhost:(none) &gt; stop slave SQL_thread;</span><br><span class="line"></span><br><span class="line">2ã€#å‡†å¤‡æ–°ç¯å¢ƒ</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line">[root@db02 ~]# <span class="built_in">rm</span> -rf /app/mysql-5.6.50/data</span><br><span class="line">é…ç½®æ–‡ä»¶å’Œæ—§ç¯å¢ƒå¤§éƒ¨åˆ†ä¿æŒä¸€è‡´</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[root@db02 ~]# /app/mysql-5.6.50/scripts/mysql_install_db --user=mysql --basedir=/app/mysql-5.6.50 --datadir=/app/mysql-5.6.50/data</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start; mysqladmin -uroot -p password <span class="string">&#x27;123&#x27;</span></span><br><span class="line"></span><br><span class="line">3ã€#å»¶æ—¶ä»åº“åšå…¨å¤‡  (ä»åº“æ²¡æœ‰å¼€binlog  ä¸ç”¨æ‰“ç‚¹å…¨å¤‡)</span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 -A -R --triggers &gt; /tmp/full_new.sql</span><br><span class="line"></span><br><span class="line">4ã€#æˆªå–åˆ åº“ä¹‹å‰relay-log.infoæ•°æ®  (æŸ¥çœ‹ä»åº“æ‰§è¡Œåˆ°å“ªä¸ªä½ç½®ç‚¹)</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /app/mysql-5.6.50/data/relay-log.info </span><br><span class="line">7</span><br><span class="line">./db02-relay-bin.000002  <span class="comment">#ç»“æŸä½ç½®ç‚¹çš„æ–‡ä»¶</span></span><br><span class="line">171031  <span class="comment">#å¼€å§‹ä½ç½®ç‚¹</span></span><br><span class="line">mysql-bin.000017</span><br><span class="line">270678</span><br><span class="line">180</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">å¼€å§‹ä½ç½®ç‚¹ï¼š171031  </span><br><span class="line"></span><br><span class="line">[root@db02 ~]# mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/db02-relay-bin.000002 | grep -iC 10 drop</span><br><span class="line">ç»“æŸä½ç½®ç‚¹ï¼š194850</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# mysqlbinlog --start-position=171031 --stop-position=194850  /app/mysql-5.6.50/data/db02-relay-bin.000002 &gt; /tmp/inc1.sql</span><br><span class="line"></span><br><span class="line">5ã€æˆªå–åˆ åº“ä¹‹åçš„æ•°æ® éœ€è¦åœæ­¢æ•°æ®å†™å…¥</span><br><span class="line">[root@db01 ~]# sh insert.sh ^C</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     3442 |</span><br><span class="line">+----------+  <span class="comment">#è®°å½•åœåº“å‰æ•°æ®æœ€åå†™å…¥çš„çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line">6ã€æˆªå–åˆ åº“ä¹‹å‰çš„ä½ç½®ç‚¹~åœåº“çš„ä½ç½®ç‚¹æ•°æ®</span><br><span class="line">[root@db02 ~]# mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/db02-relay-bin.000002 | grep -iC 10 drop</span><br><span class="line">å¼€å§‹ä½ç½®ç‚¹ï¼š194939 </span><br><span class="line"></span><br><span class="line">[root@db02 ~]# ll /app/mysql-5.6.50/data/</span><br><span class="line">-rw-rw---- 1 mysql mysql   489751 Aug 26 17:21 db02-relay-bin.000002</span><br><span class="line">ç»“æŸä½ç½®ç‚¹ï¼š489751</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# mysqlbinlog --start-position=194939 --stop-position=489751  /app/mysql-5.6.50/data/db02-relay-bin.000002 &gt; /tmp/inc2.sql</span><br><span class="line"></span><br><span class="line">7ã€å‡†å¤‡æ–°ç¯å¢ƒ<span class="string">&#x27;db03&#x27;</span></span><br><span class="line">[root@db03 ~]# /etc/init.d/mysqld stop</span><br><span class="line">[root@db03 ~]# <span class="built_in">rm</span> -rf /app/mysql-5.6.50/data</span><br><span class="line">é…ç½®æ–‡ä»¶å’Œæ—§ç¯å¢ƒå¤§éƒ¨åˆ†ä¿æŒä¸€è‡´</span><br><span class="line">[root@db03 ~]# vim /etc/my.cnf</span><br><span class="line">[root@db03 ~]# /app/mysql-5.6.50/scripts/mysql_install_db --user=mysql --basedir=/app/mysql-5.6.50 --datadir=/app/mysql-5.6.50/data</span><br><span class="line">[root@db03 ~]# /etc/init.d/mysqld start; mysqladmin -uroot -p password <span class="string">&#x27;123&#x27;</span></span><br><span class="line"></span><br><span class="line">7ã€å°†å»¶æ—¶ä»åº“çš„å…¨å¤‡å¯¼å…¥æ–°ç¯å¢ƒ</span><br><span class="line">[root@db02 ~]# scp /tmp/full_new.sql  172.16.1.53:/tmp</span><br><span class="line">[root@db03 ~]#  mysql -uroot -p123 &lt; /tmp/full_new.sql </span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹æ–°ç¯å¢ƒçš„æ•°æ®çŠ¶æ€</span><br><span class="line">[root@db03 ~]#  mysql -uroot -p123</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     1731 |</span><br><span class="line">+----------+  <span class="comment">#å¯ä»¥çœ‹åˆ°æ•°æ®è¿˜ä¸å…¨</span></span><br><span class="line"></span><br><span class="line">8ã€æ¢å¤å»¶è¿ŸæŸ¥çœ‹æˆªå–çš„ç¬¬ä¸€æ®µï¼Œç¬¬äºŒæ®µæ–°å¢æ•°æ®åˆ°æ–°ç¯å¢ƒ</span><br><span class="line">[root@db02 ~]# scp /tmp/inc1.sql   172.16.1.53:/tmp</span><br><span class="line">[root@db02 ~]# scp /tmp/inc2.sql   172.16.1.53:/tmp</span><br><span class="line">[root@db03 ~]#  mysql -uroot -p123 &lt; /tmp/inc1.sql</span><br><span class="line">[root@db03 ~]#  mysql -uroot -p123 &lt; /tmp/inc2.sql</span><br><span class="line"></span><br><span class="line">9ã€æ–°ç¯å¢ƒdb03æŸ¥çœ‹æ•°æ®æ˜¯å¦æ¢å¤</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     3442 |</span><br><span class="line">+----------+</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> * from asm.asm;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|   10 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">|    5 |</span><br><span class="line">|    6 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">10ã€åº”ç”¨å‰²æ¥</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å–æ¶ˆå»¶æ—¶ä»åº“çš„æ­¥éª¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å°†db02å»¶æ—¶ä»åº“å–æ¶ˆé…ç½®</span></span><br><span class="line">root@localhost:(none) &gt; stop slave;</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; change master to master_delay=0;</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; start slave;</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; show slave status\G</span><br><span class="line"><span class="comment">#æŸ¥çœ‹çº¿ç¨‹å¯èƒ½æœ‰æŠ¥é”™</span></span><br><span class="line">ä¸»åº“æ‰“ç‚¹å…¨å¤‡</span><br><span class="line">[root@db01 ~]#  mysqldump -uroot -p123 -A -R --triggers --master-data=2 --single-transaction  &gt; /tmp/full.sql.gz</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# scp /tmp/full.sql.gz 172.16.1.52:/tmp </span><br><span class="line">[root@db01 ~]# <span class="built_in">head</span> -25 /tmp/full.sql.gz</span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000017&#x27;</span>, MASTER_LOG_POS=589398;</span><br><span class="line"></span><br><span class="line">ã€ä»åº“æ¢å¤æ•°æ®</span><br><span class="line">root@localhost:world &gt; <span class="built_in">source</span> /tmp/full.sql;</span><br><span class="line"></span><br><span class="line">ã€ä¸»åº“æŸ¥çœ‹ä½ç½®ç‚¹</span><br><span class="line">root@localhost:(none) &gt; show master status;</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB |</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line">| mysql-bin.000017 |  589398  |              |</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ã€#ä»åº“æ‰§è¡Œchange mater è¯­å¥</span><br><span class="line">root@localhost:(none) &gt; stop slave;</span><br><span class="line"></span><br><span class="line">change master to</span><br><span class="line">master_user=<span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_host=<span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_password=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file=<span class="string">&#x27;mysql-bin.000017&#x27;</span>,</span><br><span class="line">master_log_pos=589398,</span><br><span class="line">master_port=3306;</span><br><span class="line"></span><br><span class="line">root@localhost:world &gt; start slave;</span><br><span class="line">root@localhost:world &gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.1.51</span><br><span class="line">                  Master_User: rep</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000017</span><br><span class="line">          Read_Master_Log_Pos: 589398</span><br><span class="line">               Relay_Log_File: db02-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 283</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000017</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><h3 id="3ã€åŠåŒæ­¥å¤åˆ¶">3ã€<strong>åŠåŒæ­¥å¤åˆ¶</strong></h3><p>åŠåŒæ­¥å¤åˆ¶å‡ºç°çš„åŸå› ï¼šä¸ºäº†ä¿è¯ä¸»åº“å’Œä»åº“çš„æ•°æ®ä¸€è‡´æ€§</p><p>ä»åº“çš„IOçº¿ç¨‹åœ¨æ²¡æœ‰æ¥æ”¶åˆ°ACKä¹‹å‰ï¼Œä¼šé˜»å¡ä¸»åº“å†™å…¥æ“ä½œ<br>åŠåŒæ­¥ç¼ºç‚¹ï¼šé˜»å¡ä¸»åº“å†™å…¥æ•°æ®ï¼Œå½±å“ä¸»åº“æ€§èƒ½ï¼Œé™ä½ç”¨æˆ·ä½“éªŒ<br>åŠåŒæ­¥ä¼˜ç‚¹ï¼šä¸»åº“å’Œä»åº“æ•°æ®ä¿è¯äº†ä¸€è‡´æ€§ï¼Œä¸ä¼šä¸¢æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ä»MYSQL5.5å¼€å§‹ï¼Œæ”¯æŒåŠè‡ªåŠ¨å¤åˆ¶ã€‚ä¹‹å‰ç‰ˆæœ¬çš„MySQL Replicationéƒ½æ˜¯å¼‚æ­¥ï¼ˆasynchronousï¼‰çš„ï¼Œä¸»åº“åœ¨æ‰§è¡Œå®Œä¸€äº›äº‹åŠ¡åï¼Œæ˜¯ä¸ä¼šç®¡å¤‡åº“çš„è¿›åº¦çš„ã€‚å¦‚æœå¤‡åº“ä¸å¹¸è½åï¼Œè€Œæ›´ä¸å¹¸çš„æ˜¯ä¸»åº“æ­¤æ—¶åˆå‡ºç°Crashï¼ˆä¾‹å¦‚å®•æœºï¼‰ï¼Œè¿™æ—¶å¤‡åº“ä¸­çš„æ•°æ®å°±æ˜¯ä¸å®Œæ•´çš„ã€‚ç®€è€Œè¨€ä¹‹ï¼Œåœ¨ä¸»åº“å‘ç”Ÿæ•…éšœçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ— æ³•ä½¿ç”¨å¤‡åº“æ¥ç»§ç»­æä¾›æ•°æ®ä¸€è‡´çš„æœåŠ¡äº†ã€‚</span><br><span class="line"></span><br><span class="line">åŠåŒæ­¥å¤åˆ¶ï¼ˆSemi synchronous Replicationï¼‰åˆ™ä¸€å®šç¨‹åº¦ä¸Šä¿è¯æäº¤çš„äº‹åŠ¡å·²ç»ä¼ ç»™äº†è‡³å°‘ä¸€ä¸ªå¤‡åº“ã€‚</span><br><span class="line">å‡ºå‘ç‚¹æ˜¯ä¿è¯ä¸»ä»æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå®‰å…¨çš„è€ƒè™‘ã€‚</span><br><span class="line">5.5 å‡ºç°æ¦‚å¿µï¼Œä½†æ˜¯ä¸å»ºè®®ä½¿ç”¨ï¼Œæ€§èƒ½å¤ªå·®</span><br><span class="line">5.6å‡ºç°group commit ç»„æäº¤åŠŸèƒ½ï¼Œæ¥æå‡å¼€å¯åŠåŒæ­¥å¤åˆ¶çš„æ€§èƒ½</span><br><span class="line">5.7æ›´åŠ å®Œå–„äº†ï¼Œåœ¨group commitåŸºç¡€ä¸Šå‡ºç°äº†MGR</span><br><span class="line">5.7çš„å¢å¼ºåŠåŒæ­¥å¤åˆ¶çš„æ–°ç‰¹æ€§ï¼šafter commitï¼› after <span class="built_in">sync</span>ï¼›</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä»€ä¹ˆæƒ…å†µä¸‹ä»£è¡¨æ•°æ®å†™å®Œäº†ï¼Œè€Œä¸”å®Œæ•´</span></span><br><span class="line">TCPç¼“å­˜ä¼šè¿”å›ä¸€ä¸ªACKç»™IOçº¿ç¨‹</span><br><span class="line"></span><br><span class="line"><span class="comment">#åŠåŒæ­¥å¤åˆ¶(åœ¨IOçº¿ç¨‹åšæ‰‹è„š)</span></span><br><span class="line">IOçº¿ç¨‹å–å‡ºæ•°æ®åï¼ŒIOçº¿ç¨‹ä¸è¿”å›ACKï¼ŒIOçº¿ç¨‹å°±ä¸å»ç»™Dumpçº¿ç¨‹è¦æ•°æ®</span><br><span class="line">åªè¦ä»åº“IOçº¿ç¨‹æ²¡æœ‰æ¥åˆ°ACKä¹‹å‰ï¼Œä¼šé˜»å¡ä¸»åº“å†™å…¥æ“ä½œ(ä¸ºäº†æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå½±å“ä¸»åº“æ€§èƒ½å¯¼è‡´ç”¨æˆ·çš„ä½“éªŒä¸‹é™)</span><br><span class="line"><span class="comment">#å¼€ä¸å¼€åŠåŒæ­¥å–å†³äºå…¬å¸ï¼Œä½†å‡ ä¹å¾ˆå°‘å¼€</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240826181704110.png" alt="image-20240826181704110"></p><p>åŠåŒæ­¥çš„æ’ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# ll /app/mysql-5.6.50/lib/plugin/</span><br><span class="line">-rwxr-xr-x 1 mysql mysql 515584 Aug  7 19:52 semisync_master.so</span><br><span class="line">-rwxr-xr-x 1 mysql mysql 276296 Aug  7 19:52 semisync_slave.so</span><br><span class="line"></span><br><span class="line">ä¸ºä»€ä¹ˆä¸æ˜¯è‡ªåŠ¨å®‰è£…è¿™ä¸¤ä¸ªæ’ä»¶ï¼Ÿ</span><br><span class="line">1ã€ä¸æ˜¯æ¯ä¸ªå…¬å¸éƒ½æœ‰å¼€åŠåŒæ­¥</span><br><span class="line">2ã€å…ˆåšä¸»ä»ä¹‹åæ‰èƒ½å¼€åŠåŒæ­¥</span><br></pre></td></tr></table></figure><p><strong>åŠåŒæ­¥å¤åˆ¶çš„é…ç½®</strong></p><p>1ã€db01ä¸»åº“æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¸»åº“æŸ¥çœ‹æ˜¯å¦æ”¯æŒåŠåŒæ­¥</span><br><span class="line">root@localhost:(none) &gt; show global variables like <span class="string">&#x27;have_dynamic_loading&#x27;</span>;</span><br><span class="line">+----------------------+-------+</span><br><span class="line">| Variable_name        | Value |</span><br><span class="line">+----------------------+-------+</span><br><span class="line">| have_dynamic_loading | YES   |</span><br><span class="line">+----------------------+-------+</span><br><span class="line"></span><br><span class="line">2ã€ä¸»åº“éœ€è¦å®‰è£…åŠåŒæ­¥æ’ä»¶</span><br><span class="line">root@localhost:(none) &gt; install plugin rpl_semi_sync_master soname<span class="string">&#x27;semisync_master.so&#x27;</span>;</span><br><span class="line"></span><br><span class="line">3ã€å¯åŠ¨æ’ä»¶+è®¾ç½®è¶…æ—¶æ—¶é—´(ä¸´æ—¶çš„) </span><br><span class="line">root@localhost:(none) &gt; SET GLOBAL rpl_semi_sync_master_enabled = 1;</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> global rpl_semi_sync_master_timeout = 1000;</span><br><span class="line"></span><br><span class="line">4ã€#æ°¸ä¹…å¯åŠ¨å†™åœ¨é…ç½®æ–‡ä»¶é‡Œé¢+è¶…æ—¶æ—¶é—´  è®¾ç½®è¶…æ—¶ 1000ms=1s</span><br><span class="line">è¶…è¿‡10sè¿˜æ²¡æœ‰å†™å®Œæ•°æ®ï¼Œä¼šåœæ­¢åŠåŒæ­¥ï¼Œæ¢å¤æˆå¼‚æ­¥å¤åˆ¶(å¦‚æœæƒ³è¦æ°¸ä¹…å¤±æ•ˆå°±å†™åœ¨é…ç½®æ–‡ä»¶é‡Œé¢)</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">....</span><br><span class="line">rpl_semi_sync_master_enabled=1</span><br><span class="line">rpl_semi_sync_master_timeout = 1000</span><br><span class="line"></span><br><span class="line">5ã€æ£€æŸ¥</span><br><span class="line">root@localhost:(none) &gt; show variables like<span class="string">&#x27;rpl%&#x27;</span>;</span><br><span class="line">root@localhost:(none) &gt; show variables like<span class="string">&#x27;rpl%&#x27;</span>;</span><br><span class="line">+------------------------------------+----------+</span><br><span class="line">| Variable_name                      | Value    |</span><br><span class="line">+------------------------------------+----------+</span><br><span class="line">| rpl_semi_sync_master_enabled       | ON       |#å¼€å¯</span><br><span class="line">| rpl_semi_sync_master_timeout       | 1000     |#è¶…æ—¶æ—¶é—´</span><br><span class="line">| rpl_semi_sync_master_trace_level   | 32       |#è·¯ç”±çš„çº§åˆ«</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave | ON       |</span><br><span class="line">| rpl_stop_slave_timeout             | 31536000 |#åœæ­¢ä»åº“çš„è¶…æ—¶æ—¶é—´</span><br><span class="line">+------------------------------------+----------+</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; show global status like <span class="string">&#x27;rpl_semi%&#x27;</span>;</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_master_clients               | 0     |#0ä»£è¡¨å®¢æˆ·ç«¯è¿˜æ²¡æœ‰</span><br><span class="line">| Rpl_semi_sync_master_net_avg_wait_time     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_wait_time         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_waits             | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_times              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_tx                 | 0     |</span><br><span class="line">| Rpl_semi_sync_master_status                | ON    |</span><br><span class="line">| Rpl_semi_sync_master_timefunc_failures     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_wait_time          | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_waits              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_sessions         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_yes_tx                | 0     |</span><br><span class="line">+--------------------------------------------+-------+</span><br></pre></td></tr></table></figure><p>2ã€db02ä»åº“é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä»åº“é…ç½®</span></span><br><span class="line">1ã€å®‰è£…æ’ä»¶</span><br><span class="line">root@localhost:world &gt; INSTALL PLUGIN rpl_semi_sync_slave SONAME<span class="string">&#x27;semisync_slave.so&#x27;</span>;</span><br><span class="line"></span><br><span class="line">3ã€å¯åŠ¨æ’ä»¶(ä¸´æ—¶å¯åŠ¨)</span><br><span class="line">root@localhost:world &gt; SET GLOBAL rpl_semi_sync_slave_enabled = 1;</span><br><span class="line">æ°¸ä¹…ç”Ÿæ•ˆ</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">....</span><br><span class="line">rpl_semi_sync_slave_enabled = 1</span><br><span class="line"></span><br><span class="line">4ã€é‡å¯IOçº¿ç¨‹</span><br><span class="line">root@localhost:world &gt; stop slave io_thread;</span><br><span class="line">root@localhost:world &gt; start slave io_thread;</span><br><span class="line"></span><br><span class="line">5ã€åˆ°ä¸»åº“æŸ¥çœ‹æ˜¯å¦æœ‰ä»åº“å˜æˆåŠåŒæ­¥</span><br><span class="line">root@localhost:(none) &gt; show global status like <span class="string">&#x27;rpl_semi%&#x27;</span>;</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_master_clients               | 1     |#æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯</span><br><span class="line">| Rpl_semi_sync_master_net_avg_wait_time     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_wait_time         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_waits             | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_times              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_tx                 | 0     |</span><br><span class="line">| Rpl_semi_sync_master_status                | ON    |</span><br><span class="line">| Rpl_semi_sync_master_timefunc_failures     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_wait_time          | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_waits              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_sessions         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_yes_tx                | 0     |</span><br><span class="line">+--------------------------------------------+-------+</span><br></pre></td></tr></table></figure><p>3ã€æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¸»åº“åˆ›å»ºä¸€ä¸ªåº“</span><br><span class="line">root@localhost:(none) &gt; create database abc111;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)   <span class="comment">#é…ç½®ä¹‹åï¼Œä¸»åº“å»ºåº“æ—¶é—´å˜å¿«</span></span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; create database abc112;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; create database abc113;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; create database abc114;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹çŠ¶æ€ï¼Œä¼šè®°å½•å¹³å‡ç­‰å¾…æ—¶é—´  ï¼ˆmsä¸ºå•ä½ï¼‰</span><br><span class="line">root@localhost:(none) &gt; show global status like <span class="string">&#x27;rpl_semi%&#x27;</span>;</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_master_clients               | 1     |</span><br><span class="line">| Rpl_semi_sync_master_net_avg_wait_time     | 4199  |</span><br><span class="line">| Rpl_semi_sync_master_net_wait_time         | 16799 |</span><br><span class="line">| Rpl_semi_sync_master_net_waits             | 4     |</span><br><span class="line">| Rpl_semi_sync_master_no_times              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_tx                 | 0     |</span><br><span class="line">| Rpl_semi_sync_master_status                | ON    |</span><br><span class="line">| Rpl_semi_sync_master_timefunc_failures     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_avg_wait_time      | 4286  |#å¹³å‡ç­‰å¾…æ—¶é—´ </span><br><span class="line">| Rpl_semi_sync_master_tx_wait_time          | 17144 |</span><br><span class="line">| Rpl_semi_sync_master_tx_waits              | 4     |#ä¸€å…±4æ¡è¯­å¥</span><br><span class="line">| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_sessions         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_yes_tx                | 4     |#æˆåŠŸæ‰§è¡Œ4æ¡è¯­å¥</span><br><span class="line">+--------------------------------------------+-------+</span><br></pre></td></tr></table></figure><p>å…³é—­åŠåŒæ­¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:world &gt; SET GLOBAL rpl_semi_sync_slave_enabled = 0;</span><br><span class="line">é…ç½®æ–‡ä»¶å–æ¶ˆ</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">....</span><br><span class="line"><span class="comment">#rpl_semi_sync_slave_enabled = 1</span></span><br></pre></td></tr></table></figure><h3 id="4ã€mysqlçš„è¿‡æ»¤å¤åˆ¶">4ã€<strong>mysqlçš„è¿‡æ»¤å¤åˆ¶</strong></h3><p>æ¯ä¸ªä»åº“åªæƒ³å¤åˆ¶ä¸€ä¸ªåº“</p><p><img src="../image/study_img/image-20240826200642230.png" alt="image-20240826200642230"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ–¹æ³•ï¼š</span><br><span class="line">å¯ä»¥åœ¨ä¸»åº“é…ç½®ï¼šé…ç½®ç™½åå•æˆ–è€…é»‘åå•</span><br><span class="line">å¯ä»¥åœ¨ä»åº“é…ç½®ï¼šé…ç½®ç™½åå•æˆ–è€…é»‘åå•</span><br></pre></td></tr></table></figure><p><strong>æ–¹æ³•ä¸€ï¼šä¸»åº“é…ç½®(ä¸€èˆ¬ä¸ç”¨)</strong></p><ul><li>binlog-do-dbï¼šç™½åå•ï¼šåªè®°å½•ç™½åå•ä¸­åˆ—å‡ºçš„åº“çš„äºŒè¿›åˆ¶æ—¥å¿—</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">è§„èŒƒçš„sqlè¯­å¥å…ˆuseä¸€ä¸ªåº“ï¼Œå†å†™æ•°æ®</span><br><span class="line"><span class="comment">#åœ¨binlogåšæ‰‹è„šï¼šbinlogåªè®°å½•prodåº“çš„æ•°æ®ï¼Œå…¶ä»–çš„ä¸è®°å½•</span></span><br><span class="line"></span><br><span class="line">1ã€#åªå¤åˆ¶å•åº“</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">binlog-do-db=prod</span><br><span class="line"></span><br><span class="line">2ã€#é‡å¯</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line">3ã€#é‡å¯ä¹‹åï¼Œä»åº“çš„ä¸»ä»å¤åˆ¶éœ€è¦é‡å¯</span><br><span class="line">root@localhost:world &gt; stop slave;start slave;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€#ä¸»åº“æŸ¥çœ‹çŠ¶æ€ï¼šåªå¤åˆ¶prodè¿™ä¸ªåº“çš„äºŒè¿›åˆ¶æ—¥å¿—</span><br><span class="line">root@localhost:(none) &gt; show master status;</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB |</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line">| mysql-bin.000018 |      120 | prod         |#ä»åº“åªå¤åˆ¶prodè¿™ä¸ªåº“çš„äºŒè¿›åˆ¶æ—¥å¿—</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¤åˆ¶å¤šä¸ªåº“</span></span><br><span class="line">1ã€#é…ç½®æ–‡ä»¶å†™åº“åå­—ï¼Œæœ‰å‡ ä¸ªåº“å°±å†™å‡ è¡Œ</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">binlog-do-db=prod</span><br><span class="line">binlog-do-db=world</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#é‡å¯</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line">3ã€#é‡å¯ä¹‹åï¼Œä»åº“çš„ä¸»ä»å¤åˆ¶éœ€è¦é‡å¯</span><br><span class="line">root@localhost:world &gt; stop slave;start slave;</span><br><span class="line"></span><br><span class="line">4ã€#ä¸»åº“æŸ¥çœ‹çŠ¶æ€ï¼šåªå¤åˆ¶prodå’Œworldè¿™2ä¸ªåº“çš„äºŒè¿›åˆ¶æ—¥å¿—</span><br><span class="line">root@localhost:(none) &gt; show master status;</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB |</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line">| mysql-bin.000019 |      120 | prod,world   |</span><br><span class="line">+------------------+----------+--------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æµ‹è¯•</span></span><br><span class="line">1ã€#ä¸»åº“å¾€prodåº“é‡Œé¢å†™æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; use prod</span><br><span class="line">root@localhost:prod &gt; insert into prod values(77777);</span><br><span class="line"></span><br><span class="line">2ã€#ä»åº“æŸ¥çœ‹</span><br><span class="line">root@localhost:world &gt; <span class="keyword">select</span> * from prod.prod;</span><br><span class="line">+-------+</span><br><span class="line">| 77777 |</span><br><span class="line">+-------+</span><br></pre></td></tr></table></figure><ul><li>binlog-ignore-dbï¼šé»‘åå•ï¼šä¸è®°å½•é»‘åå•åˆ—å‡ºçš„åº“çš„äºŒè¿›åˆ¶æ—¥å¿—</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åœ¨binlogåšæ‰‹è„šï¼šbinlogä¸è®°å½•abcåº“çš„æ•°æ®ï¼Œå…¶ä»–çš„éƒ½è®°å½•</span></span><br><span class="line"></span><br><span class="line">1ã€#ä¸å¤åˆ¶å•åº“</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">binlog-ignore-db=abc</span><br><span class="line"></span><br><span class="line">2ã€#é‡å¯</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line">3ã€#é‡å¯ä¹‹åï¼Œä»åº“çš„ä¸»ä»å¤åˆ¶éœ€è¦é‡å¯</span><br><span class="line">root@localhost:world &gt; stop slave;start slave;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€#ä¸»åº“æŸ¥çœ‹çŠ¶æ€ï¼šåªå¤åˆ¶prodè¿™ä¸ªåº“çš„äºŒè¿›åˆ¶æ—¥å¿—</span><br><span class="line">root@localhost:(none) &gt; show master status;</span><br><span class="line">root@localhost:prod &gt; show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | </span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| mysql-bin.000020 |      120 |              | abc              | </span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line"><span class="comment">#ä»åº“ä¸å¤åˆ¶abcè¿™ä¸ªåº“çš„äºŒè¿›åˆ¶æ—¥å¿—</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸å¤åˆ¶å¤šä¸ªåº“</span></span><br><span class="line">1ã€#é…ç½®æ–‡ä»¶å†™åº“åå­—ï¼Œæœ‰å‡ ä¸ªåº“å°±å†™å‡ è¡Œ</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">binlog-ignore-db=abc</span><br><span class="line">binlog-ignore-db=aaa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#é‡å¯</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line">3ã€#é‡å¯ä¹‹åï¼Œä»åº“çš„ä¸»ä»å¤åˆ¶éœ€è¦é‡å¯</span><br><span class="line">root@localhost:world &gt; stop slave;start slave;</span><br><span class="line"></span><br><span class="line">4ã€#ä¸»åº“æŸ¥çœ‹çŠ¶æ€ï¼šåªå¤åˆ¶prodå’Œworldè¿™2ä¸ªåº“çš„äºŒè¿›åˆ¶æ—¥å¿—</span><br><span class="line">root@localhost:(none) &gt; show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | </span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| mysql-bin.000020 |      120 |              | abc,aaa          | </span><br><span class="line">+------------------+----------+--------------+------------------+</span><br></pre></td></tr></table></figure><p><strong>æ–¹æ³•äºŒï¼šä»åº“é…ç½®(å¸¸ç”¨)</strong></p><p>ç™½åå•ï¼šåªæ‰§è¡Œç™½åå•ä¸­åˆ—å‡ºçš„åº“æˆ–è€…è¡¨çš„ä¸­ç»§æ—¥å¿—</p><ul><li>replicate-do-db=prod    (åº“é‡Œæ‰€æœ‰è¡¨éƒ½å¤åˆ¶)</li><li>replicate-do-table=prod.prod     (åº“é‡Œçš„æŸä¸€å¼ è¡¨å¤åˆ¶)</li><li>replicate-wild-do-table=prod.p*    (åº“é‡Œä»¥på¼€å¤´çš„è¡¨éƒ½å¤åˆ¶)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">binlogä¸è®°å½•æŒ‡å®šçš„åº“ï¼Œå…¶ä»–çš„éƒ½è®°å½•</span><br><span class="line"></span><br><span class="line">è¡¨é‡Œé¢SQLçº¿ç¨‹åªæ‰§è¡Œ Replicat_Do_DBæŒ‡å®šçš„åº“çš„SQLè¯­å¥</span><br><span class="line"></span><br><span class="line">1ã€#ä»åº“é…ç½®æ–‡ä»¶é…ç½®</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">replicate-do-db=prod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#ä»åº“é‡å¯</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line">3ã€#ä»åº“æŸ¥çœ‹çŠ¶æ€ï¼šåªå¤åˆ¶prodå’Œworldè¿™2ä¸ªåº“çš„äºŒè¿›åˆ¶æ—¥å¿—</span><br><span class="line">root@localhost:(none) &gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">.....</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: prod   <span class="comment">#åªå¤åˆ¶prodåº“</span></span><br></pre></td></tr></table></figure><p>é»‘åå•ï¼šä¸æ‰§è¡Œé»‘åå•ä¸­åˆ—å‡ºçš„åº“æˆ–è€…è¡¨çš„ä¸­ç»§æ—¥å¿—</p><ul><li>replicate-ignore-db=abc    (åº“é‡Œæ‰€æœ‰è¡¨ä¸å¤åˆ¶)</li><li>replicate-ignore-table=abc.abc    (åº“é‡Œçš„æŸä¸€å¼ è¡¨ä¸å¤åˆ¶)</li><li>replicate-wild-ignore-table=abc.a*      (åº“é‡Œä»¥på¼€å¤´çš„è¡¨éƒ½ä¸å¤åˆ¶)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SQLçº¿ç¨‹ä¸æ‰§è¡Œ Replicat_Ignore_DBæŒ‡å®šçš„åº“çš„SQLè¯­å¥</span><br><span class="line"></span><br><span class="line">1ã€#ä»åº“é…ç½®æ–‡ä»¶é…ç½®</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">replicate-ignore-db=abc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#ä»åº“é‡å¯</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line">3ã€#ä»åº“æŸ¥çœ‹çŠ¶æ€ï¼šåªå¤åˆ¶prodå’Œworldè¿™2ä¸ªåº“çš„äºŒè¿›åˆ¶æ—¥å¿—</span><br><span class="line">root@localhost:(none) &gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">.....</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: abc   <span class="comment">#ä¸å¤åˆ¶abcåº“</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">mysqlçš„ä¸»ä»å¤åˆ¶ã€å»¶æ—¶å¤åˆ¶ã€åŠåŒæ­¥å¤åˆ¶ã€è¿‡æ»¤å¤åˆ¶çš„æ¡ˆä¾‹</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>MySQLæ•°æ®å¤‡ä»½å’Œæ¢å¤</title>
    <link href="https://www.fomal.cc/posts/42021c83.html"/>
    <id>https://www.fomal.cc/posts/42021c83.html</id>
    <published>2024-09-21T09:44:27.000Z</published>
    <updated>2024-09-21T10:42:01.983Z</updated>
    
    <content type="html"><![CDATA[<h3 id="mysqlæ—¥å¿—ç®¡ç†">mysqlæ—¥å¿—ç®¡ç†</h3><p><strong>Mysqlæ—¥å¿—ç®¡ç†</strong></p><p><img src="../image/study_img/image-20240820084820991.png" alt="image-20240820084820991"></p><p>1ã€é”™è¯¯æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä½œç”¨ï¼šMySqlå¯åŠ¨æŠ¥é”™çš„é”™è¯¯ä¿¡æ¯ï¼Œä¸ºäº†æ’æŸ¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é»˜è®¤æ˜¯å¦å¼€å¯ï¼šå¼€å¯</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å‚¨å­˜ä½ç½®ï¼š</span></span><br><span class="line">[root@db01 ~]# ll /app/mysql-5.6.50/data/</span><br><span class="line">-rw-rw---- 1 mysql mysql   179797 Aug 20 10:31 db01.err</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; show variables like <span class="string">&#x27;%err%&#x27;</span>;</span><br><span class="line">+---------------------+--------------+</span><br><span class="line">| Variable_name       | Value        |</span><br><span class="line">+---------------------+--------------+</span><br><span class="line">| log_error           | ./db01.err   | </span><br><span class="line">+---------------------+--------------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#åå­—ï¼šhostname.err</span></span><br><span class="line">./db01.err </span><br><span class="line"></span><br><span class="line"><span class="comment">#è®¾ç½®mysqlé”™è¯¯æ—¥å¿—çš„ä½ç½®ï¼Œä½†æ˜¯éœ€è¦æå‰åˆ›å»ºè¿™ä¸ªæ—¥å¿—æ–‡ä»¶å¹¶ä¸”æˆæƒ</span></span><br><span class="line">1ã€åˆ›å»ºå‡ºé”™è¯¯æ—¥å¿—æ–‡ä»¶,å¹¶æˆæƒ</span><br><span class="line">[root@db01 ~]# <span class="built_in">touch</span> /opt/mysql_error.txt</span><br><span class="line">[root@db01 ~]# <span class="built_in">chown</span> mysql.mysql /opt/mysql_error.txt</span><br><span class="line"></span><br><span class="line">2ã€ä¿®æ”¹mysqlé…ç½®æ–‡ä»¶</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line"><span class="comment">#åœ¨[mysqld]æ ‡ç­¾éšä¾¿æ·»åŠ ä¸€è¡Œå†™å…¥ï¼š</span></span><br><span class="line">log_error=/opt/mysql_error.txt  <span class="comment">#åé¢å†™ä¸Šä½ è¦å­˜æ”¾çš„è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">3ã€é‡å¯</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld restart</span><br></pre></td></tr></table></figure><p>2ã€å¸¸è§„æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä½œç”¨ï¼šè®°å½•å¸¸è§„æ“ä½œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é»˜è®¤æ˜¯å¦å¼€å¯ï¼šå¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å‚¨å­˜ä½ç½®ï¼š</span></span><br><span class="line">root@localhost:(none) &gt; show variables like <span class="string">&#x27;%general_log%&#x27;</span>;</span><br><span class="line">+------------------+---------------------------------+</span><br><span class="line">| Variable_name    | Value                           |</span><br><span class="line">+------------------+---------------------------------+</span><br><span class="line">| general_log      | OFF                             |</span><br><span class="line">| general_log_file | /app/mysql-5.6.50/data/db01.<span class="built_in">log</span> |</span><br><span class="line">+------------------+---------------------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#åå­—ï¼šhostname.log</span></span><br><span class="line">db01.log</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹æ–¹å¼ï¼š</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">general_log=1</span><br><span class="line">general_log_file=/app/mysql/data/db01.<span class="built_in">log</span></span><br></pre></td></tr></table></figure><p>3ã€äºŒè¿›åˆ¶æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä½œç”¨ï¼šåªè®°å½•å¯¹æ•°æ®å‘ç”Ÿå˜åŒ–çš„è¯­å¥</span></span><br><span class="line">è®°å½•å·²æäº¤çš„DMLè¯­å¥ï¼Œå¹¶æ‹†åˆ†ä¸ºå¤šä¸ªäº‹ä»¶(event)æ¥è¿›è¡Œè®°å½• è®°å½•æ‰€æœ‰DDL,DML,DCL</span><br><span class="line"></span><br><span class="line"><span class="comment">#é»˜è®¤æ˜¯å¦å¼€å¯ï¼šå¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å‚¨å­˜ä½ç½®ï¼š</span></span><br><span class="line">root@localhost:(none) &gt; show variables like <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br><span class="line">+---------------------------------+----------------------------------------+</span><br><span class="line">| Variable_name                   | Value                                  |</span><br><span class="line">+---------------------------------+----------------------------------------+</span><br><span class="line">| log_bin                         | ON                                     |</span><br><span class="line">| log_bin_basename                | /app/mysql-5.6.50/data/mysql-bin       |</span><br><span class="line">| log_bin_index                   | /app/mysql-5.6.50/data/mysql-bin.index |</span><br><span class="line">| log_bin_trust_function_creators | OFF                                    |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF                                    |</span><br><span class="line">| sql_log_bin                     | ON                                     |</span><br><span class="line">+---------------------------------+----------------------------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹æ–¹æ³• MySQL5.6</span></span><br><span class="line">ä¿®æ”¹mysqlé…ç½®æ–‡ä»¶</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line"><span class="comment">#åœ¨ç©ºè¡Œéšä¾¿æ·»åŠ ä¸€ä¸ª</span></span><br><span class="line">[mysqld]</span><br><span class="line">.....</span><br><span class="line">log_bin=mysql_bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹æ–¹æ³• MySQL5.7  (éœ€è¦å’Œserver_idé…åˆä½¿ç”¨)</span></span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">.....</span><br><span class="line">server_id=1</span><br><span class="line">log-bin=mysql-bin</span><br></pre></td></tr></table></figure><p><strong>äºŒè¿›åˆ¶çš„3ç§å·¥ä½œæ¨¡å¼</strong></p><p>1ã€statement        è¯­å¥æ¨¡å¼(mysql5.6çš„é»˜è®¤æ¨¡å¼)<br>2ã€row                  è¡Œçº§æ¨¡å¼(mysql5.7çš„é»˜è®¤æ¨¡å¼)<br>3ã€mixed              æ··åˆæ¨¡å¼</p><ul><li>statement      è¯­å¥æ¨¡å¼(mysql5.6çš„é»˜è®¤æ¨¡å¼)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹å½“å‰mysql5.6é»˜è®¤æ¨¡å¼</span></span><br><span class="line">root@localhost:(none) &gt; show variables like <span class="string">&#x27;%binlog_format%&#x27;</span>;</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| Variable_name | Value     |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| binlog_format | STATEMENT |</span><br><span class="line">+---------------+-----------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å½“å‰mysql5.7é»˜è®¤æ¨¡å¼</span></span><br><span class="line">root@localhost:(none) &gt; show variables like <span class="string">&#x27;%binlog_format%&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| binlog_format | ROW   |</span><br><span class="line">+---------------+-------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¯­å¥æ¨¡å¼çš„æ¯ä¸€æ¡è¯­å¥éƒ½å¾ˆæ¸…æ™°</span></span><br><span class="line">ä¼˜ç‚¹ï¼šç®€å•æ˜“è¯»ï¼Œå ç”¨ç£ç›˜ç©ºé—´å°</span><br><span class="line">ç¼ºç‚¹ï¼šä¸æ˜“è¯»</span><br></pre></td></tr></table></figure><ul><li>row                 è¡Œçº§æ¨¡å¼(mysql5.7çš„é»˜è®¤æ¨¡å¼   ä¼ä¸šå¸¸ç”¨çš„æ¨¡å¼)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ä¼˜ç‚¹ï¼šä¸¥è°¨è®°å½•åŸæ•°æ®å’Œæ•°æ®çš„å˜åŒ–è¿‡ç¨‹ï¼Œä¸å®¹æ˜“ä¸¢æ•°æ®</span><br><span class="line">ç¼ºç‚¹ï¼šå ç”¨ç£ç›˜ç©ºé—´å¤§ï¼Œä¸æ˜“è¯»</span><br><span class="line"></span><br><span class="line"><span class="comment">#5.6å¼€å¯è¡Œçº§æ¨¡å¼</span></span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">.....</span><br><span class="line">binlog_format=row</span><br></pre></td></tr></table></figure><ul><li>mixed              æ··åˆæ¨¡å¼(ä¸Šé¢2ç§æ¨¡å¼çš„æ··åˆ     ä¸å¸¸ç”¨)</li></ul><p><strong>äºŒè¿›åˆ¶æ—¥å¿—çš„æŸ¥çœ‹æ–¹å¼</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#äºŒè¿›åˆ¶æ—¥å¿—æŸ¥çœ‹æ–¹å¼</span></span><br><span class="line">[root@db01 ~]# mysqlbinlog /app/mysql-5.6.50/data/mysql-bin.000010 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db04 ~]# mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.7.44/data/mysql-bin.000001 </span><br><span class="line"><span class="built_in">base64</span>åŠ å¯†ç®—å‘½å»ç»™ä»–è§£ç </span><br><span class="line">decode-rows:è½¬ç </span><br><span class="line">incode  ç¼–ç </span><br><span class="line"></span><br><span class="line"><span class="comment">#åªçœ‹å’ŒæŸä¸ªbinlogåº“ç›¸å…³çš„æ•°æ®   -d+åº“å</span></span><br><span class="line">[root@db04 ~]# mysqlbinlog --base64-output=decode-rows -vvv -d binlog /app/mysql-5.7.44/data/mysql-bin.000001 </span><br><span class="line"></span><br><span class="line">mysql5.6:ä¸€èˆ¬æ–°æ•°æ®åº“at 120ä½ç½®ç‚¹ä¹‹åå°±æ˜¯å†™å…¥çš„æ•°æ®</span><br><span class="line">mysql5.7:ä¸€èˆ¬æ–°æ•°æ®åº“at 154ä½ç½®ç‚¹ä¹‹åå°±æ˜¯å†™å…¥çš„æ•°æ®</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#mysqlbinlogç”¨çš„ä»€ä¹ˆå·¥ä½œæ¨¡å¼ï¼Œæ€ä¹ˆè§£ææ•°æ®çš„ï¼Ÿ  é¢è¯•é—®é¢˜</span></span><br><span class="line">è¡Œçº§æ¨¡å¼</span><br><span class="line">mysqlbinlog --base64-output=decode-rows -vvv    å°±å¯ä»¥è§£æå‡ºæ¥</span><br></pre></td></tr></table></figure><p><strong>äºŒè¿›åˆ¶æ—¥å¿—çš„æ“ä½œ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¼€å¯æ–¹å¼ </span></span><br><span class="line"><span class="comment">#æ³¨æ„:åœ¨mysql5.7ä¸­å¼€å¯binlogå¿…é¡»è¦åŠ ä¸Šserver-idã€‚</span></span><br><span class="line">[root@db01 data]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">.....</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">server_id=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å½“å‰æœ‰å“ªäº›binlog  ä»¥åŠbinlogçš„å¤§å°</span></span><br><span class="line">ç‰©ç†æ–¹æ³•</span><br><span class="line">[root@db04 ~]# ll /app/mysql-5.7.44/data/</span><br><span class="line">-rw-r----- 1 mysql mysql      688 Aug 20 14:26 mysql-bin.000001</span><br><span class="line"></span><br><span class="line">mysqlå‘½ä»¤è¡ŒæŸ¥çœ‹</span><br><span class="line">root@localhost:(none) &gt; show binary logs;</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å½“å‰æœ€æ–°çš„binlogå’Œä½ç½®ç‚¹</span></span><br><span class="line">root@localhost:(none) &gt; show master status;</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æŒ‡å®šbinlogä¸­çš„æ‰€æœ‰äº‹ä»¶ï¼Œä¸é€‚åˆçœ‹è¡Œçº§æ¨¡å¼</span></span><br><span class="line">root@localhost:(none) &gt; show binlog events <span class="keyword">in</span>  <span class="string">&#x27;mysql-bin.000012&#x27;</span>;</span><br></pre></td></tr></table></figure><p>äº‹ä»¶ä»‹ç»<br>1ï¼‰åœ¨binlogä¸­æœ€å°çš„è®°å½•å•å…ƒä¸ºevent<br>2ï¼‰ä¸€ä¸ªäº‹åŠ¡ä¼šè¢«æ‹†åˆ†æˆå¤šä¸ªäº‹ä»¶ï¼ˆeventï¼‰</p><p><strong>äº‹ä»¶çš„ç‰¹æ€§(binlogçš„ç‰¹æ€§)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1ï¼‰æ¯ä¸ªeventéƒ½æœ‰ä¸€ä¸ªå¼€å§‹ä½ç½®ï¼ˆstart positionï¼‰å’Œç»“æŸä½ç½®ï¼ˆstop positionï¼‰ã€‚</span><br><span class="line">2ï¼‰æ‰€è°“çš„ä½ç½®å°±æ˜¯eventå¯¹æ•´ä¸ªäºŒè¿›åˆ¶çš„æ–‡ä»¶çš„ç›¸å¯¹ä½ç½®ï¼ˆæ–‡ä»¶å¤§å°ï¼‰</span><br><span class="line">3ï¼‰å¯¹äºä¸€ä¸ªäºŒè¿›åˆ¶æ—¥å¿—ä¸­ï¼Œå‰120ä¸ªpositionæ˜¯æ–‡ä»¶æ ¼å¼ä¿¡æ¯é¢„ç•™ç©ºé—´ï¼ˆMySQL5.6ï¼‰ã€‚</span><br><span class="line">   å¯¹äºä¸€ä¸ªäºŒè¿›åˆ¶æ—¥å¿—ä¸­ï¼Œå‰154ä¸ªpositionæ˜¯æ–‡ä»¶æ ¼å¼ä¿¡æ¯é¢„ç•™ç©ºé—´ï¼ˆMySQL5.7ï¼‰</span><br><span class="line">4ï¼‰MySQLç¬¬ä¸€ä¸ªè®°å½•çš„äº‹ä»¶ï¼Œéƒ½æ˜¯ä»120å¼€å§‹çš„</span><br></pre></td></tr></table></figure><p><strong>åˆ©ç”¨äºŒè¿›åˆ¶æ—¥å¿—æ¢å¤æ•°æ®    ï¼ˆMySQL 5.6ï¼‰</strong></p><p>1ã€æ¨¡æ‹Ÿæ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">1ã€#åˆ·æ–°çš„binlog,å¹¶ä¸”ä»120å¼€å§‹</span><br><span class="line">root@localhost:(none) &gt; flush logs;</span><br><span class="line">root@localhost:(none) &gt; show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000012 |      120 |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line"></span><br><span class="line">2ã€#åˆ›å»ºbinlogåº“ è¡¨ </span><br><span class="line">root@localhost:(none) &gt; create database binlog;</span><br><span class="line">root@localhost:(none) &gt; use binlog;</span><br><span class="line">root@localhost:binlog &gt; create table binlog_table(<span class="built_in">id</span> int);</span><br><span class="line"></span><br><span class="line">3ã€#æ’å…¥æ•°æ®</span><br><span class="line">root@localhost:binlog &gt; insert into binlog_table values(1);</span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from binlog_table;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">4ã€#å†æ’å…¥æ•°æ®</span><br><span class="line">root@localhost:binlog &gt; insert into binlog_table values(2);</span><br><span class="line">root@localhost:binlog &gt; insert into binlog_table values(3);</span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from binlog_table;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">5ã€#åˆ é™¤ä¸€æ¡æ•°æ®</span><br><span class="line">root@localhost:binlog &gt; delete from binlog_table <span class="built_in">where</span> <span class="built_in">id</span>=1;</span><br><span class="line">root@localhost:binlog:18: &gt;<span class="keyword">select</span> * from binlog_table;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">| 2    |</span><br><span class="line">| 3    |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">6ã€#ä¿®æ”¹ä¸€æ¡æ•°æ®</span><br><span class="line">root@localhost:binlog &gt; update binlog_table <span class="built_in">set</span> <span class="built_in">id</span>=22 <span class="built_in">where</span> <span class="built_in">id</span>=2;</span><br><span class="line">root@localhost:binlog &gt; <span class="keyword">select</span> * from binlog_table;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|   22 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">7ã€#åˆ è¡¨</span><br><span class="line">root@localhost:binlog &gt; drop table binlog_table;</span><br><span class="line"></span><br><span class="line">8ã€#åˆ åº“</span><br><span class="line">root@localhost:binlog &gt; drop database binlog;</span><br></pre></td></tr></table></figure><p>2ã€ä½¿ç”¨bin log æ¢å¤æ•°æ®åˆ°deleteä¹‹å‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">æ¢å¤åˆ°ï¼š </span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from binlog_table;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">ä½ è¦çŸ¥é“ä½ åœ¨è¿™ä¸ªçŠ¶æ€ä¹‹åæ‰§è¡Œäº†ä»€ä¹ˆï¼šæ‰§è¡Œäº†delete</span><br><span class="line"></span><br><span class="line">1ã€#å‡†å¤‡ä¸€ä¸ªæ–°ç¯å¢ƒ db02</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line">[root@db02 ~]# <span class="built_in">rm</span> -rf /app/mysql-5.6.50/data</span><br><span class="line">é…ç½®æ–‡ä»¶å’Œæ—§ç¯å¢ƒå¤§éƒ¨åˆ†ä¿æŒä¸€è‡´</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/app/mysql-5.6.50</span><br><span class="line">datadir=/app/mysql-5.6.50/data</span><br><span class="line">log_bin=mysql-bin</span><br><span class="line">server_id=1</span><br><span class="line">lower_case_table=1</span><br><span class="line"><span class="comment">#innodb_data_file_path=ibdata1:12M;ibdata2:50M:autoextend</span></span><br><span class="line">binlog_format=row</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">prompt=<span class="string">&quot;\\u@\\h:\\d &gt; &quot;</span></span><br><span class="line">[root@db02 ~]# /app/mysql-5.6.50/scripts/mysql_install_db --user=mysql --basedir=/app/mysql-5.6.50 --datadir=/app/mysql-5.6.50/data</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line">2ã€#æŠŠæ—§ç¯å¢ƒçš„æ•°æ®åº“è¿›è¡Œå…¨å¤‡</span><br><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -A &gt; /tmp/full.sql</span><br><span class="line"></span><br><span class="line">3ã€#æ–°ç¯å¢ƒdb02åˆ›å»ºä¸€ä¸ªå¯ä»¥è¿œç¨‹è¿æ¥çš„ç”¨æˆ·(å¦‚æœæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œå¯ä»¥åˆ›å»ºç”¨æˆ·è¿œç¨‹æ¢å¤)</span><br><span class="line">root@localhost:(none) &gt; grant all on *.* to root@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> user,host from mysql.user;</span><br><span class="line">+------+-----------+</span><br><span class="line">| user | host      |</span><br><span class="line">+------+-----------+</span><br><span class="line">| root | %         |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€#db01å°†å…¨å¤‡æ¢å¤åˆ°æ–°ç¯å¢ƒ</span><br><span class="line">[root@db01 ~]# mysql -uroot -p123 -h172.16.1.52 &lt; /tmp/full.sql </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€#æ—§ç¯å¢ƒæˆªå–binlog</span><br><span class="line">å› ä¸ºä¸€å¼€å§‹åˆ·æ–°çš„binlog,æ‰€ä»¥èµ·å§‹ä½ç½®ç‚¹ä»120å¼€å§‹ mysql-bin.000012</span><br><span class="line">èµ·å§‹ä½ç½®ç‚¹ï¼š120</span><br><span class="line">ç»“æŸä½ç½®ç‚¹: <span class="built_in">id</span>ä¸º1 2 3 ä¹‹åï¼Œæ‰§è¡Œäº†delete   </span><br><span class="line">[root@db01 ~]# mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/mysql-bin.000012 | grep -iC 10 delete</span><br><span class="line"><span class="comment"># at 937</span></span><br><span class="line"><span class="comment">#240820 11:18:12 server id 1  end_log_pos 1011 CRC32 0x9073f227         Query   thread_id=2     exec_time=0     error_code=0</span></span><br><span class="line">SET TIMESTAMP=1724123892/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line">......</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line"></span><br><span class="line">æŸ¥åˆ°ç»“æŸä½ç½®ç‚¹å°±æ˜¯ï¼š937 (ä¸Šä¸‹10è¡Œ begin å‰é¢çš„at 937)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æˆªå–</span></span><br><span class="line">[root@db01 ~]# mysqlbinlog --start-position=120 --stop-position=937 /app/mysql-5.6.50/data/mysql-bin.000012 &gt; /tmp/binlog.sql</span><br><span class="line"></span><br><span class="line">6ã€#æ¢å¤æˆªå–çš„æ•°æ®åˆ°æ–°ç¯å¢ƒ</span><br><span class="line">[root@db01 ~]# mysql -uroot -p123 -h172.16.1.52 &lt; /tmp/binlog.sql </span><br><span class="line"></span><br><span class="line">7ã€#db02æ–°ç¯å¢ƒæŸ¥çœ‹æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> * from binlog.binlog_table;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">8ã€#å…¨å¤‡å®Œäº†ï¼Œç”¨æˆ·å¦‚æœè¿˜åœ¨å¾€æ—§æ•°æ®åº“å†™æ•°æ®ï¼Œéœ€è¦æ¢å¤</span><br><span class="line"></span><br><span class="line">9ã€#åº”ç”¨å‰²æ¥</span><br><span class="line">      - å¼€å‘æ”¹ä»£ç </span><br><span class="line">      - è¿ç»´å¯¼å‡ºæ–°ç¯å¢ƒçš„æ•°æ®åˆ°æ—§ç¯å¢ƒ</span><br></pre></td></tr></table></figure><p><strong>å­˜åœ¨é—®é¢˜</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç”Ÿäº§ä¸­ä¸ä¼šåˆ·æ–°binlog</span><br><span class="line"></span><br><span class="line">2ã€ç”Ÿäº§ä¸­è‚¯å®šä¼šä¸€ç›´æä¾›æœåŠ¡ï¼Œå®æ—¶éƒ½åœ¨å†™å…¥æ•°æ®</span><br><span class="line"></span><br><span class="line">3ã€ç”Ÿäº§ä¸­æˆªå–æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šæˆªå–åˆ°å…¶ä»–åº“çš„æ•°æ®</span><br><span class="line">åŠ ä¸Š-d  åªæˆªå–å’Œbinlogç›¸å…³çš„åº“</span><br><span class="line">[root@db01 data]# mysqlbinlog --base64-output=decode-rows -vvv -d binlog</span><br><span class="line">/app/mysql/data/mysql-bin.000030</span><br><span class="line"></span><br><span class="line">120~937ä½ç½®ç‚¹ä¸­åŒ…å«binlogåº“çš„æ•°æ®</span><br><span class="line">[root@db01 data]# mysqlbinlog --start-position=120 --stop-position=937 -d binlog /app/mysql/data/mysql-bin.000030 &gt; /tmp/binlog.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰€ä»¥ä¸èƒ½å•ç‹¬ä½¿ç”¨binlogæˆªå–æ•°æ®ï¼Œå¯ä»¥æ¯å¤©å‡Œæ™¨ä¸€ç‚¹åœ¨å®šæ—¶ä»»åŠ¡é‡Œé¢åšä¸€æ¬¡å…¨å¤‡</span></span><br><span class="line"><span class="comment">#binlogåªèƒ½ç”¨æ¥å½“æˆæ˜¯å¢é‡æ•°æ®çš„å¤‡ä»½ï¼Œä¸€å®šè¦é…åˆmysqldumé€»è¾‘å¤‡ä»½çš„å…¨å¤‡ä¸€èµ·ä½¿ç”¨ï¼Œå•ç‹¬ä½¿ç”¨éå¸¸ç´¯</span></span><br></pre></td></tr></table></figure><p><strong>binlogçš„åˆ·æ–°å’Œåˆ é™¤</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#binlogåˆ·æ–°</span></span><br><span class="line">1ã€é‡å¯mysqlæ•°æ®åº“</span><br><span class="line">2ã€æ‰§è¡Œflush logs;</span><br><span class="line">3ã€mysqladmin -uroot -p123 flush-log</span><br><span class="line">4ã€å½“binlogå¤§å°åˆ°è¾¾1G,ä¼šè‡ªåŠ¨åˆ·æ–°</span><br><span class="line"></span><br><span class="line"><span class="comment">#binlogè¦å®šæœŸæ¸…ç†å’Œåˆ é™¤</span></span><br><span class="line">1ã€æ ¹æ®æ—¶é—´åˆ é™¤</span><br><span class="line"><span class="comment">#ä¸´æ—¶ç”Ÿæ•ˆ</span></span><br><span class="line">root@localhost:(none) &gt; SET GLOBAL expire_logs_days = 7;</span><br><span class="line"><span class="comment">#æ°¸ä¹…ç”Ÿæ•ˆ</span></span><br><span class="line">[root@db01 data]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">expire_logs_days = 7</span><br><span class="line"></span><br><span class="line">2ã€æ ¹æ®æ—¶é—´åˆ é™¤</span><br><span class="line">root@localhost:(none) &gt; PURGE BINARY LOGS BEFORE now() - INTERVAL 3 day;</span><br><span class="line"></span><br><span class="line">3ã€æ ¹æ®æ–‡ä»¶ååˆ é™¤(å¸¸ç”¨)</span><br><span class="line">root@localhost:(none) &gt; PURGE BINARY LOGS TO <span class="string">&#x27;mysql-bin.000020&#x27;</span>;</span><br><span class="line">20  ä¼šæŠŠ20ä¹‹å‰çš„å…¨éƒ¨åˆ é™¤</span><br></pre></td></tr></table></figure><p>4ã€æ…¢æŸ¥è¯¢æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">åªè¦ä¼šå¼€å¯ä»–å°±è¡Œäº† ä»–æ˜¯è®°å½•æ‰§è¡Œæ¯”è¾ƒæ…¢çš„SQLè¯­å¥</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½œç”¨ï¼šè®°å½•æ‰§è¡Œçš„æ¯”è¾ƒæ…¢çš„SQLè¯­å¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤æ˜¯å¦å¼€å¯ï¼šå¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­˜å‚¨ä½ç½®ï¼š/app/mysql/data/</span></span><br><span class="line">root@localhost:(none) &gt; show variables like <span class="string">&#x27;%slow%&#x27;</span>;</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| Variable_name             | Value                                |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| log_slow_admin_statements | OFF                                  |</span><br><span class="line">| log_slow_slave_statements | OFF                                  |</span><br><span class="line">| slow_launch_time          | 2                                    |</span><br><span class="line">| slow_query_log            | OFF                                  |</span><br><span class="line">| slow_query_log_file       | /app/mysql-5.6.50/data/db01-slow.log |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># åå­—ï¼šhostname-slow.log</span></span><br><span class="line">db01-slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹æ–¹å¼</span></span><br><span class="line"><span class="comment">## ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">#æŒ‡å®šæ˜¯å¦å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—</span></span><br><span class="line">slow_query_log=1</span><br><span class="line"><span class="comment">#æŒ‡å®šæ…¢æ—¥å¿—æ–‡ä»¶å­˜æ”¾ä½ç½®ï¼ˆé»˜è®¤åœ¨dataï¼‰</span></span><br><span class="line">slow_query_log_file=/app/mysql-5.6.50/data/db01-slow.log</span><br><span class="line"><span class="comment">#è®¾å®šæ…¢æŸ¥è¯¢çš„é˜€å€¼(é»˜è®¤10s)</span></span><br><span class="line">long_query_time=0.05</span><br><span class="line"><span class="comment">#ä¸ä½¿ç”¨ç´¢å¼•çš„æ…¢æŸ¥è¯¢è¯­å¥æ˜¯å¦è®°å½•åˆ°æ—¥å¿—</span></span><br><span class="line">log_queries_not_using_indexes</span><br><span class="line"><span class="comment">#æŸ¥è¯¢æ£€æŸ¥è¿”å›å°‘äºè¯¥å‚æ•°æŒ‡å®šè¡Œçš„SQLä¸è¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—  ï¼ˆé¸¡è‚‹ï¼‰</span></span><br><span class="line">min_examined_row_limit=100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## æ¨¡æ‹Ÿæ…¢æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">#è¿›å…¥worldåº“</span></span><br><span class="line">mysql&gt; use world</span><br><span class="line"><span class="comment">#æŸ¥çœ‹è¡¨</span></span><br><span class="line">mysql&gt; show tables</span><br><span class="line"><span class="comment">#å°†cityè¡¨ä¸­æ‰€æœ‰å†…å®¹åŠ åˆ°t1è¡¨ä¸­</span></span><br><span class="line">mysql&gt; create table t1 <span class="keyword">select</span> * from city;</span><br><span class="line"><span class="comment">#æŸ¥çœ‹t1çš„è¡¨ç»“æ„</span></span><br><span class="line">mysql&gt; desc t1;</span><br><span class="line"><span class="comment">#å°†t1è¡¨æ‰€æœ‰å†…å®¹æ’å…¥åˆ°t1è¡¨ä¸­ï¼ˆå¤šæ’å…¥å‡ æ¬¡ï¼‰</span></span><br><span class="line">mysql&gt; insert into t1 <span class="keyword">select</span> * from t1;</span><br><span class="line">mysql&gt; insert into t1 <span class="keyword">select</span> * from t1;</span><br><span class="line">mysql&gt; insert into t1 <span class="keyword">select</span> * from t1;</span><br><span class="line">mysql&gt; insert into t1 <span class="keyword">select</span> * from t1;</span><br><span class="line"><span class="comment">#åˆ é™¤t1è¡¨ä¸­id&gt;2000çš„æ•°æ®</span></span><br><span class="line">mysql&gt; delete from t1 <span class="built_in">where</span> <span class="built_in">id</span>&gt;2000;</span><br><span class="line"><span class="comment">#æŸ¥çœ‹æ…¢æ—¥å¿—</span></span><br><span class="line">[root@db01 ~]# <span class="built_in">cat</span> /application/mysql/data/mysql-db01</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db01 ~]# mysqldumpslow /app/mysql-5.6.50/data/db01-slow.log</span><br><span class="line">-sï¼šæŒ‡å®šæ’åºé¡ºåº</span><br><span class="line">      cï¼šCount æ‰§è¡Œæ¬¡æ•°</span><br><span class="line">      tï¼šTime æ‰§è¡Œæ—¶é—´ æ€»æ—¶é—´</span><br><span class="line">      rï¼šRows ç»“æœè¡Œæ•° æ€»è¡Œæ•°</span><br><span class="line">      lï¼šLock é”è¡¨æ—¶é—´ æ€»é”è¡¨æ—¶é—´</span><br><span class="line">      </span><br><span class="line">      atï¼šå¹³å‡æ—¶é—´</span><br><span class="line">      arï¼šå¹³å‡è¡Œæ•°</span><br><span class="line">      alï¼šå¹³å‡é”è¡¨æ—¶é—´</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨perconaå…¬å¸æä¾›çš„pt-query-digestå·¥å…·åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">https://www.percona.com/  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€ä¸‹è½½å¹¶å®‰è£…</span><br><span class="line">[root@db01 ~]# yum install -y https://downloads.percona.com/downloads/percona-toolkit/3.6.0/binary/redhat/7/x86_64/percona-toolkit-3.6.0-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">2ã€è¿™æ¡å‘½ä»¤å°±å¯ä»¥åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—</span><br><span class="line">[root@db01 ~]# pt-query-digest /app/mysql-5.6.50/data/db01-slow.log </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¯è§†åŒ–ç•Œé¢ï¼š</span><br><span class="line">AnemometeråŸºäºpt-query-digestå°†MySQLæ…¢æŸ¥è¯¢å¯è§†åŒ–</span><br><span class="line">httpss://www.percona.com/downloads/percona-toolkit/LATEST/ æ…¢æ—¥å¿—åˆ†æå·¥å…·ä¸‹è½½</span><br><span class="line">httpss://github.com/box/Anemometer å¯è§†åŒ–ä»£ç ä¸‹è½½</span><br></pre></td></tr></table></figure><p><strong>åœ¨æ¢å¤æ•°æ®æ—¶ï¼Œæ•°æ®åº“åœ¨å®æ—¶å†™å…¥æ•°æ®ï¼Œæ€ä¹ˆæ¢å¤</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¾€æ•°æ®åº“ä¸€ç›´å†™æ•°æ®çš„è„šæœ¬</span></span><br><span class="line">[root@db01 ~]# vim insert.sh </span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">master_ip=$(hostname -I|awk  <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">mysql_cli=<span class="string">&quot;mysql -uroot -p123 -h<span class="variable">$&#123;master_ip&#125;</span>&quot;</span></span><br><span class="line"><span class="variable">$&#123;mysql_cli&#125;</span> -e <span class="string">&#x27;drop database if exists prod;&#x27;</span></span><br><span class="line"><span class="variable">$&#123;mysql_cli&#125;</span> -e <span class="string">&#x27;create database if not exists prod;&#x27;</span></span><br><span class="line"><span class="variable">$&#123;mysql_cli&#125;</span> -e <span class="string">&#x27;create table if not exists prod.prod(id int primary key auto_increment);&#x27;</span></span><br><span class="line">num=1</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line"> <span class="variable">$&#123;mysql_cli&#125;</span> -e <span class="string">&quot;insert into prod.prod values(<span class="subst">$((num++)</span>));commit;&quot;</span></span><br><span class="line"> <span class="built_in">sleep</span> 1</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>1ã€æ¨¡æ‹Ÿå†™æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">1ã€#è¿è¡Œè„šæœ¬</span><br><span class="line">[root@db01 ~]# sh insert.sh</span><br><span class="line"></span><br><span class="line">2ã€#åˆ›å»ºbinlogåº“ è¡¨ </span><br><span class="line">root@localhost:(none) &gt; create database binlog;</span><br><span class="line">root@localhost:(none) &gt; use binlog;</span><br><span class="line">root@localhost:binlog &gt; create table binlog_table(<span class="built_in">id</span> int);</span><br><span class="line"></span><br><span class="line">3ã€#æ’å…¥æ•°æ®</span><br><span class="line">root@localhost:binlog &gt; insert into binlog_table values(1);</span><br><span class="line"></span><br><span class="line">4ã€#å†æ’å…¥æ•°æ®</span><br><span class="line">root@localhost:binlog &gt; insert into binlog_table values(2);</span><br><span class="line">root@localhost:binlog &gt; insert into binlog_table values(3);</span><br><span class="line"></span><br><span class="line">5ã€#åˆ é™¤ä¸€æ¡æ•°æ®</span><br><span class="line">root@localhost:binlog &gt; delete from binlog_table <span class="built_in">where</span> <span class="built_in">id</span>=1;</span><br><span class="line"></span><br><span class="line">6ã€#ä¿®æ”¹ä¸€æ¡æ•°æ®</span><br><span class="line">root@localhost:binlog &gt; update binlog_table <span class="built_in">set</span> <span class="built_in">id</span>=22 <span class="built_in">where</span> <span class="built_in">id</span>=2;</span><br><span class="line"></span><br><span class="line">7ã€#åˆ è¡¨</span><br><span class="line">root@localhost:binlog &gt; drop table binlog_table;</span><br><span class="line"></span><br><span class="line">8ã€#åˆ åº“</span><br><span class="line">root@localhost:binlog &gt; drop database binlog;</span><br></pre></td></tr></table></figure><p>2ã€æ¢å¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">æ¢å¤åˆ°ï¼š </span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from binlog_table;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">ä½ è¦çŸ¥é“ä½ åœ¨è¿™ä¸ªçŠ¶æ€ä¹‹åæ‰§è¡Œäº†ä»€ä¹ˆï¼šæ‰§è¡Œäº†delete</span><br><span class="line">å¦‚æœæ—§ç¯å¢ƒè¿˜èƒ½æä¾›æœåŠ¡å°±æš‚æ—¶ä¸åœæ­¢åº“ï¼Œä¸€ä¼šå†åœæ­¢</span><br><span class="line"></span><br><span class="line">1ã€#å‡†å¤‡ä¸€ä¸ªæ–°ç¯å¢ƒ db02</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line">[root@db02 ~]# <span class="built_in">rm</span> -rf /app/mysql-5.6.50/data</span><br><span class="line">é…ç½®æ–‡ä»¶å’Œæ—§ç¯å¢ƒå¤§éƒ¨åˆ†ä¿æŒä¸€è‡´</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/app/mysql-5.6.50</span><br><span class="line">datadir=/app/mysql-5.6.50/data</span><br><span class="line">log_bin=mysql-bin</span><br><span class="line">server_id=1</span><br><span class="line">lower_case_table=1</span><br><span class="line"><span class="comment">#innodb_data_file_path=ibdata1:12M;ibdata2:50M:autoextend</span></span><br><span class="line">binlog_format=row</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">prompt=<span class="string">&quot;\\u@\\h:\\d &gt; &quot;</span></span><br><span class="line">[root@db02 ~]# /app/mysql-5.6.50/scripts/mysql_install_db --user=mysql --basedir=/app/mysql-5.6.50 --datadir=/app/mysql-5.6.50/data</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#æ—§ç¯å¢ƒæˆªå–binlogæ•°æ®çš„ä½ç½®ç‚¹</span><br><span class="line">[root@db01 ~]# mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/mysql-bin.000015|grep -iC 10  <span class="string">&#x27;create database binlog&#x27;</span></span><br><span class="line">å¼€å§‹ä½ç½®ï¼š11999</span><br><span class="line">[root@db01 ~]#  mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/mysql-bin.000015|grep -iC 10 <span class="string">&#x27;delete from `binlog`&#x27;</span></span><br><span class="line">ç»“æŸä½ç½®ç‚¹ï¼š30114</span><br><span class="line"></span><br><span class="line">åªæ¢å¤binlogåº“æ•°æ®çš„æˆªå–</span><br><span class="line">[root@db01 ~]# mysqlbinlog --start-position=11999 --stop-position=30114 -d binlog /app/mysql-5.6.50/data/mysql-bin.000015 &gt; /tmp/binlog.sql </span><br><span class="line"></span><br><span class="line">3ã€#æ–°ç¯å¢ƒdb02åˆ›å»ºä¸€ä¸ªå¯ä»¥è¿œç¨‹è¿æ¥çš„ç”¨æˆ·(å¦‚æœæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œå¯ä»¥åˆ›å»ºç”¨æˆ·è¿œç¨‹æ¢å¤)</span><br><span class="line">root@localhost:(none) &gt; grant all on *.* to root@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line">4ã€#db01å°†æˆªå–çš„æ•°æ®æ¢å¤åˆ°æ–°ç¯å¢ƒ</span><br><span class="line">[root@db01 ~]# mysql -uroot -p123 -h172.16.1.52 &lt; /tmp/binlog.sql </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€#æ–°ç¯å¢ƒæŸ¥çœ‹æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; show databases;</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> * from binlog.binlog_table;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">6ã€#åº”ç”¨å‰²æ¥   è¿ç»´å¯¼å‡ºæ–°ç¯å¢ƒbinlogçš„æ•°æ®åˆ°æ—§ç¯å¢ƒ</span><br><span class="line">[root@db02 ~]# mysqldump -B binlog &gt; /tmp/binlog2.sql</span><br><span class="line">[root@db02 ~]# scp /tmp/binlog2.sql 172.16.1.51:/tmp</span><br><span class="line"></span><br><span class="line">7ã€#æŒ‚ç»´æŠ¤é¡µï¼Œåœæ­¢è¿æ¥æ•°æ®åº“çš„ç¨‹åºtomcat phpï¼Œä¸èƒ½åœæ­¢æ•°æ®åº“ï¼Œå› ä¸ºå¯¼å…¥æ•°æ®éœ€è¦ä½¿ç”¨mysqlå®¢æˆ·ç«¯çš„å‘½ä»¤</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">8ã€#æ–°ç¯å¢ƒå…³é—­binlogçš„è®°å½•ï¼Œé˜²æ­¢binlogè¢«æ±¡æŸ“,å†æ¢å¤æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> sql_log_bin=0;</span><br><span class="line">root@localhost:binlog &gt; <span class="built_in">source</span> /tmp/binlog2.sql;</span><br><span class="line"></span><br><span class="line">9ã€#å¼€å¯binlogçš„è®°å½•</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> sql_log_bin=1;</span><br><span class="line">root@localhost:binlog &gt; <span class="keyword">select</span> * from binlog_table;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">10ã€#å–æ¶ˆç»´æŠ¤é¡µï¼Œå¼€å¯è¿æ¥æ•°æ®åº“çš„æœåŠ¡</span><br></pre></td></tr></table></figure><h3 id="MySQLæ•°æ®å¤‡ä»½å’Œæ¢å¤">MySQLæ•°æ®å¤‡ä»½å’Œæ¢å¤</h3><p><strong>å¤‡ä»½çš„åŸå› </strong><br>è¿ç»´å·¥ä½œçš„æ ¸å¿ƒç®€å•æ¦‚æ‹¬å°±ä¸¤ä»¶äº‹:<br>1ï¼‰ç¬¬ä¸€ä¸ªæ˜¯ä¿æŠ¤å…¬å¸çš„æ•°æ®.<br>2ï¼‰ç¬¬äºŒä¸ªæ˜¯è®©ç½‘ç«™èƒ½7*24å°æ—¶æä¾›æœåŠ¡(ç”¨æˆ·ä½“éªŒ)ã€‚</p><p><strong>å¤‡ä»½çš„ç±»å‹</strong><br>å†·å¤‡ä»½(åœæœåŠ¡åšå¤‡ä»½)ï¼š(mysqldumpåšä¸äº†)<br>è¿™äº›å¤‡ä»½åœ¨ç”¨æˆ·ä¸èƒ½è®¿é—®æ•°æ®æ—¶è¿›è¡Œï¼Œå› æ­¤æ— æ³•è¯»å–æˆ–ä¿®æ”¹æ•°æ®ã€‚è¿™äº›è„±æœºå¤‡ä»½ä¼šé˜»æ­¢æ‰§è¡Œä»»ä½•ä½¿ç”¨æ•°æ®çš„æ´»åŠ¨ã€‚è¿™äº›ç±»å‹çš„å¤‡ä»½ä¸ä¼šå¹²æ‰°æ­£å¸¸è¿è¡Œçš„ç³»ç»Ÿçš„æ€§èƒ½ã€‚ä½†æ˜¯ï¼Œå¯¹äºæŸäº›åº”ç”¨ç¨‹åºï¼Œä¼šæ— æ³•æ¥å—å¿…é¡»åœ¨ä¸€æ®µè¾ƒé•¿çš„æ—¶é—´é‡Œé”å®šæˆ–å®Œå…¨é˜»æ­¢ç”¨æˆ·è®¿é—®æ•°æ®ã€‚</p><p>æ¸©å¤‡ä»½(ä¸åœæœåŠ¡åšå¤‡ä»½ï¼Œä½†æ˜¯å¤‡ä»½è¿‡ç¨‹ä¸­ä¼šé”è¡¨)ï¼š<br>è¿™äº›å¤‡ä»½åœ¨è¯»å–æ•°æ®æ—¶è¿›è¡Œï¼Œä½†åœ¨å¤šæ•°æƒ…å†µä¸‹ï¼Œåœ¨è¿›è¡Œå¤‡ä»½æ—¶ä¸èƒ½ä¿®æ”¹æ•°æ®æœ¬èº«ã€‚è¿™ç§ä¸­é€”å¤‡ä»½ç±»å‹çš„ä¼˜ç‚¹æ˜¯ä¸å¿…å®Œå…¨é”å®šæœ€ç»ˆç”¨æˆ·ã€‚ä½†æ˜¯ï¼Œå…¶ä¸è¶³ä¹‹å¤„åœ¨äºæ— æ³•åœ¨è¿›è¡Œå¤‡ä»½æ—¶ä¿®æ”¹æ•°æ®é›†ï¼Œè¿™å¯èƒ½ä½¿è¿™ç§ç±»å‹çš„å¤‡ä»½ä¸é€‚ç”¨äºæŸäº›åº”ç”¨ç¨‹åºã€‚åœ¨å¤‡ä»½è¿‡ç¨‹ä¸­æ— æ³•ä¿®æ”¹æ•°æ®å¯èƒ½äº§ç”Ÿæ€§èƒ½é—®é¢˜ã€‚</p><p>çƒ­å¤‡ä»½(ä¸åœæœåŠ¡åšå¤‡ä»½ï¼Œä¹Ÿä¸é”è¡¨)ï¼š<br>è¿™äº›åŠ¨æ€å¤‡ä»½åœ¨è¯»å–æˆ–ä¿®æ”¹æ•°æ®çš„è¿‡ç¨‹ä¸­è¿›è¡Œï¼Œå¾ˆå°‘ä¸­æ–­æˆ–è€…ä¸ä¸­æ–­ä¼ è¾“æˆ–å¤„ç†æ•°æ®çš„åŠŸèƒ½ã€‚ä½¿ç”¨çƒ­å¤‡ä»½æ—¶ï¼Œç³»ç»Ÿä»å¯ä¾›è¯»å–å’Œä¿®æ”¹æ•°æ®çš„æ“ä½œè®¿é—®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ¢å¤æ•°æ®çš„æ—¶å€™ä¸€å®šè¦è·Ÿå¼€å‘ç¡®è®¤å¥½</span><br><span class="line"></span><br><span class="line">é€»è¾‘å¤‡ä»½ ç‰©ç†å¤‡ä»½å¯ä»¥ä¸€èµ·ç”¨ï¼Œå“ªç§é€Ÿåº¦å¿«ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨</span><br></pre></td></tr></table></figure><p><strong>å¤‡ä»½çš„å·¥å…·</strong></p><p>1ã€mysqldump (é€»è¾‘)<br>mysqlåŸç”Ÿè‡ªå¸¦å¾ˆå¥½ç”¨çš„é€»è¾‘å¤‡ä»½å·¥å…·</p><p>2ã€mysqlbinlog (é€»è¾‘)<br>å®ç°binlogå¤‡ä»½çš„åŸç”Ÿæ€å‘½ä»¤</p><p>3ã€xtrabackup (ç‰©ç†)<br>preconaå…¬å¸å¼€å‘çš„æ€§èƒ½å¾ˆé«˜çš„ç‰©ç†å¤‡ä»½å·¥å…·</p><p><strong>å¤‡ä»½çš„æ–¹å¼</strong></p><ul><li>é€»è¾‘å¤‡ä»½</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">åŸºäºSQLè¯­å¥çš„å¤‡ä»½</span><br><span class="line">1ï¼‰binlog</span><br><span class="line">2ï¼‰into outfile</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™ä¸ªæ˜¯æ¢å¤è¡¨é‡Œé¢çš„çœŸå®æ•°æ®</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from world.city into outfile <span class="string">&#x27;/tmp/world_city.data&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ï¼‰mysqldump</span><br><span class="line">4ï¼‰replication(ä¸»ä»å¤åˆ¶)</span><br><span class="line">5) mysqlbinlog</span><br></pre></td></tr></table></figure><ul><li><p>ç‰©ç†å¤‡ä»½</p><p>åŸºäºæ•°æ®æ–‡ä»¶çš„å¤‡ä»½<br>1ï¼‰Xtrabackupï¼ˆperconaå…¬å¸å†™çš„)</p></li></ul><p><strong>å¤‡ä»½ç­–ç•¥</strong></p><ul><li>å…¨å¤‡ï¼šå¤‡ä»½æ‰€æœ‰æ•°æ®</li><li>å¢å¤‡ï¼šæ¯æ¬¡åŸºäºä¸Šä¸€æ¬¡å¤‡ä»½åæ–°å¢çš„æ•°æ®</li><li>å·®å¼‚å¤‡ä»½ï¼š(æ¯æ¬¡éƒ½åŸºäºå…¨å¤‡)</li></ul><p><img src="../image/study_img/image-20240821103326915.png" alt="image-20240821103326915"></p><p><strong>mysqldumpé€»è¾‘å¤‡ä»½å·¥å…·</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®¢æˆ·ç«¯å‘½ä»¤é€‰é¡¹</span></span><br><span class="line">-uï¼šæŒ‡å®šç”¨æˆ·</span><br><span class="line">-pï¼šæŒ‡å®šå¯†ç </span><br><span class="line">-hï¼šæŒ‡å®šä¸»æœº</span><br><span class="line">-Pï¼šæŒ‡å®šç«¯å£</span><br><span class="line">-Sï¼šæŒ‡å®šsocketæ–‡ä»¶</span><br></pre></td></tr></table></figure><p><strong>å¤‡ä»½å‘½ä»¤çš„é€‰é¡¹</strong></p><p>1ã€å…¨å¤‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-A  /  --all-databases :å¤‡ä»½mysqlçš„æ‰€æœ‰åº“å’Œæ‰€æœ‰è¡¨</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 -A &gt; /tmp/full.sql  </span><br></pre></td></tr></table></figure><p>2ã€åº“çº§å¤‡ä»½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-B    /   --databases  ï¼šæŒ‡å®šåº“åšå¤‡ä»½</span><br><span class="line"></span><br><span class="line"><span class="comment">#mysqldupm -uroot -p123 -B åº“å  åº“å åº“å  åº“å...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŒ‡å®šå•ä¸ªåº“åšå¤‡ä»½    (å¤‡ä»½å‡ºæ¥çš„æ–‡ä»¶æœ‰å»ºåº“è¯­å¥)</span></span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 -B world &gt; /tmp/world.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¢å¤æ–¹å¼</span></span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 &lt; /tmp/world.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŒ‡å®šå¤šä¸ªåº“åšå¤‡ä»½</span></span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 -B world student &gt; /tmp/world_stu.sql</span><br></pre></td></tr></table></figure><p>3ã€è¡¨çº§å¤‡ä»½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¸åŠ é€‰é¡¹ï¼Œç›´æ¥å†™åº“åå­—</span></span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 world &gt; /tmp/world1.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¢å¤æ–¹å¼(æ¢å¤æ—¶éœ€è¦æŒ‡å®šä¸€ä¸ªåº“)</span></span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 <span class="built_in">test</span> &lt; /tmp/world1.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># mysqldump -uroot -p123 åº“å è¡¨å è¡¨å è¡¨å è¡¨å...</span></span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 linux8 city &gt; /tmp/linux8_city.sql</span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 linux8 prod &gt; /tmp/linux8_prod.sql</span><br></pre></td></tr></table></figure><p>4ã€æ‰“ç‚¹å¤‡ä»½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ‰“ç‚¹å¤‡ä»½(å¤‡ä»½ä½ç½®ç‚¹å’Œåå­—) </span></span><br><span class="line">å¥½å¤„ï¼šè¿™æ¬¡å…¨å¤‡å°±è®°å½•åˆ°è¿™ä¸ªä½ç½®ç‚¹äº†ï¼Œæ–°å¢çš„æ•°æ®å°±æ˜¯è¿™ä¸ªç‚¹ä¹‹åçš„ï¼Œæƒ³æˆªå–binlogï¼Œå¼€å§‹ä½ç½®ç‚¹å°±çœ‹è¿™ä¸ªç‚¹ï¼Œç»“æŸä½ç½®ç‚¹å»binlogé‡Œé¢æˆªå–</span><br><span class="line"></span><br><span class="line">--master-data=[0|1|2] ï¼š(æ¸©å¤‡é€‰é¡¹)  </span><br><span class="line"></span><br><span class="line">his option will turn --lock-all-tables on(ä½¿ç”¨è¿™ä¸ªé€‰é¡¹æ—¶ï¼Œä¼šæ‰“å¼€ --lock--all-tablesé€‰é¡¹ï¼Œä¼šé”è¡¨)</span><br><span class="line">unless --single-transaction is specified too(é™¤éåŠ å…¥ --single-transactionè¿™ä¸ªé€‰é¡¹ï¼Œå°±ä¸ä¼šè¢«é”è¡¨(å¿«ç…§)) </span><br><span class="line"></span><br><span class="line">0ï¼šå…³é—­è¿™ä¸ªé€‰é¡¹ï¼Œè·Ÿä¸å†™è¿™ä¸ªé€‰é¡¹ä¸€æ ·ï¼Œæ²¡æœ‰change masterçš„è®°å½•</span><br><span class="line">1ï¼šIf equal to 1, will <span class="built_in">print</span> it as a CHANGE MASTER <span class="built_in">command</span>; </span><br><span class="line">    <span class="comment">#æ‰“å°chenge masterè¯­å¥</span></span><br><span class="line">2ï¼š<span class="keyword">if</span> equal to 2, that <span class="built_in">command</span> will be prefixed with a comment symbol.</span><br><span class="line">    <span class="comment">#chenge masterå°†ä¼šè¢«æ³¨é‡Šæ‰(ä¸»ä»å¤åˆ¶å¯ä»¥ç”¨ 2æ¯”è¾ƒå¸¸ç”¨)  æ–‡ä»¶çš„22è¡Œè®°å½•</span></span><br></pre></td></tr></table></figure><p>5ã€å¿«ç…§å¤‡ä»½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¿«ç…§å¤‡ä»½</span></span><br><span class="line">--single--transactionï¼š(çƒ­å¤‡é€‰é¡¹) ä¸é”è¡¨ï¼Œä¸å½±å“ç”¨æˆ·æŒç»­å†™å…¥æ•°æ®</span><br><span class="line"></span><br><span class="line">åŠ å…¥è¿™ä¸ªé€‰é¡¹ï¼Œåœ¨å¤‡ä»½çš„æ—¶å€™å°±ç›¸å½“äºæ‹äº†å¿«ç…§ï¼Œå°±å¤‡ä»½åˆ°ç›®å‰çš„æŒ‡å®šä½ç½®ï¼Œåé¢ç”¨æˆ·å†™å…¥çš„æ•°æ®æˆ‘ä¸å¤‡ä»½ï¼Œåªæœ‰å¿«ç…§æˆ‘ä¸çŸ¥é“å¤‡ä»½åˆ°å“ªé‡Œï¼Œéœ€è¦é…åˆæ‰“ç‚¹å¤‡ä»½ä½¿ç”¨ï¼Œç”¨æˆ·å†™å…¥çš„æ•°æ®å°±æ˜¯è¿™ä¸ªç‚¹ä¹‹åçš„æ•°æ®</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å…¨å¤‡ä¸”çƒ­å¤‡çš„å‘½ä»¤</span></span><br><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -A --master-data=2 --single-transaction &gt; /tmp/full.sgl</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# vim /tmp/full.sgl</span><br><span class="line">22è¡Œï¼š</span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000015&#x27;</span>, MASTER_LOG_POS=105700;</span><br><span class="line">è®°å½•è¿™æ¬¡å…¨å¤‡ï¼Œå¤‡ä»½åˆ°mysql-bin.000015ï¼Œä½ç½®ç‚¹æ˜¯ï¼š10500ï¼Œè¿™ä¸ªç‚¹ä¹‹åçš„æ•°æ®å°±æ˜¯æ–°å¢æ•°æ®</span><br></pre></td></tr></table></figure><p>6ã€å¤‡ä»½å‡½æ•°å’Œå­˜å‚¨è¿‡ç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-Rï¼š å‡½æ•°å’Œå‚¨å­˜è¿‡ç¨‹æ˜¯å¼€å‘å†™ç¨‹åºçš„æ—¶å€™å†™çš„(å¦‚æœæœ‰å°±å¤‡ä»½ï¼Œå¦‚æœæ²¡æœ‰å°±ä¸å¤‡ä»½ï¼Œä½†æ˜¯åŠ ä¸Šè¿™ä¸ªé€‰é¡¹ä¹Ÿæ²¡æœ‰ä»»ä½•å½±å“)</span><br><span class="line"></span><br><span class="line">mysqldump -uroot -p123 -A -R --master-data=2 --single-transaction &gt; /tmp/full.sgl</span><br></pre></td></tr></table></figure><p>7ã€å¤‡ä»½è§¦å‘å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--triggers:  å¤‡ä»½è§¦å‘å™¨ (å¦‚æœå¼€å‘å†™äº†å°±å¤‡ä»½ï¼Œå¦‚æœæ²¡æœ‰å°±ä¸å¤‡ä»½,åŠ ä¸Šè¿™ä¸ªé€‰é¡¹ä¹Ÿæ²¡æœ‰ä»»ä½•å½±å“)</span><br><span class="line"></span><br><span class="line">mysqldump -uroot -p123 -A -R --triggers --master-data=2 --single-transaction &gt; /tmp/full.sgl</span><br><span class="line"></span><br><span class="line"><span class="comment">#å‹ç¼©</span></span><br><span class="line">mysqldump -uroot -p123 -A -R --triggers --master-data=2 --single-transaction |gzip &gt; /tmp/full.sgl</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®Œæ•´çš„å¤‡ä»½è¯­å¥</span></span><br><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -A -R --triggers --master-data=2 --single-transaction|gzip &gt; /tmp/full_$(<span class="built_in">date</span> +%F).sql.gz</span><br></pre></td></tr></table></figure><p>8ã€åˆ·æ–°binlogå¤‡ä»½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-Fï¼šåšå¤‡ä»½çš„åŒæ—¶ï¼Œæ¯å¤‡ä»½ä¸€ä¸ªåº“ï¼Œåˆ·æ–°ä¸€ä¸ªæ–°çš„binlogå‡ºæ¥(ä¸å¸¸ç”¨)</span><br><span class="line">å‡ºæ¥çš„æ˜¯æ²¡æœ‰ç”¨çš„binlog,å°æ–‡ä»¶å°±ä¼šå¤šï¼Œä¼šå¯¼è‡´inodeè¢«æ²¾æ»¡</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 -B table1 table2 table3 -F &gt; /tmp/test_binlog.sql</span><br><span class="line">ä¼šåˆ·æ–°3ä¸ªbinlogå‡ºæ¥</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#è®¤è¯†ï¼Œä½†ä¸ç”¨çš„é€‰é¡¹</span></span><br><span class="line">-d:ä»…å¤‡ä»½è¡¨ç»“æ„</span><br><span class="line">-t:ä»…å¤‡ä»½æ•°æ®</span><br></pre></td></tr></table></figure><p><strong>å®Œæ•´çš„çƒ­å¤‡è¯­å¥</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ä»»ä½•åœºæ™¯çš„å¤‡ä»½å‘½ä»¤ï¼š</span><br><span class="line">å‹ç¼©ï¼Œå¹¶ä¸”è®°å½•å¤‡ä»½æ—¶é—´æˆ³,å†™è„šæœ¬ä¹Ÿé€‚ç”¨</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -A -R --triggers --master-data=2 --single-transaction|gzip &gt; /tmp/full_$(<span class="built_in">date</span> +%F).sql.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-rw-r--r--  1 root root 252419 Aug 22 00:55 full_2024-08-22.sql.gz</span><br><span class="line"><span class="comment">#è§£å‹ï¼Œæ¢å¤æ•°æ®ä¸éœ€è¦è§£å‹çš„</span></span><br><span class="line">[root@db01 ~]# gzip -d /tmp/full_2024-08-22.sql.gz </span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¢å¤æ•°æ®</span></span><br><span class="line">[root@db01 ~]# zcat /tmp/full_2024-08-22.sql.gz |mysql -uroot -p123</span><br></pre></td></tr></table></figure><p><font color = red> æ³¨æ„ï¼š</font><br>1ï¼‰mysqldumpåœ¨å¤‡ä»½å’Œæ¢å¤æ—¶éƒ½éœ€è¦MySQLå®ä¾‹å¯åŠ¨ä¸ºå‰æ<br>2ï¼‰ä¸€èˆ¬æ•°æ®é‡çº§100Gä»¥å†…ï¼Œå¤§çº¦15-30åˆ†é’Ÿå¯ä»¥æ¢å¤ï¼ˆPBã€EBå°±éœ€è¦è€ƒè™‘åˆ«çš„æ–¹å¼ï¼‰<br>3ï¼‰mysqldumpæ˜¯ä»¥è¦†ç›–çš„å½¢å¼æ¢å¤æ•°æ®çš„</p><p><strong>ä¼ä¸šæ•…éšœæ¢å¤æ¡ˆä¾‹1</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">èƒŒæ™¯ï¼š</span><br><span class="line">æ­£åœ¨è¿è¡Œçš„ç½‘ç«™ç³»ç»Ÿï¼ŒMySQLæ•°æ®åº“ï¼Œæ•°æ®é‡25Gï¼Œæ—¥ä¸šåŠ¡å¢é‡10-15Mã€‚</span><br><span class="line"></span><br><span class="line">å¤‡ä»½ç­–ç•¥ï¼š</span><br><span class="line">æ¯å¤©23ï¼š00ï¼Œè®¡åˆ’ä»»åŠ¡è°ƒç”¨mysqldumpæ‰§è¡Œå…¨å¤‡è„šæœ¬</span><br><span class="line"></span><br><span class="line">æ•…éšœæ—¶é—´ç‚¹ï¼š</span><br><span class="line">ä¸Šåˆ10ç‚¹å¼€å‘äººå‘˜è¯¯åˆ é™¤ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡è¡¨ï¼Œå¦‚ä½•æ¢å¤ï¼Ÿ</span><br><span class="line"></span><br><span class="line"><span class="comment">#23~10ç‚¹çš„å¢é‡æ•°æ®è¦æˆªå–</span></span><br><span class="line"><span class="comment">#åˆ è¡¨è¯­å¥åé¢æ–°å¢çš„æ•°æ®ä¹Ÿè¦æˆªå–</span></span><br><span class="line"></span><br><span class="line">æ€è·¯ï¼š</span><br><span class="line">1ï¼‰åœä¸šåŠ¡é¿å…æ•°æ®çš„äºŒæ¬¡ä¼¤å®³</span><br><span class="line">2ï¼‰æ‰¾ä¸€ä¸ªä¸´æ—¶çš„åº“ï¼Œæ¢å¤å‰ä¸€å¤©çš„å…¨å¤‡</span><br><span class="line">3ï¼‰æˆªå–å‰ä¸€å¤©23ï¼š00åˆ°ç¬¬äºŒå¤©10ç‚¹è¯¯åˆ é™¤ä¹‹é—´çš„binlogï¼Œæ¢å¤åˆ°ä¸´æ—¶åº“</span><br><span class="line">4ï¼‰æµ‹è¯•å¯ç”¨æ€§å’Œå®Œæ•´æ€§</span><br><span class="line">5ï¼‰å¼€å¯ä¸šåŠ¡å‰çš„ä¸¤ç§æ–¹å¼</span><br><span class="line">    a.ç›´æ¥ä½¿ç”¨ä¸´æ—¶åº“é¡¶æ›¿åŸç”Ÿäº§åº“ï¼Œå‰ç«¯åº”ç”¨å‰²æ¥åˆ°æ–°åº“</span><br><span class="line">    b.å°†è¯¯åˆ é™¤çš„è¡¨å•ç‹¬å¯¼å‡ºï¼Œç„¶åå¯¼å…¥åˆ°åŸç”Ÿäº§ç¯å¢ƒ</span><br><span class="line">6ï¼‰å¼€å¯ä¸šåŠ¡</span><br></pre></td></tr></table></figure><p>1ã€æ•…éšœæ¨¡æ‹Ÿæ¼”ç»ƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">1ã€#å…ˆæ‰§è¡Œå†™å…¥æ•°æ®çš„è„šæœ¬</span><br><span class="line">[root@db01 ~]# sh insert.sh </span><br><span class="line"></span><br><span class="line">2ã€#åˆ›å»ºåº“åˆ›è¡¨</span><br><span class="line">root@localhost:(none) &gt; create database hexin;</span><br><span class="line">root@localhost:(none) &gt; use hexin;</span><br><span class="line">root@localhost:hexin &gt; create table hexin(<span class="built_in">id</span> int);</span><br><span class="line"></span><br><span class="line">3ã€#è¿è¡Œé‚£ä¹ˆä¹…äº†ï¼Œå¾€é‡Œé¢å†™ç‚¹æ•°æ®</span><br><span class="line">root@localhost:hexin &gt; insert into hexin values(1),(2),(3),(4);</span><br><span class="line">root@localhost:hexin &gt; <span class="keyword">select</span> * from hexin;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">4ã€#å‡è®¾ç°åœ¨åˆ°æ™šä¸Š23ç‚¹äº†ï¼Œä»»åŠ¡è®¡åˆ’è‡ªåŠ¨åšå…¨å¤‡</span><br><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -A -R --triggers --master-data=2 --single-transaction|gzip &gt; /tmp/full_$(<span class="built_in">date</span> +%F).sql.gz</span><br><span class="line"></span><br><span class="line">5ã€#æ¨¡æ‹Ÿæ–°å¢æ•°æ®</span><br><span class="line">root@localhost:hexin &gt; update hexin <span class="built_in">set</span> <span class="built_in">id</span>=10 <span class="built_in">where</span> <span class="built_in">id</span>=1;</span><br><span class="line">root@localhost:hexin &gt; <span class="keyword">select</span> * from hexin;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|   10 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">root@localhost:hexin &gt; delete from hexin <span class="built_in">where</span> <span class="built_in">id</span>=3;</span><br><span class="line">root@localhost:hexin &gt; <span class="keyword">select</span> * from hexin;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|   10 |</span><br><span class="line">|    2 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">6ã€#ä¸Šåˆ10ç‚¹å¼€å‘äººå‘˜è¯¯åˆ é™¤ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡è¡¨</span><br><span class="line">root@localhost:hexin &gt; drop table hexin;</span><br><span class="line"></span><br><span class="line">root@localhost:hexin &gt; <span class="keyword">select</span> * from hexin;</span><br><span class="line">ERROR 1146 (42S02): Table <span class="string">&#x27;hexin.hexin&#x27;</span> doesn<span class="string">&#x27;t exist</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å¦‚æœç½‘ç«™ä¸èƒ½æä¾›æœåŠ¡äº†å°±åœæ­¢æ•°æ®åº“ï¼Œå¦‚æœç½‘ç«™è¿˜èƒ½ä½¿ç”¨ï¼Œå°±å¯ä»¥ä¸åœæ­¢æ•°æ®åº“</span></span><br></pre></td></tr></table></figure><p>2ã€æ¢å¤(ä¸åœåº“)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">+------+   <span class="comment">#æ¢å¤åˆ°è¿™é‡Œ</span></span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|   10 |</span><br><span class="line">|    2 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€#å‡†å¤‡æ–°ç¯å¢ƒ  db02</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line">[root@db02 ~]# <span class="built_in">rm</span> -rf /app/mysql-5.6.50/data</span><br><span class="line">é…ç½®æ–‡ä»¶å’Œæ—§ç¯å¢ƒå¤§éƒ¨åˆ†ä¿æŒä¸€è‡´</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/app/mysql-5.6.50</span><br><span class="line">datadir=/app/mysql-5.6.50/data</span><br><span class="line">log_bin=mysql-bin</span><br><span class="line">server_id=1</span><br><span class="line">lower_case_table=1</span><br><span class="line"><span class="comment">#innodb_data_file_path=ibdata1:12M;ibdata2:50M:autoextend</span></span><br><span class="line">binlog_format=row</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">prompt=<span class="string">&quot;\\u@\\h:\\d &gt; &quot;</span></span><br><span class="line">[root@db02 ~]# /app/mysql-5.6.50/scripts/mysql_install_db --user=mysql --basedir=/app/mysql-5.6.50 --datadir=/app/mysql-5.6.50/data</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#æ–°ç¯å¢ƒåˆ›å»ºä¸€ä¸ªè¿œç¨‹è¿æ¥çš„ç”¨æˆ·</span><br><span class="line">root@localhost:(none) &gt; grant all on *.* to root@<span class="string">&#x27;172.16.1.%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#å°†å¤´ä¸€å¤©çš„å…¨å¤‡æ¢å¤åˆ°æ–°ç¯å¢ƒ</span><br><span class="line">[root@db01 ~]# zcat /tmp/full_2024-08-22.sql.gz |mysql -uroot -p123 -h172.16.1.52</span><br><span class="line">æ–°ç¯å¢ƒæŸ¥çœ‹</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> * from hexin.hexin;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">3ã€#æˆªå–binlogæ–°å¢æ•°æ®</span><br><span class="line">[root@db01 ~]# zcat /tmp/full_2024-08-22.sql.gz |<span class="built_in">head</span> -25</span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000015&#x27;</span>, MASTER_LOG_POS=527709;</span><br><span class="line">åœ¨å…¨å¤‡é‡Œé¢   <span class="string">&#x27;mysql-bin.000015   </span></span><br><span class="line"><span class="string">å¼€å§‹ä½ç½®ç‚¹ï¼š527709</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç»“æŸä½ç½®ç‚¹ï¼šä¸Šåˆ10ç‚¹å¼€å‘äººå‘˜è¯¯åˆ é™¤ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡è¡¨</span></span><br><span class="line"><span class="string">drop table hexinè¿™ä¸ªè¯­å¥ä¹‹å‰å°±æ˜¯ç»“æŸä½ç½®ç‚¹</span></span><br><span class="line"><span class="string">[root@db01 ~]# mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/mysql-bin.000015 |grep -iC 10 &#x27;</span>drop table `hexin`<span class="string">&#x27;</span></span><br><span class="line"><span class="string">ç»“æŸä½ç½®ç‚¹ï¼š584459</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@db01 ~]# mysqlbinlog --start-position=527709 --stop-position=584459 /app/mysql-5.6.50/data/mysql-bin.000015 &gt; /tmp/inc1.sql</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">4ã€#å°†ç¬¬ä¸€æ®µçš„æ•°æ®æ¢å¤åˆ°æ–°ç¯å¢ƒ</span></span><br><span class="line"><span class="string">[root@db01 ~]# mysql -uroot -p123 -h172.16.1.52 &lt; /tmp/inc1.sql </span></span><br><span class="line"><span class="string">æ–°ç¯å¢ƒæŸ¥çœ‹</span></span><br><span class="line"><span class="string">root@localhost:(none) &gt; select * from hexin.hexin;</span></span><br><span class="line"><span class="string">+------+</span></span><br><span class="line"><span class="string">| id   |</span></span><br><span class="line"><span class="string">+------+</span></span><br><span class="line"><span class="string">|   10 |</span></span><br><span class="line"><span class="string">|    2 |</span></span><br><span class="line"><span class="string">|    4 |</span></span><br><span class="line"><span class="string">+------+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">5ã€#æŒ‚ç»´æŠ¤é¡µï¼Œåœæ­¢è¿æ¥æ•°æ®åº“çš„ç¨‹åº</span></span><br><span class="line"><span class="string">è¿™ä¸ªæ—¶å€™å¯ä»¥åœæ­¢è„šæœ¬æ‰§è¡Œ</span></span><br><span class="line"><span class="string">æŸ¥çœ‹æ€»çš„æ•°æ®</span></span><br><span class="line"><span class="string">root@localhost:hexin &gt; select count(*) from prod.prod;</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">| count(*) |</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">|     4366 |</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">6ã€#æˆªå–åˆ è¡¨ä¹‹åçš„æ–°å¢æ•°æ®</span></span><br><span class="line"><span class="string">å¼€å§‹ä½ç½®ç‚¹ï¼šä¸Šåˆ10ç‚¹å¼€å‘äººå‘˜è¯¯åˆ é™¤ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡è¡¨</span></span><br><span class="line"><span class="string">drop table hexinè¿™ä¸ªè¯­å¥ä½ç½®ç‚¹ï¼Œçš„åé¢ä¸€ä¸ªä½ç½®ç‚¹</span></span><br><span class="line"><span class="string">[root@db01 ~]# mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/mysql-bin.000015 |grep -iC 10 &#x27;</span>drop table `hexin`<span class="string">&#x27;</span></span><br><span class="line"><span class="string">SET @@session.pseudo_thread_id=2475/*!*/;</span></span><br><span class="line"><span class="string">DROP TABLE `hexin` /* generated by server */</span></span><br><span class="line"><span class="string">/*!*/;</span></span><br><span class="line"><span class="string"># at 584579</span></span><br><span class="line"><span class="string">#240822  1:54:12 server id 1</span></span><br><span class="line"><span class="string">å¼€æŸä½ç½®ç‚¹ï¼š584579</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç»“æŸä½ç½®ç‚¹ï¼š(éœ€è¦åœæ­¢è¿æ¥æ•°æ®åº“çš„æœåŠ¡æ‰å¥½æ‰¾ï¼Œä¸è¦å¾€æ•°æ®åº“é‡Œé¢å†™æ•°æ®)</span></span><br><span class="line"><span class="string">[root@db01 ~]# mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/mysql-bin.000015|tail</span></span><br><span class="line"><span class="string"># at 940180                     ç»“æŸä½ç½®ç‚¹</span></span><br><span class="line"><span class="string">240822  2:26:40 server id 1  &#x27;</span>end_log_pos 940211<span class="string">&#x27; CRC32 0xd479131d       Xid = 26217</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">æˆ–è€…ç›´æ¥çœ‹æ–‡ä»¶å¤§å°å°±å¯ä»¥ï¼Œç»“æŸä½ç½®ç‚¹å’Œbinlogæ–‡ä»¶åœæ­¢å†™å…¥çš„å¤§å°ä¸€æ ·</span></span><br><span class="line"><span class="string">[root@db01 ~]# ll /app/mysql-5.6.50/data/</span></span><br><span class="line"><span class="string">-rw-rw---- 1 mysql mysql   940211 Aug 22 02:26 mysql-bin.000015</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç»“æŸä½ç½®ç‚¹ï¼š940211    (end_log_pos 940211)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@db01 ~]# mysqlbinlog --start-position=584579 --stop-position=940211 /app/mysql-5.6.50/data/mysql-bin.000015 &gt; /tmp/inc2.sql</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">7ã€#å°†ç¬¬äºŒæ®µçš„æ–°å¢æ•°æ®æ¢å¤åˆ°æ–°ç¯å¢ƒ</span></span><br><span class="line"><span class="string">[root@db01 ~]#  mysql -uroot -p123 -h172.16.1.52 &lt; /tmp/inc2.sql</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">æ–°ç¯å¢ƒæŸ¥çœ‹æ€»çš„æ•°æ®ï¼Œå’Œæ—§ç¯å¢ƒçš„æ•°æ®ä¸€æ ·</span></span><br><span class="line"><span class="string">root@localhost:(none) &gt; select count(*) from prod.prod;</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">| count(*) |</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">|     4366 |</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">root@localhost:(none) &gt; select * from hexin.hexin;</span></span><br><span class="line"><span class="string">+------+</span></span><br><span class="line"><span class="string">| id   |</span></span><br><span class="line"><span class="string">+------+</span></span><br><span class="line"><span class="string">|   10 |</span></span><br><span class="line"><span class="string">|    2 |</span></span><br><span class="line"><span class="string">|    4 |</span></span><br><span class="line"><span class="string">+------+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">8ã€#åº”ç”¨å‰²æ¥</span></span><br><span class="line"><span class="string">        - è¿ç»´ï¼šæ–°ç¯å¢ƒå…¨å¤‡ï¼Œå¯¼å…¥æ—§ç¯å¢ƒ</span></span><br><span class="line"><span class="string">        - å¼€å‘ï¼šä¿®æ”¹è¿æ¥æ•°æ®åº“çš„ä»£ç </span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">9ã€#å–æ¶ˆæŠ¤é¡µï¼Œå¼€å¯è¿æ¥æ•°æ®åº“çš„ç¨‹åº</span></span><br></pre></td></tr></table></figure><p><strong>ä¼ä¸šæ•…éšœæ¢å¤æ¡ˆä¾‹2</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">èƒŒæ™¯ï¼š</span><br><span class="line">æ­£åœ¨è¿è¡Œçš„ç½‘ç«™ç³»ç»Ÿï¼ŒMySQLæ•°æ®åº“ï¼Œæ•°æ®é‡25Gï¼Œæ—¥ä¸šåŠ¡å¢é‡10-15Mã€‚</span><br><span class="line"></span><br><span class="line">å¤‡ä»½ç­–ç•¥ï¼š</span><br><span class="line">æ¯å¤©23ï¼š00ï¼Œè®¡åˆ’ä»»åŠ¡è°ƒç”¨mysqldumpæ‰§è¡Œå…¨å¤‡è„šæœ¬</span><br><span class="line"></span><br><span class="line">æ•…éšœæ—¶é—´ç‚¹ï¼š</span><br><span class="line">ä¸Šåˆ10ç‚¹å¼€å‘äººå‘˜è¯¯åˆ é™¤ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡è¡¨ä¹‹å‰ï¼Œ<span class="string">&#x27;è¿˜è¯¯ä¿®æ”¹äº†ä¸€æ¡æ•°æ®,è¯¯å°†1æ”¹æˆ10äº†&#x27;</span>ï¼Œå¦‚ä½•æ¢å¤ï¼Ÿ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æœ€ç»ˆè¦æ¢å¤çš„æ•°æ®æ˜¯ï¼š</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#æˆªå–æ€è·¯</span></span><br><span class="line">1ã€æˆªå–å…¨å¤‡~updateä¹‹å‰</span><br><span class="line">2ã€updateä¹‹å~(drop table hexin)ä¸Šåˆ10ç‚¹å¼€å‘äººå‘˜è¯¯åˆ é™¤ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡è¡¨ä¹‹å‰</span><br><span class="line">3ã€(drop table hexin)ä¹‹å~åœåº“</span><br></pre></td></tr></table></figure><p>1ã€æ•…éšœæ¨¡æ‹Ÿæ¼”ç»ƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">1ã€#å…ˆæ‰§è¡Œå†™å…¥æ•°æ®çš„è„šæœ¬</span><br><span class="line">[root@db01 ~]# sh insert.sh </span><br><span class="line"></span><br><span class="line">2ã€#åˆ›å»ºåº“åˆ›è¡¨</span><br><span class="line">root@localhost:(none) &gt; create database hexin;</span><br><span class="line">root@localhost:(none) &gt; use hexin;</span><br><span class="line">root@localhost:hexin &gt; create table hexin(<span class="built_in">id</span> int);</span><br><span class="line"></span><br><span class="line">3ã€#è¿è¡Œé‚£ä¹ˆä¹…äº†ï¼Œå¾€é‡Œé¢å†™ç‚¹æ•°æ®</span><br><span class="line">root@localhost:hexin &gt; insert into hexin values(1),(2),(3),(4);</span><br><span class="line">root@localhost:hexin &gt; <span class="keyword">select</span> * from hexin;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">4ã€#å‡è®¾ç°åœ¨åˆ°æ™šä¸Š23ç‚¹äº†ï¼Œä»»åŠ¡è®¡åˆ’è‡ªåŠ¨åšå…¨å¤‡</span><br><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -A -R --triggers --master-data=2 --single-transaction|gzip &gt; /tmp/full_$(<span class="built_in">date</span> +%F).sql.gz</span><br><span class="line"></span><br><span class="line">5ã€#æ¨¡æ‹Ÿæ–°å¢æ•°æ®</span><br><span class="line">root@localhost:hexin &gt; update hexin <span class="built_in">set</span> <span class="built_in">id</span>=10 <span class="built_in">where</span> <span class="built_in">id</span>=1;</span><br><span class="line">root@localhost:hexin &gt; <span class="keyword">select</span> * from hexin;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|   10 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">root@localhost:hexin &gt; delete from hexin <span class="built_in">where</span> <span class="built_in">id</span>=3;</span><br><span class="line">root@localhost:hexin &gt; <span class="keyword">select</span> * from hexin;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|   10 |</span><br><span class="line">|    2 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">6ã€#ä¸Šåˆ10ç‚¹å¼€å‘äººå‘˜è¯¯åˆ é™¤ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡è¡¨</span><br><span class="line">root@localhost:hexin &gt; drop table hexin;</span><br><span class="line"></span><br><span class="line">root@localhost:hexin &gt; <span class="keyword">select</span> * from hexin;</span><br><span class="line">ERROR 1146 (42S02): Table <span class="string">&#x27;hexin.hexin&#x27;</span> doesn<span class="string">&#x27;t exist</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å¦‚æœç½‘ç«™ä¸èƒ½æä¾›æœåŠ¡äº†å°±åœæ­¢æ•°æ®åº“ï¼Œå¦‚æœç½‘ç«™è¿˜èƒ½ä½¿ç”¨ï¼Œå°±å¯ä»¥ä¸åœæ­¢æ•°æ®åº“</span></span><br></pre></td></tr></table></figure><p>2ã€æ¢å¤(ä¸åœåº“)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">+------+   <span class="comment">#æ¢å¤åˆ°è¿™é‡Œ</span></span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€#å‡†å¤‡æ–°ç¯å¢ƒ  db02</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line">[root@db02 ~]# <span class="built_in">rm</span> -rf /app/mysql-5.6.50/data</span><br><span class="line">é…ç½®æ–‡ä»¶å’Œæ—§ç¯å¢ƒå¤§éƒ¨åˆ†ä¿æŒä¸€è‡´</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip-name-resolve</span><br><span class="line">basedir=/app/mysql-5.6.50</span><br><span class="line">datadir=/app/mysql-5.6.50/data</span><br><span class="line">log_bin=mysql-bin</span><br><span class="line">server_id=1</span><br><span class="line">lower_case_table=1</span><br><span class="line"><span class="comment">#innodb_data_file_path=ibdata1:12M;ibdata2:50M:autoextend</span></span><br><span class="line">binlog_format=row</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">prompt=<span class="string">&quot;\\u@\\h:\\d &gt; &quot;</span></span><br><span class="line">[root@db02 ~]# /app/mysql-5.6.50/scripts/mysql_install_db --user=mysql --basedir=/app/mysql-5.6.50 --datadir=/app/mysql-5.6.50/data</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#æ–°ç¯å¢ƒåˆ›å»ºä¸€ä¸ªè¿œç¨‹è¿æ¥çš„ç”¨æˆ·</span><br><span class="line">root@localhost:(none) &gt; grant all on *.* to root@<span class="string">&#x27;172.16.1.%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;   <span class="comment">#å½“å…¨å¤‡æ¢å¤è¿‡æ¥ï¼Œè¿™ä¸ªç”¨æˆ·å°±ä¸åœ¨äº†ï¼Œæˆ‘ä»¬åé¢ç”¨è¿œç¨‹ç”¨æˆ·å¯¼æ•°æ®ï¼Œæ˜¯æ²¡æœ‰åˆ·æ–°è¡¨æˆ–è€…é‡å¯mysqlï¼Œå¦‚æœä¸€æ—¦åšäº†é‡å¯æˆ–è€…åˆ·æ–°ï¼Œè¿™ä¸ªç”¨æˆ·å°±ä¸èƒ½ç”¨äº†</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#å°†å¤´ä¸€å¤©çš„å…¨å¤‡æ¢å¤åˆ°æ–°ç¯å¢ƒ</span><br><span class="line">[root@db01 ~]# zcat /tmp/full_2024-08-22.sql.gz |mysql -uroot -p123 -h172.16.1.52</span><br><span class="line">æ–°ç¯å¢ƒæŸ¥çœ‹</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> * from hexin.hexin;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#æˆªå–æ€è·¯</span></span><br><span class="line">1ã€æˆªå–å…¨å¤‡~updateä¹‹å‰</span><br><span class="line">2ã€updateä¹‹å~(drop table hexin)ä¸Šåˆ10ç‚¹å¼€å‘äººå‘˜è¯¯åˆ é™¤ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡è¡¨ä¹‹å‰</span><br><span class="line">3ã€(drop table hexin)ä¹‹å~åœåº“</span><br><span class="line"></span><br><span class="line">3ã€#æˆªå–å…¨å¤‡~updateä¹‹å‰</span><br><span class="line">[root@db01 ~]# zcat /tmp/full_2024-08-22.sql.gz |<span class="built_in">head</span> -25</span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000015&#x27;</span>, MASTER_LOG_POS=969876;</span><br><span class="line">å¼€å§‹ä½ç½®ç‚¹ï¼š969876</span><br><span class="line"></span><br><span class="line">[root@db01 ~]#  mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/mysql-bin.000015 |grep -iC 10 <span class="string">&#x27;update `hexin`&#x27;</span></span><br><span class="line">ç»“æŸä½ç½®ç‚¹ï¼š971995</span><br><span class="line"></span><br><span class="line">mysqlbinlog --start-position=969876 --stop-position=971995 /app/mysql-5.6.50/data/mysql-bin.000015 &gt; /tmp/inc1.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€#æˆªå–updateä¹‹å~ä¸Šåˆ10ç‚¹å¼€å‘äººå‘˜è¯¯åˆ é™¤ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡è¡¨</span><br><span class="line">[root@db01 ~]#  mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/mysql-bin.000015 |grep -iC 10 <span class="string">&#x27;update `hexin`&#x27;</span></span><br><span class="line">å¼€å§‹ä½ç½®ç‚¹ï¼š972090</span><br><span class="line"></span><br><span class="line">[root@db01 ~]#  mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/mysql-bin.000015 |grep -iC 10 <span class="string">&#x27;drop table `hexin`&#x27;</span></span><br><span class="line">ç»“æŸä½ç½®ç‚¹ï¼š979382</span><br><span class="line"></span><br><span class="line">mysqlbinlog --start-position=972090 --stop-position=979382 /app/mysql-5.6.50/data/mysql-bin.000015 &gt; /tmp/inc2.sql</span><br><span class="line"></span><br><span class="line">5ã€#æŒ‚ç»´æŠ¤é¡µï¼Œåœæ­¢è¿æ¥æ•°æ®åº“çš„ç¨‹åº</span><br><span class="line">è¿™ä¸ªæ—¶å€™å¯ä»¥åœæ­¢è„šæœ¬æ‰§è¡Œ</span><br><span class="line">æŸ¥çœ‹æ€»çš„æ•°æ®</span><br><span class="line">root@localhost:hexin &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     2115 |</span><br><span class="line">+----------+</span><br><span class="line"></span><br><span class="line">6ã€#æˆªå–(drop table hexin)ä¹‹å~åœåº“(åœæ­¢è¿æ¥æ•°æ®åº“çš„ç¨‹åº)</span><br><span class="line">[root@db01 ~]# mysqlbinlog --base64-output=decode-rows -vvv /app/mysql-5.6.50/data/mysql-bin.000015 |grep -iC 10 <span class="string">&#x27;drop table `hexin`&#x27;</span></span><br><span class="line">å¼€å§‹ä½ç½®ç‚¹ï¼š979502</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# ll /app/mysql-5.6.50/data/</span><br><span class="line">-rw-rw---- 1 mysql mysql  1334948 Aug 22 04:25 mysql-bin.000015</span><br><span class="line">ç»“æŸä½ç½®ç‚¹ï¼š1334948</span><br><span class="line"></span><br><span class="line">mysqlbinlog --start-position=979502 --stop-position=1334948 /app/mysql-5.6.50/data/mysql-bin.000015 &gt; /tmp/inc3.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7ã€#å°†æ•°æ®æ¢å¤åˆ°æ–°ç¯å¢ƒ</span><br><span class="line">mysql -uroot -p123 -h172.16.1.52 &lt; /tmp/inc1.sql</span><br><span class="line">mysql -uroot -p123 -h172.16.1.52 &lt; /tmp/inc2.sql</span><br><span class="line">mysql -uroot -p123 -h172.16.1.52 &lt; /tmp/inc3.sql</span><br><span class="line"></span><br><span class="line">æ–°ç¯å¢ƒæŸ¥çœ‹æ€»çš„æ•°æ®ï¼Œå’Œæ—§ç¯å¢ƒçš„æ•°æ®ä¸€æ ·</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     2115 |</span><br><span class="line">+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> * from hexin.hexin;</span><br><span class="line">+------+</span><br><span class="line">| <span class="built_in">id</span>   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">8ã€#åº”ç”¨å‰²æ¥</span><br><span class="line">        - è¿ç»´ï¼šæ–°ç¯å¢ƒå…¨å¤‡ï¼Œå¯¼å…¥æ—§ç¯å¢ƒ</span><br><span class="line">        - å¼€å‘ï¼šä¿®æ”¹è¿æ¥æ•°æ®åº“çš„ä»£ç </span><br><span class="line">        </span><br><span class="line">9ã€#å–æ¶ˆæŠ¤é¡µï¼Œå¼€å¯è¿æ¥æ•°æ®åº“çš„ç¨‹åº</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¦‚æœåœ¨å°±æœåŠ¡å™¨é‡Œé¢æ¢å¤ï¼Œå…ˆæˆªå–ä½¿ç”¨æ•°æ®ï¼ŒæŠŠæ‰€æœ‰éœ€è¦çš„æ•°æ®æˆªå–å‡†å¤‡å¥½ï¼ŒåœæœåŠ¡ï¼ŒæŒ‰é¡ºåºä¸€æ¡ä¸€æ¡å¾€é‡Œé¢æ¢å¤</span><br></pre></td></tr></table></figure><h3 id="mysqlç‰©ç†å¤‡ä»½">mysqlç‰©ç†å¤‡ä»½</h3><p><strong>å®‰è£…xtrabackup</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¸‹è½½2.4ç‰ˆæœ¬çš„xtrabckup   db02</span><br><span class="line">[root@db02 ~]# wget https://downloads.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.29/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.29-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">2ã€å®‰è£…</span><br><span class="line">[root@db02 ~]# yum localinstall -y percona-xtrabackup-24-2.4.29-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">3ã€å¯ä»¥tablå‡ºè¿™ä¸¤ä¸ªå‘½ä»¤å°±å®‰è£…æˆåŠŸ</span><br><span class="line"><span class="comment">#(çƒ­å¤‡çš„å‘½ä»¤,ä¸“é—¨innodbå‚¨å­˜å¼•æ“åšå¤‡ä»½çš„)</span></span><br><span class="line">[root@db02 ~]# innobackupex </span><br><span class="line"></span><br><span class="line"><span class="comment">#(è€ç‰ˆæœ¬çš„å‘½ä»¤,ä»–ä¹Ÿå¯ä»¥åšinnodbçš„å­˜å‚¨å¼•æ“,è¦é”è¡¨,ç›¸å½“äºæ¸©å¤‡äº†,å¯ä»¥å¤‡ä»»ä½•å‚¨å­˜å¼•æ“,å±äºæ¸©å¤‡)</span></span><br><span class="line">[root@db02 ~]# xtrabackup  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€é…ç½®æ–‡ä»¶åŠ ä¸Šsocketè·¯å¾„ï¼Œmysqlç”¨æˆ·éœ€è¦æœ‰è¿›å…¥è¿™ä¸ªç›®å½•çš„æƒé™</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">....</span><br><span class="line"><span class="comment">#äºŒè¿›åˆ¶å®‰è£…çš„mysqlé»˜è®¤åœ¨tmpä¸‹</span></span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line"><span class="comment">#å®¢æˆ·ç«¯éœ€è¦æŒ‡å®šsocketæ–‡ä»¶ï¼Œä¸ç„¶å¤‡ä»½çš„æ—¶å€™ä¼šæŠ¥é”™</span></span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line"></span><br><span class="line">5ã€å‡†å¤‡æ–°ç¯å¢ƒ  db02</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line">[root@db02 ~]# <span class="built_in">rm</span> -fr /app/mysql/data</span><br><span class="line">[root@db02 ~]# /app/mysql-5.6.50/scripts/mysql_install_db --user=mysql --basedir=/app/mysql-5.6.50 --datadir=/app/mysql-5.6.50/data</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start</span><br><span class="line">6ã€#å…ˆç»™rootç”¨æˆ·é…ç½®ä¸€ä¸ªå¯†ç </span><br><span class="line">[root@db02 ~]# mysqladmin -u root -p password 123</span><br><span class="line">Enter password: <span class="comment">#ç›´æ¥å›è½¦</span></span><br><span class="line">Warning: Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">åˆ›å»ºä¸€ä¸ªç”¨æˆ·</span><br><span class="line">root@localhost:(none) &gt; grant all on *.* to root@<span class="string">&#x27;172.16.1.%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>; </span><br></pre></td></tr></table></figure><p><strong>Xtrabackupä»‹ç»</strong><br>1ï¼‰å¯¹äºéinnodbè¡¨ï¼ˆæ¯”å¦‚myisamï¼‰æ˜¯ç›´æ¥é”è¡¨cpæ•°æ®æ–‡ä»¶ï¼Œå±äºä¸€ç§æ¸©å¤‡ã€‚<br>2ï¼‰å¯¹äºinnodbçš„è¡¨ï¼ˆæ”¯æŒäº‹åŠ¡ï¼‰ï¼Œä¸é”è¡¨ï¼Œcpæ•°æ®é¡µæœ€ç»ˆä»¥æ•°æ®æ–‡ä»¶æ–¹å¼ä¿å­˜ä¸‹æ¥ï¼Œå¹¶ä¸”æŠŠredoå’Œundoä¸€å¹¶å¤‡èµ°ï¼Œå±äºçƒ­å¤‡æ–¹å¼ã€‚<br>3ï¼‰å¤‡ä»½/æ¢å¤æ—¶è¯»å–é…ç½®æ–‡ä»¶/etc/my.cnf</p><p><strong>å…¨å¤‡</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">çƒ­å¤‡ï¼šå¤‡ä»½çš„æ—¶å€™ï¼Œå¯ä»¥å†™æ•°æ®</span><br><span class="line">æ¸©å¤‡ï¼šå¤‡ä»½çš„æ—¶å€™ï¼Œåªèƒ½è¯»ï¼Œä¸èƒ½å†™</span><br><span class="line"></span><br><span class="line">1ã€#ä¿®æ”¹é…ç½®æ–‡ä»¶</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">....</span><br><span class="line"><span class="comment">#äºŒè¿›åˆ¶å®‰è£…çš„mysqlé»˜è®¤åœ¨tmpä¸‹</span></span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line"><span class="comment">#å®¢æˆ·ç«¯éœ€è¦æŒ‡å®šsocketæ–‡ä»¶ï¼Œä¸ç„¶å¤‡ä»½çš„æ—¶å€™ä¼šæŠ¥é”™</span></span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#(çƒ­å¤‡)å…¨å¤‡çš„å‘½ä»¤</span><br><span class="line">rootæ— å¯†ç  (backupä¸éœ€è¦æå‰åˆ›å»ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºçš„)</span><br><span class="line">[root@db02 ~]# innobackupex --user=root /backup</span><br><span class="line">rootæœ‰å¯†ç </span><br><span class="line">[root@db02 ~]# innobackupex --user=root  --password=<span class="string">&#x27;123&#x27;</span> /backup</span><br><span class="line">è¯·æ³¨æ„å¤‡ä»½ç»“æœæ˜¯å¦å®Œæˆ</span><br><span class="line">xtrabackup: Transaction <span class="built_in">log</span> of lsn (1625997) to (1625997) was copied.</span><br><span class="line">240822 15:16:57 completed OK!</span><br><span class="line"></span><br><span class="line"><span class="comment">#(é”è¡¨æ¸©å¤‡)å…¨å¤‡çš„å‘½ä»¤   å¦‚æœå…¬å¸ä¸æ˜¯inodbçš„å‚¨å­˜å¼•æ“ã€‚å°±ç”¨æ¸©å¤‡</span></span><br><span class="line">[root@db02 ~]# xtrabackup --user-root --password=123 --backup --target-dir=/tmp/full_$(<span class="built_in">date</span> +%F)</span><br><span class="line">è¯·æ³¨æ„å¤‡ä»½ç»“æœæ˜¯å¦å®Œæˆ</span><br><span class="line">xtrabackup: Transaction <span class="built_in">log</span> of lsn (1625997) to (1625997) was copied.</span><br><span class="line">240822 15:15:52 completed OK!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶</span><br><span class="line">[root@db02 ~]# ll /backup/2024-08-22_15-16-55/</span><br><span class="line">total 12316</span><br><span class="line">-rw-r----- 1 root root      481 Aug 22 15:16 backup-my.cnf   <span class="comment">#mysqlçš„é…ç½®æ–‡ä»¶</span></span><br><span class="line">-rw-r----- 1 root root 12582912 Aug 22 15:16 ibdata1         <span class="comment">#å…±äº«è¡¨ç©ºé—´,undoåœ¨é‡Œé¢</span></span><br><span class="line">drwxr-x--- 2 root root     4096 Aug 22 15:16 mysql</span><br><span class="line">drwxr-x--- 2 root root     4096 Aug 22 15:16 performance_schema</span><br><span class="line">drwxr-x--- 2 root root       20 Aug 22 15:16 <span class="built_in">test</span></span><br><span class="line">-rw-r----- 1 root root       21 Aug 22 15:16 xtrabackup_binlog_info  <span class="comment">#è®°å½•æ‰“ç‚¹å¤‡ä»½ å¤‡ä»½åˆ°çš„ä½ç½®ç‚¹</span></span><br><span class="line">-rw-r----- 1 root root      135 Aug 22 15:16 xtrabackup_checkpoints <span class="comment">#form_lsn  to_lsn  æŸ¥çœ‹å¢é‡å¤‡ä»½æ˜¯å¦è¡”æ¥</span></span><br><span class="line">-rw-r----- 1 root root      465 Aug 22 15:16 xtrabackup_info    <span class="comment">#è¿™æ¬¡å¤‡ä»½çš„ä¿¡æ¯</span></span><br><span class="line">-rw-r----- 1 root root     2560 Aug 22 15:16 xtrabackup_logfile   <span class="comment">#redo</span></span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/2024-08-22_15-16-55/xtrabackup_checkpoints</span><br><span class="line">backup_type = full-backuped   <span class="comment">#å¤‡ä»½ç±»å‹=å…¨å¤‡</span></span><br><span class="line">from_lsn = 0                  <span class="comment">#æ—¥å¿—ç‰ˆæœ¬å·èµ·ç‚¹ï¼šlsn:æ—¥å¿—ç‰ˆæœ¬å·  ä»0å·æ—¥å¿—ç‰ˆæœ¬å·å¼€å§‹å¤‡ä»½</span></span><br><span class="line">to_lsn = 1625997              <span class="comment">#æ—¥å¿—ç‰ˆæœ¬å·å¤‡ä»½åˆ°çš„ç‚¹ä½   å¤‡ä»½ç»“æŸä½ç½®ï¼š1625997</span></span><br><span class="line">last_lsn = 1625997            <span class="comment">#æœ€æ–°çš„æ—¥å¿—ç‰ˆæœ¬å·   å¦‚æœæœ‰ç”¨æˆ·å¾€é‡Œé¢å†™å…¥æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®å°±ä¼šæ¯”to_lsnå¤§</span></span><br><span class="line">compact = 0</span><br><span class="line">recover_binlog_info = 0       <span class="comment">#æ˜¯å¦è¦†ç›–äºŒè¿›åˆ¶çš„logä¿¡æ¯  0ï¼šå…³é—­</span></span><br><span class="line">flushed_lsn = 1625997         <span class="comment">#å¤‡ä»½å®Œæˆåè·å–åˆ°çš„æœ€æ–°lsn</span></span><br><span class="line">å¢å¤‡çš„from_lsn ä¸€å®šæ˜¯ä¸Šä¸€æ¬¡å¢å¤‡çš„to_lsn,è¦æ£€æŸ¥æ˜¯å¦è¡”æ¥ä¸Šï¼Œæ²¡æœ‰è¿æ¥ä¸Šï¼Œåšçš„å¢å¤‡æ•°æ®å°±ä¸å¯¹</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™ä¸ªæ–‡ä»¶é‡Œé¢çš„å°±å¥½æ¯”æ‰“ç‚¹å¤‡ä»½  æƒ³æˆªbinlog å¼€å§‹ä½ç½®ç‚¹å°±åœ¨è¿™é‡Œé¢çœ‹</span></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/2024-08-22_16-05-44/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000004        24251</span><br></pre></td></tr></table></figure><p><strong>å…¨å¤‡æ¢å¤</strong></p><p>æ¢å¤å…¨å¤‡çš„æ¡ä»¶ï¼š<br>1ã€è¢«æ¢å¤çš„ç›®å½•å¿…é¡»æ˜¯ç©ºçš„(dataç›®å½•æ˜¯ç©ºçš„)<br>2ã€è¢«æ¢å¤çš„æ•°æ®å®ä¾‹æ˜¯å…³é—­çš„(éœ€è¦åœåº“)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å…¨å¤‡æ¢å¤ä¹‹å‰ï¼šéœ€è¦æ‰‹åŠ¨æ¨¡æ‹ŸCSRçš„æ¢å¤è¿‡ç¨‹ï¼ŒæŠŠredoä¸­çš„æ•°æ® é‡åšï¼Œundoä¸­çš„æ•°æ®  å›æ»š</span></span><br><span class="line">å› ä¸ºè¡¨ç©ºé—´é‡Œé¢çš„æ•°æ®æ˜¯ä¸å…¨çš„ï¼Œæœ‰ä¸€éƒ¨åˆ†åœ¨redo,å¦‚æœåªåšredo,redoé‡Œé¢å­˜åœ¨ä¸€ä¸‹æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œundoä¹Ÿè¦åšä¸€é</span><br><span class="line"></span><br><span class="line">1ã€#å…ˆåˆ é™¤ä¸€ä¸ªprodåº“,å†æ¢å¤æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     1077 |</span><br><span class="line">+----------+</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; drop database prod;</span><br><span class="line"></span><br><span class="line">2ã€#å› ä¸ºæ˜¯ç‰©ç†å¤‡ä»½ï¼Œåšredo undoä¹‹å‰éœ€è¦åœæ­¢æ•°æ®åº“</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line"></span><br><span class="line">3ã€#æ¨¡æ‹ŸCSRæ¢å¤è¿‡ç¨‹ï¼šæŠŠredoä¸­çš„æ•°æ® é‡åšï¼Œundoä¸­çš„æ•°æ®  å›æ»šï¼Œè¿™ä¸ªå‘½ä»¤ä¸éœ€è¦è¿æ¥æœåŠ¡ç«¯ï¼Œæ‰€ä»¥æ¢å¤æ•°æ®çš„æ—¶å€™å¯ä»¥åœåº“</span><br><span class="line">è¿™ä¸ªé‡åšè¦å°å¿ƒè°¨æ…ï¼Œè¿™ä¸ªæ˜¯ä¸€æ¬¡æ€§çš„ï¼Œåšå®Œäº†è¿™æ¬¡å¤‡ä»½å°±ä¸èƒ½ç”¨äº†ï¼Œåé¢æœ‰å¢é‡æ•°æ®ï¼Œå°±ä¸èƒ½ä»è¿™ä¸ªçš„åŸºç¡€ä¸Šåšå¢é‡å¤‡ä»½äº†</span><br><span class="line">innobackupex --apply-log +å…¨å¤‡çš„è·¯å¾„</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log /backup/2024-08-22_16-05-44/</span><br><span class="line"></span><br><span class="line">4ã€#æ¨¡æ‹Ÿå®Œæˆï¼ŒæŸ¥çœ‹ç›®å½•ï¼Œå¤šäº†å¥½å‡ ä¸ªä¸œè¥¿</span><br><span class="line">[root@db02 ~]# ll /backup/2024-08-22_16-05-44/</span><br><span class="line"></span><br><span class="line">5ã€#æ¢å¤  æ¸…ç©ºdataç›®å½•</span><br><span class="line">[root@db02 ~]# <span class="built_in">rm</span> -rf /app/mysql-5.6.50/data</span><br><span class="line">æ¢å¤æ•°æ®</span><br><span class="line">innobackupex --copy-bak +å…¨å¤‡çš„è·¯å¾„</span><br><span class="line">[root@db02 ~]# innobackupex --copy-back /backup/2024-08-22_16-54-47/</span><br><span class="line">æˆæƒ</span><br><span class="line">[root@db02 ~]# <span class="built_in">chown</span> -R mysql.mysql /app/mysql-5.6.50/data</span><br><span class="line">å¯åŠ¨</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start</span><br><span class="line">æŸ¥çœ‹æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|       53 |</span><br><span class="line">+----------+</span><br><span class="line"></span><br><span class="line">----------------------ä¸ç”¨è¿™ç§æ–¹æ³•ï¼šè¿™ä¸ªæ–¹æ³•æ˜¯åº•å±‚åŸç†---------------------</span><br><span class="line">5ã€#æ¢å¤  æ¸…ç©ºdataç›®å½•</span><br><span class="line">[root@db02 ~]# <span class="built_in">rm</span> -rf /app/mysql-5.6.50/data</span><br><span class="line">æ¢å¤æ•°æ®</span><br><span class="line">[root@db02 ~]# <span class="built_in">mv</span> /backup/2024-08-22_16-05-44/ /app/mysql-5.6.50/data</span><br><span class="line">æˆæƒ</span><br><span class="line">[root@db02 ~]# <span class="built_in">chown</span> -R mysql.mysql /app/mysql-5.6.50/data</span><br><span class="line">å¯åŠ¨</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start</span><br><span class="line">æŸ¥çœ‹æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|       53 |</span><br><span class="line">+----------+</span><br><span class="line">----------------------------------------------------------</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‰§è¡Œè„šæœ¬</span><br><span class="line">[root@db02 ~]# sh insert.sh </span><br><span class="line"></span><br><span class="line">2ã€ç­‰å¾…ä¸€ä¼š åšå…¨å¤‡</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=<span class="string">&#x27;123&#x27;</span> /backup</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹æ•°æ®é‡Œé¢æ˜¯å¦æœ‰æ•°æ®ï¼Œå¹¶åˆ é™¤æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|      211 |</span><br><span class="line">+----------+</span><br><span class="line">root@localhost:(none) &gt; drop database prod;</span><br><span class="line"></span><br><span class="line">4ã€ç­‰å¾…ä¸€ä¼šï¼Œåœæ­¢è„šæœ¬ï¼Œè¿›è¡Œæ•°æ®çš„æ¢å¤</span><br><span class="line">[root@db02 ~]# sh insert.sh ^C</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line">æ¨¡æ‹ŸCSR</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log /backup/2024-08-22_17-09-10/</span><br><span class="line">æ¨¡æ‹Ÿå®Œæˆï¼ŒæŸ¥çœ‹ç›®å½•ï¼Œå¤šäº†å¥½å‡ ä¸ªä¸œè¥¿</span><br><span class="line">[root@db02 ~]# ll /backup/2024-08-22_17-09-10/</span><br><span class="line">[root@db02 ~]# innobackupex --copy-back /backup/2024-08-22_17-09-10/</span><br><span class="line">[root@db02 ~]# <span class="built_in">chown</span> -R mysql.mysql /app/mysql-5.6.50/data</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start</span><br><span class="line">æŸ¥çœ‹æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|      113 |</span><br><span class="line">+----------+</span><br></pre></td></tr></table></figure><p><strong>å¢é‡å¤‡ä»½å’Œæ¢å¤</strong></p><p>å¤‡ä»½æ–¹å¼<br>1ï¼‰åŸºäºä¸Šä¸€æ¬¡å¤‡ä»½è¿›è¡Œå¢é‡<br>2ï¼‰å¢é‡å¤‡ä»½æ— æ³•å•ç‹¬æ¢å¤ï¼Œå¿…é¡»åŸºäºå…¨å¤‡è¿›è¡Œæ¢å¤<br>3ï¼‰æ‰€æœ‰å¢é‡å¿…é¡»è¦æŒ‰é¡ºåºåˆå¹¶åˆ°å…¨å¤‡å½“ä¸­</p><p>1ã€å¤‡ä»½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‰§è¡Œè„šæœ¬</span><br><span class="line">[root@db02 ~]# sh insert.sh </span><br><span class="line"></span><br><span class="line">2ã€å…¨å¤‡  ç­‰å¾…ä¸€ä¼š åšå…¨å¤‡ä¸å¸¦æ—¶é—´æˆ³ï¼Œå¹¶æŸ¥çœ‹ä½ç½®ç‚¹</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp /backup/full_$(<span class="built_in">date</span> +%F)</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_checkpoints </span><br><span class="line">backup_type = full-backuped</span><br><span class="line">from_lsn = 0</span><br><span class="line">to_lsn = 3252565</span><br><span class="line">last_lsn = 3260144</span><br><span class="line"></span><br><span class="line">3ã€ç¬¬ä¸€æ¬¡å¢é‡å¤‡ä»½</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/full_2024-08-22 /backup/inc1_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc1_2024-08-22-17/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 3252565   <span class="comment">#è¦å’Œå…¨å¤‡çš„to_lsnä¸€æ ·</span></span><br><span class="line">to_lsn = 3473250</span><br><span class="line">last_lsn = 3477650</span><br><span class="line"></span><br><span class="line">4ã€ç¬¬äºŒæ¬¡å¢å¤‡</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/inc1_2024-08-22-17 /backup/inc2_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc2_2024-08-22-17/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 3473250   <span class="comment">#è¦å’Œinc1çš„to_lsnä¸€æ ·</span></span><br><span class="line">to_lsn = 3540803</span><br><span class="line">last_lsn = 3554601</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€ç¬¬ä¸‰æ¬¡å¢å¤‡</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/inc2_2024-08-22-17 /backup/inc3_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc3_2024-08-22-18/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 3540803   <span class="comment">#è¦å’Œinc2çš„to_lsnä¸€æ ·</span></span><br><span class="line">to_lsn = 3576288</span><br><span class="line">last_lsn = 3590568</span><br><span class="line"></span><br><span class="line">6ã€ç¬¬å››æ¬¡å¢å¤‡</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/inc3_2024-08-22-18 /backup/inc4_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc4_2024-08-22-18/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 3576288</span><br><span class="line">to_lsn = 3625448</span><br><span class="line">last_lsn = 3626012</span><br><span class="line"></span><br><span class="line">ç¬¬å››æ¬¡å¢é‡å¤‡ä»½ä¹‹åçš„æ•°æ®åªèƒ½å»binlogé‡Œé¢å»æŸ¥æ‰¾</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# ll /backup</span><br><span class="line">drwxr-x--- 8 root root  268 Aug 22 17:42 full_2024-08-22</span><br><span class="line">drwxr-x--- 7 root root  267 Aug 22 17:53 inc1_2024-08-22-17</span><br><span class="line">drwxr-x--- 7 root root  267 Aug 22 17:58 inc2_2024-08-22-17</span><br><span class="line">drwxr-x--- 7 root root  267 Aug 22 18:00 inc3_2024-08-22-18</span><br><span class="line">drwxr-x--- 7 root root  267 Aug 22 18:02 inc4_2024-08-22-18</span><br><span class="line"></span><br><span class="line">å½“å‰ç³»ç»Ÿæ—¶é—´-1h</span><br><span class="line"><span class="built_in">date</span> +%F-%H -d <span class="string">&#x27;-1hour&#x27;</span></span><br><span class="line"><span class="built_in">date</span> +%F-%H -d <span class="string">&#x27;-1day&#x27;</span></span><br><span class="line"><span class="built_in">date</span> +%F-%H -d <span class="string">&#x27;-1minute&#x27;</span></span><br></pre></td></tr></table></figure><p>2ã€æ¢å¤</p><p>1ï¼‰full+inc1+inc2+inc3+inc4<br>2ï¼‰éœ€è¦å°†inc1å’Œinc2æŒ‰é¡ºåºåˆå¹¶åˆ°fullä¸­<br>3ï¼‰åˆ†æ­¥éª¤è¿›è¡Œâ€“apply-log</p><p><img src="../image/study_img/image-20240822114534116.png" alt="image-20240822114534116"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">1ã€#å…ˆæŸ¥çœ‹é‡Œé¢æœ‰å¤šå°‘æ•°æ®ï¼Œå†åˆ é™¤prodåº“</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     2181 |</span><br><span class="line">+----------+</span><br><span class="line">root@localhost:(none) &gt; drop database prod;</span><br><span class="line">è„šæœ¬å¼€å§‹æŠ¥é”™æ— æ³•å†™å…¥æ•°æ®ï¼Œåœæ­¢è„šæœ¬å³å¯</span><br><span class="line">[root@db02 ~]# sh insert.sh ^C</span><br><span class="line"></span><br><span class="line">2ã€#åœæ­¢æ•°æ®åº“</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line"></span><br><span class="line">3ã€#æŒªèµ°dataç›®å½•</span><br><span class="line">[root@db02 ~]# <span class="built_in">mv</span> /app/mysql-5.6.50/data /tmp/</span><br><span class="line"></span><br><span class="line">4ã€#ç¬¬ä¸€æ­¥ï¼šåœ¨å…¨å¤‡ä¸­apply-logæ—¶ï¼Œåªåº”ç”¨redoï¼Œä¸åº”ç”¨undo    æŠŠå¢å¤‡æŒ‰ç…§é¡ºåºåˆå¹¶åˆ°å…¨å¤‡</span><br><span class="line">å…¨å¤‡æ¨¡æ‹ŸCSRåªåšredoï¼Œä¸åšundo,å› ä¸ºä¸€æ¡æ•°æ®å†™è¿›æ¥ï¼Œæ²¡æœ‰æäº¤å…¨å¤‡åšå®Œäº†ï¼Œä½†åœ¨ä¸‹ä¸€ä¸ªå¢å¤‡é‡Œé¢æäº¤äº†ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™æŠŠundoåšäº†ï¼Œæ•°æ®å°±å›æ»šäº†</span><br><span class="line">innobackupex --apply-log --redo-noly /backup/å…¨å¤‡</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --redo-only /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_checkpoints</span><br><span class="line">backup_type = log-applied  <span class="comment">#çŠ¶æ€å˜äº†</span></span><br><span class="line">from_lsn = 0</span><br><span class="line">to_lsn = 3252565</span><br><span class="line">last_lsn = 3260144</span><br><span class="line"><span class="comment">#æŸ¥çœ‹å…¨å¤‡çš„ä½ç½®ç‚¹æœ‰æ— å˜åŒ–å¹¶è®°å½•ä¸‹æ¥</span></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001       </span><br><span class="line"></span><br><span class="line">5ã€#ç¬¬äºŒæ­¥ï¼šåˆå¹¶inc1åˆå¹¶åˆ°fullä¸­ï¼Œå¹¶ä¸”apply-logï¼Œåªåº”ç”¨redoï¼Œä¸åº”ç”¨undo</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --redo-only --incremental-dir=/backup/inc1_2024-08-22-17 /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc1_2024-08-22-17/xtrabackup_checkpoints</span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 3252565</span><br><span class="line">to_lsn = 3473250</span><br><span class="line">last_lsn = 3477650</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001  </span><br><span class="line"></span><br><span class="line">6ã€#ç¬¬ä¸‰æ­¥ï¼šåˆå¹¶inc2åˆå¹¶åˆ°fullä¸­ï¼Œåªåšredoï¼Œä¸åšundo</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --redo-only --incremental-dir=/backup/inc2_2024-08-22-17 /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc2_2024-08-22-17/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 3473250</span><br><span class="line">to_lsn = 3540803</span><br><span class="line">last_lsn = 3554601</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001  </span><br><span class="line"></span><br><span class="line">7ã€#ç¬¬å››æ­¥ï¼šåˆå¹¶inc3åˆå¹¶åˆ°fullä¸­ï¼Œåªåšredoï¼Œä¸åšundo</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --redo-only --incremental-dir=/backup/inc3_2024-08-22-18 /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc3_2024-08-22-18/xtrabackup_checkpoints</span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 3540803</span><br><span class="line">to_lsn = 3576288</span><br><span class="line">last_lsn = 3590568</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001  </span><br><span class="line"></span><br><span class="line">8ã€#ç¬¬äº”æ­¥ï¼šåˆå¹¶inc4ï¼ˆæœ€åä¸€æ¬¡ï¼‰åˆå¹¶åˆ°fullä¸­ï¼Œredoå’Œundoéƒ½åš</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --incremental-dir=/backup/inc4_2024-08-22-18 /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc4_2024-08-22-18/xtrabackup_checkpoints</span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 3576288</span><br><span class="line">to_lsn = 3625448</span><br><span class="line">last_lsn = 3626012</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001  </span><br><span class="line"></span><br><span class="line">9ã€#å°†å…¨å¤‡--apply-logï¼Œredoå’Œundoéƒ½åº”ç”¨</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">10ã€#æ¢å¤æ•°æ®</span><br><span class="line">[root@db02 ~]# innobackupex --copy-back /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">11ã€#æˆæƒ  å¯åŠ¨</span><br><span class="line">[root@db02 ~]# <span class="built_in">chown</span> -R mysql.mysql /app/mysql-5.6.50/data</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line">12ã€#è¿æ¥è¿›å»æŸ¥çœ‹ä¸€ä¸‹æ•°æ®æ˜¯å¦å¯¹å¾—ä¸Š</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     1517 |</span><br><span class="line">+----------+  <span class="comment">#å¯ä»¥çœ‹åˆ°æ•°æ®å°‘äº†ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†æ•°æ®ï¼Œåœ¨binlogé‡Œé¢</span></span><br><span class="line"></span><br><span class="line">13ã€#æˆªå–binlog</span><br><span class="line">åˆå¹¶å®Œäº†ï¼Œè¿™ä¸ªbinlogçš„ä½ç½®ç‚¹ä¹Ÿä¼šåˆå¹¶</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001        282633</span><br><span class="line">å¼€å§‹ä½ç½®ç‚¹ï¼š282633</span><br><span class="line"></span><br><span class="line">ç”±äºä¹‹å‰çš„dataç›®å½•è¢«æŒªåˆ°tmpäº†</span><br><span class="line">[root@db02 ~]# mysqlbinlog --base64-output=decode-rows /tmp/data/mysql-bin.000001 |grep  -iC 10 <span class="string">&#x27;drop database&#x27;</span></span><br><span class="line">ç»“æŸä½ç½®ç‚¹ï¼š407253</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# mysqlbinlog --start-position=282633 --stop-position=407253 /tmp/data/mysql-bin.000001 &gt; /tmp/inc5.sql</span><br><span class="line"></span><br><span class="line">14ã€#è¿›å…¥æ•°æ®åº“</span><br><span class="line">å…³é—­binlog,é˜²æ­¢binlogè¢«æ±¡æŸ“ï¼Œè®©binlogä»120å¼€å§‹</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> sql_log_bin=0;</span><br><span class="line"></span><br><span class="line">å¯¼å…¥æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">source</span> /tmp/inc5.sql</span><br><span class="line"></span><br><span class="line">å¼€å¯binlog</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> sql_log_bin=1;</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹æ•°æ®ï¼Œå·²ç»æ¢å¤</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     2187 |</span><br><span class="line">+----------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¢é‡å¤‡ä»½æŒºéº»çƒ¦çš„ æ‰€ä»¥ä¼ä¸šé‡Œé¢éƒ½æ˜¯åšå·®å¼‚å¤‡ä»½</span><br><span class="line">ä½†æ˜¯å·®å¼‚å¤‡ä»½æ¯”è¾ƒå ç£ç›˜ç©ºé—´</span><br></pre></td></tr></table></figure><p><strong>ä¼ä¸šçº§å¢é‡æ¢å¤å®æˆ˜</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">èƒŒæ™¯ï¼š</span><br><span class="line">æŸå¤§å‹ç½‘ç«™ï¼Œmysqlæ•°æ®åº“ï¼Œæ•°æ®é‡500Gï¼Œæ¯æ—¥æ›´æ–°é‡100M-200M</span><br><span class="line"></span><br><span class="line">å¤‡ä»½ç­–ç•¥ï¼š</span><br><span class="line">xtrabackupï¼Œæ¯å‘¨å…­0:00è¿›è¡Œå…¨å¤‡ï¼Œå‘¨ä¸€åˆ°å‘¨äº”åŠå‘¨æ—¥00:00è¿›è¡Œå¢é‡å¤‡ä»½ã€‚</span><br><span class="line"></span><br><span class="line">æ•…éšœåœºæ™¯ï¼š</span><br><span class="line">å‘¨ä¸‰ä¸‹åˆ2ç‚¹å‡ºç°æ•°æ®åº“æ„å¤–åˆ é™¤è¡¨æ“ä½œã€‚</span><br><span class="line">å¦‚ä½•æ¢å¤ï¼Ÿï¼Ÿï¼Ÿ</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…¨å¤‡+å¢å¤‡+binlog</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240822201507914.png" alt="image-20240822201507914"></p><p>1ã€æ¨¡æ‹Ÿå¤‡ä»½åˆ æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">1ã€#æ‰§è¡Œå†™æ•°æ®çš„è„šæœ¬</span><br><span class="line">[root@db02 ~]# sh insert.sh </span><br><span class="line"></span><br><span class="line">2ã€#ç­‰å¾…ä¸€ä¼šï¼Œå…¨å¤‡ (å‘¨å…­)</span><br><span class="line">[root@db02 ~]# <span class="built_in">rm</span> -rf /backup/*</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp /backup/full_$(<span class="built_in">date</span> +%F)</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_checkpoints </span><br><span class="line">backup_type = full-backuped</span><br><span class="line">from_lsn = 0</span><br><span class="line">to_lsn = 4215962</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#ç­‰å¾…ä¸€ä¼šï¼Œå¢å¤‡inc1 (å‘¨æ—¥)</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/full_2024-08-22/ /backup/inc1_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc1_2024-08-22-20/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 4215962</span><br><span class="line">to_lsn = 4333233</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€#ç­‰å¾…ä¸€ä¼šï¼Œå¢å¤‡inc2 (å‘¨ä¸€)</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/inc1_2024-08-22-20/ /backup/inc2_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc2_2024-08-22-20/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 4333233</span><br><span class="line">to_lsn = 4395658</span><br><span class="line"></span><br><span class="line">5ã€#ç­‰å¾…ä¸€ä¼šï¼Œå¢å¤‡inc3 (å‘¨äºŒ)</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/inc2_2024-08-22-20/ /backup/inc3_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc3_2024-08-22-20/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 4395658</span><br><span class="line">to_lsn = 4411035</span><br><span class="line"></span><br><span class="line">6ã€#ç­‰å¾…ä¸€ä¼šï¼Œå¢å¤‡inc4 (å‘¨ä¸‰)</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/inc3_2024-08-22-20/ /backup/inc4_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc4_2024-08-22-20/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 4411035</span><br><span class="line">to_lsn = 4455757</span><br><span class="line"></span><br><span class="line">7ã€#å‘¨ä¸‰ä¸‹åˆ2ç‚¹å‡ºç°æ•°æ®åº“æ„å¤–åˆ é™¤è¡¨æ“ä½œï¼Œå…ˆæŸ¥çœ‹æ•°æ®ï¼Œå†åˆ è¡¨</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     1199 |</span><br><span class="line">+----------+</span><br><span class="line">root@localhost:(none) &gt; drop table prod.prod;</span><br><span class="line">åœæ­¢è„šæœ¬è¿è¡Œ</span><br><span class="line">[root@db02 ~]# sh insert.sh ^C</span><br></pre></td></tr></table></figure><p>2ã€æ¢å¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">1ã€#åœæ­¢æ•°æ®åº“</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line"></span><br><span class="line">3ã€#æŒªèµ°dataç›®å½•</span><br><span class="line">[root@db02 ~]# <span class="built_in">mv</span> /app/mysql-5.6.50/data /tmp/</span><br><span class="line"></span><br><span class="line">2ã€#ç¬¬ä¸€æ­¥ï¼šåœ¨å…¨å¤‡ä¸­apply-logæ—¶ï¼Œåªåº”ç”¨redoï¼Œä¸åº”ç”¨undo</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --redo-only /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_checkpoints </span><br><span class="line">backup_type = log-applied</span><br><span class="line">from_lsn = 0</span><br><span class="line">to_lsn = 4215962</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001        55527</span><br><span class="line"></span><br><span class="line">3ã€#ç¬¬äºŒæ­¥ï¼šåˆå¹¶inc1åˆå¹¶åˆ°fullä¸­ï¼Œå¹¶ä¸”apply-logï¼Œåªåº”ç”¨redoï¼Œä¸åº”ç”¨undo  (å‘¨æ—¥å’Œå‘¨å…­åˆå¹¶)</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --redo-only --incremental-dir=/backup/inc1_2024-08-22-20 /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc1_2024-08-22-20/xtrabackup_checkpoints</span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 4215962</span><br><span class="line">to_lsn = 4333233</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc1_2024-08-22-20/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001        112629</span><br><span class="line"></span><br><span class="line">4ã€#ç¬¬ä¸‰æ­¥ï¼šåˆå¹¶inc2åˆå¹¶åˆ°fullä¸­ï¼Œåªåšredoï¼Œä¸åšundo    (å‘¨ä¸€å’Œå‘¨å…­åˆå¹¶)</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --redo-only --incremental-dir=/backup/inc2_2024-08-22-20 /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc2_2024-08-22-20/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 4333233</span><br><span class="line">to_lsn = 4395658</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc2_2024-08-22-20/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001        144249</span><br><span class="line"></span><br><span class="line">5ã€#ç¬¬å››æ­¥ï¼šåˆå¹¶inc3åˆå¹¶åˆ°fullä¸­ï¼Œåªåšredoï¼Œä¸åšundo    (å‘¨äºŒå’Œå‘¨å…­åˆå¹¶)</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --redo-only --incremental-dir=/backup/inc3_2024-08-22-20 /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc3_2024-08-22-20/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 4395658</span><br><span class="line">to_lsn = 4411035</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc3_2024-08-22-20/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001        163965</span><br><span class="line"></span><br><span class="line">6ã€#ç¬¬äº”æ­¥ï¼šåˆå¹¶inc4ï¼ˆæœ€åä¸€æ¬¡ï¼‰åˆå¹¶åˆ°fullä¸­ï¼Œredoå’Œundoéƒ½åš   (å‘¨ä¸‰å’Œå‘¨å…­åˆå¹¶)</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --incremental-dir=/backup/inc4_2024-08-22-20 /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc4_2024-08-22-20/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 4411035</span><br><span class="line">to_lsn = 4455757</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc4_2024-08-22-20/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001        186099</span><br><span class="line"></span><br><span class="line">7ã€#å°†å…¨å¤‡--apply-logï¼Œredoå’Œundoéƒ½åº”ç”¨</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">8ã€#æ¢å¤æ•°æ®</span><br><span class="line">[root@db02 ~]# innobackupex --copy-back /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">9ã€#æˆæƒ  å¯åŠ¨</span><br><span class="line">[root@db02 ~]# <span class="built_in">chown</span> -R mysql.mysql /app/mysql-5.6.50/data</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line">10ã€#è¿æ¥è¿›å»æŸ¥çœ‹ä¸€ä¸‹æ•°æ®æ˜¯å¦å¯¹å¾—ä¸Š</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|      998 |</span><br><span class="line">+----------+  <span class="comment">#å¯ä»¥çœ‹åˆ°æ•°æ®å°‘äº†ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†æ•°æ®ï¼Œåœ¨binlogé‡Œé¢</span></span><br><span class="line"></span><br><span class="line">11ã€#æˆªå–binlog</span><br><span class="line">åˆå¹¶å®Œäº†ï¼Œè¿™ä¸ªbinlogçš„ä½ç½®ç‚¹ä¹Ÿä¼šåˆå¹¶</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001        186099</span><br><span class="line">å¼€å§‹ä½ç½®ç‚¹ï¼š186099</span><br><span class="line">ç”±äºä¹‹å‰çš„dataç›®å½•è¢«æŒªåˆ°tmpäº†</span><br><span class="line">[root@db02 ~]# mysqlbinlog --base64-output=decode-rows /tmp/data/mysql-bin.000001 |grep  -iC 10 <span class="string">&#x27;drop table&#x27;</span></span><br><span class="line">ç»“æŸä½ç½®ç‚¹ï¼š223640</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# mysqlbinlog --start-position=186099 --stop-position=223640 /tmp/data/mysql-bin.000001 &gt; /tmp/inc5.sql</span><br><span class="line"></span><br><span class="line">12ã€#è¿›å…¥æ•°æ®åº“</span><br><span class="line">å…³é—­binlog,é˜²æ­¢binlogè¢«æ±¡æŸ“ï¼Œè®©binlogä»120å¼€å§‹</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> sql_log_bin=0;</span><br><span class="line"></span><br><span class="line">å¯¼å…¥æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">source</span> /tmp/inc5.sql</span><br><span class="line"></span><br><span class="line">å¼€å¯binlog</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> sql_log_bin=1;</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹æ•°æ®ï¼Œå·²ç»æ¢å¤</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     1199 |</span><br><span class="line">+----------+</span><br></pre></td></tr></table></figure><p><strong>xtrabackupexè¿›è¡Œå·®å¼‚å¤‡ä»½</strong></p><p><img src="../image/study_img/image-20240822212220010.png" alt="image-20240822212220010"></p><p><img src="../image/study_img/image-20240822214839115.png" alt="image-20240822214839115"></p><p>1ã€æ¨¡æ‹Ÿå¤‡ä»½åˆ æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">1ã€#æ‰§è¡Œå†™æ•°æ®çš„è„šæœ¬</span><br><span class="line">[root@db02 ~]# sh insert.sh </span><br><span class="line"></span><br><span class="line">2ã€#ç­‰å¾…ä¸€ä¼šï¼Œå…¨å¤‡ (å‘¨å…­)</span><br><span class="line">[root@db02 ~]# <span class="built_in">rm</span> -rf /backup/*</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp /backup/full_$(<span class="built_in">date</span> +%F)</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_checkpoints </span><br><span class="line">backup_type = full-backuped</span><br><span class="line">from_lsn = 0</span><br><span class="line">to_lsn = 4915321</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#ç­‰å¾…ä¸€ä¼šï¼Œå·®å¼‚å¤‡inc1 (å‘¨æ—¥)</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/full_2024-08-22/ /backup/inc1_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc1_2024-08-22-21/xtrabackup_checkpoints</span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 4915321</span><br><span class="line">to_lsn = 4987544</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€#ç­‰å¾…ä¸€ä¼šï¼Œå·®å¼‚å¤‡inc2 (å‘¨ä¸€)</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/full_2024-08-22/ /backup/inc2_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc2_2024-08-22-21/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = </span><br><span class="line">to_lsn = </span><br><span class="line"></span><br><span class="line">5ã€#ç­‰å¾…ä¸€ä¼šï¼Œå·®å¼‚å¤‡inc3 (å‘¨äºŒ)</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/full_2024-08-22/ /backup/inc3_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc3_2024-08-22-21/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = </span><br><span class="line">to_lsn = </span><br><span class="line"></span><br><span class="line">6ã€#ç­‰å¾…ä¸€ä¼šï¼Œå·®å¼‚å¤‡inc4 (å‘¨ä¸‰)</span><br><span class="line">[root@db02 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/full_2024-08-22/ /backup/inc4_$(<span class="built_in">date</span> +%F-%H)</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc4_2024-08-22-21/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = </span><br><span class="line">to_lsn = </span><br><span class="line"></span><br><span class="line">7ã€#å‘¨ä¸‰ä¸‹åˆ2ç‚¹å‡ºç°æ•°æ®åº“æ„å¤–åˆ é™¤è¡¨æ“ä½œï¼Œå…ˆæŸ¥çœ‹æ•°æ®ï¼Œå†åˆ è¡¨</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|      497 |</span><br><span class="line">+----------+</span><br><span class="line">root@localhost:(none) &gt; drop table prod.prod;</span><br><span class="line">åœæ­¢è„šæœ¬è¿è¡Œ</span><br><span class="line">[root@db02 ~]# sh insert.sh ^C</span><br></pre></td></tr></table></figure><p>2ã€æ¢å¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">1ã€#åœæ­¢æ•°æ®åº“</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld stop</span><br><span class="line"></span><br><span class="line">3ã€#æŒªèµ°dataç›®å½•</span><br><span class="line">[root@db02 ~]# <span class="built_in">mv</span> /app/mysql-5.6.50/data /tmp/</span><br><span class="line"></span><br><span class="line">2ã€#ç¬¬ä¸€æ­¥ï¼šåœ¨å…¨å¤‡ä¸­apply-logæ—¶ï¼Œåªåº”ç”¨redoï¼Œä¸åº”ç”¨undo</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --redo-only /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_checkpoints </span><br><span class="line">backup_type = log-applied</span><br><span class="line">from_lsn = 0</span><br><span class="line">to_lsn = 4915321</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001        9399</span><br><span class="line"></span><br><span class="line">3ã€#ç¬¬äºŒæ­¥ï¼šåˆå¹¶inc4ï¼ˆæœ€åä¸€æ¬¡çš„å·®å¼‚å¤‡ä»½ï¼‰åˆ°fullä¸­ï¼Œredoå’Œundoéƒ½åš   (å‘¨ä¸‰å’Œå‘¨å…­åˆå¹¶)</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log --incremental-dir=/backup/inc4_2024-08-22-21 /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc4_2024-08-22-21/xtrabackup_checkpoints </span><br><span class="line">backup_type = incremental</span><br><span class="line">from_lsn = 4915321</span><br><span class="line">to_lsn = 5067923</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/inc4_2024-08-22-21/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001         85473</span><br><span class="line"></span><br><span class="line">4ã€#å°†å…¨å¤‡--apply-logï¼Œredoå’Œundoéƒ½åº”ç”¨</span><br><span class="line">[root@db02 ~]# innobackupex --apply-log /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">5ã€#æ¢å¤æ•°æ®</span><br><span class="line">[root@db02 ~]# innobackupex --copy-back /backup/full_2024-08-22/</span><br><span class="line"></span><br><span class="line">6ã€#æˆæƒ  å¯åŠ¨</span><br><span class="line">[root@db02 ~]# <span class="built_in">chown</span> -R mysql.mysql /app/mysql-5.6.50/data</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line">7ã€#è¿æ¥è¿›å»æŸ¥çœ‹ä¸€ä¸‹æ•°æ®æ˜¯å¦å¯¹å¾—ä¸Š</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|      457 |</span><br><span class="line">+----------+  <span class="comment">#å¯ä»¥çœ‹åˆ°æ•°æ®å°‘äº†ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†æ•°æ®ï¼Œåœ¨binlogé‡Œé¢</span></span><br><span class="line"></span><br><span class="line">8ã€#æˆªå–binlog</span><br><span class="line">åˆå¹¶å®Œäº†ï¼Œè¿™ä¸ªbinlogçš„ä½ç½®ç‚¹ä¹Ÿä¼šåˆå¹¶</span><br><span class="line">[root@db02 ~]# <span class="built_in">cat</span> /backup/full_2024-08-22/xtrabackup_binlog_info </span><br><span class="line">mysql-bin.000001        85473</span><br><span class="line">å¼€å§‹ä½ç½®ç‚¹ï¼š85473</span><br><span class="line">ç”±äºä¹‹å‰çš„dataç›®å½•è¢«æŒªåˆ°tmpäº†</span><br><span class="line">[root@db02 ~]# mysqlbinlog --base64-output=decode-rows /tmp/data/mysql-bin.000001 |grep  -iC 10 <span class="string">&#x27;drop table&#x27;</span></span><br><span class="line">ç»“æŸä½ç½®ç‚¹ï¼š93068</span><br><span class="line"></span><br><span class="line">[root@db02 ~]# mysqlbinlog --start-position=85473 --stop-position=93068 /tmp/data/mysql-bin.000001 &gt; /tmp/inc5.sql</span><br><span class="line"></span><br><span class="line">9ã€#è¿›å…¥æ•°æ®åº“</span><br><span class="line">å…³é—­binlog,é˜²æ­¢binlogè¢«æ±¡æŸ“ï¼Œè®©binlogä»120å¼€å§‹</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> sql_log_bin=0;</span><br><span class="line"></span><br><span class="line">å¯¼å…¥æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">source</span> /tmp/inc5.sql</span><br><span class="line"></span><br><span class="line">å¼€å¯binlog</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> sql_log_bin=1;</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹æ•°æ®ï¼Œå·²ç»æ¢å¤</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> count(*) from prod.prod;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|      497 |</span><br><span class="line">+----------+  <span class="comment">#å·®å¼‚å¤‡ä»½æ¢å¤å®Œæˆ</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ¬ç¯‡æ–‡ç« ä»‹ç»äº†mysqlçš„æ—¥å¿—ï¼Œåˆ©ç”¨mysqlçš„binlogå¯¹è¿›è¡Œæˆªå–å’Œæ¢å¤æ•°æ®ï¼Œä»‹ç»ä½¿ç”¨å¤‡ä»½å·¥å…·å¯¹æ•°æ®è¿›è¡Œå¤‡ä»½çš„æ¡ˆä¾‹</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Mysqlå­˜å‚¨å¼•æ“å’ŒDTL</title>
    <link href="https://www.fomal.cc/posts/23751c6b.html"/>
    <id>https://www.fomal.cc/posts/23751c6b.html</id>
    <published>2024-09-21T09:43:45.000Z</published>
    <updated>2024-09-21T11:19:03.299Z</updated>
    
    <content type="html"><![CDATA[<h3 id="mysqlå­˜å‚¨å¼•æ“-DTL">mysqlå­˜å‚¨å¼•æ“&amp;DTL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.idb ç»“å°¾çš„æ–‡ä»¶å«è¡¨ç©ºé—´</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MySQLå¼•æ“åŠŸèƒ½ï¼š</span><br><span class="line">é™¤äº†å¯ä»¥æä¾›åŸºæœ¬çš„å­˜å–åŠŸèƒ½ï¼Œè¿˜æœ‰æ›´å¤šåŠŸèƒ½äº‹åŠ¡åŠŸèƒ½ã€é”å®šã€å¤‡ä»½å’Œæ¢å¤ã€ä¼˜åŒ–ä»¥åŠç‰¹æ®ŠåŠŸèƒ½</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MySQL æä¾›ä»¥ä¸‹å­˜å‚¨å¼•æ“:</span><br><span class="line"><span class="string">&#x27;01ï¼‰InnoDB&#x27;</span>    <span class="comment">#ä¸»æµçš„</span></span><br><span class="line"><span class="string">&#x27;02ï¼‰MyISAM&#x27;</span></span><br><span class="line">03ï¼‰MEMORY</span><br><span class="line">04ï¼‰ARCHIVE</span><br><span class="line">05ï¼‰FEDERATED</span><br><span class="line">06ï¼‰EXAMPLE</span><br><span class="line">07ï¼‰BLACKHOLE</span><br><span class="line">08ï¼‰MERGE</span><br><span class="line">09ï¼‰NDBCLUSTER</span><br><span class="line">10ï¼‰CSV</span><br><span class="line"></span><br><span class="line">æ•°æ®å®šä¹‰è¯­è¨€ï¼Œå»ºåº“å»ºè¡¨</span><br></pre></td></tr></table></figure><p>mysqlè‡ªå¸¦çš„å­˜å‚¨å¼•æ“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹mysqlè‡ªå¸¦çš„å­˜å‚¨å¼•æ“</span></span><br><span class="line">root@localhost:(none) &gt; show engines;</span><br><span class="line">+--------------------+</span><br><span class="line">| Engine             |</span><br><span class="line">+--------------------+</span><br><span class="line">| FEDERATED          |</span><br><span class="line">| MRG_MYISAM         |</span><br><span class="line">| MyISAM             |#</span><br><span class="line">| BLACKHOLE          |</span><br><span class="line">| CSV                |</span><br><span class="line">| MEMORY             |</span><br><span class="line">| ARCHIVE            |</span><br><span class="line">| InnoDB             | <span class="comment">#</span></span><br><span class="line">| PERFORMANCE_SCHEMA |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹mysqlæ•°æ®åº“ä¸­å“ªäº›è¡¨ä½¿ç”¨çš„å­˜å‚¨å¼•æ“æ˜¯InnoDB</span></span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> * from information_schema.tables  <span class="built_in">where</span> ENGINE=<span class="string">&#x27;InnoDB&#x27;</span>\G;</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æ•°æ®åº“ä¸­å“ªäº›è¡¨æ˜¯myisam</span></span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> * from information_schema.tables <span class="built_in">where</span> engine=<span class="string">&#x27;myisam&#x27;</span>\G</span><br></pre></td></tr></table></figure><p><strong>InnoDBå’Œmyisamçš„åŒºåˆ«</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#é¢è¯•é—®é¢˜InnoDBå’Œmyisamçš„åŒºåˆ«</span></span><br><span class="line">mysiamçš„ç‰©ç†æ–‡ä»¶æœ‰3ä¸ªï¼ŒInodbçš„ç‰©ç†æ–‡ä»¶æœ‰2ä¸ª</span><br><span class="line">Inodbæ˜¯è¡Œçº§é”ï¼Œmysiamæ˜¯è¡¨çº§é”</span><br><span class="line">inodbæ”¯æŒäº‹åŠ¡ï¼Œredoå’Œundoæ˜¯å®ç°CSRè¿‡ç¨‹çš„2ä¸ªäº‹åŠ¡æ—¥å¿—ï¼Œæ‰€ä»¥æœ‰CSRè‡ªåŠ¨æ•…éšœæ¢å¤ï¼›</span><br><span class="line">mysiamä¸æ”¯æŒäº‹åŠ¡ï¼Œæ²¡æœ‰redoå’Œundoï¼Œæ²¡æœ‰CSRè‡ªåŠ¨æ•…éšœæ¢å¤</span><br><span class="line">Inodbæ˜¯è¡Œçº§é”ï¼Œæ”¯æŒMVCCé«˜ç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼›mysiamä¸æ”¯æŒï¼Œå› ä¸ºmysiamæ˜¯è¡¨çº§é”(æ”¹ä¸€è¡Œï¼Œæ•´ä¸ªè¡¨éƒ½é”äº†)</span><br><span class="line">é«˜ç‰ˆæœ¬å¹¶å‘æ§åˆ¶ç±»ä¼¼äºè¡Œçº§é”ï¼Œä½ æ”¹è¿™è¡Œæ•°æ®çš„æ—¶å€™ï¼Œå…¶ä»–è¡Œçš„æ•°æ®åˆ«äººä¹Ÿæ˜¯å¯ä»¥æ”¹çš„ï¼Œå› ä¸ºæœ‰å…±äº«é”+æ’ä»–é”+ä¹è§‚é”æ„æˆ</span><br><span class="line">Inodbæ”¯æŒçƒ­å¤‡ï¼Œmysiamä¸æ”¯æŒ</span><br><span class="line">(çƒ­å¤‡æ˜¯æŒ‰ç…§äº‹åŠ¡çš„æäº¤åšçš„å¤‡ä»½)</span><br></pre></td></tr></table></figure><p>1ã€ç‰©ç†åŒºåˆ«ï¼šæœ€åº•å±‚çš„æ•°æ®æ–‡ä»¶ä¸åŒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysiamæ•°æ®æ–‡ä»¶  frm=fotmat ç»“æ„</span></span><br><span class="line"><span class="comment">#myisamçš„æ•°æ®æ–‡ä»¶ç”±3ä¸ªç»„æˆ</span></span><br><span class="line">1ã€æŸ¥çœ‹mysqlçš„å®‰è£…ç›®å½•ä¸‹çš„æ‰€æœ‰useræ–‡ä»¶</span><br><span class="line">[root@db01 ~]# <span class="built_in">cd</span> /app/mysql-5.6.50/data/mysql</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹æ‰€æœ‰userçš„æ–‡ä»¶</span><br><span class="line">[root@db01 mysql]# ll user*</span><br><span class="line">-rw-rw---- 1 mysql mysql 10684 Aug  7 23:30 user.frm</span><br><span class="line">-rw-rw---- 1 mysql mysql   664 Aug 13 15:27 user.MYD</span><br><span class="line">-rw-rw---- 1 mysql mysql  2048 Aug 13 22:01 user.MYI</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#InoDdçš„æ•°æ®æ–‡ä»¶ç”±2ä¸ªç»„æˆ</span></span><br><span class="line">è¿›å…¥éšæ„ä¸€ä¸ªåº“æ–‡ä»¶</span><br><span class="line">[root@db01 student]# <span class="built_in">cd</span> /app/mysql-5.6.50/data/student</span><br><span class="line">[root@db01 student]# ll</span><br><span class="line">-rw-rw---- 1 mysql mysql   8726 Aug 13 03:17 stu1.frm</span><br><span class="line">-rw-rw---- 1 mysql mysql  98304 Aug 15 20:52 stu1.ibd</span><br></pre></td></tr></table></figure><p>2ã€é€»è¾‘åŒºåˆ«</p><p><img src="../image/study_img/image-20240816090213485.png" alt="image-20240816090213485"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mvccå«å¤šç‰ˆæœ¬è¿›åŒ–æ§åˆ¶</span><br><span class="line"></span><br><span class="line">é”å®šç²’åº¦ï¼šåœ¨ä¿®æ”¹ä¸€è¡Œæ•°æ®ä¸­ï¼Œåˆ«çš„ç”¨æˆ·è¿‡æ¥æ˜¯ä¸å¯ä»¥ä¿®æ”¹çš„</span><br><span class="line"></span><br><span class="line">æŠŠæ”¹çš„æ•°æ®æ”¾åˆ°ç¼“å­˜é‡Œï¼Œå…ˆæä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ŒæŠŠæ”¹çš„å¤´åƒæ”¾åˆ°ç¼“å­˜é‡Œé¢ï¼Œç­‰ä¸Šä¸€ä¸ªäººä¿®æ”¹å®Œæˆåï¼Œå†æŠŠä½ çš„å¤´åƒæ”¾åˆ°æ•°æ®åº“ä¸­ï¼Œæ‰€ä»¥æ”¹å¤´åƒè¦åˆ·æ–°ä¸€ä¼šæ‰çœ‹åˆ°æ–°æ”¹çš„å¤´åƒ</span><br><span class="line"></span><br><span class="line">å†·å¤‡ï¼šæŠŠæœåŠ¡åœæ‰ï¼Œåšå¤‡ä»½</span><br><span class="line">çƒ­å¤‡ï¼šä¸åœæœåŠ¡å™¨ï¼Œåšå¤‡ä»½</span><br><span class="line">æ¸©å¤‡ï¼š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#innodbæ ¸å¿ƒç‰¹æ€§</span></span><br><span class="line">é‡ç‚¹:</span><br><span class="line">MVCC</span><br><span class="line">äº‹åŠ¡</span><br><span class="line">è¡Œçº§é”</span><br><span class="line">çƒ­å¤‡ä»½</span><br><span class="line">Crash Safe Recoveryï¼ˆè‡ªåŠ¨æ•…éšœæ¢å¤ï¼‰</span><br><span class="line"></span><br><span class="line">mysiamæ²¡æœ‰äº‹åŠ¡ å°±æ²¡æœ‰äº‹åŠ¡æ—¥å¿—redo undo</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹é»˜è®¤çš„å­˜å‚¨å¼•æ“çš„3ç§æ–¹æ³•ï¼š</span></span><br><span class="line">1ã€#ä½¿ç”¨ SELECT ç¡®è®¤ä¼šè¯å­˜å‚¨å¼•æ“</span><br><span class="line">root@localhost:(none) &gt; SELECT @@default_storage_engine;</span><br><span class="line">+--------------------------+</span><br><span class="line">| @@default_storage_engine |</span><br><span class="line">+--------------------------+</span><br><span class="line">| InnoDB                   |</span><br><span class="line">+--------------------------+</span><br><span class="line"></span><br><span class="line">2ã€#ä½¿ç”¨ show ç¡®è®¤æ¯ä¸ªè¡¨çš„å­˜å‚¨å¼•æ“</span><br><span class="line">root@localhost:(none) &gt; show create table world.city;</span><br><span class="line">å»ºè¡¨è¯­å¥æœ€åä¸€è¡Œæ˜¾ç¤ºå­˜å‚¨å¼•æ“</span><br><span class="line">ENGINE=InnoDB AUTO_INCREMENT=4080 DEFAULT CHARSET=latin1</span><br><span class="line"></span><br><span class="line">3ã€#ä½¿ç”¨  informattion_schema ç¡®è®¤æ¯ä¸ªè¡¨çš„å­˜å‚¨å¼•æ“</span><br><span class="line"><span class="keyword">select</span> table_name, engine from information_schema.tables <span class="built_in">where</span> table_name=<span class="string">&#x27;city&#x27;</span> and table_schema=<span class="string">&#x27;world&#x27;</span>\G</span><br><span class="line"></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">table_name: city</span><br><span class="line">    engine: InnoDB</span><br></pre></td></tr></table></figure><p>å­˜å‚¨å¼•æ“çš„è®¾ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#.å­˜å‚¨å¼•æ“çš„è®¾ç½®     #ä¸è¦å»çæ”¹ï¼Œä½¿ç”¨é»˜è®¤çš„å°±è¡Œ</span></span><br><span class="line">1ï¼‰#åœ¨é…ç½®æ–‡ä»¶çš„[mysqld]æ ‡ç­¾ä¸‹æ·»åŠ  (æ°¸ä¹…ç”Ÿæ•ˆ)</span><br><span class="line">[mysqld]</span><br><span class="line">default-storage-engine=InnoDB  <span class="comment">#è¿™è¡Œé…ç½®å°±æ”¹ä½ éœ€è¦çš„å­˜å‚¨å¼•æ“</span></span><br><span class="line">æ³¨æ„ï¼šæ”¹äº†é…ç½®æ–‡ä»¶éœ€è¦é‡å¯</span><br><span class="line"></span><br><span class="line">2ï¼‰#åœ¨MySQLå‘½ä»¤è¡Œä¸­ä¸´æ—¶è®¾ç½®(ä¸´æ—¶ç”Ÿæ•ˆ)</span><br><span class="line">SET @@storage_engine=InnoDB</span><br><span class="line"></span><br><span class="line">3ï¼‰#å»ºè¡¨çš„æ—¶å€™æŒ‡å®šå­˜å‚¨å¼•æ“</span><br><span class="line">create table t (i int) engine = InnoDB;</span><br></pre></td></tr></table></figure><p><strong>ä¼ä¸šæ¡ˆä¾‹1</strong></p><p>é¡¹ç›®èƒŒæ™¯ï¼š<br>å…¬å¸åŸæœ‰çš„æ¶æ„ï¼šä¸€ä¸ªå±•ç¤ºå‹çš„ç½‘ç«™ï¼ŒLAMTï¼ŒMySQL5.1.77ç‰ˆæœ¬ï¼ˆMYISAMï¼‰ï¼Œ50Mæ•°æ®é‡ã€‚</p><p>å°é—®é¢˜ä¸æ–­ï¼š<br>1ã€è¡¨çº§é”ï¼šå¯¹è¡¨ä¸­ä»»æ„ä¸€è¡Œæ•°æ®ä¿®æ”¹ç±»æ“ä½œæ—¶ï¼Œæ•´ä¸ªè¡¨éƒ½ä¼šé”å®šï¼Œå¯¹å…¶ä»–è¡Œçš„æ“ä½œéƒ½ä¸èƒ½åŒæ—¶è¿›è¡Œã€‚<br>2ã€myisamä¸æ”¯æŒæ•…éšœè‡ªåŠ¨æ¢å¤ï¼ˆCSRï¼‰ï¼šå½“æ–­ç”µæ—¶æœ‰å¯èƒ½ä¼šå‡ºç°æ•°æ®æŸåæˆ–ä¸¢å¤±çš„é—®é¢˜ã€‚</p><p>å¦‚ä½•è§£å†³ï¼š<br>1ã€å»ºè®®å°†ç°æœ‰çš„myisamå¼•æ“æ›¿æ¢ä¸ºInnodbï¼Œå°†ç‰ˆæœ¬æ›¿æ¢ä¸º5.7<br>1ï¼‰å¦‚æœä½¿ç”¨MYISAMä¼šäº§ç”Ÿâ€å°é—®é¢˜â€ï¼Œæ€§èƒ½å®‰å…¨ä¸èƒ½å¾—åˆ°ä¿è¯ï¼Œä½¿ç”¨innodbå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚<br>2ï¼‰5.7ç‰ˆæœ¬å¯¹äºinnodbå¼•æ“æ”¯æŒä¸å¤Ÿå®Œå–„ï¼Œ5.7ç‰ˆæœ¬å¯¹innodbæ”¯æŒéå¸¸å®Œå–„äº†ã€‚</p><p>2ã€å®æ–½è¿‡ç¨‹å’Œæ³¨æ„è¦ç´ ï¼šä½†æ˜¯è¿™ä¸ªä»£ç ä¸Šé¢æœ‰å¾ˆå¤§çš„æ”¹åŠ¨ï¼Œå¼€å‘æ”¹å¥½ä»£ç æ‰åšå‡çº§</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">å‡çº§çš„æ—¶å€™ä¸èƒ½å½±å“åˆ°ç”¨æˆ·</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸åœåº“çš„æ“ä½œ</span></span><br><span class="line">1ã€å‡†å¤‡ä¸€ä¸ªæ–°ç¯å¢ƒï¼Œæ¥ä¸€å°æ–°æœºå™¨ï¼Œå› ä¸ºæœ‰é—®é¢˜çš„æœºå™¨ä¸èƒ½åŠ¨</span><br><span class="line"></span><br><span class="line">2ã€åœ¨æ–°ç¯å¢ƒä¸­äºŒè¿›åˆ¶å®‰è£…ä¸€ä¸ªmysql5.7.44ï¼Œå¦‚æœæ˜¯å®¹å™¨çš„è¯å°±dockerèµ·ä¸€ä¸ª</span><br><span class="line"></span><br><span class="line">3ã€ç»™å½“å‰æ­£åœ¨æä¾›æœåŠ¡çš„ç”Ÿäº§åº“ï¼Œè¿›è¡Œä¸€ä¸ªå…¨å¤‡ï¼ˆæ‰“ç‚¹å…¨å¤‡ï¼Œè®°å½•å½“å‰å¤‡ä»½çš„ä½ç½®ç‚¹ï¼‰</span><br><span class="line">ä¸ºä»€ä¹ˆåšå…¨å¤‡ï¼šå› ä¸ºåœ¨ç”Ÿäº§çš„æ•°æ®åº“è™½ç„¶ä¸ç”¨äº†ï¼Œä½†é‡Œé¢æœ‰å¾ˆå¤šç³»ç»Ÿè¡¨ï¼Œmysqlçš„userè¡¨,åˆ›å»ºçš„ç”¨æˆ·ï¼Œç»™å¼€å‘å¼€çš„ç”¨æˆ·ï¼Œå¼€å‘å†™çš„ç¨‹åºè¿æ¥æ•°æ®åº“çš„ç”¨æˆ·éƒ½åœ¨é‡Œé¢ï¼ŒåŒ…æ‹¬è¦æ±‚çš„æˆæƒï¼Œè„±æ•çš„æˆæƒï¼Œå¦‚æœå†å»ä¸€ä¸ªä¸€ä¸ªåˆ›å»ºå°±æ¯”è¾ƒéº»çƒ¦ï¼Œå¦‚æœè¦ä¿è¯è¿™äº›éƒ½è¿˜åœ¨ï¼Œå°±è¦åšå…¨å¤‡</span><br><span class="line">[root@db02 ~]# vim /etc/my.cnf</span><br><span class="line">[mysql]   <span class="comment">#è¿™ä¸ªæ ‡ç­¾æ‰€æœ‰å®¢æˆ·ç«¯éƒ½è¯†åˆ«</span></span><br><span class="line">prompt=<span class="string">&quot;\\u@\\h:\\d &gt; &quot;</span></span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 -A --triggers -R --master-data=2 &gt;/tmp/full.sql</span><br><span class="line">-A         å¯¼å‡ºæ‰€æœ‰æ•°æ®åº“ã€‚</span><br><span class="line">--triggers ç¡®ä¿è§¦å‘å™¨ä¹Ÿè¢«å¯¼å‡º</span><br><span class="line">-R         å¯¼å‡ºå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ã€‚</span><br><span class="line">--master-data=2 å¯¼å‡ºçš„SQLæ–‡ä»¶ä¸­åŒ…å«CHANGE MASTER TOè¯­å¥ï¼Œè¿™äº›è¯­å¥åŒ…å«äº†äºŒè¿›åˆ¶æ—¥å¿—çš„ä½ç½®ä¿¡æ¯ï¼Œè¿™å¯¹äºè®¾ç½®å¤åˆ¶ç¯å¢ƒéå¸¸æœ‰ç”¨ã€‚=2 çš„æ„æ€æ˜¯ï¼Œè¿™äº›è¯­å¥ä¼šè¢«æ³¨é‡Šæ‰ï¼Œä½¿å¾—å®ƒä»¬é»˜è®¤ä¸ä¼šè¢«æ‰§è¡Œï¼Œä½†ä½ å¯ä»¥æ ¹æ®éœ€è¦å–æ¶ˆæ³¨é‡Šå®ƒä»¬ã€‚</span><br><span class="line"></span><br><span class="line">4ã€å°†å…¨å¤‡æ¢å¤åˆ°æ–°ç¯å¢ƒ</span><br><span class="line">[root@db01 ~]# mysql -uroot -p123 &lt; /tmp/full.sql</span><br><span class="line"></span><br><span class="line">5ã€ä»æ–°ç¯å¢ƒå¤‡ä»½å‡ºç¨‹åºåº“çš„æ‰€æœ‰è¡¨æ•°æ®(åšä¸€ä¸ªå•åº“çš„å¤‡ä»½)</span><br><span class="line">mysqldump -uroot -p123 -B ç¨‹åºåº“ &gt; /tmp/ç¨‹åºåº“.sql</span><br><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -B student &gt; /tmp/student.sql</span><br><span class="line"></span><br><span class="line">6ã€ä¿®æ”¹è¡¨çš„å­˜å‚¨å¼•æ“</span><br><span class="line">[root@db01 ~]# sed -i <span class="string">&#x27;s#ENGINE=MYISAM#ENGINE=INNODB#g&#x27;</span> /tmp/student.sql</span><br><span class="line"></span><br><span class="line">7ã€å°†ä¿®æ”¹åçš„ç¨‹åºåº“æ•°æ®åˆ°æ–°ç¯å¢ƒ</span><br><span class="line"><span class="comment">#æ–°ç¯å¢ƒæ²¡å¼€bin_logçš„å¯¼å…¥æ–¹æ³•</span></span><br><span class="line">[root@db01 student]# mysqldump -uroot -p123 &lt; /tmp/student.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–°ç¯å¢ƒå¼€bin_logçš„å¯¼å…¥æ–¹æ³•ï¼šéœ€è¦åŠ å…¥æ•°æ®åº“</span></span><br><span class="line">1ï¼‰å…³é—­bin_logçš„è®°å½•</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> sql_log_bin=0;</span><br><span class="line"></span><br><span class="line">2ï¼‰å¯¼å…¥æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">source</span> /tmp/student.sql</span><br><span class="line"></span><br><span class="line">3ï¼‰å¼€å¯bin_logçš„è®°å½•</span><br><span class="line">root@localhost:(none) &gt; <span class="built_in">set</span> sql_log_bin=1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#åœåº“æ“ä½œ</span></span><br><span class="line">8ã€å…ˆæŒ‚ç»´æŠ¤é¡µï¼Œæ—§ç¯å¢ƒåœæ­¢è¿æ¥æ•°æ®åº“çš„æœåŠ¡ã€æ•°æ®åº“</span><br><span class="line">[root@db02 ~]# systemctl stop tomcat;systemctl stop php-fpm;systemctl stop mysql</span><br><span class="line"></span><br><span class="line">9ã€ä»bin_logä¸­æˆªå–å¢é‡æ•°æ®</span><br><span class="line"></span><br><span class="line">10ã€å¯åŠ¨æ–°ç¯å¢ƒæ•°æ®åº“</span><br><span class="line"></span><br><span class="line">11ã€æ¢å¤æˆªå–çš„å¢é‡æ•°æ®åˆ°æ–°ç¯å¢ƒ</span><br><span class="line"></span><br><span class="line">12ã€æµ‹è¯•ç¯å¢ƒè¿æ¥æ–°åº“ï¼Œæµ‹è¯•æ‰€æœ‰åŠŸèƒ½</span><br><span class="line">    </span><br><span class="line">13ã€åº”ç”¨å‰²æ¥åˆ°æ–°æ•°æ®åº“(æ”¹ç¨‹åºä»£ç è¿æ¥åˆ°æ•°æ®åº“çš„ä¿¡æ¯,å¦‚æœæ˜¯äº‘ä¸»æœºå°±æ”¹äº‘ä¸»æœºçš„ip,ç‰©ç†æœºä¿®æ”¹ç½‘å¡çš„ipå¾ˆéº»çƒ¦,æ”¹ç¨‹åºä»£ç è¿æ¥åˆ°æ•°æ®åº“)</span><br><span class="line"></span><br><span class="line">14ã€å¯åŠ¨è¿æ¥æ•°æ®åº“çš„æœåŠ¡</span><br><span class="line"></span><br><span class="line">15ã€å–æ¶ˆç»´æŠ¤é¡µ</span><br><span class="line"></span><br><span class="line">é¡¹ç›®ç»“æœï¼š</span><br><span class="line">è§£å†³äº†<span class="string">&#x27;å°é—®é¢˜&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>mysqlä¸­çš„è¡¨ç©ºé—´</strong></p><p>åœ¨mysqlä¸­è¡¨ç©ºé—´æœ‰2ç§<br>1ã€å…±äº«è¡¨ç©ºé—´(éœ€è¦åšåˆ‡å‰²)ï¼Œæ‰€æœ‰è¡¨éƒ½èƒ½å…±äº«è¿™é‡Œçš„æ•°æ®<br>â€“  ç”¨æ¥å­˜å‚¨ç³»ç»Ÿæ•°æ®çš„<br>â€“  å­˜undo<br>â€“  ä¸´æ—¶è¡¨(ç±»ä¼¼äºè¿è¡¨æŸ¥è¯¢å‡ºæ¥çš„è¡¨)<br>2ã€ç‹¬ç«‹è¡¨ç©ºé—´(inodbçœ‹åˆ°çš„idbæ–‡ä»¶)<br>â€“  å­˜å‚¨ç”¨æˆ·çœŸå®æ•°æ®<br>â€“  æ¯ä¸€å¼ inodbå­˜å‚¨å¼•æ“çš„è¡¨éƒ½æœ‰ä¸€ä¸ªè‡ªå·±ç‹¬ç«‹è¡¨ç©ºé—´</p><ul><li>å…±äº«è¡¨ç©ºé—´ï¼šç”¨æ¥å­˜å‚¨ç³»ç»Ÿæ•°æ®ã€å­˜undoã€å­˜ä¸´æ—¶è¡¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹å…±äº«è¡¨ç©ºé—´</span></span><br><span class="line"><span class="comment">#ç‰©ç†æŸ¥çœ‹</span></span><br><span class="line">[root@db01 ~]# ll /app/mysql-5.6.50/data/</span><br><span class="line">-rw-rw---- 1 mysql mysql       56 Aug  7 23:44 auto.cnf  <span class="comment">#UUIDæ–‡ä»¶</span></span><br><span class="line">-rw-rw---- 1 mysql mysql 79691776 Aug 15 20:56 ibdata1   <span class="comment">#å…±äº«è¡¨ç©ºé—´</span></span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 Aug 15 20:56 ib_logfile0</span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 Aug  7 23:30 ib_logfile1</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å…±äº«è¡¨ç©ºé—´çš„é…ç½®</span></span><br><span class="line">root@localhost:(none) &gt; show variables like <span class="string">&#x27;%path%&#x27;</span>;</span><br><span class="line">+----------------------------------+------------------------+</span><br><span class="line">| Variable_name                    | Value                  |</span><br><span class="line">+----------------------------------+------------------------+</span><br><span class="line">| innodb_data_file_path            | ibdata1:12M:autoextend |</span><br><span class="line">+----------------------------------+------------------------+</span><br><span class="line">è¿™ä¸ªè¡¨ç©ºé—´é»˜è®¤å¤§å†™åªèƒ½å­˜å‚¨12Mæ•°æ®   autoextendè‡ªåŠ¨æ‰©å±•ï¼šå¦‚æœè¯´å…±äº«è¡¨ç©ºé—´è¶Šæ¥è¶Šå¤§ï¼Œå­˜å‚¨ç³»ç»Ÿæ•°æ®çš„ã€å­˜undoã€ä¸´æ—¶è¡¨çš„é€Ÿåº¦è¶Šæ¥è¶Šæ…¢ï¼Œæ‰€ä»¥å…±äº«è¡¨ç©ºé—´è¦åšåˆ‡å‰²</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å…±äº«è¡¨ç©ºé—´çš„åˆ‡å‰²</span></span><br><span class="line">1ã€ç¼–è¾‘é…ç½®æ–‡ä»¶</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_data_file_path=ibdata1:50M;ibdata2:50M:autoextend  <span class="comment">#åé¢å†åˆ‡çš„è¯æ”¹ibdata3 ibdata4å°±è¡Œäº†</span></span><br><span class="line"></span><br><span class="line">2ã€é‡å¯æ•°æ®åº“å¤±è´¥</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL.... SUCCESS! </span><br><span class="line">Starting MySQL.... ERROR! The server quit without updating PID file (/app/mysql-5.6.50/data/db01.pid).</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹æ—¥å¿—</span><br><span class="line">[root@db01 ~]# tailf -200 /app/mysql-5.6.50/data/db01.err </span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240816162945793.png" alt="image-20240816162945793"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åˆ†æï¼š</span></span><br><span class="line">mysqlé‡Œé¢æœ€å°çš„æ•°æ®å•ä½æ˜¯é¡µï¼Œä¸€é¡µ16K</span><br><span class="line">æŠ¥é”™æ˜¾ç¤ºidbdata1çš„å¤§å°æ˜¯4864é¡µ,è€Œæˆ‘åœ¨é…ç½®æ–‡ä»¶é…ç½®çš„æ˜¯3200é¡µ</span><br><span class="line">(4864*16)/1024=76M                (3200*16)/1024=50M</span><br><span class="line">åŸæœ¬ibdata1å…±äº«è¡¨ç©ºé—´çš„å¤§å°ä¸º76Mï¼Œä½†æ˜¯é…ç½®æ–‡ä»¶ä¸­åªç»™äº†50Mä¸å¤Ÿ</span><br><span class="line"></span><br><span class="line">4ã€æ‰€ä»¥æˆ‘åœ¨æ”¹çš„æ—¶å€™ä¸€å®šè¦çœ‹ä¸€ä¸‹ibdata1å…±äº«è¡¨ç©ºé—´å¤šå¤§ï¼Œæ”¹æˆä¸€æ¨¡ä¸€æ ·çš„å¤§å°å°±å¥½,åé¢çš„æ— æ‰€è°“ï¼Œå› ä¸ºåé¢çš„è¿˜æ²¡æœ‰ç”Ÿæˆ</span><br><span class="line">[root@db01 ~]# <span class="built_in">du</span> -sh /app/mysql-5.6.50/data/ibdata1</span><br><span class="line">76M     /app/mysql-5.6.50/data/ibdata1</span><br><span class="line">è¡¨ç¤ºibdata1 æ–‡ä»¶å ç”¨äº†å¤§çº¦ 76M çš„ç£ç›˜ç©ºé—´</span><br><span class="line"></span><br><span class="line">5ã€é‡æ–°ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå†å¯åŠ¨</span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_data_file_path=ibdata1:76M;ibdata2:50M:autoextend</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line">6ã€åˆ‡å‰²å®ŒæˆæŸ¥çœ‹å¤šå‡ºibdata2ï¼Œä»¥åå°±å¾€ibdata2ä¿å­˜ç³»ç»Ÿæ•°æ®ï¼Œundoã€ä¸´æ—¶è¡¨ï¼Œibdata1å°±å›ºå®šåœ¨76Mäº†</span><br><span class="line">[root@db01 ~]# ll /app/mysql-5.6.50/data/</span><br><span class="line">-rw-rw---- 1 mysql mysql 79691776 Aug 16 11:07 ibdata1</span><br><span class="line">-rw-rw---- 1 mysql mysql 52428800 Aug 16 11:07 ibdata2  <span class="comment">#ä¼šæ–°å¢è¿™ä¸ª</span></span><br></pre></td></tr></table></figure><ul><li>ç‹¬ç«‹è¡¨ç©ºé—´ï¼šå­˜å‚¨ç”¨æˆ·çœŸå®æ•°æ®ã€æ¯ä¸€å¼ inodbå­˜å‚¨å¼•æ“çš„è¡¨éƒ½æœ‰ä¸€ä¸ªè‡ªå·±ç‹¬ç«‹è¡¨ç©ºé—´</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">æ‰€æœ‰çš„idbæ–‡ä»¶ï¼Œå°±æ˜¯æ¯ä¸€å¼ è¡¨çš„ç‹¬ç«‹è¡¨ç©ºé—´</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹ç‹¬ç«‹è¡¨ç©ºé—´</span></span><br><span class="line">[root@db01 ~]# ll /app/mysql-5.6.50/data/student/stu*</span><br><span class="line">-rw-rw---- 1 mysql mysql   8726 Aug 13 03:17 stu1.frm</span><br><span class="line">-rw-rw---- 1 mysql mysql  98304 Aug 15 20:52 stu1.ibd    <span class="comment">#ç‹¬ç«‹è¡¨ç©ºé—´</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹ç‹¬ç«‹è¡¨ç©ºé—´æ˜¯å¦å¼€å¯ï¼Œé»˜è®¤æ˜¯å¼€å¯çš„</span></span><br><span class="line">root@localhost:(none) &gt; show variables like <span class="string">&#x27;%per_table%&#x27;</span>;</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| innodb_file_per_table | ON    |</span><br><span class="line">+-----------------------+-------+</span><br></pre></td></tr></table></figure><p>5.7ç‰ˆæœ¬ä¸­é»˜è®¤ä¼šå°†undoå’Œä¸´æ—¶è¡¨ç‹¬ç«‹å‡ºæ¥ï¼Œ5.6ç‰ˆæœ¬ä¹Ÿå¯ä»¥ç‹¬ç«‹ï¼Œåªä¸è¿‡éœ€è¦åœ¨åˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œé…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#5.7çš„ä¸´æ—¶è¡¨</span></span><br><span class="line">[root@db03 ~]# ll /app/mysql-5.7.44/data/</span><br><span class="line">-rw-r----- 1 mysql mysql 12582912 Aug  9 05:40 ibtmp1</span><br></pre></td></tr></table></figure><p><strong>ä¼ä¸šæ¡ˆä¾‹2</strong></p><p>åœ¨æ²¡æœ‰å¤‡ä»½æ•°æ®çš„æƒ…å†µä¸‹ï¼Œçªç„¶æ–­ç”µå¯¼è‡´è¡¨ç»“æ„æŸåï¼Œæ‰“ä¸å¼€æ•°æ®åº“ã€‚</p><p>ç¯å¢ƒå‡†å¤‡ï¼š</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th></tr></thead><tbody><tr><td>db01</td><td>10.0.0.51  /  172.16.1.51</td><td>æ–°ç¯å¢ƒ</td></tr><tr><td>bdb02</td><td>10.0.0.52  /  172.16.1.52</td><td>æ—§ç¯å¢ƒï¼šè¡¨ç»“æ„æŸåçš„æ•°æ®åº“</td></tr></tbody></table><p>æ¨¡æ‹Ÿæ•°æ®æŸå</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ¨¡æ‹Ÿè¡¨ç»“æ„æŸå</span></span><br><span class="line">å‡†å¤‡æ•°æ®åº“çš„å¤‡ä»½æ–‡ä»¶ä¼ é€’åˆ°å…¶ä»–æœºå™¨</span><br><span class="line">[root@db01 ~]# <span class="built_in">cd</span> /app/mysql-5.6.50/data/</span><br><span class="line">[root@db01 data]# tar zcf world.tgz world</span><br><span class="line">[root@db01 data]# scp world.tgz 172.16.1.52:/root</span><br><span class="line"></span><br><span class="line">bdb02æ“ä½œï¼š</span><br><span class="line">1ã€å°†åº“æ–‡ä»¶è§£å‹åˆ°mysqlçš„dataç›®å½•</span><br><span class="line">[root@db02 ~]# tar xf world.tgz -C /app/mysql-5.6.50/data/</span><br><span class="line"></span><br><span class="line">2ã€é‡å¯mysql</span><br><span class="line">[root@db02 ~]# /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line">3ã€è¿æ¥æ•°æ®åº“ï¼ŒæŸ¥çœ‹åº“æ˜¯å¦å¯¼å…¥æˆåŠŸ</span><br><span class="line">[root@db02 ~]# mysql</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| world              |</span><br><span class="line"></span><br><span class="line">4ã€æŸ¥çœ‹è¡¨é‡Œé¢çš„æ•°æ®ï¼ŒæŠ¥é”™</span><br><span class="line">mysql&gt; use world</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_world |</span><br><span class="line">+-----------------+</span><br><span class="line">| city            |</span><br><span class="line">| country         |</span><br><span class="line">| countrylanguage |</span><br><span class="line">| score           |</span><br><span class="line">+-----------------+</span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from city;</span><br><span class="line">ERROR 1146 (42S02): Table <span class="string">&#x27;world.city&#x27;</span> doesn<span class="string">&#x27;t exist</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql&gt; select * from country;</span></span><br><span class="line"><span class="string">ERROR 1146 (42S02): Table &#x27;</span>world.country<span class="string">&#x27; doesn&#x27;</span>t exist</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¦‚ä¸‹æ¢å¤çš„æ“ä½œéœ€è¦å‡†å¤‡æ–°ç¯å¢ƒï¼Œä½†æ˜¯æƒ³ä¿ç•™2ä¸ªæœºå™¨ä¹‹å‰çš„æ•°æ®ï¼Œå»ºè®®ç»™db01ã€db02æ‹æ‘„å¿«ç…§</span></span><br></pre></td></tr></table></figure><p>æ¢å¤æ€è·¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">1ã€#å…ˆåœæ­¢db02è¿æ¥mysqlçš„æ‰€æœ‰æœåŠ¡ï¼Œåœæ­¢mysqlæ•°æ®åº“ï¼Œå‡†å¤‡æ–°ç¯å¢ƒ</span><br><span class="line">ç”±äºæˆ‘æŠŠdb01å½“ä½œæ–°ç¯å¢ƒï¼Œå¹¶ä¸”æ‹æ‘„äº†å¿«ç…§ï¼Œæˆ‘å¯ä»¥æŠŠä¹‹å‰çš„æ•°æ®æ–‡ä»¶æ¸…ç†æ‰</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld stop</span><br><span class="line">[root@db01 ~]# <span class="built_in">rm</span> -rf /app/mysql-5.6.50/data/</span><br><span class="line"></span><br><span class="line">é‡æ–°åˆå§‹åŒ–ï¼Œå°±å¯ä»¥å½“ä½œæ–°ç¯å¢ƒçš„æ•°æ®åº“</span><br><span class="line">[root@db01 ~]# /app/mysql-5.6.50/scripts/mysql_install_db --user=mysql --basedir=/app/mysql-5.6.50 --datadir=/app/mysql-5.6.50/data</span><br><span class="line">[root@db01 ~]# <span class="built_in">echo</span> $?</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">æ–°ç¯å¢ƒOK,å¯åŠ¨mysql</span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL.Logging to <span class="string">&#x27;/app/mysql-5.6.50/data/db01.err&#x27;</span>.</span><br><span class="line">.. SUCCESS! </span><br><span class="line"></span><br><span class="line">[root@db01 ~]# ll /app/mysql-5.6.50/data/</span><br><span class="line">total 229028</span><br><span class="line">-rw-rw---- 1 mysql mysql       56 Aug 17 02:16 auto.cnf</span><br><span class="line">-rw-rw---- 1 mysql mysql     1995 Aug 17 02:16 db01.err</span><br><span class="line">-rw-rw---- 1 mysql mysql        5 Aug 17 02:16 db01.pid</span><br><span class="line">-rw-rw---- 1 mysql mysql 79691776 Aug 17 02:16 ibdata1</span><br><span class="line">-rw-rw---- 1 mysql mysql 52428800 Aug 17 02:15 ibdata2</span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 Aug 17 02:16 ib_logfile0</span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 Aug 17 02:15 ib_logfile1</span><br><span class="line">drwx------ 2 mysql mysql     4096 Aug 17 02:15 mysql</span><br><span class="line">-rw-rw---- 1 mysql mysql    69408 Aug 17 02:15 mysql-bin.000001</span><br><span class="line">-rw-rw---- 1 mysql mysql  1640526 Aug 17 02:15 mysql-bin.000002</span><br><span class="line">-rw-rw---- 1 mysql mysql      120 Aug 17 02:16 mysql-bin.000003</span><br><span class="line">-rw-rw---- 1 mysql mysql       57 Aug 17 02:16 mysql-bin.index</span><br><span class="line">drwx------ 2 mysql mysql     4096 Aug 17 02:15 performance_schema</span><br><span class="line">drwx------ 2 mysql mysql        6 Aug 17 02:15 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">2ã€#æ—§ç¯å¢ƒçš„è¡¨ç»“æ„(å­—æ®µï¼Œæ•°æ®ç±»å‹ï¼Œçº¦æŸ)å·²ç»æŸåï¼Œéœ€è¦æ‰¾å¼€å‘è¦è¡¨ç»“æ„ï¼ˆå°±æ˜¯å»ºè¡¨è¯­å¥ï¼‰</span><br><span class="line"><span class="comment">#åˆ æ‰å¤–é”®åˆ›å»ºè¯­å¥:  CONSTRAINT `city_ibfk_1` FOREIGN KEY (`CountryCode`) REFERENCES `country` (`Code`)</span></span><br><span class="line"></span><br><span class="line"> CREATE TABLE world.city (</span><br><span class="line">  `ID` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `Name` char(35) NOT NULL DEFAULT <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `CountryCode` char(3) NOT NULL DEFAULT <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `District` char(20) NOT NULL DEFAULT <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `Population` int(11) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`ID`),</span><br><span class="line">  KEY `CountryCode` (`CountryCode`),</span><br><span class="line">  KEY `Population` (`Population`),</span><br><span class="line">  KEY `inx_aa` (`CountryCode`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=4080 DEFAULT CHARSET=latin1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#ç™»é™†æ–°ç¯å¢ƒçš„æ•°æ®åº“ï¼Œåˆ›å»ºåº“ã€è¡¨</span><br><span class="line">[root@db01 ~]# mysql </span><br><span class="line">root@localhost:(none) &gt; create database world;</span><br><span class="line"></span><br><span class="line">root@localhost:(none) &gt; CREATE TABLE world.city (</span><br><span class="line">  `ID` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `Name` char(35) NOT NULL DEFAULT <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `CountryCode` char(3) NOT NULL DEFAULT <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `District` char(20) NOT NULL DEFAULT <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `Population` int(11) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`ID`),</span><br><span class="line">  KEY `CountryCode` (`CountryCode`),</span><br><span class="line">  KEY `Population` (`Population`),</span><br><span class="line">  KEY `inx_aa` (`CountryCode`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=4080 DEFAULT CHARSET=latin1;</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹è¡¨ç»“æ„å®Œæ•´ï¼Œä½†æ˜¯æ²¡æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; desc world.city;</span><br><span class="line">+-------------+----------+------+-----+---------+----------------+</span><br><span class="line">| Field       | Type     | Null | Key | Default | Extra          |</span><br><span class="line">+-------------+----------+------+-----+---------+----------------+</span><br><span class="line">| ID          | int(11)  | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| Name        | char(35) | NO   |     |         |                |</span><br><span class="line">| CountryCode | char(3)  | NO   | MUL |         |                |</span><br><span class="line">| District    | char(20) | NO   |     |         |                |</span><br><span class="line">| Population  | int(11)  | NO   | MUL | 0       |                |</span><br><span class="line">+-------------+----------+------+-----+---------+----------------+</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> * from world.city;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">é‚£ä¹ˆæ•°æ®åœ¨å“ªé‡Œå‘¢ï¼Œæ•°æ®åœ¨ç‹¬ç«‹è¡¨ç©ºé—´</span><br><span class="line">[root@db01 ~]# ll /app/mysql-5.6.50/data/world/</span><br><span class="line">total 16</span><br><span class="line">-rw-rw---- 1 mysql mysql 8710  Aug 17 02:24 city.frm</span><br><span class="line">-rw-rw---- 1 mysql mysql 147456 Aug 17 02:24 city.idb <span class="comment">#ç‹¬ç«‹è¡¨ç©ºé—´</span></span><br><span class="line">-rw-rw---- 1 mysql mysql   61 Aug 17 02:22 db.opt</span><br><span class="line"></span><br><span class="line">4ã€#åˆ é™¤æ–°ç¯å¢ƒçš„ç‹¬ç«‹è¡¨ç©ºé—´</span><br><span class="line">root@localhost:(none) &gt; alter table world.city discard tablespace;</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# ll /app/mysql-5.6.50/data/world/</span><br><span class="line">total 16</span><br><span class="line">-rw-rw---- 1 mysql mysql 8710 Aug 17 02:24 city.frm</span><br><span class="line">-rw-rw---- 1 mysql mysql   61 Aug 17 02:22 db.opt</span><br><span class="line"><span class="comment">#ç‹¬ç«‹è¡¨ç©ºé—´è¢«åˆ é™¤</span></span><br><span class="line"></span><br><span class="line">5ã€#ä»æ—§ç¯å¢ƒdb02å°†cityè¡¨çš„è¡¨ç©ºé—´å¤åˆ¶è¿‡æ¥</span><br><span class="line">[root@db02 ~]# <span class="built_in">cd</span> /app/mysql-5.6.50/data/world/</span><br><span class="line">[root@db02 world]# scp city.ibd 172.16.1.51:/app/mysql-5.6.50/data/world/</span><br><span class="line"></span><br><span class="line">6ã€#æ–°ç¯å¢ƒdb01ç»™ç‹¬ç«‹è¡¨ç©ºé—´æˆæƒ</span><br><span class="line">[root@db01 ~]# <span class="built_in">chown</span> -R mysql.mysql /app/mysql-5.6.50/data/world</span><br><span class="line"></span><br><span class="line">7ã€#æ–°ç¯å¢ƒdb01å¯¼å…¥è¡¨ç©ºé—´</span><br><span class="line">root@localhost:(none) &gt; alter table world.city import tablespace;</span><br><span class="line"></span><br><span class="line">8ã€#æŸ¥è¯¢æ•°æ®</span><br><span class="line">root@localhost:(none) &gt; <span class="keyword">select</span> * from world.city;</span><br><span class="line"></span><br><span class="line">9ã€#ç¨‹åºè¿˜åœ¨æ—§æ•°æ®åº“ä¸Šï¼Œæµ‹è¯•æ²¡é—®é¢˜ä¹‹åï¼Œå°±ç”¨äºå‰²æ¥</span><br><span class="line">   - æ–¹æ³•ä¸€ï¼šå¼€å‘ä¿®æ”¹ä»£ç è¿æ¥æ•°æ®åº“çš„IPï¼Œå¼€å‘æ”¹å®Œä»£ç è¦èµ°ä»£ç ä¸Šçº¿çš„æµç¨‹ï¼Œå®¡æ‰¹ï¼Œæµ‹è¯•ï¼Œ..å‘å¸ƒ</span><br><span class="line">   - æ–¹æ³•äºŒï¼šè¿ç»´å¯¼å‡ºæ–°ç¯å¢ƒçš„æ•°æ®ï¼Œæ¢å¤åˆ°æ—§ç¯å¢ƒ</span><br><span class="line"></span><br><span class="line">10ã€#å¯åŠ¨è¿æ¥æ•°æ®åº“çš„æœåŠ¡</span><br></pre></td></tr></table></figure><h3 id="Innodbæ ¸å¿ƒç‰¹æ€§â€”â€”äº‹åŠ¡"><strong>Innodbæ ¸å¿ƒç‰¹æ€§â€”â€”äº‹åŠ¡</strong></h3><p><strong>ä»€ä¹ˆæ˜¯äº‹åŠ¡</strong><br>ä¸»è¦é’ˆå¯¹DMLè¯­å¥ï¼ˆupdateï¼Œdeleteï¼Œinsertï¼‰</p><p>ä¸€ç»„æ•°æ®æ“ä½œæ‰§è¡Œæ­¥éª¤ï¼Œè¿™äº›æ­¥éª¤è¢«è§†ä¸ºä¸€ä¸ªå·¥ä½œå•å…ƒ:<br>1ï¼‰ç”¨äºå¯¹å¤šä¸ªè¯­å¥è¿›è¡Œåˆ†ç»„<br>2ï¼‰å¯ä»¥åœ¨å¤šä¸ªå®¢æˆ·æœºå¹¶å‘è®¿é—®åŒä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®æ—¶ä½¿ç”¨</p><p>**äº‹ç‰©çš„ç”Ÿå‘½å‘¨æœŸï¼š**æ‰€æœ‰æ­¥éª¤éƒ½æˆåŠŸæˆ–éƒ½å¤±è´¥<br>1ï¼‰å¦‚æœæ‰€æœ‰æ­¥éª¤æ­£å¸¸ï¼Œåˆ™æ‰§è¡Œ<br>2ï¼‰å¦‚æœæ­¥éª¤å‡ºç°é”™è¯¯æˆ–ä¸å®Œæ•´ï¼Œåˆ™å–æ¶ˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æˆåŠŸçš„äº‹ç‰©</span></span><br><span class="line"><span class="comment">#å¼€å¯äº‹ç‰©</span></span><br><span class="line">beginï¼š</span><br><span class="line">ç„¶åæ‰§è¡ŒDMLè¯­å¥</span><br><span class="line"></span><br><span class="line"><span class="comment">#æäº¤äº‹ç‰©</span></span><br><span class="line">commit;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¤±è´¥çš„äº‹ç‰©</span></span><br><span class="line"><span class="comment">#å¼€å¯äº‹ç‰©</span></span><br><span class="line">beginï¼š</span><br><span class="line">ç„¶åæ‰§è¡ŒDMLè¯­å¥</span><br><span class="line"></span><br><span class="line"><span class="comment">#å›æ»šäº‹ç‰©</span></span><br><span class="line">rollback     </span><br><span class="line"></span><br><span class="line">æ‰§è¡Œcommitæˆ–è€…rollback,äº‹ç‰©ä¸ä¼šç›´æ¥å†™åœ¨ç£ç›˜é‡Œï¼Œæ˜¯å…ˆå†™åœ¨æ—¥å¿—é‡Œé¢ï¼Œå†™å…¥æ—¥å¿—æ¯”è¾ƒå¿«ï¼Œæ—¥å¿—ä¼˜å…ˆå†™</span><br></pre></td></tr></table></figure><p>äº‹ç‰©çš„é€šä¿—ç†è§£ï¼šä¼´éšç€â€œäº¤æ˜“â€å‡ºç°çš„æ•°æ®åº“æ¦‚å¿µã€‚æˆ‘ä»¬ç†è§£çš„â€œäº¤æ˜“â€æ˜¯ä»€ä¹ˆï¼Ÿ<br>1ï¼‰ç‰©ä¸ç‰©çš„äº¤æ¢ï¼ˆå¤ä»£ï¼‰<br>2ï¼‰è´§å¸ç°é‡‘ä¸å®ç‰©çš„äº¤æ¢ï¼ˆç°ä»£1ï¼‰<br>3ï¼‰è™šæ‹Ÿè´§å¸ä¸å®ç‰©çš„äº¤æ¢ï¼ˆç°ä»£2ï¼‰<br>4ï¼‰è™šæ‹Ÿè´§å¸ä¸è™šæ‹Ÿå®ç‰©äº¤æ¢ï¼ˆç°ä»£3ï¼‰</p><p><strong>äº‹ç‰©çš„ç‰¹æ€§</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Aï¼šåŸå­æ€§ï¼šå¼€å¯ä¸€ä¸ªäº‹ç‰©ï¼Œè¦ä¹ˆæ“ä½œå…¨éƒ¨æˆåŠŸï¼Œäº‹ç‰©æ‰ä¼šç»“æŸï¼Œå¦‚æœå¤±è´¥ä¸€æ¬¡ï¼Œå°±å›æ»š</span><br><span class="line">Cï¼šä¸€è‡´æ€§ï¼šäº‹ç‰©å¼€å¯ä¹‹å‰å’Œäº‹ç‰©æ‰§è¡Œç»“æŸåï¼Œæ•°æ®çŠ¶æ€ä¿å­˜ä¸€è‡´</span><br><span class="line">Iï¼šéš”ç¦»æ€§ï¼šäº‹ç‰©ä¸äº‹ç‰©ä¹‹é—´æ˜¯éš”ç¦»çš„(å’Œé”æœ‰å…³ç³»ï¼Œé”åˆå’Œéš”ç¦»çº§åˆ«æœ‰å…³ç³»)</span><br><span class="line">Dï¼šæŒä¹…æ€§ï¼šäº‹ç‰©æ“ä½œå®Œæˆåè¦æŒä¹…åŒ–</span><br></pre></td></tr></table></figure><p>äº‹ç‰©æµç¨‹ä¸¾ä¾‹</p><p><img src="../image/study_img/image-20240816121313252.png" alt="image-20240816121313252"></p><p><strong>äº‹ç‰©çš„æµç¨‹æ§åˆ¶è¯­å¥ (DTL ï¼šDatabases Transaction Language)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">DTLä¹Ÿå«TCL(Transaction Control Language)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¨¡æ‹Ÿæ“ä½œäº‹ç‰©(é“¶è¡Œå–é’±)</span></span><br><span class="line">1ã€#åˆ›å»ºä¸€ä¸ªäº¤æ˜“è¡¨ï¼Œå¹¶æ’å…¥æ•°æ®(ä¸€å¼€å§‹ä¸¤ä¸ªäººçš„åˆå§‹ä½™é¢æ˜¯500)</span><br><span class="line">root@localhost:student &gt; create table jiaoyi(money int,name varchar(10));</span><br><span class="line">root@localhost:student &gt; insert into  jiaoyi values(500,<span class="string">&#x27;zhang3&#x27;</span>),(500,<span class="string">&#x27;lisi&#x27;</span>);</span><br><span class="line">root@localhost:student &gt; <span class="keyword">select</span> * from jiaoyi;</span><br><span class="line">+-------+--------+</span><br><span class="line">| money | name   |</span><br><span class="line">+-------+--------+</span><br><span class="line">|   500 | zhang3 |</span><br><span class="line">|   500 | lisi   |</span><br><span class="line">+-------+--------+</span><br><span class="line"></span><br><span class="line">2ã€#å¼€å¯äº‹ç‰©</span><br><span class="line">root@localhost:student &gt; start transaction;  <span class="comment">#æˆ–è€…beginï¼šéƒ½å¯ä»¥æ˜¾ç¤ºå¼€å¯ä¸€ä¸ªæ–°äº‹ç‰©</span></span><br><span class="line"></span><br><span class="line">3ã€#è¿›è¡Œäº¤æ˜“ï¼Œzhang3ç»™lisiè½¬è´¦300</span><br><span class="line">root@localhost:student &gt; update jiaoyi <span class="built_in">set</span> money=800 <span class="built_in">where</span> name=<span class="string">&#x27;lisi&#x27;</span>;</span><br><span class="line">root@localhost:student &gt; update jiaoyi <span class="built_in">set</span> money=200 <span class="built_in">where</span> name=<span class="string">&#x27;zhang3&#x27;</span>;</span><br><span class="line">root@localhost:student &gt; <span class="keyword">select</span> * from jiaoyi;</span><br><span class="line">+-------+--------+</span><br><span class="line">| money | name   |</span><br><span class="line">+-------+--------+</span><br><span class="line">|   200 | zhang3 |</span><br><span class="line">|   800 | lisi   |</span><br><span class="line">+-------+--------+</span><br><span class="line"></span><br><span class="line">4ã€#å¼€å¯ä¸€ä¸ªæ–°ç»ˆç«¯Bï¼ŒæŸ¥çœ‹æ•°æ®ï¼Œæ²¡æœ‰å˜åŒ–ï¼Œå› ä¸ºäº‹ç‰©è¿˜æ²¡æœ‰ç»“æŸ</span><br><span class="line">root@localhost:student &gt; <span class="keyword">select</span> * from jiaoyi;</span><br><span class="line">+-------+--------+</span><br><span class="line">| money | name   |</span><br><span class="line">+-------+--------+</span><br><span class="line">|   500 | zhang3 |</span><br><span class="line">|   500 | lisi   |</span><br><span class="line">+-------+--------+</span><br><span class="line"></span><br><span class="line">5ã€#ç»“æŸäº‹ç‰©</span><br><span class="line">Aç»ˆç«¯ç»“æŸäº‹ç‰©</span><br><span class="line">root@localhost:student &gt; commit;</span><br><span class="line"></span><br><span class="line">Bç»ˆç«¯æŸ¥çœ‹æ•°æ®</span><br><span class="line">root@localhost:student &gt; <span class="keyword">select</span> * from jiaoyi;</span><br><span class="line">+-------+--------+</span><br><span class="line">| money | name   |</span><br><span class="line">+-------+--------+</span><br><span class="line">|   200 | zhang3 |</span><br><span class="line">|   800 | lisi   |</span><br><span class="line">+-------+--------+</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">ç°åœ¨çš„è¿™ä¸ªè¡¨å¯¹äºmysqlæ¥è¯´ï¼Œå°±æ˜¯ä¸€è¡Œï¼Œç°åœ¨çœ‹åˆ°çš„æ ¼å¼åŒ–çš„è¡¨ï¼Œæ˜¯å­˜å‚¨å¼•æ“åšçš„æ ¼å¼åŒ–ï¼Œå¦‚æœæƒ³è®©mysqlè®¤ä¸ºæ˜¯ä¸¤è¡Œæ•°æ®ï¼Œè¡¨é‡Œé¢å¿…é¡»è¦åŠ ä¸»é”®</span><br><span class="line">1ã€#ç»™è¡¨å¢åŠ ä¸»é”®ï¼Œåˆå§‹åŒ–ä½™é¢</span><br><span class="line">root@localhost:student &gt; alter table jiaoyi add <span class="built_in">id</span> int primary key auto_increment first;</span><br><span class="line">root@localhost:student &gt; update jiaoyi <span class="built_in">set</span> money=500 <span class="built_in">where</span> <span class="built_in">id</span>=2;</span><br><span class="line"></span><br><span class="line">root@localhost:student &gt; <span class="keyword">select</span> * from jiaoyi;</span><br><span class="line">+----+-------+--------+</span><br><span class="line">| <span class="built_in">id</span> | money | name   |</span><br><span class="line">+----+-------+--------+</span><br><span class="line">|  1 |   500 | zhang3 |</span><br><span class="line">|  2 |   500 | lisi   |</span><br><span class="line">+----+-------+--------+</span><br><span class="line"></span><br><span class="line">2ã€#Aç»ˆç«¯å¼€å¯ä¸€ä¸ªäº‹ç‰©ï¼Œè¿›è¡Œäº¤æ˜“ï¼Œzhang3ç»™lisiè½¬è´¦300</span><br><span class="line">root@localhost:student &gt; begin;</span><br><span class="line">root@localhost:student &gt; update jiaoyi <span class="built_in">set</span> money=800 <span class="built_in">where</span> <span class="built_in">id</span>=2;#è¿™ä¸ªæ—¶å€™æ¡ä»¶å¿…é¡»ç”¨<span class="built_in">id</span>,å¦‚æœç”¨name,å¯¹äºMySQLæ¥è¯´ï¼Œä¸èƒ½è¯†åˆ«ä¸ºä¸€è¡Œ</span><br><span class="line">root@localhost:student &gt; update jiaoyi <span class="built_in">set</span> money=200 <span class="built_in">where</span> <span class="built_in">id</span>=1;</span><br><span class="line">root@localhost:student &gt; <span class="keyword">select</span> * from jiaoyi;</span><br><span class="line">+----+-------+--------+</span><br><span class="line">| <span class="built_in">id</span> | money | name   |</span><br><span class="line">+----+-------+--------+</span><br><span class="line">|  1 |   200 | zhang3 |</span><br><span class="line">|  2 |   800 | lisi   |</span><br><span class="line">+----+-------+--------+</span><br><span class="line"></span><br><span class="line">3ã€#Bç»ˆç«¯å¼€å¯ä¸€ä¸ªäº‹ç‰©ï¼Œæœ‰äººå¾€zhang3çš„è´¦å·è½¬1000å…ƒ</span><br><span class="line">root@localhost:student &gt; begin;</span><br><span class="line">root@localhost:student &gt; update jiaoyi <span class="built_in">set</span> money=1000 <span class="built_in">where</span> <span class="built_in">id</span>=1;</span><br><span class="line">ä¸åŒçš„è¡Œï¼Œäº‹ç‰©ä¸äº‹ç‰©ä¹‹é—´ä¸å½±å“</span><br><span class="line">å¦‚æœæ˜¯åŒä¸€è¡Œï¼Œéƒ½åœ¨æ“ä½œäº‹ç‰©ï¼Œå°±è¦ç­‰å…ˆå¼€å¯çš„äº‹ç‰©å®Œæˆæ“ä½œä¹‹åï¼Œåå¼€å¯çš„äº‹ç‰©æ‰è¿›è¡Œæ“ä½œ</span><br><span class="line"></span><br><span class="line">4ã€ABç»ˆç«¯ç»“æŸäº‹ç‰©</span><br><span class="line">root@localhost:student &gt; commit;</span><br><span class="line">root@localhost:student &gt; <span class="keyword">select</span> * from jiaoyi;</span><br><span class="line">+----+-------+--------+</span><br><span class="line">| <span class="built_in">id</span> | money | name   |</span><br><span class="line">+----+-------+--------+</span><br><span class="line">|  1 |  1200 | zhang3 |</span><br><span class="line">|  2 |   800 | lisi   |</span><br><span class="line">+----+-------+--------+</span><br></pre></td></tr></table></figure><p><strong>äº‹ç‰©çš„è‡ªåŠ¨æäº¤</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">mysqlä¸æ˜¯æ‰§è¡Œbeginçš„æ—¶å€™å¼€å¯äº‹ç‰©ï¼Œæ˜¯æ‰§è¡ŒDMLè¯­å¥åï¼Œä¼šè‡ªåŠ¨å¼€å¯äº‹ç‰©ï¼Œå› ä¸ºmysqlé‡Œé¢é»˜è®¤æœ‰ä¸€ä¸ªé…ç½®ï¼š</span><br><span class="line">root@localhost:student &gt; show variables like <span class="string">&#x27;%auto%&#x27;</span>;</span><br><span class="line">+-----------------------------+-------+</span><br><span class="line">| Variable_name               | Value |</span><br><span class="line">+-----------------------------+-------+</span><br><span class="line">| auto_increment_increment    | 1     |</span><br><span class="line">| auto_increment_offset       | 1     |</span><br><span class="line">| autocommit                  | ON    |#é»˜è®¤mysqlå¼€å¯è‡ªåŠ¨æäº¤</span><br><span class="line">| automatic_sp_privileges     | ON    |</span><br><span class="line">| innodb_autoextend_increment | 64    |</span><br><span class="line">| innodb_autoinc_lock_mode    | 1     |</span><br><span class="line">| innodb_stats_auto_recalc    | ON    |</span><br><span class="line">| sql_auto_is_null            | OFF   |</span><br><span class="line">+-----------------------------+-------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹bin_logæ—¥å¿—</span></span><br><span class="line">[root@db01 ~]# mysqlbinlog --base64-output=decode rows -vvv /app/mysql-5.6.50/data/mysql-bin.000010</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€#åœ¨äº‹ç‰©æ‰§è¡ŒæœŸé—´ï¼Œå¦‚æœæ‰§è¡ŒDDLã€DCLè¯­å¥ï¼Œéƒ½ä¼šå¯¼è‡´äº‹ç‰©è‡ªåŠ¨æäº¤</span><br><span class="line"></span><br><span class="line">2ã€#åœ¨äº‹ç‰©æ‰§è¡ŒæœŸé—´ï¼Œå¦‚æœæ‰§è¡Œbeginï¼Œä¼šè‡ªåŠ¨æäº¤ä¸Šä¸€æ¬¡äº‹ç‰©ï¼Œå¼€å¯ä¸€ä¸ªæ–°äº‹ç‰©</span><br><span class="line"></span><br><span class="line">3ã€#åœ¨äº‹ç‰©æ‰§è¡ŒæœŸé—´ï¼Œå¦‚æœæ‰§è¡Œé”å®šè¯­å¥(lock tablesã€unlock tables),ä¼šè‡ªåŠ¨æäº¤äº‹ç‰©</span><br><span class="line"></span><br><span class="line">4ã€#åœ¨äº‹ç‰©æ‰§è¡ŒæœŸé—´ï¼Œæ‰§è¡Œå¯¼å‡ºæ•°æ®(load data infile)</span><br><span class="line"></span><br><span class="line">5ã€#åœ¨äº‹ç‰©æ‰§è¡ŒæœŸé—´ï¼Œæ‰§è¡Œ(<span class="keyword">select</span> <span class="keyword">for</span> update)</span><br><span class="line"></span><br><span class="line">6ã€#åœ¨æ‰§è¡Œautocommit=1çš„æ—¶å€™</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## å…³äºäº‹åŠ¡çš„è¯­å¥</span></span><br><span class="line">START TRANSACTIONï¼ˆæˆ– BEGINï¼‰ï¼šæ˜¾å¼å¼€å§‹ä¸€ä¸ªæ–°äº‹åŠ¡</span><br><span class="line"><span class="comment"># SAVEPOINTï¼šåˆ†é…äº‹åŠ¡è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªä½ç½®ï¼Œä»¥ä¾›å°†æ¥å¼•ç”¨</span></span><br><span class="line">root@localhost:(none):47: &gt;savepoint lzd_1000;</span><br><span class="line"><span class="comment"># COMMITï¼šæ°¸ä¹…è®°å½•å½“å‰äº‹åŠ¡æ‰€åšçš„æ›´æ”¹</span></span><br><span class="line"><span class="comment"># ROLLBACKï¼šå–æ¶ˆå½“å‰äº‹åŠ¡æ‰€åšçš„æ›´æ”¹</span></span><br><span class="line"><span class="comment"># ROLLBACK TO SAVEPOINTï¼šå–æ¶ˆåœ¨ savepoint ä¹‹åæ‰§è¡Œçš„æ›´æ”¹</span></span><br><span class="line">root@localhost:(none):48: &gt;rollback to savepoint lzd_1000;</span><br><span class="line"><span class="comment"># RELEASE SAVEPOINTï¼šåˆ é™¤ savepoint æ ‡è¯†ç¬¦</span></span><br><span class="line">root@localhost:(none):49: &gt;release savepoint lzd_1000;</span><br><span class="line"><span class="comment"># ä¸´æ—¶è®¾ç½®è‡ªåŠ¨æäº¤</span></span><br><span class="line">SET AUTOCOMMITï¼šä¸ºå½“å‰è¿æ¥ç¦ç”¨æˆ–å¯ç”¨é»˜è®¤ autocommit æ¨¡å¼</span><br><span class="line">root@localhost:(none):50: &gt;<span class="built_in">set</span> autocommit=1;</span><br><span class="line">root@localhost:(none):50: &gt;<span class="built_in">set</span> autocommit=0;</span><br></pre></td></tr></table></figure><h3 id="äº‹ç‰©æ—¥å¿—redo"><strong>äº‹ç‰©æ—¥å¿—redo</strong></h3><p>MySQLç‰¹æ€§ï¼šWALç‰¹æ€§  Write Ahead Log æ—¥å¿—ä¼˜å…ˆå†™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹mysqlçš„redo   åœ¨ç£ç›˜ä¸Šé¢å­˜ç€</span></span><br><span class="line">[root@db01 ~]# ll /app/mysql-5.6.50/data/</span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 Aug 18 00:20 ib_logfile0</span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 Aug  7 23:30 ib_logfile1</span><br><span class="line"></span><br><span class="line">redoçš„æ„æ€ï¼šé‡åš</span><br></pre></td></tr></table></figure><p>redologçš„å·¥ä½œæµç¨‹</p><p><img src="../image/study_img/image-20240819151513794.png" alt="image-20240819151513794"></p><p><strong>è‡ªåŠ¨æ•…éšœæ¢å¤CSR  æŠŠæ•°æ®è¯¥æ¨¡æ‹Ÿçš„æ¨¡æ‹Ÿï¼Œè¯¥å˜åŒ–çš„å˜åŒ–ï¼Œå†™å…¥åˆ°è¡¨ç©ºé—´</strong></p><p>æ–­ç”µï¼š</p><p>1ã€æ•°æ®commit,æ•°æ®å†™å…¥ib_logfile(redolog)æ—¶ï¼Œçªç„¶æ–­ç”µ</p><p>2ã€æ²¡æœ‰commit,æ•°æ®å†™å…¥ib_logfile(redo log)æ—¶</p><p>3ã€æ•°æ®æ²¡æœ‰commit,æ²¡æœ‰è®°å½•åœ¨redo logä¸­</p><p>è¿™3ç§æƒ…å†µçš„æ•°æ®å¦‚ä½•å¤„ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æƒ…å†µ1:æ•°æ®commit,æ•°æ®å†™å…¥ib_logfile(redolog)æ—¶ï¼Œçªç„¶æ–­ç”µï¼Œè¡¨ç©ºé—´çš„æ•°æ®æ€ä¹ˆæ¢å¤ï¼Œå¦‚æœä¸æ¢å¤ï¼Œç”¨æˆ·çœ‹åˆ°æ•°æ®è¿˜æ˜¯500ï¼Œæ˜¯ä¸å¯¹çš„</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240819154720922.png" alt="image-20240819154720922"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æƒ…å†µ2ï¼šæ²¡æœ‰commit,æ•°æ®å†™å…¥ib_logfile(redo log)æ—¶ï¼Œçªç„¶æ–­ç”µ</span></span><br><span class="line"></span><br><span class="line">è¿™ç§æƒ…å†µä¼šå‡ºç°é—®é¢˜ï¼Œæ•°æ®ä¸èƒ½æ¢å¤ï¼Œåªèƒ½å°†å˜åŒ–è¿‡ç¨‹è®°å½•åˆ°redo <span class="built_in">log</span>ï¼Œä¸èƒ½æŠŠæ¨¡æ‹Ÿå‡ºæ¥çš„800å†™å…¥ç‹¬ç«‹è¡¨ç©ºé—´,æ‰€ä»¥éœ€è¦é…åˆundo</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240819155546706.png" alt="image-20240819155546706"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æƒ…å†µ3ï¼šæ²¡æœ‰commit,ä¹Ÿæ²¡æœ‰å†™å…¥ib_logfile(redo log)æ—¶ï¼Œçªç„¶æ–­ç”µ</span></span><br><span class="line"></span><br><span class="line">æ²¡æœ‰commit,ä¹Ÿæ²¡æœ‰å†™å…¥ib_logfile(redo <span class="built_in">log</span>)æ—¶ï¼Œå°±ä¸ä¼šæœ‰å˜åŒ–è¿‡ç¨‹ï¼ŒåŸæ•°æ®è¿˜æ˜¯åŸæ•°æ®ï¼Œæ²¡ä»€ä¹ˆå˜åŒ–</span><br></pre></td></tr></table></figure><p><strong>äº‹ç‰©æ—¥å¿—undo</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹mysqlçš„undo</span></span><br><span class="line">[root@db01 ~]# ll /app/mysql-5.6.50/data/</span><br><span class="line">-rw-rw---- 1 mysql mysql 79691776 Aug 18 00:20 ibdata1</span><br><span class="line">-rw-rw---- 1 mysql mysql 52428800 Aug 18 00:20 ibdata2</span><br><span class="line"></span><br><span class="line">undoï¼šä¸åš   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">äº‹åŠ¡æ—¥å¿—undo</span><br><span class="line">1ï¼‰undoæ˜¯ä»€ä¹ˆï¼Ÿ</span><br><span class="line">undo,é¡¾åæ€ä¹‰â€œå›æ»šæ—¥å¿—â€ï¼Œæ˜¯äº‹åŠ¡æ—¥å¿—çš„ä¸€ç§ã€‚</span><br><span class="line"></span><br><span class="line">_2ï¼‰ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</span><br><span class="line">åœ¨äº‹åŠ¡ACIDè¿‡ç¨‹ä¸­ï¼Œå®ç°çš„æ˜¯â€œAâ€åŸå­æ€§çš„ä½œç”¨ã€‚å½“ç„¶CIçš„ç‰¹æ€§ä¹Ÿå’Œundoæœ‰å…³</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">é¢è¯•é—®é¢˜ï¼š</span><br><span class="line"><span class="comment">#mysql CSRçš„è¿‡ç¨‹å’Œä»€ä¹ˆæœ‰å…³</span></span><br><span class="line">CSRå’Œ2ä¸ªæ—¥å¿—æ–‡ä»¶æœ‰å…³ï¼Œäº‹ç‰©æ—¥å¿—redoã€undoï¼Œredoé‡åšæ•°æ®ï¼Œundoä¸åšæ•°æ®ï¼Œä»–ä»¬åˆ†åˆ«åœ¨MySQLçš„dataç›®å½•ä¸‹</span><br><span class="line">redoå°±åœ¨æ•°æ®ç›®å½•ä¸‹</span><br><span class="line">undo:åœ¨MySQL5.6ç‰ˆæœ¬ä¸­undoæ˜¯åœ¨ibdata(å…±äº«è¡¨ç©ºé—´)æ–‡ä»¶ä¸­ï¼Œåœ¨MySQL5.7ç‰ˆæœ¬ä¼šç‹¬ç«‹å‡ºæ¥ã€‚</span><br></pre></td></tr></table></figure><p><strong>MYSQL CSRçš„è¿‡ç¨‹   æ–­ç”µä¹‹åï¼Œundoç»“åˆredoï¼Œæ¢å¤æ•°æ®</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æƒ…å†µ1:æ•°æ®commit,æ•°æ®å†™å…¥ib_logfile(redolog)æ—¶ï¼Œçªç„¶æ–­ç”µï¼Œè¡¨ç©ºé—´çš„æ•°æ®æ€ä¹ˆæ¢å¤ï¼Œ</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240819170447907.png" alt="image-20240819170447907"></p><p>çªç„¶æ–­ç”µï¼Œå†…å­˜é‡Œé¢çš„æ•°æ®æ²¡äº†</p><p><img src="../image/study_img/image-20240819172903983.png" alt="image-20240819172903983"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æƒ…å†µ2ï¼šæ²¡æœ‰commit,æ•°æ®å†™å…¥ib_logfile(redo log)æ—¶ï¼Œçªç„¶æ–­ç”µ</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240819174134262.png" alt="image-20240819174134262"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ–­ç”µæ—¶ï¼Œredoé…åˆundoæ¢å¤æ•°æ®</span><br><span class="line"><span class="comment">#æƒ…å†µ3:æ²¡æœ‰commit,æ²¡æœ‰å†™å…¥ib_logfile(redolog)æ—¶ï¼Œçªç„¶æ–­ç”µ,è¡¨ç©ºé—´çš„æ•°æ®æ€ä¹ˆæ¢å¤</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240819175306313.png" alt="image-20240819175306313"></p><p><strong>äº‹ç‰©ä¸­çš„é”</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1ï¼‰ä»€ä¹ˆæ˜¯â€œé”â€ï¼Ÿ</span><br><span class="line">â€œé”â€é¡¾åæ€ä¹‰å°±æ˜¯é”å®šçš„æ„æ€ã€‚</span><br><span class="line"></span><br><span class="line">2ï¼‰â€œé”â€çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</span><br><span class="line">åœ¨äº‹åŠ¡ACIDç‰¹æ€§è¿‡ç¨‹ä¸­ï¼Œâ€œé”â€å’Œâ€œéš”ç¦»çº§åˆ«â€ä¸€èµ·æ¥å®ç°â€œIâ€éš”ç¦»æ€§çš„ä½œç”¨ã€‚</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240819111236391.png" alt="image-20240819111236391"></p><p>æœ€åçš„æ•°æ®A=2   å› ä¸ºè°å…ˆæäº¤ï¼Œä»¥è°ä¸ºå‡†ï¼Œæ¡ä»¶åé¢çš„A=1æ²¡æœ‰äº†ï¼Œè¢«ç¬¬äºŒä¸ªäº‹åŠ¡æ”¹æ‰äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">æ’ä»–é”ï¼šæ‰€è°“çš„è¡ŒåŠé”å°±æ˜¯æ’ä»–é”é€ æˆçš„ï¼Œåœ¨äº‹ç‰©æ‰§è¡ŒæœŸé—´,ä¸å…è®¸å…¶ä»–äº‹ç‰©æ‰§è¡Œä¿®æ”¹æ“ä½œ</span><br><span class="line">å…±äº«é”ï¼šåœ¨äº‹ç‰©æ‰§è¡ŒæœŸé—´ï¼Œå…è®¸æ‰€æœ‰äº‹ç‰©æ‰§è¡ŒæŸ¥è¯¢æ“ä½œ</span><br><span class="line"></span><br><span class="line">ä»–ä¸¤ç»“åˆå°±æ˜¯ï¼šé˜»å¡ä¿®æ”¹åˆ é™¤æ“ä½œï¼Œä¸é˜»å¡æŸ¥è¯¢æ“ä½œ</span><br><span class="line"></span><br><span class="line">ä¹è§‚é”ï¼šè°å…ˆæäº¤ä»¥è°ä¸ºå‡†</span><br><span class="line">æ‚²è§‚é”ï¼šåœ¨äº‹ç‰©æ‰§è¡ŒæœŸé—´ï¼Œé˜»å¡å…¶ä»–äº‹ç‰©çš„æŸ¥è¯¢æ“ä½œã€‚å‰©1å¼ ç¥¨ï¼Œæˆ‘æŠ¢äº†ï¼Œä¸ç®¡æ˜¯å¦ä»˜æ¬¾ï¼Œä½ çœ‹ä¸åˆ°è¿™ä¸ªç¥¨</span><br></pre></td></tr></table></figure><p><strong>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1ï¼‰åªé˜»å¡ä¿®æ”¹ç±»æ“ä½œï¼Œä¸é˜»å¡æŸ¥è¯¢ç±»æ“ä½œ</span><br><span class="line">2ï¼‰ä¹è§‚é”çš„æœºåˆ¶ï¼ˆè°å…ˆæäº¤è°ä¸ºå‡†ï¼‰ï¼Œmysqlä¸èƒ½æ¼”ç¤ºï¼Œå› ä¸ºéš”ç¦»çº§åˆ«å­˜åœ¨</span><br><span class="line"></span><br><span class="line"><span class="comment">#é”çš„ç²’åº¦</span></span><br><span class="line">MyIsamï¼šä½å¹¶å‘é”ï¼ˆè¡¨çº§é”ï¼‰</span><br><span class="line">Innodbï¼šé«˜å¹¶å‘é”ï¼ˆè¡Œçº§é”ï¼‰</span><br></pre></td></tr></table></figure><p><strong>äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹éš”ç¦»çº§åˆ«</span></span><br><span class="line">root@localhost:(none) &gt; show variables like <span class="string">&#x27;%iso%&#x27;</span>;</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| Variable_name | Value           |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| tx_isolation  | REPEATABLE-READ |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line"></span><br><span class="line">å››ç§éš”ç¦»çº§åˆ«ï¼š</span><br><span class="line">1ã€#READ UNCOMMITTEDï¼ˆæœªæäº¤è¯»ï¼‰ <span class="comment">#RUçº§åˆ«</span></span><br><span class="line">å…è®¸äº‹åŠ¡æŸ¥çœ‹å…¶ä»–äº‹åŠ¡æ‰€è¿›è¡Œçš„æœªæäº¤æ›´æ”¹</span><br><span class="line"></span><br><span class="line">2ã€#READ COMMITTED(å·²æäº¤è¯»)  <span class="comment">#RCçº§åˆ«</span></span><br><span class="line">å…è®¸äº‹åŠ¡æŸ¥çœ‹å…¶ä»–äº‹åŠ¡æ‰€è¿›è¡Œçš„å·²æäº¤æ›´æ”¹</span><br><span class="line"></span><br><span class="line">3ã€#REPEATABLE READï¼ˆé‡å¤è¯»ï¼‰ <span class="comment">#RRçº§åˆ«</span></span><br><span class="line">ç¡®ä¿æ¯ä¸ªäº‹åŠ¡çš„ SELECT è¾“å‡ºä¸€è‡´ï¼Œæ¯”å¦‚è¯´ï¼Œä½ å†²é’±äº†ï¼Œè¦åˆ·æ–°æˆ–è€…é€€å‡ºï¼Œæ‰å¯ä»¥çœ‹åˆ°æ›´æ–°åçš„é’±</span><br><span class="line">InnoDB çš„é»˜è®¤çº§åˆ«</span><br><span class="line"></span><br><span class="line">4ã€#SERIALIZABLE (ä¸²è¡ŒåŒ–)  <span class="comment">#ä¸ç”¨è¿™ä¸ªçº§åˆ«</span></span><br><span class="line">å°†ä¸€ä¸ªäº‹åŠ¡çš„ç»“æœä¸å…¶ä»–äº‹åŠ¡å®Œå…¨éš”ç¦»</span><br><span class="line">åœ¨äº‹ç‰©æ‰§è¡ŒæœŸé—´ï¼ŒæŸ¥è¯¢åˆ°çš„æ•°æ®æ˜¯undoé‡Œé¢=çš„æ•°æ®ï¼Œ</span><br><span class="line">æŸ¥è¯¢çš„æ—¶å€™ï¼Œé˜»å¡ä¿®æ”¹</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹éš”ç¦»çº§åˆ«</span></span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;%iso%&#x27;</span>;</span><br><span class="line"><span class="comment">#ä¿®æ”¹éš”ç¦»çº§åˆ«ä¸ºRU</span></span><br><span class="line">[mysqld]</span><br><span class="line">transaction_isolation=read-uncommit</span><br><span class="line">mysql&gt; use oldboy</span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu;</span><br><span class="line">mysql&gt; insert into stu(<span class="built_in">id</span>,name,sex,money) values(2,<span class="string">&#x27;li4&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,123);</span><br><span class="line"><span class="comment">#ä¿®æ”¹éš”ç¦»çº§åˆ«ä¸ºRC  ä¸éœ€è¦ä¿®æ”¹ï¼ŒçŸ¥é“ä¿®æ”¹æ–¹æ³•</span></span><br><span class="line">[mysqld]</span><br><span class="line">transaction_isolation=read-commit</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysqlä»¥å‰ç‰ˆæœ¬å­˜åœ¨çš„é—®é¢˜ï¼šåˆ†åˆ«æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ï¼Œç®€å•äº†è§£è§£å†³æ–¹æ¡ˆ</span></span><br><span class="line">1ã€è„è¯»:éš”ç¦»çº§åˆ«æ˜¯RUçº§åˆ«å°±äº§ç”Ÿè„è¯»ï¼Œè„è¯»è¯»å–åˆ°çš„æ˜¯å…¶ä»–äº‹åŠ¡ä¸­æœªæäº¤çš„æ•°æ®ã€‚æ¯”å¦‚è¯´æœ‰ä¸€ä¸ªäº‹åŠ¡ï¼ŒAç»™Bè½¬é’±ï¼Œä¸€å¼€å§‹ä¸¤ä¸ªäººéƒ½æ˜¯500ï¼ŒAç»™Bè½¬300ï¼ŒBå°±æœ‰800å¹¶å»æŸ¥ï¼ŒæŸ¥çœ‹åˆ°800ï¼Œä½†æ˜¯Aæ²¡æœ‰æäº¤ï¼ŒBçœ‹åˆ°çš„å°±æ˜¯è„æ•°æ®ï¼Œå› ä¸ºAçš„ä½™é¢å¯èƒ½ä¸è¶³ï¼Œå›æ»šè½¬é’±     </span><br><span class="line"></span><br><span class="line">è§£å†³åŠæ³•ï¼šæé«˜éš”ç¦»åŸºæœ¬RCçº§åˆ«ï¼Œå¯ä»¥è§£å†³è„è¯»çš„é—®é¢˜</span><br><span class="line"></span><br><span class="line">2ã€å¹»è¯»ï¼šå·²æäº¤è¯»å¼€2ä¸ªäº‹åŠ¡ï¼Œå»æŸ¥çœ‹åŒä¸€è¡Œæ•°æ®</span><br><span class="line">åœ¨ä¸€ä¸ªä¸»é”®ä¸­æ˜æ˜æ²¡æœ‰æŸ¥åˆ°ä¸»é”®ä¸ºXçš„æ•°æ®ï¼Œä½†ä¸»é”®ä¸ºXçš„æ•°æ®å°±æ˜¯æ’ä¸è¿›å»ï¼Œå°±åƒæŸç§å¹»è§‰ä¸€æ ·</span><br><span class="line">è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨RRçº§åˆ«è§£å†³ï¼Œä½¿ç”¨äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ¥é¿å…å¹»è¯»ã€‚ä¸è„è¯»ç±»ä¼¼ï¼Œé€šè¿‡è®¾ç½®åˆé€‚çš„éš”ç¦»çº§åˆ«å¯ä»¥è§£å†³å¹»è¯»é—®é¢˜ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è¡Œçº§é”æˆ–è¡¨çº§é”æ¥é™åˆ¶æŸ¥è¯¢çš„èŒƒå›´ï¼Œä»è€Œé¿å…å¹»è¯»çš„å‘ç”Ÿã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡å…ˆåæ‰§è¡ŒåŒä¸€æ¡SQL,ä½†2æ¬¡è¯»å–åˆ°çš„æ•°æ®ä¸åŒï¼Œå°±æ˜¯ä¸å¯é‡å¤è¯»</span><br><span class="line"></span><br><span class="line">è§£å†³æ–¹æ¡ˆï¼šåŒæ ·å¯ä»¥ä½¿ç”¨äº‹åŠ¡çš„éš”ç¦»çº§åˆ«å’Œè¡Œçº§é”æ¥é¿å…ä¸å¯é‡å¤è¯»ã€‚å¦å¤–ï¼ŒMySQLè¿˜æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„é”â€”â€”å¯é‡å¤è¯»é”ï¼ˆRepeatable Readï¼‰ï¼Œå®ƒå¯ä»¥é¿å…ä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚è¦ä½¿ç”¨å¯é‡å¤è¯»é”ï¼Œå¯ä»¥åœ¨æŸ¥è¯¢è¯­å¥å‰åŠ ä¸ŠFOR REPLICATE READå…³é”®å­—ï¼š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#è„è¯»æ˜¯è¯»åˆ°äº†å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ï¼Œè€Œä¸å¯é‡å¤è¯»æ˜¯è¯»åˆ°äº†å…¶ä»–äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œä½†å‰åæŸ¥è¯¢çš„ç»“æœä¸åŒï¼Œè€Œå¹»è¯»åˆ™æ˜¯æ˜æ˜æŸ¥è¯¢ä¸åˆ°ï¼Œä½†å°±æ˜¯æ’å…¥ä¸äº†ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#rediså­˜åœ¨çš„é—®é¢˜</span></span><br><span class="line">ç¼“å­˜å‡»ç©¿ï¼šå½“æœ‰1ä¸ªkeyï¼Œè®¾ç½®æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œå½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥åï¼ŒæŸ¥è¯¢è¿™ä¸ªå¯ä»¥æ—¶ï¼Œåˆšå¥½è¿™ä¸ªkeyåˆ°æœŸäº†ï¼Œç›´æ¥ç©¿è¿‡ç¼“å­˜ï¼Œæ‰“åˆ°æ•°æ®åº“ä¸Šã€‚å½“æœ‰å¤§é‡çš„å¹¶å‘è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ä¸Šï¼Œä¼šå¯¼è‡´æ•°æ®åº“è¢«æ‰“å®</span><br><span class="line"></span><br><span class="line">ç¼“å­˜ç©¿é€ï¼šæ„å‘³ç€è¿™ä¸ªæ•°æ®ï¼Œæ•°æ®åº“é‡Œé¢æ²¡æœ‰ï¼Œæ‰€ä»¥ä¸ä¼šæŠŠæ•°æ®æ”¾åˆ°redisç¼“å­˜é‡Œï¼Œåªè¦æœ‰äººæ¥æŸ¥è¯¢ï¼Œå°±ä¸€å®šç¼“å­˜ä¸­æŸ¥ä¸åˆ°ï¼Œæ‰€ä»¥ä¸€å®šè¦èµ°æ•°æ®åº“</span><br><span class="line">é‚£ä¹ˆï¼Œå‡è®¾å¾ˆå¤šäººï¼Œæ•…æ„å»æŸ¥é‚£äº›æ•°æ®åº“é‡Œä¹Ÿæ²¡æœ‰çš„è®°å½•ï¼Œæˆ‘ä»¬çš„ redis å°±èµ·ä¸åˆ°å±éšœçš„ä½œç”¨ï¼Œå› ä¸º redis é‡Œä¸å¯èƒ½æœ‰æ•°æ®ï¼Œæ‰€ä»¥å¹¶å‘æŸ¥è¯¢å°±ä¸€å®šä¼šæ‰“åˆ°æ•°æ®åº“çš„èº«ä¸Šã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å‡»ç©¿ï¼šæ•°æ®åº“é‡Œ<span class="string">&#x27;æœ‰&#x27;</span>æ•°æ®</span><br><span class="line">ç©¿é€ï¼šæ•°æ®åº“é‡Œ<span class="string">&#x27;æ²¡æœ‰&#x27;</span>æ•°æ®</span><br><span class="line"></span><br><span class="line">ç¼“å­˜é›ªå´©ï¼šå¤§é¢ç§¯çš„keyåŒæ—¶è¿‡æœŸï¼Œå¤§é‡çš„å¹¶å‘æ‰“åˆ°æ•°æ®åº“</span><br><span class="line">ä¸åƒç¼“å†²å‡»ç©¿ï¼Œåªæ˜¯å› ä¸ºä¸€ä¸ªkeyçš„è¿‡æœŸï¼Œæ‰€ä»¥ï¼Œå¯¹äºé›ªå´©æ¥è¯´ï¼Œä¸€èˆ¬å°‘é‡çš„keyå¤±æ•ˆï¼Œæ‰€å¸¦æ¥çš„æ•°æ®åº“å¹¶å‘å‹åŠ›ä¸æ˜¯å¾ˆå¤§ï¼Œè€Œå¤§é‡çš„keyåŒæ—¶å¤±æ•ˆï¼Œå¯¼è‡´keyçš„å¹¶å‘åŠ èµ·æ¥ï¼Œä¼šå½±å“åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ã€‚é‚£å°±ç®—ä¸€ä¸ªkeyå¤±æ•ˆï¼Œä¹Ÿä¼šå¯¹æ•°æ®åº“é€ æˆå¾ˆå¤§çš„å½±å“ï¼Œé‚£ä¹ˆæŠŠé›ªå´©çš„æ‰€æœ‰keyæ‹†é™¤ä¸€ä¸ªä¸€ä¸ªè¿‡æœŸçš„keyæ¥çœ‹ï¼Œä¹Ÿå°±æ˜¯é›ªå´©å¯ä»¥æ‹†åˆ†æˆä¸€ä¸ªä¸€ä¸ªç¼“å­˜å‡»ç©¿çš„é›†åˆï¼ŒæŠŠæ•°æ®åº“æ‰“å´©</span><br><span class="line"></span><br><span class="line">è§£å†³è¿™äº›é—®é¢˜éƒ½æ˜¯å¼€å‘å†™ä»£ç å»è§£å†³</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">MYSQL CSRçš„æ•°æ®æ¢å¤è¿‡ç¨‹</summary>
    
    
    
    
  </entry>
  
</feed>
