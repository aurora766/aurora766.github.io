<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>AurorağŸ¥</title>
  
  
  <link href="https://www.fomal.cc/atom.xml" rel="self"/>
  
  <link href="https://www.fomal.cc/"/>
  <updated>2024-10-02T07:56:03.732Z</updated>
  <id>https://www.fomal.cc/</id>
  
  <author>
    <name>Aurora ğŸ¥</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ğŸ‰6ã€æ§åˆ¶å™¨Controllerèµ„æº</title>
    <link href="https://www.fomal.cc/posts/64ee6901.html"/>
    <id>https://www.fomal.cc/posts/64ee6901.html</id>
    <published>2024-10-02T06:34:20.000Z</published>
    <updated>2024-10-02T07:56:03.732Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ§åˆ¶å™¨-Controllerèµ„æº">æ§åˆ¶å™¨ Controllerèµ„æº</h2><h3 id="1ã€æ§åˆ¶å™¨ä½œç”¨"><strong>1ã€æ§åˆ¶å™¨ä½œç”¨</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.podç±»å‹çš„èµ„æºï¼Œåˆ é™¤podåï¼Œä¸ä¼šé‡å»º</span><br><span class="line">2.æ›¿ç”¨æˆ·ç›‘è§†å¹¶ä¿è¯ç›¸åº”çš„èŠ‚ç‚¹ä¸Šå§‹ç»ˆæœ‰ç”¨æˆ·æ‰€æœŸæœ›çš„å‰¯æœ¬æ•°é‡çš„podåœ¨è¿è¡Œ</span><br><span class="line">3.å¦‚æœæ‰€è¿è¡Œçš„podå‰¯æœ¬æ•°è¶…è¿‡äº†ç”¨æˆ·æœŸæœ›çš„ï¼Œé‚£ä¹ˆæ§åˆ¶å™¨å°±ä¼šå±¾æ‰ï¼Œç›´åˆ°å’Œç”¨æˆ·æœŸæœ›çš„ä¸€è‡´</span><br><span class="line">4.å¦‚æœæ‰€è¿è¡Œçš„podå‰¯æœ¬æ•°ä½äºç”¨æˆ·æœŸæœ›çš„ï¼Œé‚£ä¹ˆæ§åˆ¶å™¨å°±ä¼šåˆ›å»ºï¼Œç›´åˆ°å’Œç”¨æˆ·æœŸæœ›çš„ä¸€è‡´</span><br></pre></td></tr></table></figure><h3 id="2ã€æ§åˆ¶å™¨çš„ç±»å‹"><strong>2ã€æ§åˆ¶å™¨çš„ç±»å‹</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1) Replicacontroller:Rc  <span class="string">&quot;å·²ç»æ·˜æ±°æ‰äº†&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¸¸ç”¨çš„</span></span><br><span class="line">2) Replicaset Rs:æŒ‰ç”¨æˆ·æœŸæœ›çš„å‰¯æœ¬åˆ›å»ºpod,å¹¶å§‹ç»ˆä¿æŒç›¸åº”æ•°é‡å‰¯æœ¬</span><br><span class="line"></span><br><span class="line">3) Deployment:</span><br><span class="line">Deploymenté€šè¿‡æ§åˆ¶RSæ¥ä¿è¯PODå§‹ç»ˆä¿æŒç›¸åº”çš„æ•°é‡å‰¯æœ¬æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼Œå›æ»šï¼Œå›æ»šé»˜è®¤ä¿ç•™10ä¸ªç‰ˆæœ¬æä¾›å£°æ˜å¼é…ç½®ï¼Œæ”¯æŒåŠ¨æ€ä¿®æ”¹ç®¡ç†æ— çŠ¶æ€åº”ç”¨æœ€ç†æƒ³çš„æ§åˆ¶å™¨nodeèŠ‚ç‚¹å¯èƒ½ä¼šè¿è¡Œ0ä¸ªæˆ–å¤šä¸ªPOD</span><br><span class="line"></span><br><span class="line">4)Deamonset:</span><br><span class="line">ä¸€ä¸ªèŠ‚ç‚¹åªè¿è¡Œä¸€ä¸ªï¼Œå¿…é¡»æ˜¯å§‹ç»ˆè¿è¡Œçš„çŠ¶æ€</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™ä¸ªç”¨çš„æ¯”è¾ƒå°‘</span></span><br><span class="line">5)statefulset:     </span><br><span class="line">æœ‰çŠ¶æ€åº”ç”¨</span><br></pre></td></tr></table></figure><h3 id="3ã€ReplicaSet-Rs-æ§åˆ¶å™¨"><strong>3ã€ReplicaSet     Rs æ§åˆ¶å™¨</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span>        <span class="comment">#RSæ§åˆ¶å™¨çš„æ¥å£</span></span><br><span class="line">kind: <span class="string">&quot;ReplicaSet&quot;</span>           <span class="comment">#RSæ§åˆ¶å™¨çš„ç±»å‹</span></span><br><span class="line">metadata:                    <span class="comment">#RSæ§åˆ¶å™¨çš„å…ƒæ•°æ®</span></span><br><span class="line"><span class="comment">#metadataé‡Œé¢çš„nameæ˜¯è¿™ä¸ªèµ„æºçš„name,è¿™ä¸ªnameæ˜¯ç»™Rsæ§åˆ¶å™¨èµ·çš„å</span></span><br><span class="line">  name: nginx-rs             <span class="comment">#RSæ§åˆ¶å™¨çš„åå­—</span></span><br><span class="line"><span class="comment">#labesä¸éœ€è¦æ‰“ï¼Œå› ä¸ºserviceèµ„æºæ‰¾çš„æ˜¯Podèµ„æºçš„æ ‡ç­¾ï¼Œæ‰€ä»¥æ§åˆ¶å™¨çš„æ ‡ç­¾æ²¡å¿…è¦æ‰“</span></span><br><span class="line">  namespace: default         <span class="comment">#RSæ§åˆ¶å™¨å¯åŠ¨åœ¨defaultåç§°ç©ºé—´  </span></span><br><span class="line">spec:                        <span class="comment">#RSæ§åˆ¶å™¨å…³è”Pod</span></span><br><span class="line"><span class="comment">#æœ€å°çš„å‡†å¤‡æ—¶é—´ï¼Œç»™æ§åˆ¶å™¨ä¸€ä¸ªå°±ç»ªæ—¶é—´ï¼Œä¸€èˆ¬ä¸éœ€è¦å†™ï¼Œä¸éœ€è¦çº¦æŸ</span></span><br><span class="line">  <span class="comment">#minReadySeconds: integer</span></span><br><span class="line"><span class="comment">#æœŸæœ›çš„å‰¯æœ¬ï¼Œæ¯”å¦‚è¯´èµ·5ä¸ªnginxå‰¯æœ¬</span></span><br><span class="line">  replicas: 5                <span class="comment">#podå‰¯æœ¬æ•°é‡</span></span><br><span class="line"><span class="comment">#åŒ¹é…æ ‡ç­¾çš„ï¼Œæœ‰2ç§å†™æ³•ï¼Œä¸€ä¸ªæ˜¯æ‹¿æ­£åˆ™åŒ¹é…ï¼Œä¸€ä¸ªç²¾ç¡®åŒ¹é…</span></span><br><span class="line">  selector:                  <span class="comment">#æ ‡ç­¾é€‰æ‹©å™¨</span></span><br><span class="line">    matchLabels:             <span class="comment">#åŒ¹é…çš„æ ‡ç­¾</span></span><br><span class="line">    <span class="comment">#æ ‡ç­¾èƒ½è®©æ§åˆ¶å™¨æ‰¾åˆ°pod,æ‰€ä»¥è¿™é‡Œå†™podçš„æ ‡ç­¾,ä¸€ä¼špodé‡Œé¢è¦æ‰“çš„æ ‡ç­¾ä¸€å®šè¦å’Œè¿™ä¸ªä¸€æ ·</span></span><br><span class="line">      app: nginx             <span class="comment">#æ§åˆ¶å™¨åŒ¹é…çš„Podæ ‡ç­¾</span></span><br><span class="line">  template:                  <span class="comment">#Podèµ„æºä¿¡æ¯</span></span><br><span class="line">    metadata:                <span class="comment">#Podçš„å…ƒæ•°æ®</span></span><br><span class="line">      name: nginx-rs-pod       <span class="comment">#Podçš„åå­—</span></span><br><span class="line">      labels:                  <span class="comment">#PODæ‰“æ ‡ç­¾</span></span><br><span class="line">        app: nginx             <span class="comment">#PODæ‰“æ ‡ç­¾</span></span><br><span class="line">    spec:                      <span class="comment">#å®¹å™¨ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">      containers:              <span class="comment">#å®¹å™¨ä¿¡æ¯</span></span><br><span class="line">      - name: nginx-web-containers     <span class="comment">#å®¹å™¨å</span></span><br><span class="line">        image: nginx:alpine            <span class="comment">#é•œåƒ</span></span><br><span class="line">        imagePullPolicy: IfNotPresent  <span class="comment">#æ‹‰å–è§„åˆ™</span></span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">å…¶å®Rsæ§åˆ¶å™¨å°±æ˜¯æŠŠä¹‹å‰çš„Podèµ„æºåŒ…å«èµ·æ¥</span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5CMac%5CDesktop%5Casm_blog%5Chexo-theme-Fomalhaut%5Csource%5Cimage%5Cstudy_img%5Cimage-20240923164211035.png" alt="image-20240923164211035"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™Rsæ§åˆ¶å™¨çš„èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim nginx-rs.yml</span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;ReplicaSet&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-rs</span><br><span class="line">  namespace: default</span><br><span class="line">spec: </span><br><span class="line">  replicas: 5</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">    <span class="comment">#æ§åˆ¶å™¨åŒ¹é…çš„podæ ‡ç­¾</span></span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx-rs-pod</span><br><span class="line">      labels:</span><br><span class="line">    <span class="comment">#Podçš„æ ‡ç­¾è¢«Rsæ§åˆ¶å™¨åŒ¹é…</span></span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-web-containers</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">  </span><br><span class="line">2ã€è¿è¡Œï¼Œå¹¶æŸ¥çœ‹ï¼Œè¿è¡Œçš„Podæ˜¯è½®è¯¢åœ¨node1ã€2ã€3çš„</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-rs.yml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -owide| grep nginx-rs</span><br><span class="line">nginx-rs-4z82q   1/1     Running   0      6m13s   10.2.2.9    node02</span><br><span class="line">nginx-rs-d5mhz   1/1     Running   0      6m13s   10.2.2.10   node02</span><br><span class="line">nginx-rs-qv5l6   1/1     Running   0      6m13s   10.2.3.62   node03</span><br><span class="line">nginx-rs-t8hz6   1/1     Running   0      6m13s   10.2.1.16   node01</span><br><span class="line">nginx-rs-tksxm   1/1     Running   0      6m13s   10.2.1.17   node01</span><br><span class="line"></span><br><span class="line">Podçš„åå­—åœ¨èµ„æºæ¸…å•ä¸­åŠ nginx-pod,ä½†æ˜¯ä¸æŒ‰podåå­—æ¥ï¼Œæ˜¯æ ¹å…·æ§åˆ¶å™¨name: nginx-rsè¿™ä¸ªåŠ ä¸Šéšæœºå­—ç¬¦ä¸²</span><br></pre></td></tr></table></figure><p>1ã€rsèµ„æºçš„æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1ã€æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl get replicasets</span><br><span class="line"> <span class="comment">#                  æœŸæœ›æ•°é‡   å½“å‰æ•°é‡</span></span><br><span class="line">NAME               DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-5f5d9d69c4   1         1         1       5d2h</span><br><span class="line">nginx-65cc99f84f   0         0         0       5d8h</span><br><span class="line">nginx-rs           5         5         5       11m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl get rs -owide</span><br><span class="line">[root@master01 kubernetes]# kubectl get replicasets -owide</span><br><span class="line">NAME               DESIRED   CURRENT   READY   AGE    CONTAINERS             IMAGES         SELECTOR  </span><br><span class="line">nginx-rs           5         5         5       13m    nginx-web-containers   nginx:alpine   app=nginx  <span class="comment">#æ ‡ç­¾é€‰æ‹©å™¨é€‰æ‹©å¸¦app=nginxè¿™ä¸ªæ ‡ç­¾çš„ </span></span><br><span class="line"></span><br><span class="line">2ã€#æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</span><br><span class="line">[root@master01 kubernetes]# kubectl describe rs nginx-rs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#æŒç»­è¾“å‡º</span><br><span class="line">å½“å‰çª—å£A</span><br><span class="line">[root@master01 kubernetes]# kubectl get rs -w</span><br><span class="line">å†æ‰“å¼€ä¸€ä¸ªmasteræ–°çª—å£Bï¼Œ</span><br><span class="line">[root@master01 ~]# kubectl get pod -w</span><br><span class="line"></span><br><span class="line">å†æ‰“å¼€ä¸€ä¸ªmasteræ–°çª—å£Cï¼Œåˆ é™¤ä¸€ä¸ªpod,æ—§çª—å£æœ‰è¾“å‡ºä¿¡æ¯</span><br><span class="line">[root@master01 ~]# kubectl delete pod nginx-rs-4z82q</span><br><span class="line"></span><br><span class="line">çª—å£Aã€Bä¼šæœ‰è¾“å‡ºä¿¡æ¯ï¼Œçª—å£Bä¼šæ ‡è®°åˆ é™¤Terminating(æ­¤æ—¶åªæ˜¯æ ‡è®°ï¼Œå¹¶æ²¡æœ‰çœŸåˆ é™¤)ï¼Œç„¶åä¸ºäº†ä¿è¯ä½ çš„æœŸæœ›ï¼Œä¼šèµ¶ç´§åˆ›å»ºä¸€ä¸ªæ–°çš„Pendingï¼Œç„¶ååˆå§‹åŒ–å®¹å™¨ContainerCreatingï¼Œä¹‹ååœ¨åˆ é™¤Terminatingï¼Œæ–°å®¹å™¨è¿è¡Œä¹‹åï¼Œæ‰å½»åº•è¢«åˆ é™¤æ‰</span><br><span class="line"></span><br><span class="line">4ã€#åˆ é™¤PODï¼ˆåªèƒ½åˆ é™¤rsæ§åˆ¶å™¨ï¼Œå¦åˆ™ä¼šè‡ªåŠ¨æ‹‰èµ·ï¼‰</span><br><span class="line">å½“æˆ‘ä»¬ä¸éœ€è¦è¿™ä¸ªpodï¼Œdelete podæ˜¯åˆ ä¸æ‰çš„ï¼Œåˆ äº†å°±ä¼šé‡æ–°èµ·æ¥ï¼Œæ‰€ä»¥åˆ rsæ§åˆ¶å™¨æ‰å½»åº•åˆ é™¤</span><br><span class="line">kubectl delete æ§åˆ¶å™¨ æ§åˆ¶å™¨å</span><br><span class="line">[root@master01 kubernetes]# kubectl delete rs nginx-rs</span><br></pre></td></tr></table></figure><p>2ã€Rsèµ„æºæ‰‹åŠ¨æ‰©ç¼©å®¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ–¹æ³•ä¸€ï¼š</span></span><br><span class="line">1ã€ç¼–è¾‘èµ„æºæ¸…å•ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹å‰¯æœ¬æ•°é‡</span><br><span class="line">[root@master01 kubernetes]# vim nginx-rs.yml </span><br><span class="line">replicas: 8</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œï¼ŒæŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-rs.yml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">[root@master01 kubernetes]# kubectl get rs </span><br><span class="line">NAME               DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-rs           8         8         8       10s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–¹æ³•äºŒï¼š  ä½¿ç”¨å†…ç½®çš„editå‘½ä»¤å»ä¿®æ”¹èµ„æºæ¸…å•</span></span><br><span class="line">1ã€ç¼–è¾‘æ§åˆ¶å™¨çš„èµ„æºæ¸…å•ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹å‰¯æœ¬æ•°é‡   å¦‚æœæ˜¯æ”¾åˆ°å…¶ä»–åç§°ç©ºé—´ï¼Œåé¢è¦åŠ  -n æŒ‡å®šåç§°ç©ºé—´</span><br><span class="line">[root@master01 kubernetes]# kubectl edit rs nginx-rs </span><br><span class="line">replicas: 4</span><br><span class="line">ä¿®æ”¹ä¹‹åç›´æ¥æŸ¥çœ‹ï¼Œä¸éœ€è¦apply,ç›´æ¥ç”Ÿæ•ˆ</span><br><span class="line">[root@master01 kubernetes]# kubectl get rs</span><br><span class="line">NAME               DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-rs           4         4         4       5m56s</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–¹æ³•ä¸‰ï¼š   ä½¿ç”¨ä¸“é—¨çš„å‘½ä»¤ä¿®æ”¹é…ç½®ï¼Œæ‰©ç¼©å®¹ï¼Œå‡çº§</span></span><br><span class="line">[root@master01 kubernetes]# kubectl scale rs nginx-rs --replicas=7</span><br><span class="line"></span><br><span class="line">scaleï¼šæ‰‹åŠ¨æ‰©ç¼©å®¹</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">[root@master01 kubernetes]# kubectl get rs</span><br><span class="line">NAME               DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-rs           7         7         7       13m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸“ä¸šä¸€ç‚¹æ˜¯æ ¹æ®ç‰©ç†æœºçš„èµ„æºå ç”¨æƒ…å†µæ¥åšä¸€ä¸ªè®¡ç®—ï¼Œå¦‚æœæŠ—ä¸ä½äº†å°±è‡ªåŠ¨ç¼©å®¹</span></span><br></pre></td></tr></table></figure><h3 id="4ã€Deployment-æ§åˆ¶å™¨"><strong>4ã€Deployment æ§åˆ¶å™¨</strong></h3><p>1ã€Deploymentæ§åˆ¶å™¨çš„åŠŸèƒ½å’Œå…³ç³»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Deploymenté€šè¿‡æ§åˆ¶RSæ¥ä¿è¯Podå§‹ç»ˆä¿æŒç›¸å¯¹äºçš„æ•°é‡å‰¯æœ¬</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240923200104784.png" alt="image-20240923200104784"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RSæ§åˆ¶å™¨ä»–ä¼šè¾¾åˆ°ä½ çš„æœŸæœ›å‰¯æœ¬ï¼Œç¼ºé™·ä¸èƒ½åšç‰ˆæœ¬å‡çº§</span><br><span class="line">Deploymentä¹‹æ‰€ä»¥è¦æ§åˆ¶RSæ§åˆ¶å™¨æ˜¯å› ä¸ºè¦ä¿ç•™RSæ§åˆ¶å™¨çš„åŠŸèƒ½ï¼Œä¿è¯ç”¨æˆ·æœŸæœ›çš„å‰¯æœ¬æ•°é‡ä¸€ç›´å­˜åœ¨</span><br><span class="line"></span><br><span class="line">æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼Œå›æ»šï¼Œå›æ»šé»˜è®¤ä¿ç•™10ä¸ªç‰ˆæœ¬(ä¹Ÿå°±é»˜è®¤ä¿ç•™10ä¸ªRSæ§åˆ¶å™¨)</span><br><span class="line">æä¾›å£°æ˜å¼é…ç½®ï¼Œæ”¯æŒåŠ¨æ€ä¿®æ”¹</span><br><span class="line">ç®¡ç†æ— çŠ¶æ€åº”ç”¨æœ€ç†æƒ³çš„æ§åˆ¶å™¨</span><br><span class="line">nodeèŠ‚ç‚¹å¯èƒ½è¿è¡Œ0ä¸ªæˆ–å¤šä¸ªpod</span><br></pre></td></tr></table></figure><p>2ã€Deploymentæ§åˆ¶å™¨çš„èµ„æºæ¸…å•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cp</span> nginx-rs.yml nginx-dp.yml </span><br><span class="line">[root@master01 kubernetes]# vim nginx-dp.yml </span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line"><span class="comment">#å°±ä¿®æ”¹è¿™é‡Œæ§åˆ¶å™¨çš„åå­—ï¼Œç„¶åå†ä¿®æ”¹ä¸€ä¸‹ä¸‹é¢çš„æ ‡ç­¾</span></span><br><span class="line">kind: <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-dp</span><br><span class="line">  namespace: default</span><br><span class="line">spec: </span><br><span class="line">  replicas: 8</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-dp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx-dp-pod</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-dp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-web-containers</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œå¹¶æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-dp.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">[root@master01 kubernetes]# kubectl get deployments.apps </span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-dp   8/8     8            8           39s</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹æ§åˆ¶å™¨çš„è¯¦ç»†ä¿¡æ¯</span><br><span class="line">[root@master01 kubernetes]# kubectl describe deployments.apps nginx-dp </span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240923202757305.png" alt="image-20240923202757305"></p><p>3ã€Deploymentçš„æ‰©ç¼©å®¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ–¹æ³•ä¸€ï¼š</span></span><br><span class="line">1ã€ç¼–è¾‘èµ„æºæ¸…å•ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹å‰¯æœ¬æ•°é‡</span><br><span class="line">[root@master01 kubernetes]# vim nginx-dp.yml </span><br><span class="line">replicas: 6</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œï¼ŒæŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-dp.yml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">[root@master01 kubernetes]# kubectl get deployments.apps </span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-dp   6/6     6            6           69m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–¹æ³•äºŒï¼š  ä½¿ç”¨å†…ç½®çš„editå‘½ä»¤å»ä¿®æ”¹èµ„æºæ¸…å•</span></span><br><span class="line">1ã€ç¼–è¾‘æ§åˆ¶å™¨çš„èµ„æºæ¸…å•ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹å‰¯æœ¬æ•°é‡   å¦‚æœæ˜¯æ”¾åˆ°å…¶ä»–åç§°ç©ºé—´ï¼Œåé¢è¦åŠ  -n æŒ‡å®šåç§°ç©ºé—´</span><br><span class="line">[root@master01 kubernetes]# kubectl edit deployments.apps nginx-dp </span><br><span class="line">replicas: 10</span><br><span class="line">ä¿®æ”¹ä¹‹åç›´æ¥æŸ¥çœ‹ï¼Œä¸éœ€è¦apply,ç›´æ¥ç”Ÿæ•ˆ</span><br><span class="line">[root@master01 kubernetes]# kubectl get deployments.apps </span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-dp   10/10   10           10          71m</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–¹æ³•ä¸‰ï¼š   ä½¿ç”¨ä¸“é—¨çš„å‘½ä»¤ä¿®æ”¹é…ç½®ï¼Œæ‰©ç¼©å®¹</span></span><br><span class="line">[root@master01 kubernetes]# kubectl scale deployment nginx-dp --replicas=4</span><br><span class="line">scaleï¼šæ‰‹åŠ¨æ‰©ç¼©å®¹</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">[root@master01 kubernetes]# kubectl get deployments.apps </span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-dp   4/4     4            4           73m</span><br></pre></td></tr></table></figure><p>4ã€Deploymentæ›´æ–°ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ–¹æ³•ä¸€ï¼š</span></span><br><span class="line">1ã€ç¼–è¾‘èµ„æºæ¸…å•ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹ç‰ˆæœ¬</span><br><span class="line">[root@master01 kubernetes]# vim nginx-dp.yml </span><br><span class="line">image: nginx:alpine æ”¹æˆ image: nginx:1.20.1</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œï¼ŒæŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-dp.yml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">[root@master01 kubernetes]# kubectl get deployments.apps </span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-dp   6/6     6            6           69m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–¹æ³•äºŒï¼š  ä½¿ç”¨å†…ç½®çš„editå‘½ä»¤å»ä¿®æ”¹èµ„æºæ¸…å•</span></span><br><span class="line">1ã€ç¼–è¾‘æ§åˆ¶å™¨çš„èµ„æºæ¸…å•ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹ç‰ˆæœ¬   å¦‚æœæ˜¯æ”¾åˆ°å…¶ä»–åç§°ç©ºé—´ï¼Œåé¢è¦åŠ  -n æŒ‡å®šåç§°ç©ºé—´</span><br><span class="line">[root@master01 kubernetes]# kubectl edit deployments.apps nginx-dp </span><br><span class="line">- image: nginx:alpine æ”¹æˆ - image: nginx:1.20.1</span><br><span class="line"></span><br><span class="line">ä¿®æ”¹ä¹‹åç›´æ¥æŸ¥çœ‹ï¼Œä¸éœ€è¦apply,ç›´æ¥ç”Ÿæ•ˆ</span><br><span class="line">[root@master01 kubernetes]# kubectl get rs</span><br><span class="line">NAME                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-dp-6447db69d8   0         0         0       79m</span><br><span class="line">nginx-dp-7b88fc7dff   6         6         6       2m8s</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªç‰ˆæœ¬æ˜¯æ²¡æœ‰ç›´æ¥æ˜¾ç¤ºï¼Œå¯ä»¥æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl describe rs nginx-dp-7b88fc7dff| grep -n <span class="string">&#x27;.*&#x27;</span></span><br><span class="line">17è¡Œ    Image:        nginx:1.20.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–¹æ³•ä¸‰ï¼š   ä½¿ç”¨ä¸“é—¨çš„å‘½ä»¤å‡çº§</span></span><br><span class="line">kubectl <span class="built_in">set</span> image -f èµ„æºæ¸…å• å®¹å™¨å=é•œåƒ:ç‰ˆæœ¬</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">set</span> image -f nginx-dp.yml nginx-web-containers=nginx:1.16.0</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹ä¿ç•™çš„å‡ ä¸ªç‰ˆæœ¬</span><br><span class="line">[root@master01 kubernetes]# kubectl get rs</span><br></pre></td></tr></table></figure><p>æ»šåŠ¨æ›´æ–°ç¤ºæ„å›¾ï¼š</p><p><img src="../image/study_img/image-20240923115022973.png" alt="image-20240923115022973"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹ç‰ˆæœ¬æ»šåŠ¨çš„çŠ¶æ€æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">[root@master01 kubernetes]# kubectl rollout status deployment nginx-dp </span><br><span class="line">deployment <span class="string">&quot;nginx-dp&quot;</span> successfully rolled out</span><br></pre></td></tr></table></figure><p>5ã€Deploymentå›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å›æ»šå…¶å®å’Œä¸Šé¢çš„æ›´æ–°æ–¹æ³•ä¸€æ ·çš„ï¼Œæ”¹ç‰ˆæœ¬å·</span></span><br><span class="line"><span class="comment">#æ–¹æ³•ä¸€ï¼š</span></span><br><span class="line">1ã€ç¼–è¾‘èµ„æºæ¸…å•ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹ç‰ˆæœ¬</span><br><span class="line">[root@master01 kubernetes]# vim nginx-dp.yml </span><br><span class="line">image: nginx:alpine æ”¹æˆ image: nginx:1.20.1</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œï¼ŒæŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-dp.yml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">[root@master01 kubernetes]# kubectl get deployments.apps </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–¹æ³•äºŒï¼š  ä½¿ç”¨å†…ç½®çš„editå‘½ä»¤å»ä¿®æ”¹èµ„æºæ¸…å•</span></span><br><span class="line">1ã€ç¼–è¾‘æ§åˆ¶å™¨çš„èµ„æºæ¸…å•ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹ç‰ˆæœ¬   å¦‚æœæ˜¯æ”¾åˆ°å…¶ä»–åç§°ç©ºé—´ï¼Œåé¢è¦åŠ  -n æŒ‡å®šåç§°ç©ºé—´</span><br><span class="line">[root@master01 kubernetes]# kubectl edit deployments.apps nginx-dp </span><br><span class="line">- image: nginx:alpine æ”¹æˆ - image: nginx:1.20.1</span><br><span class="line"></span><br><span class="line">ä¿®æ”¹ä¹‹åç›´æ¥æŸ¥çœ‹ï¼Œä¸éœ€è¦apply,ç›´æ¥ç”Ÿæ•ˆ</span><br><span class="line">[root@master01 kubernetes]# kubectl get rs</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªç‰ˆæœ¬æ˜¯æ²¡æœ‰ç›´æ¥æ˜¾ç¤ºï¼Œå¯ä»¥æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl describe rs nginx-dp-7b88fc7dff| grep -n <span class="string">&#x27;.*&#x27;</span></span><br><span class="line">17è¡Œ    Image:        nginx:1.20.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–¹æ³•ä¸‰ï¼š   ä½¿ç”¨ä¸“é—¨çš„å‘½ä»¤å‡çº§</span></span><br><span class="line">kubectl <span class="built_in">set</span> image -f èµ„æºæ¸…å• å®¹å™¨å=é•œåƒ:ç‰ˆæœ¬</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">set</span> image -f nginx-dp.yml nginx-web-containers=nginx:1.16.0</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹å†å²ç‰ˆæœ¬</span></span><br><span class="line">[root@master01 kubernetes]# kubectl rollout <span class="built_in">history</span> deployment nginx-dp </span><br><span class="line">deployment.apps/nginx-dp </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br><span class="line">3         &lt;none&gt;</span><br><span class="line">ä¿ç•™10ä¸ªï¼Œç°åœ¨åªè¦3ä¸ª</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æŒ‡å®šå†å²ç‰ˆæœ¬çš„ä¿¡æ¯</span></span><br><span class="line">[root@master01 kubernetes]# kubectl rollout <span class="built_in">history</span> deployment nginx-dp --revision=1</span><br><span class="line">ç¬¬7è¡Œå¯ä»¥çœ‹åˆ°ç‰ˆæœ¬ä¿¡æ¯</span><br><span class="line">Image:      nginx:alpine</span><br><span class="line"></span><br><span class="line"><span class="comment">#çœ‹å®Œç‰ˆæœ¬åï¼Œå°±å¯ä»¥å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">[root@master01 kubernetes]# kubectl rollout undo deployment nginx-dp --to-revision=1</span><br><span class="line">[root@master01 kubernetes]# kubectl get rs</span><br><span class="line">NAME                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-dp-57fb845d6d   0         0         0       3m45s</span><br><span class="line">nginx-dp-6447db69d8   6         6         6       109m</span><br><span class="line">nginx-dp-6c696f4449   0         0         0       22m</span><br><span class="line">nginx-dp-7b88fc7dff   0         0         0       31m</span><br><span class="line">[root@master01 kubernetes]# kubectl describe rs nginx-dp-6447db69d8</span><br><span class="line">æŸ¥çœ‹å·²ç»å›åˆ°alpineç‰ˆæœ¬</span><br><span class="line">    Image:        nginx:alpine</span><br></pre></td></tr></table></figure><p>å°æŠ€å·§  ä½¿ç”¨â€“recordåœ¨å†å²ç‰ˆæœ¬ä¸­è®°å½•å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹å†å²ç‰ˆæœ¬</span></span><br><span class="line">[root@master01 kubernetes]# kubectl rollout <span class="built_in">history</span> deployment nginx-dp </span><br><span class="line">deployment.apps/nginx-dp </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br><span class="line">3         &lt;none&gt;</span><br><span class="line"></span><br><span class="line">å½“å‰ç‰ˆæœ¬ä¿¡æ¯ä¸º&lt;none&gt;ï¼Œå½“ä½¿ç”¨å‘½ä»¤å»æ›´æ”¹çš„ä½¿ç”¨ï¼Œå¯ä»¥åœ¨æœ€åé¢åŠ ä¸Šé€‰é¡¹--record,å¯ä»¥è®°å½•è¿™æ¡æ‰§è¡Œçš„å‘½ä»¤ï¼Œå¦‚æœèµ„æºæ¸…å•åŠ ä¸Šç‰ˆæœ¬å·ï¼Œä¹Ÿæ˜¯å¯ä»¥æ˜¾ç¤ºï¼Œç”¨æ³•å¦‚ä¸‹</span><br><span class="line"><span class="comment">#æ–¹æ³•ä¸€ï¼š</span></span><br><span class="line">1ã€ä¿®æ”¹èµ„æºæ¸…å•ï¼Œæ”¹ä¸€ä¸‹é‡Œé¢çš„ç‰ˆæœ¬</span><br><span class="line">[root@master01 kubernetes]# vim nginx-dp.yml </span><br><span class="line">image: nginx:1.17.4</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œèµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-dp.yml --record</span><br><span class="line">[root@master01 kubernetes]# kubectl rollout <span class="built_in">history</span> deployment nginx-dp </span><br><span class="line">deployment.apps/nginx-dp </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">2         &lt;none&gt;</span><br><span class="line">3         &lt;none&gt;</span><br><span class="line">4         &lt;none&gt;</span><br><span class="line">5         &lt;none&gt;</span><br><span class="line">6         kubectl apply --filename=nginx-dp.yml --record=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–¹æ³•äºŒï¼š</span></span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">set</span> image -f nginx-dp.yml nginx-web-containers=nginx:1.18.4 --record</span><br><span class="line">deployment.apps/nginx-dp image updated</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl rollout <span class="built_in">history</span> deployment nginx-dp </span><br><span class="line">deployment.apps/nginx-dp </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">2         &lt;none&gt;</span><br><span class="line">3         &lt;none&gt;</span><br><span class="line">4         &lt;none&gt;</span><br><span class="line">5         &lt;none&gt;</span><br><span class="line">6         kubectl apply --filename=nginx-dp.yml --record=<span class="literal">true</span></span><br><span class="line">7         kubectl <span class="built_in">set</span> image nginx-web-containers=nginx:1.18.4 --filename=nginx-dp.yml --record=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="5ã€DaemonSet-æ§åˆ¶å™¨"><strong>5ã€DaemonSet æ§åˆ¶å™¨</strong></h3><p>1ã€DaemonSetç±»å‹ä»‹ç»   åº”ç”¨åœºæ™¯ï¼šæ¯ä¸€ä¸ªèŠ‚ç‚¹æœ‰ä¸”åªèµ·ä¸€ä¸ªpodï¼Œåƒzabbix-agent,flannel</p><p><img src="../image/study_img/image-20240923120503080.png" alt="image-20240923120503080"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ç®€å•æ¥è¯´å°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ¨ç½²ä¸€ä¸ªPODå‰¯æœ¬</span><br><span class="line">å¸¸è§çš„åº”ç”¨åœºæ™¯ï¼š</span><br><span class="line">ç›‘æ§å®¹å™¨</span><br><span class="line">æ—¥å¿—æ”¶é›†å®¹å™¨</span><br></pre></td></tr></table></figure><p>2ã€DaemonSetçš„èµ„æºæ¸…å•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cp</span> nginx-dp.yml nginx-ds.yml</span><br><span class="line">[root@master01 kubernetes]# vim nginx-ds.yml</span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line"><span class="comment">#ä¿®æ”¹ä¸€ä¸‹æ§åˆ¶å™¨ç±»å‹</span></span><br><span class="line">kind: <span class="string">&quot;DaemonSet&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  namespace: default</span><br><span class="line">spec: </span><br><span class="line">  <span class="comment">#replicas: 6  è¿™è¡Œä¸è¦</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-ds</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx-ds-pod</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-web-containers</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œèµ„æºæ¸…å•ï¼Œå¹¶æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -owide| grep nginx-ds</span><br><span class="line">nginx-ds-7gpkh              1/1     Running            0          3m21s   10.2.1.38   node01</span><br><span class="line">nginx-ds-9r2hz              1/1     Running            0          3m21s   10.2.2.34   node02</span><br><span class="line">nginx-ds-vmjsj              1/1     Running            0          3m21s   10.2.3.81   node03</span><br><span class="line">[root@master01 kubernetes]# kubectl get ds</span><br><span class="line">NAME       DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE</span><br><span class="line">nginx-ds   3         3         3       3            3   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸éœ€è¦æ‰©ç¼©å®¹ï¼Œä¸€å°æœºå™¨åªèƒ½èµ·ä¸€ä¸ªï¼Œé™¤éåŠ node</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è¿™å‡ ä¸ªæ§åˆ¶å™¨ï¼Œä»¥åçœ‹ä½ èµ·ä»€ä¹ˆæ ·çš„æœåŠ¡ï¼Œå»å†³å®šä½ ç”¨ä»€ä¹ˆç±»å‹çš„æ§åˆ¶å™¨ï¼Œé™¤äº†å®¢æˆ·ç«¯ç±»å‹çš„ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯Deplament</span><br><span class="line"></span><br><span class="line">StatefulSetæ§åˆ¶å™¨</span><br><span class="line">mysqlä¸»ä»å¤åˆ¶ ï¼Œkepalived</span><br><span class="line">è¿™ä¸ªç”¨çš„å°‘ï¼Œå¦‚æœéœ€è¦å¯ä»¥ä»ç½‘ä¸Šæœç´¢K8smysqlä¸»ä»å¤åˆ¶</span><br></pre></td></tr></table></figure><p>å°ç»ƒä¹ ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1ã€## ä½¿ç”¨æ§åˆ¶å™¨èµ·wordpress</span><br><span class="line">ä¸€ï¼šwordpressé•œåƒ</span><br><span class="line">åœ¨ä¸€ä¸ªPODé‡Œå¯åŠ¨ä¸¤ä¸ªå®¹å™¨</span><br><span class="line">- wordpress</span><br><span class="line">- mysql5.7</span><br><span class="line">1.å°±ç»ªæ€§æ¢é’ˆ</span><br><span class="line">2.å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">3.å¯åŠ¨é’©å­</span><br><span class="line">4.åœæ­¢é’©å­</span><br><span class="line">5.åˆå§‹åŒ–å®¹å™¨</span><br><span class="line">äºŒï¼šå°è¯• wordpress å¯åŠ¨ä¸€ä¸ªPOD</span><br><span class="line">MySQLå•ç‹¬å¯åŠ¨åœ¨ä¸€ä¸ªPODé‡Œ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€## äº†è§£HPA è‡ªåŠ¨æ‰©ç¼©å®¹</span><br><span class="line">3ã€## å†™ä¸€ä¸ªMySQLä¸»ä»å¤åˆ¶çš„èµ„æºæ¸…å•</span><br></pre></td></tr></table></figure><p>ä¸€ã€ä½¿ç”¨æ§åˆ¶å™¨èµ·wordpress</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">metadata:</span><br><span class="line"><span class="comment">#ç»™Deploymentèµ„æºèµ·çš„åå­—</span></span><br><span class="line">  name: wp-dp</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line"><span class="comment">#èµ·2ä¸ªï¼Œæ•°æ®ä¹Ÿæ˜¯2ä¸ªï¼Œé™¤éæŠŠæ•°æ®åˆ†å¼€ï¼Œæ‰€ä»¥ç°åœ¨åªèƒ½èµ·1ä¸ª</span></span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: wp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: wp-pod</span><br><span class="line">      namespace: default</span><br><span class="line">      labels:</span><br><span class="line">        app: wp</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: mysql-data</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /data/mysql</span><br><span class="line">      - name: wp-data</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /data/wp</span><br><span class="line">      containers:</span><br><span class="line">      - name: wp-container</span><br><span class="line">        image: wordpress</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 80</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          timeoutSeconds: 3</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 3306</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">          periodSeconds: 2</span><br><span class="line">          successThreshold: 3</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: WORDPRESS_DB_HOST</span><br><span class="line">          value: <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_USER</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_NAME</span><br><span class="line">          value: <span class="string">&#x27;wp_db&#x27;</span></span><br><span class="line">        </span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: wp-data</span><br><span class="line">          mountPath: /var/www/html/</span><br><span class="line">    </span><br><span class="line">      - name: mysql-container</span><br><span class="line">        image: mysql:5.7</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - --character-set-server=utf8</span><br><span class="line">        - --collation-server=utf8_general_ci</span><br><span class="line">        livenessProbe:</span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;mysqladmin -uroot -p123 ping&quot;</span>]</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          timeoutSeconds: 3</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        - name: MYSQL_DATABASE</span><br><span class="line">          value: <span class="string">&#x27;wp_db&#x27;</span></span><br><span class="line">        - name: MYSQL_USER</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: MYSQL_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: mysql-data</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line">          </span><br><span class="line">ç›®å‰çš„èµ„æºæ¸…å•è¿˜æ˜¯æœ‰ç¼ºé™·</span><br><span class="line">1ã€å¯¹å¤–æä¾›æœåŠ¡çš„é—®é¢˜</span><br><span class="line">2ã€æ•°æ®å®¹å™¨å’Œwordpresså®¹å™¨åœ¨åŒä¸€ä¸ªpodé‡Œï¼Œæ­£å¸¸åº”è¯¥åˆ†å¼€èµ·åœ¨ä¸åŒpod</span><br><span class="line">3ã€è‡ªåŠ¨æ‰©ç¼©å®¹</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ¬æ–‡ä¼šè®²è§£k8sçš„3ç§æ§åˆ¶å™¨</summary>
    
    
    
    <category term="k8s" scheme="https://www.fomal.cc/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰7ã€è‡ªåŠ¨æ‰©ç¼©å®¹HPA</title>
    <link href="https://www.fomal.cc/posts/276654d0.html"/>
    <id>https://www.fomal.cc/posts/276654d0.html</id>
    <published>2024-10-02T06:32:59.000Z</published>
    <updated>2024-10-02T07:56:03.734Z</updated>
    
    <content type="html"><![CDATA[<h2 id="è‡ªåŠ¨æ‰©ç¼©å®¹HPA">è‡ªåŠ¨æ‰©ç¼©å®¹HPA</h2><h3 id="1ã€HPAçš„ä»‹ç»"><strong>1ã€HPAçš„ä»‹ç»</strong></h3><p>HorizontalPodAutoscalerï¼ˆç®€ç§° HPA ï¼‰ è‡ªåŠ¨æ›´æ–°å·¥ä½œè´Ÿè½½èµ„æºï¼ˆä¾‹å¦‚ Deployment æˆ–è€…StatefulSetï¼‰ï¼Œ ç›®çš„æ˜¯è‡ªåŠ¨æ‰©ç¼©å·¥ä½œè´Ÿè½½ä»¥æ»¡è¶³éœ€æ±‚ã€‚<br>æ°´å¹³æ‰©ç¼©æ„å‘³ç€å¯¹å¢åŠ çš„è´Ÿè½½çš„å“åº”æ˜¯éƒ¨ç½²æ›´å¤šçš„ Podã€‚ è¿™ä¸â€œå‚ç›´ï¼ˆVerticalï¼‰â€æ‰©ç¼©ä¸åŒï¼Œå¯¹äºKubernetesï¼Œ å‚ç›´æ‰©ç¼©æ„å‘³ç€å°†æ›´å¤šèµ„æºï¼ˆä¾‹å¦‚ï¼šå†…å­˜æˆ– CPUï¼‰åˆ†é…ç»™å·²ç»ä¸ºå·¥ä½œè´Ÿè½½è¿è¡Œçš„ Podã€‚<br>å¦‚æœè´Ÿè½½å‡å°‘ï¼Œå¹¶ä¸” Pod çš„æ•°é‡é«˜äºé…ç½®çš„æœ€å°å€¼ï¼Œ HorizontalPodAutoscaler ä¼šæŒ‡ç¤ºå·¥ä½œè´Ÿè½½èµ„æºï¼ˆDeploymentã€StatefulSet æˆ–å…¶ä»–ç±»ä¼¼èµ„æºï¼‰ç¼©å‡ã€‚<br>æœ¬æ–‡æ¡£å°†å¼•å¯¼ä½ å®Œæˆå¯ç”¨ HorizontalPodAutoscaler ä»¥è‡ªåŠ¨ç®¡ç†ç¤ºä¾‹ Web åº”ç”¨ç¨‹åºçš„æ‰©ç¼©çš„ç¤ºä¾‹ã€‚ æ­¤ç¤ºä¾‹å·¥ä½œè´Ÿè½½æ˜¯è¿è¡Œä¸€äº› PHP ä»£ç çš„ Apache httpd</p><p><font color=red>æ€»ç»“ï¼šHPAå¯æ ¹æ®ç³»ç»Ÿè´Ÿè½½æƒ…å†µ(CPUã€å†…å­˜ã€ç£ç›˜ã€å¹³å‡è´Ÿè½½)ï¼Œå¯¹æ§åˆ¶å™¨(Deploymentã€statefulsetã€ReplicaSet)è¿›è¡Œæ“ä½œï¼Œä¿®æ”¹å‰¯æœ¬æ•°é‡ï¼Œè¾¾åˆ°æ‰©ç¼©å®¹çš„ç›®çš„</font>&gt;</p><h3 id="2ã€Metrics-Serviceä»‹ç»"><strong>2ã€Metrics Serviceä»‹ç»</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Metricsï¼šæŒ‡æ ‡çš„æ„æ€</span><br><span class="line">ä»€ä¹ˆæƒ…å†µä¸‹æ‰©å®¹é‡ï¼šè´Ÿè½½é«˜</span><br><span class="line">ç¼©å®¹ï¼šPod çš„æ•°é‡é«˜äºé…ç½®çš„æœ€å°å€¼</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹nodeèµ„æºçš„ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">[root@master01 ~]# kubectl top node</span><br><span class="line">error: Metrics API not available</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å®˜æ–¹æ–‡æ¡£åœ°å€ï¼šhttps://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/</span><br><span class="line"></span><br><span class="line">HPAæ€ä¹ˆçŸ¥é“ç³»ç»Ÿè´Ÿè½½çš„æƒ…å†µï¼Ÿ</span><br><span class="line">éœ€è¦æœ‰Metrics serviceæœåŠ¡</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240924084519004.png" alt="image-20240924084519004"></p><p><img src="../image/study_img/image-20240924085953555.png" alt="image-20240924085953555"></p><p><img src="../image/study_img/image-20240924141858256.png" alt="image-20240924141858256"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Metrics Serveræ˜¯Kuberneteså†…ç½®è‡ªåŠ¨ç¼©æ”¾ç®¡é“çš„å¯æ‰©å±•ã€é«˜æ•ˆçš„å®¹å™¨èµ„æºåº¦é‡æºã€‚</span><br><span class="line">Metrics Serverä»Kubeletsæ”¶é›†èµ„æºåº¦é‡ï¼Œå¹¶é€šè¿‡Metrics APIåœ¨Kubernetes apiserverä¸­å…¬å¼€è¿™äº›åº¦é‡ï¼Œä¾›Horizontal Pod Autoscalerå’ŒVertical Pod Autocalerä½¿ç”¨ã€‚kubectl topè¿˜å¯ä»¥è®¿é—®åº¦é‡APIï¼Œä»è€Œæ›´å®¹æ˜“åœ°è°ƒè¯•è‡ªåŠ¨ç¼©æ”¾ç®¡é“</span><br></pre></td></tr></table></figure><p>ç‰ˆæœ¬çš„é€‰æ‹©ï¼š</p><table><thead><tr><th>Metrics Server</th><th>Metrics APl group/version</th><th>Supported Kubernetes version</th></tr></thead><tbody><tr><td>0.7.x</td><td><a href="http://metrics.k8s.io/v1beta1">metrics.k8s.io/v1beta1</a></td><td>1.19+</td></tr><tr><td>0.6.x</td><td><a href="http://metrics.k8s.io/v1beta1">metrics.k8s.io/v1beta1</a></td><td>1.19+</td></tr><tr><td>0.5.x</td><td><a href="http://metrics.k8s.io/v1beta1">metrics.k8s.io/v1beta1</a></td><td>*1.8+</td></tr><tr><td>0.4.x</td><td><a href="http://metrics.k8s.io/v1beta1">metrics.k8s.io/v1beta1</a></td><td>*1.8+</td></tr><tr><td>0.3.x</td><td><a href="http://metrics.k8s.io/v1beta1">metrics.k8s.io/v1beta1</a></td><td>1.8-1.21</td></tr></tbody></table><h3 id="3ã€éƒ¨ç½²Metics-Server"><strong>3ã€éƒ¨ç½²Metics Server</strong></h3><p>1ã€éƒ¨ç½²Metics Server</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">registry.k8s.io/metrics-server/metrics-server:v0.7.2æ˜¯è°·æ­Œå†…éƒ¨é•œåƒç«™ä¸‹è½½ï¼Œä½†æ˜¯æ— æ³•ä¸‹è½½ï¼Œéœ€è¦æ‰‹æ®µï¼Œå¯ä»¥ä»å¦‚ä¸‹åœ°å€ä¸‹è½½</span><br><span class="line">http://test.driverzeng.com/HPA/metrics-server.tarï¼Œèµ„æºæ¸…å•å’Œé•œåƒéƒ½æœ‰</span><br><span class="line"></span><br><span class="line">1ã€æŸ¥çœ‹å½“å‰k8sç‰ˆæœ¬</span><br><span class="line">[root@master01 service]#  kubectl version | grep <span class="string">&quot;GitVersion:&quot;</span></span><br><span class="line">GitVersion:<span class="string">&quot;v1.19.3&quot;</span></span><br><span class="line"></span><br><span class="line">2ã€å»ºè®®æ¯ä¸ªnodeéƒ½ä¸‹è½½é•œåƒ</span><br><span class="line">wget http://test.driverzeng.com/HPA/metrics-server.tar</span><br><span class="line">wget http://test.driverzeng.com/HPA/components.yaml</span><br><span class="line"></span><br><span class="line">3ã€æ¯ä¸ªnodeå¯¼å…¥é•œåƒ</span><br><span class="line">[root@node01 ~]# docker load &lt; metrics-server.tar</span><br><span class="line"></span><br><span class="line">4ã€ä¿®æ”¹èµ„æºæ¸…å•</span><br><span class="line"></span><br><span class="line">[root@node01 ~]# <span class="built_in">mv</span> components.yaml.1 components.yaml</span><br><span class="line">[root@node01 ~]# vim components.yaml</span><br><span class="line">â‘ ã€åˆ é™¤è¿™å‡ è¡Œ</span><br><span class="line">122   strategy:</span><br><span class="line">123     rollingUpdate:</span><br><span class="line">124       maxUnavailable: 0</span><br><span class="line">â‘¡ã€ä¿®æ”¹æ§åˆ¶å™¨èµ„æºï¼Œä¸ºäº†ä¿è¯æ¯å°èµ·ä¸€ä¸ªæ‰€ä»¥è¦ä¿®æ”¹</span><br><span class="line">112 å°†kind: Deployment æ”¹ä¸ºkind: DaemonSet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€å¯åŠ¨ï¼Œå¹¶æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f components.yaml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -n kube-system -owide</span><br><span class="line">NAME                  READY   STATUS    RE         AGE     </span><br><span class="line">metrics-server-9kcvb  1/1     Running   0      5h40m 10.0.0.202   node02  </span><br><span class="line">metrics-server-nltkh  1/1     Running   0          5h40m 10.0.0.201   node01  </span><br><span class="line">metrics-server-v28cw  1/1     Running   0          5h40m 10.0.0.203   node03  </span><br><span class="line"></span><br><span class="line">6ã€æŸ¥çœ‹nodeèŠ‚ç‚¹èµ„æºçš„å ç”¨æƒ…å†µ            </span><br><span class="line">[root@master01 kubernetes]# kubectl top node</span><br><span class="line">NAME       CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">master01   167m         16%    1248Mi          71%       </span><br><span class="line">node01     70m          7%     507Mi           29%       </span><br><span class="line">node02     73m          7%     615Mi           35%       </span><br><span class="line">node03     110m         5%     688Mi           20% </span><br><span class="line"></span><br><span class="line">7ã€æŸ¥çœ‹podèµ„æºçš„å ç”¨æƒ…å†µ  </span><br><span class="line">[root@master01 kubernetes]# kubectl top pod</span><br><span class="line">NAME                            CPU(cores)   MEMORY(bytes)   </span><br><span class="line">c7-nginx                        0m           1Mi             </span><br><span class="line">nginx-deploy-545f948568-4tgvd   0m           2Mi             </span><br><span class="line">nginx-deploy-545f948568-7jnbf   0m           2Mi             </span><br><span class="line">nginx-deploy-545f948568-v5v82   0m           2Mi             </span><br><span class="line">nginx-ds-7gpkh                  0m           1Mi             </span><br><span class="line">nginx-ds-9r2hz                  0m           1Mi             </span><br><span class="line">nginx-ds-vmjsj                  0m           2Mi </span><br><span class="line"></span><br><span class="line">HPAå°±æ˜¯æ‰nodeçš„æ¥å£è·å–èµ„æºä¿¡æ¯</span><br></pre></td></tr></table></figure><p>2ã€ç”Ÿæˆæµ‹è¯•é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ¯ä¸ªnodeç¼–å†™phpä»£ç ï¼Œåˆ›å»ºæµ‹è¯•é¦–é¡µ</span><br><span class="line"><span class="built_in">cat</span> &gt; index.php &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&lt;?php</span><br><span class="line">  <span class="variable">$x</span> = 0.0001;</span><br><span class="line">  <span class="keyword">for</span> (<span class="variable">$i</span> = 0; <span class="variable">$i</span> &lt;= 1000000; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$x</span> += sqrt(<span class="variable">$x</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;OK!&quot;</span>;</span><br><span class="line">?&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">ä¸€èˆ¬åšè®¡ç®—æ˜¯cpuè®¡ç®—ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨å‹ä½ çš„cpuï¼Œè®¡ç®—100äº¿æ¬¡</span><br><span class="line"></span><br><span class="line">2ã€æ¯ä¸ªnodeåˆ›å»ºDockerfile</span><br><span class="line"><span class="built_in">cat</span> &gt; dockerfile &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">FROM php:5-apache</span><br><span class="line">ADD index.php /var/www/html/index.php</span><br><span class="line">RUN <span class="built_in">chmod</span> a+rx index.php</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€æ¯ä¸ªnodeæ„å»ºé•œåƒ</span><br><span class="line">docker build -t php:v1 .</span><br></pre></td></tr></table></figure><p>3ã€ç¼–å†™èµ„æºæ¸…å•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•    kubectl run php-apache --image=php:v1 --requests=cpu=200m --expose --port=80</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# vim php-dp.yml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: php-apache</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: php-apache</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        run: php-apache</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: php:v1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: php-apache</span><br><span class="line"><span class="comment">#ç°åœ¨CPUæœ€å¤šä½¿ç”¨200æ¯«æ ¸ 0.2æ ¸</span></span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 200m</span><br><span class="line">  </span><br><span class="line">2ã€è¿è¡Œï¼Œå¹¶æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f php-dp.yml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -owide</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     IP          NODE</span><br><span class="line">php-apache-869dfddb74-qgffj     1/1     Running   0          53s     10.2.3.90   node03</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.3.90 </span><br><span class="line">OK!</span><br><span class="line"></span><br><span class="line">3ã€ç›®å‰è¿˜æ²¡æœ‰éƒ¨ç½²HPA,</span><br><span class="line">[root@master01 kubernetes]# kubectl get hpa</span><br><span class="line">No resources found <span class="keyword">in</span> default namespace.</span><br><span class="line"></span><br><span class="line">4ã€åˆšåˆšéƒ¨ç½²äº†Metics Serverï¼Œhpaæ‰æ˜¯æ‰©å®¹çš„ä¸œè¥¿ï¼Œæ‰€ä»¥ç°åœ¨ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">ç¼–å†™HPAç›‘æ§èµ„æºæ‰©å®¹phpçš„Deployment</span><br><span class="line">kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# vim php-hpa.yml</span><br><span class="line">apiVersion: <span class="string">&quot;autoscaling/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;HorizontalPodAutoscaler&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: php-apache</span><br><span class="line">  namespace: default</span><br><span class="line">spec: </span><br><span class="line">  <span class="comment">#è‡ªåŠ¨æ‰©å®¹æœ€å¤§æ‰©åˆ°å¤šå°‘</span></span><br><span class="line">  maxReplicas: 8</span><br><span class="line">  <span class="comment">#è‡ªåŠ¨æ‰©å®¹æœ€å¤§æ‰©åˆ°å¤šå°‘</span></span><br><span class="line">  minReplicas: 1</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: php-apache</span><br><span class="line">  targetCPUUtilizationPercentage: 50</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">5ã€å¯åŠ¨hpaèµ„æº</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f php-hpa.yml</span><br><span class="line">[root@master01 kubernetes]# kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         8         1          16s</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä½ æƒ³è®©å“ªä¸ªDeploymentæ§åˆ¶å™¨è‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œå°±è¦è°çš„HPAèµ„æºæ¸…å•ï¼Œwordpressè‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œå°±è¦å†™wordpressçš„HPAèµ„æºç›‘æ§wordpress</span></span><br><span class="line"></span><br><span class="line">apiVersion: <span class="string">&quot;autoscaling/v1&quot;</span>           <span class="comment">#HPAæ¥å£</span></span><br><span class="line">kind: <span class="string">&quot;HorizontalPodAutoscaler&quot;</span>        <span class="comment">#HPAèµ„æºç±»å‹</span></span><br><span class="line">metadata:                              <span class="comment">#HPAå…ƒæ•°æ®</span></span><br><span class="line">  name: php-apache                     <span class="comment">#HPAèµ„æºå</span></span><br><span class="line">  namespace: default                   <span class="comment">#åç§°ç©ºé—´</span></span><br><span class="line">spec:                                  <span class="comment">#HPAæ§åˆ¶ä¿¡æ¯</span></span><br><span class="line">  maxReplicas: 8                       <span class="comment">#æœ€å¤šæ‰©å®¹8ä¸ªå‰¯æœ¬         </span></span><br><span class="line">  minReplicas: 1                       <span class="comment">#æœ€å°‘æ‰©å®¹1ä¸ªå‰¯æœ¬</span></span><br><span class="line">  scaleTargetRef:                      <span class="comment">#HPAå…³è”æ§åˆ¶å™¨</span></span><br><span class="line">    apiVersion: apps/v1                <span class="comment">#æ§åˆ¶å™¨çš„æ¥å£</span></span><br><span class="line">    kind: Deployment                   <span class="comment">#æ§åˆ¶å™¨ç±»å‹</span></span><br><span class="line">    name: php-apache                   <span class="comment">#æ§åˆ¶å™¨åå­—</span></span><br><span class="line">  targetCPUUtilizationPercentage: 50   <span class="comment">#CPUä½¿ç”¨ç‡è¾¾åˆ°50%åˆ™æ‰©å®¹</span></span><br></pre></td></tr></table></figure><p>4ã€å‹æµ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">1ã€æŸ¥çœ‹éœ€è¦å‹æµ‹çš„podçš„ip</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -owide</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     IP          NODE</span><br><span class="line">php-apache-869dfddb74-qgffj     1/1     Running   0          28m     10.2.3.90   node03</span><br><span class="line"></span><br><span class="line">2ã€å†™å¾ªç¯è„šæœ¬å‹æµ‹</span><br><span class="line">æ‰“å¼€2ä¸ªçª—å£ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå‹æµ‹æ•ˆæœå°±æ¯”è¾ƒæ˜æ˜¾</span><br><span class="line">[root@master01 kubernetes]# <span class="keyword">while</span> <span class="literal">true</span> ;<span class="keyword">do</span> curl 10.2.3.90;<span class="built_in">sleep</span> 0.2;<span class="keyword">done</span></span><br><span class="line">OK!OK!OK!OK!OK!OK!OK!OK!OK</span><br><span class="line"></span><br><span class="line">3ã€å†å¼€ä¸€ä¸ªmasterçª—å£ï¼ŒæŸ¥çœ‹cupçš„ä½¿ç”¨ç‡ï¼Œéœ€è¦ç­‰å¾…ä¸€ä¸‹ä¸‹ï¼Œæ‰å¯ä»¥çœ‹åˆ°cpuå˜åŒ–</span><br><span class="line">[root@master01 ~]# kubectl get hpa -w</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         8         1          6m37s</span><br><span class="line">php-apache   Deployment/php-apache   386%/50%   1         8         1          8m38s</span><br><span class="line">php-apache   Deployment/php-apache   386%/50%   1         8         4          8m53s</span><br><span class="line">php-apache   Deployment/php-apache   386%/50%   1         8         8          9m9s</span><br><span class="line">php-apache   Deployment/php-apache   103%/50%   1         8         8          9m39s</span><br><span class="line"></span><br><span class="line">4ã€å†å¼€ä¸€ä¸ªçª—å£ï¼ŒæŸ¥çœ‹podçš„å‰¯æœ¬æ•°é‡ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œcpuä½¿ç”¨ç‡å¢åŠ ï¼Œpodçš„å‰¯æœ¬å¢åŠ ï¼Œæ­¤æ—¶å·²ç»å¢åŠ åˆ°8ä¸ªäº†</span><br><span class="line">[root@master01 ~]# kubectl get pod</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">php-apache-869dfddb74-2x25m     1/1     Running   0          64s</span><br><span class="line">php-apache-869dfddb74-884jw     1/1     Running   0          79s</span><br><span class="line">php-apache-869dfddb74-m6vb7     1/1     Running   0          64s</span><br><span class="line">php-apache-869dfddb74-mck7s     1/1     Running   0          64s</span><br><span class="line">php-apache-869dfddb74-mg9pf     1/1     Running   0          79s</span><br><span class="line">php-apache-869dfddb74-qgffj     1/1     Running   0          35m</span><br><span class="line">php-apache-869dfddb74-t49wf     1/1     Running   0          64s</span><br><span class="line">php-apache-869dfddb74-xdtv6     1/1     Running   0          79s</span><br><span class="line"></span><br><span class="line">5ã€åœæ­¢å‹æµ‹å‘½ä»¤ï¼Œç¨ç­‰ä¸€ä¼šï¼ŒæŸ¥çœ‹podçš„å‰¯æœ¬æ•°é‡ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œcpuä½¿ç”¨ç‡å‡å°‘ï¼Œpodæ•°é‡å‡å°‘ï¼Œå˜æˆ1ä¸ªpod</span><br><span class="line">[root@master01 ~]# kubectl get pod</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">php-apache-869dfddb74-884jw     1/1     Running   0          8m54s</span><br><span class="line"></span><br><span class="line">å‹åŠ›å‡å°æ²¡æœ‰ç«‹é©¬ç¼©å®¹ï¼Œå°±åƒæå¤§æ´»åŠ¨618ï¼Œç”¨æˆ·é‡æœ‰ä¸€éƒ¨åˆ†ä¹°å®Œäº§å“äº†ï¼Œå¦‚æœçªç„¶åˆä¸Šäº†äº§å“å°±ä¸ä¼šç¼©å®¹ã€‚è¿™ä¸ªè®¾è®¡å¾ˆåˆç†çš„ï¼Œä»–ä¼šè§‰å¾—æ²¡æœ‰ä»€ä¹ˆå¤§æµé‡ï¼Œå°±ä¼šç¼©å®¹</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ¬æ–‡æ¡£å°†å¼•å¯¼ä½ å®Œæˆå¯ HPAä»¥è‡ªåŠ¨ç®¡ç†ç¤ºä¾‹ Web åº”ç”¨ç¨‹åºçš„æ‰©ç¼©æ¡ˆä¾‹</summary>
    
    
    
    <category term="k8s" scheme="https://www.fomal.cc/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰8ã€Serviceèµ„æº</title>
    <link href="https://www.fomal.cc/posts/b92e2a5d.html"/>
    <id>https://www.fomal.cc/posts/b92e2a5d.html</id>
    <published>2024-10-02T06:32:47.000Z</published>
    <updated>2024-10-02T07:56:03.736Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Serviceèµ„æº">Serviceèµ„æº</h2><p>æ²¡æœ‰serviceèµ„æºï¼Œæƒ³è¦è®¿é—®æœåŠ¡ï¼Œéœ€è¦åœ¨é˜²ç«å¢™åšç«¯å£è½¬å‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">1ã€èµ·ä¸€ä¸ªpodèµ„æº</span><br><span class="line">[root@master01 kubernetes]# vim nginx.yml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-test</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container-v2</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="comment">#ç«¯å£æ˜ å°„</span></span><br><span class="line">    ports:</span><br><span class="line">    - name: http-port</span><br><span class="line">    <span class="comment">#å®¹å™¨çš„80ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„8081ç«¯å£</span></span><br><span class="line">      containerPort: 80</span><br><span class="line">      hostPort: 8081</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œ</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -owide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">nginx-test                    1/1     Running   0          46s     10.2.3.96   node03</span><br><span class="line"></span><br><span class="line">3ã€podèµ·æ¥äº†ï¼Œå¹¶ä¸”è¿è¡Œåœ¨node03èŠ‚ç‚¹ä¸Šï¼ŒæŸ¥çœ‹node03çš„ç«¯å£ï¼Œçœ‹ä¸åˆ°8081ç«¯å£ï¼Œå¯ä»¥æµè§ˆå™¨ç›´æ¥è®¿é—®ï¼Œèƒ½å¤Ÿè®¿é—®åˆ°nginxä¸»é¡µé¢</span><br><span class="line">10.0.0.203:8081</span><br><span class="line"></span><br><span class="line">4ã€å› ä¸ºé˜²ç«å¢™åœ¨åº•å±‚åšäº†ç«¯å£è½¬å‘ï¼Œæ˜¯çœ‹ä¸åˆ°çš„ï¼Œåªè¦è®¿é—®åˆ°node03çš„8081ç«¯å£ï¼Œä¼šè‡ªåŠ¨è½¬å‘è½¬å‘åˆ°å®¹å™¨é‡Œçš„80ç«¯å£</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¦‚æœå¦‚ä¸Šç«¯å£è½¬å‘ä¸€èˆ¬ä¸ä½¿ç”¨ï¼Œæ˜ å°„çš„ç«¯å£çœ‹ä¸åˆ°</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## ä½¿ç”¨æ§åˆ¶å™¨å¯åŠ¨PODæ—¶ï¼Œæ— æ³•å¤šä¸ªPODç»‘å®šåŒä¸€ä¸ªç«¯å£ï¼Œè€Œä¸”æ¯æ¬¡podèµ·æ¥ï¼Œipä¼šå‘ç”Ÿå˜åŒ–</span></span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cat</span> nginx-dp.yaml</span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-dp</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: nginx-dp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx-pod</span><br><span class="line">      namespace: default</span><br><span class="line">      labels:</span><br><span class="line">        run: nginx-dp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-container</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - name: http-port</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 8081</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŠ¥é”™ç«¯å£è¢«å ç”¨</span></span><br><span class="line">[root@master01 kubernetes]# kubectl describe pod nginx-dp-69c9d4dbc5-9xp64</span><br><span class="line">Warning FailedScheduling 44s default-scheduler 0/4 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn<span class="string">&#x27;t tolerate, 3 node(s) didn&#x27;</span>t have free ports <span class="keyword">for</span> the requested pod ports.</span><br><span class="line">Warning FailedScheduling 44s default-scheduler 0/4 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn<span class="string">&#x27;t tolerate, 3 node(s) didn&#x27;</span>t have free ports <span class="keyword">for</span> the requested pod ports.</span><br></pre></td></tr></table></figure><h3 id="1ã€Serviceèµ„æºä»‹ç»"><strong>1ã€Serviceèµ„æºä»‹ç»</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   é€šè¿‡å‰é¢çš„å®éªŒæˆ‘ä»¬å·²ç»æŒæ¡äº†ä½¿ç”¨Podæ§åˆ¶å™¨æ¥ç®¡ç†Podï¼Œæˆ‘ä»¬ä¹Ÿä¼šå‘ç°ï¼ŒPodçš„ç”Ÿå‘½å‘¨æœŸéå¸¸çŸ­æš‚ï¼Œæ¯æ¬¡é•œåƒå‡çº§éƒ½ä¼šé”€æ¯ä»¥åŠåˆ›å»ºï¼Œè€Œæˆ‘ä»¬çŸ¥é“æ¯ä¸ªPodéƒ½æ‹¥æœ‰è‡ªå·±çš„IPåœ°å€ï¼Œå¹¶ä¸”éšç€Podåˆ é™¤å’Œåˆ›å»ºï¼Œè¿™ä¸ªIPæ˜¯ä¼šå˜åŒ–çš„ã€‚</span><br><span class="line">å½“æˆ‘ä»¬çš„Podæ•°é‡éå¸¸å¤šçš„æ—¶å€™å‰ç«¯çš„å…¥å£æœåŠ¡è¯¥æ€ä¹ˆçŸ¥é“åé¢éƒ½æœ‰å“ªäº›Podå‘¢ï¼Ÿ</span><br><span class="line">ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜k8sæä¾›äº†ä¸€ä¸ªå¯¹è±¡Serviceå’Œä¸‰ç§IPï¼Œåˆ›å»ºçš„Serviceèµ„æºé€šè¿‡æ ‡ç­¾å¯ä»¥åŠ¨æ€çš„çŸ¥é“åç«¯çš„Podçš„IPåœ°å€ï¼Œåœ¨PodIPä¹‹ä¸Šè®¾è®¡ä¸€ä¸ªå›ºå®šçš„IPï¼Œä¹Ÿå°±æ˜¯ClusterIPï¼Œç„¶åä½¿ç”¨NodePortæ¥å¯¹å¤–æš´éœ²ç«¯å£æä¾›è®¿é—®ã€‚</span><br><span class="line">æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆè®¤è¯†ä¸€ä¸‹K8sé‡Œçš„ä¸‰ç§IPåŠå…¶ä½œç”¨ã€‚</span><br></pre></td></tr></table></figure><p><strong>K8sä½¿ç”¨çš„ä¸‰ç§IP</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1ã€nodes IPï¼šå®¿ä¸»æœºçš„IP</span><br><span class="line">2ã€Pod IPï¼šå®¹å™¨çš„IPåœ°å€</span><br><span class="line">3ã€Cluster IPï¼šå®¹å™¨çš„è´Ÿè½½å‡è¡¡IP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Serviceèµ„æºæ¶‰åŠåˆ°çš„IPå’Œç½‘ç»œ</span></span><br><span class="line">ClusterIPï¼šIPåœ°å€</span><br><span class="line">NodePortï¼šç«¯å£</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240924175240230.png" alt="image-20240924175240230"></p><h3 id="2ã€ClusterIPçš„èµ„æº"><strong>2ã€ClusterIPçš„èµ„æº</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¦‚æœè¦èµ·ä¸€ä¸ªserviceèµ„æºï¼Œå°±å¿…é¡»å…ˆèµ·ä¸€ä¸ªPod,å†ç»™PODæ‰“ä¸ŠCluster IP</span></span><br><span class="line"></span><br><span class="line">1ã€éœ€è¦å…ˆèµ·ä¸€ä¸ªDeploymentæ§åˆ¶å™¨èµ„æº</span><br><span class="line">[root@master01 service]# vim nginx-dp.yaml</span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: nginx-deploy</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx-pod</span><br><span class="line">      namespace: default</span><br><span class="line">      labels:</span><br><span class="line">        run: nginx-deploy</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-container</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">[root@master01 service]# kubectl apply -f nginx-dp.yaml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deploy-545f948568-66bjf   1/1     Running   0          5s</span><br><span class="line">nginx-deploy-545f948568-f5mhc   1/1     Running   0          5s</span><br><span class="line">nginx-deploy-545f948568-vmkpz   1/1     Running   0          5s</span><br><span class="line"><span class="comment">#ç°åœ¨è®¿é—®ï¼Œå°±ç›¸å½“äºè®¿é—®web01ã€web02ã€web03ï¼Œä½†æ˜¯å‰é¢æ²¡æœ‰åŠ lb01,æ¥ä¸‹æ¥å°±å†™Clusterèµ„æºæ¸…å•ï¼Œå°±ç›¸å½“äºlb01</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€å†™Clusterèµ„æºæ¸…å•,è¿™ä¸ªèµ„æºæ¸…å•è¦ç»™ä¸Šé¢çš„3ä¸ªpodæ‰“ä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„Cluster IP</span><br><span class="line">[root@master01 service]# vim nginx-svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line"><span class="comment">#ä½ çš„serviceèµ·çš„cluster IPè¦ç»™å“ªä¸ªpodç»‘å®šï¼Œå°±ç›¸å½“äºæ ‡ç­¾é€‰æ‹©å™¨ï¼Œè¿™é‡Œçš„æ ‡ç­¾è¦å’Œpodçš„æ ‡ç­¾ä¸€æ ·</span></span><br><span class="line">  selector:</span><br><span class="line">    run: nginx-deploy</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-nginx</span><br><span class="line">  <span class="comment">#å®¿ä¸»æœºé‡Œæ˜ å°„çš„ç«¯å£</span></span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    <span class="comment">#å®¹å™¨çš„çš„ç«¯å£</span></span><br><span class="line">    targetPort: 80</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 service]# kubectl apply -f nginx-svc.yaml</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹svcè¯¦ç»†ä¿¡æ¯</span><br><span class="line">[root@master01 kubernetes]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.1.0.1       &lt;none&gt;        443/TCP   11d  <span class="comment">#è¿™ä¸ªæ˜¯k8såˆ›å»ºçš„svc</span></span><br><span class="line">nginx-svc    ClusterIP   10.1.168.150   &lt;none&gt;        80/TCP    8h</span><br><span class="line">[root@master01 kubernetes]# curl 10.1.168.150</span><br><span class="line">curl ä¸€ä¸‹ï¼Œå¦‚æœé€šäº†ï¼Œè¿™ä¸ªè´Ÿè½½å‡è¡¡å°±åšå¥½äº†</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ³¨æ„ï¼Œå¦‚æœcurlä¸é€šï¼Œä¸è¦ç€æ€¥ï¼Œå…ˆcurlä¸€ä¸‹POdçš„ipæ˜¯å¦èƒ½é€šï¼Œé€šè¿‡å¯ä»¥é€šï¼Œé‚£å°±æ˜¯svcçš„è¯·æ±‚æ— æ³•åˆ°è¾¾pod,å¯èƒ½æ˜¯iptablesé˜²ç«å¢™é˜»æ­¢äº†ï¼Œå¯ä»¥åœ¨å‰é¢åŠ ingressï¼Œå¦‚æœåœ¨æµè§ˆå™¨é‡Œé¢å¯ä»¥è®¿é—®ï¼Œé‚£ä¹ˆingressèƒ½æ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ï¼Œå°±æ²¡é—®é¢˜</span></span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl describe svc nginx-svc</span><br><span class="line">Name:              nginx-svc</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            &lt;none&gt;</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          run=nginx-deploy</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.1.168.150     <span class="comment">#seriviceèµ„æºçš„ip</span></span><br><span class="line">Port:              http-nginx  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         10.2.1.52:80,10.2.2.46:80,10.2.3.111:80</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240925231650457.png" alt="image-20240925231650457"></p><p>åŒä¸€ä¸ªåç§°ç©ºé—´é€šä¿¡çš„æ–¹æ³•ï¼šé€šè¿‡ping serverèµ„æºå è¿›è¡Œé€šä¿¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">4ã€éšä¾¿èµ·ä¸€ä¸ªæœ‰pingå‘½ä»¤çš„podï¼Œå¹¶è¿›å…¥pod</span><br><span class="line">[root@master01 kubernetes]# vim c7.yml </span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: c7-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: c7-container</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line">    </span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f c7.yml </span><br><span class="line"></span><br><span class="line">5ã€è¿æ¥è¿›å…¥å®¹å™¨,ping seriviceèµ„æºçš„ipå’Œseriviceèµ„æºçš„åå­—</span><br><span class="line">[root@master01 service]# kubectl <span class="built_in">exec</span> -it c7-nginx -c c7-container -- /bin/bash</span><br><span class="line">[root@c7-nginx /]# ping  10.1.189.201</span><br><span class="line">[root@c7-nginx /]# ping  nginx-svc</span><br><span class="line">å¯ä»¥ping</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240924195940632.png" alt="image-20240924195940632"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 prometheus]# kubectl get pod -n kube-system</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d56c8448f-85k2r           1/1     Running   2          13d</span><br><span class="line">coredns-6d56c8448f-h697m           1/1     Running   2          8d</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">#æµç¨‹æ¢³ç†ï¼š</span></span><br><span class="line">1ã€å› ä¸ºæˆ‘ä»¬æœ‰2ä¸ªcorednsæœåŠ¡å™¨ï¼Œä»–ä¼šå¸®æˆ‘ä»¬åšä¸€ä¸ªåŸŸåè§£æ</span><br><span class="line">2ã€å•¥æ—¶å€™åšåŸŸåè§£æå‘¢ï¼Ÿ</span><br><span class="line">å½“ä½ applyèµ·ä¸€ä¸ªsvcæ—¶ï¼Œå½“svcèµ·æ¥äº†åï¼Œä»–ä¼šæŠŠ10.1.189.201  nginx-svc(seriviceèµ„æºçš„ipå’Œseriviceèµ„æºçš„åå­—)ç»‘å®šåˆ°é‚£2ä¸ªdnsæœåŠ¡å™¨é‡Œé¢ï¼Œåšä¸€ä¸ªåŸŸåè§£æ</span><br><span class="line"></span><br><span class="line">èµ·äº†ä¸€ä¸ªpodï¼Œpodé‡Œé¢æœ‰dnsçš„é…ç½®ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªip,æ˜¯serviceçš„ip,è¿™ä¸ªèµ·åœ¨kube-systemåç§°ç©ºé—´é‡Œé¢çš„</span><br><span class="line"></span><br><span class="line">[root@master01 prometheus]# kubectl get svc -n kube-system</span><br><span class="line">NAME             TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns         ClusterIP   10.1.0.10     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   13d</span><br><span class="line">metrics-server   ClusterIP   10.1.11.158   &lt;none&gt;        443/TCP                  2d13h</span><br><span class="line">[root@master01 kubernetes]# kubectl describe svc -n kube-system kube-dns</span><br><span class="line">Name:              kube-dns</span><br><span class="line">Namespace:         kube-system</span><br><span class="line">Labels:            k8s-app=kube-dns</span><br><span class="line">                   kubernetes.io/cluster-service=<span class="literal">true</span></span><br><span class="line">                   kubernetes.io/name=KubeDNS</span><br><span class="line">Annotations:       prometheus.io/port: 9153</span><br><span class="line">                   prometheus.io/scrape: <span class="literal">true</span></span><br><span class="line">Selector:          k8s-app=kube-dns</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.1.0.10</span><br><span class="line">Port:              dns  53/UDP</span><br><span class="line">TargetPort:        53/UDP</span><br><span class="line">Endpoints:         10.2.1.5:53,10.2.2.7:53</span><br><span class="line">Port:              dns-tcp  53/TCP</span><br><span class="line">TargetPort:        53/TCP</span><br><span class="line">Endpoints:         10.2.1.5:53,10.2.2.7:53</span><br><span class="line">Port:              metrics  9153/TCP</span><br><span class="line">TargetPort:        9153/TCP</span><br><span class="line">Endpoints:         10.2.1.5:9153,10.2.2.7:9153</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240926232750951.png" alt="image-20240926232750951"></p><p><img src="../image/study_img/image-20240926233119633.png" alt="image-20240926233119633"></p><p>ä¸åç§°ç©ºé—´é€šä¿¡çš„æ–¹æ³•ï¼šping serviceçš„åå­—.serviceçš„åç§°ç©ºé—´.svc.cluster.local</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">1ã€éšä¾¿èµ·ä¸€ä¸ªæœ‰pingå‘½ä»¤çš„podï¼Œå¹¶è¿›å…¥pod</span><br><span class="line">[root@master01 kubernetes]# vim c7.yml </span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: c7-test</span><br><span class="line">  <span class="comment">#è¿™é‡ŒæŒ‡å®šä¸€ä¸ªåç§°ç©ºé—´</span></span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: c7-container</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line">    </span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f c7.yml </span><br><span class="line"></span><br><span class="line">5ã€è¿æ¥è¿›å…¥å®¹å™¨,ping seriviceèµ„æºçš„ipå’Œseriviceèµ„æºçš„åå­—</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it c7-test -n  kube-system -- /bin/bash</span><br><span class="line">[root@c7-test /]# ping nginx-svc</span><br><span class="line">ping: nginx-svc: Name or service not known</span><br><span class="line"><span class="comment">#pingèµ„æºåï¼Œæ— æ³•é€šï¼Œè¯´æ˜ä¸åœ¨åŒä¸€ä¸ªåç§°ç©ºé—´æ˜¯åšç½‘ç»œéš”ç¦»çš„ï¼Œä¸åœ¨åŒä¸€ä¸ªpodä¸èƒ½ç”¨serviceé€šä¿¡</span></span><br><span class="line"></span><br><span class="line">[root@c7-nginx /]# ping  10.1.189.201</span><br><span class="line">ipå¯ä»¥é€šï¼Œä½†æ˜¯ipé€šæ²¡å•¥ç”¨ï¼Œipä¼šå‘ç”Ÿå˜åŒ–</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¦‚æœæœ‰æ—¶å€™ï¼Œå°±æ˜¯æƒ³è¦ä¸åŒåç§°ç©ºé—´çš„é€šä¿¡ï¼Œå°±åƒé˜¿é‡Œäº‘ä¹°æœºå™¨ï¼ŒæŠŠç½‘ç»œæ‰“é€šå†…ç½‘çš„éœ€æ±‚ï¼Œæ‰“é€šå†…å¤–è¿™ç§äº‹ï¼Œk8sä¹Ÿèƒ½åš</span></span><br><span class="line">ping serviceçš„åå­—.serviceçš„åç§°ç©ºé—´.svc.cluster.local</span><br><span class="line"> </span><br><span class="line">[root@c7-test /]# ping nginx-svc.default.svc.cluster.local</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åŸç†ï¼š</span></span><br><span class="line">1ã€é¦–å…ˆèµ·äº†ä¸€ä¸ªc7-testçš„podï¼Œé‡Œé¢æœ‰dnsæœåŠ¡å™¨çš„é…ç½®</span><br><span class="line">[root@c7-test /]# <span class="built_in">cat</span> /etc/resolv.conf</span><br><span class="line">nameserver 10.1.0.10</span><br><span class="line">search kube-system.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">2ã€10.1.0.10è¿™ä¸ªipæ˜¯ä¸€ä¸ªsvcçš„ip,ä¸è¿‡è¿™ä¸ªsvcèµ·åœ¨kube-systemè¿™ä¸ªåç§°ç©ºé—´é‡Œ</span><br><span class="line">[root@master01 prometheus]# kubectl get svc -n kube-system</span><br><span class="line">NAME             TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns         ClusterIP   10.1.0.10     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   13d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl describe svc -n kube-system kube-dns</span><br><span class="line">Name:              kube-dns</span><br><span class="line">Namespace:         kube-system</span><br><span class="line">Labels:            k8s-app=kube-dns</span><br><span class="line">                   kubernetes.io/cluster-service=<span class="literal">true</span></span><br><span class="line">                   kubernetes.io/name=KubeDNS</span><br><span class="line">Annotations:       prometheus.io/port: 9153</span><br><span class="line">                   prometheus.io/scrape: <span class="literal">true</span></span><br><span class="line">Selector:          k8s-app=kube-dns</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.1.0.10</span><br><span class="line">Port:              dns  53/UDP</span><br><span class="line">TargetPort:        53/UDP</span><br><span class="line">Endpoints:         10.2.1.5:53,10.2.2.7:53</span><br><span class="line">Port:              dns-tcp  53/TCP</span><br><span class="line">TargetPort:        53/TCP</span><br><span class="line">Endpoints:         10.2.1.5:53,10.2.2.7:53</span><br><span class="line">Port:              metrics  9153/TCP</span><br><span class="line">TargetPort:        9153/TCP</span><br><span class="line">Endpoints:         10.2.1.5:9153,10.2.2.7:9153</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure><p>ä»¥åpodä¸podçš„é€šä¿¡æµç¨‹å›¾</p><p><img src="../image/study_img/image-20240927194820715.png" alt="image-20240927194820715"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä½†æ˜¯ç°åœ¨å…‰ç”¨Cluster ipæ˜¯æ²¡å•¥ç”¨çš„ï¼Œä¼šå‘ç°Cluster ipçš„ipåœ¨æµè§ˆå™¨æ— æ³•è®¿é—®ï¼Œå› ä¸ºä»–æ˜¯ä¸€ä¸ªå†…ç½‘ip,æƒ³è¦è¿™ä¸ªipèƒ½å¤Ÿè®¿é—®ï¼Œè¿˜éœ€è¦åœ¨å®¿ä¸»æœºä¸Šåšä¸€ä¸ªNodePort ç«¯å£æ˜ å°„ï¼Œæ˜ å°„åˆ°clusterip</span><br></pre></td></tr></table></figure><h3 id="3ã€NodePortèµ„æº-åšç«¯å£æ˜ å°„"><strong>3ã€NodePortèµ„æº    åšç«¯å£æ˜ å°„</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¦‚æœè¦èµ·ä¸€ä¸ªserviceèµ„æºï¼Œå°±å¿…é¡»å…ˆèµ·ä¸€ä¸ªPod,å†ç»™PODæ‰“ä¸ŠNodePort</span></span><br><span class="line"></span><br><span class="line">1ã€éœ€è¦å…ˆèµ·ä¸€ä¸ªDeploymentæ§åˆ¶å™¨èµ„æº</span><br><span class="line">[root@master01 service]# vim nginx-dp.yaml</span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: nginx-deploy</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx-pod</span><br><span class="line">      namespace: default</span><br><span class="line">      labels:</span><br><span class="line">        run: nginx-deploy</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-container</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-dp.yml</span><br><span class="line"></span><br><span class="line">2ã€ç¼–å†™nodeportèµ„æºæ¸…å•   å†™å‘å’Œclusteripä¸€æ ·ï¼Œå°±æŠŠåé¢çš„<span class="built_in">type</span>æ¢ä¸€ä¸‹</span><br><span class="line">[root@master01 service]# vim nginx-svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    run: nginx-deploy</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-nginx</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">    <span class="comment">#æ˜ å°„åˆ°å®¿ä¸»æœº30000çš„ç«¯å£</span></span><br><span class="line">    nodePort: 30000</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  </span><br><span class="line">3ã€åˆ é™¤ä¸Šä¸€ä¸ªå®éªŒçš„nginx-svcèµ„æºï¼Œè¿è¡Œæœ¬æ¬¡ç¼–å†™çš„èµ„æºæ¸…å•  </span><br><span class="line">[root@master01 service]# kubectl delete service nginx-svc</span><br><span class="line">service <span class="string">&quot;nginx-svc&quot;</span> deleted</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 service]# kubectl apply -f nginx-svc.yml </span><br><span class="line">[root@master01 service]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP   10.1.0.1      &lt;none&gt;        443/TCP        11d</span><br><span class="line">nginx-svc    NodePort    10.1.171.27   &lt;none&gt;        80:30000/TCP   63s</span><br><span class="line"><span class="comment">#æŠŠcluster ipçš„80ç«¯å£ï¼Œæ˜ å°„åˆ°å®¿ä¸»æœºçš„30000</span></span><br><span class="line">ä»–èµ·NodePortä¹Ÿå¸®ä½ èµ·ä¸€ä¸ªcluster ip,ä¹Ÿå°±æ˜¯è¯´NodePortä¹ŸåŒ…å«cluster ip,æ‰€ä»¥ä»¥åèµ·çš„æ—¶å€™å°±ä¸éœ€è¦å•ç‹¬èµ·cluster ipçš„èµ„æºäº†</span><br><span class="line"></span><br><span class="line">3ã€è¿æ¥è¿›å…¥å®¹å™¨,ping seriviceèµ„æºçš„åå­—,å¯ä»¥pingé€š</span><br><span class="line">[root@master01 service]# kubectl <span class="built_in">exec</span> -it c7-nginx -c c7-container -- /bin/bash</span><br><span class="line">[root@c7-nginx /]# ping  nginx-svc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å°†æ‹¥æœ‰åŒä¸€ä¸ªæ ‡ç­¾çš„podåˆ†ä¸ºä¸€ç»„ å¯¹å¤–æ˜ å°„ç«¯å£ï¼ˆ30000-65535ï¼‰ è¿›è¡Œè´Ÿè½½ </span></span><br><span class="line">å®¿ä¸»æœº 30000 --- &gt; serIP:80 -----&gt; podip:80</span><br><span class="line"></span><br><span class="line"><span class="comment">## NodePortç«¯å£èŒƒå›´ï¼š30000-32767</span></span><br><span class="line">The Service <span class="string">&quot;nginx-svc&quot;</span> is invalid: spec.ports[0].nodePort: Invalid value: 80:provided port is not <span class="keyword">in</span> the valid range. The range of valid ports is 30000-32767</span><br><span class="line"></span><br><span class="line">ç°åœ¨ä½¿ç”¨æµè§ˆå™¨è®¿é—®ï¼Œå¯ä»¥è®¿é—®åˆ°nginxä¸»é¡µé¢</span><br><span class="line">10.0.0.200:30000</span><br><span class="line">10.0.0.201:30000</span><br><span class="line">10.0.0.202:30000</span><br><span class="line">10.0.0.203:30000</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™ä¸ªå’Œk8sçš„ç»„ä»¶kube-proxyæœ‰å…³ï¼Œåªè¦æœ‰kube-proxyçš„æœºå™¨éƒ½ä¼šåšç«¯å£æ˜ å°„å‡ºæ¥ï¼Œåº•å±‚åšä¸€ä¸ªè½¬å‘ï¼Œkube-proxyåœ¨å¯åŠ¨çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯DaemonSetï¼Œæ¯ä¸ªæœºå™¨éƒ½ä¼šèµ·</span></span><br><span class="line">kube-proxyæä¾›çš„30000ç«¯å£</span><br><span class="line">[root@master01 kubernetes]# netstat -lntup|grep 30000</span><br><span class="line">tcp        0      0 0.0.0.0:30000           0.0.0.0:*               LISTEN      96411/kube-proxy </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ³¨æ„ï¼š</span></span><br><span class="line">ç«¯å£èŒƒå›´æ˜¯30000~32767ï¼Œä¸å¤ªå¥½ç”¨ï¼Œæ‰€ä»¥ä»¥åä¸è¡ŒNodePortï¼Œå†™cluster ipå°±å¯ä»¥ï¼Œä¸è¦NodePortï¼Œå°±å¯ä»¥ä¸ç”¨kube-proxyï¼Œæˆ‘ä»¬ä¼šç”¨ingresså–ä»£</span><br></pre></td></tr></table></figure><h3 id="4ã€Ingressèµ„æºä»‹ç»"><strong>4ã€Ingressèµ„æºä»‹ç»</strong></h3><p>NodePortçš„ç¼ºç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1.æ²¡æœ‰ingressä¹‹å‰ï¼Œpodå¯¹å¤–æä¾›æœåŠ¡åªèƒ½é€šè¿‡NodeIP:NodePortçš„å½¢å¼ï¼Œä½†æ˜¯è¿™ç§å½¢å¼æœ‰ç¼ºç‚¹ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„Portä¸èƒ½é‡å¤åˆ©ç”¨ã€‚æ¯”å¦‚æŸä¸ªæœåŠ¡å ç”¨äº†80ç«¯å£ï¼Œé‚£ä¹ˆå…¶ä»–æœåŠ¡å°±ä¸èƒ½åœ¨ç”¨è¿™ä¸ªç«¯å£äº†ã€‚</span><br><span class="line"></span><br><span class="line">2.NodePortæ˜¯4å±‚ä»£ç†ï¼Œä¸èƒ½è§£æ7å±‚çš„httpï¼Œä¸èƒ½é€šè¿‡åŸŸååŒºåˆ†æµé‡</span><br><span class="line"></span><br><span class="line">3.ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°èµ„æºæ§åˆ¶å™¨å«Ingressï¼Œä½œç”¨å°±æ˜¯æä¾›ä¸€ä¸ªç»Ÿä¸€çš„è®¿é—®å…¥å£ã€‚å·¥ä½œåœ¨7å±‚</span><br><span class="line"></span><br><span class="line">4.è™½ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨nginx/haproxyæ¥å®ç°ç±»ä¼¼çš„æ•ˆæœï¼Œä½†æ˜¯ä¼ ç»Ÿéƒ¨ç½²ä¸èƒ½åŠ¨æ€çš„å‘ç°æˆ‘ä»¬æ–°åˆ›å»ºçš„èµ„æºï¼Œå¿…é¡»æ‰‹åŠ¨ä¿®æ”¹é…ç½®æ–‡ä»¶å¹¶é‡å¯ã€‚</span><br><span class="line"></span><br><span class="line">5.é€‚ç”¨äºk8sçš„ingressæ§åˆ¶å™¨ä¸»æµçš„æœ‰nginx-ingressã€traefikã€haproxy-ingress</span><br></pre></td></tr></table></figure><p>Ingressæ§åˆ¶å™¨<br>1ï¼‰[AKS åº”ç”¨ç½‘å…³Ingresæ§åˆ¶å™¨] ä½¿ç”¨ Azureåº”ç”¨ç¨‹åºç½‘å…³å¯ç”¨AKSé›†ç¾¤ingressã€‚<br>2ï¼‰mbassador APIç½‘å…³ï¼Œä¸€ä¸ªåŸºäºEnvoyçš„Ingressæ§åˆ¶å™¨ï¼Œæœ‰ç€æ¥è‡ªç¤¾åŒºçš„æ”¯æŒå’Œæ¥è‡ªDatawireçš„å•†ä¸šæ”¯æŒã€‚<br>3ï¼‰AppsCode Inc ä¸ºæœ€å¹¿æ³›ä½¿ç”¨çš„åŸºäºHAproxyçš„Ingressæ§åˆ¶å™¨Voyageræä¾›è‡ªæŒå’Œç»´æŠ¤ã€‚<br>4ï¼‰AWS ALB Ingressæ§åˆ¶å™¨ï¼Œé€šè¿‡AWSåº”ç”¨Load Balancerå¯ç”¨Ingressã€‚<br>5ï¼‰Contouræ˜¯ä¸€ä¸ªåŸºäºEnvoyçš„Ingressæ§åˆ¶å™¨ï¼Œå®ƒç”±VMwareæä¾›å’Œæ”¯æŒã€‚<br>6ï¼‰Citrixä¸ºå…¶ç¡¬ä»¶ï¼ˆMPXï¼‰ï¼Œè™šæ‹ŸåŒ–ï¼ˆVPXï¼‰å’Œå…è´¹å®¹å™¨åŒ–ï¼ˆCPXï¼‰ADCæä¾›äº†ä¸€ä¸ªIngressæ§åˆ¶å™¨ï¼Œç”¨äºè£¸é‡‘å±å’Œäº‘éƒ¨ç½²ã€‚<br>7ï¼‰F5 Networksä¸ºç”¨äºKubernetesçš„F5 BIG-IPæ§åˆ¶å™¨æä¾›æ”¯æŒå’Œç»´æŠ¤ã€‚<br>8ï¼‰Glooæ˜¯ä¸€ä¸ªå¼€æºçš„åŸºäºEnvoyçš„Ingressæ§åˆ¶å™¨ï¼Œå®ƒæä¾›äº†APIç½‘å…³åŠŸèƒ½ï¼Œæœ‰ç€æ¥è‡ªsolo.ioçš„ä¼ä¸šçº§æ”¯æŒã€‚<br>9ï¼‰HAproxy Ingressæ˜¯HAproxyé«˜åº¦å¯å®šåˆ¶çš„ã€ç”±ç¤¾åŒºé©±åŠ¨çš„Ingressæ§åˆ¶å™¨ã€‚<br>10ï¼‰HAproxy Technologiesä¸ºç”¨äºKubernetesçš„HAproxy Ingressæ§åˆ¶å™¨æä¾›æ”¯æŒå’Œç»´æŠ¤ï¼Œå…·ä½“ä¿¡æ¯è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚<br>11ï¼‰åŸºäºIstioçš„ingressæ§åˆ¶å™¨ï¼Œæ§åˆ¶Ingressæµé‡ã€‚<br>12ï¼‰Kongä¸ºç”¨äºKubernetesçš„Kong Ingressæ§åˆ¶å™¨æä¾›ç¤¾åŒºæˆ–å•†ä¸šæ”¯æŒå’Œç»´æŠ¤ã€‚<br>14ï¼‰Nginx ä¸ºç”¨äºKubernetesçš„Nginx Ingressæ§åˆ¶å™¨æä¾›æ”¯æŒå’Œç»´æŠ¤<br>15ï¼‰Traefikï¼ˆå°èœœèœ‚ï¼‰æ˜¯ä¸€ä¸ªå…¨åŠŸèƒ½çš„Ingressæ§åˆ¶å™¨ã€‚ï¼ˆLetâ€™s Encryptï¼Œsecretsï¼Œhttp2ï¼Œwebsocketï¼‰å¹¶ä¸”å®ƒä¹Ÿæœ‰Traefik Labsçš„å•†ä¸šæ”¯æŒ</p><p><img src="../image/study_img/image-20240924121232376.png" alt="image-20240924121232376"></p><p>1ã€éƒ¨ç½²nginx-ingress</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubeguide</span><br><span class="line">æƒå¨æŒ‡å—çš„èµ„æºæ¸…å•ç½‘å€ï¼šhttps://github.com/kubeguide/K8sDefinitiveGuide-V5-Sourcecode/blob/main/Chapter04/4.6.1%20nginx-ingress-controller.yaml</span><br><span class="line"></span><br><span class="line">1ã€ä¸‹è½½æƒå¨æŒ‡å—çš„èµ„æºæ¸…å• ingressèµ„æºæ¸…å•</span><br><span class="line">[root@master01 service]# vim nginx-ingress.yaml</span><br><span class="line">æŠŠå¤åˆ¶çš„èµ„æºæ¸…å•ç²˜è´´</span><br><span class="line">135è¡Œï¼š kind: Deployment æ”¹ä¸º kind: DaemonSet</span><br><span class="line">130è¡Œï¼š  åˆ é™¤ data:</span><br><span class="line">140è¡Œï¼š  åˆ é™¤ replicas: 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™2è¡Œæ˜¯ç»™nodeæ‰“æ ‡ç­¾çš„ï¼Œåªæœ‰æ‰“äº†æ ‡ç­¾æ‰è£…åœ¨nodeä¸Šé¢ï¼Œè¦ä¹ˆæ³¨é‡Šè¿™ä¸¤è¡Œï¼Œè¦ä¹ˆç»™nodeæ‰“æ ‡ç­¾     èŠ‚ç‚¹æ ‡ç­¾é€‰æ‹©å™¨</span></span><br><span class="line">147è¡Œï¼š      nodeSelector:</span><br><span class="line">148è¡Œï¼š        role: ingress-nginx-controller</span><br><span class="line"></span><br><span class="line"><span class="comment">#å»ºè®®å¤åˆ¶ä¹‹åç²˜è´´åœ¨VScodeé‡Œé¢ï¼Œæ ¼å¼ä¸ä¼šå‡ºé”™</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240924213753073.png" alt="image-20240924213753073"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2ã€ç»™nodeèŠ‚ç‚¹æ‰“ä¸Šæ ‡ç­¾</span><br><span class="line">[root@master01 kubernetes]# kubectl label node node01 role=ingress-nginx-controller</span><br><span class="line">node/node01 labeled</span><br><span class="line">[root@master01 kubernetes]# kubectl label node node02 role=ingress-nginx-controller</span><br><span class="line">node/node02 labeled</span><br><span class="line">[root@master01 kubernetes]# kubectl label node node03 role=ingress-nginx-controller</span><br><span class="line">node/node03 labeled</span><br><span class="line"></span><br><span class="line">3ã€è¿è¡Œèµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-ingress.yaml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -n nginx-ingress -owide</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">nginx-ingress-hrn5v   1/1     Running   0          2m16s   10.2.3.98   node03</span><br><span class="line">nginx-ingress-hsvgc   1/1     Running   0          2m16s   10.2.1.45   node01</span><br><span class="line">nginx-ingress-tzsht   1/1     Running   0          2m16s   10.2.2.40   node02</span><br></pre></td></tr></table></figure><p>2ã€ä½¿ç”¨ingresså¯åŠ¨è‡ªå·±çš„ç«™ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¸ºé¿å…æ•°æ®åº“æœ‰è„æ•°æ®ï¼Œå…ˆåˆ é™¤èŠ‚ç‚¹ä¸Šä¹‹å‰æ˜ å°„çš„æ•°æ®åº“ç›®å½•</span><br><span class="line">[root@node01 ~]#  <span class="built_in">rm</span> -rf /data/</span><br><span class="line">[root@node02 ~]#  <span class="built_in">rm</span> -rf /data/</span><br><span class="line">[root@node03 ~]#  <span class="built_in">rm</span> -rf /data/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€# wordpress pod    èµ·Deploymentèµ„æº</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f wp-dp-v1.yml </span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: wp-dp</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line"><span class="comment">#èµ·2ä¸ªï¼Œæ•°æ®ä¹Ÿæ˜¯2ä¸ªï¼Œé™¤éæŠŠæ•°æ®åˆ†å¼€</span></span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">    <span class="comment">#è¿™é‡Œçš„æ ‡ç­¾ä¸€å®šè¦å’Œsvcçš„æ ‡ç­¾ä¸€æ ·ï¼Œä¸ç„¶ä¼šè¿æ¥ä¸åˆ°</span></span><br><span class="line">      app: wp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: wp-pod</span><br><span class="line">      namespace: default</span><br><span class="line">      labels:</span><br><span class="line">        app: wp</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: mysql-data</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /data/mysql</span><br><span class="line">      - name: wp-data</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /data/wp</span><br><span class="line"></span><br><span class="line">      containers:</span><br><span class="line">      - name: wp-container</span><br><span class="line">        image: wordpress</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="comment">#livenessProbe:</span></span><br><span class="line">        <span class="comment">#  tcpSocket:</span></span><br><span class="line">        <span class="comment">#    port: 80</span></span><br><span class="line">        <span class="comment">#  initialDelaySeconds: 10</span></span><br><span class="line">        <span class="comment">#  periodSeconds: 3</span></span><br><span class="line">        <span class="comment">#  timeoutSeconds: 3</span></span><br><span class="line">        <span class="comment">#  failureThreshold: 3</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 3306</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">          periodSeconds: 2</span><br><span class="line">          successThreshold: 3</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: WORDPRESS_DB_HOST</span><br><span class="line">          value: <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_USER</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_NAME</span><br><span class="line">          value: <span class="string">&#x27;wp_db&#x27;</span></span><br><span class="line">        </span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: wp-data</span><br><span class="line">          mountPath: /var/www/html/</span><br><span class="line">    </span><br><span class="line">      - name: mysql-container</span><br><span class="line">        image: mysql:5.7</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - --character-set-server=utf8</span><br><span class="line">        - --collation-server=utf8_general_ci</span><br><span class="line">        livenessProbe:</span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;mysqladmin -uroot -p123 ping&quot;</span>]</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          timeoutSeconds: 3</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        - name: MYSQL_DATABASE</span><br><span class="line">          value: <span class="string">&#x27;wp_db&#x27;</span></span><br><span class="line">        - name: MYSQL_USER</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: MYSQL_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: mysql-data</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€# wordpress service</span><br><span class="line">[root@master01 kubernetes]# vim wp-svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: wordpress-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">  <span class="comment">#è¿™é‡Œçš„æ ‡ç­¾ä¸€å®šè¦å’Œpod-dpçš„æ ‡ç­¾ä¸€æ ·ï¼Œä¸ç„¶ä¼šè¿æ¥ä¸åˆ°</span></span><br><span class="line">    app: wp</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  </span><br><span class="line">3ã€# å¯¹å¤–æä¾›æœåŠ¡çš„wordpress ingress</span><br><span class="line">[root@master01 kubernetes]# vim wp-ingress.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: wordpress-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  <span class="comment">#ç«™ç‚¹çš„åŸŸå</span></span><br><span class="line">  - host: blog.wp.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: ImplementationSpecific</span><br><span class="line">        <span class="comment">#backendä¹‹å‰çš„éƒ½æ˜¯ç½‘ç«™ç›¸å…³é…ç½®</span></span><br><span class="line">        <span class="comment">##ä»backendä¹‹åçš„éƒ½æ˜¯ingresså…³è”ClusterIP</span></span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">          <span class="comment">#è¿™é‡Œå¿…é¡»è¦å†™svcç½‘ç«™çš„åå­—</span></span><br><span class="line">            name: wordpress-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">              </span><br><span class="line">4ã€è¿è¡Œ</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f wp-ingress.yml </span><br><span class="line">ingress.networking.k8s.io/wordpress-ingress created</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f wp-dp-v1.yml  </span><br><span class="line">pod/wp-pod created</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f wp-svc.yml </span><br><span class="line">service/wordpress-svc created</span><br><span class="line"></span><br><span class="line">5ã€æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl get ingress</span><br><span class="line">Warning: extensions/v1beta1 Ingress is deprecated <span class="keyword">in</span> v1.14+, unavailable <span class="keyword">in</span> v1.22+; use networking.k8s.io/v1 Ingress</span><br><span class="line">NAME                CLASS    HOSTS         ADDRESS   PORTS   AGE</span><br><span class="line">wordpress-ingress   &lt;none&gt;   blog.wp.com             80      13s</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl get svc</span><br><span class="line">wordpress-svc   ClusterIP   10.1.42.145    &lt;none&gt;        80/TCP         25s</span><br><span class="line">[root@master01 kubernetes]# kubectl describe svc wordpress-svc </span><br><span class="line">Name:              wordpress-svc</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            &lt;none&gt;</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          app=wp</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.1.84.160</span><br><span class="line">Port:              http  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         10.2.3.118:80  <span class="comment">#æ˜¾ç¤ºæ‰¾åˆ°äº†pod ip</span></span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -owide</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE   IP           NODE  </span><br><span class="line">wp-dp-9d48b944b-z6snw           2/2     Running   0          22m   10.2.3.118   node03</span><br></pre></td></tr></table></figure><p>3ã€æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1ã€æœ¬åœ°æœºå™¨åšåŸŸåè§£æï¼Œingressèµ·åœ¨nodeèŠ‚ç‚¹ä¸Šçš„ï¼ŒnodeèŠ‚ç‚¹çš„ipåšè°çš„åŸŸåè§£æéƒ½å¯ä»¥</span><br><span class="line">10.0.0.201  blog.wp.com</span><br><span class="line"></span><br><span class="line">2ã€ä½¿ç”¨åŸŸååœ¨æµè§ˆå™¨è®¿é—®æˆåŠŸï¼Œè¿™å°±æ˜¯ingressçš„ç›¸å…³ï¼Œè€Œä¸”è¿˜æ˜¯80ç«¯å£ï¼Œä»¥åä¸ç®¡èµ·å¤šå°‘ä¸ªç½‘ç«™ï¼Œéƒ½èµ°80ç«¯å£ï¼Œä½†æ˜¯nodeèŠ‚ç‚¹ä¸Šçœ‹ä¸åˆ°80ç«¯å£çš„ï¼Œåªæ˜¯åœ¨åº•å±‚çš„é˜²ç«å¢™åšçš„è½¬å‘</span><br><span class="line">blog.wp.com</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;3ã€iptables -Fè¿™ä¸ªå‘½ä»¤åƒä¸‡ä¸è¦æ‰§è¡Œï¼Œä»–ä¼šæ¸…ç©ºiptablesæ‰€æœ‰çš„è½¬å‘é…ç½®&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240927230958071.png" alt="image-20240927230958071"></p><p><img src="../image/study_img/image-20240927231602977.png" alt="image-20240927231602977"></p><p>å°†åŸŸåè§£ææ”¹åˆ°å…¶ä»–nodeï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŸŸåè®¿é—®æˆåŠŸ</p><p><img src="../image/study_img/image-20240927231929202.png" alt="image-20240927231929202"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ä»–åˆ°nodeèŠ‚ç‚¹çš„æœºå™¨ï¼Œè½¬å‘åˆ°cluster ipä¸Šï¼Œcluster ipå»è®¿é—®podï¼Œä½†æˆ‘ä»¬çš„podå°±ä¸€ä¸ªpodï¼Œæ‰€ä»¥æš‚æ—¶æ²¡æœ‰æ—¥å¿—æ˜¾ç¤ºæ˜¯å“ªå°æœºå™¨è½¬å‘çš„</span><br><span class="line"></span><br><span class="line">è§£æåˆ°å“ªï¼Œå–å†³äºå“ªäº›æœºå™¨å®‰è£…äº†ingress</span><br></pre></td></tr></table></figure><p>3ã€ingressèµ„æºè§£æ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">spec:                                          <span class="comment">#è½¬å‘è§„åˆ™</span></span><br><span class="line">  rules:                                       <span class="comment">#è½¬å‘è§„åˆ™</span></span><br><span class="line">  <span class="comment">#ç«™ç‚¹çš„åŸŸå</span></span><br><span class="line">  - host: blog.wp.com                          <span class="comment">#åŒ¹é…çš„åŸŸå</span></span><br><span class="line">    http:                                      <span class="comment">#åŸºäºhttpåè®®è§£æ</span></span><br><span class="line">      paths:                                   <span class="comment">#åŸºäºè·¯å¾„è¿›è¡ŒåŒ¹é…</span></span><br><span class="line">      - path: /                                <span class="comment">#åŒ¹é…/è·¯å¾„</span></span><br><span class="line">        pathType: ImplementationSpecific       <span class="comment">#è·¯å¾„ç±»å‹</span></span><br><span class="line">        backend:                               <span class="comment">#åŒ¹é…åè·³è½¬çš„åç«¯æœåŠ¡</span></span><br><span class="line">          service:                       <span class="comment">#è®¾ç½®åç«¯è·³è½¬åˆ°Serviceçš„é…ç½®</span></span><br><span class="line">            name: wordpress-svc          <span class="comment">#è·³è½¬åˆ°åä¸ºwordpress-svcçš„ClusterIP</span></span><br><span class="line">            port:                              <span class="comment">#è·³è½¬åˆ°çš„ç«¯å£</span></span><br><span class="line">              number: 80                       <span class="comment">#Serviceç«¯å£å·</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># pathTypeè·¯å¾„ç±»å‹æ”¯æŒçš„ç±»å‹ï¼š</span></span><br><span class="line">ImplementationSpecific ç³»ç»Ÿé»˜è®¤ï¼Œç”±IngressClassæ§åˆ¶å™¨æä¾›</span><br><span class="line">Exact ç²¾ç¡®åŒ¹é…URLè·¯å¾„ï¼ŒåŒºåˆ†å¤§å°å†™  ç›¸å½“äºnginxé…ç½®æ–‡ä»¶çš„ location = /  ~ * è¿™ç§</span><br><span class="line">Prefix åŒ¹é…URLè·¯å¾„çš„å‰ç¼€ï¼ŒåŒºåˆ†å¤§å°å†™</span><br></pre></td></tr></table></figure><h3 id="5ã€ServiceæœåŠ¡å‘ç°"><strong>5ã€ServiceæœåŠ¡å‘ç°</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åœ¨k8sä¸­ï¼Œä¸€ä¸ªserviceå¯¹åº”çš„â€œåç«¯â€ç”±Podçš„IPå’Œå®¹å™¨ç«¯å£å·ç»„æˆï¼Œå³ä¸€ä¸ªå®Œæ•´çš„<span class="string">&quot;IP:Port&quot;</span>è®¿é—®åœ°å€ï¼Œè¿™åœ¨k8sé‡Œå«åšEndpointã€‚é€šè¿‡æŸ¥çœ‹Serviceçš„è¯¦ç»†ä¿¡æ¯å¯ä»¥çœ‹åˆ°åç«¯Endpointçš„åˆ—è¡¨ã€‚</span><br><span class="line">[rootÂ©node1 ~]# kubectl describe svc my-nginx</span><br><span class="line">Endpoints:  10.2.1.24:80,10.2.1.26:80,10.2.1.27:89 more...</span><br><span class="line"></span><br><span class="line">æŠŠä¸€ä¸ªpodåˆ æ‰åï¼Œè‡ªåŠ¨èµ·æ¥çš„å°±ä¼šè‡ªåŠ¨åŠ åˆ°cluster ipé‡Œ</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨DNSåŸŸåçš„å½¢å¼è®¿é—®Serviceï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªå‘½åç©ºé—´é‡Œç”šè‡³å¯ä»¥ç›´æ¥ä½¿ç”¨serviceåæ¥è®¿é—®æœåŠ¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">servicename.namespace.svc.cluster.local</span><br><span class="line">servicename.namespace</span><br><span class="line">servicename</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240927183355537.png" alt="image-20240927183355537"></p>]]></content>
    
    
    <summary type="html">Serviceèµ„æºå’Œk8sçš„ä¸‰ç§IP</summary>
    
    
    
    <category term="k8s" scheme="https://www.fomal.cc/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰9ã€KubernetesæŒä¹…åŒ–å‚¨å­˜</title>
    <link href="https://www.fomal.cc/posts/a288ff46.html"/>
    <id>https://www.fomal.cc/posts/a288ff46.html</id>
    <published>2024-10-02T06:32:31.000Z</published>
    <updated>2024-10-02T07:56:03.737Z</updated>
    
    <content type="html"><![CDATA[<h2 id="KubernetesæŒä¹…åŒ–å‚¨å­˜">KubernetesæŒä¹…åŒ–å‚¨å­˜</h2><h3 id="1ã€K8sæŒä¹…åŒ–å‚¨å­˜ä»‹ç»"><strong>1ã€K8sæŒä¹…åŒ–å‚¨å­˜ä»‹ç»</strong></h3><p>â€‹      ä¹‹å‰æ¥è§¦hostpathã€emptyDirçš„æ˜¯æœ¬åœ°å‚¨å­˜ï¼Œç¼ºé™·æ•°æ®ä¸èƒ½åšåˆ°å’Œå…¶ä»–æœºå™¨å…±äº«</p><p>â€‹       å®¹å™¨å†…éƒ¨çš„çš„å­˜å‚¨åœ¨ç”Ÿå‘½å‘¨æœŸæ˜¯çŸ­æš‚çš„ï¼Œä¼šéšç€å®¹å™¨ç¯å¢ƒçš„é”€æ¯è€Œé”€æ¯ï¼Œå…·æœ‰ä¸ç¨³å®šæ€§ï¼Œåœ¨k8sé‡Œå°†å¯¹å®¹å™¨åº”ç”¨æ‰€éœ€çš„å­˜å‚¨èµ„æºæŠ½è±¡ä¸ºå­˜å‚¨å·(Volume)æ¦‚å¿µæ¥è§£å†³è¿™äº›é—®é¢˜ã€‚</p><p>K8sç›®å‰æ”¯æŒçš„Volumeç±»å‹åŒ…æ‹¬k8sçš„å†…éƒ¨èµ„æºå¯¹è±¡ç±»å‹ï¼Œå¼€æºå…±äº«å­˜å‚¨ç±»å‹å’Œå…¬æœ‰äº‘å­˜å‚¨ç­‰ã€‚åˆ†ç±»å¦‚ä¸‹:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#K8sç‰¹å®šçš„èµ„æºå¯¹è±¡</span></span><br><span class="line">configMapï¼šå‚¨å­˜é…ç½®æ–‡ä»¶  (é…ç½®ä¸­å¿ƒ:nacos)</span><br><span class="line">Secretï¼šå‚¨å­˜åŠ å¯†æ•°æ®ï¼Œè¯ä¹¦æ–‡ä»¶</span><br><span class="line">ServiceAccountTokenï¼šå‚¨å­˜tokenæ•°æ®</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æœ¬åœ°å‚¨å­˜ï¼špodèµ·åœ¨å“ªï¼Œæ•°æ®å°±åœ¨å“ªä¸ªæœºå™¨</span></span><br><span class="line">EmptDirï¼šä¸´æ—¶å‚¨å­˜(å®¿ä¸»æœºéšæœºç”Ÿæˆä¸€ä¸ªå‚¨å­˜ç›®å½•)</span><br><span class="line">HostPathï¼šå®¿ä¸»æœºç›®å½•</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç½‘ç»œå…±äº«å‚¨å­˜</span></span><br><span class="line">CephFSï¼šå¼€æºå…±äº«å‚¨å­˜ç³»ç»Ÿ(ç°åœ¨ç”¨çš„æ¯”è¾ƒå¤šä¸€äº›)</span><br><span class="line">ClusterFSï¼šå¼€æºå…±äº«å‚¨å­˜ç³»ç»Ÿ  FastDFS</span><br><span class="line">NFSï¼šå¼€æºå…±äº«å‚¨å­˜  (è¿™ä¸ªæ˜¯å•ç‚¹ï¼Œå†™è„šæœ¬ä¼šå¡ä¸»)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PVå…±äº«å­˜å‚¨ï¼š</span></span><br><span class="line">PersishtenVolumeClainï¼š</span><br></pre></td></tr></table></figure><h3 id="2ã€æœ¬åœ°å‚¨å­˜â€”â€”EmptyDirç±»å‹çš„æŒ‚è½½æ–¹å¼"><strong>2ã€æœ¬åœ°å‚¨å­˜â€”â€”EmptyDirç±»å‹çš„æŒ‚è½½æ–¹å¼</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™Deploymentæ§åˆ¶å™¨çš„èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim nginx-emptDir.yml</span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-dp</span><br><span class="line">  namespace: default</span><br><span class="line">spec: </span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mysql-dp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx-dp-pod</span><br><span class="line">      namespace: default</span><br><span class="line">      labels:</span><br><span class="line">        app: mysql-dp</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: mysql-emptydir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: mysql-container</span><br><span class="line">        image: mysql:5.7</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: mysql-emptydir</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œå¹¶æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-emptDir.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -owide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE  </span><br><span class="line">nginx-dp-67b5bd5fdc-kvjqh   1/1     Running   0          18s   10.2.3.119   node03</span><br><span class="line"></span><br><span class="line">3ã€node03æŸ¥çœ‹æŒ‚è½½çš„æ•°æ®</span><br><span class="line">[root@node03 ~]# docker inspect fb799f13d7e9</span><br><span class="line">[root@node03 ~]# ll /var/lib/kubelet/pods/9be94529-0040-4185-91c8-91b4b271d387/volumes/kubernetes.io~empty-dir/mysql-emptydir</span><br><span class="line">-rw-r----- 1 polkitd input       56 Sep 28 11:53 auto.cnf</span><br><span class="line">-rw------- 1 polkitd input     1680 Sep 28 11:53 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 polkitd input     1112 Sep 28 11:53 ca.pem</span><br><span class="line">-rw-r--r-- 1 polkitd input     1112 Sep 28 11:53 client-cert.pem</span><br><span class="line">-rw------- 1 polkitd input     1680 Sep 28 11:53 client-key.pem</span><br><span class="line">-rw-r----- 1 polkitd input     1318 Sep 28 11:53 ib_buffer_pool</span><br><span class="line">-rw-r----- 1 polkitd input 79691776 Sep 28 11:53 ibdata1</span><br><span class="line">-rw-r----- 1 polkitd input 50331648 Sep 28 11:53 ib_logfile0</span><br><span class="line">-rw-r----- 1 polkitd input 50331648 Sep 28 11:53 ib_logfile1</span><br><span class="line">-rw-r----- 1 polkitd input 12582912 Sep 28 11:53 ibtmp1</span><br><span class="line">drwxr-x--- 2 polkitd input     4096 Sep 28 11:53 mysql</span><br><span class="line">lrwxrwxrwx 1 polkitd input       27 Sep 28 11:53 mysql.sock -&gt; /var/run/mysqld/mysqld.sock</span><br><span class="line">drwxr-x--- 2 polkitd input     8192 Sep 28 11:53 performance_schema</span><br><span class="line">-rw------- 1 polkitd input     1680 Sep 28 11:53 private_key.pem</span><br><span class="line">-rw-r--r-- 1 polkitd input      452 Sep 28 11:53 public_key.pem</span><br><span class="line">-rw-r--r-- 1 polkitd input     1112 Sep 28 11:53 server-cert.pem</span><br><span class="line">-rw------- 1 polkitd input     1680 Sep 28 11:53 server-key.pem</span><br><span class="line">drwxr-x--- 2 polkitd input     8192 Sep 28 11:53 sys</span><br></pre></td></tr></table></figure><h3 id="3ã€æœ¬åœ°å‚¨å­˜â€”â€”hostpathç±»å‹"><strong>3ã€æœ¬åœ°å‚¨å­˜â€”â€”hostpathç±»å‹</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™æ§åˆ¶å™¨çš„èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim nginx-hostpath.yml</span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-dp</span><br><span class="line">  namespace: default</span><br><span class="line">spec: </span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mysql-dp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx-dp-pod</span><br><span class="line">      namespace: default</span><br><span class="line">      labels:</span><br><span class="line">        app: mysql-dp</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: mysql-emptydir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      - name: mysql-hostpath</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /opt/mysql</span><br><span class="line">      containers:</span><br><span class="line">      - name: mysql-container</span><br><span class="line">        image: mysql:5.7</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: mysql-hostpath</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-hostpath.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4ã€å…±äº«å‚¨å­˜â€”â€”NFSç±»å‹"><strong>4ã€å…±äº«å‚¨å­˜â€”â€”NFSç±»å‹</strong></h3><p><img src="../image/study_img/image-20240928175642454.png" alt="image-20240928175642454"></p><p>1ã€éƒ¨ç½²NFS</p><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th></tr></thead><tbody><tr><td>nfs</td><td>10.0.0.31  /  172.16.1.31</td><td></td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#NFSæœåŠ¡å™¨ä¸èƒ½èµ·åœ¨Podé‡Œçš„ï¼Œå‚¨å­˜ç±»çš„å‡ ä¹ä¸ä¼šç”¨podå»èµ·çš„</span></span><br><span class="line"></span><br><span class="line">1ã€NFSæœåŠ¡å®‰è£…NFS</span><br><span class="line">[root@nfs ~]# yum -y install nfs-utils</span><br><span class="line"></span><br><span class="line">2ã€nodeèŠ‚ç‚¹è¦æŒ‚è½½è¿‡å»ï¼Œæ‰€æœ‰nodeèŠ‚ç‚¹å®‰è£…nfs</span><br><span class="line">[root@node01 ~]# yum -y install nfs-utils</span><br><span class="line">[root@node02 ~]# yum -y install nfs-utils</span><br><span class="line">[root@node03 ~]# yum -y install nfs-utils</span><br><span class="line"></span><br><span class="line">3ã€ä¿®æ”¹nfsæœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶</span><br><span class="line">[root@nfs ~]# vim /etc/exports</span><br><span class="line">/data/wp 172.16.1.0/24(rw,<span class="built_in">sync</span>,all_squash)</span><br><span class="line"></span><br><span class="line">4ã€åˆ›å»ºæŒ‚è½½ç›®å½•ï¼Œå¹¶æˆæƒï¼Œå¯åŠ¨æœåŠ¡</span><br><span class="line">[root@nfs ~]# <span class="built_in">mkdir</span> -p /data/wp</span><br><span class="line">[root@nfs ~]# <span class="built_in">chown</span> -R nfsnobody.nfsnobody /data/wp</span><br><span class="line">[root@nfs ~]# systemctl start nfs &amp;&amp; systemctl <span class="built_in">enable</span> nfs </span><br><span class="line"></span><br><span class="line">5ã€éªŒè¯ç”Ÿæ•ˆ</span><br><span class="line">[root@nfs ~]# <span class="built_in">cat</span> /var/lib/nfs/etab </span><br><span class="line">/data/wp        172.16.1.0/24(rw,<span class="built_in">sync</span>,wdelay,hide,nocrossmnt,secure,root_squash,all_squash,no_subtree_check,secure_locks,acl,no_pnfs,anonuid=65534,anongid=65534,sec=sys,rw,secure,root_squash,all_squash)</span><br></pre></td></tr></table></figure><p>2ã€masterç¼–å†™wpæŒ‚è½½nfsçš„èµ„æºæ¸…å•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™wpçš„Deploymentèµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim wp-dp-v1.yml </span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: wp-dp</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line"><span class="comment">#èµ·2ä¸ªï¼Œæ•°æ®ä¹Ÿæ˜¯2ä¸ªï¼Œé™¤éæŠŠæ•°æ®åˆ†å¼€</span></span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: wp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: wp-pod</span><br><span class="line">      namespace: default</span><br><span class="line">      labels:</span><br><span class="line">        app: wp</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: wp-data</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /data/wp</span><br><span class="line"></span><br><span class="line">      <span class="comment">#-----------------æŒ‚è½½nfsçš„å†™æ³•---------------------</span></span><br><span class="line">      <span class="comment">#æœ€åä¸€è¡ŒæŒ‚è½½çš„åå­—è¦æ”¹ä¸€ä¸‹</span></span><br><span class="line">      <span class="comment"># mount -t nfs 172.16.1.31:/data/wordpress /var/www/html</span></span><br><span class="line">      - name: wp-nfs    </span><br><span class="line">        nfs:</span><br><span class="line">      <span class="comment">#nfsæœåŠ¡å™¨é…ç½®æ–‡ä»¶å†™çš„å…±äº«ç›®å½•</span></span><br><span class="line">          path: /data/wp</span><br><span class="line">          readOnly: <span class="literal">false</span></span><br><span class="line">      <span class="comment">#serverå°±æ˜¯nfsæœåŠ¡çš„ip</span></span><br><span class="line">          server: 172.16.1.31</span><br><span class="line"></span><br><span class="line">      containers:</span><br><span class="line">      - name: wp-container</span><br><span class="line">        image: wordpress</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="comment">#livenessProbe:</span></span><br><span class="line">        <span class="comment">#  tcpSocket:</span></span><br><span class="line">        <span class="comment">#    port: 80</span></span><br><span class="line">        <span class="comment">#  initialDelaySeconds: 10</span></span><br><span class="line">        <span class="comment">#  periodSeconds: 3</span></span><br><span class="line">        <span class="comment">#  timeoutSeconds: 3</span></span><br><span class="line">        <span class="comment">#  failureThreshold: 3</span></span><br><span class="line">        <span class="comment">#readinessProbe:</span></span><br><span class="line">        <span class="comment">#  tcpSocket:</span></span><br><span class="line">        <span class="comment">#    host: mysql-svc</span></span><br><span class="line">        <span class="comment">#    port: 3306</span></span><br><span class="line">        <span class="comment">#  initialDelaySeconds: 3</span></span><br><span class="line">        <span class="comment">#  timeoutSeconds: 1</span></span><br><span class="line">        <span class="comment">#  periodSeconds: 2</span></span><br><span class="line">        <span class="comment">#  successThreshold: 3</span></span><br><span class="line">        <span class="comment">#  failureThreshold: 3</span></span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: WORDPRESS_DB_HOST</span><br><span class="line">          value: <span class="string">&#x27;mysql-svc&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_USER</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_NAME</span><br><span class="line">          value: <span class="string">&#x27;wp_db&#x27;</span></span><br><span class="line">        </span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: wp-nfs</span><br><span class="line">          mountPath: /var/www/html/</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f wp-dp-v1.yml </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ç¼–å†™wpçš„Serviceèµ„æº</span><br><span class="line">[root@master01 kubernetes]# vim wp-svc.yml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: wordpress-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: wp</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    <span class="comment">#è¿™é‡Œä¸´æ—¶ä¸ºäº†æµ‹è¯•ï¼Œæ‰€ä»¥ä¸´æ—¶ä½¿ç”¨NodePort</span></span><br><span class="line">    targetPort: 80</span><br><span class="line">    nodePort: 30002</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  </span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f wp-svc.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get svc</span><br><span class="line">NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)     </span><br><span class="line">wordpress-svc   NodePort    10.1.84.160    &lt;none&gt;        80:30002/TCP</span><br><span class="line"></span><br><span class="line">3ã€ç¼–å†™mysqlçš„Deploymentèµ„æº</span><br><span class="line">[root@master01 kubernetes]# vim mysql-dp.yml </span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-dp</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mysql-dp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: mysql-pod</span><br><span class="line">      namespace: default</span><br><span class="line">      labels:</span><br><span class="line">        app: mysql-dp</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: mysql-emptydir</span><br><span class="line">        emptyDir: &#123;&#125; </span><br><span class="line">      - name: mysql-hostpath</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /opt/mysql</span><br><span class="line"></span><br><span class="line">      containers:</span><br><span class="line">      - name: mysql-container</span><br><span class="line">        image: mysql:5.7.44</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&quot;123&quot;</span></span><br><span class="line">        - name: MYSQL_DATABASE</span><br><span class="line">          value: <span class="string">&quot;wp_db&quot;</span></span><br><span class="line">        - name: MYSQL_USER</span><br><span class="line">          value: <span class="string">&quot;wp_user&quot;</span></span><br><span class="line">        - name: MYSQL_PASSWORD</span><br><span class="line">          value: <span class="string">&quot;123&quot;</span></span><br><span class="line">        </span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: mysql-hostpath</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line">          </span><br><span class="line">[root@master01 kubernetes]#  kubectl apply -f mysql-dp.yml </span><br><span class="line"></span><br><span class="line">4ã€ç¼–å†™mysqlçš„Serviceèµ„æº</span><br><span class="line">[root@master01 kubernetes]# vim mysql-svc.yml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: mysql-dp</span><br><span class="line">  ports:</span><br><span class="line">  - name: mysql</span><br><span class="line">    port: 3306</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3306</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  </span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f mysql-svc.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get svc</span><br><span class="line">NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">mysql-svc       ClusterIP   10.1.47.161    &lt;none&gt;        3306/TCP       52s</span><br><span class="line">wordpress-svc   NodePort    10.1.84.160    &lt;none&gt;        80:30002/TCP   15h</span><br><span class="line"></span><br><span class="line">3ã€åˆ°nfséªŒè¯æ˜¯å¦æŒ‚è½½æˆåŠŸ</span><br><span class="line">[root@nfs ~]# ll /data/wp/</span><br><span class="line">-rw-r--r--  1 nfsnobody nfsnobody   405 Feb  6  2020 index.php</span><br><span class="line">-rw-r--r--  1 nfsnobody nfsnobody 19915 Jan  1  2024 ...</span><br><span class="line">-rw-r--r--  1 nfsnobody nfsnobody  3246 Mar  2  2024 xmlrpc.php</span><br><span class="line"></span><br><span class="line">4ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">k8sé›†ç¾¤ä¸­éšä¾¿ä¸€ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è®¿é—®ï¼Œä¸Šé¢è¯´è¿‡ï¼Œå’Œkube-proxyæœ‰å…³</span><br><span class="line">10.0.0.200:30002</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240928141216598.png" alt="image-20240928141216598"></p><p>å‘å¸ƒæ–‡ç« ä¸Šä¼ å›¾ç‰‡</p><p><img src="../image/study_img/image-20240928142403213.png" alt="image-20240928142403213"></p><p>nfsæœºå™¨é‡Œé¢æŸ¥çœ‹å›¾ç‰‡æ˜¯å¦ä¸Šä¼ åˆ°æŒ‚è½½ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs ~]# ll /data/wp/wp-content/uploads/2024/09/</span><br><span class="line">total 512</span><br><span class="line">-rw-r--r-- 1 nfsnobody nfsnobody  74163 Sep 28 14:21 12-1024x758.jpg</span><br><span class="line">-rw-r--r-- 1 nfsnobody nfsnobody   6000 Sep 28 14:21 12-150x150.jpg</span><br><span class="line">-rw-r--r-- 1 nfsnobody nfsnobody  13125 Sep 28 14:21 12-300x222.jpg</span><br><span class="line">-rw-r--r-- 1 nfsnobody nfsnobody  50103 Sep 28 14:21 12-768x568.jpg</span><br><span class="line">-rw-r--r-- 1 nfsnobody nfsnobody 367277 Sep 28 14:21 12.jpg</span><br></pre></td></tr></table></figure><h3 id="5ã€PVå’ŒPVCçš„ä»‹ç»"><strong>5ã€PVå’ŒPVCçš„ä»‹ç»</strong></h3><p>PVæ˜¯å¯¹åº•å±‚ç½‘ç»œå…±äº«å­˜å‚¨çš„æŠ½è±¡ï¼Œå°†å…±äº«å­˜å‚¨å®šä¹‰ä¸ºä¸€ç§â€œèµ„æºâ€<br>PVç”±ç®¡ç†å‘˜åˆ›å»ºå’Œé…ç½®<br>PVCåˆ™æ˜¯ç”¨æˆ·å¯¹å­˜å‚¨èµ„æºçš„ä¸€ä¸ªâ€œç”³è¯·â€å°±åƒPodæ¶ˆè´¹Nodeçš„èµ„æºä¸€æ ·ï¼Œ<br>PVCèƒ½å¤Ÿ&quot;æ¶ˆè´¹&quot;PVèµ„æºPVCå¯ä»¥ç”³è¯·ç‰¹å®šçš„å­˜å‚¨ç©ºé—´å’Œè®¿é—®æ¨¡å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å°±ç›®å‰è€Œè¨€ï¼ŒæŒ‚è½½é‚£å°NFSä¸»æœºç£ç›˜æœ‰å¤šå¤§ï¼Œå°±èƒ½å‚¨å­˜å¤šå¤§ï¼Œå¯¹å ç”¨æ²¡æœ‰åšé™åˆ¶ï¼Œ</span><br><span class="line"></span><br><span class="line">PV,å¯ä»¥ç†è§£ä¸ºnfså‚¨å­˜ï¼Œä¸€å…±20Gï¼ŒPVå°±æ˜¯åˆ’åˆ†ç£ç›˜ç©ºé—´çš„ä¸œè¥¿ï¼Œç»™å‚¨å­˜èµ„æºåˆ’åˆ†ç©ºé—´ï¼Œåˆ’åˆ†2Gä¸€å—ï¼Œ3Gä¸€å—...</span><br><span class="line"></span><br><span class="line">PVC,è¿™ä¸ªå‚¨å­˜æ˜¯ä¸€ä¸ªå¤§çš„å›­åŒºï¼Œå¼€å‘å•†æŠŠå›­åŒºå¼€å‘æˆæˆ¿å­ï¼ŒPVCå°±æ˜¯è´­ä¹°åˆ«å¢…çš„äººï¼Œæƒ³è¦å¤šå¤§ï¼Œå°±ç”³è¯·å¤šå¤§(ç”³è¯·PVåˆ’åˆ†çš„èµ„æºç©ºé—´)ï¼Œ</span><br><span class="line"></span><br><span class="line">PVåˆ’åˆ†å‚¨å­˜ï¼ŒPVCç»‘å®šPV,podä½¿ç”¨æŒ‡å®šçš„PVC</span><br></pre></td></tr></table></figure><p>pvå’ŒPVCçš„ç”Ÿå‘½å‘¨æœŸ</p><p><img src="../image/study_img/image-20240925102733528.png" alt="image-20240925102733528"></p><p>PVå’ŒPVCéœ€è¦æ³¨æ„çš„åœ°æ–¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åœ¨PVçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¯èƒ½ä¼šå¤„äº4ç§ä¸åŒçš„é˜¶æ®µ:</span><br><span class="line"></span><br><span class="line">Avaliable(å¯ç”¨)ï¼šè¡¨ç¤ºå¯ç”¨çŠ¶æ€ï¼Œè¿˜æœªè¢«ä»»ä½•PVCç»‘å®š</span><br><span class="line">Bound(è¢«ç»‘å®šçš„)ï¼šè¡¨ç¤ºPVå·²ç»è¢«PVCç»‘å®š</span><br><span class="line">Released(å·²é‡Šæ”¾)ï¼šPVCè¢«åˆ é™¤ï¼Œä½†æ˜¯èµ„æºè¿˜æœªè¢«é›†ç¾¤é‡æ–°å£°æ˜ï¼Œè¢«é‡Šæ”¾äº†ï¼Œé‡Œé¢è¿˜æœ‰æ•°æ®åœ¨ï¼Œéœ€è¦æŠŠæ•°æ®åˆ é™¤æˆ–è€…å¤‡ä»½ï¼Œå†æŠŠè¿™ä¸ªpvåˆ é™¤ï¼Œé‡å¯èµ·æ¥ï¼Œå°±ä¼šå˜æˆAvaliableçŠ¶æ€</span><br><span class="line">Failed(å¤±è´¥)ï¼šè¡¨ç¤ºè¯¥PVçš„è‡ªåŠ¨å›æ”¶å¤±è´¥</span><br></pre></td></tr></table></figure><p>PVCç»‘å®šPVçš„æ¡ä»¶å¦‚ä¸‹ï¼š</p><p>åˆ›å»ºPVCä¹‹åï¼Œk8så°±ä¼šå»æŸ¥æ‰¾æ»¡è¶³æˆ‘ä»¬å£°æ˜è¦æ±‚çš„PVæ¯”å¦‚storageClassNameï¼ŒaccessModesä»¥åŠå®¹æ˜¯è¿™äº›æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå¦‚æœæ»¡è¶³è¦æ±‚å°±å°†PVå’ŒPVCç»‘å®šåœ¨ä¸€èµ·ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1ã€storageClassName</span><br><span class="line">2ã€accessModes</span><br><span class="line">3ã€size</span><br></pre></td></tr></table></figure><p><font color=red>éœ€è¦æ³¨æ„çš„æ˜¯ç›®å‰PVå’ŒPVCä¹‹é—´æ˜¯ä¸€å¯¹ä¸€ç»‘å®šçš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªPVåªèƒ½è¢«ä¸€ä¸ªPVCç»‘å®šã€‚</font>&gt;</p><p><img src="../image/study_img/image-20240925103145263.png" alt="image-20240925103145263"></p><h3 id="6ã€PVã€PVCçš„èµ„æºæ¸…å•"><strong>6ã€PVã€PVCçš„èµ„æºæ¸…å•</strong></h3><p>PVèµ„æºå…³é”®å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">capacity: PVå­˜å‚¨çš„å®¹é‡</span><br><span class="line">capacity: 5Gi <span class="comment">#åˆ’åˆ†ç£ç›˜ç©ºé—´5G</span></span><br><span class="line"></span><br><span class="line">accessModes: è®¿é—®æ¨¡å¼,k8sæ”¯æŒçš„è®¿é—®æ¨¡å¼å¦‚ä¸‹</span><br><span class="line">------------------------------------------------------</span><br><span class="line">ReadWriteOnce(RWO): è¯»å†™æƒé™ï¼Œå¹¶ä¸”åªèƒ½è¢«å•ä¸ªNodeæŒ‚è½½</span><br><span class="line">ReadOnlyMany(ROX): åªè¯»æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½</span><br><span class="line">ReadWriteMany(RWX): è¯»å†™æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½</span><br><span class="line">------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">persistentVolumeReclaimPolicy: èµ„æºå›æ”¶ç­–ç•¥ï¼Œpvcåˆ ä¹‹åæ•°æ®æ˜¯å¦å›æ”¶çš„ç­–ç•¥</span><br><span class="line">------------------------------------------------------</span><br><span class="line">Retain: ä¿ç•™æ•°æ®ï¼Œéœ€è¦æ‰‹å·¥å¤„ç†      </span><br><span class="line">Recycle: ç®€å•æ¸…é™¤æ–‡ä»¶çš„æ“ä½œ(ä¾‹å¦‚è¿è¡Œ<span class="built_in">rm</span> -rf /dada/* å‘½ä»¤)ï¼Œå¦‚æœåˆ é™¤pvc,pvçš„èµ„æºå°±ä¼šè¢«åˆ é™¤é‡Šæ”¾æ‰</span><br><span class="line">Delete: å¦‚æœæŠŠPVCåˆ äº†ï¼ŒPVä¹Ÿä¼šè¢«ä¸€èµ·åˆ é™¤ï¼Œæ•°æ®ä¹Ÿä¼šè¢«æ¸…æ‰(å¾ˆå°‘ç”¨)</span><br><span class="line">ç›®å‰åªæœ‰NFSå’ŒHostPathä¸¤ç§ç±»å‹çš„PVæ”¯æŒRecycleç­–ç•¥ã€‚</span><br><span class="line">------------------------------------------------------</span><br><span class="line"></span><br><span class="line">storageClassName: å­˜å‚¨ç±»åˆ«</span><br><span class="line">å…·æœ‰ç‰¹å®šç±»åˆ«çš„PVåªèƒ½ä¸è¯·æ±‚äº†è¯¥ç±»åˆ«çš„PVCç»‘å®šã€‚æœªæŒ‡å®šç±»å‹çš„PVåˆ™åªèƒ½å¯¹ä¸ä¸è¯·æ±‚ä»»ä½•ç±»åˆ«çš„PVCç»‘å®šã€‚</span><br></pre></td></tr></table></figure><p>ç¼–å†™PVèµ„æºæ¸…å•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">1 mib =1024 kib</span><br><span class="line">1 gib = 1024 mib</span><br><span class="line"></span><br><span class="line">1ã€ç¼–å†™PVèµ„æºæ¸…å•ï¼Œåˆ’åˆ†5G</span><br><span class="line">[root@master01 kubernetes]# vim pv01.yml </span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;PersistentVolume&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: pv01</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    <span class="comment">#PVç”³è¯·ç£ç›˜ç©ºé—´çš„å¤§å°5G</span></span><br><span class="line">    storage: 5Gi</span><br><span class="line">  <span class="comment">#è®¿é—®æ¨¡å¼ï¼šè¯»å†™æƒé™ï¼Œå¹¶ä¸”åªèƒ½è¢«å•ä¸ªNodeæŒ‚è½½</span></span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  <span class="comment">#å›æ”¶ç­–ç•¥</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">  storageClassName: pv01-nfs</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/wp1</span><br><span class="line">    server: 172.16.1.31</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">2ã€ç¼–å†™PVèµ„æºæ¸…å•ï¼Œåˆ’åˆ†3G</span><br><span class="line">[root@master01 kubernetes]# vim pv02.yml </span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;PersistentVolume&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: pv02</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    <span class="comment">#PVç”³è¯·ç£ç›˜ç©ºé—´çš„å¤§å°5G</span></span><br><span class="line">    storage: 4Gi</span><br><span class="line">  <span class="comment">#è®¿é—®æ¨¡å¼ï¼šåªè¯»æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½</span></span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadOnlyMany</span><br><span class="line">  <span class="comment">#å›æ”¶ç­–ç•¥</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">  storageClassName: pv02-nfs</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/wp2</span><br><span class="line">    server: 172.16.1.31</span><br><span class="line">    </span><br><span class="line">3ã€ç¼–å†™PVèµ„æºæ¸…å•ï¼Œåˆ’åˆ†5G   </span><br><span class="line">[root@master01 kubernetes]# vim pv03.yml </span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;PersistentVolume&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: pv03</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    <span class="comment">#PVç”³è¯·ç£ç›˜ç©ºé—´çš„å¤§å°5G</span></span><br><span class="line">    storage: 3Gi</span><br><span class="line">  <span class="comment">#è®¿é—®æ¨¡å¼ï¼š(RWX): è¯»å†™æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½</span></span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  <span class="comment">#å›æ”¶ç­–ç•¥</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">  storageClassName: pv03-nfs</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/wp3</span><br><span class="line">    server: 172.16.1.31</span><br><span class="line"></span><br><span class="line">4ã€è¿è¡Œ</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f pv01.yml     </span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f pv02.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f pv03.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get pv</span><br><span class="line">NAME   CAPACITY(#pvcç»‘å®šçš„æ¡ä»¶)   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGEC</span><br><span class="line">pv01   5Gi        RWO            Recycle          Available           pv01-nfs</span><br><span class="line">pv02   4Gi        ROX            Recycle          Available           pv02-nfs</span><br><span class="line">pv03   3Gi        RWX            Recycle          Available           pv03-nfs</span><br></pre></td></tr></table></figure><p>ç¼–å†™PVCèµ„æºæ¸…å•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™PVCèµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim pvc01.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc01</span><br><span class="line"><span class="comment">#specé‡Œé¢çš„å†…å®¹å°±æ˜¯è¦å»åŒ¹é…PVçš„</span></span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 4Gi</span><br><span class="line">  storageClassName: pv01-nfs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œ</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f pvc01.yml </span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹PVCå·²ç»ç»‘å®šäº†pv01</span><br><span class="line">[root@master01 kubernetes]# kubectl get pvc</span><br><span class="line">NAME    STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc01   Bound    pv01     5Gi        RWO            pv01-nfs       4m5s</span><br><span class="line"></span><br><span class="line">4ã€pvå·²ç»æ˜¾ç¤ºè¢«ç»‘å®š</span><br><span class="line">[root@master01 kubernetes]# kubectl get pv</span><br><span class="line">NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM           STORAGECLA</span><br><span class="line">pv01   5Gi        RWO            Recycle          Bound       default/pvc01   pv01-nfs  </span><br><span class="line">pv02   4Gi        ROX            Recycle          Available                   pv02-nfs  </span><br><span class="line">pv03   3Gi        RWX            Recycle          Available                   pv03-nfs  </span><br></pre></td></tr></table></figure><h3 id="7ã€Podå…³è”PVC"><strong>7ã€Podå…³è”PVC</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">1ã€åˆ›å»ºwordpress-Deploymentèµ„æº</span><br><span class="line">[root@master01 kubernetes]# vim wp-dp-v2.yml</span><br><span class="line">apiVersion: <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: wp-dp</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line"><span class="comment">#èµ·2ä¸ªï¼Œæ•°æ®ä¹Ÿæ˜¯2ä¸ªï¼Œé™¤éæŠŠæ•°æ®åˆ†å¼€</span></span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: wp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: wp-pod</span><br><span class="line">      namespace: default</span><br><span class="line">      labels:</span><br><span class="line">        app: wp</span><br><span class="line">    spec:</span><br><span class="line">    <span class="comment">#æœ€åä¸€è¡ŒæŒ‚è½½ç‚¹çš„åå­—é¸¡è›‹æ›´æ”¹ nfsè¢«pvå’Œpvcç»‘å®šäº†ï¼Œæ‰€ä»¥podè‡ªå·±ç”¨pvcèµ„æº</span></span><br><span class="line">      volumes:</span><br><span class="line">      - name: wp-pvc</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">        <span class="comment">#è¿™ä¸ªæ˜¯pvcçš„åå­—</span></span><br><span class="line">          claimName: pvc01</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      containers:</span><br><span class="line">      - name: wp-container</span><br><span class="line">        image: wordpress</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="comment">#livenessProbe:</span></span><br><span class="line">        <span class="comment">#  tcpSocket:</span></span><br><span class="line">        <span class="comment">#    port: 80</span></span><br><span class="line">        <span class="comment">#  initialDelaySeconds: 10</span></span><br><span class="line">        <span class="comment">#  periodSeconds: 3</span></span><br><span class="line">        <span class="comment">#  timeoutSeconds: 3</span></span><br><span class="line">        <span class="comment">#  failureThreshold: 3</span></span><br><span class="line">        <span class="comment">#readinessProbe:</span></span><br><span class="line">        <span class="comment">#  tcpSocket:</span></span><br><span class="line">        <span class="comment">#    host: mysql-svc</span></span><br><span class="line">        <span class="comment">#    port: 3306</span></span><br><span class="line">        <span class="comment">#  initialDelaySeconds: 3</span></span><br><span class="line">        <span class="comment">#  timeoutSeconds: 1</span></span><br><span class="line">        <span class="comment">#  periodSeconds: 2</span></span><br><span class="line">        <span class="comment">#  successThreshold: 3</span></span><br><span class="line">        <span class="comment">#  failureThreshold: 3</span></span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: WORDPRESS_DB_HOST</span><br><span class="line">          value: <span class="string">&#x27;mysql-svc&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_USER</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_NAME</span><br><span class="line">          value: <span class="string">&#x27;wp_db&#x27;</span></span><br><span class="line">        </span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: wp-pvc</span><br><span class="line">          mountPath: /var/www/html/</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œ</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f wp-dp-v2.yml</span><br><span class="line"></span><br><span class="line">3ã€åˆ°nfsæœºå™¨æŸ¥çœ‹æŒ‚è½½æˆåŠŸ</span><br><span class="line">[root@nfs ~]# ll /data/wp1/</span><br><span class="line">-rw-r--r--  1 nfsnobody nfsnobody   405 Feb  6  2020 index.php</span><br><span class="line">-rw-r--r--  1 nfsnobody nfsnobody 19915 Jan  1  2024 license.txt</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240928181611313.png" alt="image-20240928181611313"></p>]]></content>
    
    
    <summary type="html">ä¹‹å‰æ¥è§¦çš„æœ¬åœ°å‚¨å­˜ï¼Œæ•°æ®ä¸èƒ½åšåˆ°å’Œå…¶ä»–æœºå™¨å…±äº«ï¼Œè¿™æ¬¡ä¼šè®²è§£å¼€æºå…±äº«å­˜å‚¨ç±»å‹å’Œå…¬æœ‰äº‘å­˜å‚¨</summary>
    
    
    
    <category term="k8s" scheme="https://www.fomal.cc/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰10ã€Kubernetesé…ç½®æ–‡ä»¶ç®¡ç†ConfigMap</title>
    <link href="https://www.fomal.cc/posts/b63dfd70.html"/>
    <id>https://www.fomal.cc/posts/b63dfd70.html</id>
    <published>2024-10-02T06:32:16.000Z</published>
    <updated>2024-10-02T07:56:03.723Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Kubernetesé…ç½®æ–‡ä»¶ç®¡ç†ConfigMap">Kubernetesé…ç½®æ–‡ä»¶ç®¡ç†ConfigMap</h2><h3 id="1ã€ConfigMapçš„ä»‹ç»"><strong>1ã€ConfigMapçš„ä»‹ç»</strong></h3><p>ä½œç”¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å°†é…ç½®æ–‡ä»¶å’ŒPodè§£å¶ï¼Œæ–¹ä¾¿ç®¡ç†é…ç½®æ–‡ä»¶</span><br></pre></td></tr></table></figure><p>ConfigMapé‡Œçš„é…ç½®æ–‡ä»¶å¦‚ä½•å‚¨å­˜çš„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ–¹æ³•ä¸€</span></span><br><span class="line">é”®å€¼å¯¹çš„æ–¹å¼ï¼š </span><br><span class="line">key:value</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–¹æ³•äºŒï¼š</span></span><br><span class="line">æ–‡ä»¶å:é…ç½®æ–‡ä»¶çš„å†…å®¹</span><br></pre></td></tr></table></figure><p>ConfigMapæ”¯æŒçš„é…ç½®ç±»å‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç›´æ¥å®šä¹‰é”®å€¼å¯¹</span><br><span class="line">2ã€åŸºäºæ–‡ä»¶åˆ›å»ºçš„é”®å€¼å¯¹</span><br></pre></td></tr></table></figure><p>ConfigMapåˆ›å»ºæ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1ã€å‘½ä»¤è¡Œ</span><br><span class="line">2ã€èµ„æºæ¸…å•</span><br></pre></td></tr></table></figure><p>ConfigMapçš„é…ç½®æ–‡ä»¶å¦‚ä½•ä¼ é€’åˆ°podé‡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1ã€å˜é‡ä¼ é€’    (åªæ˜¯ç¯å¢ƒå˜é‡ï¼Œåˆä¸ä¼šæ”¹å˜é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥æ¯«æ— æ„ä¹‰)</span><br><span class="line">2ã€æ•°æ®å·æŒ‚è½½</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨Configmapçš„é™åˆ¶æ¡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1ã€ConfigMapå¿…é¡»åœ¨podä¹‹å‰åˆ›å»ºï¼Œpodæ‰èƒ½å¼•ç”¨</span><br><span class="line">2ã€ConfigMapå—é™äºåç§°ç©ºé—´çš„é™åˆ¶ï¼Œåªæœ‰å¤„äºåŒä¸€ä¸ªåç§°ç©ºé—´çš„podæ‰å¯ä»¥è¢«å¼•ç”¨</span><br></pre></td></tr></table></figure><h3 id="2ã€å‘½ä»¤è¡Œåˆ›å»ºConfigMap"><strong>2ã€å‘½ä»¤è¡Œåˆ›å»ºConfigMap</strong></h3><p>æ–¹å¼ä¸€ï¼šå‘½ä»¤è¡Œåˆ›å»ºé”®å€¼å¯¹Keyï¼švalueçš„å‚¨å­˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">1ã€æŸ¥çœ‹å¸®åŠ©</span><br><span class="line">[root@master01 kubernetes]# kubectl create configmap --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">2ã€åˆ›å»ºconfigmap</span><br><span class="line">[root@master01 kubernetes]# kubectl create configmap nginx-config --from-literal=nginx_port=80 --from-literal=server_name=blog.test.com</span><br><span class="line"></span><br><span class="line">--from-literalï¼šåˆ›å»ºé”®å€¼å¯¹çš„key=value</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl get cm</span><br><span class="line">NAME           DATA   AGE</span><br><span class="line">nginx-config   2      67s</span><br><span class="line"></span><br><span class="line">ConfigMapçš„åå­—ï¼šnginx-configï¼Œé‡Œé¢æœ‰2æ¡æ•°æ®</span><br><span class="line"></span><br><span class="line">4ã€æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</span><br><span class="line">[root@master01 kubernetes]# kubectl describe cm nginx-config </span><br><span class="line">Name:         nginx-config</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">nginx_port:</span><br><span class="line">----</span><br><span class="line">80</span><br><span class="line">server_name:</span><br><span class="line">----</span><br><span class="line">blog.test.com</span><br><span class="line">Events:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ›å»ºè¿™ç§é”®å€¼å¯¹çš„æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºé…ç½®æ–‡ä»¶å¾ˆå°‘æ˜¯é”®å€¼å¯¹çš„</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€å¼•ç”¨ConfigMapï¼Œå¦‚æœpodæƒ³è¦å¼•ç”¨ä¸Šé¢çš„ConfigMapï¼Œåªèƒ½é€šè¿‡ç¯å¢ƒå˜é‡çš„å½¢å¼</span><br></pre></td></tr></table></figure><p>é€šè¿‡å˜é‡ä¼ é€’åˆ°pod</p><p><img src="../image/study_img/image-20240928205743737.png" alt="image-20240928205743737"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 kubernetes]# vim nginx-cm.yml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-cm</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-pod</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: NGINX_PORT</span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: nginx-config</span><br><span class="line">          key: nginx_port</span><br><span class="line"></span><br><span class="line">    - name: SERVER_NAME</span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: nginx-config</span><br><span class="line">          key: server_name</span><br><span class="line"></span><br><span class="line">6ã€å¯åŠ¨pod</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-cm.yml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-cm                   1/1     Running   0          9s</span><br><span class="line"></span><br><span class="line">7ã€è¿›å…¥podï¼ŒæŸ¥çœ‹podå·²ç»å¼•å…¥äº†å˜é‡</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it nginx-cm -- /bin/sh</span><br><span class="line">/ <span class="comment"># echo $NGINX_PORT</span></span><br><span class="line">80</span><br><span class="line">/ <span class="comment"># echo $SERVER_NAME</span></span><br><span class="line">blog.test.com</span><br><span class="line"></span><br><span class="line"><span class="comment">#è™½ç„¶è¿™ä¸¤ä¸ªå˜é‡ä¼ è¿›æ¥äº†ï¼Œä½†æ˜¯é…ç½®æ–‡ä»¶å¹¶æ²¡æœ‰æ”¹å˜ï¼Œå› ä¸ºä»–ä¸çŸ¥é“ä¼šä¼ åˆ°å“ªä¸ªé…ç½®æ–‡ä»¶ï¼Œæ²¡é‚£ä¹ˆæ™ºèƒ½ï¼Œåªæ˜¯ä¼ é€’å˜é‡</span></span><br></pre></td></tr></table></figure><p>æ–¹å¼äºŒï¼šåŸºäºæ–‡ä»¶å½¢å¼åˆ›å»ºConfigMap</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1ã€åˆ›å»ºé…ç½®æ–‡ä»¶</span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cat</span> &gt; www.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">server &#123;</span></span><br><span class="line"><span class="string">    listen 80;</span></span><br><span class="line"><span class="string">    server_name blog.test.com;</span></span><br><span class="line"><span class="string">    location / &#123;</span></span><br><span class="line"><span class="string">        root /usr/share/nginx/html/www;</span></span><br><span class="line"><span class="string">        index index.html index.htm;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">2ã€å‘½ä»¤è¡Œåˆ›å»ºConfigMapèµ„æº</span><br><span class="line">kubectl create configmap [è‡ªå®šä¹‰çš„ConfigMapåå­—]  --from-file=[è‡ªå®šä¹‰çš„keyåå­—]=[é…ç½®æ–‡ä»¶è·¯å¾„]</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl create configmap nginx-www  --from-file=test-www=./www.conf</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹cmèµ„æº</span><br><span class="line">[root@master01 kubernetes]# kubectl get cm</span><br><span class="line">NAME           DATA   AGE</span><br><span class="line">nginx-www      1      117s</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240928214603450.png" alt="image-20240928214603450"></p><ul><li>é€šè¿‡æŒ‚è½½å·ä¼ é€’åˆ°pod</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 kubernetes]# vim nginx-cm.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-cm-v1</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data-configmap</span><br><span class="line">    configMap:</span><br><span class="line">      name: nginx-www</span><br><span class="line">      items:</span><br><span class="line">      - key: test-www</span><br><span class="line">        path: wordpress.conf</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-pod</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data-configmap</span><br><span class="line">      mountPath: /etc/nginx/conf.d/</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240928221503694.png" alt="image-20240928221503694"></p><ul><li>ä¸€æ¬¡æ€§åˆ›å»ºConfigMapçš„2ä¸ªkey</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">1ã€å‡†å¤‡é…ç½®æ–‡ä»¶</span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cat</span> &gt; wp.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">server &#123;</span></span><br><span class="line"><span class="string">    listen 80;</span></span><br><span class="line"><span class="string">    server_name www.wp.com;</span></span><br><span class="line"><span class="string">    location / &#123;</span></span><br><span class="line"><span class="string">        root /usr/share/nginx/html/www;</span></span><br><span class="line"><span class="string">        index index.html index.htm;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cat</span> &gt; wc.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">server &#123;</span></span><br><span class="line"><span class="string">    listen 90;</span></span><br><span class="line"><span class="string">    server_name www.wc.com;</span></span><br><span class="line"><span class="string">    location / &#123;</span></span><br><span class="line"><span class="string">        root /usr/share/nginx/html/www;</span></span><br><span class="line"><span class="string">        index index.html index.htm;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">2ã€å‘½ä»¤è¡Œåˆ›å»ºConfigMap</span><br><span class="line">[root@master01 kubernetes]# kubectl create configmap wp-wc-conf  --from-file=wp-conf=./wp.conf --from-file=wc-conf=./wc.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹</span><br><span class="line">[root@master01 ~]# kubectl get cm</span><br><span class="line">NAME           DATA   AGE</span><br><span class="line">nginx-config   2      126m</span><br><span class="line">nginx-www      1      45m</span><br><span class="line">wp-wc-conf     2      112s</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240928223040756.png" alt="image-20240928223040756"></p><p>ä¸€æ¬¡æ€§æŒ‚è½½2ä¸ªæ–‡ä»¶è¿›å»</p><p><img src="../image/study_img/image-20240928225407162.png" alt="image-20240928225407162"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]#  vim wp-wc-configmap.yml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: wp-wc-cm</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: wp-wc-configmap</span><br><span class="line">    configMap:</span><br><span class="line">      name: wp-wc-conf</span><br><span class="line">      items:</span><br><span class="line">      - key: wp-conf</span><br><span class="line">        path: wordpress.conf</span><br><span class="line">      - key: wc-conf</span><br><span class="line">        path: wecenter.conf</span><br><span class="line"></span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-pod</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: wp-wc-configmap</span><br><span class="line">      mountPath: /etc/nginx/conf.d/</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œï¼Œå¹¶æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]#  kubectl apply -f wp-wc-configmap.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">wp-wc-cm                   1/1     Running   0          5s</span><br><span class="line"></span><br><span class="line">3ã€è¿›å…¥podæŸ¥çœ‹æŒ‚è½½æˆåŠŸ</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it wp-wc-cm -- /bin/sh</span><br><span class="line">/ <span class="comment"># ls -l /etc/nginx/conf.d/</span></span><br><span class="line">lrwxrwxrwx    1 root     root            20 Sep 28 14:41 wecenter.conf -&gt; ..data/wecenter.conf</span><br><span class="line">lrwxrwxrwx    1 root     root            21 Sep 28 14:41 wordpress.conf -&gt; ..data/wordpress.conf</span><br><span class="line">/ <span class="comment"># cat /etc/nginx/conf.d/wecenter.conf &amp;&amp; cat /etc/nginx/conf.d/wordpress.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 90;</span><br><span class="line">    server_name www.wc.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /usr/share/nginx/html/www;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.wp.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /usr/share/nginx/html/www;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•åŠ¨æ€ä¿®æ”¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 kubernetes]# kubectl get cm</span><br><span class="line">NAME           DATA   AGE</span><br><span class="line">wp-wc-conf     2      30m</span><br><span class="line"></span><br><span class="line">1ã€ä¿®æ”¹</span><br><span class="line">[root@master01 kubernetes]# kubectl edit cm wp-wc-conf</span><br><span class="line">        listen 91;</span><br><span class="line">......</span><br><span class="line">        listen 81;</span><br><span class="line">        </span><br><span class="line">2ã€å†æ¬¡è¿›å…¥å®¹å™¨å†…è§‚å¯Ÿä¹Ÿä¼šè‡ªåŠ¨æ›´æ–°</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it wp-wc-cm -- /bin/sh</span><br><span class="line">/ <span class="comment"># cat /etc/nginx/conf.d/wecenter.conf &amp;&amp; cat /etc/nginx/conf.d/wordpress.conf </span></span><br><span class="line"></span><br><span class="line">3ã€ä½†æ˜¯ç«¯å£æ²¡æœ‰å˜</span><br><span class="line">/ <span class="comment">#  netstat -lntup</span></span><br><span class="line">tcp        0      0 0.0.0.0:80 </span><br><span class="line">tcp        0      0 0.0.0.0:90</span><br><span class="line"></span><br><span class="line">4ã€éœ€è¦é‡å¯æœåŠ¡æ‰å¯ä»¥ç”Ÿæ•ˆï¼Œéœ€è¦åˆ é™¤èµ„æºå†é‡å¯ï¼Œå¦‚æœæ˜¯podèµ„æºå°±ä¸èƒ½åˆ é™¤é‡å¯ï¼Œpodèµ„æºå°±åˆ é™¤ï¼Œé‡æ–°åº”ç”¨ä¸€ä¸‹</span><br><span class="line">[root@master01 kubernetes]#  kubectl delete -f wp-wc-configmap.yml</span><br><span class="line">[root@master01 kubernetes]#  kubectl apply -f wp-wc-configmap.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it wp-wc-cm -- /bin/sh</span><br><span class="line">/ <span class="comment"># netstat -lntup      </span></span><br><span class="line">tcp        0      0 0.0.0.0:81              0.0.0.0:*             </span><br><span class="line">tcp        0      0 0.0.0.0:91              0.0.0.0:*            </span><br><span class="line"><span class="comment"># åŠ¨æ€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯æ— æ³•é‡æ–°åŠ è½½æœåŠ¡ ï¼ˆæœ‰ä¸€äº›ä¼ä¸šç”¨NacosæœåŠ¡ï¼šé…ç½®ç®¡ç†ä¸­å¿ƒï¼Œæ”¹å®Œäº†å°±å¸®ä½ é‡æ–°åŠ è½½æœåŠ¡ï¼‰</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä»¥ä¸Šæ“ä½œæŠŠé…ç½®æ–‡ä»¶æŒ‚åˆ°podé‡Œé¢äº†ï¼Œéœ€è¦å…ˆå‡†å¤‡é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯è¿˜æœ‰ç¼ºé™·ï¼Œéœ€è¦æå‰å‡†å¤‡é…ç½®æ–‡ä»¶</span><br><span class="line">ä½†æœ‰çš„èµ„æºæ¸…å•ï¼Œæ¯”å¦‚kube-flannelï¼Œæ²¡æœ‰å‡†å¤‡é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨èµ„æºæ¸…å•åˆ›å»ºConfigMapå°±ä¸éœ€è¦æå‰å‡†å¤‡</span><br></pre></td></tr></table></figure><h3 id="3ã€ä½¿ç”¨èµ„æºæ¸…å•åˆ›å»ºconfigmap"><strong>3ã€ä½¿ç”¨èµ„æºæ¸…å•åˆ›å»ºconfigmap</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">ä¸ºé¿å…å†²çªï¼Œåˆ é™¤ä¸Šæ¬¡å®éªŒåˆ›å»ºçš„cmå’Œpod</span><br><span class="line"></span><br><span class="line">1ã€åˆ›å»ºèµ„æºæ¸…å•</span><br><span class="line">root@master01 kubernetes]# vim wp-wc-configmap.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: wp-wc-conf</span><br><span class="line">  namespace: default</span><br><span class="line">data:</span><br><span class="line">  wp-key: |</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 88;</span><br><span class="line">        server_name www.wwpp.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root /usr/share/nginx/html/www;</span><br><span class="line">            index index.html index.htm;</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  wc-key: |</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 99;</span><br><span class="line">        server_name www.wwcc.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root /usr/share/nginx/html/www;</span><br><span class="line">            index index.html index.htm;</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: wp-wc-cm2</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: wp-wc-configmap</span><br><span class="line">    configMap:</span><br><span class="line">      name: wp-wc-conf</span><br><span class="line">      items:</span><br><span class="line">      - key: wp-key</span><br><span class="line">        path: wordpress.conf</span><br><span class="line">      - key: wc-key</span><br><span class="line">        path: wecenter.conf</span><br><span class="line"></span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-pod</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: wp-wc-configmap</span><br><span class="line">      mountPath: /etc/nginx/conf.d/</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œï¼Œå¹¶ä¸”æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</span><br><span class="line">root@master01 kubernetes]# kubectl apply -f wp-wc-configmap.yml </span><br><span class="line">configmap/wp-wc-conf created</span><br><span class="line">pod/wp-wc-cm2 created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">wp-wc-cm2                  1/1     Running   0          2m42s</span><br><span class="line">[root@master01 kubernetes]# kubectl get cm</span><br><span class="line">NAME         DATA   AGE</span><br><span class="line">wp-wc-conf   2      21s</span><br><span class="line">[root@master01 kubernetes]# kubectl describe cm wp-wc-conf</span><br><span class="line">Name:         wp-wc-conf</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">wc-key:</span><br><span class="line">----</span><br><span class="line">server &#123;</span><br><span class="line">    listen 99;</span><br><span class="line">    server_name www.wwcc.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /usr/share/nginx/html/www;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wp-key:</span><br><span class="line">----</span><br><span class="line">server &#123;</span><br><span class="line">    listen 88;</span><br><span class="line">    server_name www.wwpp.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /usr/share/nginx/html/www;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€è¿›å…¥å®¹å™¨å¹¶æŸ¥çœ‹é…ç½®æ–‡ä»¶</span><br><span class="line">[root@master01 ~]# kubectl <span class="built_in">exec</span> -it wp-wc-cm2 -- /bin/sh</span><br><span class="line">/# <span class="built_in">cat</span> /etc/nginx/conf.d/wecenter.conf &amp;&amp; <span class="built_in">cat</span> /etc/nginx/conf.d/wordpress.conf </span><br><span class="line">/# netstat -lntup</span><br><span class="line">tcp        0      0 0.0.0.0:88</span><br><span class="line">tcp        0      0 0.0.0.0:99</span><br><span class="line"></span><br><span class="line">4ã€åŠ¨æ€ä¿®æ”¹èƒ½å¤Ÿä¿®æ”¹ï¼Œä½†æ˜¯ä¸ç”Ÿæ•ˆ</span><br></pre></td></tr></table></figure><h3 id="4ã€wordpressç»¼åˆç»ƒä¹ "><strong>4ã€wordpressç»¼åˆç»ƒä¹ </strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## wordpress è¦è¿è¡Œåœ¨k8sä¸­</span></span><br><span class="line"><span class="comment">## MySQL</span></span><br><span class="line">1.åç§°ç©ºé—´ï¼š blog</span><br><span class="line">2.é•œåƒmysql:5.7</span><br><span class="line">3.ç¯å¢ƒå˜é‡</span><br><span class="line">        - rootå¯†ç ï¼š123</span><br><span class="line">        - æ•°æ®åº“ï¼šwordpress</span><br><span class="line">        - ç”¨æˆ·ï¼šwordpress</span><br><span class="line">        - å‚æ•°ï¼šå­—ç¬¦é›†</span><br><span class="line">4.æ•°æ®æŒä¹…åŒ–ï¼šåœ¨å®¿ä¸»æœºçš„/data/mysql/data</span><br><span class="line"></span><br><span class="line"><span class="comment">## mysql-svcéœ€æ±‚</span></span><br><span class="line">åç§°ç©ºé—´ï¼šblog</span><br><span class="line"></span><br><span class="line"><span class="comment">## wordpresséœ€æ±‚</span></span><br><span class="line">å‰¯æœ¬æ•°ä¸º:2</span><br><span class="line">é•œåƒï¼šwordpress:latest</span><br><span class="line">æ•°æ®åº“åœ°å€ï¼šcluster ip</span><br><span class="line">æ•°æ®åº“åç§°ï¼šwordpress</span><br><span class="line">ç”¨æˆ·ï¼šwordpress</span><br><span class="line"></span><br><span class="line">******** ä½¿ç”¨NFSæŒä¹…åŒ–æ•°æ®ï¼Œå®¿ä¸»æœºï¼š/data/wordpress/data 10.0.0.31</span><br><span class="line"></span><br><span class="line">mysql deployment</span><br><span class="line">mysql clusterip</span><br><span class="line">wordpress deployment</span><br><span class="line">wordpress clusterip</span><br><span class="line">wordpress ingress</span><br><span class="line">wordpress hpa</span><br></pre></td></tr></table></figure><p>èµ„æºæ¸…å•å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"><span class="comment"># åç§°ç©ºé—´</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: blog</span><br><span class="line">---</span><br><span class="line"><span class="comment"># mysqlçš„PVèµ„æº</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pv</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: mysql-hostpath</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi</span><br><span class="line">  hostPath:</span><br><span class="line">    path: /data/wp-db</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment"># mysqlçš„pvcèµ„æº</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pvc</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: mysql-pvc</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 5Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment"># mysqlçš„deployèµ„æº</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-deploy</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: mysql-deploy</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: mysql-pod</span><br><span class="line">      namespace: blog</span><br><span class="line">      labels:</span><br><span class="line">        run: mysql-deploy</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: db-pvc</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: mysql-pvc</span><br><span class="line">      containers:</span><br><span class="line">      - name: mysql-container</span><br><span class="line">        image: mysql:5.7</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 3306</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 1</span><br><span class="line">          timeoutSeconds: 10</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        - name: MYSQL_DATABASE</span><br><span class="line">          value: <span class="string">&#x27;wordpress&#x27;</span></span><br><span class="line">        - name: MYSQL_USER</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: MYSQL_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: db-pvc</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment"># mysqlçš„serviceèµ„æº</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-service</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    run: mysql-deploy</span><br><span class="line">  ports:</span><br><span class="line">  - name: mysql</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 3306</span><br><span class="line">    targetPort: 3306</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment"># wordpressçš„PVèµ„æº</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: wordpress-pv</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: wordpress-nfs</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/wp</span><br><span class="line">    server: 172.16.1.31</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment">#wordpressçš„PVC</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: wordpress-pvc</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  storageClassName: wordpress-nfs</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 5Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment"># wordpressçš„deploymentçš„èµ„æº</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: wordpress-deploy</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: wordpress-deploy</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        run: wordpress-deploy</span><br><span class="line">      name: wordpress-pod </span><br><span class="line">      namespace: blog</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: web-pvc</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: wordpress-pvc</span><br><span class="line">      containers:</span><br><span class="line">      - name: wordpress-container</span><br><span class="line">        image: wordpress</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="comment">#livenessProbe:</span></span><br><span class="line">        <span class="comment">#  httpGet:</span></span><br><span class="line">        <span class="comment">#    path: /</span></span><br><span class="line">        <span class="comment">#    port: 80</span></span><br><span class="line">        <span class="comment">#  failureThreshold: 3</span></span><br><span class="line">        <span class="comment">#  initialDelaySeconds: 5</span></span><br><span class="line">        <span class="comment">#  periodSeconds: 1</span></span><br><span class="line">        <span class="comment">#  timeoutSeconds: 10</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 3306</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 1</span><br><span class="line">          successThreshold: 3</span><br><span class="line">          timeoutSeconds: 10</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: WORDPRESS_DB_HOST</span><br><span class="line">          value: <span class="string">&#x27;mysql-service&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_USR</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_DATABASE</span><br><span class="line">          value: <span class="string">&#x27;wordpress&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: web-pvc</span><br><span class="line">          mountPath: /var/www/html</span><br><span class="line">---</span><br><span class="line"><span class="comment"># wordpressçš„serviceèµ„æº</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: wordpress-service</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    run: wordpress-deploy</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP  </span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment"># wordpressçš„HPAèµ„æº</span></span><br><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: wordpress-hpa</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  minReplicas: 2</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: wordpress-deploy</span><br><span class="line">  targetCPUUtilizationPercentage: 50</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment"># wordpressçš„ingressèµ„æº</span></span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: wordpress-ingress</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: wp.web.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          pathType: Prefix</span><br><span class="line">          backend:</span><br><span class="line">            service:</span><br><span class="line">              name: wordpress-service</span><br><span class="line">              port:</span><br><span class="line">                number: 80</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">k8sä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†ConfigMapï¼Œå°†é…ç½®æ–‡ä»¶å’ŒPodè§£å¶</summary>
    
    
    
    <category term="k8s" scheme="https://www.fomal.cc/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰11ã€K8sèµ„æºé™åˆ¶å’ŒPrometheusç›‘æ§</title>
    <link href="https://www.fomal.cc/posts/aef7182b.html"/>
    <id>https://www.fomal.cc/posts/aef7182b.html</id>
    <published>2024-10-02T06:32:00.000Z</published>
    <updated>2024-10-02T07:56:03.729Z</updated>
    
    <content type="html"><![CDATA[<h2 id="K8sèµ„æºé™åˆ¶å’ŒPrometheusç›‘æ§">K8sèµ„æºé™åˆ¶å’ŒPrometheusç›‘æ§</h2><h3 id="1ã€K8sé‡Œçš„Podèµ„æºé™åˆ¶"><strong>1ã€K8sé‡Œçš„Podèµ„æºé™åˆ¶</strong></h3><p>èµ„æºé™åˆ¶çš„èµ„æºæ¸…å•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1ã€èµ„æºæ¸…å•çš„ç¼–å†™</span><br><span class="line">[root@master01 kubernetes]# vim limit.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: resource-demo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: resource-demo</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    resources:</span><br><span class="line">    <span class="comment">#æœ€å°çš„éœ€æ±‚</span></span><br><span class="line">      requests:</span><br><span class="line">      <span class="comment">#å†…å­˜æœ€å°éœ€æ±‚</span></span><br><span class="line">        memory: 50Mi</span><br><span class="line">      <span class="comment">#cpuçš„æœ€å°éœ€æ±‚</span></span><br><span class="line">        cpu: 200m</span><br><span class="line">      <span class="comment">#é™åˆ¶å ç”¨ç£ç›˜æœ€å°éœ€æ±‚</span></span><br><span class="line">        <span class="comment">#storage: 3Gi</span></span><br><span class="line">      <span class="comment">#æœ€å¤§éœ€æ±‚</span></span><br><span class="line">      limits:</span><br><span class="line">        memory: 100Mi</span><br><span class="line">        cpu: 1500m</span><br><span class="line">        <span class="comment">#storage: 5Gi</span></span><br><span class="line">        </span><br><span class="line">2ã€è¿è¡Œ</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f limit.yaml</span><br></pre></td></tr></table></figure><p>å‚æ•°è§£é‡Šï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">requestsï¼šèŠ‚ç‚¹æ‰€éœ€çš„æœ€å°è®¡ç®—èµ„æºï¼Œk8sè°ƒåº¦çš„æ—¶å€™çš„ä¾æ®å€¼</span><br><span class="line"></span><br><span class="line">limitsï¼šé™åˆ¶å…è®¸çš„æœ€å¤§è®¡ç®—èµ„æºï¼ŒçœŸæ­£çš„èµ„æºé™åˆ¶å‚æ•°</span><br></pre></td></tr></table></figure><p>æ•°å€¼è½¬æ¢ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1 CPU = 1000m     mæ˜¯æ¯«æ ¸</span><br><span class="line">0.5 CPU = 500m</span><br><span class="line">1 Mib = 1024 Kib</span><br><span class="line">1 MB = 1000 KB</span><br></pre></td></tr></table></figure><p>éªŒè¯æ–¹å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">docker inspect å®¹å™¨ID | grep CgroupParent</span><br><span class="line"><span class="built_in">cd</span> /sys/fs/cgroup/cpu/kubepods.slice/kubepods-burstable.slice/è¿‡æ»¤å‡ºæ¥çš„ç»“æœ</span><br><span class="line"><span class="built_in">cat</span> cpu.cfs_quota_us</span><br><span class="line"></span><br><span class="line">1ã€æŸ¥çœ‹èµ·åœ¨å“ªä¸ªnode</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -owide</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     IP           NODE</span><br><span class="line">resource-demo                   1/1     Running   0          4m19s   10.2.3.114   node03</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹node03ä¸Šçš„å®¹å™¨</span><br><span class="line">[root@node03 ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">2463239ecc3f        c7b4f26a7d93                                        <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   5 minutes ago       Up 5 minutes                            k8s_resource-demo_resource-demo_default_cb221617-6b64-41d8-83de-d1766988dddd_0</span><br><span class="line"></span><br><span class="line">[root@node03 ~]# docker inspect 2463239ecc3f | grep CgroupParent</span><br><span class="line">            <span class="string">&quot;CgroupParent&quot;</span>: <span class="string">&quot;kubepods-burstable-podcb221617_6b64_41d8_83de_d1766988dddd.slice&quot;</span>,</span><br><span class="line">            </span><br><span class="line">[root@node03 ~]# <span class="built_in">cd</span> /sys/fs/cgroup/cpu/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-podcb221617_6b64_41d8_83de_d1766988dddd.slice</span><br><span class="line"></span><br><span class="line">[root@node03 kubepods-burstable-podcb221617_6b64_41d8_83de_d1766988dddd.slice]# <span class="built_in">cat</span> cpu.cfs_quota_us</span><br><span class="line">150000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¦‚æœæŸ¥çœ‹åˆ°çš„ç»“æœæ˜¯-1ï¼Œå°±æ˜¯æ²¡åšé™åˆ¶</span></span><br><span class="line">ä¸èƒ½ç›²ç›®çš„åšèµ„æºé™åˆ¶ï¼Œæ‰€ä»¥è¦åšç›‘æ§</span><br></pre></td></tr></table></figure><h3 id="2ã€Prometheusçš„ä»‹ç»"><strong>2ã€Prometheusçš„ä»‹ç»</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   Prometheusæ˜¯ä¸€ä¸ªå¼€æºç³»ç»Ÿç›‘æ§å’Œè­¦æŠ¥å·¥å…·åŒ…ï¼Œæœ€åˆæ˜¯åœ¨SoundCloudä¸Šæ„å»ºçš„ã€‚è‡ª2012å¹´æˆç«‹ä»¥æ¥ï¼Œè®¸å¤šå…¬å¸å’Œç»„ç»‡éƒ½é‡‡ç”¨äº†Prometheusï¼Œè¯¥é¡¹ç›®æ‹¥æœ‰éå¸¸æ´»è·ƒçš„å¼€å‘è€…å’Œç”¨æˆ·ç¤¾åŒºã€‚</span><br><span class="line">   </span><br><span class="line">Prometheusç°åœ¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¼€æºé¡¹ç›®ï¼Œç‹¬ç«‹äºä»»ä½•å…¬å¸è¿›è¡Œç»´æŠ¤ã€‚ä¸ºäº†å¼ºè°ƒè¿™ä¸€ç‚¹ï¼Œå¹¶æ¾„æ¸…é¡¹ç›®çš„æ²»ç†ç»“æ„ï¼ŒPrometheusäº2016å¹´åŠ å…¥äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼Œä½œä¸ºç»§Kubernetesä¹‹åçš„ç¬¬äºŒä¸ªæ‰˜ç®¡é¡¹ç›®ã€‚</span><br><span class="line"></span><br><span class="line">æˆ‘ä»¬å¯ä»¥ç®€å•çš„ç†è§£Prometheusæ˜¯ä¸€ä¸ªç›‘æ§ç³»ç»ŸåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªæ—¶é—´åºåˆ—æ•°æ®åº“ã€‚</span><br><span class="line"></span><br><span class="line">æ¨èé˜…è¯»:</span><br><span class="line">    å®˜ç½‘åœ°å€ï¼šhttps://prometheus.io</span><br><span class="line">    å®˜æ–¹æ–‡æ¡£ï¼šhttps://prometheus.io/docs/introduction/overview/</span><br><span class="line">    GitHubåœ°å€ï¼šhttps://github.com/prometheus</span><br><span class="line">    æ¶æ„å›¾åœ°å€ï¼šhttps://prometheus.io/docs/introduction/overview/</span><br></pre></td></tr></table></figure><h3 id="3ã€Prometheusæ¶æ„"><strong>3ã€Prometheusæ¶æ„</strong></h3><p><img src="../image/study_img/image-20240926113735188.png" alt="image-20240926113735188"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå±•ç¤ºäº†æ™®ç½—ç±³ä¿®æ–¯(prometheus)çš„å»ºç­‘å’Œå®ƒçš„ä¸€äº›ç”Ÿæ€ç³»ç»Ÿç»„æˆéƒ¨åˆ†ã€‚</span><br><span class="line">(1)Prometheus server:</span><br><span class="line">    prometheusçš„æœåŠ¡ç«¯ï¼Œè´Ÿè´£æ”¶é›†æŒ‡æ ‡å’Œå­˜å‚¨æ—¶é—´åºåˆ—æ•°æ®ï¼Œå¹¶æä¾›æŸ¥è¯¢æ¥å£ã€‚</span><br><span class="line"></span><br><span class="line">(2)exporters:</span><br><span class="line">    å¦‚æœæƒ³è¦ç›‘æ§ï¼Œå‰ææ˜¯èƒ½è·å–è¢«ç›‘æ§ç«¯æ•°æ®ï¼Œå¹¶ä¸”è¿™ä¸ªæ•°æ®æ ¼å¼å¿…é¡»éµå¾ªPrometheusæ•°æ®æ¨¡å‹ï¼Œè¿™æ ·æ‰èƒ½è¯†åˆ«å’Œé‡‡é›†ï¼Œä¸€èˆ¬ä½¿ç”¨exporteræ•°æ®é‡‡é›†å™¨(ç±»ä¼¼äºzabbix_agentç«¯)æä¾›ç›‘æ§æŒ‡æ ‡æ•°æ®ã€‚</span><br><span class="line">    exporteræ•°æ®é‡‡é›†å™¨ï¼Œé™¤äº†å®˜æ–¹å’ŒGitHubæä¾›çš„å¸¸ç”¨ç»„ä»¶exporterå¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ºè‡ªå·±è‡ªç ”çš„äº§å“å®šåˆ¶exportersç»„ä»¶å“Ÿã€‚</span><br><span class="line"></span><br><span class="line">(3)Pushgateway:</span><br><span class="line">    çŸ­æœŸå­˜å‚¨æŒ‡æ ‡æ•°æ®ï¼Œä¸»è¦ç”¨äºä¸´æ—¶æ€§çš„ä»»åŠ¡ã€‚æ¯”å¦‚å¤‡ä»½æ•°æ®åº“ä»»åŠ¡ç›‘æ§ç­‰ã€‚</span><br><span class="line">æœ¬è´¨ä¸Šæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºPushgatewayå¯ä»¥å¸®å’±ä»¬ç›‘æ§è‡ªå®šä¹‰çš„ç›‘æ§é¡¹ï¼Œè¿™éœ€è¦å’±ä»¬è‡ªå·±ç¼–å†™è„šæœ¬æ¥æ¨é€åˆ°Pushgatewayç«¯ï¼Œè€Œåç”±Prometheus serverä»Pushgatewayå»pullç›‘æ§æ•°æ®ã€‚</span><br><span class="line">    æ¢å¥è¯è¯´ï¼Œè¯·ä¸è¦è¢«å®˜æ–¹çš„æ¶æ„å›¾è’™éª—äº†ï¼Œå’±ä»¬å®Œå…¨å¯ä»¥åŸºäºPushgatewayæ¥ç›‘æ§å’±ä»¬è‡ªå®šä¹‰çš„ç›‘æ§é¡¹å“Ÿï¼Œè¿™äº›ç›‘æ§é¡¹å®Œå…¨å¯ä»¥æ˜¯é•¿æœŸè¿è¡Œçš„å‘¢ï¼</span><br><span class="line"></span><br><span class="line">(4)Service discovery:</span><br><span class="line">    æœåŠ¡å‘ç°ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥é…ç½®åŠ¨æ€çš„æœåŠ¡ç›‘æ§ï¼Œæ— éœ€é‡å¯Prometheus serverå®ä¾‹å°±èƒ½å®ç°åŠ¨æ€ç›‘æ§ã€‚</span><br><span class="line"></span><br><span class="line">(5)Alertmanager:</span><br><span class="line">    æ”¯æŒæŠ¥è­¦åŠŸèƒ½ï¼Œæ¯”å¦‚å¯ä»¥æ”¯æŒåŸºäºé‚®ä»¶ï¼Œå¾®ä¿¡ï¼Œé’‰é’‰æŠ¥è­¦ã€‚</span><br><span class="line">    æ®ç½‘å‹åé¦ˆè¯¥ç»„ä»¶åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å­˜åœ¨ç¼ºé™·ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨Grafanaæ¥å±•ç¤ºå¹¶å®ç°æŠ¥è­¦åŠŸèƒ½ã€‚</span><br><span class="line"></span><br><span class="line">(6)Prometheus Web UI</span><br><span class="line">    Prometheusæ¯”è¾ƒç®€å•çš„Webæ§åˆ¶å°ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥ä½¿ç”¨grafanaæ¥é›†æˆåšæ›´æ¼‚äº®çš„Webå±•ç¤ºå“Ÿã€‚</span><br><span class="line">æ¸©é¦¨æç¤º:</span><br><span class="line">    å¤§å¤šæ•°Prometheusç»„ä»¶éƒ½æ˜¯ç”¨Goç¼–å†™çš„ï¼Œè¿™ä½¿å¾—å®ƒä»¬æ˜“äºæ„å»ºå’Œéƒ¨ç½²ä¸ºé™æ€äºŒè¿›åˆ¶æ–‡ä»¶</span><br></pre></td></tr></table></figure><h3 id="4ã€äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²Prometheus"><strong>4ã€äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²Prometheus</strong></h3><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>hostname</th><th>ip</th><th>roles</th><th>é…ç½®(application)</th><th>é…ç½®</th></tr></thead><tbody><tr><td>master01</td><td>10.0.0.200  /  172.16.1.200</td><td>PrometheusæœåŠ¡ç«¯</td><td>promethues,pushgateway,alertmanager,<br/>node_exporter,cAdVidorï¼Œgrafana</td><td>1h2G</td></tr><tr><td>node01</td><td>10.0.0.201  /  172.16.1.201</td><td>prometheuså®¢æˆ·ç«¯(æ”¶é›†æ•°æ®æŒ‡æ ‡)</td><td>node_exporter,cAdVidor</td><td>1h2G</td></tr><tr><td>node02</td><td>10.0.0.202  /  172.16.1.202</td><td>prometheuså®¢æˆ·ç«¯(æ”¶é›†æ•°æ®æŒ‡æ ‡)</td><td>node_exporter,cAdVidor</td><td>1h2G</td></tr><tr><td>node03</td><td>10.0.0.203  /  172.16.1.203</td><td>prometheuså®¢æˆ·ç«¯(æ”¶é›†æ•°æ®æŒ‡æ ‡)</td><td>node_exporter,cAdVidor</td><td>2h4G</td></tr></tbody></table><p>1ã€ä¸‹è½½åŒ…</p><p><img src="../image/study_img/image-20240926155738935.png" alt="image-20240926155738935"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pushgatewayï¼šè‡ªå®šä¹‰ç›‘æ§</span><br><span class="line">alertmanagerï¼šå‘Šè­¦</span><br><span class="line">node_exporterï¼šmasterèµ·å®¹å™¨äº†ï¼Œapiserverï¼Œcontrollerç»„ä»¶éƒ½æ˜¯ä»¥å®¹å™¨æ–¹å¼èµ·æ¥çš„éœ€è¦ç›‘æ§</span><br><span class="line">cAdVidorï¼šç›‘æ§å®¹å™¨</span><br><span class="line"></span><br><span class="line">https://prometheus.io/download/</span><br><span class="line"></span><br><span class="line">1ã€ä¸‹è½½äºŒè¿›åˆ¶åŒ…</span><br><span class="line">ç‰ˆæœ¬çš„é€‰æ‹©bataæ˜¯é¢„ä¸Šçº¿ç‰ˆæœ¬ï¼Œå½“å‰ç¨³å®šç‰ˆLTS   ç”Ÿäº§ä¸­æœ€å¥½ç”¨æ–‡æ¡£ç‰ˆçš„</span><br><span class="line"><span class="comment">#ä¸‹è½½Prometheus</span></span><br><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.54.1/prometheus-2.54.1.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸‹è½½alertmanagerï¼ˆå‘Šè­¦ç»„ä»¶ï¼‰</span></span><br><span class="line">wget https://github.com/prometheus/alertmanager/releases/download/v0.27.0/alertmanager-0.27.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸‹è½½node_exporter(å®¿ä¸»æœºæŒ‡æ ‡æ”¶é›†å™¨)</span></span><br><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸‹è½½pushgatewayï¼ˆè‡ªå®šä¹‰ç›‘æ§ç»„ä»¶ï¼‰</span></span><br><span class="line">cAdVidorä¸æ˜¯è‡ªå·±çš„ç»„ä»¶</span><br></pre></td></tr></table></figure><p>2ã€éƒ¨ç½²Prometheus</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1ã€å®‰è£…Prometheus</span><br><span class="line">[root@master01 ~]# tar xf prometheus-2.54.1.linux-amd64.tar.gz -C /app</span><br><span class="line">[root@master01 ~]# <span class="built_in">mv</span> /app/prometheus-2.54.1.linux-amd64 /app/prometheus-2.54.1</span><br><span class="line">[root@master01 ~]# <span class="built_in">ln</span> -s /app/prometheus-2.54.1 /app/prometheus</span><br><span class="line">åˆ¶ä½œå¥½è½¯è¿æ¥ï¼Œå°±å®‰è£…å®Œæˆ</span><br><span class="line"></span><br><span class="line">[root@master01 prometheus-2.54.1]# ll /app/</span><br><span class="line">lrwxrwxrwx 1 root root    22 Sep 26 12:01 prometheus -&gt; /app/prometheus-2.54.1</span><br><span class="line">drwxr-xr-x 4 1001 docker 132 Sep 26 12:44 prometheus-2.54.1</span><br><span class="line">[root@master01 ~]# ll /app/prometheus-2.54.1/</span><br><span class="line">total 265552</span><br><span class="line">drwxr-xr-x 2 1001 docker        38 Aug 27 19:11 console_libraries#åº“æ–‡ä»¶</span><br><span class="line">drwxr-xr-x 2 1001 docker       173 Aug 27 19:11 consoles</span><br><span class="line">-rw-r--r-- 1 1001 docker     11357 Aug 27 19:11 LICENSE</span><br><span class="line">-rw-r--r-- 1 1001 docker      3773 Aug 27 19:11 NOTICE</span><br><span class="line">-rwxr-xr-x 1 1001 docker 140096826 Aug 27 18:58 prometheus <span class="comment">#å¯åŠ¨ç¨‹åº</span></span><br><span class="line">-rw-r--r-- 1 1001 docker       934 Aug 27 19:11 prometheus.yml  <span class="comment">#é…ç½®æ–‡ä»¶</span></span><br><span class="line">-rwxr-xr-x 1 1001 docker 131802216 Aug 27 18:58 promtool</span><br></pre></td></tr></table></figure><p>â€‹    Prometheusé…ç½®æ–‡ä»¶è§£è¯»</p><p><img src="../image/study_img/image-20240926163353506.png" alt="image-20240926163353506"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶</span><br><span class="line">[root@master01 prometheus-2.54.1]# vim prometheus.yml</span><br><span class="line">......</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: <span class="string">&quot;prometheus&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [<span class="string">&quot;10.0.0.200:9090&quot;</span>]</span><br><span class="line">     <span class="comment">#è¿™é‡Œå†™Prometheusçš„å®‰è£…æœºå™¨çš„ip:ç«¯å£</span></span><br><span class="line"> </span><br><span class="line">3ã€æŸ¥çœ‹å¸®åŠ©ï¼ŒæŸ¥çœ‹å¯åŠ¨æœåŠ¡éƒ½éœ€è¦å“ªäº›å‚æ•° </span><br><span class="line">[root@master01 prometheus]# /app/prometheus/prometheus --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€å¯åŠ¨Prometheus</span><br><span class="line">[root@master01 prometheus]# /app/prometheus/prometheus --config.file=/app/prometheus/prometheus.yml &amp;</span><br><span class="line">ä¼šæœ‰æ—¥å¿—è¾“å‡ºåœ¨ç»ˆç«¯</span><br><span class="line"><span class="comment">#å¯åŠ¨ä¹‹åï¼Œè¿™æ¬¡ä¸éœ€è¦å†™systemdè„šæœ¬ç®¡ç†ï¼Œè¿™æ¬¡ä½¿ç”¨å¦å¤–ä¸€ç§ç®¡ç†æ–¹å¼supervisor</span></span><br><span class="line"></span><br><span class="line">5ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.200:9090</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240926164644789.png" alt="image-20240926164644789"></p><p>3ã€äºŒè¿›åˆ¶å®‰è£…node_exportï¼Œå¹¶åŠ å…¥Prometheus</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1ã€å®‰è£…</span><br><span class="line">[root@master01 ~]# tar xf node_exporter-1.8.2.linux-amd64.tar.gz -C /app</span><br><span class="line">[root@master01 app]# <span class="built_in">mv</span> /app/node_exporter-1.8.2.linux-amd64/ /app/node_exporter-1.8.2</span><br><span class="line">[root@master01 app]# <span class="built_in">ln</span> -s /app/node_exporter-1.8.2 /app/node_exporter</span><br><span class="line"><span class="comment">#è¿™é‡Œå¯ä»¥å…ˆåšç¬¬5æ­¥ï¼ŒæŠŠé…ç½®æ–‡ä»¶æ”¹äº†</span></span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹</span><br><span class="line">[root@master01 app]# <span class="built_in">cd</span> /app/node_exporter</span><br><span class="line">[root@master01 node_exporter]# ll</span><br><span class="line">total 20040</span><br><span class="line">-rw-r--r-- 1 1001 1002    11357 Jul 14 19:57 LICENSE</span><br><span class="line">-rwxr-xr-x 1 1001 1002 20500541 Jul 14 19:54 node_exporter <span class="comment">#å¯åŠ¨ç¨‹åºæ–‡ä»¶</span></span><br><span class="line">-rw-r--r-- 1 1001 1002      463 Jul 14 19:57 NOTICE</span><br><span class="line"></span><br><span class="line">3ã€å¯åŠ¨</span><br><span class="line">[root@master01 node_exporter]# /app/node_exporter/node_exporter  &amp;</span><br><span class="line">å¯åŠ¨ï¼Œä¹‹åï¼ŒPrometheusæŒ‚äº†</span><br><span class="line"></span><br><span class="line">4ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.200:9100</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240926170004149.png" alt="image-20240926170004149"></p><p><img src="../image/study_img/image-20240926170140793.png" alt="image-20240926170140793"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">5ã€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå°†node_exporterçš„ä¿¡æ¯åŠ å…¥Prometheus</span><br><span class="line">[root@master01 prometheus-2.54.1]# vim prometheus.yml</span><br><span class="line">......</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: <span class="string">&quot;prometheus&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [<span class="string">&quot;10.0.0.200:9090&quot;</span>]</span><br><span class="line">  - job_name: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">    <span class="comment">#å†™node_exporterçš„åœ°å€å’Œç«¯å£</span></span><br><span class="line">      - targets: [<span class="string">&quot;10.0.0.200:9100&quot;</span>]</span><br><span class="line">      </span><br><span class="line">6ã€å†æ¬¡é‡æ–°å¯åŠ¨Prometheus</span><br><span class="line">[root@master01 prometheus]# <span class="built_in">jobs</span></span><br><span class="line">[1]-  Running                 /app/prometheus/prometheus --config.file=/app/prometheus/prometheus.yml &amp;</span><br><span class="line">[2]+  Running                 /app/node_exporter/node_exporter &amp;  (wd: /app/node_exporter)</span><br><span class="line">[root@master01 prometheus]# <span class="built_in">kill</span> %1</span><br><span class="line"></span><br><span class="line">[root@master01 prometheus]# /app/prometheus/prometheus --config.file=/app/prometheus/prometheus.yml &amp;</span><br><span class="line"></span><br><span class="line">7ã€åˆ·æ–°é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°node_exporterçš„èŠ‚ç‚¹</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240926171311595.png" alt="image-20240926171311595"></p><p>4ã€éƒ¨ç½²supervisor</p><p>node_exporterå’ŒPrometheusæœåŠ¡,å¯åœæ²¡æœ‰ä½¿ç”¨systemdç®¡ç†ï¼Œè¿™æ¬¡ä½¿ç”¨supervisorç®¡ç†æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">1ã€å®‰è£…supervisor   æ˜¯pythonå†™çš„</span><br><span class="line">[root@master01 prometheus-2.54.1]# yum -y install supervisor</span><br><span class="line">[root@master01 prometheus]# systemctl start supervisord</span><br><span class="line">[root@master01 prometheus]# systemctl <span class="built_in">enable</span> supervisord</span><br><span class="line">å¦‚æœå…¬å¸æœ‰ä¸€äº›å‰ç«¯æˆ–è€…åç«¯çš„é¡µé¢è¦å¯åŠ¨éƒ½å¯ä»¥æ”¾åˆ°è¿™é‡Œç®¡ç†</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹é…ç½®æ–‡ä»¶</span><br><span class="line">[root@master01 prometheus]# vim /etc/supervisord.conf </span><br><span class="line">[include]</span><br><span class="line">files = supervisord.d/*.ini   <span class="comment">#å­é…ç½®æ–‡ä»¶çš„å†™æ³•</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€ç¼–å†™promethueså¯åŠ¨è„šæœ¬</span><br><span class="line">[root@master01 prometheus]# vim /etc/supervisord.d/prome.ini</span><br><span class="line">[program:prometheus]</span><br><span class="line">directory=/app/prometheus/</span><br><span class="line"><span class="built_in">command</span>=/bin/bash -c <span class="string">&quot;/app/prometheus/prometheus --config.file=/app/prometheus/prometheus.yml&quot;</span></span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">stdout_logfile=/var/log/prome_stdout.log</span><br><span class="line">stderr_logfile=/var/log/prome_stderr.log</span><br><span class="line">user=root</span><br><span class="line">stopsignal=TERM</span><br><span class="line">startsecs=5</span><br><span class="line">startretries=3</span><br><span class="line">stopasgroup=<span class="literal">true</span></span><br><span class="line">killasgroup=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿›ç¨‹/ç¨‹åºï¼šç¨‹åºå</span></span><br><span class="line">[program:prometheus]</span><br><span class="line"><span class="comment">#ç¨‹åºçš„å·¥ä½œç›®å½•</span></span><br><span class="line">directory=/app/prometheus/</span><br><span class="line"><span class="comment">#å¯åŠ¨å‘½ä»¤</span></span><br><span class="line"><span class="built_in">command</span>=/bin/bash -c <span class="string">&quot;/app/prometheus/prometheus --config.file=/app/prometheus/prometheus.yml&quot;</span></span><br><span class="line"><span class="comment">#è‡ªåŠ¨å¯åŠ¨ï¼Œå¯ä»¥çœ‹åšå¼€æœºè‡ªå¯åŠ¨ï¼Œåªè¦supervisoå¯åŠ¨ï¼Œä»–å°±å¯åŠ¨ï¼Œæ‰€ä»¥è¦ç»™supervisoè®¾ç½®å¼€æœºè‡ªå¯åŠ¨</span></span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line"><span class="comment">#è‡ªåŠ¨å¯åŠ¨</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line"><span class="comment">#æ ‡å‡†è¾“å‡ºçš„æ—¥å¿—</span></span><br><span class="line">stdout_logfile=/var/log/prome_stdout.log</span><br><span class="line"><span class="comment">#é”™è¯¯è¾“å‡ºçš„æ—¥å¿—</span></span><br><span class="line">stderr_logfile=/var/log/prome_stderr.log</span><br><span class="line"><span class="comment">#ç¨‹åºçš„å¯åŠ¨ç”¨æˆ·</span></span><br><span class="line">user=root</span><br><span class="line"><span class="comment">#stopçš„ä¿¡å·æ˜¯termï¼Œkill -lå¯ä»¥çœ‹åˆ°æ‰€æœ‰ä¿¡å·ï¼Œæœ‰ä¸€ä¸ª15)çš„ä¿¡å· ç›¸å½“äºkill -15 è¿›ç¨‹åï¼Œè¿™ä¸ªæ˜¯æœ€æ ‡å‡†æœ€å®‰å…¨çš„æ€è¿›ç¨‹</span></span><br><span class="line">stopsignal=TERM</span><br><span class="line"><span class="comment">#å¯åŠ¨çš„è¶…æ—¶æ—¶é—´5sï¼Œè¶…è¿‡5sæ²¡èµ·æ¥å°±æ˜¯è¶…æ—¶</span></span><br><span class="line">startsecs=5</span><br><span class="line"><span class="comment">#é‡è¯•æ¬¡æ•°</span></span><br><span class="line">startretries=3</span><br><span class="line"><span class="comment">#å¦‚æœä½ çš„è¿™ä¸ªè„šæœ¬åœäº†ï¼Œè¿™ä¸ªè„šæœ¬é‡Œé¢çš„å…¶ä»–ç¨‹åºä¹Ÿåœæ‰</span></span><br><span class="line">stopasgroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#è¿™ä¸ªè„šæœ¬é‡Œé¢çš„å…¶ä¸­ä¸€ä¸ªæœåŠ¡æ€æ‰ï¼Œå…¶ä»–æœåŠ¡ä¹Ÿæ€æ‰</span></span><br><span class="line">killasgroup=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€éœ€è¦æ›´æ–°å¯åŠ¨è„šæœ¬,æ¯æ¬¡æ›´æ”¹è¿™ä¸ªå¯åŠ¨è„šæœ¬éƒ½è¦æ›´æ–°ï¼Œç›¸å½“äºæ‰§è¡Œsystemctl daemon-reload</span><br><span class="line">[root@master01 prometheus]# supervisorctl update</span><br><span class="line">prometheus: added process group</span><br><span class="line"></span><br><span class="line">5ã€å…ˆæŠŠåå°çš„2ä¸ªè¿›ç¨‹åœæ­¢æ‰ï¼Œ</span><br><span class="line">[root@master01 prometheus]# <span class="built_in">jobs</span></span><br><span class="line">[2]-  Running                 /app/node_exporter/node_exporter &amp;  (wd: /app/node_exporter)</span><br><span class="line">[3]+  Running                 /app/prometheus/prometheus --config.file=/app/prometheus/prometheus.yml &amp;</span><br><span class="line">[root@master01 prometheus]# <span class="built_in">kill</span> %1</span><br><span class="line">-bash: <span class="built_in">kill</span>: %1: no such job</span><br><span class="line">[root@master01 prometheus]# <span class="built_in">kill</span> %2</span><br><span class="line">[root@master01 prometheus]# <span class="built_in">kill</span> %3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6ã€supervisoræ§åˆ¶æœåŠ¡çš„å¯åœ</span><br><span class="line">[root@master01 prometheus]# supervisorctl start all</span><br><span class="line">prometheus: started</span><br><span class="line">[root@master01 prometheus]# supervisorctl stop all</span><br><span class="line">prometheus: stopped</span><br><span class="line"></span><br><span class="line">æˆ–è€…</span><br><span class="line">[root@master01 prometheus]# supervisorctl stop prometheus</span><br><span class="line">prometheus: stopped</span><br><span class="line">[root@master01 prometheus]# supervisorctl start prometheus</span><br><span class="line">prometheus: started</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240926181219003.png" alt="image-20240926181219003"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#supervisorçš„å¤šæœåŠ¡ç®¡ç†</span></span><br><span class="line">7ã€ç¼–å†™node_exporterçš„å¯åŠ¨è„šæœ¬</span><br><span class="line">[root@master01 prometheus]# vim /etc/supervisord.d/prome.ini</span><br><span class="line">[program:prometheus]</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="comment">#åŠ å…¥node_exporterçš„å¯åœæ­¢è„šæœ¬</span></span><br><span class="line">[program:node_exporter]</span><br><span class="line">directory=/app/node_exporter/</span><br><span class="line"><span class="built_in">command</span>=/bin/bash -c <span class="string">&quot;/app/node_exporter/node_exporter&quot;</span></span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">stdout_logfile=/var/log/node_exporter_stdout.log</span><br><span class="line">stderr_logfile=/var/log/node_exporter_stderr.log</span><br><span class="line">user=root</span><br><span class="line">stopsignal=TERM</span><br><span class="line">startsecs=5</span><br><span class="line">startretries=3</span><br><span class="line">stopasgroup=<span class="literal">true</span></span><br><span class="line">killasgroup=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">8ã€æ›´æ–°å¯åŠ¨è„šæœ¬</span><br><span class="line">[root@master01 prometheus]# supervisorctl update</span><br><span class="line">node_exporter: added process group</span><br><span class="line">åŠ è¿›å»ä¼šè‡ªåŠ¨å¯åŠ¨ï¼Œå› ä¸ºå†™äº†autostart=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">9ã€å¦‚æœä½¿ç”¨å¦‚ä¸‹ç›®å½•ï¼Œå°±ä¼š2ä¸ªæœåŠ¡ä¸€èµ·å¯åŠ¨æˆ–åœæ­¢</span><br><span class="line">[root@master01 prometheus]# supervisorctl stop all</span><br><span class="line">node_exporter: stopped</span><br><span class="line">prometheus: stopped</span><br><span class="line">[root@master01 prometheus]# supervisorctl start all</span><br><span class="line">node_exporter: started</span><br><span class="line">prometheus: started</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# supervisorctl status</span><br><span class="line">node_exporter                    RUNNING   pid 33788, <span class="built_in">uptime</span> 0:05:37</span><br><span class="line">prometheus                       RUNNING   pid 33789, <span class="built_in">uptime</span> 0:05:37</span><br></pre></td></tr></table></figure><p>5ã€å®‰è£…pushgateway</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">1ã€å®‰è£…</span><br><span class="line">[root@master01 ~]# tar xf pushgateway-1.10.0.linux-amd64.tar.gz  -C /app/</span><br><span class="line">[root@master01 ~]# <span class="built_in">mv</span> /app/pushgateway-1.10.0.linux-amd64/ /app/pushgateway-1.10.0</span><br><span class="line">[root@master01 ~]# <span class="built_in">ln</span> -s /app/pushgateway-1.10.0/ /app/pushgateway</span><br><span class="line"></span><br><span class="line">2ã€å¯åŠ¨å‘½ä»¤</span><br><span class="line">[root@master01 ~]# /app/pushgateway/pushgateway</span><br><span class="line"></span><br><span class="line">3ã€ä¿®æ”¹å¯åŠ¨è„šæœ¬</span><br><span class="line">[root@master01 ~]# vim /etc/supervisord.d/prome.ini</span><br><span class="line">[program:prometheus]</span><br><span class="line">[program:node_exporter]</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="comment">#åŠ å…¥pushgatewayçš„å¯åœæ­¢è„šæœ¬</span></span><br><span class="line">[program:pushgateway]</span><br><span class="line">directory=/app/pushgateway/</span><br><span class="line"><span class="built_in">command</span>=/bin/bash -c <span class="string">&quot;/app/pushgateway/pushgateway&quot;</span></span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">stdout_logfile=/var/log/pushgateway_stdout.log</span><br><span class="line">stderr_logfile=/var/log/pushgateway_stderr.log</span><br><span class="line">user=root</span><br><span class="line">stopsignal=TERM</span><br><span class="line">startsecs=5</span><br><span class="line">startretries=3</span><br><span class="line">stopasgroup=<span class="literal">true</span></span><br><span class="line">killasgroup=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">4ã€æ›´æ–°å¯åŠ¨è„šæœ¬</span><br><span class="line">[root@master01 prometheus]# supervisorctl update</span><br><span class="line">pushgateway: added process group</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# supervisorctl status</span><br><span class="line">node_exporter                    RUNNING   pid 33788, <span class="built_in">uptime</span> 1:20:01</span><br><span class="line">prometheus                       RUNNING   pid 33789, <span class="built_in">uptime</span> 1:20:01</span><br><span class="line">pushgateway                      RUNNING   pid 77783, <span class="built_in">uptime</span> 0:01:20</span><br><span class="line"></span><br><span class="line">5ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.200:9091</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240926195532979.png" alt="image-20240926195532979"></p><p>6ã€éƒ¨ç½²alertmanager</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1ã€å®‰è£…</span><br><span class="line">[root@master01 ~]# tar xf alertmanager-0.27.0.linux-amd64.tar.gz -C /app/</span><br><span class="line">[root@master01 ~]# <span class="built_in">mv</span> /app/alertmanager-0.27.0.linux-amd64/ /app/alertmanager-0.27.0</span><br><span class="line">[root@master01 ~]# <span class="built_in">ln</span> -s /app/alertmanager-0.27.0/ /app/alertmanager</span><br><span class="line">[root@master01 ~]# ll /app/alertmanager/</span><br><span class="line">é‡Œé¢æœ‰é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯ä¸éœ€è¦æ”¹</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹å¸®åŠ©</span><br><span class="line">[root@master01 ~]# /app/alertmanager/alertmanager  --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">3ã€å¯åŠ¨</span><br><span class="line">[root@master01 ~]# /app/alertmanager/alertmanager  --config.file=/app/alertmanager/alertmanager.yml </span><br><span class="line"></span><br><span class="line">4ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.200:9093</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240926194338396.png" alt="image-20240926194338396"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">5ã€ä¿®æ”¹å¯åŠ¨è„šæœ¬</span><br><span class="line">[root@master01 ~]# vim /etc/supervisord.d/prome.ini</span><br><span class="line">[program:prometheus]</span><br><span class="line">[program:node_exporter]</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="comment">#åŠ å…¥alertmanagerçš„å¯åœæ­¢è„šæœ¬</span></span><br><span class="line">[program:alertmanager]</span><br><span class="line">directory=/app/alertmanager/</span><br><span class="line"><span class="built_in">command</span>=/bin/bash -c <span class="string">&quot;/app/alertmanager/alertmanager  --config.file=/app/alertmanager/alertmanager.yml &quot;</span></span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">stdout_logfile=/var/log/alertmanager_stdout.log</span><br><span class="line">stderr_logfile=/var/log/alertmanager_stderr.log</span><br><span class="line">user=root</span><br><span class="line">stopsignal=TERM</span><br><span class="line">startsecs=5</span><br><span class="line">startretries=3</span><br><span class="line">stopasgroup=<span class="literal">true</span></span><br><span class="line">killasgroup=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">8ã€æ›´æ–°å¯åŠ¨è„šæœ¬</span><br><span class="line">[root@master01 ~]# supervisorctl update</span><br><span class="line">alertmanager: added process group</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# supervisorctl status</span><br><span class="line">alertmanager                     RUNNING   pid 77780, <span class="built_in">uptime</span> 0:01:20</span><br><span class="line">node_exporter                    RUNNING   pid 33788, <span class="built_in">uptime</span> 1:20:01</span><br><span class="line">prometheus                       RUNNING   pid 33789, <span class="built_in">uptime</span> 1:20:01</span><br><span class="line">pushgateway                      RUNNING   pid 77783, <span class="built_in">uptime</span> 0:01:20</span><br></pre></td></tr></table></figure><p>7ã€3å°nodeèŠ‚ç‚¹éƒ¨ç½²node_exporter</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">-----------#3å°éƒ½è¦å®‰è£…------------------------</span><br><span class="line">1ã€å®‰è£…node_exporter   </span><br><span class="line">[root@node01 ~]# <span class="built_in">mkdir</span> /app</span><br><span class="line">[root@node01 ~]# tar xf node_exporter-1.8.2.linux-amd64.tar.gz -C /app</span><br><span class="line">[root@node01 ~]# <span class="built_in">mv</span> /app/node_exporter-1.8.2.linux-amd64/ /app/node_exporter-1.8.2</span><br><span class="line">[root@node01 ~]# <span class="built_in">ln</span> -s /app/node_exporter-1.8.2 /app/node_exporter</span><br><span class="line">[root@node01 ~]# <span class="built_in">cd</span> /app/node_exporter</span><br><span class="line">[root@node01 node_exporter]# ll</span><br><span class="line">total 20040</span><br><span class="line">-rw-r--r-- 1 1001 1002    11357 Jul 14 19:57 LICENSE</span><br><span class="line">-rwxr-xr-x 1 1001 1002 20500541 Jul 14 19:54 node_exporter</span><br><span class="line">-rw-r--r-- 1 1001 1002      463 Jul 14 19:57 NOTICE</span><br><span class="line">[root@node01 node_exporter]# yum -y install supervisor</span><br><span class="line">[root@node01 node_exporter]# systemctl start supervisord</span><br><span class="line">[root@node01 node_exporter]# systemctl <span class="built_in">enable</span> supervisord</span><br><span class="line"></span><br><span class="line">2ã€ç¼–å†™å¯åŠ¨è„šæœ¬</span><br><span class="line">[root@node01 node_exporter]# vim /etc/supervisord.d/prome.ini</span><br><span class="line">[program:node_exporter]</span><br><span class="line">directory=/app/node_exporter/</span><br><span class="line"><span class="built_in">command</span>=/bin/bash -c <span class="string">&quot;/app/node_exporter/node_exporter&quot;</span></span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">stdout_logfile=/var/log/node_exporter_stdout.log</span><br><span class="line">stderr_logfile=/var/log/node_exporter_stderr.log</span><br><span class="line">user=root</span><br><span class="line">stopsignal=TERM</span><br><span class="line">startsecs=5</span><br><span class="line">startretries=3</span><br><span class="line">stopasgroup=<span class="literal">true</span></span><br><span class="line">killasgroup=<span class="literal">true</span></span><br><span class="line">             </span><br><span class="line">[root@node01 node_exporter]# supervisorctl update</span><br><span class="line">node_exporter: added process group</span><br><span class="line">[root@node01 node_exporter]# supervisorctl start all</span><br><span class="line">------------------------------------------------</span><br><span class="line"></span><br><span class="line">--------------#masteræ“ä½œ---------------------</span><br><span class="line">3ã€#masteræ“ä½œ</span><br><span class="line">ä¿®æ”¹prometheusé…ç½®æ–‡ä»¶ï¼Œå°†node_exporterçš„ä¿¡æ¯åŠ å…¥Prometheus</span><br><span class="line">[root@master01 prometheus-2.54.1]# vim prometheus.yml</span><br><span class="line">......</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: <span class="string">&quot;prometheus&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [<span class="string">&quot;10.0.0.200:9090&quot;</span>]</span><br><span class="line">  - job_name: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">    <span class="comment">#å†™node_exporterçš„åœ°å€å’Œç«¯å£,å°†node01  02 03çš„ipç«¯å£æ·»åŠ </span></span><br><span class="line">      - targets: [<span class="string">&quot;10.0.0.200:9100&quot;</span>, <span class="string">&quot;10.0.0.201:9100&quot;</span>, <span class="string">&quot;10.0.0.202:9100&quot;</span>, <span class="string">&quot;10.0.0.203:9100&quot;</span>]</span><br><span class="line">      </span><br><span class="line">4ã€é‡å¯</span><br><span class="line">[root@master01 prometheus]# supervisorctl restart all</span><br><span class="line"></span><br><span class="line">5ã€è®¿é—®é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°nodeèŠ‚ç‚¹éƒ½èµ·æ¥äº†</span><br><span class="line">10.0.0.200:9090</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240926210750410.png" alt="image-20240926210750410"></p><p>8ã€3å°nodeèŠ‚ç‚¹å®‰è£…cAdVisor</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1ã€3å°nodeèŠ‚ç‚¹æ‹‰å–cadvisoré•œåƒ</span><br><span class="line">docker pull google/cadvisor:latest</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œé•œåƒ</span><br><span class="line">[root@node01 ~]# docker run --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/data/cadvisor:/var/lib/docker.io --publish=8080:8080 --detach=<span class="literal">true</span> --name=cadvisor google/cadvisor:latest</span><br></pre></td></tr></table></figure><h3 id="5ã€Prometheusè‡ªåŠ¨å‘ç°â€”â€”file-sd-æ–‡ä»¶å‘ç°"><strong>5ã€Prometheusè‡ªåŠ¨å‘ç°â€”â€”file-sd(æ–‡ä»¶å‘ç°)</strong></h3><p>1ã€å…ˆæŠŠPrometheusæ”¶é›†åˆ°çš„nodeèŠ‚ç‚¹åœ¨Prometheusçš„é…ç½®æ–‡ä»¶é‡Œé¢åˆ é™¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¿®æ”¹é…ç½®æ–‡ä»¶</span><br><span class="line">[root@master01 prometheus-2.54.1]# vim prometheus.yml</span><br><span class="line">......</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: <span class="string">&quot;prometheus&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [<span class="string">&quot;10.0.0.200:9090&quot;</span>]</span><br><span class="line">  - job_name: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">    <span class="comment">#æ”¹å›åªè·å–master01çš„</span></span><br><span class="line">      - targets: [<span class="string">&quot;10.0.0.200:9100&quot;</span>]</span><br></pre></td></tr></table></figure><p>2ã€ä¿®æ”¹Prometheusé…ç½®æ–‡ä»¶ï¼Œæ·»åŠ è‡ªåŠ¨å‘ç°è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¿®æ”¹é…ç½®æ–‡ä»¶</span><br><span class="line">[root@master01 prometheus]# vim prometheus.yml</span><br><span class="line">scrape_configs:</span><br><span class="line">.....</span><br><span class="line"><span class="comment">#æ·»åŠ è‡ªåŠ¨å‘ç°è§„åˆ™</span></span><br><span class="line"> - job_name: <span class="string">&quot;prome_file_sd&quot;</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /app/prometheus/file_sd/agent.yml</span><br><span class="line">      refresh_interval: 5s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€åˆ›å»ºæ–‡ä»¶å‘ç°é…ç½®å­˜æ”¾ç›®å½•</span><br><span class="line">[root@master01 prometheus]# <span class="built_in">mkdir</span> -p /app/prometheus/file_sd</span><br><span class="line"></span><br><span class="line">3ã€ç¼–è¾‘æ–‡ä»¶å‘ç°çš„é…ç½®æ–‡ä»¶</span><br><span class="line">ä»¥åå¯èƒ½åƒpushgatewayä¹Ÿè¦åŠ è¿›æ¥</span><br><span class="line">[root@master01 prometheus]# vim /app/prometheus/file_sd/agent.yml</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;targets&quot;</span>:  [<span class="string">&quot;10.0.0.201:9100&quot;</span>,<span class="string">&quot;10.0.0.202:9100&quot;</span>,<span class="string">&quot;10.0.0.203:9100&quot;</span>],</span><br><span class="line">    <span class="string">&quot;labels&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;agent&quot;</span>: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;targets&quot;</span>:  [<span class="string">&quot;10.0.0.201:8080&quot;</span>,<span class="string">&quot;10.0.0.202:8080&quot;</span>,<span class="string">&quot;10.0.0.203:8080&quot;</span>],</span><br><span class="line">    <span class="string">&quot;labels&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;agent&quot;</span>: <span class="string">&quot;cAdVisor&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line">      </span><br><span class="line">2ã€é‡å¯Prometheus</span><br><span class="line">[root@master01 prometheus]# supervisorctl restart all</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240927135935380.png" alt="image-20240927135935380"></p><h3 id="6ã€Prometheusæ•°æ®æ ¼å¼"><strong>6ã€Prometheusæ•°æ®æ ¼å¼</strong></h3><p><strong>â‘ ã€PrometheusæŒ‡æ ‡ç±»å‹</strong></p><p><img src="../image/study_img/image-20240927100110091.png" alt="image-20240927100110091"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ•°æ®æè¿°</span></span><br><span class="line"><span class="comment"># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.</span></span><br><span class="line"><span class="comment">#æ•°æ®ç±»å‹ (ä¸‹é¢æ”¶é›†åˆ°çš„æ•°æ®å«æŒ‡æ ‡ï¼ŒæŒ‡æ ‡ç±»å‹)</span></span><br><span class="line"><span class="comment"># TYPE node_cpu_seconds_total counter</span></span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125; 335802.19  <span class="comment">#ç©ºé—²</span></span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;iowait&quot;</span>&#125; 115.16   <span class="comment">#ç­‰å¾…</span></span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;irq&quot;</span>&#125; 0    <span class="comment">#</span></span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;nice&quot;</span>&#125; 3.2</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;softirq&quot;</span>&#125; 602.95</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;steal&quot;</span>&#125; 0</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;system&quot;</span>&#125; 11580.34 <span class="comment">#å†…æ ¸æ€</span></span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;user&quot;</span>&#125; 8994.06   <span class="comment">#ç”¨æˆ·æ€</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cpu2ä¸ªæ ¸å¿ƒçš„</span></span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125; 337368.67</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;iowait&quot;</span>&#125; 10.91</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;irq&quot;</span>&#125; 0</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;nice&quot;</span>&#125; 3.41</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;softirq&quot;</span>&#125; 520.71</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;steal&quot;</span>&#125; 0</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;system&quot;</span>&#125; 11293.66</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;user&quot;</span>&#125; 9194.18</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŒ‡æ ‡ç±»å‹    åé¢çš„è‡ªå®šä¹‰ç›‘æ§è¦å®šä¹‰æŒ‡æ ‡ç±»å‹</span></span><br><span class="line">1ã€gaugeï¼šç¬æ—¶å€¼ï¼Œå½“å‰æœ€æ–°çš„å€¼   <span class="comment">#(å¸¸ç”¨çš„)</span></span><br><span class="line">æ¯”å¦‚æ”¶é›†ç”¨æˆ·æœ€æ–°çš„ç™»å½•æ•°é‡</span><br><span class="line">Gaugesæ˜¯æœ€ç®€å•çš„åº¦é‡æŒ‡æ ‡ï¼Œåªæœ‰ä¸€ä¸ªç®€å•çš„è¿”å›å€¼ï¼Œæˆ–è€…å«ç¬æ—¶çŠ¶æ€ã€‚</span><br><span class="line">ä¾‹å¦‚ï¼šæˆ‘ä»¬æƒ³è¡¡é‡ä¸€ä¸ªå¾…å¤„ç†é˜Ÿåˆ—ä¸­ä»»åŠ¡çš„ä¸ªæ•°ï¼Œè¿™ä¸ªä¸ªæ•°æ˜¯ä¼šå˜åŒ–çš„ã€‚</span><br><span class="line">å½“æˆ‘ä»¬è¦ç›‘æ§ç¡¬ç›˜å®¹é‡æˆ–è€…å†…å­˜çš„ä½¿ç”¨é‡ï¼Œé‚£ä¹ˆå°±åº”è¯¥ä½¿ç”¨Gaugesçš„metricsæ ¼å¼æ¥è¡¡é‡ï¼Œå› ä¸ºç¡¬ç›˜çš„å®¹é‡æˆ–è€…å†…å­˜çš„ä½¿ç”¨é‡æ˜¯éšæ—¶é—´çš„æ¨ç§»ï¼Œä¸æ–­ç¬æ—¶ä¸”æ— è§„åˆ™å˜åŒ–çš„ã€‚</span><br><span class="line">è¿™ç§å˜åŒ–æ²¡æœ‰è§„å¾‹ï¼Œå½“å‰æ˜¯å¤šå°‘ï¼Œé‡‡é›†å›æ¥çš„å°±æ˜¯å¤šå°‘ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€counterï¼šè®¡æ•°å™¨ç±»å‹         <span class="comment">#(å¸¸ç”¨çš„)</span></span><br><span class="line">Counterså°±æ˜¯è®¡æ•°å™¨ï¼Œä»æ•°æ®é‡0å¼€å§‹ç§¯ç´¯è®¡ç®—ï¼Œåœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œåªèƒ½æ˜¯æ°¸è¿œçš„å¢é•¿ï¼Œä¸ä¼šé™ä½(ä¸€äº›ç‰¹æ®Šæƒ…å†µå¦è¯´,æ¯”å¦‚è¯´ç²‰ä¸æ•°,æœªå¿…å°±æ˜¯åªå¢ä¸å‡.)ã€‚</span><br><span class="line">æ¯”å¦‚ç»Ÿè®¡ä¸€å°æ—¶ï¼Œä¸€å¤©ï¼Œä¸€å‘¨ï¼Œä¸€ä¸ªæœˆçš„ç”¨æˆ·çš„è®¿é—®é‡ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªç´¯åŠ çš„æ“ä½œã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€histogramsï¼šç»Ÿè®¡æ•°æ®çš„å‘å¸ƒæƒ…å†µã€‚æ¯”å¦‚æœ€å°å€¼ï¼Œæœ€å¤§å€¼ï¼Œä¸­é—´å€¼ï¼Œè¿˜æœ‰ä¸­ä½æ•° (å¾ˆå°‘ç”¨)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸¾ä¸ªä¾‹å­:</span></span><br><span class="line">å¦‚æœæˆ‘ä»¬æƒ³é€šè¿‡ç›‘æ§çš„æ–¹å¼æŠ“å–å½“å¤©nginxçš„access.logï¼Œå¹¶ä¸”æƒ³ç›‘æ§ç”¨æˆ·çš„è®¿é—®æœåŠ¡å‡ºç°çš„æ•…éšœæ—¶é—´ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢?</span><br><span class="line"><span class="comment"># é”™è¯¯è§£å†³æ–¹æ¡ˆ</span></span><br><span class="line">æŠŠæ—¥å¿—æ¯è¡Œçš„<span class="string">&quot;http_response_time&quot;</span>æ•°å€¼ç»Ÿç»Ÿé‡‡é›†ä¸‹æ¥ï¼Œç„¶åè®¡ç®—ä¸€ä¸‹æ€»çš„å¹³å‡å€¼ã€‚è¿™æ˜¯æ¯«æ— æ„ä¹‰çš„ï¼Œå› ä¸ºæ•…éšœå‘ç”Ÿæ—¶é—´å¯èƒ½åªæœ‰ä¸€å°æ®µæ—¶é—´ï¼Œæ¯”å¦‚ç½‘ç»œå»¶è¿Ÿæ”¾ç”Ÿåœ¨12:30-12:40ä¹‹é—´ï¼Œå…¶å®ƒæ—¶é—´éƒ½æ˜¯æ­£å¸¸çš„ï¼Œå¦‚æœè®¡ç®—æ€»çš„å¹³å‡å€¼ï¼Œåˆ™ç»“æœçœ‹èµ·æ¥ä¼šå¾ˆæ­£å¸¸ï¼Œæ— æ³•è§¦å‘æŠ¥è­¦åŠŸèƒ½ï¼Œè¿ç»´äººå‘˜å¯èƒ½ä¹Ÿä¸çŸ¥é“è¿™ä»¶äº‹æƒ…å‘ç”Ÿäº†ã€‚</span><br><span class="line"><span class="comment"># æ­£ç¡®è§£å†³æ–¹æ¡ˆ:</span></span><br><span class="line">é€šè¿‡Histogramså‡½æ•°ï¼Œå¯ä»¥åˆ†åˆ«ç»Ÿè®¡å‡ºå…¨éƒ¨ç”¨æˆ·çš„å“åº”æ—¶é—´åœ¨0.05ç§’,1ç§’,2ç§’,5ç§’,10ç§’çš„é‡ã€‚è¿™æ ·è¿ç»´äººå‘˜å°±èƒ½æ ¹æ®è¿™ä¸ªå€¼è¿›è¡ŒæŠ¥è­¦ï¼Œåˆ†æè¿™äº›æ—¶é—´çš„äº§ç”ŸåŸå› ï¼Œä»è€Œé¿å…ä»¥åç±»ä¼¼çš„é—®é¢˜å‘ç”Ÿã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€summaryï¼šç›¸å½“äºå‡çº§ç‰ˆçš„histograms</span><br><span class="line">å› ä¸ºhistogramåœ¨å®¢æˆ·ç«¯å°±æ˜¯ç®€å•çš„åˆ†æ¡¶è®¡æ•°ï¼Œåœ¨prometheusæœåŠ¡ç«¯åŸºäºè¿™ä¹ˆæœ‰é™çš„æ•°æ®åšç™¾åˆ†ä½ä¼°ç®—ï¼Œæ‰€ä»¥çš„ç¡®ä¸æ˜¯å¾ˆå‡†ç¡®ï¼Œsummaryå°±æ˜¯è§£å†³ç™¾åˆ†ä½å‡†ç¡®çš„é—®é¢˜è€Œæ¥çš„ã€‚</span><br><span class="line">æˆ‘ä»¬å¯ä»¥ç®€å•ç†è§£summaryæ˜¯Histogramçš„æ‰©å±•ç±»å‹ï¼Œå¦‚æœæƒ³è¦æ¸…é™¤çš„äº†è§£histogramså’Œsummaryçš„æ›´å¤šç»†èŠ‚ï¼Œå¯è‡ªè¡ŒæŸ¥é˜…ç›¸å…³çš„æ–‡æ¡£ã€‚</span><br></pre></td></tr></table></figure><p><strong>â‘¡ã€æŒ‡æ ‡æ•°æ®æ ¼å¼</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ•°æ®æè¿°</span></span><br><span class="line"><span class="comment"># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.</span></span><br><span class="line"><span class="comment">#æ•°æ®ç±»å‹ (æŒ‡æ ‡ç±»å‹)</span></span><br><span class="line"><span class="comment"># TYPE node_cpu_seconds_total counter</span></span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125; 335802.19</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;iowait&quot;</span>&#125; 115.16</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;irq&quot;</span>&#125; 0</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;nice&quot;</span>&#125; 3.2</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;softirq&quot;</span>&#125; 602.95</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;steal&quot;</span>&#125; 0</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;system&quot;</span>&#125; 11580.34</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;user&quot;</span>&#125; 8994.06</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125; 337368.67</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;iowait&quot;</span>&#125; 10.91</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;irq&quot;</span>&#125; 0</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;nice&quot;</span>&#125; 3.41</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;softirq&quot;</span>&#125; 520.71</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;steal&quot;</span>&#125; 0</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;system&quot;</span>&#125; 11293.66</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;1&quot;</span>,mode=<span class="string">&quot;user&quot;</span>&#125; 9194.18</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">keyï¼šnode_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125; </span><br><span class="line">valueï¼š335802.19</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŒ‡æ ‡æ•°æ®æ ¼å¼å°±æ˜¯å¦‚ä¸‹ï¼š</span></span><br><span class="line">1ã€è¦æœ‰ä¸€è¡Œæè¿°</span><br><span class="line">2ã€è¦æœ‰ä¸€è¡ŒæŒ‡æ ‡ç±»å‹å®šä¹‰</span><br><span class="line">3ã€çœŸå®æ•°æ®(æ•°æ®æ ¼å¼æ˜¯Key value)</span><br><span class="line"></span><br><span class="line">ä»¥åè‡ªå®šä¹‰ç›‘æ§æ”¶é›†åˆ°çš„æ•°æ®è¦ç»„æˆkey valueçš„å½¢å¼</span><br></pre></td></tr></table></figure><p><strong>â‘¢ã€PromeQLæŸ¥è¯¢ç»“æœçš„ç±»å‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PromQLçš„è¡¨è¾¾å¼ä¸­æ”¯æŒä¸€ä¸‹4ç§æ•°æ®ç±»å‹</span><br><span class="line">1ã€å³æ—¶å‘é‡(Instant Vector):</span><br><span class="line">ç‰¹å®šæˆ–å…¨éƒ¨çš„æ—¶é—´åºåˆ—é›†åˆä¸Šï¼Œå…·æœ‰ç›¸åŒæ—¶é—´æˆ³çš„ä¸€ç»„æ ·æœ¬ç§°ä¸ºå³æ—¶å‘é‡ã€‚</span><br><span class="line"></span><br><span class="line">2ã€èŒƒå›´å‘é‡(Range Vector):</span><br><span class="line">ç‰¹å®šæˆ–å…¨éƒ¨çš„æ—¶é—´åºåˆ—é›†åˆä¸Šï¼Œåœ¨æŒ‡å®šçš„åŒä¸€èŒƒå›´å†…çš„æ‰€æœ‰æ ·æœ¬å€¼</span><br><span class="line"></span><br><span class="line">3ã€æ ‡é‡(Scalar):</span><br><span class="line">ä¸€ä¸ªæµ®ç‚¹å‹çš„æ•°æ®å€¼ã€‚å¸¦å°æ•°ç‚¹çš„</span><br><span class="line"></span><br><span class="line">4ã€å­—ç¬¦ä¸²(String)ï¼š</span><br><span class="line">æ”¯æŒä½¿ç”¨å•å¼•å·ï¼ŒåŒå¼•å·æˆ–åå¼•å·è¿›è¡Œå¼•ç”¨ï¼Œä½†åå¼•å·ä¸­ä¸ä¼šè½¬ç§»å­—ç¬¦è¿›è¡Œè½¬ä¹‰</span><br></pre></td></tr></table></figure><p>1ã€å³æ—¶å‘é‡</p><p><img src="../image/study_img/image-20240927151046205.png" alt="image-20240927151046205"></p><p>è¿™äº›æ•°æ®åœ¨åŒä¸€æ—¶åˆ»ï¼ŒåŒä¸€ç§’ï¼Œæ±‡æˆä¸€å°çº¿çš„æ•°æ®å€¼ï¼Œå«å³æ—¶å‘é‡ï¼Œæ¯ä¸€ä¸ªæŒ‡æ ‡åœ¨åŒä¸€ä¸ªæ—¶é—´ç‚¹è·å–åˆ°çš„æ•°æ®å€¼</p><p>2ã€èŒƒå›´å‘é‡   æ¯”å¦‚ä»10ç‚¹~11ç‚¹æŸ¥å‡ºæ¥çš„ç»“æœé›†</p><p><strong>â‘¢ã€Prometheuså¸¸ç”¨çš„å‡½æ•°</strong></p><p>1ã€increaseå‡½æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">increaseå‡½æ•°ï¼šæ±‚æŒ‡å®šæ—¶é—´å†…çš„å¢é‡</span><br><span class="line">    åœ¨prometheusä¸­æ˜¯ç”¨æ¥é’ˆå¯¹Counterè¿™ç§æŒç»­å¢é•¿çš„æ•°å€¼ï¼Œæˆªå–å…¶ä¸­çš„ä¸€æ®µæ—¶é—´çš„å¢é‡ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸¾ä¸ªä¾‹å­:</span></span><br><span class="line">increase(node_cpu_seconds_total[1m]):</span><br><span class="line">    è·å–CPUæ€»ä½¿ç”¨æ—¶é—´åœ¨1åˆ†é’Ÿå†…çš„å¢é‡ï¼Œè®¡ç®—çš„æ˜¯1åˆ†é’Ÿå†…å¢åŠ çš„æ€»é‡ã€‚</span><br><span class="line">    åœ¨å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨é€šå¸¸æ˜¯å¤šæ ¸çš„ï¼Œå› æ­¤è¿™ä¸ªé‡‡é›†çš„æ˜¯æ‰€æœ‰æ ¸å¿ƒçš„å€¼å“Ÿã€‚</span><br><span class="line">increase(node_cpu_seconds_total&#123;instance=<span class="string">&quot;10.0.0.101:9100&quot;</span>&#125;[100m]):</span><br><span class="line">     æˆ‘ä»¬ä¹Ÿå¯ä»¥å€ŸåŠ©æ ‡ç­¾é€‰æ‹©å™¨è¿‡æ»¤æŸ¥çœ‹æŸä¸ªæœåŠ¡å™¨å®ä¾‹çš„é…ç½®.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cpu 1åˆ†é’Ÿçš„å¢é•¿é‡</span><br><span class="line">increase(node_cpu_seconds_total&#123;instance=<span class="string">&#x27;10.0.0.202:9100&#x27;</span>,job=<span class="string">&#x27;prome_file_sd&#x27;</span>,mode=<span class="string">&#x27;system&#x27;</span>&#125;[1m])</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240927102930773.png" alt="image-20240927102930773"></p><p><img src="../image/study_img/image-20240927153951299.png" alt="image-20240927153951299"></p><p>2ã€sumå‡½æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>å‡½æ•°: ä¸»è¦æ˜¯èµ·åˆ°åŠ å’Œçš„ä½œç”¨ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸¾ä¸ªä¾‹å­:</span></span><br><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total[1m])):</span><br><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;job=<span class="string">&#x27;prome_file_sd&#x27;</span>,mode=<span class="string">&#x27;system&#x27;</span>&#125;[1m]))</span><br><span class="line">    åœ¨<span class="string">&quot;increase(node_cpu[1m])&quot;</span>å¤–é¢å¥—ç”¨ä¸€ä¸ª<span class="built_in">sum</span>å‡½æ•°å°±å¯ä»¥æŠŠæ‰€æœ‰CPUæ ¸å¿ƒæ•°åœ¨1åˆ†é’Ÿå†…çš„å¢é‡åšä¸€ä¸ªç´¯åŠ ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;instance=<span class="string">&#x27;10.0.0.202:9100&#x27;</span>,job=<span class="string">&#x27;prome_file_sd&#x27;</span>,mode=<span class="string">&#x27;system&#x27;</span>&#125;[1m]))</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240927103557200.png" alt="image-20240927103557200"></p><p>3ã€byå‡½æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">byå‡½æ•°:</span><br><span class="line">   å°†æ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œç±»ä¼¼äºMySQLçš„<span class="string">&quot;group by&quot;</span>ã€‚</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line"><span class="comment">#ä¸¾ä¸ªä¾‹å­:</span></span><br><span class="line">by (instance):</span><br><span class="line">    è¿™é‡Œçš„<span class="string">&quot;instance&quot;</span>ä»£è¡¨çš„æ˜¯æœºå™¨åç§°ï¼Œæ„æ€æ˜¯å°†æ•°æ®æŒ‰ç…§instanceæ ‡ç­¾è¿›è¡Œå¼ºè¡Œæ‹†åˆ†ã€‚</span><br><span class="line">    è¯¥å‡½æ•°é€šå¸¸ä¼šå’Œ<span class="built_in">sum</span>å‡½æ•°æ­é…ä½¿ç”¨ï¼Œæ¯”å¦‚<span class="string">&quot;(sum(increase(node_cpu_seconds_total[1m]))by (instance))&quot;</span>,è¡¨ç¤ºæŠŠ<span class="built_in">sum</span>å‡½æ•°ä¸­ç´¯åŠ å’ŒæŒ‰ç…§<span class="string">&quot;instance&quot;</span>(æœºå™¨åç§°)å¼ºè¡Œæ‹†åˆ†æˆå¤šç»„æ•°æ®ã€‚å½“ç„¶ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªæœºå™¨åç§°çš„è¯ï¼Œä½ ä¼šå‘ç°åªæœ‰ä¸€ç»„æ•°æ®ï¼Œå› æ­¤ä»ç»“æœä¸Šå¯èƒ½çœ‹ä¸åˆ°æ˜æ˜¾çš„å˜åŒ–å“Ÿã€‚</span><br><span class="line"></span><br><span class="line">æ¸©é¦¨æç¤º:</span><br><span class="line">instanceæ˜¯node_exporterå†…ç½®çš„æ ‡ç­¾ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ ‡ç­¾ï¼Œæ¯”å¦‚æ ¹æ®ç”Ÿäº§ç¯å¢ƒä¸­ä¸åŒçš„é›†ç¾¤æ·»åŠ ç›¸åº”çš„æ ‡ç­¾ã€‚æ¯”å¦‚åŸºäºè‡ªå®šä¹‰çš„<span class="string">&quot;cluster_name&quot;</span>æ ‡ç­¾è¿›è¡Œåˆ†ç»„ç­‰ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;job=<span class="string">&#x27;prome_file_sd&#x27;</span>,mode=<span class="string">&#x27;system&#x27;</span>&#125;[1m]))by(instance)</span><br><span class="line"></span><br><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;agent=<span class="string">&#x27;node_exporter&#x27;</span>,mode=<span class="string">&#x27;system&#x27;</span>&#125;[1m])) by(instance)</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240927104801961.png" alt="image-20240927104801961"></p><p>4ã€rateå‡½æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">rateå‡½æ•°:</span><br><span class="line">    å®ƒçš„åŠŸèƒ½æ˜¯æŒ‰ç…§è®¾ç½®çš„ä¸€ä¸ªæ—¶é—´æ®µï¼Œå–counteråœ¨è¿™ä¸ªæ—¶é—´æ®µä¸­çš„å¹³å‡æ¯ç§’çš„å¢é‡ã€‚å› æ­¤æ˜¯ä¸“é—¨æ­é…counterç±»å‹æ•°æ®ä½¿ç”¨çš„å‡½æ•°ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸¾ä¸ªä¾‹å­:</span></span><br><span class="line">    rate(node_cpu_seconds_total[1m]):</span><br><span class="line">è·å–CPUæ€»ä½¿ç”¨æ—¶é—´åœ¨1åˆ†é’Ÿå†…çš„å¢åŠ çš„æ€»é‡å¹¶é™¤ä»¥60ç§’ï¼Œè®¡ç®—çš„æ˜¯æ¯ç§’çš„å¢é‡ã€‚</span><br><span class="line"></span><br><span class="line">    rate(node_network_receive_bytes_total[1m]):</span><br><span class="line">è·å–ä¸€åˆ†é’Ÿå†…ç½‘ç»œæ¥æ”¶çš„æ€»é‡ã€‚</span><br><span class="line">æŸ¥çœ‹çš„æ—¶é—´è¶ŠçŸ­ï¼ŒæŸä¸€ç¬é—´çš„çªèµ·æˆ–é™ä½åœ¨æˆå›¾çš„æ—¶å€™ä¼šä½“ç°çš„æ›´ç»†è‡´ï¼Œæ›´æ•æ„Ÿã€‚</span><br><span class="line"></span><br><span class="line">    rate(node_network_receive_bytes_total[20m])</span><br><span class="line">è·å–äºŒååˆ†é’Ÿå†…ç½‘ç»œæ¥æ”¶çš„æ€»é‡ã€‚</span><br><span class="line">æŸ¥çœ‹çš„æ—¶é—´è¶Šé•¿ï¼Œé‚£ä¹ˆå½“å‘ç”Ÿç¬é—´çš„çªèµ·æˆ–é™ä½æ—¶å€™ï¼Œä¼šæ˜¾å¾—å¹³ç¼“ä¸€äº›ï¼Œå› ä¸ºå–å¾—æ—¶é—´æ®µè¶Šé•¿ä¼šæŠŠæ³¢å³°æ³¢è°·éƒ½ç»™å¹³å‡æ¶ˆä¸‹å»äº†ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#increaseå‡½æ•°å’Œrateå‡½æ•°å¦‚æ­¤ç›¸ä¼¼å¦‚ä½•é€‰æ‹©?</span></span><br><span class="line">(1)å¯¹äºé‡‡é›†é¢‘ç‡è¾ƒä½çš„æ•°æ®é‡‡ç”¨å»ºè®®ä½¿ç”¨increaseå‡½æ•°ï¼Œå› ä¸ºä½¿ç”¨rateå‡½æ•°å¯èƒ½ä¼šå‡ºç°æ–­ç‚¹(æ¯”å¦‚æŒ‰ç…§5åˆ†é’Ÿé‡‡æ ·æ•°æ®é‡è¾ƒå°çš„åœºæ™¯ï¼Œä»¥é‡‡é›†ç¡¬ç›˜å¯ç”¨å®¹é‡ä¸ºä¾‹ï¼Œå¯èƒ½ä¼šå‡ºç°æŸæ¬¡é‡‡é›†æ•°æ®æœªé‡‡é›†åˆ°çš„æƒ…å†µï¼Œå› ä¸ºä¼šæŒ‰ç…§å¹³å‡æ¯ç§’æ¥è®¡ç®—æœ€ç»ˆçš„å¢é‡)çš„æƒ…å†µ;</span><br><span class="line"></span><br><span class="line">(2)å¯¹äºé‡‡é›†é¢‘ç‡è¾ƒé«˜çš„æ•°æ®é‡‡ç”¨å»ºè®®ä½¿ç”¨rateå‡½æ•°ï¼Œæ¯”å¦‚å¯¹CPUï¼Œå†…å­˜ï¼Œç½‘ç»œæµé‡ç­‰éƒ½å¯ä»¥åŸºäºrateå‡½æ•°æ¥é‡‡æ ·ï¼Œå½“ç„¶ï¼Œç¡¬ç›˜ä¹Ÿæ˜¯å¯ä»¥ç”¨rateå‡½æ•°æ¥é‡‡æ ·çš„å“Ÿ;</span><br><span class="line">æ¸©é¦¨æç¤º:</span><br><span class="line"></span><br><span class="line">åœ¨å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å–ç›‘æ§é¢‘ç‡ä¸º1åˆ†é’Ÿè¿˜æ˜¯5åˆ†é’Ÿè¿™å–å†³ä¸æˆ‘ä»¬å¯¹äºç›‘æ§æ•°æ®çš„æ•æ„Ÿç¨‹åº¦æ¥æŒ‘é€‰ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rate(node_cpu_seconds_total&#123;agent=<span class="string">&#x27;node_exporter&#x27;</span>,mode=<span class="string">&#x27;system&#x27;</span>&#125;[1m])</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240927105435679.png" alt="image-20240927105435679"></p><p>5ã€irateå‡½æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  irateå‡½æ•°ï¼šä¸»è¦ç”¨äºè®¡ç®—å‘é‡ï¼ˆé€šå¸¸æ˜¯Counterç±»å‹çš„æ—¶é—´åºåˆ—ï¼‰åœ¨æ¯ä¸ªæ—¶é—´èŒƒå›´å†…çš„æ¯ç§’ç¬æ—¶å¢é•¿ç‡ã€‚ä¸rateå‡½æ•°ä¸åŒï¼Œirateç‰¹åˆ«å…³æ³¨äºæ—¶é—´èŒƒå›´å†…çš„æœ€åä¸¤ä¸ªæ•°æ®ç‚¹ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªç‚¹çš„å·®å€¼é™¤ä»¥å®ƒä»¬ä¹‹é—´çš„æ—¶é—´å·®æ¥å¾—åˆ°ç¬æ—¶å¢é•¿ç‡ã€‚è¿™ç§æ–¹å¼ä½¿å¾—irateåœ¨æ•æ‰å¿«é€Ÿå˜åŒ–æˆ–æ³¢åŠ¨è¾ƒå¤§çš„æ•°æ®æ—¶æ›´åŠ æ•æ„Ÿã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸¾ä¸ªä¾‹å­:</span></span><br><span class="line">å‡è®¾æœ‰ä¸€ä¸ªåä¸ºhttp_requests_totalçš„Counterç±»å‹æ—¶é—´åºåˆ—ï¼Œè®°å½•äº†HTTPè¯·æ±‚çš„æ€»æ•°ã€‚è¦è®¡ç®—è¿‡å»5åˆ†é’Ÿå†…æ¯ç§’çš„HTTPè¯·æ±‚ç¬æ—¶å¢é•¿ç‡ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹PromQLè¡¨è¾¾å¼ï¼š</span><br><span class="line">irate(http_requests_total[5m])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">irate(node_cpu_seconds_total&#123;agent=<span class="string">&#x27;node_exporter&#x27;</span>,mode=<span class="string">&#x27;system&#x27;</span>&#125;[1m])</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240927105526235.png" alt="image-20240927105526235"></p><p>6ã€topkå‡½æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">topkå‡½æ•°:</span><br><span class="line">    å–topæ¦œçš„å‰nåã€‚å®é™…ä½¿ç”¨çš„æ—¶å€™ä¸€èˆ¬ä¼šç”¨è¯¥å‡½æ•°è¿›è¡Œç¬æ—¶æŠ¥è­¦ï¼Œè€Œä¸æ˜¯ä¸ºäº†è§‚å¯Ÿæ›²çº¿å›¾ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸¾ä¸ªä¾‹å­:</span></span><br><span class="line">     topk(3,rate(node_cpu_seconds_total[1m])):</span><br><span class="line">è·å–CPUæ€»ä½¿ç”¨æ—¶é—´åœ¨1åˆ†é’Ÿå†…çš„å¢åŠ çš„æ€»é‡å¹¶é™¤ä»¥60ç§’ï¼Œè®¡ç®—çš„æ˜¯æ¯ç§’çš„æ•°é‡ã€‚å¹¶åªæŸ¥çœ‹top3ã€‚</span><br><span class="line"></span><br><span class="line">æ¸©é¦¨æç¤º:</span><br><span class="line">æˆ‘ä»¬é€šå¸¸ä½¿ç”¨topkåªä¼šå…³æ³¨<span class="string">&quot;Console&quot;</span>ä¸­çš„ç¬æ—¶ç»“æœï¼Œä¸å¤ªä¼šå…³å¿ƒGraphçš„å‡ºå›¾æ•ˆæœï¼Œå› ä¸ºå…³æ³¨ä»–å¹¶æ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œå­˜åœ¨å¤ªå¤šçš„æ–­ç‚¹å•¦ï¼</span><br><span class="line">å¦‚æœå‡ºå›¾ä¼šå‡ºç°ä¸­æ–­çš„æƒ…å†µï¼Œæ˜¯å› ä¸ºåœ¨xxåˆ†é’Ÿå†…è¿™ä¸€åˆ»çš„æ•°æ®å…¶å¹¶æ²¡æœ‰æ’è¿›top3ï¼Œè‡ªç„¶å°±ä¼šå‡ºç°æ–­ç‚¹çš„çŠ¶å†µ</span><br><span class="line"></span><br><span class="line">topk(10,rate(node_cpu_seconds_total&#123;agent=<span class="string">&#x27;node_exporter&#x27;</span>&#125;[1m]))</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240927161431883.png" alt="image-20240927161431883"></p><p>7ã€countå‡½æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">count(container_last_seen&#123;instance=<span class="string">&#x27;10.0.0.201:8080&#x27;</span>,image!=<span class="string">&#x27;&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">countå‡½æ•°:</span><br><span class="line">    æŠŠæ•°å€¼ç¬¦åˆæ¡ä»¶çš„ï¼Œè¾“å‡ºæ•°ç›®è¿›è¡Œç´¯è®¡åŠ å’Œã€‚ä¸€èˆ¬ç”¨å®ƒè¿›è¡Œä¸€äº›æ¨¡ç³Šçš„ç›‘æ§åˆ¤æ–­ã€‚</span><br><span class="line">    æ¯”å¦‚è¯´ä¼ä¸šä¸­æœ‰100å°æœåŠ¡å™¨ï¼Œé‚£ä¹ˆåªæœ‰10å°æœåŠ¡å™¨CPUä½¿ç”¨ç‡é«˜äº80%çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™ä¸éœ€è¦æŠ¥è­¦ï¼Œå½“ç¬¦åˆ80%CPUçš„æœåŠ¡å™¨æ•°é‡è¶…è¿‡70å°çš„æ—¶å€™é‚£ä¹ˆå°±è§¦å‘æŠ¥è­¦ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸¾ä¸ªä¾‹å­:</span></span><br><span class="line">    count(aaa_tcp_wait_conn &gt; 500):</span><br><span class="line">æˆ‘ä»¬å‡è®¾aaa_tcp_wait_connæ˜¯å’±ä»¬è‡ªå®šä¹‰çš„KEYï¼Œä¸Šè¿°æ¡ˆä¾‹æ˜¯æ‰¾å‡ºå½“å‰(æˆ–è€…å†å²çš„)å½“å‰TCPç­‰å¾…æ•°å¤§äº500çš„æœºå™¨æ•°é‡ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç»Ÿè®¡node01ä¸Šæœ‰å¤šå°‘å°å®¹å™¨</span></span><br><span class="line">image!=<span class="string">&#x27;&#x27;</span>  imageä¸ç­‰äºç©ºçš„å°±æ˜¯å®¹å™¨</span><br><span class="line"></span><br><span class="line">countç»Ÿè®¡ä»–æœ‰å¤šå°‘è¡Œ</span><br><span class="line">count(container_last_seen&#123;instance=<span class="string">&#x27;10.0.0.201:8080&#x27;</span>,image!=<span class="string">&#x27;&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240927162241644.png" alt="image-20240927162241644"></p><p><strong>å‡½æ•°ç»ƒä¹ ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">1ã€è®¡ç®—å„èŠ‚ç‚¹çš„CPUçš„æ€»ä½¿ç”¨ç‡ï¼Œå‚è€ƒå…¬å¼:100%-(CPUç©ºé—²æ—¶é—´/æ€»æ—¶é—´)</span><br><span class="line">(1)æˆ‘ä»¬éœ€è¦å…ˆæ‰¾åˆ°æŸ¥çœ‹CPUçš„keyåç§°</span><br><span class="line">node_cpu_seconds_total</span><br><span class="line"></span><br><span class="line">(2)æŒ‰æœºå™¨åˆ†ç»„ï¼Œè®¡ç®—å‡ºæ¯ä¸ªæœºå™¨çš„ç©ºé—²æ—¶é—´</span><br><span class="line"><span class="built_in">sum</span>(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;idle&#x27;</span>&#125;)by(instance)</span><br><span class="line"></span><br><span class="line">(3)æŒ‰æœºå™¨åˆ†ç»„ï¼Œè®¡ç®—å‡ºæ¯ä¸ªæœºå™¨çš„æ€»æ—¶é—´</span><br><span class="line"><span class="built_in">sum</span>(node_cpu_seconds_total) by(instance)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(4)CPUç©ºé—²æ—¶é—´/æ€»æ—¶é—´=ç©ºé—²ç‡</span><br><span class="line"><span class="built_in">sum</span>(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;idle&#x27;</span>&#125;)by(instance)/sum(node_cpu_seconds_total) by(instance)</span><br><span class="line"></span><br><span class="line">(5)æ¯å°æœºå™¨çš„CPUçš„æ€»ä½¿ç”¨ç‡</span><br><span class="line">1-(<span class="built_in">sum</span>(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;idle&#x27;</span>&#125;)by(instance)/sum(node_cpu_seconds_total) by(instance))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€è®¡ç®—ç”¨æˆ·æ€çš„CPUä½¿ç”¨ç‡</span><br><span class="line"><span class="built_in">sum</span>(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;user&#x27;</span>&#125;)by(instance)/sum(node_cpu_seconds_total) by(instance)</span><br><span class="line"></span><br><span class="line">3ã€è®¡ç®—å†…æ ¸æ€çš„CPUä½¿ç”¨ç‡</span><br><span class="line"><span class="built_in">sum</span>(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;system&#x27;</span>&#125;)by(instance)/sum(node_cpu_seconds_total) by(instance)</span><br><span class="line"></span><br><span class="line">4ã€è®¡ç®—IOç­‰å¾…çš„CPUä½¿ç”¨ç‡</span><br><span class="line"><span class="built_in">sum</span>(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;iowait&#x27;</span>&#125;)by(instance)/sum(node_cpu_seconds_total) by(instance)</span><br></pre></td></tr></table></figure><h3 id="7ã€ä½¿ç”¨pushgatewayè‡ªå®šä¹‰ç›‘æ§"><strong>7ã€ä½¿ç”¨pushgatewayè‡ªå®šä¹‰ç›‘æ§</strong></h3><p><strong>pushgatewayä»‹ç»</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨è„šæœ¬ç›‘æ§å°†æ•°æ®æ¨é€åˆ°pushgatewayä¸Šï¼ŒPromethuesä»pushgatewayä¸­æ‹‰å–æ•°æ® (å¯ä»¥æŠŠpushgatewayå½“åˆPrometheusçš„å®¢æˆ·ç«¯ï¼ŒPrometheusä¹Ÿæ˜¯æ‹‰å–æ•°æ®)</span><br><span class="line"></span><br><span class="line">å®ƒæ˜¯å¯ä»¥å•ç‹¬è¿è¡Œåœ¨ä»»ä½•èŠ‚ç‚¹(ä¸ä¸€å®šæ˜¯åœ¨è¢«ç›‘æ§å®¢æˆ·ç«¯)ä¸Šçš„æ’ä»¶ï¼Œç„¶åé€šè¿‡ç”¨æˆ·è‡ªå®šä¹‰å¼€å‘è„šæœ¬æŠŠéœ€è¦ç›‘æ§çš„æ•°æ®å‘é€ç»™pushgatewayï¼Œå†ç”±pushgatewayæš´éœ²httpæ¥å£,è€Œåç”±æŠŠprometheus serverå»pullæ•°æ®ã€‚</span><br><span class="line"></span><br><span class="line">pushgatewayç»„ä»¶æœ¬èº«æ˜¯æ²¡æœ‰ä»»ä½•æŠ“å–ç›‘æ§æ•°æ®åŠŸèƒ½çš„ï¼Œå®ƒåªèƒ½è¢«åŠ¨çš„ç­‰å¾…ç›‘æ§æ•°æ®è¢«æ¨é€è¿‡æ¥ã€‚</span><br></pre></td></tr></table></figure><p><strong>Prometheuså…³è”pushgateway</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ–¹æ³•ä¸€ï¼šä¿®æ”¹Prometheusé…ç½®æ–‡ä»¶</span></span><br><span class="line">[root@master01 prometheus]# vim prometheus.yml</span><br><span class="line">scrape_configs:</span><br><span class="line">.....</span><br><span class="line"><span class="comment">#æ·»åŠ è‡ªåŠ¨å‘ç°è§„åˆ™</span></span><br><span class="line"> - job_name: <span class="string">&quot;prome_file_sd&quot;</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /app/prometheus/file_sd/agent.yml</span><br><span class="line">      refresh_interval: 5s</span><br><span class="line"></span><br><span class="line">2ã€é‡å¯Prometheus</span><br><span class="line">[root@master01 prometheus]# supervisorctl restart all</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–¹æ³•äºŒï¼šç¼–è¾‘æ–‡ä»¶å‘ç°çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line">ä»¥åå¯èƒ½åƒpushgatewayä¹Ÿè¦åŠ è¿›æ¥</span><br><span class="line">[root@master01 prometheus]# vim /app/prometheus/file_sd/agent.yml</span><br><span class="line">[</span><br><span class="line">.....</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="string">&quot;targets&quot;</span>:  [<span class="string">&quot;10.0.0.200:9091&quot;</span>],</span><br><span class="line">    <span class="string">&quot;labels&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;agent&quot;</span>: <span class="string">&quot;pushgateway&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line">      </span><br><span class="line"><span class="comment">#ä¸éœ€è¦é‡å¯</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240930182759622.png" alt="image-20240930182759622"></p><p><strong>pushgatewayçš„ä¼˜ç¼ºç‚¹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pushgatewayé»˜è®¤ä¼šæœ‰ä¸€äº›æ•°æ®ï¼Œå¹¶ä¸å¤šï¼Œä¸»è¦æ˜¯è‡ªå®šä¹‰ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰æ•°æ®è¦å†™è„šæœ¬ï¼Œåªè¦èƒ½å†™è„šæœ¬è·å–åˆ°çš„æ•°æ®éƒ½å¯ä»¥ç›‘æ§</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¼˜ç‚¹:</span></span><br><span class="line">çµæ´»æ€§æ›´å¼ºã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¼ºç‚¹:</span></span><br><span class="line">(1)å­˜åœ¨å•ç‚¹ç“¶é¢ˆï¼Œå‡å¦‚æœ‰å¤šä¸ªè„šæœ¬åŒæ—¶å‘ç»™ä¸€ä¸ªpushgatewayè¿›ç¨‹ï¼Œå¦‚æœè¯¥pushgatewayè¿›ç¨‹æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆç›‘æ§æ•°æ®ä¹Ÿå°±æ²¡äº†ã€‚</span><br><span class="line">(2)pushgatewayå¹¶ä¸èƒ½å¯¹å‘é€è¿‡æ¥çš„è„šæœ¬é‡‡é›†æ•°æ®è¿›è¡Œæ›´æ™ºèƒ½çš„åˆ¤æ–­ï¼Œå‡å¦‚è„šæœ¬ä¸­é—´é‡‡é›†å‡ºäº†é—®é¢˜ï¼Œé‚£ä¹ˆæœ‰é—®é¢˜çš„æ•°æ®pushgatewayç»„ä»¶ä¼šç…§å•å…¨æ”¶å‘é€ç»™Prometheus serverã€‚(ä¹Ÿå°±æ˜¯è¯´ä»–ä¸èƒ½åšåˆ¤æ–­ï¼Œæ”¶é›†åˆ°å•¥å°±ä¼ å•¥ï¼Œæ‰€ä»¥å†™çš„è„šæœ¬ä¸€å®šè¦ç²¾ç¡®)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ¸©é¦¨æç¤º:</span><br><span class="line">å¯¹äºç¼ºç‚¹ä¸€ï¼Œå»ºè®®å¤§å®¶åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¤šå¼€å¯å‡ ä¸ªpushgatewayè¿›ç¨‹ï¼Œå‰é¢åŠ ä¸ªè´Ÿè½½å‡è¡¡ï¼Œä»¥ä¾¿äºå¤‡ä»½ä½¿ç”¨ã€‚</span><br><span class="line">å¦‚æœä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼Œé…ç½®æ–‡ä»¶çš„å†™æ³•æ˜¯ï¼š</span><br><span class="line">[root@master01 prometheus]# vim /app/prometheus/file_sd/agent.yml</span><br><span class="line">[</span><br><span class="line">.....</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="string">&quot;targets&quot;</span>:  [<span class="string">&quot;ç”¨åŸŸåæˆ–è€…è´Ÿè½½å‡è¡¡çš„ip:9091&quot;</span>],</span><br><span class="line">    <span class="string">&quot;labels&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;agent&quot;</span>: <span class="string">&quot;pushgateway&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line">å¯¹äºç¼ºç‚¹äºŒï¼Œå»ºè®®å¤§å®¶åœ¨ç¼–å†™è„šæœ¬æ—¶è¦æ³¨æ„ä¸šåŠ¡é€»è¾‘ï¼Œå°½å¯èƒ½é¿å…è„šæœ¬å‡ºé”™çš„æƒ…å†µå‘ç”Ÿã€‚</span><br></pre></td></tr></table></figure><p><strong>å•ä¸ªæ•°æ®è‡ªå®šä¹‰ç›‘æ§â€”â€”ç”¨æˆ·ç™»å½•æ•°é‡</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#é¦–å…ˆä½ æƒ³ç›‘æ§å“ªå°æœºå™¨ï¼Œå°±æŠŠè„šæœ¬å†™åœ¨å“ªä¸ªæœºå™¨ä¸Š</span></span><br><span class="line"></span><br><span class="line">1ã€ç¼–å†™è‡ªå®šä¹‰ç›‘æ§â€”â€”ç”¨æˆ·ç™»å½•æ•°é‡çš„è„šæœ¬</span><br><span class="line">[root@node03 ~]# vim user_count.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#è·å–ä¸»æœºåhostname -sçŸ­çš„ä¸»æœºå  hostnameé•¿çš„ä¸»æœºå</span></span><br><span class="line">INSTANCE_NAME=$(hostname -s)</span><br><span class="line"><span class="comment">#åˆ¤æ–­å¦‚æœæ˜¯æ²¡æœ‰ä¿®æ”¹ä¸»æœºåå°±æŠ¥é”™</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$INSTANCE_NAME</span>&quot;</span> == <span class="string">&quot;localhost&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;å¿…é¡»è¦å®Œæ•´çš„ä¸»æœºå&quot;</span></span><br><span class="line">   <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å®šä¹‰PrometheusæŠ“å–åˆ°çš„ç›‘æ§é¡¹çš„keyåå­—ï¼Œ</span></span><br><span class="line">METRICS_NAME=<span class="string">&quot;user_count&quot;</span></span><br><span class="line"><span class="comment">#è·å–ç”¨æˆ·çš„ç™»å½•æ•°é‡(ç›‘æ§é¡¹çš„å€¼çš„è·å–)</span></span><br><span class="line">USER_COUNT_VALUE=$(<span class="built_in">uptime</span> |grep -Po <span class="string">&#x27;[0-9]+(?= user)&#x27;</span>)</span><br><span class="line"><span class="comment">#å‘é€æ•°æ®  æŠŠechoçš„å†…å®¹äº¤ç»™curl --data-binary å‘é€äºŒè¿›åˆ¶çš„æ•°æ®,åé¢çš„è·¯å¾„å¯ä»¥è‡ªå®šä¹‰</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$METRICS_NAME</span> <span class="variable">$USER_COUNT_VALUE</span>&quot;</span> |curl --data-binary @- http://10.0.0.200:9091/metrics/job/sh_job/instance/<span class="variable">$INSTANCE_NAME</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€æ‰§è¡Œè„šæœ¬</span><br><span class="line">[root@node03 ~]# sh user_count.sh</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹é¡µé¢</span><br><span class="line">10.0.0.200:9091</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240930202019536.png" alt="image-20240930202019536"></p><p>é¦–å…ˆå›¾ä¸­çš„æ•°æ®ç±»å‹æ˜¯ UNTYPED æˆ‘å¹¶æ²¡æœ‰å®šä¹‰æ•°æ®ç±»å‹çš„,æŸ¥çœ‹æ•°æ®æŒ‡æ ‡10.0.0.200:9091/metricï¼Œä»–è‡ªå·±åŠ çš„untype</p><p><img src="../image/study_img/image-20240930203034740.png" alt="image-20240930203034740"></p><p>PrometheusæŸ¥çœ‹æ•°æ®</p><p><img src="../image/study_img/image-20240930202427231.png" alt="image-20240930202427231"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">user_count&#123;agent=<span class="string">&quot;pushgateway&quot;</span>, exported_instance=<span class="string">&quot;node03&quot;</span>, exported_job=<span class="string">&quot;sh_job&quot;</span>, instance=<span class="string">&quot;10.0.0.200:9091&quot;</span>, job=<span class="string">&quot;prome_file_sd&quot;</span>&#125;   æ˜¾ç¤ºçš„ç»“æœæ˜¯è‡ªå®šä¹‰çš„</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ä¸Šé¢æåˆ°è¿‡</span><br><span class="line"><span class="comment">#æŒ‡æ ‡æ•°æ®æ ¼å¼å°±æ˜¯å¦‚ä¸‹ï¼š</span></span><br><span class="line">1ã€è¦æœ‰ä¸€è¡Œæè¿°</span><br><span class="line">2ã€è¦æœ‰ä¸€è¡ŒæŒ‡æ ‡ç±»å‹å®šä¹‰</span><br><span class="line">3ã€çœŸå®æ•°æ®(æ•°æ®æ ¼å¼æ˜¯Key value)</span><br><span class="line"><span class="comment">#æ•°æ®æè¿°</span></span><br><span class="line"><span class="comment"># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.</span></span><br><span class="line"><span class="comment">#æ•°æ®ç±»å‹ (æŒ‡æ ‡ç±»å‹)</span></span><br><span class="line"><span class="comment"># TYPE keyåå­— counter</span></span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125; 335802.19</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€ä¿®æ”¹è„šæœ¬ï¼Œå®šä¹‰æ•°æ®ç±»å‹,å¹¶åŠ ä¸Šå¾ªç¯</span><br><span class="line">[root@node03 ~]# vim user_count.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line">  <span class="comment">#è·å–ä¸»æœºåhostname -sçŸ­çš„ä¸»æœºå  hostnameé•¿çš„ä¸»æœºå</span></span><br><span class="line">  INSTANCE_NAME=$(hostname -s)</span><br><span class="line">  <span class="comment">#åˆ¤æ–­å¦‚æœæ˜¯æ²¡æœ‰ä¿®æ”¹ä¸»æœºåå°±æŠ¥é”™</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$INSTANCE_NAME</span>&quot;</span> == <span class="string">&quot;localhost&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;å¿…é¡»è¦å®Œæ•´çš„ä¸»æœºå&quot;</span></span><br><span class="line">     <span class="built_in">exit</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#å®šä¹‰PrometheusæŠ“å–åˆ°çš„ç›‘æ§é¡¹çš„keyåå­—ï¼Œ</span></span><br><span class="line">  METRICS_NAME=<span class="string">&quot;user_count&quot;</span></span><br><span class="line">  <span class="comment">#è·å–ç”¨æˆ·çš„ç™»å½•æ•°é‡(ç›‘æ§é¡¹çš„å€¼çš„è·å–)</span></span><br><span class="line">  USER_COUNT_VALUE=$(<span class="built_in">uptime</span> |grep -Po <span class="string">&#x27;[0-9]+(?= user)&#x27;</span>)</span><br><span class="line">  <span class="comment">#å‘é€æ•°æ®  æŠŠechoçš„å†…å®¹äº¤ç»™curl --data-binary å‘é€äºŒè¿›åˆ¶çš„æ•°æ®,åé¢çš„è·¯å¾„å¯ä»¥è‡ªå®šä¹‰ \nå›è½¦  gaugeï¼šç¬æ—¶å€¼ï¼Œå½“å‰æœ€æ–°çš„å€¼</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">&quot;# TYPE <span class="variable">$&#123;METRICS_NAME&#125;</span> gauge\n<span class="variable">$METRICS_NAME</span> <span class="variable">$USER_COUNT_VALUE</span>&quot;</span> |curl --data-binary @- http://10.0.0.200:9091/metrics/job/sh_job/instance/<span class="variable">$INSTANCE_NAME</span></span><br><span class="line">  <span class="built_in">sleep</span> 1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€ç”±äºè„šæœ¬é‡Œé¢å†™äº†æ­»å¾ªç¯ï¼Œä¸èƒ½ç›´æ¥æ‰§è¡Œè„šæœ¬ï¼Œå¯ä»¥ç”¨supervisorå»ç®¡ç†</span><br><span class="line">ä»¥åæ‰€ä»¥å¾—ç›‘æ§è„šæœ¬éƒ½å¯ä»¥æ”¾è¿™é‡Œï¼Œæ‰€æœ‰çš„ç›‘æ§é¡¹éƒ½å¯ä»¥èµ·æ¥</span><br><span class="line">[root@node03 ~]# vim /etc/supervisord.d/push.ini </span><br><span class="line">[program:user_count]</span><br><span class="line"><span class="comment">#è¿™é‡Œå»ºè®®è„šæœ¬å»ºä¸€ä¸ªç›®å½•å­˜æ”¾</span></span><br><span class="line">directory=/root</span><br><span class="line"><span class="built_in">command</span>=/bin/bash -c <span class="string">&quot;/bin/sh /root/user_count.sh&quot;</span></span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">stdout_logfile=/var/log/node_exporter_stdout.log</span><br><span class="line">stderr_logfile=/var/log/node_exporter_stderr.log</span><br><span class="line">user=root</span><br><span class="line">stopsignal=TERM</span><br><span class="line">startsecs=5</span><br><span class="line">startretries=3</span><br><span class="line">stopasgroup=<span class="literal">true</span></span><br><span class="line">killasgroup=<span class="literal">true</span></span><br><span class="line">[root@node03 ~]# supervisorctl update</span><br><span class="line">[root@node03 ~]# supervisorctl restart all</span><br><span class="line">[root@node03 ~]# supervisorctl status</span><br><span class="line">node_exporter                    RUNNING   pid 8440, <span class="built_in">uptime</span> 1 day, 12:35:41</span><br><span class="line">user_count                       RUNNING   pid 107360, <span class="built_in">uptime</span> 0:02:39</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6ã€éªŒè¯æ˜¯å¦è¿è¡Œ</span><br><span class="line">å¤šå¼€å‡ ä¸ªç»ˆç«¯ï¼Œå»Prometheusé‡Œé¢æŸ¥è¯¢æ•°æ®</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240930212805096.png" alt="image-20240930212805096"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å‘½ä»¤è¡Œç®€å†ç›‘æ§æ•°æ®</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;# TYPE keyåå­— gauge\nkeyåå­— value&quot;</span> |curl --data-binary @- http://10.0.0.200:9091/metrics/job/é¡¹ç›®å/instance/ä¸»æœºå</span><br><span class="line"></span><br><span class="line">[root@node03 ~]# <span class="built_in">echo</span> -e <span class="string">&quot;# TYPE aaa gauge\naaa 111&quot;</span> |curl --data-binary @- http://10.0.0.200:9091/metrics/job/aaa/instance/node03</span><br><span class="line"></span><br><span class="line">æ•°æ®æŒ‡æ ‡ä¸­å°±ä¼šç”Ÿæˆaaaçš„key</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240930224338728.png" alt="image-20240930224338728"></p><p><img src="../image/study_img/image-20240930224429624.png" alt="image-20240930224429624"></p><p><strong>å¤šä¸ªæ•°æ®è‡ªå®šä¹‰ç›‘æ§â€”â€”ç›‘æ§å®¹å™¨è¿è¡Œæ—¶é—´</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">è·å–cadvisorçš„è¿è¡Œæ—¶é—´</span><br><span class="line">[root@node03 ~]# docker inspect -f <span class="string">&#x27;&#123;&#123;.State.StartedAt&#125;&#125;&#x27;</span> cadvisor</span><br><span class="line">2024-09-30T10:06:13.136629499Z</span><br><span class="line">[root@node03 ~]# docker inspect -f <span class="string">&#x27;&#123;&#123;.State.StartedAt&#125;&#125;&#x27;</span> cadvisor</span><br><span class="line">2024-09-30T10:06:13.136629499Z</span><br><span class="line">[root@node03 ~]# docker inspect -f <span class="string">&#x27;&#123;&#123;.State.StartedAt&#125;&#125;&#x27;</span> cadvisor</span><br><span class="line">2024-09-30T10:06:13.136629499Z</span><br><span class="line">[root@node03 ~]# <span class="built_in">date</span> +%s -d 2024-09-30T10:06:13.136629499Z</span><br><span class="line">1727690773</span><br><span class="line">[root@node03 ~]# <span class="built_in">date</span> +%s </span><br><span class="line">1727708230</span><br><span class="line">[root@node03 ~]# <span class="built_in">let</span> res=1727708230-1727690773</span><br><span class="line">[root@node03 ~]# <span class="built_in">echo</span> <span class="variable">$res</span></span><br><span class="line">17457</span><br><span class="line">[root@node03 ~]# python</span><br><span class="line">&gt;&gt;&gt; 17457/60/60</span><br><span class="line">4</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span><span class="string">&quot;# TYPE <span class="variable">$&#123;metrics_name&#125;</span> gauge  </span></span><br><span class="line"><span class="string"># HELP <span class="variable">$&#123;metrics_name&#125;</span> time sec&quot;</span><span class="string">&quot;&quot;</span> &gt; docker_temp.log</span><br><span class="line"></span><br><span class="line">1ã€ç¼–å†™å¤šä¸ªæ•°æ®è‡ªå®šä¹‰ç›‘æ§â€”â€”ç›‘æ§å®¹å™¨è¿è¡Œæ—¶é—´çš„è„šæœ¬</span><br><span class="line">[root@node03 ~]# vim runtime.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line"><span class="comment">#è·å–ä¸»æœºåhostname -sçŸ­çš„ä¸»æœºå  hostnameé•¿çš„ä¸»æœºå</span></span><br><span class="line">instance_name=$(hostname -s)</span><br><span class="line">metrics_name=docker_runtime</span><br><span class="line"><span class="comment">#åˆ¤æ–­å¦‚æœæ˜¯æ²¡æœ‰ä¿®æ”¹ä¸»æœºåå°±æŠ¥é”™</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$instance_name</span>&quot;</span> == <span class="string">&quot;localhost&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;å¿…é¡»è¦å®Œæ•´çš„ä¸»æœºå&quot;</span></span><br><span class="line">   <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è·å–æ‰€ä»¥è¿è¡Œå®¹å™¨çš„åç§° &#123;&#123;.Names&#125;&#125;ç›¸å½“äºé‡‘ç”²æ¨¡ç‰ˆçš„è°ƒç”¨å˜é‡</span></span><br><span class="line">allname=$(docker ps --format <span class="string">&quot;&#123;&#123;.Names&#125;&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">docker_run</span></span>()&#123;</span><br><span class="line">      <span class="comment">#è·å–å„ä¸ªå®¹å™¨çš„å¯åŠ¨æ—¶é—´</span></span><br><span class="line">      start_time=$(docker inspect -f <span class="string">&#x27;&#123;&#123;.State.StartedAt&#125;&#125;&#x27;</span> <span class="variable">$1</span>)</span><br><span class="line">      <span class="comment">#å°†æ—¶é—´è½¬æ¢ä½æ—¶é—´æˆ³</span></span><br><span class="line">      time1=$(<span class="built_in">date</span> +%s -d <span class="string">&quot;<span class="variable">$start_time</span>&quot;</span>)</span><br><span class="line">      <span class="comment">#è·å–å½“å‰çš„æ—¶é—´æˆ³</span></span><br><span class="line">      time2=$(<span class="built_in">date</span> +%s)</span><br><span class="line">      <span class="comment">#è®¡ç®—è¿è¡Œæ—¶é—´</span></span><br><span class="line">      <span class="built_in">let</span> tt=<span class="variable">$time2</span>-<span class="variable">$time1</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="variable">$tt</span></span><br><span class="line">      <span class="built_in">return</span> <span class="variable">$tt</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†éœ€è¦å¾€pushgatewayä¸Šä¼ çš„æ•°æ®å†™å…¥&quot;docker_temp.log&quot;æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;# TYPE <span class="variable">$&#123;metrics_name&#125;</span> gauge&quot;</span> &gt; docker_temp.log  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;# HELP <span class="variable">$&#123;metrics_name&#125;</span> time sec&quot;</span> &gt;&gt; docker_temp.log</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;allname&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    start_time=$(docker_run <span class="variable">$i</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$metrics_name</span>&#123;name=\&quot;<span class="variable">$i</span>\&quot;,aaa=\&quot;xxx\&quot;&#125; <span class="variable">$start_time</span>&quot;</span> &gt;&gt;  docker_temp.log <span class="comment"># æ ¼å¼åŒ–å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹åœ°å€å’Œå‚æ•°åå‘ç‰¹å®šçš„urlä¸Šä¼ æ•°æ®ï¼Œæ•°æ®åœ¨doceker_temp.logæ–‡ä»¶ä¸­</span></span><br><span class="line"><span class="comment">#curl äºŒè¿›åˆ¶ @æ–‡ä»¶å æŠŠä¸ªæ–‡ä»¶é‡Œé¢çš„å†…å®¹äº¤ç»™åé¢çš„url</span></span><br><span class="line">curl --data-binary <span class="string">&quot;@docker_temp.log&quot;</span> http://10.0.0.200:9091/metrics/job/docker_runtime/instance/<span class="variable">$instance_name</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æƒ…å†µä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line"><span class="comment">#rm -rf docker_temp.log</span></span><br><span class="line"><span class="built_in">sleep</span> 1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">2ã€å°†è„šæœ¬åŠ å…¥supervisor</span><br><span class="line">[root@node03 ~]# vim /etc/supervisord.d/push.ini </span><br><span class="line">[program:docker_runtime]</span><br><span class="line">directory=/root</span><br><span class="line"><span class="built_in">command</span>=/bin/bash -c <span class="string">&quot;/bin/sh /root/runtime.sh&quot;</span></span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">stdout_logfile=/var/log/node_exporter_stdout.log</span><br><span class="line">stderr_logfile=/var/log/node_exporter_stderr.log</span><br><span class="line">user=root</span><br><span class="line">stopsignal=TERM</span><br><span class="line">startsecs=5</span><br><span class="line">startretries=3</span><br><span class="line">stopasgroup=<span class="literal">true</span></span><br><span class="line">killasgroup=<span class="literal">true</span></span><br><span class="line">[root@node03 ~]# supervisorctl update</span><br><span class="line">[root@node03 ~]# supervisorctl status</span><br><span class="line">docker_runtime                   RUNNING   pid 29434, <span class="built_in">uptime</span> 0:00:07</span><br><span class="line">node_exporter                    RUNNING   pid 8372, <span class="built_in">uptime</span> 5:48:45</span><br><span class="line">user_count                       RUNNING   pid 8374, <span class="built_in">uptime</span> 5:48:45</span><br><span class="line"></span><br><span class="line">3ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.200:9091          10.0.0.200:9091/metrics</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20241001220001771.png" alt="image-20241001220001771"></p><p><img src="../image/study_img/image-20241001220252497.png" alt="image-20241001220252497"></p><p>PrometheusæŸ¥çœ‹æ•°æ®</p><p><img src="../image/study_img/image-20241001220418085.png" alt="image-20241001220418085"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">éªŒè¯æ²¡é—®é¢˜ä¹‹åï¼ŒæŠŠè„šæœ¬å‘é€ç»™å…¶ä»–nodeèŠ‚ç‚¹ï¼Œå¹¶æ‰§è¡Œï¼Œå°±å¯ä»¥è·å–åˆ°æ•°æ®äº†</span><br></pre></td></tr></table></figure><p><strong>ç›‘æ§å†…å­˜ä½¿ç”¨ç‡    (è¿™ä¸ªæ˜¯è‡ªå¸¦çš„ï¼Œä¸éœ€è¦å†™è„šæœ¬ï¼Œç›´æ¥å¯ä»¥æŸ¥å‡ºæ¥)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å‚è€ƒæ¡ˆä¾‹:</span><br><span class="line">(1 - (node_memory_Buffers_bytes + node_memory_Cached_bytes + node_memory_MemFree_bytes) / node_memory_MemTotal_bytes) * 100</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20241001223311889.png" alt="image-20241001223311889"></p><p><strong>ç›‘æ§ç¡¬ç›˜çš„ä½¿ç”¨æƒ…å†µ    (è¿™ä¸ªæ˜¯è‡ªå¸¦çš„ï¼Œä¸éœ€è¦å†™è„šæœ¬ï¼Œç›´æ¥å¯ä»¥æŸ¥å‡ºæ¥)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å‚è€ƒæ¡ˆä¾‹:</span><br><span class="line">(node_filesystem_free_bytes / node_filesystem_size_bytes) &lt; 0.95</span><br><span class="line"></span><br><span class="line">æ¸©é¦¨æç¤º:</span><br><span class="line">(1)ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®å¤§å®¶å°†0.95æ”¹ä¸º0.20ï¼Œè¡¨ç¤ºå½“ç©ºé—²ç¡¬ç›˜å°äº20%çš„æ—¶å€™å°±æ˜¾ç¤ºåœ¨å›¾ä¸Š;</span><br><span class="line">(2)æˆ‘ä¹‹æ‰€ä»¥å†™0.95æ˜¯å› ä¸ºæˆ‘çš„ç©ºé—²ç¡¬ç›˜æŒºå¤§çš„ï¼Œä¸ºäº†è®©å¤§å®¶çœ‹åˆ°å‡ºå›¾çš„æ•ˆæœè€Œå·²ã€‚</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20241001223441812.png" alt="image-20241001223441812"></p><p><strong>ç›‘æ§ç¡¬ç›˜I/Oä½¿ç”¨æƒ…å†µ  (è¿™ä¸ªæ˜¯è‡ªå¸¦çš„ï¼Œä¸éœ€è¦å†™è„šæœ¬ï¼Œç›´æ¥å¯ä»¥æŸ¥å‡ºæ¥)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å‚è€ƒæ¡ˆä¾‹:</span><br><span class="line">rate(node_network_transmit_bytes_total[1m]) / 1024 / 1024</span><br><span class="line"></span><br><span class="line">node_network_transmit_bytes_total:</span><br><span class="line">ç½‘ç»œä¼ è¾“å­—èŠ‚æ•°ã€‚</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20241001223636224.png" alt="image-20241001223636224"></p><p><strong>ç›‘æ§æ–‡ä»¶æè¿°ç¬¦</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">å‚è€ƒæ¡ˆä¾‹:</span><br><span class="line">(node_filefd_allocated / node_filefd_maximum) * 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">node_filefd_allocated:</span><br><span class="line">å·²åˆ†é…çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">node_filefd_maximum:</span><br><span class="line">ä¸€ä¸ªè¿›ç¨‹è¿è¡Œæœ€å¤§æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„æ€»é‡ã€‚</span><br><span class="line"></span><br><span class="line">(1)ç¼–å†™è„šæœ¬</span><br><span class="line">[root@docker201 ~]# vim network_delay.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#instance_name=`hostname -i` # è¯¥æŒ‡ä»¤è¦æ±‚hostsæ–‡ä»¶å¿…é¡»æœ‰è§£æ</span></span><br><span class="line">instance_name=$(hostname -s) </span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦æ±‚æœºå™¨åä¸èƒ½æ˜¯&quot;localhost&quot;ä¸ç„¶æ ‡ç­¾å°±æ²¡æœ‰åŒºåˆ†äº†</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$instance_name</span> == <span class="string">&quot;localhost&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Must FQDN hostname&quot;</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šéœ€è¦pingçš„ä¸»æœº</span></span><br><span class="line">monitoring_site=<span class="string">&quot;www.aaa.com&quot;</span></span><br><span class="line"><span class="comment"># è·å–ä¸¢åŒ…ç‡ç›¸å…³å­—æ®µ</span></span><br><span class="line"><span class="comment"># -q:</span></span><br><span class="line"><span class="comment"># å®‰é™æ¨¡å¼pingï¼Œå³ä¸è¾“å‡ºæ¯æ¬¡pingçš„è¿”å›çš„ä¸­é—´ç»“æœï¼Œä»…è¿”å›æœ€ç»ˆçš„ç»“æœã€‚</span></span><br><span class="line"><span class="comment"># -A:</span></span><br><span class="line"><span class="comment"># å¯ç”¨å¹¶è¡Œçš„pingæ•ˆæœï¼Œå¯ä»¥åŠ å¿«pingçš„å¤„ç†è¿‡ç¨‹ã€‚</span></span><br><span class="line"><span class="comment"># -s:</span></span><br><span class="line"><span class="comment"># ä¸€ä¸ªpingåŒ…çš„å¤§å°ã€‚</span></span><br><span class="line"><span class="comment"># -W:</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œpingå‘½ä»¤æœ€å¤§çš„å»¶è¿Ÿç­‰å¾…æ—¶é—´(timeout),ä»¥msä¸ºå•ä½ã€‚</span></span><br><span class="line"><span class="comment"># -c:</span></span><br><span class="line"><span class="comment"># å‘é€å¤šå°‘ä¸ªæ•°æ®åŒ…ã€‚</span></span><br><span class="line">package_loss_rate=`<span class="built_in">timeout</span> 5 ping -q -A -s 500 -W 1000 -c 100 <span class="variable">$monitoring_site</span> |</span><br><span class="line">grep transmitted | awk <span class="string">&#x27;&#123;print $6&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å»¶è¿Ÿæƒ…å†µçš„ç›¸å…³å­—æ®µ(æœ¬è´¨ä¸Šæ˜¯æ‰§è¡Œpingå‘½ä»¤æ‰€è€—è´¹çš„æ—¶é—´å“Ÿ~)</span></span><br><span class="line">delay_time=`<span class="built_in">timeout</span> 5 ping -q -A -s 500 -W 1000 -c 100 <span class="variable">$monitoring_site</span> | grep transmitted | awk <span class="string">&#x27;&#123;print $10&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æ•°å­—ç±»å‹</span></span><br><span class="line">package_loss_rate_number=`<span class="built_in">echo</span> <span class="variable">$package_loss_rate</span> | sed <span class="string">&quot;s/%//g&quot;</span>`</span><br><span class="line">delay_time_number=`<span class="built_in">echo</span> <span class="variable">$delay_time</span> | sed <span class="string">&quot;s/ms//g&quot;</span>`</span><br><span class="line"><span class="comment"># å°†æ•°æ®ä¸Šä¼ åˆ°pushgateway</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;sh_linux_package_loss_rate_<span class="variable">$instance_name</span> <span class="variable">$package_loss_rate_number</span>&quot;</span> | curl --data-binary @-</span><br><span class="line">http://docker201.zls.com:9091/metrics/job/zls_linux_package_loss_rate/instance/localhost:9092</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;sh_linux_delay_time_<span class="variable">$instance_name</span> <span class="variable">$delay_time_number</span>&quot;</span> | curl --data-binary @- http://docker201.zls.com:9091/metrics/job/zls_linux_package_loss_rate/instance/localhost:9092</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(2)ç¼–å†™å‘¨æœŸæ€§ä»»åŠ¡</span><br><span class="line">[root@docker201~]# crontab -l</span><br><span class="line">...</span><br><span class="line">*/10 * * * * /root/network_delay.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(3)åœ¨Prometheus serverä¸­æŸ¥çœ‹KEY</span><br><span class="line">sh_linux_package_loss_rate_docker201</span><br><span class="line">sh_linux_delay_time_docker201</span><br><span class="line">æ¸©é¦¨æç¤º:</span><br><span class="line">(1)å¯¹äºè¾ƒå¤šçš„ç½‘ç»œç›‘æ§æˆ‘å»ºè®®è¿˜æ˜¯ä½¿ç”¨ä¸“ä¸šçš„smokepingç›‘æ§ç³»ç»Ÿï¼Œå°¤å…¶æ˜¯åœ¨IDCå…¬å¸ï¼ŒsmokepingåŸºæœ¬ä¸Šæ˜¯å¿…ç”¨è½¯ä»¶å“Ÿã€‚</span><br></pre></td></tr></table></figure><h3 id="8ã€ä½¿ç”¨alertmanagerå‘Šè­¦"><strong>8ã€ä½¿ç”¨alertmanagerå‘Šè­¦</strong></h3><p>1ã€ä¿®æ”¹é…ç½®æ–‡ä»¶(é…ç½®æŠ¥è­¦åª’ä»‹ç±»å‹)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">1ã€å…ˆåœæ‰alertmanager</span><br><span class="line">[root@master01 kubernetes]# supervisorctl stop alertmanager</span><br><span class="line"></span><br><span class="line">2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œé…ç½®æŠ¥è­¦åª’ä»‹ç±»å‹</span><br><span class="line">[root@master01 kubernetes]# vim /app/alertmanager/alertmanager.yml </span><br><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line">  smtp_from: <span class="string">&#x27;xxx@qq.com&#x27;</span></span><br><span class="line">  smtp_smarthost: <span class="string">&#x27;smtp.qq.com:465&#x27;</span></span><br><span class="line">  smtp_auth_username: <span class="string">&#x27;xxxx@qq.com&#x27;</span></span><br><span class="line">  smtp_auth_password: <span class="string">&#x27;xxxgreaga&#x27;</span></span><br><span class="line">  smtp_require_tls: <span class="literal">false</span></span><br><span class="line">  smtp_hello: <span class="string">&#x27;qq.com&#x27;</span></span><br><span class="line">route:</span><br><span class="line">  group_by: [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">  group_wait: 5s</span><br><span class="line">  group_interval: 5s</span><br><span class="line">  repeat_interval: 5m</span><br><span class="line">  receiver: <span class="string">&#x27;email&#x27;</span></span><br><span class="line">receivers:</span><br><span class="line">- name: <span class="string">&#x27;email&#x27;</span></span><br><span class="line">  email_configs:</span><br><span class="line">  - to: <span class="string">&#x27;xxx85@qq.com&#x27;</span></span><br><span class="line">    send_resolved: <span class="literal">true</span></span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">    target_match:</span><br><span class="line">      severity: <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">    equal: [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;dev&#x27;</span>, <span class="string">&#x27;instance&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">ç›¸å…³å‚æ•°è¯´æ˜    </span><br><span class="line">global:</span><br><span class="line"><span class="comment">#è§£æè¶…æ—¶æ—¶é—´</span></span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line">  <span class="comment">#å‘ä»¶äººé‚®ç®±åœ°å€</span></span><br><span class="line">  smtp_from: <span class="string">&#x27;xxxxxxxx@qq.com&#x27;</span></span><br><span class="line">  <span class="comment">#é‚®ç®±çš„æœåŠ¡å™¨çš„åœ°å€åŠç«¯å£ï¼Œä¾‹å¦‚: &#x27;smtp.qq.com:465&#x27;</span></span><br><span class="line">  smtp_smarthost: <span class="string">&#x27;smtp.qq.com:465&#x27;</span></span><br><span class="line">  <span class="comment">#å‘é€äººçš„é‚®ç®±ç”¨æˆ·å</span></span><br><span class="line">  smtp_auth_username: <span class="string">&#x27;xxxxxxxx@qq.com&#x27;</span></span><br><span class="line">  <span class="comment">#å‘é€äººçš„é‚®ç®±çš„æˆæƒç </span></span><br><span class="line">  smtp_auth_password: <span class="string">&#x27;xxxxxxxxxxxxxxx&#x27;</span></span><br><span class="line">  <span class="comment">#æ˜¯å¦åŸºäºtlsåŠ å¯†</span></span><br><span class="line">  smtp_require_tls: <span class="literal">false</span></span><br><span class="line">  <span class="comment">#é‚®ç®±æœåŠ¡å™¨ï¼Œä¾‹å¦‚: &#x27;qq.com&#x27;</span></span><br><span class="line">  smtp_hello: <span class="string">&#x27;qq.com&#x27;</span></span><br><span class="line">route:</span><br><span class="line"><span class="comment">#é‡å¤æŠ¥è­¦çš„é—´éš”æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰è§£å³æŠ¥è­¦é—®é¢˜ï¼Œåˆ™ä¼šé—´éš”æŒ‡å®šæ—¶é—´ä¸€ç›´è§¦å‘æŠ¥è­¦ï¼Œæ¯”å¦‚:5m</span></span><br><span class="line">  group_by: [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">  group_wait: 5s</span><br><span class="line">  group_interval: 5s</span><br><span class="line">  repeat_interval: 5m</span><br><span class="line">  <span class="comment">#é‡‡ç”¨ä»€ä¹ˆæ–¹å¼æ¥æ”¶æŠ¥è­¦ï¼Œä¾‹å¦‚&#x27;email&#x27;</span></span><br><span class="line">  receiver: <span class="string">&#x27;email&#x27;</span></span><br><span class="line">receivers:</span><br><span class="line"><span class="comment">#å®šä¹‰æ¥æ”¶è€…çš„åç§°ï¼Œæ³¨æ„è¿™é‡Œçš„nameè¦å’Œä¸Šé¢çš„routeå¯¹åº”ï¼Œä¾‹å¦‚: &#x27;email&#x27;</span></span><br><span class="line">- name: <span class="string">&#x27;email&#x27;</span></span><br><span class="line">  email_configs:</span><br><span class="line">  <span class="comment">#é‚®ç®±å‘ç»™è°</span></span><br><span class="line">  - to: <span class="string">&#x27;xxxxxxxx@qq.com&#x27;</span></span><br><span class="line">    send_resolved: <span class="literal">true</span></span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">  <span class="comment">#åŒ¹é…æŠ¥è­¦çº§åˆ«ï¼Œä¾‹å¦‚: &#x27;critical&#x27;</span></span><br><span class="line">      severity: <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">    target_match:</span><br><span class="line">    <span class="comment">#åªè¦æ˜¯warningå°±æŠ¥è­¦</span></span><br><span class="line">      severity: <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">    equal: [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;dev&#x27;</span>, <span class="string">&#x27;instance&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">3ã€å¯åŠ¨alertmanager</span><br><span class="line">[root@master01 kubernetes]# supervisorctl start alertmanager</span><br></pre></td></tr></table></figure><p>2ã€é…ç½®è®©Prometheuså…³è”alertmanager</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 kubernetes]# vim /app/prometheus/prometheus.yml </span><br><span class="line"><span class="comment"># Alertmanager configuration</span></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">        <span class="comment">#è¿™é‡Œå†™alertmanagerçš„å®‰è£…åœ°å€</span></span><br><span class="line">          - 10.0.0.200:9093</span><br><span class="line">          </span><br><span class="line">[root@master01 kubernetes]# supervisorctl restart prometheus</span><br></pre></td></tr></table></figure><p>3ã€é…ç½®è§¦å‘å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">1ã€é…ç½®è§¦å‘å™¨è§„åˆ™å­˜æ”¾ç›®å½•</span><br><span class="line"><span class="comment">#ä¸€ä¸ªè§¦å‘å™¨ï¼Œä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line">[root@master01 kubernetes]# vim /app/prometheus/prometheus.yml </span><br><span class="line"><span class="comment"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span></span><br><span class="line">rule_files:</span><br><span class="line"><span class="comment">#é…ç½®è§¦å‘å™¨è§„åˆ™å­˜æ”¾ç›®å½•</span></span><br><span class="line">  - <span class="string">&quot;/app/prometheus/alertmanager/user_count.yml&quot;</span></span><br><span class="line">  <span class="comment">#- &quot;second_rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# supervisorctl restart prometheus</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€åˆ›å»ºå­˜æ”¾ç›®å½•</span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">mkdir</span> -p /app/prometheus/alertmanager/</span><br><span class="line"></span><br><span class="line">3ã€ç¼–å†™è§¦å‘å™¨è§„åˆ™æ–‡ä»¶</span><br><span class="line">[root@master01 kubernetes]# vim /app/prometheus/alertmanager/user_count.yml</span><br><span class="line"><span class="built_in">groups</span>:</span><br><span class="line">- name: user-count</span><br><span class="line">  rules:</span><br><span class="line">  - alert: user-count</span><br><span class="line">    <span class="built_in">expr</span>: user_count &gt; 3</span><br><span class="line">    <span class="keyword">for</span>: 15s</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">      team: node</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.exported_instance &#125;&#125; ç™»å½•ç”¨æˆ·æ•°é‡è¶…è¿‡ 3ï¼&quot;</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">#å‚æ•°è§£é‡Š    </span></span><br><span class="line"><span class="built_in">groups</span>:</span><br><span class="line"><span class="comment">#åå­—è‡ªå®šä¹‰</span></span><br><span class="line">- name: user-count</span><br><span class="line">  rules:</span><br><span class="line">  <span class="comment">#å‘Šè­¦ä¿¡æ¯ï¼Œuser-countçš„å€¼çš„key</span></span><br><span class="line">  - alert: user-count</span><br><span class="line">  <span class="comment">#expr: keyåå­—&#123;job=&quot;xxx&quot;&#125; == 3</span></span><br><span class="line">    <span class="built_in">expr</span>: user_count == 3</span><br><span class="line">    <span class="keyword">for</span>: 15s</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">      team: node</span><br><span class="line">    annotations:</span><br><span class="line">    <span class="comment">#exported_instanceæ˜¯è·å–æœºå™¨çš„ip</span></span><br><span class="line">      summary: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.exported_instance &#125;&#125; ç™»å½•ç”¨æˆ·æ•°é‡è¶…è¿‡ 3ï¼&quot;</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20241002124047891.png" alt="image-20241002124047891"></p><p>4ã€æµ‹è¯•ï¼Œnode03å¤šå¼€å‡ ä¸ªç»ˆç«¯ï¼Œæµè§ˆå™¨è®¿é—®10.0.0.200:9093ï¼ŒæŸ¥çœ‹æœ‰æŠ¥è­¦ä¿¡æ¯ï¼Œå°±å¯ä»¥æŸ¥çœ‹é‚®ç®±ï¼Œä¼šæ”¶åˆ°æŠ¥è­¦é‚®ä»¶</p><p><img src="../image/study_img/image-20241002145740578.png" alt="image-20241002145740578"></p><p><img src="../image/study_img/image-20241002145916255.png" alt="image-20241002145916255"></p><p>5ã€å½“ç™»å½•ç”¨æˆ·æ•°é‡å°‘äº3ä¸ªæ—¶é—´ï¼Œä¹Ÿä¼šå‘æ¢å¤çš„é‚®ä»¶</p><p><img src="../image/study_img/image-20241002150222081.png" alt="image-20241002150222081"></p><h3 id="9ã€K8séƒ¨ç½²Prometheusçš„èµ„æºæ¸…å•â€”â€”è¿™ä¸ªæ˜¯éƒ¨ç½²åœ¨å®¹å™¨é‡Œé¢"><strong>9ã€K8séƒ¨ç½²Prometheusçš„èµ„æºæ¸…å•â€”â€”è¿™ä¸ªæ˜¯éƒ¨ç½²åœ¨å®¹å™¨é‡Œé¢</strong></h3><p>1ã€ConfigMap èµ„æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; prom-cm.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Namespace</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: prom-config</span></span><br><span class="line"><span class="string">  namespace: prom</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ConfigMap</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: prom-config</span></span><br><span class="line"><span class="string">  namespace: prom</span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">  prometheus.yml: |</span></span><br><span class="line"><span class="string">  #å…¨å±€é…ç½®</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 15s #æŠ“å–æ•°æ®é—´éš”æ—¶é—´</span></span><br><span class="line"><span class="string">      scrape_timeout: 15s #æŠ“å–æ•°æ®è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="string">    scrape_configs: #æŠ“å–é…ç½®</span></span><br><span class="line"><span class="string">    #ä»»åŠ¡åç§°</span></span><br><span class="line"><span class="string">      - job_name: &quot;prometheus&quot;</span></span><br><span class="line"><span class="string">      #é™æ€é…ç½®</span></span><br><span class="line"><span class="string">        static_configs:</span></span><br><span class="line"><span class="string">        #æŠ“å–æ•°æ®èŠ‚ç‚¹çš„IPç«¯å£ï¼Œèµ·åœ¨å®¹å™¨é‡Œé¢ï¼Œåªèƒ½å†™localhost</span></span><br><span class="line"><span class="string">          - targets: [&quot;localhost:9090&quot;]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¦‚æœè¦æ·»åŠ å®¢æˆ·ç«¯ï¼Œå°±è¦editè¿™ä¸ªèµ„æºæ¸…å•ï¼Œæ·»åŠ å®¢æˆ·ç«¯</span></span><br></pre></td></tr></table></figure><p>2ã€PVå’ŒPVCèµ„æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä½ è¦å®‰è£…åœ¨å“ªå°æœºå™¨ï¼Œå°±å…ˆåˆ›å»ºæŒ‚è½½ç›®å½•ï¼Œå› ä¸ºä¸‹é¢ä½¿ç”¨çš„æ˜¯<span class="built_in">local</span></span><br><span class="line"><span class="built_in">mkdir</span> /data/k8s/prometheus</span><br><span class="line"></span><br><span class="line">2ã€èµ„æºæ¸…å•</span><br><span class="line"><span class="built_in">cat</span> &gt; prom-pv-pvc.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: PersistentVolume</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: prom-localhost</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: prometheus</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  capacity:</span></span><br><span class="line"><span class="string">    storage: 10Gi</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">  - ReadWriteOnce</span></span><br><span class="line"><span class="string">  storageClassName: local-storage</span></span><br><span class="line"><span class="string">  local:</span></span><br><span class="line"><span class="string">    path: /data/k8s/prometheus</span></span><br><span class="line"><span class="string">    #è¿™é‡Œæ˜¯äº²å’Œæ€§</span></span><br><span class="line"><span class="string">  nodeAffinity:</span></span><br><span class="line"><span class="string">    required:</span></span><br><span class="line"><span class="string">      nodeSelectorTerms:</span></span><br><span class="line"><span class="string">      - matchExpressions:</span></span><br><span class="line"><span class="string">        - key: kubernetes.io/hostname</span></span><br><span class="line"><span class="string">        #In,å°±æ˜¯ä¸»æœºååŒ…å«nodeï¼Œéƒ½èµ·</span></span><br><span class="line"><span class="string">          operator: In</span></span><br><span class="line"><span class="string">          values:</span></span><br><span class="line"><span class="string">          #- ä½ æƒ³å®‰è£…åœ¨å“ªå°æœºå™¨ï¼Œå°±å†™ä»–çš„ä¸»æœºå</span></span><br><span class="line"><span class="string">          - node03</span></span><br><span class="line"><span class="string">  persistentVolumeReclaimPolicy: Retain</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: PersistentVolumeClaim</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: prom-data</span></span><br><span class="line"><span class="string">  namespace: prom</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: prometheus</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">  - ReadWriteOnce</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">    requests:</span></span><br><span class="line"><span class="string">      storage: 10Gi</span></span><br><span class="line"><span class="string">  storageClassName: local-storage</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>3ã€RBAC æƒé™èµ„æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; prom-rbac.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ServiceAccount</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: prometheus</span></span><br><span class="line"><span class="string">  namespace: prom</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: ClusterRole</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: prometheus</span></span><br><span class="line"><span class="string">rules:</span></span><br><span class="line"><span class="string">- apiGroups:</span></span><br><span class="line"><span class="string">  - &quot;&quot;</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">  - nodes</span></span><br><span class="line"><span class="string">  - services</span></span><br><span class="line"><span class="string">  - endpoints</span></span><br><span class="line"><span class="string">  - pods</span></span><br><span class="line"><span class="string">  - nodes/proxy</span></span><br><span class="line"><span class="string">  verbs:</span></span><br><span class="line"><span class="string">  - get</span></span><br><span class="line"><span class="string">  - list</span></span><br><span class="line"><span class="string">  - watch</span></span><br><span class="line"><span class="string">- apiGroups:</span></span><br><span class="line"><span class="string">  - &quot;extensions&quot;</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">  - ingresses</span></span><br><span class="line"><span class="string">  verbs:</span></span><br><span class="line"><span class="string">  - get</span></span><br><span class="line"><span class="string">  - list</span></span><br><span class="line"><span class="string">  - watch</span></span><br><span class="line"><span class="string">- apiGroups:</span></span><br><span class="line"><span class="string">  - &quot;&quot;</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">  - configmaps</span></span><br><span class="line"><span class="string">  - nodes/metrics</span></span><br><span class="line"><span class="string">  verbs:</span></span><br><span class="line"><span class="string">  - get</span></span><br><span class="line"><span class="string">- nonResourceURLs:</span></span><br><span class="line"><span class="string">  - /metrics</span></span><br><span class="line"><span class="string">  verbs:</span></span><br><span class="line"><span class="string">  - get</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: ClusterRoleBinding</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: prometheus</span></span><br><span class="line"><span class="string">roleRef:</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">  kind: ClusterRole</span></span><br><span class="line"><span class="string">  name: prometheus</span></span><br><span class="line"><span class="string">subjects:</span></span><br><span class="line"><span class="string">- kind: ServiceAccount</span></span><br><span class="line"><span class="string">  name: prometheus</span></span><br><span class="line"><span class="string">  namespace: prom</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>4ã€Deployment èµ„æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; prom-dp.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: prometheus</span></span><br><span class="line"><span class="string">  namespace: prom</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: prometheus</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: prometheus</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: prometheus</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      serviceAccountName: prometheus</span></span><br><span class="line"><span class="string">      volumes:</span></span><br><span class="line"><span class="string">      - name: data</span></span><br><span class="line"><span class="string">      persistentVolumeClaim:</span></span><br><span class="line"><span class="string">        claimName: prom-data</span></span><br><span class="line"><span class="string">      - name: config-volume</span></span><br><span class="line"><span class="string">        configMap:</span></span><br><span class="line"><span class="string">          name: prom-config</span></span><br><span class="line"><span class="string">      initContainers:</span></span><br><span class="line"><span class="string">      - name: fix-permissions</span></span><br><span class="line"><span class="string">        image: busybox</span></span><br><span class="line"><span class="string">        command: [chown, -R, &quot;nobody:nobody&quot;, /prometheus]</span></span><br><span class="line"><span class="string">        volumeMounts:</span></span><br><span class="line"><span class="string">        - name: data</span></span><br><span class="line"><span class="string">          mountPath: /prometheus</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: prometheus</span></span><br><span class="line"><span class="string">        image: prom/prometheus:v2.24.1</span></span><br><span class="line"><span class="string">        args:</span></span><br><span class="line"><span class="string">        - &quot;--config.file=/etc/prometheus/prometheus.yml&quot; # é…ç½®æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="string">        - &quot;--storage.tsdb.path=/prometheus&quot; # æ•°æ®ä¿å­˜è·¯å¾„</span></span><br><span class="line"><span class="string">        - &quot;--storage.tsdb.retention.time=24h&quot; # æ•°æ®ä¿ç•™ï¼Œé»˜è®¤15å¤©</span></span><br><span class="line"><span class="string">        - &quot;--web.enable-admin-api&quot; # æ§åˆ¶å¯¹admin HTTP APIè®¿é—®</span></span><br><span class="line"><span class="string">        - &quot;--web.enable-lifecycle&quot; # æ”¯æŒçƒ­æ›´æ–°</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 9090</span></span><br><span class="line"><span class="string">        volumeMounts:</span></span><br><span class="line"><span class="string">        - name: config-volume</span></span><br><span class="line"><span class="string">          mountPath: /etc/prometheus</span></span><br><span class="line"><span class="string">        - name: data</span></span><br><span class="line"><span class="string">          mountPath: /prometheus</span></span><br><span class="line"><span class="string">        resources:</span></span><br><span class="line"><span class="string">          requests:</span></span><br><span class="line"><span class="string">            cpu: 100m</span></span><br><span class="line"><span class="string">            memory: 512Mi</span></span><br><span class="line"><span class="string">          limits:</span></span><br><span class="line"><span class="string">            cpu: 100m</span></span><br><span class="line"><span class="string">          memory: 512Mi</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>5ã€Serviceèµ„æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; prom-svc.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: prometheus</span></span><br><span class="line"><span class="string">  namespace: prom</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: prometheus</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: prometheus</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">  - name: web</span></span><br><span class="line"><span class="string">    port: 9090</span></span><br><span class="line"><span class="string">    targetPort: 9090</span></span><br><span class="line"><span class="string">  type: ClusterIP</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>6ã€ingressèµ„æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; prom-ingress.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: networking.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Ingress</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: prometheus</span></span><br><span class="line"><span class="string">  namespace: prom</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: prometheus</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">  - host: prom.drz.com</span></span><br><span class="line"><span class="string">    http:</span></span><br><span class="line"><span class="string">      paths:</span></span><br><span class="line"><span class="string">      - path: /</span></span><br><span class="line"><span class="string">        pathType: ImplementationSpecific</span></span><br><span class="line"><span class="string">        backend:</span></span><br><span class="line"><span class="string">          service:</span></span><br><span class="line"><span class="string">            name: prometheus</span></span><br><span class="line"><span class="string">            port:</span></span><br><span class="line"><span class="string">              number: 9090</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>7ã€å®‰è£…å®Œæˆï¼Œåº”è¯¥æ˜¯èµ·åˆ°node03ä¸Šçš„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç‰©ç†æœºåšåŸŸåè§£æ</span><br><span class="line">10.0.0.203 prom.drz.com   </span><br><span class="line"></span><br><span class="line">æµè§ˆå™¨è®¿é—®åŸŸå</span><br><span class="line">prom.drz.com</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ¬æ¬¡ä¼šä»‹ç»å¼€æºç³»ç»Ÿç›‘æ§å’Œè­¦æŠ¥å·¥å…·Prometheusçš„ä½¿ç”¨ï¼Œä»¥åŠå†™è„šæœ¬ç›‘æ§</summary>
    
    
    
    <category term="k8s" scheme="https://www.fomal.cc/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰5ã€Podçš„é’©å­å’Œæ¢é’ˆ</title>
    <link href="https://www.fomal.cc/posts/feb758ca.html"/>
    <id>https://www.fomal.cc/posts/feb758ca.html</id>
    <published>2024-09-22T06:46:01.000Z</published>
    <updated>2024-09-30T07:54:53.358Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Podçš„é’©å­å’Œæ¢é’ˆ">Podçš„é’©å­å’Œæ¢é’ˆ</h2><h3 id="1ã€podçš„ç”Ÿå‘½å‘¨æœŸ">1ã€<strong>podçš„ç”Ÿå‘½å‘¨æœŸ</strong></h3><p><img src="../image/study_img/image-20240920083828296.png" alt="image-20240920083828296"></p><p><img src="../image/study_img/image-20240920083900491.png" alt="image-20240920083900491"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ç”Ÿå‘½å‘¨æœŸé‡Œé¢åŒ…å«çš„ä¸œè¥¿</span><br><span class="line">1ã€åˆå§‹åŒ–å®¹å™¨</span><br><span class="line">2ã€2ä¸ªé’©å­</span><br><span class="line">   - start hook</span><br><span class="line">   - stop hook</span><br><span class="line"></span><br><span class="line"><span class="comment">#init container</span></span><br><span class="line">åˆå§‹åŒ–å®¹å™¨çš„ä½œç”¨ï¼šä¸»å®¹å™¨å¯åŠ¨ä¹‹å‰ï¼Œå¯ä»¥è®©ä»–åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚</span><br><span class="line">æ¯”å¦‚ï¼š</span><br><span class="line">1ã€åˆ›å»ºç”¨æˆ·ï¼Œå®¹å™¨çš„ç»Ÿä¸€ç”¨æˆ·</span><br><span class="line">2ã€2ä¸ªå®¹å™¨åšäº†å…±äº«å‚¨å­˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è®©ä»–å…ˆå¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œæ¥å¯¹ç›®å½•è¿›è¡Œæ›´æ”¹å’Œæˆæƒ</span><br><span class="line">3ã€å®¹å™¨éœ€è¦è¿æ¥æ•°æ®åº“ï¼Œå¯ä»¥è®©åˆå§‹åŒ–å®¹å™¨æ£€æµ‹æ•°æ®åº“æ˜¯å¦å¯ä»¥æ­£å¸¸è¿æ¥ï¼Œå¦‚æœå¯ä»¥å†å¯åŠ¨ä¸»å®¹å™¨</span><br><span class="line"></span><br><span class="line"><span class="comment">#hook</span></span><br><span class="line">Poststartï¼šåœ¨å®¹å™¨åˆ›å»ºåï¼Œç«‹å³æ‰§è¡Œï¼Œä½†æ—¶é—´ä¸èƒ½å¤ªä¹…ï¼Œå¦åˆ™å®¹å™¨ä¸ä¼šæ˜¯runningçŠ¶æ€</span><br><span class="line">Prestartï¼šåœ¨å®¹å™¨åœæ­¢å‰ï¼Œæ‰§è¡Œä¸€äº›å‘½ä»¤ï¼Œä¸»è¦ç”¨äºä¼˜é›…å…³é—­è¿›ç¨‹</span><br><span class="line"></span><br><span class="line"><span class="comment">#Liveness probe</span></span><br><span class="line">å­˜æ´»æ¢é’ˆï¼Œç”¨äºå®šä¹‰å®¹å™¨å†…ï¼Œåº”ç”¨æ˜¯å¦æ»¡è¶³æ¢é’ˆçŠ¶æ€</span><br><span class="line"></span><br><span class="line"><span class="comment">#rediness probe</span></span><br><span class="line">å°±ç»ªæ¢é’ˆï¼ŒæŒ‡å®šä½•æ—¶å…è®¸å®¹å™¨è¿›å…¥æµé‡</span><br></pre></td></tr></table></figure><h3 id="2ã€åˆå§‹åŒ–å®¹å™¨">2ã€<strong>åˆå§‹åŒ–å®¹å™¨</strong></h3><ul><li>åˆ©ç”¨åˆå§‹åŒ–å®¹å™¨æ›´æ”¹nginxé¡µé¢</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åˆ©ç”¨åˆå§‹åŒ–å®¹å™¨æ›´æ”¹nginxé¡µé¢</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸»å®¹å™¨å¯åŠ¨ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥è®©ä»–åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œåˆå§‹åŒ–å®¹å™¨æ‰§è¡Œå®Œæˆåå°±ç»“æŸé€€å‡º</span></span><br><span class="line"></span><br><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim init-container.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: init-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">#æŒ‡å®šä¸€ä¸ªåˆå§‹åŒ–å®¹å™¨ï¼šåˆå§‹åŒ–å®¹å™¨çš„å†™æ³•å’Œä¸‹é¢å®¹å™¨çš„å†™æ³•æ˜¯ä¸€æ ·çš„</span></span><br><span class="line">  initContainers:</span><br><span class="line">  - name: initcontainer</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s åˆå§‹åŒ–å®¹å™¨&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">  - name: c7-container</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œå®¹å™¨ï¼ŒæŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f init-container.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -owide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE    IP          NODE</span><br><span class="line">init-pod    2/2     Running   0          2m1s   10.2.2.6    node02</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.2.6</span><br><span class="line"><span class="built_in">test</span> k8s åˆå§‹åŒ–å®¹å™¨</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it init-pod -c c7-container -- /bin/bash</span><br><span class="line">[root@init-pod /]# <span class="built_in">cat</span> /usr/share/nginx/html/index.html </span><br><span class="line"><span class="built_in">test</span> k8s åˆå§‹åŒ–å®¹å™¨</span><br><span class="line"></span><br><span class="line">ç°åœ¨ç›¸å½“äº3ä¸ªå®¹å™¨åŒæ—¶æŒ‚è½½åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼ŒåŒæ—¶ä¹Ÿç›¸å½“äºæŒ‚è½½åˆ°å®¿ä¸»æœºçš„ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼Œä»–ä»¬3çš„ç›®å½•åšäº†å…±äº«</span><br><span class="line"></span><br><span class="line">æ¯”å¦‚è¯´èµ·ä¸ªnginxå’Œphpå®¹å™¨ï¼Œå®¹å™¨çš„æ–‡ä»¶äº’ç›¸éš”ç¦»ï¼Œä»£ç å°±ä¸å…±äº«ï¼Œé‚£ä»£ç éƒ¨ç½²åœ¨å“ªé‡Œå‘¢ï¼Œå¦‚æœéƒ¨ç½²åœ¨nginxä¸Šï¼Œphpæ‰æ˜¯è§£æä»£ç çš„ï¼Œwordpressä¸æ˜¯å‰åç«¯åˆ†ç¦»çš„ï¼Œnginxé…ç½®æ–‡ä»¶å°±ä¸èƒ½ç”¨socketè¿æ¥phpäº†ï¼Œè¦ç”¨fastcgi_pass xx.xx.xx.xx:900,ä»£ç å¿…é¡»2è¾¹éƒ½è¦å­˜</span><br></pre></td></tr></table></figure><h3 id="3ã€é’©å­">3ã€<strong>é’©å­</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¯åŠ¨é’©å­  poststart  å¯åŠ¨ä¹‹å</span></span><br><span class="line">lifecycle: </span><br><span class="line">  preStart: </span><br><span class="line">    <span class="built_in">exec</span>:</span><br><span class="line">    httpGet: </span><br><span class="line">    tcpSocket </span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>ï¼šæ‰§è¡Œå‘½ä»¤</span><br><span class="line">httpGetï¼šæ£€æµ‹HTTPï¼Œæ¯”å¦‚æ£€æµ‹ç½‘ç«™çš„80ï¼Œ443ç«¯å£ï¼Œè¦æ±‚webé¡µé¢çŠ¶æ€ç è¿”å›æ˜¯ä¸æ˜¯404ï¼Œ200ï¼Œä¸€èˆ¬åœ¨æ¢é’ˆé‡Œç”¨</span><br><span class="line">tcpSocketï¼šæ£€æµ‹ç«¯å£é€šä¸é€šï¼Œæ¯”å¦‚æ£€æµ‹æ•°æ®åº“æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¦‚æœç”¨httpgetä¸è¡Œ</span><br><span class="line"></span><br><span class="line"><span class="comment">#åœæ­¢é’©å­   preStop   åœæ­¢ä¹‹å‰</span></span><br><span class="line">lifecycle: </span><br><span class="line">  preStop: </span><br><span class="line">    <span class="built_in">exec</span>:</span><br><span class="line">    httpGet: </span><br><span class="line">    tcpSocket</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨å¯åŠ¨é’©å­åœ¨ä¸€ä¸ªpodé‡Œç»Ÿä¸€å¤šä¸ªå®¹å™¨çš„ç”¨æˆ·</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cp</span> init-container.yml poststart.yml</span><br><span class="line">[root@master01 kubernetes]# vim poststart.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: poststart-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  <span class="comment">#è¿™é‡ŒæŒ‚è½½ç›®å½•å¯ä»¥æ˜¯ä¸´æ—¶çš„</span></span><br><span class="line">  - name: nginx-data</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">  initContainers:</span><br><span class="line">  - name: initcontainer</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s ä½¿ç”¨å¯åŠ¨é’©å­åœ¨ä¸€ä¸ªpodé‡Œç»Ÿä¸€å¤šä¸ªå®¹å™¨çš„ç”¨æˆ·&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="comment">#nginxå¯åŠ¨ä¹‹åçš„é’©å­å†™æ³•:ç»Ÿä¸€å®¹å™¨çš„ç”¨æˆ·</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">     <span class="comment">#nginxé‡Œé¢ä¸€å¼€å§‹å†™useraddå‘½ä»¤åˆ›å»ºç”¨æˆ·ï¼Œä½†æ˜¯è¿™ä¸ªå®¹å™¨é‡Œé¢æ²¡æœ‰useraddå‘½ä»¤ï¼Œä¼šæŠ¥é”™ã€‚æ‰€ä»¥åªèƒ½ç”¨æ”¹ç»„ã€ç”¨æˆ·æœ‰å…³çš„é…ç½®æ–‡ä»¶å»æ·»åŠ ç”¨æˆ·</span></span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;www:x:666&#x27; &gt;&gt; /etc/group &amp;&amp; echo &#x27;www:x:666:666::/home/www:/sbin/nologin&#x27; &gt;&gt; /etc/passwd&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">  - name: c7-container</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line">    <span class="comment">#C7å¯åŠ¨ä¹‹åçš„é’©å­å†™æ³•:ç»Ÿä¸€å®¹å™¨çš„ç”¨æˆ·</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>: </span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;groupadd www -g 666 &amp;&amp; useradd www -u 666 -g 666 -s /sbin/nologin -M&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œå®¹å™¨ï¼ŒæŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f  poststart.yml </span><br><span class="line">pod/poststart-pod created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod poststart-pod -owide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE   IP          NODE  </span><br><span class="line">poststart-pod   2/2     Running   0          33s   10.2.3.33   node03</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.3.33</span><br><span class="line"><span class="built_in">test</span> k8s ä½¿ç”¨å¯åŠ¨é’©å­åœ¨ä¸€ä¸ªpodé‡Œç»Ÿä¸€å¤šä¸ªå®¹å™¨çš„ç”¨æˆ·</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it poststart-pod -c c7-container -- /bin/bash</span><br><span class="line">[root@poststart-pod /]# <span class="built_in">id</span> www</span><br><span class="line">uid=666(www) gid=666(www) <span class="built_in">groups</span>=666(www)</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it poststart-pod -c nginx-container -- /bin/sh</span><br><span class="line">/ <span class="comment"># id www</span></span><br><span class="line">uid=666(www) gid=666 <span class="built_in">groups</span>=666</span><br></pre></td></tr></table></figure><ul><li>åœæ­¢é’©å­  å®¹å™¨åœæ­¢ä¹‹å‰æ‰“å°æŒ‡å®šå†…å®¹åˆ°æ–‡ä»¶  (ä¸å¸¸ç”¨ï¼Œæ²¡ä»€ä¹ˆåº”ç”¨åœºæ™¯)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cp</span> poststart.yml poststop.yml</span><br><span class="line">[root@master01 kubernetes]# vim prestop.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: poststop-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  <span class="comment">#ä¸ºäº†æ»¡è¶³åœæ­¢ä¹‹å‰echoå†…å®¹åˆ°æŒ‚è½½ç›®å½•ï¼Œæ‰€ä»¥è¿™é‡Œçš„æŒ‚è½½ç›®å½•éœ€è¦æŒä¹…åŒ–</span></span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">  initContainers:</span><br><span class="line">  - name: initcontainer</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s ä½¿ç”¨å¯åŠ¨é’©å­åœ¨ä¸€ä¸ªpodé‡Œç»Ÿä¸€å¤šä¸ªå®¹å™¨çš„ç”¨æˆ·&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;www:x:666&#x27; &gt;&gt; /etc/group &amp;&amp; echo &#x27;www:x:666:666::/home/www:/sbin/nologin&#x27; &gt;&gt; /etc/passwd&quot;</span>]</span><br><span class="line"><span class="comment">#å®¹å™¨åœæ­¢ä¹‹å‰åšçš„äº‹æƒ…</span></span><br><span class="line">      preStop:</span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s ä½¿ç”¨åœæ­¢é’©å­ä½¿podåœ¨åœæ­¢ä¹‹å‰æ‰“å°  bye&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">  - name: c7-container</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line">    <span class="comment">#C7å¯åŠ¨ä¹‹åçš„é’©å­å†™æ³•:ç»Ÿä¸€å®¹å™¨çš„ç”¨æˆ·</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>: </span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;groupadd www -g 666 &amp;&amp; useradd www -u 666 -g 666 -s /sbin/nologin -M&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line"> 2ã€æŸ¥çœ‹  </span><br><span class="line">[root@node03 ~]# <span class="built_in">rm</span> -rf /data/nginx/index.html</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod poststop-pod -owide</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP          NODE  </span><br><span class="line">poststop-pod   2/2     Running   0          40s   10.2.3.34   node03</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.3.34</span><br><span class="line"><span class="built_in">test</span> k8s ä½¿ç”¨å¯åŠ¨é’©å­åœ¨ä¸€ä¸ªpodé‡Œç»Ÿä¸€å¤šä¸ªå®¹å™¨çš„ç”¨æˆ·</span><br><span class="line"></span><br><span class="line">3ã€ç°åœ¨curlå‡ºæ¥çš„ç»“æœè¿˜æ²¡æœ‰æ”¹å˜ï¼Œéœ€è¦åˆ é™¤è¿™ä¸ªpodï¼Œæ‰ä¼šå‘ç”Ÿæ”¹å˜ï¼Œåˆ æ‰ä¹‹åå®¹å™¨ä¸åœ¨äº†ï¼Œä¸èƒ½ç”¨curl,åªèƒ½åˆ°æŒ‚è½½ç›®å½•å»çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod poststop-pod</span><br><span class="line"></span><br><span class="line">[root@node03 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s ä½¿ç”¨åœæ­¢é’©å­ä½¿podåœ¨åœæ­¢ä¹‹å‰æ‰“å° <span class="built_in">bye</span></span><br></pre></td></tr></table></figure><h3 id="4ã€æ¢é’ˆ">4ã€<strong>æ¢é’ˆ</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å­˜æ´»æ€§æ¢é’ˆ(å­˜æ´»æ€æ¢é’ˆ) livenessprobe</span></span><br><span class="line">åˆ—å¦‚ï¼š</span><br><span class="line">å½“nginxå®¹å™¨èµ·æ¥åï¼Œå³ä¾¿é¡µé¢æ˜¯404ï¼Œå®¹å™¨ä¼šæ­£å¸¸è¿è¡Œï¼Œ80ç«¯å£ä¹Ÿä¼šæ­£å¸¸å­˜åœ¨ï¼Œk8så°±ä¸ä¼šåšåˆ°é‡æ–°æ‹‰èµ·è¿™ä¸ªå®¹å™¨ï¼Œå­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">æ•°æ®åº“å‡æ­»ï¼Œè¿›ç¨‹å­˜åœ¨ï¼Œå­˜æ´»æ€§æ¢é’ˆå°±å¯ä»¥æ£€æµ‹åº”ç”¨æ˜¯å¦å­˜æ´»ï¼Œä¸å­˜æ´»ä¼šå‡ºç°æ‹‰èµ·æ–°çš„pod</span><br><span class="line"></span><br><span class="line">ç”¨äºå®šä¹‰å®¹å™¨å†…ï¼Œåº”ç”¨æ˜¯å¦æ»¡è¶³æ¢é’ˆæŒ‡å®šçŠ¶æ€ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œåˆ™åˆ é™¤PODé‡æ–°æ‹‰èµ·ä¸€ä¸ªæ–°çš„POD</span><br><span class="line"></span><br><span class="line">å­˜æ´»æ¢é’ˆç®€å•æ¥è¯´å°±æ˜¯ç”¨æ¥æ£€æµ‹å®¹å™¨çš„åº”ç”¨ç¨‹åºæ˜¯å¦è¿˜æ­£å¸¸å·¥ä½œï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸æ­£å¸¸ï¼Œå³ä½¿å®¹å™¨è¿˜æ´»ç€ä¹Ÿæ²¡æœ‰æ„ä¹‰äº†ï¼Œæ‰€ä»¥è¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨å­˜æ´»æ¢é’ˆæ¥æ¢æµ‹ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸æ­£å¸¸ï¼Œå°±é‡å¯PODã€‚</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>ï¼šæ‰§è¡Œå‘½ä»¤</span><br><span class="line">httpGetï¼šæ£€æµ‹HTTP</span><br><span class="line">tcpSocketï¼šæ£€æµ‹ç«¯å£</span><br><span class="line"></span><br><span class="line">ivenessProbe:</span><br><span class="line">httpGet:   <span class="comment">#åŸºäºHTTPè¯·æ±‚èµ„æº</span></span><br><span class="line">path:      <span class="comment">#è¯·æ±‚åœ°å€ï¼Œå¦‚æœè¿™ä¸ªåœ°å€è¿”å›çš„çŠ¶æ€ç åœ¨200~400ä¹‹é—´æ­£å¸¸</span></span><br><span class="line">port:      <span class="comment">#è¯·æ±‚çš„ç«¯å£</span></span><br><span class="line">initialDelaySeconds: 3     <span class="comment">#ç¬¬ä¸€æ¬¡å¯åŠ¨æ¢æµ‹åœ¨å®¹å™¨å¯åŠ¨çš„3såå¼€å§‹</span></span><br><span class="line">periodSeconds: 3           <span class="comment">#å®¹å™¨å¯åŠ¨åæ¯éš”3sæ£€æµ‹ä¸€æ¬¡</span></span><br></pre></td></tr></table></figure><ul><li>1ã€å­˜æ´»æ€§æ¢é’ˆ  execç‰ˆ   åº”ç”¨åœºæ™¯ï¼šæ¯”å¦‚è¯´nfs,æ²¡æœ‰é¡µé¢å’Œç«¯å£ï¼Œå°±å¯ä»¥ç”¨å‘½ä»¤ï¼Œdf -Th|grep æŒ‚è½½ç›®å½•ï¼Œå¦‚æœnfsæŒ‚äº†df -Thä¼šå¡ä¸»ï¼Œä½†æ˜¯ä»–æœ‰ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå¡ä½äº†ï¼Œåˆ°æ—¶å€™è¶…æ—¶äº†å°±è®¤ä¸ºæŒ‚äº†</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>è¿˜å¯ä»¥å†™è„šæœ¬å»æ£€æµ‹æŸä¸ªæœåŠ¡</span><br><span class="line"></span><br><span class="line">1ã€å†™serviceèµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim ivenssprobe-service.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: ivenssprobe-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">  <span class="comment">#è¿™ä¸ªæ ‡ç­¾ä¸€å®šè¦å’Œä¸‹é¢çš„æ ‡ç­¾ä¿æŒä¸€è‡´ï¼Œä¸ç„¶ä¼šcurlæŠ¥é”™</span></span><br><span class="line">    app: ivenssprobe</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">    <span class="comment">#æŠŠ80æ˜ å°„åˆ°å®¿ä¸»æœºçš„30000ç«¯å£</span></span><br><span class="line">    nodePort: 30000</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ç¼–å†™èµ„æºæ¸…å•    åˆ°è¿™é‡Œç›®å‰è¿˜æ²¡æœ‰æ·»åŠ å­˜æ´»æ¢é’ˆçš„åŠŸèƒ½ï¼Œåœ¨åé¢æ·»åŠ </span><br><span class="line">[root@master01 kubernetes]# vim ivenssprobe.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: ivenssprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: ivenssprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å­˜æ´»æ€§æ¢é’ˆ&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">          </span><br><span class="line">2ã€è¿è¡Œ</span><br><span class="line">[root@master01 kubernetes]# kubectl get service</span><br><span class="line">NAME                  TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">ivenssprobe-service   NodePort    10.1.87.209   &lt;none&gt;        80:30000/TCP   25s</span><br><span class="line">kubernetes            ClusterIP   10.1.0.1      &lt;none&gt;        443/TCP        7d5h</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod ivenssprobe-pod -owide</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">ivenssprobe-pod   1/1     Running   0          3m53s   10.2.1.11   node01</span><br><span class="line"></span><br><span class="line">3ã€æ£€æŸ¥</span><br><span class="line">ivenssprobe-serviceè¿™ä¸ªèµ„æºç›¸å½“äºç»™ä»–ä»¬åšäº†è´Ÿè½½å‡è¡¡</span><br><span class="line">[root@master01 kubernetes]# curl 10.1.151.36</span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.1.7 </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line"></span><br><span class="line">ç”±äºåšäº†å®¿ä¸»æœºä¸Šçš„æ˜ å°„ï¼Œå¯ä»¥æµè§ˆå™¨è®¿é—®   10.0.0.201:30000</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240920165623622.png" alt="image-20240920165623622"></p><p>æµ‹è¯•æ¢é’ˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line"></span><br><span class="line">1ã€åˆ é™¤ä¸»é¡µé¢ï¼Œå†æ¬¡æµè§ˆå™¨è®¿é—®ï¼Œå˜æˆ403</span><br><span class="line">[root@node01 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line"></span><br><span class="line">2ã€å†æ¬¡æŸ¥çœ‹ä¸»é¡µé¢ï¼Œè¿˜æ˜¯ç©ºçš„ï¼ŒæŸ¥çœ‹podï¼Œè¿˜æ˜¯runningçŠ¶æ€ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†ç½‘ç«™ç¡®å®æŒ‚äº†ï¼Œpodè™½ç„¶åœ¨è¿è¡Œï¼Œä½†æ˜¯æ²¡å•¥ç”¨äº†ï¼Œè¿˜å ç”¨èµ„æº</span><br></pre></td></tr></table></figure><p>åœ¨èµ„æºæ¸…å•ç¼–å†™å­˜æ´»æ€§æ¢é’ˆçš„æ£€éªŒåŠŸèƒ½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">1ã€åˆ é™¤æ—§çš„pod</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod ivenssprobe-pod </span><br><span class="line"></span><br><span class="line">2ã€åœ¨èµ„æºæ¸…å•æ·»åŠ å­˜æ´»æ€§æ¢é’ˆçš„æ£€éªŒåŠŸèƒ½</span><br><span class="line">[root@master01 kubernetes]# vim ivenssprobe.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: ivenssprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: ivenssprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å­˜æ´»æ€§æ¢é’ˆ&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    livenessProbe:</span><br><span class="line">      <span class="built_in">exec</span>:</span><br><span class="line"><span class="comment">#æ£€æµ‹ä¸»é¡µé¢ï¼Œæ‹¿å‘½ä»¤æ£€æµ‹ï¼Œå½“è¿”å›å€¼ä¸ä¸º0å°±æ˜¯å¤±è´¥</span></span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;cat /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line"><span class="comment">#ä¸€å®šè¦å†™ä¼˜åŒ–å‚æ•°</span></span><br><span class="line">      <span class="comment">#å»¶è¿Ÿæ—¶é—´3s</span></span><br><span class="line">      initialDelaySeconds: 3 </span><br><span class="line">      <span class="comment">#å®¹å™¨æ¯éš”2sæ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">      periodSeconds: 2</span><br><span class="line">      <span class="comment">#è¶…æ—¶æ—¶é—´ 1s</span></span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      <span class="comment">#æˆåŠŸä¹‹å3æ¬¡è¿ç»­å¤±è´¥ï¼Œæ‰æ˜¯çœŸå¤±è´¥ï¼Œç„¶åé‡æ–°å»æ‹‰èµ·ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨çš„æƒ…å†µ</span></span><br><span class="line">      failureThreshold: 3</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line">3ã€æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]#  kubectl apply -f ivenssprobe.yml </span><br><span class="line">pod/ivenssprobe-pod created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod ivenssprobe-pod -owide</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE   IP          NODE  </span><br><span class="line">ivenssprobe-pod   1/1     Running   0          64s   10.2.1.12   node01</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å‚æ•°è§£é‡Šï¼š</span><br><span class="line"></span><br><span class="line">initialDelaySeconds: <span class="comment">#ç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢é’ˆéœ€è¦åœ¨å®¹å™¨å¯åŠ¨åç­‰å¾…çš„æ—¶å€™æ—¶é—´</span></span><br><span class="line">periodSeconds: <span class="comment">#å®¹å™¨å¯åŠ¨åæ¯éš”å¤šå°‘ç§’æ‰§è¡Œä¸€æ¬¡å­˜æ´»æ¢é’ˆ(å¿ƒè·³æ£€æµ‹çš„é—´éš”æ—¶é—´)</span></span><br><span class="line">timeoutSeconds: <span class="comment">#æ¢é’ˆè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤1ç§’ï¼Œæœ€å°1ç§’</span></span><br><span class="line">successThreshold: <span class="comment">#æ¢é’ˆå¤±è´¥åæœ€å°‘è¿ç»­æ¢æµ‹æˆåŠŸå¤šå°‘æ¬¡æ‰è¢«è®¤å®šæˆåŠŸï¼Œé»˜è®¤1æ¬¡ï¼Œå¦‚æœæ˜¯livenesså¿…é¡»ä¸º1(ä¸€å¼€å§‹æ£€æµ‹ä¸€ä¸ªç½‘ç«™æ˜¯403ï¼Œä»£è¡¨ç½‘ç«™å¤±è´¥ï¼Œä¸å¯èƒ½ä¸€å¤±è´¥å°±ç«‹é©¬å»é‡æ–°æ‹‰èµ·pod,éœ€è¦æ£€æŸ¥åˆ°å‡ æ¬¡æˆåŠŸæ‰è®¤ä¸ºæ˜¯æˆåŠŸçš„)</span></span><br><span class="line">failureThreshold: <span class="comment">#æ¢é’ˆæˆåŠŸåè¢«è§†ä¸ºå¤±è´¥çš„æ¢æµ‹çš„æœ€å°è¿ç»­å¤±è´¥æ¬¡æ•°ã€‚é»˜è®¤3æ¬¡ã€‚æœ€å°å€¼ä¸º1(æ¢é’ˆæ£€æµ‹æˆåŠŸå®¹å™¨æ­£å¸¸è¿è¡Œï¼Œé‚£ä¹ˆè¿˜è¦æ£€æµ‹å‡ æ¬¡å¤±è´¥æ‰ä¼šé‡æ–°æ‹‰èµ·è¿™ä¸ªpod)</span></span><br></pre></td></tr></table></figure><p>å†æ¬¡æµ‹è¯•  è®¿é—®ç½‘é¡µ  10.0.0.201:30000  æ¢å¤æ­£å¸¸</p><p><img src="../image/study_img/image-20240920173329296.png" alt="image-20240920173329296"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">[root@node01 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">[root@node01 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">cat</span>: /data/nginx/index.html: No such file or directory</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">cat</span>: /data/nginx/index.html: No such file or directory</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line"></span><br><span class="line">åˆ æ‰ä¸»é¡µé¢ï¼ŒæŸ¥çœ‹ä¸»é¡µé¢å†…å®¹ï¼Œä¼šé‡æ–°æ‹‰èµ·ï¼Œæ‰€ä»¥ä¼šçœ‹åˆ°å†…å®¹</span><br><span class="line"></span><br><span class="line">ä½†æ˜¯<span class="built_in">exec</span>æœ‰ç¼ºé™·ï¼Œä»¥åä»£ç é¡µé¢å¤šï¼Œä¸èƒ½<span class="built_in">cat</span>ï¼Œæ‰€ä»¥Httpgetæ¯”è¾ƒå¥½ç”¨</span><br></pre></td></tr></table></figure><ul><li>2ã€å­˜æ´»æ€§æ¢é’ˆ  httpgetç‰ˆ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">1ã€åˆ é™¤æ—§çš„pod</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod ivenssprobe-pod </span><br><span class="line"></span><br><span class="line">2ã€åœ¨èµ„æºæ¸…å•æ·»åŠ å­˜æ´»æ€§æ¢é’ˆçš„æ£€éªŒåŠŸèƒ½</span><br><span class="line">[root@master01 kubernetes]# vim ivenssprobe.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: ivenssprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: ivenssprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å­˜æ´»æ€§æ¢é’ˆ&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    livenessProbe:</span><br><span class="line">    <span class="comment">#httpç‰ˆæœ¬</span></span><br><span class="line">      httpGet:</span><br><span class="line">      <span class="comment">#hostå°±æ˜¯æœ¬æœºï¼Œä½†æ˜¯å¯ä»¥é»˜è®¤å°±æ˜¯æœ¬æœºï¼Œä¸éœ€è¦å†™</span></span><br><span class="line">        <span class="comment">#host: 127.0.0.1</span></span><br><span class="line"><span class="comment">#pathå°±æ˜¯uri   http://k8s.driverzeng.com/v1.19/,æ¯”å¦‚è¯´è¿™ä¸ªç½‘ç«™çš„uriå°±æ˜¯/v1.19/     http://10.0.0.201:30000/ï¼Œuriå°±æ˜¯/</span></span><br><span class="line">        path: /</span><br><span class="line">      <span class="comment">#è¿˜å¯ä»¥åŠ ä¸Šç«¯å£</span></span><br><span class="line">        port: 80</span><br><span class="line">      </span><br><span class="line"><span class="comment">#ä¸€å®šè¦å†™ä¼˜åŒ–å‚æ•°</span></span><br><span class="line">      <span class="comment">#å»¶è¿Ÿæ—¶é—´3s</span></span><br><span class="line">      initialDelaySeconds: 3 </span><br><span class="line">      <span class="comment">#å®¹å™¨æ¯éš”2sæ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">      periodSeconds: 2</span><br><span class="line">      <span class="comment">#è¶…æ—¶æ—¶é—´ 1s</span></span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      <span class="comment">#æˆåŠŸä¹‹å3æ¬¡è¿ç»­å¤±è´¥ï¼Œæ‰æ˜¯çœŸå¤±è´¥ï¼Œç„¶åé‡æ–°å»æ‹‰èµ·ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨çš„æƒ…å†µ</span></span><br><span class="line">      failureThreshold: 3</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------</span><br><span class="line">ä¸å†™hostæ˜¯å› ä¸ºä¸çŸ¥é“podèµ·æ¥æ˜¯ä»€ä¹ˆip,ä½†ä»¥åå¾—å†™ï¼Œä»¥åä¸å¯èƒ½å§nginxå’Œmysqlèµ·åœ¨ä¸€ä¸ªpod,æ•°æ®åº“è‚¯å®šè¦å•ç‹¬èµ·ä¸€ä¸ªpod</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥è¯¢</span><br><span class="line">[root@master01 kubernetes]#  kubectl delete pod ivenssprobe-pod </span><br><span class="line">pod <span class="string">&quot;ivenssprobe-pod&quot;</span> deleted</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f ivenssprobe.yml </span><br><span class="line">pod/ivenssprobe-pod created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod ivenssprobe-pod -owide</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE   IP          NODE  </span><br><span class="line">ivenssprobe-pod   1/1     Running   0          26s   10.2.1.13   node01</span><br><span class="line"></span><br><span class="line">4ã€#æµ‹è¯•</span><br><span class="line">åˆ°node01åˆ é™¤ä¸»é¡µæ–‡ä»¶</span><br><span class="line">[root@node01 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line">é€Ÿåº¦å¿«ç‚¹ï¼Œåˆ‡æ¢åˆ°æµè§ˆå™¨ç½‘ç«™ï¼Œä¼šçœ‹åˆ°403ï¼Œä¸€ç›´åˆ·æ–°ï¼Œç½‘ç«™å°±ä¼šæ¢å¤åŸæ ·ï¼Œä¸éœ€è¦å»<span class="built_in">cat</span>ä¸»é¡µæ–‡ä»¶äº†</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹ä¸»é¡µæ–‡ä»¶ï¼Œæ¢å¤åŸæ ·</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /data/nginx/index.html </span><br><span class="line"><span class="built_in">test</span> k8s å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¥½å¤„æ˜¯ç›‘æµ‹å®ƒçš„80ç«¯å£ï¼Œè®¿é—®è¿™ä¸ªuriï¼Œåªè¦å‡ºç°çŠ¶æ€ç 40å‡ ï¼Œ50å‡ å°±ä¼šé‡æ–°æ‹‰èµ·ï¼Œæƒ³wordpressè¿™ç§ä»£ç å¤šçš„æƒ…å†µä¸‹ï¼Œä¸èƒ½ç”¨catå‘½ä»¤ä¸å¯èƒ½æ¯ä¸ªæ–‡ä»¶éƒ½cat,æ‰€ä»¥httpgetæ˜¯æ£€æµ‹nginxæœ€åçš„æ–¹æ³•</span></span><br></pre></td></tr></table></figure><ul><li>3ã€å­˜æ´»æ€§æ¢é’ˆ  tcpSocketç‰ˆ   åº”ç”¨åœºæ™¯ï¼šæ¯”å¦‚è¯´æ•°æ®åº“ï¼Œåªæœ‰ç«¯å£ï¼Œæ²¡æœ‰ç½‘ç«™</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">åªèƒ½æ£€æµ‹ç«¯å£ï¼Œä¸ä¼šæ£€æµ‹é¡µé¢ï¼Œåˆ æ‰é¡µé¢ï¼Œæ²¡æœ‰ç”¨ï¼Œä¸ä¼šé‡æ–°æ‹‰èµ·ï¼ŒhttpGetå°±ç›¸å½“äºåº•å±‚ä½¿ç”¨curlå‘½ä»¤å»æ£€æµ‹</span><br><span class="line"></span><br><span class="line">tcpSocket: </span><br><span class="line">  host:     <span class="comment">#é»˜è®¤å¯ä»¥ä¸å†™ï¼Œä»–è‡ªå·±çŸ¥é“podçš„ip,æ‰€ä»¥å¯ä»¥ä¸å†™</span></span><br><span class="line">  port:     <span class="comment">#ç«¯å£ã€‚å¦‚æœåªæ£€æµ‹ç«¯å£ï¼Œé¡µé¢åˆ é™¤æ²¡æœ‰æ„ä¹‰ï¼Œä¸ä¼šæ‹‰èµ·</span></span><br><span class="line"></span><br><span class="line">1ã€åœ¨èµ„æºæ¸…å•æ·»åŠ å­˜æ´»æ€§æ¢é’ˆçš„æ£€éªŒåŠŸèƒ½</span><br><span class="line">[root@master01 kubernetes]# vim ivenssprobe.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: ivenssprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: ivenssprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å­˜æ´»æ€§æ¢é’ˆ&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    livenessProbe:</span><br><span class="line">      <span class="comment">#tcpSocketç‰ˆ</span></span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 80</span><br><span class="line">      </span><br><span class="line"><span class="comment">#ä¸€å®šè¦å†™ä¼˜åŒ–å‚æ•°</span></span><br><span class="line">      <span class="comment">#å»¶è¿Ÿæ—¶é—´3s</span></span><br><span class="line">      initialDelaySeconds: 3 </span><br><span class="line">      <span class="comment">#å®¹å™¨æ¯éš”2sæ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">      periodSeconds: 2</span><br><span class="line">      <span class="comment">#è¶…æ—¶æ—¶é—´ 1s</span></span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      <span class="comment">#æˆåŠŸä¹‹å3æ¬¡è¿ç»­å¤±è´¥ï¼Œæ‰æ˜¯çœŸå¤±è´¥ï¼Œç„¶åé‡æ–°å»æ‹‰èµ·ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨çš„æƒ…å†µ</span></span><br><span class="line">      failureThreshold: 3</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">2ã€åˆ é™¤æ—§podï¼Œè¿è¡Œæ–°pod</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod ivenssprobe-pod &amp;&amp; kubectl apply -f ivenssprobe.yml </span><br><span class="line">pod <span class="string">&quot;ivenssprobe-pod&quot;</span> deleted</span><br><span class="line">pod/ivenssprobe-pod created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod ivenssprobe-pod  -owide</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">ivenssprobe-pod   1/1     Running   0          8m58s   10.2.1.14   node01</span><br><span class="line"></span><br><span class="line">3ã€è¿æ¥è¿›å…¥å®¹å™¨ï¼Œæ–­å¼€ç«¯å£</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it ivenssprobe-pod -c nginx-container -- /bin/sh</span><br><span class="line">/ <span class="comment">#  nginx -s stop</span></span><br><span class="line">æ‰§è¡Œä¹‹åå®¹å™¨ä¼šè‡ªåŠ¨é€€å‡ºï¼Œå› ä¸ºå­˜æ´»æ€§æ¢é’ˆæ£€æµ‹åˆ°ç«¯å£ä¸è§äº†ï¼ŒæŠŠå°±å®¹å™¨åˆ é™¤ï¼Œå°±ä¼šè¢«å¼ºåˆ¶è¸¢å‡ºæ¥</span><br></pre></td></tr></table></figure><p>2ã€å°±ç»ªæ€§æ¢é’ˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å°±ç»ªæ€§æ¢é’ˆ(å°±ç»ªæ€æ¢é’ˆ) readnissprobe  </span></span><br><span class="line">å°±ç»ªæ€§æ¢é’ˆé…ç½®è¯­æ³•å’Œå­˜æ´»æ¢é’ˆåŸºæœ¬ä¸€æ ·</span><br><span class="line"></span><br><span class="line">æœ‰æ—¶å€™æˆ‘ä»¬Podæœ¬èº«å·²ç»èµ·æ¥äº†ï¼Œä½†æ˜¯podçš„å®¹å™¨è¿˜æ²¡æœ‰å®Œå…¨å‡†å¤‡å¥½å¯¹å¤–æä¾›æœåŠ¡ï¼Œé‚£ä¹ˆè¿™æ—¶å€™æµé‡è¿›æ¥å°±ä¼šé€ æˆè¯·æ±‚å¤±è´¥çš„æƒ…å†µå‡ºç°ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µk8sæœ‰ä¸€ç§æ¢é’ˆå«å°±ç»ªæ¢é’ˆï¼Œä»–çš„ä½œç”¨å°±æ˜¯è®©k8sçŸ¥é“ä½ çš„Podå†…åº”ç”¨æ˜¯å¦å‡†å¤‡å¥½ä¸ºè¯·æ±‚æä¾›æœåŠ¡ã€‚åªæœ‰å°±ç»ªæ¢é’ˆokäº†æ‰ä¼šæŠŠæµé‡è½¬å‘åˆ°podä¸Šã€‚</span><br><span class="line"></span><br><span class="line">åº”ç”¨åœºæ™¯ï¼šæ¯”å¦‚è¯´æ•°æ®åº“éœ€è¦åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–çš„æ—¶å€™é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œnginxå®¹å™¨èµ·æ¥çš„é€Ÿåº¦å¿«ï¼Œä½†æ˜¯æ•°æ®åº“æ²¡èµ·æ¥ï¼Œè®¿é—®è‚¯å®šæ˜¯502ï¼Œå°±å¥½æ¯”gitlab,nginxèµ·æ¥äº†ï¼Œç»„ä»¶æ²¡èµ·æ¥ï¼Œè®¿é—®æ˜¾ç¤º502ï¼Œå°±ç»ªæ¢é’ˆå°±æ˜¯ç­‰æ•°æ®èµ·æ¥ï¼Œæ‰å¯¹å¤–æä¾›æœåŠ¡(å°±æ˜¯æµè§ˆå™¨æ­£å¸¸è®¿é—®)</span><br><span class="line">ä½†æ˜¯æƒ³è¦æ£€æµ‹ï¼Œå°±è¦ç”¨åˆ°serviceèµ„æº</span><br></pre></td></tr></table></figure><p>ç¼–å†™èµ„æºæ¸…å•ï¼šéœ€æ±‚</p><p>nginxçš„podå¯åŠ¨ï¼Œå‰ææ¡ä»¶æ˜¯æ•°æ®åº“podä¹Ÿå¯åŠ¨èµ·æ¥ï¼Œå¹¶ä¸”æ•°æ®åº“å·²åˆå§‹åŒ–å®Œäº†ï¼Œç„¶åå†å¯¹å¤–æä¾›æœåŠ¡</p><ul><li>å°±ç»ªæ¢é’ˆ  execå‘½ä»¤ç‰ˆ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim readnessprobe.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: readnessprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: readnessprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /</span><br><span class="line">        port: 80</span><br><span class="line"><span class="comment">#å°±ç»ªæ€§æ¢é’ˆå†™æ³•</span></span><br><span class="line">    readinessProbe:</span><br><span class="line">      <span class="built_in">exec</span>:</span><br><span class="line"><span class="comment">#æ£€æµ‹æ–‡ä»¶æ˜¯å¦æœ‰å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰æ–‡ä»¶å°±æ²¡æœ‰å°±ç»ª</span></span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;cat /usr/share/nginx/html/healthy.html&quot;</span>]</span><br><span class="line">      </span><br><span class="line"><span class="comment">#ä¸€å®šè¦å†™ä¼˜åŒ–å‚æ•°</span></span><br><span class="line">      <span class="comment">#å»¶è¿Ÿæ—¶é—´3s</span></span><br><span class="line">      initialDelaySeconds: 3 </span><br><span class="line">      <span class="comment">#å®¹å™¨æ¯éš”2sæ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">      periodSeconds: 2</span><br><span class="line">      <span class="comment">#è¶…æ—¶æ—¶é—´ 1s</span></span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      <span class="comment">#æˆåŠŸä¹‹å3æ¬¡è¿ç»­å¤±è´¥ï¼Œæ‰æ˜¯çœŸå¤±è´¥ï¼Œç„¶åé‡æ–°å»æ‹‰èµ·ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨çš„æƒ…å†µ</span></span><br><span class="line">      failureThreshold: 3</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">ä½†æ˜¯ç°åœ¨æ²¡æœ‰/usr/share/nginx/html/healthy.htmlè¿™ä¸ªæ–‡ä»¶ï¼Œé‚£å®¹å™¨è‚¯å®šæ˜¯ä¸€ç›´ä¸å°±ç»ªçš„</span><br><span class="line"></span><br><span class="line">2ã€åˆ é™¤æ—§pod,åˆ›å»ºæ–°pod</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod ivenssprobe-pod</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f readnessprobe.yml </span><br><span class="line">pod/readnessprobe-pod created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod readnessprobe-pod -owide</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE   IP          NODE </span><br><span class="line">readnessprobe-pod   0/1     Running   0          69s   10.2.1.15   node01</span><br><span class="line"></span><br><span class="line">READYä¸€ç›´æ˜¾ç¤º0/1,ä¸€ç›´ä¸å°±ç»ªï¼Œå°±ä¸å¯¹å¤–æä¾›æµé‡ï¼Œä¸å¯¹å¤–æä¾›æµé‡ï¼Œä½†æ˜¯é¡µé¢å¯ä»¥è®¿é—®</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.1.15</span><br><span class="line"><span class="built_in">test</span> k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯¹å¤–æä¾›æµé‡å‰é¢è¦åŠ è´Ÿè½½å‡è¡¡å’Œç«¯å£æ˜ å°„ï¼Œå¾—ç”¨serviceè´Ÿè½½å‡ºæ¥</span></span><br><span class="line">3ã€ç¼–å†™serviceèµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# <span class="built_in">cp</span> ivenssprobe-service.yml readnessprobe-service.yml</span><br><span class="line">[root@master01 kubernetes]# vim readnessprobe-service.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: readnessprobe-service</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: readnessprobe</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">    <span class="comment">#ä¸èƒ½ç«¯å£å†²çªï¼Œæ‰€ä»¥ç«¯å£éœ€è¦æ”¹ä¸€ä¸‹</span></span><br><span class="line">    nodePort: 30001</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"></span><br><span class="line">4ã€å¯åŠ¨å¹¶æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f readnessprobe-service.yml</span><br><span class="line">service/readnessprobe-service created</span><br><span class="line">[root@master01 kubernetes]# kubectl get svc</span><br><span class="line">NAME                    TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes              ClusterIP   10.1.0.1      &lt;none&gt;        443/TCP        7d9h</span><br><span class="line">readnessprobe-service   NodePort    10.1.234.20   &lt;none&gt;        80:30001/TCP   17s</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1ã€æµ‹è¯•curl</span><br><span class="line">[root@master01 kubernetes]# curl 10.1.234.20</span><br><span class="line">curl: (7) Failed connect to 10.1.234.20:80; Connection refused</span><br><span class="line">æ²¡æœ‰ç»“æœï¼Œå› ä¸ºå°±ç»ªæ¢é’ˆæ²¡æœ‰å°±ç»ª</span><br><span class="line"></span><br><span class="line">2ã€åœ¨nodeèŠ‚ç‚¹æ˜ å°„çš„å®¿ä¸»æœºç›®å½•åˆ›å»ºå°±ç»ªæ–‡ä»¶</span><br><span class="line">[root@node01 ~]# <span class="built_in">touch</span> /data/nginx/healthy.html</span><br><span class="line"></span><br><span class="line">3ã€åˆ°masteræŸ¥çœ‹å°±ç»ªçŠ¶æ€ï¼Œå·²ç»å˜æˆå°±ç»ªå®Œæˆ</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod readnessprobe-pod -owide</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE   IP          NODE  </span><br><span class="line">readnessprobe-pod   1/1     Running   0          16m   10.2.1.15   node01</span><br><span class="line">[root@master01 kubernetes]#  curl 10.1.234.20</span><br><span class="line"><span class="built_in">test</span> k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe</span><br><span class="line"></span><br><span class="line">4ã€æ£€æŸ¥å·²ç»å¯¹å¤–æä¾›æœåŠ¡äº†</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240920201911358.png" alt="image-20240920201911358"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">5ã€åˆ é™¤å°±ç»ªæ–‡ä»¶ï¼Œcurlå¤±è´¥ï¼Œæœªå°±ç»ªï¼Œç½‘ç«™æ— æ³•è®¿é—®</span><br><span class="line">[root@node01 ~]# <span class="built_in">rm</span> -rf /data/nginx/healthy.html</span><br><span class="line">[root@master01 kubernetes]#  curl 10.1.234.20</span><br><span class="line">curl: (7) Failed connect to 10.1.234.20:80; Connection refused</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod readnessprobe-pod -owide</span><br><span class="line"></span><br><span class="line">podçš„ipå¯ä»¥é€šï¼Œä»£è¡¨å¯¹å†…æä¾›æœåŠ¡</span><br><span class="line">[root@master01 kubernetes]# curl 10.2.1.15</span><br><span class="line"><span class="built_in">test</span> k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¦‚ä¸Šæ˜¯å°±ç»ªæ¢é’ˆçš„ä½¿ç”¨æ–¹æ³•ï¼Œä½†æ˜¯æ­£å¸¸ä¸ä¼šè¿™æ ·å­åšï¼Œå°±åƒèµ·wp,å°±è¦æ£€æµ‹æ•°æ®åº“æœ‰æ²¡æœ‰å‡†å¤‡å¥½</span><br></pre></td></tr></table></figure><p>nginxå’Œmysqlï¼Œæ£€æµ‹mysqlæ˜¯å¦å°±ç»ªï¼Œå°±åƒå°±å¯¹å¤–æä¾›æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 kubernetes]# vim readness-mysql.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: readnessprobe-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: readnessprobe</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-data</span><br><span class="line">    hostPath:</span><br><span class="line">     path: /data/nginx</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"><span class="comment">#ä½¿ç”¨å¯åŠ¨é’©å­ç»™nginxä¸€ä¸ªåˆå§‹é¡µé¢ï¼Œåˆå§‹åŒ–å®¹å™¨æˆ–è€…å¯åŠ¨é’©å­éƒ½è¡Œï¼Œä¸ç„¶æŒ‚è½½å‡ºæ¥æ²¡é¡µé¢</span></span><br><span class="line">    lifecycle: </span><br><span class="line">      postStart: </span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;test k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /</span><br><span class="line">        port: 80</span><br><span class="line"><span class="comment">#å°±ç»ªæ€§æ¢é’ˆå†™æ³•  #è¦æ£€æµ‹æ•°æ®åªèƒ½ç”¨tcpsocket,é™¤éæ˜¯è¿™ä¸ªç½‘ç«™å¯åŠ¨è¦ä¾èµ–å…¶ä»–ç½‘ç«™å°±ç”¨httpGet:</span></span><br><span class="line">    readinessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 3306</span><br><span class="line">      </span><br><span class="line"><span class="comment">#ä¸€å®šè¦å†™ä¼˜åŒ–å‚æ•°ï¼Œå­˜æ´»æ€§æ¢é’ˆè®¾ç½®çš„é¢‘ç‡è¦æ¯”å°±ç»ªæ¢é’ˆæ…¢ä¸€äº›</span></span><br><span class="line">      <span class="comment">#å»¶è¿Ÿæ—¶é—´3s</span></span><br><span class="line">      initialDelaySeconds: 3 </span><br><span class="line">      <span class="comment">#å®¹å™¨æ¯éš”2sæ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">      periodSeconds: 2</span><br><span class="line">      <span class="comment">#è¶…æ—¶æ—¶é—´ 1s</span></span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      successThreshold: 3</span><br><span class="line">      <span class="comment">#æˆåŠŸä¹‹å3æ¬¡è¿ç»­å¤±è´¥ï¼Œæ‰æ˜¯çœŸå¤±è´¥ï¼Œç„¶åé‡æ–°å»æ‹‰èµ·ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨çš„æƒ…å†µ</span></span><br><span class="line">      failureThreshold: 3</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-data</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">  - name: mysql-container</span><br><span class="line">    image: mysql:5.7.44</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">    <span class="comment">#åé¢çš„ä¼˜åŒ–ï¼Œæ¢é’ˆå¯ä»¥ç»§ç»­å†™</span></span><br><span class="line"></span><br><span class="line">2ã€å¯åŠ¨æ£€æŸ¥</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f readness-mysql.yml</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod readnessprobe-pod</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">readnessprobe-pod   1/2     Running   0          62s</span><br><span class="line"></span><br><span class="line">1/2æ˜¯å› ä¸ºæ•°æ®åº“æ²¡æœ‰å†™å°±ç»ªæ¢é’ˆï¼Œå¦‚æœå†™äº†ï¼Œå°±æ˜¯0/2,æ•°æ®åº“çš„å°±ç»ªæ¢é’ˆå°±å†™æ£€æµ‹è‡ªå·±çš„3306ç«¯å£</span><br><span class="line">ç­‰å¾…ä¸€ä¼šï¼Œmysqlåˆå§‹åŒ–å®Œæˆå°±ç»ªå®Œæˆ</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod readnessprobe-pod</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">readnessprobe-pod   2/2     Running   0          18s</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl get svc </span><br><span class="line">NAME                    TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes              ClusterIP   10.1.0.1      &lt;none&gt;        443/TCP        7d10h</span><br><span class="line">readnessprobe-service   NodePort    10.1.234.20   &lt;none&gt;        80:30001/TCP   52m</span><br><span class="line">[root@master01 kubernetes]# curl 10.1.234.20</span><br><span class="line"><span class="built_in">test</span> k8s å°±ç»ªæ€§æ¢é’ˆreadnessprobe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å­˜æ´»æ¢é’ˆå’Œå°±ç»ªæ¢é’ˆåŒæ—¶å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œæ•°æ®åº“æ²¡æœ‰å‡†å¤‡å¥½å°±ä¸å°±ç»ªï¼Œé¡µé¢å°±ä¸€ç›´æ˜¯502ï¼Œå‡ºç°502ï¼Œå­˜æ´»æ¢é’ˆé¢‘ç‡é…é«˜äº†ï¼Œæ£€æµ‹åˆ°æœ‰é—®é¢˜å°±ä¼šé‡æ–°æ‹‰èµ·ï¼Œè¿™æ ·å°±è¿›å…¥æ­»å¾ªç¯ï¼Œå¦‚æœ2ä¸ªå®¹å™¨åœ¨ä¸€ä¸ªpodé‡Œï¼Œæ•°æ®æ°¸è¿œèµ·ä¸æ¥ï¼Œå› ä¸ºæŠŠpodåˆ äº†ï¼Œä¼šé‡æ–°åˆ›å»ºï¼Œè¿›å…¥æ­»å¾ªç¯ï¼Œæ‰€ä»¥å­˜æ´»æ¢é’ˆè¦æ¯”å°±ç»ªæ¢é’ˆè®¾ç½®çš„é¢‘ç‡æ…¢</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ä¸€ï¼šwordpressé•œåƒ</span><br><span class="line">åœ¨ä¸€ä¸ªPODé‡Œå¯åŠ¨ä¸¤ä¸ªå®¹å™¨</span><br><span class="line">- wordpress</span><br><span class="line">- mysql5.7</span><br><span class="line">1.å°±ç»ªæ€§æ¢é’ˆ</span><br><span class="line">2.å­˜æ´»æ€§æ¢é’ˆ</span><br><span class="line">3.å¯åŠ¨é’©å­</span><br><span class="line">4.åœæ­¢é’©å­</span><br><span class="line">5.åˆå§‹åŒ–å®¹å™¨</span><br><span class="line"></span><br><span class="line">äºŒï¼šå°è¯• wordpress å¯åŠ¨ä¸€ä¸ªPOD</span><br><span class="line">MySQLå•ç‹¬å¯åŠ¨åœ¨ä¸€ä¸ªPODé‡Œ,å¦‚ä½•è¿æ¥ï¼Œæ‰èƒ½è®©ç½‘ç«™èƒ½å¤Ÿæ­£å¸¸è®¿é—®</span><br><span class="line"></span><br><span class="line">ä¸‰ï¼šå°è¯• nginx å’Œ phpç¯å¢ƒåˆ†å¼€è£…ï¼Œéƒ¨ç½²ä»£ç </span><br><span class="line">fastcgi_pass unix://dev/shm/php.sock</span><br><span class="line"></span><br><span class="line">ä¸€å¼€å§‹æ˜¯è¿™æ ·å­å†™çš„fastcgi_pass 127.0.0.1:9000ï¼Œä½†æ˜¯ç°åœ¨è¦åˆ†å¼€å®‰è£…ï¼Œå°±è¦å†™å†…å¤–ip  fastcgi_pass 172.16.1.8:9000</span><br><span class="line">æµ‹è¯•ï¼Œä¸Šä¼ å›¾ç‰‡</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ä½¿ç”¨èµ„æºæ¸…å•ç¼–å†™åˆå§‹åŒ–å®¹å™¨ï¼Œé’©å­ï¼Œæ¢é’ˆ</summary>
    
    
    
    <category term="k8s" scheme="https://www.fomal.cc/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰4ã€æ ‡ç­¾çš„è®¾ç½®åŠä½¿ç”¨</title>
    <link href="https://www.fomal.cc/posts/4666867d.html"/>
    <id>https://www.fomal.cc/posts/4666867d.html</id>
    <published>2024-09-22T06:45:27.000Z</published>
    <updated>2024-09-30T07:54:39.509Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ ‡ç­¾çš„è®¾ç½®åŠä½¿ç”¨">æ ‡ç­¾çš„è®¾ç½®åŠä½¿ç”¨</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">kubectl get  [èµ„æº] -n [åç§°ç©ºé—´] --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹nodeæ ‡ç­¾</span></span><br><span class="line">[root@master01 ~]# kubectl get nodes --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹podçš„æ ‡ç­¾</span></span><br><span class="line">[root@master01 ~]# kubectl get  pod -n kube-flannel --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç»™nodeæ‰“æ ‡ç­¾</span></span><br><span class="line">[root@master01 ~]# kubectl label node node01 MEM=16G</span><br><span class="line">node/node01 labeled</span><br><span class="line">[root@master01 ~]# kubectl get nodes --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç»™nodeæ‰“è§’è‰²æ ‡ç­¾ï¼šä¸ºäº†åŒºåˆ†é¡¹ç›®åï¼Œæˆ–è€…é…ç½®</span></span><br><span class="line">node-role  è§’è‰²æ ‡ç­¾çš„æ¥å£</span><br><span class="line">node-role.kubernetes.io  æ ‡è¯†è°ƒè§’è‰²æ ‡ç­¾çš„æ¥å£</span><br><span class="line">=å˜æˆ-å·ï¼Œå°±æ˜¯åˆ é™¤è§’è‰²æ ‡ç­¾  node-</span><br><span class="line">node=  ï¼šè¡¨ç¤ºç»™è§’è‰²æ‰“çš„æ ‡ç­¾åå«node</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl label node node01 node-role.kubernetes.io/node=</span><br><span class="line">[root@master01 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS   ROLES    AGE     VERSION</span><br><span class="line">master01   Ready    master   5d23h   v1.19.3</span><br><span class="line">node01     Ready    node     5d23h   v1.19.3</span><br><span class="line">node02     Ready    node     5d23h   v1.19.3</span><br><span class="line">node03     Ready    node     5d23h   v1.19.3</span><br></pre></td></tr></table></figure><p><font color=red><strong>ç»™podæ‰“æ ‡ç­¾çš„æ–¹æ³•ï¼šÂ  Â  å¦‚æœä¸èµ„æºæ¸…å•é‡Œé¢ä¸å†™æ ‡ç­¾ï¼Œèµ·æ¥çš„podå°±æ²¡æœ‰æ ‡ç­¾ï¼Œä¸ä¼šå­˜åœ¨é»˜è®¤æ ‡ç­¾çš„è¯´æ³•ï¼Œæ‰€ä»¥èµ„æºæ¸…å•é‡Œé¢ä¸€å®šè¦å†™æ ‡ç­¾</strong></font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç»™podæ‰“æ ‡ç­¾ä¸ºäº†ä»¥åé€šä¿¡ç”¨</span></span><br><span class="line">æ–¹æ³•ä¸€ï¼š</span><br><span class="line">ä½¿ç”¨å‘½ä»¤æ‰“æ ‡ç­¾ï¼š(ä¸€èˆ¬å¾ˆå°‘ç”¨å‘½ä»¤æ‰“æ ‡ç­¾ï¼Œä»¥åèµ·podæ˜¯ç”¨èµ„æºæ¸…å•çš„ï¼Œæ‰€ä»¥åœ¨èµ„æºæ¸…å•é‡Œé¢æ‰“æ ‡ç­¾æ¯”è¾ƒå¸¸ç”¨)</span><br><span class="line">[root@master01 ~]# kubectl label pod kube-flannel-ds-4ncf5 run=flannel -n kube-flannel </span><br><span class="line">kube-flannel-ds-4ncf5ï¼šPodå</span><br><span class="line">run=flannelï¼šæ ‡ç­¾å</span><br><span class="line">kube-flannelï¼šåç§°ç©ºé—´</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ–¹æ³•äºŒï¼š</span><br><span class="line"><span class="comment">#ç»™Podæ‰“æ ‡ç­¾(ç”¨èµ„æºæ¸…å•æ‰“ï¼Œæ¯”è¾ƒå¸¸ç”¨)</span></span><br><span class="line">[root@master01 kubernetes]# vim nginx-label.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata: </span><br><span class="line">  name: nginx-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    run: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx:alpine</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">è¿è¡Œèµ„æºæ¸…å• </span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-label.yml </span><br><span class="line">æŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod --show-labels</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">nginx-pod      1/1     Running   0          23s   run=nginx</span><br></pre></td></tr></table></figure><p>å°†podèµ·åˆ°æŒ‡å®šçš„nodeä¸Š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">ä¸Šé¢æ‰§è¡Œäº†å‘½ä»¤ç»™node01æ‰“MEM=16Gçš„æ ‡ç­¾</span><br><span class="line">[root@master01 ~]# kubectl label node node01 MEM=16G</span><br><span class="line"></span><br><span class="line">å°†podèµ·åœ¨MEM=16çš„èŠ‚ç‚¹ä¸Š</span><br><span class="line"><span class="comment">#å¯åŠ¨podåœ¨æŒ‡å®šæ ‡ç­¾çš„nodeä¸Š</span></span><br><span class="line">[root@master01 kubernetes]# vim nginx2-label.yml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata: </span><br><span class="line">  name: nginx-pod-v2</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    run: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container-v2</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="comment">#å°†podèµ·åœ¨MEM=16çš„èŠ‚ç‚¹ä¸Š</span></span><br><span class="line">  nodeSelector:</span><br><span class="line">    MEM: 16G</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">#(ä¸€èˆ¬æ¥è¯´ä¸å†™å¦‚ä¸‹å†…å®¹ï¼Œå› ä¸ºk8sä¼šåšèµ„æºè®¡ç®—å’Œè°ƒåº¦ï¼Œä½†æ˜¯åœ¨èµ·redisæˆ–è€…æ•°æ®åº“è¿™ç§podçš„æ—¶å€™ï¼Œä»–ä¸¤å¯¹å†…å­˜çš„ä½¿ç”¨æ¯”è¾ƒå¤§ï¼Œå»ºè®®ä¸è¦èµ·åœ¨åŒä¸€ä¸ªæœºå™¨ä¸Šï¼Œè¿™ä¸ªæƒ…å†µå°±è¦ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤äº†ï¼Œé¿å…k8sè‡ªå·±èµ„æºè®¡ç®—ï¼Œå°†redisã€mysqlèµ·åœ¨åŒä¸€ä¸ªæœºå™¨) </span></span><br><span class="line">  nodeSelector:</span><br><span class="line">    MEM: 16G</span><br><span class="line"> </span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx2-label.yml </span><br><span class="line">pod/nginx-pod-v2 created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-pod                1/1     Running   0          17m</span><br><span class="line">nginx-pod-v2             1/1     Running   0          32s</span><br><span class="line">æŸ¥çœ‹èµ·åœ¨node01ä¸Šçš„</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod nginx-pod-v2  -o wide</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE     IP         NODE  </span><br><span class="line">nginx-pod-v2   1/1     Running   0          6m26s   10.2.1.4   node01</span><br></pre></td></tr></table></figure><p>åˆ é™¤æ ‡ç­¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">1ã€å…ˆæŸ¥çœ‹</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod --show-labels</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">nginx-pod                1/1     Running   0          31m   run=nginx</span><br><span class="line">nginx-pod-v2             1/1     Running   0          14m   run=nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#åˆ é™¤æ ‡ç­¾</span><br><span class="line">kubectl label [èµ„æº] [èµ„æºå] [æ ‡ç­¾å/æ ‡ç­¾key]-</span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# kubectl label pod nginx-pod-v2 run-</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod --show-labels</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">nginx-pod                1/1     Running   0          32m   run=nginx</span><br><span class="line">nginx-pod-v2             1/1     Running   0          15m   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ ¹æ®æ ‡ç­¾æŸ¥æ‰¾pod</span></span><br><span class="line">3ã€æŸ¥çœ‹å“ªäº›podæ‰“äº†run=nginxçš„æ ‡ç­¾ï¼Œæ‰“äº†è¿™ä¸ªæ ‡ç­¾çš„éƒ½ä¼šè¢«åˆ—å‡ºæ¥</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -l run=nginx</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-pod   1/1     Running   0          35m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ ¹æ®æ ‡ç­¾åˆ é™¤pod</span></span><br><span class="line">4ã€æ‰“äº†æ ‡ç­¾æ¯”è¾ƒæ–¹ä¾¿ï¼Œå¯ä»¥æ ¹æ®æ ‡ç­¾å»ç­›é€‰ï¼Œè¿˜å¯ä»¥æ ¹æ®æ ‡ç­¾å»åˆ é™¤pod</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod -l run=nginx</span><br><span class="line">pod <span class="string">&quot;nginx-pod&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">  ä½†æ˜¯ä¸€ä¸ªpodé‡Œé¢èµ·2ä¸ªå®¹å™¨æ€ä¹ˆè¿</span><br><span class="line">  -c æ°¸è¿œåªæœ‰3ä¸ªå¼•å·</span><br><span class="line">  é»˜è®¤è¿ç¬¬ä¸€ä¸ªå®¹å™¨</span><br><span class="line">  -cæŒ‡å®šå®¹å™¨å</span><br><span class="line">  <span class="comment">#å½“ä¸€ä¸ªpodä¸­æœ‰å¤šä¸ªå®¹å™¨æ—¶</span></span><br></pre></td></tr></table></figure><p>è¿æ¥åˆ°pod     å®¹å™¨å¯ä»¥ä½¿ç”¨å‘½ä»¤è¿æ¥è¿›å»ï¼Œpodä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤è¿æ¥è¿›å»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¿æ¥åˆ°ä¸€ä¸ªpod</span></span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it  nginx-pod-v2 -- /bin/sh</span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">bin           etc  </span><br><span class="line"></span><br><span class="line">--ï¼šç›¸å½“äºåˆ†éš”ç¬¦,--åé¢çš„æ‰€æœ‰éƒ½æ˜¯å‘½ä»¤</span><br><span class="line"></span><br><span class="line"><span class="comment">#é—®é¢˜ï¼šä¸€ä¸ªpodé‡Œé¢èµ·2ä¸ªå®¹å™¨æ€ä¹ˆè¿ï¼Ÿ</span></span><br><span class="line">1ã€ç¼–å†™ä¸€ä¸ªpodèµ·2ä¸ªå®¹å™¨çš„èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim nginx-busybox.yml</span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox-container</span><br><span class="line">    image: busybox</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line"> <span class="comment">#-cï¼šè¡¨ç¤ºæ°¸è¿œåªæœ‰3ä¸ªå¼•å·ï¼Œç¬¬3ä¸ªå¼•å·å¯ä»¥å†™é•¿çš„å‘½ä»¤</span></span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œpod,å¹¶æŸ¥çœ‹podæ˜¯å¦èµ·æ¥ï¼ŒæŸ¥çœ‹podèµ·åœ¨å“ªä¸ªæœºå™¨</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f nginx-busybox.yml </span><br><span class="line">pod/nginx-busybox created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-5f5d9d69c4-d8hvx   1/1     Running   0          19h</span><br><span class="line">nginx-busybox            2/2     Running   0          8s</span><br><span class="line">nginx-pod-v2             1/1     Running   0          43m</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod nginx-busybox -o wide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE     IP         NODE  </span><br><span class="line">nginx-busybox   2/2     Running   0          3m34s   10.2.2.5   node02</span><br><span class="line"></span><br><span class="line">3ã€è¿æ¥è¿›å…¥å®¹å™¨</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it nginx-busybox -- /bin/sh</span><br><span class="line">/ <span class="comment"># ls -l /usr</span></span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x    2 root     root            17 May 18  2023 bin</span><br><span class="line">drwxr-xr-x    2 daemon   daemon           6 May 18  2023 sbin</span><br><span class="line"></span><br><span class="line">è¯¥ç›®å½•æ²¡æœ‰ç«™ç‚¹ç›®å½•ï¼Œæ‰€ä»¥è¿›å»çš„busyboxå®¹å™¨ï¼Œæ‰€ä»¥é»˜è®¤è¿ç¬¬ä¸€ä¸ªå®¹å™¨</span><br><span class="line"></span><br><span class="line">4ã€å¦‚æœéœ€è¦è¿æ¥æŒ‡å®šçš„å®¹å™¨ï¼Œéœ€è¦ä½¿ç”¨é€‰é¡¹-cæŒ‡å®š</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it nginx-busybox -c nginx-container -- /bin/sh</span><br><span class="line">/ <span class="comment"># ls -l /usr/share/nginx/html/</span></span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--    1 root     root           497 Aug 14 06:12 50x.html</span><br><span class="line">-rw-r--r--    1 root     root           615 Aug 14 06:12 index.html</span><br><span class="line"></span><br><span class="line">-cï¼šè¿æ¥åˆ°æŒ‡å®šçš„å®¹å™¨å</span><br><span class="line"></span><br><span class="line">ä½œç”¨ï¼šk8såªéœ€è¦åœ¨masterä¸Šæ“ä½œï¼Œå°±å¯ä»¥è¿åˆ°éœ€è¦è¿çš„å®¹å™¨</span><br></pre></td></tr></table></figure><h2 id="2ã€é‡æ–°è®¤è¯†Pod">2ã€<strong>é‡æ–°è®¤è¯†Pod</strong></h2><p>å…±äº«ç½‘ç»œ</p><p><img src="../image/study_img/image-20240919110354547.png" alt="image-20240919110354547"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1ã€Podå†…çš„å®¹å™¨ä½¿ç”¨Containeræ¨¡å¼å…±äº«æ ¹å®¹å™¨çš„ç½‘ç»œ</span><br><span class="line">2ã€å®¹å™¨çœ‹åˆ°çš„ç½‘ç»œè®¾å¤‡ä¿¡æ¯å’Œæ ¹å®¹å™¨å®Œå…¨ç›¸åŒ</span><br><span class="line">3ã€Podå†…çš„å¤šä¸ªå®¹å™¨å¯ä»¥ä½¿ç”¨localhostè¿›è¡Œç½‘ç»œé€šè®¯</span><br><span class="line">4ã€Podå†…çš„å¤šä¸ªå®¹å™¨ä¸èƒ½ç»‘å®šç›¸åŒçš„ç«¯å£</span><br><span class="line">5ã€Podçš„ç”Ÿå‘½å‘¨æœŸå’Œæ ¹å®¹å™¨ä¸€æ ·ï¼Œå¦‚æœæ ¹å®¹å™¨é€€å‡ºï¼ŒPodå°±é€€å‡º</span><br></pre></td></tr></table></figure><h2 id="3ã€å…±äº«æ–‡ä»¶ç³»ç»Ÿ">3ã€<strong>å…±äº«æ–‡ä»¶ç³»ç»Ÿ</strong></h2><h3 id="1ã€æœ¬åœ°å…±äº«å‚¨å­˜">1ã€<strong>æœ¬åœ°å…±äº«å‚¨å­˜</strong></h3><p><img src="../image/study_img/image-20240919165826698.png" alt="image-20240919165826698"></p><p>ç¬¬ä¸€ç§ï¼šhostPath  æœ¬åœ°çš„æ˜ å°„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim wp.yml</span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: mysql57-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: mysql57</span><br><span class="line">    run: mysql57</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#è®¾ç½®æŒ‚è½½æ˜ å°„çš„å†™æ³•   æŒ‡å®šå®¿ä¸»æœºçš„æŒ‚è½½ç›®å½•</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: mysql-data       <span class="comment">#åå­—ä¸€å®šè¦å†™ï¼Œè®¾ç½®æŒ‚è½½çš„å˜é‡ï¼Œç›¸å½“äºå˜é‡å</span></span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/mysql    <span class="comment">#å®¿ä¸»æœºçš„ç›®å½•ï¼Œç›¸å½“äºå˜é‡å€¼</span></span><br><span class="line">  - name: test-data</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /opt/test</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: mysql57-container</span><br><span class="line">    image: mysql:5.7.44</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line">    - name: MYSQL_DATABASE</span><br><span class="line">      value: <span class="string">&quot;wp_db&quot;</span></span><br><span class="line">    - name: MYSQL_USER</span><br><span class="line">      value: <span class="string">&quot;wp_user&quot;</span></span><br><span class="line">    - name: MYSQL_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="comment">#æŒ‡å®šå­—ç¬¦é›†çš„å†™æ³•</span></span><br><span class="line">    args:</span><br><span class="line">    - --character-set-server=utf8mb4</span><br><span class="line">    - --collation-server=utf8mb4_unicode_ci</span><br><span class="line"><span class="comment">#å®¹å™¨é‡Œé¢çš„ç›®å½•æŒ‚è½½å‡ºæ¥çš„å†™æ³•</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: mysql-data             <span class="comment">#ç°åœ¨å®¹å™¨çš„ç›®å½•è¦æŒ‚åˆ°å®¿ä¸»æœºçš„å“ªä¸ªç›®å½•ï¼Œå°±å†™å®¿ä¸»æœºç›®å½•çš„å˜é‡å</span></span><br><span class="line">      mountPath: /var/lib/mysql    <span class="comment">#è¿™é‡Œå†™å®¹å™¨é‡Œéœ€è¦æŒ‚å‡ºæ¥çš„ç›®å½•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br><span class="line">--xxxä¸€èˆ¬ç”¨args</span><br><span class="line">å¦‚æœæ˜¯ä¸€æ¡å®Œæ•´çš„å‘½ä»¤å°±ç”¨<span class="built_in">command</span></span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œèµ„æºæ¸…å•ï¼Œå¹¶æŸ¥çœ‹podè¿è¡Œçš„node</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f mysql.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">mysql57-pod              1/1     Running   0          3m42s   10.2.3.14   node03</span><br><span class="line"></span><br><span class="line">3ã€åˆ°node03èŠ‚ç‚¹æŸ¥çœ‹ç›®å½•æ˜¯å¦æ˜ å°„</span><br><span class="line">[root@node03 ~]# ll /data/mysql/</span><br><span class="line">-rw-r----- 1 polkitd input       56 Sep 19 18:29 auto.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç›®å½•æ˜ å°„å‡ºæ¥äº†ï¼Œå¦‚æœmysqlæŒ‚äº†ï¼Œå†æ‹‰èµ·ï¼Œæ•°æ®æ˜¯å­˜åœ¨çš„ï¼Œå¦‚æœä¸åšæ˜ å°„ï¼Œk8sè‡ªåŠ¨æ‹‰èµ·ï¼Œæ•°æ®å°±ä¼šå…¨éƒ¨æ²¡æœ‰</span></span><br><span class="line"></span><br><span class="line">å®¹å™¨é‡Œé¢mysqlç”¨æˆ·çš„uid gidéƒ½æ˜¯999ï¼Œå®¿ä¸»æœºä¸Šuidä¸º999çš„æ˜¯polkitd,gidä¸º999çš„æ˜¯inputï¼Œç³»ç»Ÿåªè®¤IDï¼Œä¸è®¤å­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²æ˜¯ç»™äººçœ‹çš„ï¼ŒçŸ¥é“åå­—å°±æ›´å¥½åŒºåˆ†</span><br><span class="line"></span><br><span class="line">4ã€è¿æ¥åˆ°å®¹å™¨é‡Œé¢æ£€æŸ¥</span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it pod/mysql57-pod -- /bin/sh</span><br><span class="line">sh-4.2# mysql -uroot -p123</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">mysql&gt; <span class="keyword">select</span> host,user from mysql.user;</span><br><span class="line">mysql&gt; show create database wp_db;</span><br><span class="line">sh-4.2# mysql -uwp_user -p123</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">Value</th><th style="text-align:left">Behavior</th></tr></thead><tbody><tr><td style="text-align:left"><code>â€Œ&quot;&quot;</code></td><td style="text-align:left">é»˜è®¤ä¸éœ€è¦åˆ›å»ºï¼Œä¼šè‡ªåŠ¨åˆ›å»º</td></tr><tr><td style="text-align:left"><code>DirectoryOrCreate</code></td><td style="text-align:left">ç›®å½•å¿…é¡»å­˜åœ¨ï¼Œæƒé™å¿…é¡»æ˜¯755</td></tr><tr><td style="text-align:left"><code>Directory</code></td><td style="text-align:left">ç›®å½•å¿…é¡»å­˜åœ¨</td></tr><tr><td style="text-align:left"><code>FileOrCreate</code></td><td style="text-align:left">æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œæƒé™å¿…é¡»æ˜¯644</td></tr><tr><td style="text-align:left"><code>File</code></td><td style="text-align:left">æ–‡ä»¶å¿…é¡»å­˜åœ¨</td></tr><tr><td style="text-align:left"><code>Socket</code></td><td style="text-align:left">æŒ‚è½½socketæ–‡ä»¶</td></tr><tr><td style="text-align:left"><code>CharDevice</code></td><td style="text-align:left">æŒ‚è½½å­—ç¬¦è®¾å¤‡æ–‡ä»¶ï¼ˆé”®ç›˜ï¼Œé¼ æ ‡ï¼Œç»ˆç«¯â€¦ï¼‰</td></tr><tr><td style="text-align:left"><code>BlockDevice</code></td><td style="text-align:left">æŒ‚è½½å¿«è®¾å¤‡æ–‡ä»¶ï¼ˆç£ç›˜ï¼ŒUç›˜ï¼Œç§»åŠ¨ç¡¬ç›˜â€¦ï¼‰</td></tr></tbody></table><p>ç¬¬äºŒç§ï¼šemptyDir</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# vim wp.yml</span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: mysql57-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: mysql57</span><br><span class="line">    run: mysql57</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#è®¾ç½®æŒ‚è½½æ˜ å°„çš„å†™æ³•   æŒ‡å®šå®¿ä¸»æœºçš„æŒ‚è½½ç›®å½•</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: mysql-data       <span class="comment">#åå­—ä¸€å®šè¦å†™ï¼Œè®¾ç½®æŒ‚è½½çš„å˜é‡ï¼Œç›¸å½“äºå˜é‡å</span></span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/mysql    <span class="comment">#å®¿ä¸»æœºçš„ç›®å½•ï¼Œç›¸å½“äºå˜é‡å€¼</span></span><br><span class="line">  - name: empty-data</span><br><span class="line">    emptyDir: &#123;&#125;           <span class="comment">#é»˜è®¤æ˜¯ç©ºçš„è¯å°±å†™&#123;&#125;</span></span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: mysql57-container</span><br><span class="line">    image: mysql:5.7.44</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line">    - name: MYSQL_DATABASE</span><br><span class="line">      value: <span class="string">&quot;wp_db&quot;</span></span><br><span class="line">    - name: MYSQL_USER</span><br><span class="line">      value: <span class="string">&quot;wp_user&quot;</span></span><br><span class="line">    - name: MYSQL_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="comment">#æŒ‡å®šå­—ç¬¦é›†çš„å†™æ³•</span></span><br><span class="line">    args:</span><br><span class="line">    - --character-set-server=utf8mb4</span><br><span class="line">    - --collation-server=utf8mb4_unicode_ci</span><br><span class="line"><span class="comment">#å®¹å™¨é‡Œé¢çš„ç›®å½•æŒ‚è½½å‡ºæ¥çš„å†™æ³•</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: empty-data             <span class="comment">#ç°åœ¨å®¹å™¨çš„ç›®å½•è¦æŒ‚åˆ°å®¿ä¸»æœºçš„å“ªä¸ªç›®å½•ï¼Œå°±å†™å®¿ä¸»æœºç›®å½•çš„å˜é‡å</span></span><br><span class="line">      mountPath: /var/lib/mysql    <span class="comment">#è¿™é‡Œå†™å®¹å™¨é‡Œéœ€è¦æŒ‚å‡ºæ¥çš„ç›®å½•</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€åˆ é™¤node03çš„dataç›®å½•</span><br><span class="line">[root@node03 ~]# <span class="built_in">rm</span> -rf /data/mysql/</span><br><span class="line"></span><br><span class="line">3ã€åˆ é™¤ä¸Šä¸€æ¬¡å®éªŒèµ·çš„pod,é‡æ–°è¿è¡Œèµ„æºæ¸…å•</span><br><span class="line">[root@master01 kubernetes]# kubectl delete pod  mysql57-pod</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f mysql.yml </span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">mysql57-pod              1/1     Running   0          59s     10.2.3.24   node03</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€æŸ¥è¯¢æ˜ å°„çš„datamç›®å½•</span><br><span class="line">[root@node03 ~]# docker inspect 1dd8436185b0</span><br><span class="line"><span class="comment">#æŸ¥æ‰¾Mounts</span></span><br><span class="line"><span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/kubelet/pods/b3994de1-53ba-4ccf-b3b1-a7bdc8f1b08d/volumes/kubernetes.io~empty-dir/empty-data&quot;</span>,</span><br><span class="line"></span><br><span class="line">[root@node03 ~]# ll /var/lib/kubelet/pods/b3994de1-53ba-4ccf-b3b1-a7bdc8f1b08d/volumes/kubernetes.io~empty-dir/empty-data</span><br><span class="line">total 188484</span><br><span class="line">-rw-r----- 1 polkitd input       56 Sep 19 20:05 auto.cnf</span><br><span class="line"></span><br><span class="line">emptyDir: &#123;&#125;</span><br><span class="line">åªæ˜¯ä¸´æ—¶ä½¿ç”¨ï¼šéšæœºçš„ä¸´æ—¶ç›®å½•  å®¹å™¨åˆ é™¤ï¼Œè¿™ä¸ªç›®å½•å°±ä¼šè¢«åˆ é™¤ï¼Œåšä¸åˆ°æŒä¹…åŒ–</span><br><span class="line"></span><br><span class="line">ä½œç”¨ï¼šåœ¨åŒä¸€ä¸ªPodé‡Œ,2ä¸ªå®¹å™¨ä¹‹é—´çš„æ–‡ä»¶æ˜¯äº’ç›¸éš”ç¦»çš„ï¼Œæƒ³è®©ä»–ä»¬äº’é€šæŸä¸ªç›®å½•å°±å¯ä»¥ä½¿ç”¨åˆ°ï¼Œè®©2ä¸ªå®¹å™¨åŒæ—¶éƒ½æŒ‚è½½åˆ°è¿™ä¸ªç›®å½•ï¼Œè¿™æ ·å­è¿™ä¸¤ä¸ªå®¹å™¨å°±æ‰¾åˆ°å…±äº«è¿™ä¸ªç›®å½•</span><br></pre></td></tr></table></figure><p>å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•</span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: c7-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: empty-data</span><br><span class="line">    emptyDir: &#123;&#125; </span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: empty-data</span><br><span class="line">      mountPath: /usr/share/nginx/html     </span><br><span class="line">      <span class="comment">#è®©busyboxæŒ‚åˆ°å®¿ä¸»æœºçš„éšæœºç›®å½•</span></span><br><span class="line"> </span><br><span class="line">  - name: c7-container</span><br><span class="line">    image: centos:7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /etc/hosts&quot;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: empty-data</span><br><span class="line">      mountPath: /opt/html    </span><br><span class="line">      <span class="comment">#è®©c7æŒ‚åˆ°å®¿ä¸»æœºçš„éšæœºç›®å½•</span></span><br><span class="line">      <span class="comment">#éƒ½æ˜¯æŒ‚åˆ°å®¿ä¸»æœºçš„ä¸´æ—¶ç›®å½•ï¼Œè¿™ä¸¤ä¸ªç›®å½•é‡Œé¢çš„æ–‡ä»¶è‚¯å®šæ˜¯äº’é€šçš„</span></span><br><span class="line">      </span><br><span class="line">2ã€è¿è¡Œèµ„æºæ¸…å•ï¼Œå¹¶æŸ¥çœ‹podè¿è¡Œçš„node</span><br><span class="line">[root@master01 kubernetes]# kubectl apply -f c7-busybox-emptyDir.yml </span><br><span class="line">pod/c7-nginx created</span><br><span class="line">[root@master01 kubernetes]# kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP          NODE  </span><br><span class="line">c7-nginx                 2/2     Running   0          5s      10.2.3.30   node03</span><br><span class="line"></span><br><span class="line">3ã€æµ‹è¯•2ä¸ªå®¹å™¨æ˜¯å¦å…±äº«äº†ç›®å½•</span><br><span class="line">[root@node03 ~]# docker inspect dbb9f576eacd</span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/kubelet/pods/bed3c777-7aff-4593-a7bc-f2bc3ed47827/volumes/kubernetes.io~empty-dir/empty-data&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/opt/html&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;rprivate&quot;</span></span><br><span class="line">                </span><br><span class="line">4ã€æŸ¥çœ‹æŒ‚è½½çš„éšæœºç›®å½•ï¼Œæ˜¯ç©ºçš„               </span><br><span class="line">[root@node03 ~]# ll /var/lib/kubelet/pods/bed3c777-7aff-4593-a7bc-f2bc3ed47827/volumes/kubernetes.io~empty-dir/empty-data</span><br><span class="line">total 0     </span><br><span class="line"></span><br><span class="line">5ã€è¿è¿›å®¹å™¨é‡Œé¢æŸ¥çœ‹æŒ‚è½½ç›®å½•ï¼Œæ˜¯ç©ºçš„  </span><br><span class="line">[root@master01 kubernetes]# kubectl <span class="built_in">exec</span> -it c7-nginx -c nginx-container -- /bin/sh</span><br><span class="line">/ <span class="comment"># ls -l /usr/share/nginx/html/</span></span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl <span class="built_in">exec</span> -it c7-nginx -c c7-container -- /bin/bash</span><br><span class="line">[root@c7-nginx /]# <span class="built_in">ls</span> -l /opt/html/</span><br><span class="line">total 0</span><br><span class="line"></span><br><span class="line">6ã€è¿›å…¥éšæœºç›®å½•ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ–‡ä»¶</span><br><span class="line">[root@node03 ~]# <span class="built_in">cd</span> /var/lib/kubelet/pods/bed3c777-7aff-4593-a7bc-f2bc3ed47827/volumes/kubernetes.io~empty-dir/empty-data</span><br><span class="line">[root@node03 empty-data]# <span class="built_in">echo</span> <span class="string">&quot;test å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•&quot;</span> &gt; index.html</span><br><span class="line"></span><br><span class="line">7ã€è¿›å…¥å®¹å™¨ï¼ŒæŸ¥çœ‹æ–‡ä»¶å¯ä»¥çœ‹åˆ°2ä¸ªå®¹å™¨éƒ½å¯ä»¥çœ‹åˆ°åˆ›å»ºçš„æ–‡ä»¶å†…å®¹</span><br><span class="line">/ <span class="comment"># cat /usr/share/nginx/html/index.html </span></span><br><span class="line"><span class="built_in">test</span> å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•</span><br><span class="line">/ <span class="comment"># curl 127.0.0.1</span></span><br><span class="line"><span class="built_in">test</span> å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•</span><br><span class="line"></span><br><span class="line">[root@c7-nginx /]# <span class="built_in">cat</span> /opt/html/index.html </span><br><span class="line"><span class="built_in">test</span> å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•</span><br><span class="line">[root@c7-nginx /]# curl 127.0.0.1</span><br><span class="line"><span class="built_in">test</span> å°†ä¸€ä¸ªPODå†…çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›®å½•</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å½“Podç»“æŸäº†ï¼Œå…±äº«å°±ç»“æŸäº†ï¼Œå¦‚æœæ•°æ®å¾ˆé‡è¦ï¼Œéœ€è¦æŒä¹…åŒ–ï¼ŒemptyDirå°±ä¸å»ºè®®ä½¿ç”¨ï¼Œå°±ä½¿ç”¨Hostoath</span></span><br><span class="line"></span><br><span class="line">ä¸€ä¸ªpodèµ·åœ¨node02,ä¸€ä¸ªèµ·åœ¨node03,åªèƒ½ç”¨nfså…±äº«</span><br><span class="line"></span><br><span class="line"><span class="built_in">command</span>åé¢çš„å‘½ä»¤ä¼šè®©å®¹å™¨æŠŠåé¢çš„å‘½ä»¤å½“åˆPIDä¸º1çš„è¿›ç¨‹ï¼Œé‚£æ¡å‘½ä»¤ç»“æŸï¼Œè¿›ç¨‹å°±ç»“æŸäº†</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">æ¯”å¦‚è¯´æƒ³æ”¹nginxç«¯å£ï¼Œæƒ³ç”¨8080ï¼Œç”¨èµ„æºæ¸…å•æ€ä¹ˆæ”¹é…ç½®æ–‡ä»¶</span><br><span class="line">podä¸èƒ½è‡ªåŠ¨æ‹‰å–</span><br><span class="line">podåˆå§‹åŒ–å®¹å™¨ï¼Œæƒ³ä¸´æ—¶æ”¹é‡Œé¢æŸäº›ä¸œè¥¿ï¼Œæ¯”å¦‚è¯´æ·»åŠ wwwç”¨æˆ·ï¼Œç»Ÿä¸€ç”¨æˆ·</span><br><span class="line"></span><br><span class="line">é’©å­ å¯åŠ¨é’©å­ï¼šå¯åŠ¨ä¹‹å‰è®©ä»–åšä¸€äº›äº‹æƒ…</span><br><span class="line">åœæ­¢é’©å­ï¼špodç»“æŸäº†å°±åœæ­¢é’©å­ï¼Œç»“æŸä¹‹å‰æƒ³è®©ä»–å‘é‚®ä»¶å‘Šè­¦</span><br><span class="line">æ¢é’ˆï¼šk8sæŒ‚äº†å¯ä»¥é‡æ–°æ‹‰èµ·ï¼Œé‚£ä¹ˆpodæ²¡æŒ‚ï¼Œä½†æ˜¯ç½‘ç«™æ˜¯404æˆ–è€…50å‡ ï¼Œç½‘ç«™ä¸èƒ½æ­£å¸¸è®¿é—®ï¼Œä½†æ˜¯k8såªæ£€æµ‹podæœ‰æ²¡æœ‰æŒ‚æˆ–è€…è¢«åˆ é™¤ï¼Œä½†æ˜¯10ä¸ªpodéƒ½æ˜¯404ï¼Œpodåœ¨ï¼Œä¸ä¼šé‡æ–°æ‹‰èµ·ï¼Œå°±è¦ç”¨æ¢é’ˆ</span><br><span class="line">å­˜æ´»æ¢é’ˆ æ•‘ç»­æ¢é’ˆ  è‡ªåŠ¨æ‰©ç¼©å®¹</span><br></pre></td></tr></table></figure><p><strong>wordpressé•œåƒ</strong></p><p>åœ¨ä¸€ä¸ªPODé‡Œå¯åŠ¨ä¸¤ä¸ªå®¹å™¨ wordpresså’Œmysql5.7ï¼Œç”¨æˆ·ä¸Šä¼ æ•°æ®çš„ç›®å½•åšæŒä¹…åŒ–ï¼Œè¯¥æ‰“æ ‡ç­¾çš„æ‰“æ ‡ç­¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œwordpresså®¹å™¨</span></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wp_db \</span><br><span class="line">-d wordpress-df:v2 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 kubernetes]# vim wp.yml</span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Namespace&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: wp</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: wp-pod</span><br><span class="line">  namespace: wp</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: wp-containers</span><br><span class="line">    image: wordpress-df:v2</span><br><span class="line">    imagePullPolicy: Never</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: WORDPRESS_DB_HOST</span><br><span class="line">      value: <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    - name: WORDPRESS_DB_USER</span><br><span class="line">      value: <span class="string">&quot;wp_user&quot;</span></span><br><span class="line">    - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line">    - name: WORDPRESS_DB_NAME</span><br><span class="line">      value: <span class="string">&quot;wp_db&quot;</span></span><br><span class="line"></span><br><span class="line">  - name: mysql-containers</span><br><span class="line">    image: mysql:5.7.44</span><br><span class="line">    imagePullPolicy: Never</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 3306</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line">    - name: MYSQL_DATABASE</span><br><span class="line">      value: <span class="string">&quot;wp_db&quot;</span></span><br><span class="line">    - name: MYSQL_USER</span><br><span class="line">      value: <span class="string">&quot;wp_user&quot;</span></span><br><span class="line">    - name: MYSQL_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123&quot;</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: db</span><br><span class="line">      mountPath: /var/lib/mysql</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ç»™podæ‰“æ ‡ç­¾ä»¥åŠå…±äº«æ–‡ä»¶ç³»ç»Ÿ</summary>
    
    
    
    <category term="k8s" scheme="https://www.fomal.cc/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰3ã€PODèµ„æº</title>
    <link href="https://www.fomal.cc/posts/763f53e4.html"/>
    <id>https://www.fomal.cc/posts/763f53e4.html</id>
    <published>2024-09-22T06:44:58.000Z</published>
    <updated>2024-09-30T07:54:12.393Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PODèµ„æºçš„ä»‹ç»">PODèµ„æºçš„ä»‹ç»</h2><h3 id="1ã€kubernetesèµ„æºå¯¹è±¡æ“ä½œ">1ã€<strong>kubernetesèµ„æºå¯¹è±¡æ“ä½œ</strong></h3><table><thead><tr><th>èµ„æºå¯¹è±¡</th><th>å¢</th><th>åˆ </th><th>æ”¹</th><th>æŸ¥</th></tr></thead><tbody><tr><td>nodes</td><td></td><td>kubectl delete node</td><td></td><td>kubectl get nodes</td></tr><tr><td>namespace</td><td>kubectl create ns  [èµ„æºå]</td><td>kubectl delete ns  [èµ„æºå]</td><td>kubectl edit ns  [èµ„æºå]</td><td>kubectl get ns</td></tr><tr><td>pod</td><td>kubectl create deployment [èµ„æºå]</td><td>kubectl delete pod  [podå]</td><td></td><td>kubectl get pod</td></tr></tbody></table><p>1ã€nodes</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">å¢</span><br><span class="line"><span class="comment">#å¿˜è®°nodeåŠ å…¥masteré›†ç¾¤å‘½ä»¤,é‚£ä¹ˆéœ€è¦é‡æ–°æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</span></span><br><span class="line">[root@master01 ~]# kubeadm token create --print-join-command</span><br><span class="line"></span><br><span class="line">åˆ </span><br><span class="line">kubectl delete node</span><br><span class="line"></span><br><span class="line">æŸ¥</span><br><span class="line"><span class="comment">#æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">[root@master01 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS   ROLES    AGE    VERSION</span><br><span class="line">master01   Ready    master   5d2h   v1.19.3</span><br><span class="line">node01     Ready    &lt;none&gt;   5d2h   v1.19.3</span><br><span class="line">node02     Ready    &lt;none&gt;   5d2h   v1.19.3</span><br><span class="line">node03     Ready    &lt;none&gt;   5d2h   v1.19.3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹åç§°ç©ºé—´</span></span><br><span class="line">[root@master01 ~]# kubectl get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   5d2h</span><br><span class="line">kube-flannel      Active   5d1h</span><br><span class="line">kube-node-lease   Active   5d2h</span><br><span class="line">kube-public       Active   5d2h</span><br><span class="line">kube-system       Active   5d2h</span><br></pre></td></tr></table></figure><p>2ã€namespace</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å¢</span><br><span class="line">kubectl create ns  [èµ„æºå]</span><br><span class="line"></span><br><span class="line">åˆ </span><br><span class="line">kubectl delete ns  [èµ„æºå]</span><br><span class="line"></span><br><span class="line">æ”¹</span><br><span class="line">kubectl edit ns  [èµ„æºå]</span><br><span class="line"></span><br><span class="line">æŸ¥</span><br><span class="line">kubectl get ns </span><br></pre></td></tr></table></figure><p>3ã€pod</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥</span><br><span class="line"><span class="comment">#æŸ¥çœ‹pod(é»˜è®¤æŸ¥çœ‹defaultåç§°ç©ºé—´)</span></span><br><span class="line">[root@master01 ~]# kubectl get pod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹pod(æŸ¥çœ‹æŒ‡å®šçš„åç§°ç©ºé—´)</span></span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å¸®åŠ©</span></span><br><span class="line">[root@master01 ~]# kubectl get pod --<span class="built_in">help</span></span><br><span class="line">-oæˆ–è€…--outputï¼šæŒ‡å®šè¾“å‡ºæ ¼å¼</span><br><span class="line">jsonï¼šè¾“å‡ºjsonæ ¼å¼</span><br><span class="line">yamlï¼šè¾“å‡ºyamlæ ¼å¼</span><br><span class="line">wideï¼šè¾“å‡ºè¯¦ç»†ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">-nï¼šæŒ‡å®šåç§°ç©ºé—´</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŒ‡å®šè¾“å‡ºæ ¼å¼</span></span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel -o json</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel </span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-4ncf5   1/1     Running   0          5d2h</span><br><span class="line">kube-flannel-ds-7dnxx   1/1     Running   1          5d2h</span><br><span class="line">kube-flannel-ds-dpzqp   1/1     Running   0          5d2h</span><br><span class="line">kube-flannel-ds-knmch   1/1     Running   0          5d2h</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel kube-flannel-ds-4ncf5 -o json</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æŒ‡å®šçš„pod</span></span><br><span class="line">[root@master01 ~]# kubectl get pod nginx-5f5d9d69c4-pk4c4 -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¾“å‡ºpodè¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel -o wide</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-flannel-ds-4ncf5   1/1     Running   0          5d2h   10.0.0.203   node03     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-7dnxx   1/1     Running   1          5d2h   10.0.0.200   master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-dpzqp   1/1     Running   0          5d2h   10.0.0.201   node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-knmch   1/1     Running   0          5d2h   10.0.0.202   node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¢</span><br><span class="line"><span class="comment">#åˆ›å»ºpod(é»˜è®¤åˆ›å»ºåœ¨defaultåç§°ç©ºé—´)</span></span><br><span class="line">kubectl create deployment podå --image=é•œåƒ:ç‰ˆæœ¬</span><br><span class="line">[root@master01 ~]# kubectl create deployment nginx --image=nginx:alpine</span><br><span class="line"></span><br><span class="line">åˆ </span><br><span class="line"><span class="comment">#åˆ é™¤pod</span></span><br><span class="line">[root@master01 ~]# kubectl delete pod nginx-65cc99f84f-8k9rj</span><br><span class="line"></span><br><span class="line">æ”¹</span><br><span class="line"><span class="comment">#å½“åˆ›å»ºpodï¼Œé•œåƒåå†™é”™äº†ï¼Œéœ€è¦ä¿®æ”¹æ—¶</span></span><br><span class="line">[root@master01 ~]# kubectl edit deployment nginx </span><br><span class="line">å°±ä¼šè¿›å…¥åƒviç¼–è¾‘å™¨ä¸€æ ·çš„ä¸œè¥¿ï¼Œæ‰¾åˆ°imageï¼Œæ”¹åé¢çš„é•œåƒå</span><br><span class="line"></span><br><span class="line">ç­‰å¾…ä¸€ä¼šï¼Œè¿™æ¬¡æŸ¥çœ‹pod,å°±ä¼šæ­£å¸¸è¿è¡Œ</span><br><span class="line">[root@master01 ~]#  kubectl get pod</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-5f5d9d69c4-pk4c4   1/1     Running   0          8m14s</span><br></pre></td></tr></table></figure><h3 id="2ã€PODçš„èµ„æºæ¸…å•">2ã€<strong>PODçš„èµ„æºæ¸…å•</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# vim nginx.yaml </span><br><span class="line">apiVersion: v1                        <span class="comment">## K8Sèµ„æºæ¥å£</span></span><br><span class="line">kind: Pod                             <span class="comment">## èµ„æºç±»å‹</span></span><br><span class="line">metadata:                             <span class="comment">## èµ„æºçš„å…ƒæ•°æ®</span></span><br><span class="line">  name: nginx-pod                     <span class="comment">## PODåå­—</span></span><br><span class="line">  namespace: default                  <span class="comment">## èµ„æºå¯åŠ¨åœ¨å“ªä¸ªåç§°ç©ºé—´</span></span><br><span class="line">spec:                                 <span class="comment">## å®¹å™¨ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">  containers:                         <span class="comment">## å®¹å™¨ä¿¡æ¯</span></span><br><span class="line">  - image: nginx:alpine               <span class="comment">## æŒ‡å®šå®¹å™¨çš„é•œåƒ</span></span><br><span class="line">    imagePullPolicy: IfNotPresent     <span class="comment">## é•œåƒæ‹‰å–è§„åˆ™  IfNotPresentï¼šä¸å­˜åœ¨åˆ™æ‹‰å–</span></span><br><span class="line">    name: nginx-containers            <span class="comment">## å®¹å™¨åå­—</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">Alwaysï¼šæ€»æ˜¯æ‹‰å–ï¼Œä¸ç®¡å½“å‰æœºå™¨ä¸Šæ˜¯å¦æœ‰æ”¹é•œåƒéƒ½æ‹‰å–</span><br><span class="line">Neverï¼šä»ä¸æ‹‰å–é•œåƒï¼Œéœ€è¦æå‰docker pull</span><br><span class="line">IfNotPresentï¼šä¸å­˜åœ¨åˆ™æ‹‰å–</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#K8Sèµ„æºæ¥å£ï¼š</span></span><br><span class="line">apiVersion: v1  </span><br><span class="line">å¯ä»¥ç†è§£ä¸ºhttps://masterçš„ip:6443/pod/v1ä¸€å¼€å§‹initåˆå§‹åŒ–çš„æ—¶å€™å°±å†™äº†masterçš„ipä¸º10.0.0.200ï¼Œä¼šè‡ªåŠ¨è¡¥å…¨ï¼Œå¯ä»¥ç†è§£ä¸ºå‰é¢å¯ä»¥ä¸å†™ï¼Œä¼šè‡ªåŠ¨è¡¥å…¨,è¿™äº›æ¥å£å…¨éƒ½æ³¨å†Œåœ¨etcdé‡Œé¢</span><br><span class="line">https://10.0.0.200:6443/pod/v1</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240918150439792.png" alt="image-20240918150439792"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¯åŠ¨pod</span></span><br><span class="line">[root@master01 ~]# kubectl create -f nginx.yml </span><br><span class="line">pod/nginx-pod created</span><br><span class="line">[root@master01 ~]# kubectl get pod</span><br><span class="line">nginx-pod                0/1     ContainerCreating   0          13s</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹è¿™ä¸ªpodèµ·åœ¨å“ªä¸ªnode</span></span><br><span class="line">[root@master01 ~]# kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS             RESTARTS   AGE     IP         NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-pod                0/1     ImagePullBackOff   0          4m49s   10.2.3.6   node03   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="3ã€æ‰‹å†™èµ„æºæ¸…å•">3ã€<strong>æ‰‹å†™èµ„æºæ¸…å•</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å‚è€ƒç½‘å€ï¼šhttp://k8s.driverzeng.com/v1.19/</span><br><span class="line">è¿™4ä¸ªå¿…å†™çš„</span><br><span class="line"></span><br><span class="line">objectæ•°æ®ç±»å‹å†™æ³•ï¼šç›´æ¥å›è½¦ï¼Œå’Œä¸Šä¸€ä¸ªç¼©è¿›å†™key: valueçš„å½¢å¼</span><br><span class="line">[]åˆ—è¡¨æ•°æ®ç±»å‹å†™æ³•ï¼šå›è½¦ä¹‹åå†™ä¸€ä¸ªå‡å·-ï¼Œå†ç©ºæ ¼</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240918153235543.png" alt="image-20240918153235543"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™èµ„æºæ¸…å•  <span class="comment"># è¿™é‡Œæœ‰å‘ï¼Œéœ€è¦ç»§ç»­å¾€ä¸‹æŸ¥çœ‹æ›´æ–°åçš„èµ„æºæ¸…å•</span></span><br><span class="line">[root@master01 ~]# vim busybox.yml</span><br><span class="line"><span class="comment">#å¦‚æœåé¢è¦æŒ‡å®šåç§°ç©ºé—´ï¼Œå°±è¦å…ˆåˆ›å»ºåç§°ç©ºé—´</span></span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Namespace&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: aaa</span><br><span class="line"><span class="comment">#åˆ†éš”ç¬¦ï¼Œåˆ†éš”ä¸Šé¢å’Œä¸‹é¢çš„èµ„æº</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#è¿™ä¸ªæ˜¯1ä¸ªpodé‡Œé¢èµ·2ä¸ªå®¹å™¨</span></span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: busybox-pod</span><br><span class="line">  namespace: aaa</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox-containers</span><br><span class="line">    image: busybox</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"> </span><br><span class="line">  - name: nginx-containers</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    </span><br><span class="line">2ã€å¯åŠ¨èµ„æº</span><br><span class="line">[root@master01 ~]# kubectl apply -f busybox.yml </span><br><span class="line">namespace/aaa created</span><br><span class="line">pod/busybox-pod created</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹åç§°ç©ºé—´é‡Œé¢èµ·çš„èµ„æºï¼Œåªçœ‹åˆ°ä¸€ä¸ª</span><br><span class="line">[root@master01 ~]# kubectl get pod -n aaa</span><br><span class="line">NAME          READY   STATUS             RESTARTS   AGE</span><br><span class="line">busybox-pod   1/2     CrashLoopBackOff   3          94s</span><br><span class="line"></span><br><span class="line">4ã€ç”±äºåç§°ç©ºé—´é‡Œé¢èµ·çš„èµ„æºï¼Œåªçœ‹åˆ°ä¸€ä¸ªï¼Œæ‰€ä»¥æœ‰é—®é¢˜ï¼Œè¦æ£€æŸ¥åŸå› æ’é”™</span><br><span class="line"><span class="comment">#æ’æŸ¥å‘½ä»¤</span></span><br><span class="line"><span class="comment">#kubectl describe [èµ„æº] [èµ„æºå] [-n åç§°ç©ºé—´]</span></span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl describe pod busybox-pod -n aaa</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl describe namespace  aaa</span><br><span class="line"></span><br><span class="line">å…¶å®åŸå› å°±æ˜¯busyboxæ²¡å¡ä½ï¼Œè¿™ä¸ªæ˜¯ç½‘ç»œç›¸å…³çš„é•œåƒï¼Œéœ€è¦åŠ å‘½ä»¤å¡ä½</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">5ã€æ›´æ–°èµ„æºæ¸…å•</span><br><span class="line">[root@master01 ~]# vim busybox.yml</span><br><span class="line"><span class="comment">#å¦‚æœåé¢è¦æŒ‡å®šåç§°ç©ºé—´ï¼Œå°±è¦å…ˆåˆ›å»ºåç§°ç©ºé—´</span></span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Namespace&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: aaa</span><br><span class="line"><span class="comment">#åˆ†éš”ç¬¦ï¼Œåˆ†éš”ä¸Šé¢å’Œä¸‹é¢çš„èµ„æº</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#è¿™ä¸ªæ˜¯1ä¸ªpodé‡Œé¢èµ·2ä¸ªå®¹å™¨</span></span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  name: busybox-pod</span><br><span class="line">  namespace: aaa</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox-containers</span><br><span class="line">    image: busybox</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="comment">#åŠ å…¥å¡ä½çš„å‘½ä»¤</span></span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/tail&quot;</span>,<span class="string">&quot;-f&quot;</span>,<span class="string">&quot;/etc/hosts&quot;</span>]</span><br><span class="line"> </span><br><span class="line">  - name: nginx-containers</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    </span><br><span class="line">6ã€åˆ é™¤å°±å¾—pod</span><br><span class="line">[root@master01 ~]# kubectl delete -f busybox.yml</span><br><span class="line"></span><br><span class="line">7ã€å†æ¬¡åˆ›å»ºpod,å¹¶æŸ¥çœ‹</span><br><span class="line">[root@master01 ~]# kubectl apply -f busybox.yml </span><br><span class="line">[root@master01 ~]# kubectl get pod -n aaa</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">busybox-pod   2/2     Running   0          13s</span><br><span class="line"><span class="comment">#æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">[root@master01 ~]# kubectl get pod -n aaa -o wide</span><br></pre></td></tr></table></figure><h3 id="4ã€ä½¿ç”¨VScodeç¼–å†™èµ„æºæ¸…å•">4ã€<strong>ä½¿ç”¨VScodeç¼–å†™èµ„æºæ¸…å•</strong></h3><p>1ã€é…ç½®VScode</p><p>å…ˆè¿œç¨‹è¿æ¥ä¸»èŠ‚ç‚¹</p><p><img src="../image/study_img/image-20240918170551193.png" alt="image-20240918170551193"></p><p>ç»Ÿä¸€èµ„æºæ¸…å•çš„ä½ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# <span class="built_in">mkdir</span> /opt/kubernetes</span><br><span class="line">[root@master01 ~]# <span class="built_in">mv</span> *.yml /opt/kubernetes</span><br></pre></td></tr></table></figure><p>è¿æ¥æˆåŠŸï¼Œæ‰“å¼€åˆ›å»ºçš„/opt/kubernetesç›®å½•</p><p><img src="../image/study_img/image-20240918171056628.png" alt="image-20240918171056628"></p><p><img src="../image/study_img/image-20240918171219206.png" alt="image-20240918171219206"></p><p>é…ç½®æ¢¯å­åŠ é€Ÿä¸‹è½½ï¼Œå®‰è£…kubernetesæ’ä»¶ï¼Œå®‰è£…æ’ä»¶å¯èƒ½éœ€è¦7åˆ†é’Ÿå·¦å³</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# vim ~/.bashrc </span><br><span class="line"><span class="built_in">export</span> https_proxy=https://192.168.10.200:7890</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# <span class="built_in">source</span> .bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä½¿ç”¨å®Œæˆåï¼Œæ‰§è¡Œå¦‚ä¸‹ï¼š</span></span><br><span class="line">[root@master01 ~]# vim ~/.bashrc </span><br><span class="line"><span class="comment">#export https_proxy=https://192.168.10.200:7890</span></span><br><span class="line"></span><br><span class="line">[root@master01 ~]# <span class="built_in">unset</span> https_proxy</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240918172406539.png" alt="image-20240918172406539"></p><p><img src="../image/study_img/image-20240918173241749.png" alt="image-20240918173241749"></p><p>å®‰è£…æ’ä»¶å¯èƒ½éœ€è¦7åˆ†é’Ÿå·¦å³ï¼Œå®‰è£…å®Œæˆ</p><p><img src="../image/study_img/image-20240918174036219.png" alt="image-20240918174036219"></p><p>2ã€ä½¿ç”¨æ’ä»¶</p><p>æŸ¥çœ‹é•œåƒçš„çŠ¶æ€å’Œip</p><p><img src="../image/study_img/image-20240918174854465.png" alt="image-20240918174854465"></p><p>ç¼–å†™èµ„æºæ¸…å•</p><p><img src="../image/study_img/image-20240918175229795.png" alt="image-20240918175229795"></p><p><img src="../image/study_img/image-20240918175420732.png" alt="image-20240918175420732"></p><p><img src="../image/study_img/image-20240918175433243.png" alt="image-20240918175433243"></p><p>æ ¹æ®æ¨¡ç‰ˆä¿®æ”¹å†…å®¹    èµ„æºé™åˆ¶ä¸éœ€è¦ï¼Œæ‰€ä»¥åˆ é™¤ï¼Œåˆ é™¤ä¹‹åæœ‰é»„çº¿ï¼Œä¸ç”¨ç®¡</p><p><img src="../image/study_img/image-20240918175813043.png" alt="image-20240918175813043"></p>]]></content>
    
    
    <summary type="html">ç¼–å†™podèµ„æºæ¸…å•ï¼Œä½¿ç”¨ä¸€ä¸ªå¾ˆå¥½ç”¨çš„å·¥å…·VScodeç¼–å†™èµ„æºæ¸…å•ï¼Œæœ¬æ–‡æœ‰å†™æ“ä½œæ–¹æ³•å“¦ï¼Œéå¸¸å®ç”¨</summary>
    
    
    
    <category term="k8s" scheme="https://www.fomal.cc/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰2ã€kubernetså®‰è£…éƒ¨ç½²v1.19-æºç å®‰è£…</title>
    <link href="https://www.fomal.cc/posts/8b2778bc.html"/>
    <id>https://www.fomal.cc/posts/8b2778bc.html</id>
    <published>2024-09-22T06:44:18.000Z</published>
    <updated>2024-10-02T08:05:43.445Z</updated>
    
    <content type="html"><![CDATA[<h2 id="kubernetså®‰è£…éƒ¨ç½²v1-19-æºç å®‰è£…">kubernetså®‰è£…éƒ¨ç½²v1.19  (æºç å®‰è£…)</h2><h3 id="1ã€k8sçš„å®‰è£…æ–¹å¼">1ã€<strong>k8sçš„å®‰è£…æ–¹å¼</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## K8Sçš„æ–¹å¼æœ‰ä¸€å †</span></span><br><span class="line">äºŒè¿›åˆ¶å®‰è£…  ç”Ÿäº§æ¨è</span><br><span class="line">kubeadm    ç”Ÿäº§æ¨è</span><br><span class="line">Ansible    äºŒè¿›åˆ¶å®‰è£…</span><br><span class="line">Rancher    è™½ç„¶k8sæ˜¯æœ‰è‡ªå¸¦çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œä½†åœ¨ä¼ä¸šé‡Œé¢ç”¨Rancherçš„è¿˜æ˜¯æ¯”è¾ƒå¤š</span><br><span class="line">é˜¿é‡Œäº‘ACK</span><br><span class="line">äºšé©¬é€Šäº‘EKS</span><br><span class="line"></span><br><span class="line">å®‰è£…k8s1.19ç‰ˆï¼Œk8sä¸­å°ç‰ˆæœ¬å˜äº†å½±å“å¾ˆå¤§ï¼Œæ¥å£æ˜¯ä¸ä¸€æ ·çš„</span><br></pre></td></tr></table></figure><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th><th>é…ç½®</th><th>é…ç½®</th></tr></thead><tbody><tr><td>master01</td><td>10.0.0.200  /  172.16.1.200</td><td>master</td><td>kubectl,apiserver,scheduler,controller,<br>etcd,kubelet,kube-proxy</td><td>1h2G</td></tr><tr><td>node01</td><td>10.0.0.201  /  172.16.1.201</td><td>node</td><td>kubectlï¼Œapiserver,<br>kube-proxy</td><td>1h2G</td></tr><tr><td>node02</td><td>10.0.0.202  /  172.16.1.202</td><td>node</td><td>kubectlï¼Œapiserver,<br>kube-proxy</td><td>1h2G</td></tr><tr><td>node03</td><td>10.0.0.203  /  172.16.1.203</td><td>node</td><td>kubectlï¼Œapiserver,<br>kube-proxy</td><td>2h4G</td></tr></tbody></table><p>IPè§„åˆ’</p><p>ä¸ºä»€ä¹ˆè§„åˆ’IP?  å› ä¸ºæ‰€æœ‰çš„PODèµ·æ¥åº”è¯¥åœ¨åŒä¸€ä¸ªç½‘æ®µï¼ŒCluster IPä¹Ÿåœ¨åŒä¸€ä¸ªç½‘æ®µ</p><table><thead><tr><th>ä¸‰ç§service</th><th>IP</th></tr></thead><tbody><tr><td>POD IP</td><td>10.2.0.0</td></tr><tr><td>Cluster IP</td><td>10.1.0.0</td></tr><tr><td>Node IP</td><td>10.0.0.0</td></tr></tbody></table><p>æ³¨æ„ï¼šå¦‚æœæ˜¯äºŒè¿›åˆ¶å®‰è£…ï¼Œé»˜è®¤çš„pod IPæ˜¯10.0.0.0ç½‘æ®µï¼Œå®¿ä¸»æœºçš„ç½‘æ®µå’Œpod ipÂ·ä¸èƒ½ä¸€æ ·</p><p><strong>â‘ ã€éƒ¨ç½²å‰çš„ç¯å¢ƒä¼˜åŒ–</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######4å°æœºå™¨éƒ½æ‰§è¡Œ   </span></span><br><span class="line"><span class="comment">#(kubelet:æ§åˆ¶å®¹å™¨è¿è¡Œæ—¶å¯åŠ¨å®¹å™¨çš„ä¸œè¥¿,è¦æŠŠmasterå½“ä½œnodeèŠ‚ç‚¹ï¼Œæ‰€ä»¥masterä¹Ÿè¦å®‰è£…)</span></span><br><span class="line">1ã€é…ç½®kubleté…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„Cgroupé©±åŠ¨å’Œç¦ç”¨swap     </span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/sysconfig/kubelet &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">KUBELET_CGROUP_ARGS=&quot;--cgroup-driver=systemd&quot;</span></span><br><span class="line"><span class="string">KUBELET_EXTRA_ARGS=&quot;--fail-swap-on=false&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è®©kubeletä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„Cgroupé©±åŠ¨ </span></span><br><span class="line">KUBELET_CGROUP_ARGS=<span class="string">&quot;--cgroup-driver=systemd&quot;</span></span><br><span class="line"><span class="comment">#è®©kubeletç¦æ­¢ä½¿ç”¨swap(è™šæ‹Ÿå†…å­˜) </span></span><br><span class="line">KUBELET_EXTRA_ARGS=<span class="string">&quot;--fail-swap-on=false&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€å†…å‚æ•°è°ƒä¼˜ï¼Œè¦æŠŠiptableåŠŸèƒ½å¼€å¯(å› ä¸ºåº•å±‚ç«¯å£çš„è½¬å‘ç«¯å£æ˜ å°„éƒ½æ˜¯é˜²ç«å¢™åšçš„)</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">vm.swappiness=0</span></span><br><span class="line"><span class="string">fs.file-max=52706963</span></span><br><span class="line"><span class="string">fs.nr_open=52706963</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¼€å¯iptablesåŠŸèƒ½   ipv4</span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line"><span class="comment">#å¼€å¯iptablesåŠŸèƒ½   ipv6</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="comment">#å¼€å¯å†…æ ¸è½¬å‘</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="comment">#å†…æ ¸å‚æ•°ç¦ç”¨swap</span></span><br><span class="line">vm.swappiness=0</span><br><span class="line"><span class="comment">#æ–‡ä»¶æè¿°ç¬¦æ–‡ä»¶æœ€å¤§å€¼</span></span><br><span class="line">fs.file-max=52706963</span><br><span class="line"><span class="comment">#æ–‡ä»¶æè¿°ç¬¦å¼€å¯æ•°é‡</span></span><br><span class="line">fs.nr_open=52706963</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€æ£€æŸ¥æ˜¯å¦é…ç½®æˆåŠŸ</span><br><span class="line">sysctl --system</span><br><span class="line">æ‰§è¡Œä¹‹åè¾“å‡ºç»“æœå€’æ•°çš„è¡Œä¼šæ˜¾ç¤ºç¬¬2æ­¥é…ç½®çš„å†…å®¹</span><br><span class="line">* Applying /etc/sysctl.d/k8s.conf ...</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">vm.swappiness = 0</span><br><span class="line">fs.file-max = 52706963</span><br><span class="line">fs.nr_open = 52706963</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€æ›´æ”¹dockeræº</span><br><span class="line">[root@master01 ~]# <span class="built_in">cat</span> &gt; /etc/yum.repos.d/docker-ce.repo &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[docker-ce-stable]</span></span><br><span class="line"><span class="string">name=Docker CE Stable - $basearch</span></span><br><span class="line"><span class="string">baseurl=https://download.docker.com/linux/centos/7/x86_64/stable</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://download.docker.com/linux/centos/gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">[root@master01 ~]# sed -i <span class="string">&#x27;s+download.docker.com+mirrors.huaweicloud.com/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line">5ã€å®‰è£…æ—¶é—´åŒæ­¥æœåŠ¡ (è¿™ä¸ªä¸éœ€è¦å†™åœ¨å®šæ—¶ä»»åŠ¡é‡Œé¢)</span><br><span class="line">yum install -y chrony</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl <span class="built_in">enable</span> chronyd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6ã€å…³é—­swap</span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;/swap/d&#x27;</span> /etc/fstab</span><br><span class="line">free -m</span><br><span class="line">[root@master01 ~]# free -m</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           1846         100        1271           9         474        1564</span><br><span class="line">Swap:             0           0           0#å˜æˆ0å°±æ˜¯å…³é—­äº†</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸´æ—¶å…³é—­swap</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="comment">#æ°¸ä¹…å…³é—­swap</span></span><br><span class="line">sed -i <span class="string">&#x27;/swap/d&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7ã€åŠ è½½ipvsæ¨¡å—   åšk8sï¼Œåº•å±‚æœ‰è½¬å‘ï¼Œéœ€è¦é…åˆipvsæ¨¡å—æ‰å¯ä»¥</span><br><span class="line"><span class="built_in">cat</span>  &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">modprobe -- ip_vs</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_rr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_wrr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_sh</span></span><br><span class="line"><span class="string">modprobe -- nf_conntrack_ipv4</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="built_in">source</span> /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">lsmod|grep -e <span class="string">&#x27;ip_vs&#x27;</span> -e <span class="string">&#x27;nf_conntrack_ipv&#x27;</span>  </span><br><span class="line"><span class="comment">#è¿‡æ»¤å‡ºip_vsæ¨¡å—å°±åŠ è½½å‡ºæ¥äº†</span></span><br><span class="line"></span><br><span class="line">ipvs:LVSåšå››å±‚è´Ÿè½½,ä¸éœ€è¦è£…ä»»ä½•è½¯ä»¶,éœ€è¦ä¸‹è½½ipvsadmå‘½ä»¤,ç”¨ipvsadmè¿™ä¸ªå‘½ä»¤å»æ”¹ä¸»æœºçš„è·¯ç”±ã€è·¯ç”±è¡¨ã€ç½‘ç»œç›¸å…³çš„ä¸œè¥¿æ”¹æ‰,æŠŠè¿™ä¸ªä¸»æœºå½“æˆå››å±‚è´Ÿè½½çš„æœºå™¨,åº•å±‚è¦åšè½¬å‘çš„ï¼ŒLVSè¿™ä¸ªæœåŠ¡æ¯”è¾ƒç‹¬ç‰¹çš„ï¼Œæ²¡æœ‰ä¸“é—¨çš„åº”ç”¨ï¼Œä¸åƒnginxã€HAproxyåšè´Ÿè½½å‡è¡¡éœ€è¦å®‰è£…nginxã€HAproxy,LVSæ²¡æœ‰æœåŠ¡å®‰è£…ï¼Œéœ€è¦å®‰è£…ipvsadm,ç”¨è¿™ä¸ªå‘½ä»¤å»ä¿®æ”¹è·¯ç”±ä¿®æ”¹è½¬å‘è¿™äº›ä¸œè¥¿ï¼Œè®©æ•´ä¸ªç‰©ç†æœºå˜æˆè½¬å‘çš„æœºå™¨</span><br></pre></td></tr></table></figure><p><strong>â‘¡ã€å®‰è£…dockeræŒ‡å®šç‰ˆæœ¬</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######4å°æœºå™¨éƒ½æ‰§è¡Œ ####</span></span><br><span class="line">1ã€æŸ¥è¯¢dockerç‰ˆæœ¬  </span><br><span class="line"><span class="comment">#(åªæ˜¾ç¤ºyumä»“åº“é‡Œçš„æœ€æ–°ç‰ˆ)</span></span><br><span class="line">yum list docker-ce </span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æ‰€æœ‰çš„ç‰ˆæœ¬</span></span><br><span class="line">yum list docker-ce --showduplicates</span><br><span class="line"></span><br><span class="line">2ã€å®‰è£…docke 19.03.15ç‰ˆæœ¬ï¼Œå› ä¸ºè¿™ä¸ªç‰ˆæœ¬æ¯”è¾ƒç¨³å®š</span><br><span class="line">yum install -y docker-ce-19.03.15 docker-ce-cli-19.03.15 containerd.io</span><br><span class="line">systemctl start docker &amp;&amp; systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">containerd.ioï¼šå®¹å™¨è¿è¡Œæ—¶ï¼Œç”¨k8sæ–°ç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥æ— ç—•ä»dockeå¯¹æ¥åˆ°containerdï¼Œé»˜è®¤å®‰è£…æœ€æ–°ç‰ˆ</span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹æ˜¯å¦å‡ºç°è­¦å‘Šï¼Œå†çœ‹ä¸€ä¸‹æ˜¾ç¤ºçš„ç‰ˆæœ¬æ˜¯å¦å¯¹çš„ä¸Š</span><br><span class="line">[root@node01 ~]# docker info</span><br><span class="line">Client:</span><br><span class="line">...</span><br><span class="line"> Server Version: 19.03.15</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">#ç”Ÿäº§ä¸­å†åŠ 2ä¸ªæ­¥éª¤ï¼š</span></span><br><span class="line"><span class="comment">#4ã€ä¿®æ”¹æ•°æ®ç›®å½•</span></span><br><span class="line"><span class="comment">#5ã€dockerå›¾å½¢åŒ–ç•Œé¢</span></span><br><span class="line"> </span><br><span class="line">4ã€é…ç½®é•œåƒåŠ é€Ÿå’ŒCgroupé©±åŠ¨</span><br><span class="line"> <span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [</span></span><br><span class="line"><span class="string">  &quot;https://docker.1panel.live&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://dockercf.jsdelivr.fyi&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker-cf.registry.cyou&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.chenby.cn&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.jsdelivr.fyi&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.m.daocloud.io&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.m.daocloud.io&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.mirrors.sjtug.sjtu.edu.cn&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.nju.edu.cn&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://dockerproxy.com&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.rainbond.cc&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://docker.registry.cyou&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://dockertest.jsdelivr.fyi&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://hub-mirror.c.163.com&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://hub.rat.dev/&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://mirror.aliyuncs.com&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://mirror.baidubce.com&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://mirror.iscas.ac.cn&quot;,</span></span><br><span class="line"><span class="string">  &quot;https://registry.docker-cn.com&quot;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€æµ‹è¯•æ‹‰å–</span><br><span class="line">[root@node01 ~]# docker pull busybox</span><br><span class="line">[root@node01 ~]# docker images</span><br></pre></td></tr></table></figure><p><strong>â‘¢ã€å®‰è£…kubeadm</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######4å°æœºå™¨éƒ½æ‰§è¡Œ ####</span></span><br><span class="line">1ã€æ›´æ¢åä¸ºæº</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.huaweicloud.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.huaweicloud.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.huaweicloud.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">2ã€å®‰è£…kubelet nodeèŠ‚ç‚¹å®¹å™¨è¿è¡Œæ—¶çš„æ§åˆ¶å™¨ kubeadmåšk8sé›†ç¾¤ kubectlæ˜¯k8sçš„å®¢æˆ·ç«¯å‘½ä»¤ ipvsadmåŠ è½½jpvsæ¨¡å—</span><br><span class="line">yum install kubelet-1.19.3 kubeadm-1.19.3  kubectl-1.19.3  ipvsadm -y</span><br><span class="line"></span><br><span class="line">systemctl start kubelet.service &amp;&amp; systemctl <span class="built_in">enable</span> kubelet.service </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubelet-1.19.3 ï¼šæ§åˆ¶å®¹å™¨è¿è¡Œæ—¶</span><br><span class="line">kubeadm-1.19.3  ï¼šç±»ä¼¼äºstream</span><br><span class="line">kubectl-1.19.3  ï¼šæ‰§è¡Œk8så‘½ä»¤éœ€è¦çš„å®¢æˆ·ç«¯</span><br><span class="line">ipvsadmï¼šä¸Šé¢é…ç½®IPVSæ¨¡å—ï¼Œéœ€è¦ä½¿ç”¨è¿™ä¸ªå‘½ä»¤</span><br></pre></td></tr></table></figure><p><strong>â‘£ã€master01åˆå§‹åŒ–é›†ç¾¤</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#####å¦‚ä¸‹æ“ä½œåªèƒ½master01æ‰§è¡Œ(masterèŠ‚ç‚¹æ‰§è¡Œ)ï¼Œå…¶ä»–æœºå™¨ä¸è¦æ‰§è¡Œ</span></span><br><span class="line">1ã€åˆå§‹åŒ–é›†ç¾¤   å¤§æ¦‚è¦ç­‰å¾…å‡ åˆ†é’Ÿ</span><br><span class="line">[root@master01 ~]# kubeadm init \</span><br><span class="line">--apiserver-advertise-address=10.0.0.200 \</span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers  \</span><br><span class="line">--kubernetes-version=v1.19.3 \</span><br><span class="line">--service-cidr=10.1.0.0/16 \</span><br><span class="line">--pod-network-cidr=10.2.0.0/16 \</span><br><span class="line">--service-dns-domain=cluster.local \</span><br><span class="line">--ignore-preflight-errors=Swap \</span><br><span class="line">--ignore-preflight-errors=NumCPU</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#åªæœ‰ä¸€ä¸ªmasterçš„å†™æ³•</span></span><br><span class="line">--apiserver-advertise-address=masterçš„ip \</span><br><span class="line"><span class="comment">#é•œåƒä»“åº“çš„åœ°å€ é˜¿é‡Œäº‘çš„è°·æ­Œå®¹å™¨çš„</span></span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers  \</span><br><span class="line">--kubernetes-version=v1.19.3 \</span><br><span class="line"><span class="comment">#serviceèµ„æºï¼Œè®¾ç½®cluster ipç½‘æ®µ</span></span><br><span class="line">--service-cidr=10.1.0.0/16 \</span><br><span class="line"><span class="comment">#è®¾ç½®pod ipçš„ç½‘æ®µ</span></span><br><span class="line">--pod-network-cidr=10.2.0.0/16 \</span><br><span class="line"><span class="comment">#ä½¿ç”¨æœ¬åœ°çš„dns</span></span><br><span class="line">--service-dns-domain=cluster.local \</span><br><span class="line"><span class="comment">#å¿½ç•¥swapçš„æŠ¥é”™</span></span><br><span class="line">--ignore-preflight-errors=Swap \</span><br><span class="line"><span class="comment">#å¿½ç•¥cpuçš„æŠ¥é”™</span></span><br><span class="line">--ignore-preflight-errors=NumCPU</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ä¿å­˜æœ€åå‡ è¡Œå†…å®¹</span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line">  <span class="comment">#å…¶ä»–nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤</span></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line">kubeadm <span class="built_in">join</span> 10.0.0.200:6443 --token cgex1m.9ck6cjchon5xn4j5 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:273cdce81c642065666a2d0eb4fd0c3097df69e984fa50836b8daf2ed10de18a </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¿»è¯‘</span></span><br><span class="line">æ‚¨çš„Kubernetesæ§åˆ¶å¹³é¢å·²æˆåŠŸåˆå§‹åŒ–ï¼</span><br><span class="line">è¦å¼€å§‹ä½¿ç”¨é›†ç¾¤ï¼Œæ‚¨éœ€è¦ä»¥æ™®é€šç”¨æˆ·èº«ä»½è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</span><br><span class="line">mkdir-p<span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">sudo</span> cp-i/etc/kubernetes/admin.conf<span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span>$ï¼ˆid-uï¼‰ï¼š$ï¼ˆid-gï¼‰<span class="variable">$HOME</span>/.kube/config</span><br><span class="line">ç°åœ¨ï¼Œæ‚¨åº”è¯¥å°†podç½‘ç»œéƒ¨ç½²åˆ°é›†ç¾¤ã€‚</span><br><span class="line">ä½¿ç”¨ä»¥ä¸‹åˆ—å‡ºçš„é€‰é¡¹ä¹‹ä¸€è¿è¡Œâ€œkubectl apply-f[podnetwork].yamlâ€ï¼š</span><br><span class="line">https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line">ç„¶åï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥rootèº«ä»½åœ¨æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åŠ å…¥ä»»æ„æ•°é‡çš„å·¥ä½œèŠ‚ç‚¹ï¼š</span><br><span class="line">kubeadm <span class="built_in">join</span> 10.0.0.200:6443 --token cgex1m.9ck6cjchon5xn4j5 \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:273cdce81c642065666a2d0eb4fd0c3097df69e984fa50836b8daf2ed10de18a</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">3ã€å¯ä»¥çœ‹åˆ°å¤šäº†å¥½å‡ ä¸ªé•œåƒï¼Œè¯´æ˜åˆšæ‰çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œæ‹‰å–äº†éœ€è¦çš„é•œåƒ</span><br><span class="line">[root@master01 ~]# docker images</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">4ã€æ‰§è¡Œè¿™å‡ ä¸ªå‘½ä»¤   åˆ›å»ºéšè—ç›®å½•ï¼Œæ‹·è´é…ç½®æ–‡ä»¶ï¼Œæˆæƒ</span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€æŸ¥çœ‹k8sé›†ç¾¤èŠ‚ç‚¹ï¼Œ ä¼šçœ‹åˆ°masterä¸»èŠ‚ç‚¹</span><br><span class="line">[root@master01 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS     ROLES    AGE     VERSION</span><br><span class="line">master01   NotReady   master   4m32s   v1.19.3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###############nodeèŠ‚ç‚¹æ“ä½œç¬¬6æ­¥  node01 node02 node03</span></span><br><span class="line">6ã€ç›®å‰åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¦å°†å…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</span><br><span class="line"><span class="comment">##æ³¨æ„ï¼šè¿™ä¸ªå‘½ä»¤è¦ä¿å­˜å¥½ï¼Œå› ä¸ºæ¨ªå‘æ‰©å±•ï¼Œå°†èŠ‚ç‚¹åŠ å…¥é›†ç¾¤éœ€è¦ä½¿ç”¨</span></span><br><span class="line">[root@master01 ~]# kubeadm <span class="built_in">join</span> 10.0.0.200:6443 --token cgex1m.9ck6cjchon5xn4j5 \</span><br><span class="line">--discovery-token-ca-cert-hash</span><br><span class="line">sha256:273cdce81c642065666a2d0eb4fd0c3097df69e984fa50836b8daf2ed10de18a </span><br><span class="line"><span class="comment">##########################################  </span></span><br><span class="line">  </span><br><span class="line">7ã€åŠ å…¥é›†ç¾¤å‘½ä»¤æ‰§è¡Œä¹‹åï¼Œæœ€åä¸€è¡Œä¿¡æ¯æ˜¾ç¤ºå¦‚ä¸‹</span><br><span class="line">Run <span class="string">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class="built_in">join</span> the cluster.</span><br><span class="line">åœ¨æ§åˆ¶å¹³é¢ä¸Š(master)è¿è¡Œâ€œkubectl get nodesâ€ä»¥æŸ¥çœ‹æ­¤èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">8ã€#åˆ°master01æ‰§è¡Œkubectl get nodes</span><br><span class="line">[root@master01 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS     ROLES    AGE     VERSION</span><br><span class="line">master01   NotReady   master   9m33s   v1.19.3</span><br><span class="line">node01     NotReady   &lt;none&gt;   3m48s   v1.19.3</span><br><span class="line">node02     NotReady   &lt;none&gt;   118s    v1.19.3</span><br><span class="line">node03     NotReady   &lt;none&gt;   106s    v1.19.3</span><br><span class="line"></span><br><span class="line">ç°åœ¨çš„çŠ¶æ€æ˜¯NotReadyæ²¡æœ‰å‡†å¤‡å¥½çš„ï¼Œå› ä¸ºç½‘ç»œè¿˜æ²¡é…</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">9ã€è®¾ç½®kube-proxyä½¿ç”¨ipvsæ¨¡å¼</span><br><span class="line">k8sé»˜è®¤ä½¿ç”¨çš„æ˜¯iptablesé˜²ç«å¢™ï¼Œå¯ä»¥ä¿®æ”¹æˆæ€§èƒ½æ›´é«˜çš„ipvsæ¨¡å¼ï¼Œè¯¥æ¨¡å¼LVSä¹Ÿåœ¨ä½¿ç”¨</span><br><span class="line">[root@master01 ~]# kubectl edit cm kube-proxy -n kube-system</span><br><span class="line"> 44è¡Œ     </span><br><span class="line"> mode: <span class="string">&quot; &quot;</span> æ”¹ä¸º mode: <span class="string">&quot;ipvs&quot;</span></span><br><span class="line"> </span><br><span class="line">10ã€æŸ¥çœ‹åç§°ç©ºé—´</span><br><span class="line">[root@master01 ~]# kubectl get ns</span><br><span class="line">æˆ–è€…</span><br><span class="line">[root@master01 ~]# kubectl get namespace</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   45m</span><br><span class="line">kube-node-lease   Active   45m</span><br><span class="line">kube-public       Active   45m</span><br><span class="line">kube-system       Active   45m</span><br><span class="line"></span><br><span class="line">11ã€æŸ¥çœ‹æŒ‡å®šåç§°ç©ºé—´ä¸­çš„podä¿¡æ¯</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-system</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d56c8448f-85k2r           0/1     Pending   0          46m <span class="comment">#DNSæœåŠ¡å™¨</span></span><br><span class="line">coredns-6d56c8448f-cn2t9           0/1     Pending   0          46m <span class="comment">#DNSæœåŠ¡å™¨</span></span><br><span class="line">etcd-master01                      1/1     Running   0          46m <span class="comment">#æ•°æ®åº“etcd</span></span><br><span class="line">kube-apiserver-master01            1/1     Running   0          46m <span class="comment">#å¸ä»¤éƒ¨ipserver</span></span><br><span class="line">kube-controller-manager-master01   1/1     Running   0          46m <span class="comment">#æ§åˆ¶å™¨controller</span></span><br><span class="line">kube-proxy-2wfhq                   1/1     Running   0          38m <span class="comment">#ç½‘ç»œã€ç«¯å£æ˜ å°„å°„kube-proxy  æœ‰4ä¸ªæ˜¯å› ä¸ºè¿™ä¸ªé›†ç¾¤é‡Œé¢æœ‰4å°æœºå™¨</span></span><br><span class="line">kube-proxy-8tmqx                   1/1     Running   0          40m <span class="comment">#ç½‘ç»œã€ç«¯å£æ˜ å°„å°„kube-proxy</span></span><br><span class="line">kube-proxy-fr9dl                   1/1     Running   0          39m <span class="comment">#ç½‘ç»œã€ç«¯å£æ˜ å°„å°„kube-proxy</span></span><br><span class="line">kube-proxy-pz4ms                   1/1     Running   0          46m <span class="comment">#ç½‘ç»œã€ç«¯å£æ˜ å°„å°„kube-proxy</span></span><br><span class="line">kube-scheduler-master01            1/1     Running   0          46m <span class="comment">#èµ„æºè°ƒåº¦scheduler</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">12ã€æŸ¥çœ‹æŒ‡å®šåç§°ç©ºé—´ä¸­podçš„è¯¦ç»†ä¿¡æ¯  å¯ä»¥çœ‹åˆ°èµ·åœ¨å“ªå°æœºå™¨ä¸Š</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-system -o wide</span><br><span class="line"></span><br><span class="line">ç”¨çš„DaemonSetæ§åˆ¶å™¨ï¼Œæ¯å°æœ‰ä¸”åªèƒ½èµ·ä¸€ä¸ª</span><br><span class="line"></span><br><span class="line">13ã€é‡å¯pod</span><br><span class="line">æŠŠä»–åˆ æ‰ï¼Œå°±ä¼šè‡ªåŠ¨æ‹‰èµ·ï¼Œä»¥åæœ‰å“ªä¸ªç»„ä»¶åäº†ï¼Œå°±åˆ æ‰é‡æ–°æ‹‰èµ·</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-system|grep <span class="string">&#x27;kube-proxy&#x27;</span>|awk <span class="string">&#x27;&#123;print &quot;kubectl delete pod -n kube-system &quot;$1&#125;&#x27;</span>|bash</span><br></pre></td></tr></table></figure><p>**â‘¤ã€master é…ç½®flanale **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#éƒ¨ç½²ç½‘ç»œæ’ä»¶flanaleï¼Œè®©æ‰€æœ‰èŠ‚ç‚¹ç½‘ç»œæ‰“é€š</span></span><br><span class="line"><span class="comment">##############master01æ‰§è¡Œ#####</span></span><br><span class="line">é“¾æ¥åœ°å€ï¼š</span><br><span class="line">https://github.com/flannel-io/flannel/blob/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line">1ã€ä¸‹è½½èµ„æºæ¸…å•</span><br><span class="line">[root@master01 ~]# wget https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ä¿®æ”¹flannelèµ„æºæ¸…å•</span><br><span class="line">[root@master01 ~]# vim  kube-flannel.yml </span><br><span class="line">       <span class="comment">#æœç´¢net-conf.jsonï¼Œä¿®æ”¹ç½‘æ®µä¸ºè§„åˆ’çš„pod ip  </span></span><br><span class="line">      <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;10.2.0.0/16&quot;</span>,</span><br><span class="line">      ......</span><br><span class="line">      .....</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        <span class="comment">#æœç´¢ containersï¼Œæ–°å¢ä½¿ç”¨çš„ç½‘å¡</span></span><br><span class="line">        - --iface=eth0</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">#æœç´¢containersï¼Œå¦‚æœå‡ºç°è¿™ä¸ªæ ‡ç­¾ï¼Œå°±æŠŠè¿™ä¸ªæ ‡ç­¾é‡Œé¢çš„3è¡Œå†…å®¹åˆ æ‰</span></span><br><span class="line">        spec:</span><br><span class="line">          selector:  <span class="comment">#åˆ æ‰</span></span><br><span class="line">            matchLabels:  <span class="comment">#åˆ æ‰</span></span><br><span class="line">            app: flannel  <span class="comment">#åˆ æ‰</span></span><br><span class="line"></span><br><span class="line">app: flannelæ˜¯ä¸€ä¸ªæ ‡ç­¾é€‰æ‹©å™¨ï¼Œåªæœ‰æ‰“äº†appæ ‡ç­¾çš„nodeï¼Œæ‰ä¼šå®‰è£…flannel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€åªè¦ä¿®æ”¹äº†flannelèµ„æºæ¸…å•ï¼Œå°±è¦æ‰§è¡Œåº”ç”¨flannelèµ„æºæ¸…å•</span><br><span class="line">[root@master01 ~]# kubectl apply -f kube-flannel.yml</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">4ã€#æ£€æŸ¥è¿™å‡ ä¸ªçŠ¶æ€</span><br><span class="line">â‘ ã€æ£€æŸ¥flannelçš„podæ˜¯å¦å¯åŠ¨æˆåŠŸ   4ä¸ªSTATUSæ˜¾ç¤ºRunningå°±æ˜¯æˆåŠŸ</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-flannel</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-4ncf5   1/1     Running   0          4m20s</span><br><span class="line">kube-flannel-ds-7dnxx   1/1     Running   0          4m20s</span><br><span class="line">kube-flannel-ds-dpzqp   1/1     Running   0          4m20s</span><br><span class="line">kube-flannel-ds-knmch   1/1     Running   0          4m20s</span><br><span class="line"></span><br><span class="line">â‘¡ã€æ£€æŸ¥k8sé›†ç¾¤èŠ‚ç‚¹çŠ¶æ€    STATUSæ˜¾ç¤ºReadyå°±æ˜¯å‡†å¤‡å¥½çš„ï¼Œé›†ç¾¤ä¹‹é—´èµ·çš„podå°±å¯ä»¥äº’ç›¸é€šä¿¡äº†</span><br><span class="line">[root@master01 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS   ROLES    AGE   VERSION</span><br><span class="line">master01   Ready    master   81m   v1.19.3</span><br><span class="line">node01     Ready    &lt;none&gt;   75m   v1.19.3</span><br><span class="line">node02     Ready    &lt;none&gt;   73m   v1.19.3</span><br><span class="line">node03     Ready    &lt;none&gt;   73m   v1.19.3</span><br><span class="line"></span><br><span class="line">â‘¢ã€æ£€æŸ¥corednsæ˜¯å¦æ­£å¸¸è¿è¡Œ   åªè¦ç½‘ç»œé…å¥½ï¼Œdnså°±okäº†ï¼ŒSTATUSæ˜¾ç¤ºRunningçŠ¶æ€</span><br><span class="line">[root@master01 ~]# kubectl get pod -n kube-system</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d56c8448f-85k2r           1/1     Running   0          81m</span><br><span class="line">coredns-6d56c8448f-cn2t9           1/1     Running   0          81m</span><br><span class="line">etcd-master01                      1/1     Running   0          81m</span><br><span class="line">kube-apiserver-master01            1/1     Running   0          81m</span><br><span class="line">kube-controller-manager-master01   1/1     Running   0          81m</span><br><span class="line">kube-proxy-2skng                   1/1     Running   0          30m</span><br><span class="line">kube-proxy-fxwbg                   1/1     Running   0          30m</span><br><span class="line">kube-proxy-w6v6r                   1/1     Running   0          30m</span><br><span class="line">kube-proxy-zng7l                   1/1     Running   0          30m</span><br><span class="line">kube-scheduler-master01            1/1     Running   0          81m</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nodeè®¾ç½®è§’è‰²ä¿¡æ¯   </span></span><br><span class="line"> kubectl label node node01 node-role.kubernetes.io/node=</span><br><span class="line"> kubectl label node node02 node-role.kubernetes.io/node=</span><br><span class="line"> kubectl label node node03 node-role.kubernetes.io/node=</span><br></pre></td></tr></table></figure><h3 id="2ã€å®‰è£…kubectlå‘½ä»¤è¡¥å…¨é»‘ç§‘æŠ€">2ã€<strong>å®‰è£…kubectlå‘½ä»¤è¡¥å…¨é»‘ç§‘æŠ€</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¯ä»¥tabè¡¥å…¨çš„å·¥å…·</span></span><br><span class="line"></span><br><span class="line">yum install -y bash-completion</span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion </span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash) </span><br><span class="line">kubectl completion bash &gt; /etc/bash_completion.d/kubectl</span><br><span class="line"></span><br><span class="line">å®‰è£…å®Œæˆéœ€è¦é€€å‡ºåœ¨é‡æ–°è¿æ¥</span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl ap æŒ‰tabå¯ä»¥è¡¥å…¨äº†</span><br><span class="line">api-resources  api-versions   apply          </span><br><span class="line">[root@master01 ~]# kubectl get namespaces æŒ‰tabå¯ä»¥è¡¥å…¨äº†</span><br><span class="line">default          kube-flannel     kube-node-lease  kube-public      kube-system  </span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">è¿™ç¯‡æ–‡ç« å†™äº†éƒ¨ç½²k8sï¼Œè¶…çº§è¯¦ç»†ï¼Œæœ‰éœ€è¦çš„å°ä¼™ä¼´å¯ä»¥æŸ¥çœ‹</summary>
    
    
    
    <category term="K8s" scheme="https://www.fomal.cc/categories/K8s/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ‰1ã€K8såŸºç¡€å’Œèµ„æºä»‹ç»</title>
    <link href="https://www.fomal.cc/posts/4b5e2999.html"/>
    <id>https://www.fomal.cc/posts/4b5e2999.html</id>
    <published>2024-09-22T06:42:38.000Z</published>
    <updated>2024-09-30T07:51:03.814Z</updated>
    
    <content type="html"><![CDATA[<h2 id="K8såŸºç¡€å’Œèµ„æºä»‹ç»">K8såŸºç¡€å’Œèµ„æºä»‹ç»</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">k8æ˜¯å¯¹å®¹å™¨çš„ç¼–æ’å·¥å…·ï¼Œä¹‹å‰ä½¿ç”¨çš„docker-composeæ˜¯å•æœºç¼–æ’</span><br><span class="line"></span><br><span class="line">k8såŸç”Ÿçš„è¯­è¨€ï¼šgoè¯­è¨€</span><br><span class="line"></span><br><span class="line">ç®¡ç†k8sé›†ç¾¤å·¥å…·ï¼š</span><br><span class="line">1ã€vsocde</span><br><span class="line">2ã€rancherï¼ˆwebå›¾å½¢åŒ–ç•Œé¢ï¼‰</span><br><span class="line">3ã€k9s</span><br><span class="line"></span><br><span class="line"><span class="comment">#å’Œk8sç±»ä¼¼çš„ç¼–æ’å·¥å…·</span></span><br><span class="line">borg   </span><br><span class="line">swarm(dockerå†™çš„)</span><br><span class="line">mesos </span><br><span class="line">è¿™äº›éƒ½åœ¨ä¹‹å‰ä½¿ç”¨çš„ç¼–æ’å·¥å…·ï¼Œä½†ç°åœ¨k8sç«èµ·æ¥äº†ï¼Œä»–ä»¬å°±ä¸æ€ä¹ˆç”¨äº†</span><br></pre></td></tr></table></figure><h3 id="1ã€K8så‚è€ƒç½‘ç«™">1ã€<strong>K8så‚è€ƒç½‘ç«™</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å®˜ç½‘ï¼šhttps://kubernetes.io</span><br><span class="line">å®˜æ–¹æ–‡æ¡£ï¼šhttps://kubernetes.io/zh-cn/docs/home/</span><br><span class="line">kubeadmå®˜æ–¹æ–‡æ¡£ï¼šhttps://kubernetes.io/zh-cn/docs/setup/production-environment/tools/</span><br><span class="line">dockerå®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.docker.com/</span><br><span class="line">prometheuså®˜æ–¹æ–‡æ¡£ï¼šhttps://prometheus.io/docs/introduction/overview/</span><br><span class="line">ansibleå®‰è£…k8sé¡¹ç›®ï¼šhttps://github.com/easzlab/kubeasz?tab=readme-ov-file</span><br><span class="line">é˜¿é‡Œäº‘ACKï¼šhttps://www.aliyun.com/product/kubernetes</span><br><span class="line">äºšé©¬é€Šäº‘EKSï¼šhttps://aws.amazon.com/cn/eks/?nc2=h_ql_prod_ct_eks</span><br></pre></td></tr></table></figure><h3 id="2ã€K8sçš„2å¤§ç»„ä»¶">2ã€<strong>K8sçš„2å¤§ç»„ä»¶</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c/sç»“æ„çš„</span><br><span class="line"></span><br><span class="line">1ã€masterç»„ä»¶(æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl Plane Componentsï¼‰)</span><br><span class="line"></span><br><span class="line">2ã€nodeç»„ä»¶</span><br></pre></td></tr></table></figure><ul><li><strong>1ã€masterç»„ä»¶    (æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl Plane Componentsï¼‰)</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1ã€kube-apiserver(apiserver)ï¼šç±»ä¼¼äºå¸ä»¤éƒ¨ï¼Œæ‰€æœ‰masterä¸Šçš„ç»„ä»¶å·¥ä½œéƒ½è¦ç»è¿‡apiserver</span><br><span class="line">(å½“åœ¨å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤æˆ–è€…åœ¨UIç•Œé¢æ“ä½œèµ·ä¸€ä¸ªå®¹å™¨éƒ½éœ€è¦ç»è¿‡api,ä»–ä¼šé€šçŸ¥å…¶ä»–ç»„ä»¶ï¼Œæ‰€æœ‰ç»„ä»¶è°ƒç”¨ä»€ä¹ˆä¸œè¥¿æˆ–è€…è®¡ç®—ä»€ä¹ˆä¸œè¥¿éƒ½è¦ç»è¿‡ä»–)</span><br><span class="line"></span><br><span class="line">2ã€etcdï¼šæ‰€æœ‰ç»„ä»·äº§ç”Ÿçš„æ•°æ®å­˜æ”¾ä½ç½®ï¼Œå‚¨å­˜æ‰€æœ‰å‘½ä»¤ã€èµ„æºæ¸…å•ã€è¯ä¹¦ä¿¡ä»»ã€webæ“ä½œåŠå…¶ä»–ç»„ä»¶æ•°æ®</span><br><span class="line">(å¦‚æœè¿™ä¸ªå®•äº†ï¼Œè¿™ä¸€å¥—é›†ç¾¤å°±åºŸäº†ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™å¥—é›†ç¾¤éœ€è¦é‡æ–°æ­å»ºï¼Œè€Œä¸æ˜¯ä¿®å¤ä¸€å°etcd)</span><br><span class="line"></span><br><span class="line">3ã€kube-scheduler(scheduler  æ—¶è¯¥ä¸¢äº†å„¿)ï¼šèµ„æºè®¡ç®—ã€èµ„æºè°ƒåº¦</span><br><span class="line">(æ¯”å¦‚è¯´åœ¨å‘½ä»¤è¡Œæ‰§è¡Œåˆ›å»º10å°å®¹å™¨ï¼Œå…ˆç»è¿‡ä»–apiserverï¼Œä¼šæŠŠæœŸæœ›å€¼å­˜æ¡£etcd,ç„¶åé€šçŸ¥schedulerå»etcdæŠŠæ•°æ®å–å‡ºæ¥)</span><br><span class="line"></span><br><span class="line">4ã€kube-controller-manager(controller  æŠ—æŠ½äº†å„¿)ï¼šæ§åˆ¶å™¨ï¼Œæ§åˆ¶nodeç»„ä»¶å¯åŠ¨å®¹å™¨</span><br><span class="line">(scheduleåšå®Œèµ„æºçš„è®¡ç®—è°ƒåº¦,æ•°æ®å­˜æ¡£etcdäº†,controlleré€šè¿‡apiserveræ‹¿åˆ°æ•°æ®ï¼Œä¼šæ§åˆ¶nodeç»„ä»¶å¯åŠ¨)</span><br></pre></td></tr></table></figure><ul><li><strong>2ã€nodeç»„ä»¶</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1ã€kubeletï¼šæ§åˆ¶dockerå¯åŠ¨å®¹å™¨(æ§åˆ¶å®¹å™¨è¿æ—¶ï¼Œå¯åŠ¨æŒ‡å®šå®¹å™¨)</span><br><span class="line">(æ¯ä¸€ä¸ªnodeéƒ½è¦è£…)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer runtimeï¼‰</span><br><span class="line"> (æ¯ä¸€ä¸ªnodeèŠ‚ç‚¹ä¸Šå¾—è£…ä¸€ä¸ªå®¹å™¨è¿è¡Œæ—¶)</span><br><span class="line">    - containerd</span><br><span class="line">    - CRI-O</span><br><span class="line">    - Docker Engine</span><br><span class="line">    - Mirantis Container Runtime</span><br><span class="line"></span><br><span class="line">3ã€kube-proxyï¼ˆå¯é€‰ï¼‰ï¼šPODç«¯å£æ˜ å°„ï¼Œç½‘ç»œç›¸å…³</span><br><span class="line">å¯ä»¥ç†è§£ä¸ºpodå°±æ˜¯å®¹å™¨</span><br><span class="line">èµ·podéœ€è¦åšç«¯å£æ˜ å°„ï¼Œä»–å°±æ˜¯åšç«¯å£æ˜ å°„çš„å·¥å…·</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#k8sä¸‰å¤§æ¥å£APIäºŒæ¬¡å¼€å‘ï¼Œè°ƒç”¨æ¥å£</span></span><br><span class="line">CRIï¼šruntimeï¼Œå®¹å™¨æ“ä½œæ¥å£</span><br><span class="line">CNIï¼šnetworkï¼Œç½‘ç»œæ“ä½œæ¥å£</span><br><span class="line">CSIï¼šstorageï¼Œå‚¨å­˜æ“ä½œæ¥å£</span><br></pre></td></tr></table></figure><h3 id="3ã€K8sæ¶æ„">3ã€<strong>K8sæ¶æ„</strong></h3><p>å•æœºèŠ‚ç‚¹æ¶æ„</p><p><img src="../image/study_img/image-20240912101412211.png" alt="image-20240912101412211"></p><p>é«˜å¯ç”¨æ¶æ„</p><p><img src="../image/study_img/image-20240912163330677.png" alt="image-20240912163330677"></p><p><img src="../image/study_img/image-20240912102531543.png" alt="image-20240912102531543"></p><p>podåˆ›å»ºæµç¨‹</p><p><img src="../image/study_img/image-20240912103904760.png" alt="image-20240912103904760"></p><p><img src="../image/study_img/image-20240912173745374.png" alt="image-20240912173745374"></p><h3 id="4ã€k8sæ ¸å¿ƒèµ„æº-æ“ä½œå¯¹è±¡">4ã€<strong>k8sæ ¸å¿ƒèµ„æº(æ“ä½œå¯¹è±¡)</strong></h3><p><strong>â‘ ã€podèµ„æº</strong></p><p>â‘ ä»€ä¹ˆæ˜¯pod<br>1ã€Podæ˜¯K8sçš„æœ€å°å•ä½<br>2ã€Podçš„IPåœ°å€æ˜¯éšæœºçš„ï¼Œåˆ é™¤Podä¼šæ”¹å˜IP<br>3ã€Podéƒ½æœ‰ä¸€ä¸ªæ ¹å®¹å™¨<br>4ã€ä¸€ä¸ªPodå†…å¯ä»¥ç”±ä¸€ä¸ªå®¹å™¨æˆ–å¤šä¸ªå®¹å™¨ç»„æˆ<br>5ã€ä¸€ä¸ªPodå†…çš„å®¹å™¨å…±äº«æ ¹å®¹å™¨çš„ç½‘ç»œã€åç§°ç©ºé—´ã€å’Œæ–‡ä»¶ç³»ç»Ÿå·    (æ¯”å¦‚è¯´èµ·ä¸€ä¸ªnginxçš„pod,ä»–ä¼šå’Œæ ¹å®¹å™¨å…±äº«ç½‘ç»œã€åç§°ç©ºé—´ã€å’Œæ–‡ä»¶ç³»ç»Ÿã€‚åŸç†æ˜¯ï¼šæ ¹å®¹å™¨é‡Œé¢çš„ç½‘ç»œæ¨¡å¼ç”¨çš„æ˜¯dockerç½‘ç»œæ¨¡å¼ä¸­çš„Containeræ¨¡å¼)<br>6ã€ä¸€ä¸ªPodå†…çš„ç½‘ç»œåœ°å€ç”±æ ¹å®¹å™¨æä¾›</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¯·é—®è´µå…¬å¸k8sæ¶æ„ä¸€ä¸ªpodé‡Œé¢èµ·å‡ ä¸ªå®¹å™¨</span><br><span class="line"></span><br><span class="line"> ç­”ç²¾ç¡®çš„æ•°å­—å°±æ˜¯é”™è¯¯çš„ï¼Œé¦–å…ˆåº”è¯¥podé‡Œé¢èµ·å‡ ä¸ªå®¹å™¨å–å†³äºé¡¹ç›®</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240912104532405.png" alt="image-20240912104532405"></p><p>â‘¡podè¿è¡ŒçŠ¶æ€ï¼Œåªè¦è®°ä½ä¸æ˜¯runingçŠ¶æ€å°±æ˜¯æœ‰é—®é¢˜çš„</p><table><thead><tr><th>çŠ¶æ€</th><th>æè¿°</th></tr></thead><tbody><tr><td>Pendingï¼ˆç­‰å¾…ï¼‰</td><td>Podå·²ç»è¢«K8Sç³»ç»Ÿæ¥å—ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ï¼Œå°šæœªåˆ›å»ºï¼Œäº¦æœªè¿è¡Œã€‚æ­¤é˜¶æ®µåŒ…æ‹¬ç­‰å¾…Podè¢«è°ƒåº¦çš„æ—¶é—´å’Œé€šè¿‡ç½‘ç»œä¸‹è½½é•œåƒçš„æ—¶é—´</td></tr><tr><td>Runningï¼ˆè¿è¡Œï¼‰</td><td>Podå·²ç»ç»‘å®šåˆ°æŸä¸ªèŠ‚ç‚¹(node)ï¼ŒPodä¸­æ‰€æœ‰å®¹å™¨éƒ½å·²è¢«åˆ›å»ºï¼Œè‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ä»åœ¨è¿è¡Œï¼Œæˆ–è€…å¤„äºå¯åŠ¨æˆ–é‡å¯çŠ¶æ€</td></tr><tr><td>Succeededï¼ˆæˆåŠŸï¼‰</td><td>Podä¸­æ‰€æœ‰å®¹å™¨éƒ½å·²æˆåŠŸç»ˆæ­¢ï¼Œå¹¶ä¸”ä¸ä¼šå†é‡å¯</td></tr><tr><td>Failedï¼ˆå¤±è´¥ï¼‰</td><td>Podä¸­æ‰€æœ‰å®¹å™¨éƒ½å·²æˆåŠŸç»ˆæ­¢ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå®¹å™¨æ˜¯å› ä¸ºå¤±è´¥è€Œç»ˆæ­¢</td></tr><tr><td>Unknownï¼ˆæœªçŸ¥ï¼‰</td><td>å› ä¸ºæŸäº›åŸå› æ— æ³•è·å–PodçŠ¶æ€ï¼Œè¿™ç§æƒ…å†µï¼Œé€šå¸¸æ˜¯å› ä¸ºä¸Podæ‰€åœ¨ä¸»æœºé€šä¿¡å¤±è´¥</td></tr></tbody></table><p><strong>â‘¡ã€serviceèµ„æº</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serviceä¹Ÿæ˜¯k8sæ ¸å¿ƒèµ„æºä¹‹ä¸€ï¼Œserviceå®šä¹‰äº†æœåŠ¡çš„å…¥å£åœ°å€ï¼Œç”¨æ¥å°†åç«¯çš„podæœåŠ¡æš´éœ²ç»™å¤–éƒ¨çš„ç”¨æˆ·è®¿é—®</span><br></pre></td></tr></table></figure><p>serviceæä¾›äº†2ç§ç½‘ç»œèµ„æº</p><p><img src="../image/study_img/image-20240912180101026.png" alt="image-20240912180101026"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€ç§ï¼šNodePort  å®¿ä¸»æœºç«¯å£æ˜ å°„clusteripç«¯å£ï¼Œå¯¹å¤–æä¾›æœåŠ¡</span><br><span class="line"></span><br><span class="line">ç¬¬äºŒç§ï¼šClusterIP  podçš„è´Ÿè½½å‡è¡¡(èµ·10ä¸ªpod,clusteripå¯ä»¥ç»™è¿™äº›podè´Ÿè½½ï¼Œä½†æ˜¯clusteripæ˜¯å†…ç½‘ipï¼Œå®¿ä¸»æœºè¿˜æ˜¯ä¸èƒ½è®¿é—®ï¼Œæ‰€ä»¥serviceåˆæä¾›äº†nodeport)</span><br><span class="line"></span><br><span class="line"><span class="comment">#é—®é¢˜ï¼šPODçš„IPæ˜¯éšæœºçš„ï¼Œå¦‚æœä¸€ä¸ªPODå®•æœºäº†ï¼Œk8sä¼šè‡ªåŠ¨æ‹‰èµ·ä¸€ä¸ªæ–°çš„pod,ipå˜äº†å¦‚ä½•åŠ å…¥åˆ°ClusterIPè¿™ä¸ªè´Ÿè½½å‡è¡¡é›†ç¾¤ä¸­ï¼Ÿ</span></span><br><span class="line">è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨DNSè§£æPODçš„IPåˆ°ä¸€ä¸ª<span class="string">&#x27;å­—ç¬¦ä¸²ä¸Š&#x27;</span>(æ¯ä¸ªpodå¯åŠ¨éƒ½è¦åˆ°æ ‡ç­¾app:nginx)</span><br><span class="line">DNSçš„æœåŠ¡ï¼š</span><br><span class="line">    - coreDNS(k8sç”¨è¿™ä¸ª)</span><br><span class="line">    - bind9(æ¯”è¾ƒéº»çƒ¦)</span><br><span class="line">    - dnsmsq(å†…å¤–çš„dnsç”¨)</span><br></pre></td></tr></table></figure><p><strong>â‘¢ã€labelæ ‡ç­¾èµ„æº</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Labelæ ‡ç­¾æ˜¯K8Sä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªå±æ€§ï¼ŒLabelæ ‡ç­¾å°±åƒèº«ä»½è¯ä¸€æ ·ï¼Œå¯ä»¥ç”¨æ¥è¯†åˆ«K8Sçš„å¯¹è±¡ã€‚</span><br><span class="line">ä¼ ç»Ÿæ¶æ„ä¸­ï¼Œä¸åŒçš„æœåŠ¡åº”ç”¨ä¹‹é—´é€šè®¯ï¼Œéƒ½æ˜¯é€šè¿‡IPå’Œç«¯å£ï¼Œä½†æ˜¯åœ¨K8Sä¸­å¾ˆå¤šåŒ¹é…å…³ç³»éƒ½æ˜¯é€šè¿‡æ ‡ç­¾æ¥æ‰¾ã€‚</span><br></pre></td></tr></table></figure><p><strong>â‘£ã€Namespaceèµ„æº</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Namespaceï¼ˆåç§°ç©ºé—´ï¼‰æ˜¯K8Sä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼ŒNamespaceå°†é›†ç¾¤å†…éƒ¨çš„èµ„æºè¿›è¡Œéš”ç¦»åˆ’åˆ†ã€‚</span><br><span class="line">åœ¨Namespaceä¸­ï¼Œå½¢æˆé€»è¾‘ä¸Šçš„ä¸åŒé¡¹ç›®ç»„æˆ–ç”¨æˆ·ç»„ã€‚</span><br></pre></td></tr></table></figure><p><strong>â‘¤ã€Controlleræ§åˆ¶å™¨èµ„æº</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Controllerç”¨æ¥ç®¡ç†Podã€‚</span></span><br><span class="line"><span class="comment">## Podæ§åˆ¶å™¨çš„ç§ç±»æœ‰å¾ˆå¤šï¼š</span></span><br><span class="line">  - RCèµ„æºï¼šå¯ä»¥åšçš„è‡ªåŠ¨æ‹‰èµ·ï¼Œæ§åˆ¶å¤šä¸ªå‰¯æœ¬ï¼Œä½†ç°åœ¨ä¸ç”¨äº†</span><br><span class="line">  - RS   RCæ§åˆ¶å™¨çš„å‡çº§ç‰ˆï¼Œå¯ä»¥è‡ªåŠ¨æ‹‰èµ·å®•æœºçš„POD</span><br><span class="line">  - Deployment  ç”Ÿäº§ä¸­å¸¸ç”¨çš„æ§åˆ¶å™¨ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼ŒåŒ…å«äº†RSæ§åˆ¶å™¨ï¼Œå¯¹é•œåƒåšç‰ˆæœ¬ç®¡ç†(æ¯”è¾ƒå¸¸ç”¨)</span><br><span class="line">  - DaemonSet   ä¿è¯æ‰€æœ‰nodeèŠ‚ç‚¹ä¸Šï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªpodè¿è¡Œ</span><br><span class="line">  - Staefulset  æœ‰çŠ¶æ€çš„åº”ç”¨(å¦‚mysqlçš„ä¸»ä»å¤åˆ¶)ï¼Œä¸ºpodæä¾›å”¯ä¸€æ ‡è¯†</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  åé¢èµ·podä¼šå†™èµ„æºæ¸…å•èµ·10ä¸ªnginxï¼ŒæŒ‚äº†ä¸€å°å°±ç›´æ¥æŒ‚äº†ï¼Œpodä¸ä¼šå†èµ·ä¸€å°ï¼Œè€Œèƒ½å¤Ÿæ‹‰èµ·çš„æ˜¯controllerèµ„æºï¼Œä»–ä¼šæ£€æµ‹èµ„æºæ¸…å•æ˜¯ä¸æ˜¯10ä¸ªpodéƒ½åœ¨ï¼Œå¦‚æœå°‘ä¸€ä¸ªï¼Œæ§åˆ¶å™¨ä¼šé‡æ–°æ‹‰èµ·ä¸€ä¸ªå†åŠ å…¥é›†ç¾¤</span><br></pre></td></tr></table></figure><p><strong>pod RC Service çš„å…³ç³»</strong></p><p><img src="../image/study_img/image-20240912120405666.png" alt="image-20240912120405666"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è‡ªåŠ¨æ‰©ç¼©å®¹ï¼š</span><br><span class="line">æ¯”å¦‚è¯´ç°åœ¨æœ‰10å°nginx,åŒåä¸€æµé‡ä¸Šæ¥äº†ï¼Œ10å°ä¸å¤Ÿç”¨ï¼Œæ€ä¹ˆåŠï¼Ÿ</span><br><span class="line">k8sæœ‰ä¸€ä¸ªèµ„æºï¼Œä¸€å¼€å§‹10ä¸ªnginxå°±å¤Ÿäº†ï¼Œæµé‡ä¸Šæ¥äº†ä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œæµé‡ä¸‹å»äº†ä¼šè‡ªåŠ¨ç¼©å®¹ï¼Œè€Œä¸”æ‰©å‡ºæ¥çš„podå’Œä¹‹å‰çš„podä¸€æ¨¡ä¸€æ ·</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å¼€å§‹å†™k8sçš„åŸºç¡€ä»‹ç»å•¦</summary>
    
    
    
    <category term="k8s" scheme="https://www.fomal.cc/categories/k8s/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ¡åä¸€ã€groupèµ„æºæ§åˆ¶/æ·»åŠ ç£ç›˜</title>
    <link href="https://www.fomal.cc/posts/cb5f694f.html"/>
    <id>https://www.fomal.cc/posts/cb5f694f.html</id>
    <published>2024-09-22T06:33:37.000Z</published>
    <updated>2024-10-02T07:54:56.128Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Cgroup-èµ„æºæ§åˆ¶-æ·»åŠ ç£ç›˜">Cgroup(èµ„æºæ§åˆ¶)/æ·»åŠ ç£ç›˜</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1ã€#dockerå¦‚ä½•åšèµ„æºé™åˆ¶çš„(æ¯”å¦‚è¯´å†…å­˜çš„é™åˆ¶)</span><br><span class="line">docker run -m å»é™åˆ¶å†…å­˜</span><br><span class="line"></span><br><span class="line">2ã€#åŸç†æ˜¯ä»€ä¹ˆ</span><br><span class="line">-mæŒ‡å®šé™åˆ¶å†…å­˜çš„æ•°é‡ï¼Œdockeré€šè¿‡å†…æ ¸å‚æ•°ï¼Œä¹Ÿå°±æ˜¯Cgroupå¯¹èµ„æºè¿›è¡Œé™åˆ¶</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#Cgroupçš„ä½œç”¨</span><br><span class="line">åœ¨æ“ä½œç³»ç»Ÿè§£å†³äº†èµ„æºç›¸ä¸éš”ç¦»çš„é—®é¢˜ä»¥åï¼Œè¿˜éœ€è¦è§£å†³èµ„æºé™åˆ¶çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯é¿å…åœ¨åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿä¸­ï¼Œé˜²æ­¢æœ‰äº›èµ„æºæ¶ˆè€—è¾ƒå¤§çš„å®¹å™¨ï¼Œå°†æ•´ä¸ªç‰©ç†æœºå™¨(å®¿ä¸»æœº)çš„ç¡¬ä»¶èµ„æº(CPU,Memory)å æ»¡ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">åœ¨Linux ç³»ç»Ÿä¸­èƒ½å¤Ÿæ§åˆ¶çš„èµ„æºåˆ—è¡¨å¦‚ä¸‹</span><br><span class="line">memory      <span class="comment">#å†…å­˜é™åˆ¶</span></span><br><span class="line">hugetlb     <span class="comment">#huge pages ä½¿ç”¨é‡</span></span><br><span class="line">cpu         <span class="comment">#é™åˆ¶CPUä½¿ç”¨ç‡</span></span><br><span class="line">cpuacct     <span class="comment">#ç»Ÿè®¡cgroupsä¸­çš„è¿›ç¨‹çš„CPUä½¿ç”¨æŠ¥å‘Š</span></span><br><span class="line">cpuset      <span class="comment">#ç»‘å®šcgroupsåˆ°æŒ‡å®š CPUså’Œ NUMAèŠ‚ç‚¹</span></span><br><span class="line">innodb_lock_wait_timeout  <span class="comment">#blockè®¾å¤‡çš„I0é€Ÿåº¦</span></span><br><span class="line">not_cls     <span class="comment">#ç½‘ç»œæ¥å£è®¾ç½®ä¼˜å…ˆçº§</span></span><br><span class="line">devices     <span class="comment">#mknodeè®¿é—®è®¾å¤‡æƒé™</span></span><br><span class="line">freezer     <span class="comment">#suspendå’Œrestore cgroups è¿›ç¨‹</span></span><br><span class="line">perf_event  <span class="comment">#æ€§èƒ½ç›‘æ§</span></span><br><span class="line">pids        <span class="comment">#é™åˆ¶å­æ ‘ cgroups æ€»è¿›ç¨‹æ•°</span></span><br><span class="line"></span><br><span class="line">4ã€#å®¹å™¨ä¸å®¹å™¨ä¹‹é—´çš„èµ„æºå¦‚ä½•éš”ç¦»ï¼Ÿ</span><br><span class="line">Namespace  åç§°ç©ºé—´éš”ç¦»</span><br><span class="line"></span><br><span class="line">5ã€#ä¸ºä»€ä¹ˆå®¹å™¨ä¹‹é—´çš„èµ„æºå¯ä»¥é€šè¿‡nsè¿›è¡Œéš”ç¦»ï¼Ÿ</span><br><span class="line">å› ä¸ºdockerå®¹å™¨è¿è¡Œèµ·æ¥æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œæ¯ä¸€ä¸ªå®¹å™¨éƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹ä¹‹é—´ç”¨æ¥èµ„æºéš”ç¦»çš„å°±æ˜¯Namespace</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ç³»ç»Ÿå®ç°çš„é™åˆ¶èµ„æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 node]# <span class="built_in">cat</span> /proc/cgroups </span><br><span class="line"><span class="comment">#subsys_name    hierarchy       num_cgroups     enabled</span></span><br><span class="line">cpuset  11      7       1</span><br><span class="line">cpu     3       77      1</span><br><span class="line">cpuacct 3       77      1</span><br><span class="line">memory  7       77      1</span><br><span class="line">devices 5       77      1</span><br><span class="line">freezer 10      7       1</span><br><span class="line">net_cls 2       7       1</span><br><span class="line">blkio   9       77      1</span><br><span class="line">perf_event      4       7       1</span><br><span class="line">hugetlb 6       7       1</span><br><span class="line">pids    8       77      1</span><br><span class="line">net_prio        2       7       1</span><br></pre></td></tr></table></figure><h3 id="1ã€æ¡ˆä¾‹ï¼šé™åˆ¶SSHå†…å­˜ä½¿ç”¨">1ã€<strong>æ¡ˆä¾‹ï¼šé™åˆ¶SSHå†…å­˜ä½¿ç”¨</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1ã€é™åˆ¶ç³»ç»ŸæœåŠ¡å†…å­˜</span><br><span class="line">[root@docker01 node]# <span class="built_in">cd</span> /sys/fs/cgroup/memory/system.slice/sshd.service/</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹å†…å­˜æœåŠ¡é™åˆ¶(byte)</span><br><span class="line">[root@docker01 sshd.service]# <span class="built_in">cat</span> memory.limit_in_bytes </span><br><span class="line">9223372036854771712</span><br><span class="line"></span><br><span class="line">3ã€è®¡ç®—ä¸€ä¸‹ï¼Œå¤§æ¦‚æ˜¯7G,è¿™ä¸ªæ˜¯é»˜è®¤å€¼ï¼Œä¸ç®¡ç³»ç»Ÿå†…å­˜å¤šå¤§ï¼Œæ¯ä¸ªè¿›ç¨‹é»˜è®¤æœ€å¤§ä½¿ç”¨7G,è¿™æ ·å°±ç›¸å½“äºæ²¡æœ‰åšä»»ä½•é™åˆ¶Â·</span><br><span class="line">[root@docker01 sshd.service]# python</span><br><span class="line">&gt;&gt;&gt; 9223372036854771712/1024/1024/1024/1024/1024/1024</span><br><span class="line">7</span><br><span class="line"></span><br><span class="line">4ã€sshæœåŠ¡ä¸æ˜¯æ‹¿å®¹å™¨èµ·èµ·æ¥çš„ï¼Œå¦‚æœæƒ³ç»™ä»–é™åˆ¶ï¼Œå°±éœ€è¦æ”¹æ–‡ä»¶é‡Œé¢çš„æ•°å­—å¤§å°</span><br><span class="line">è®¾ç½®é™åˆ¶å†…å­˜</span><br><span class="line">[root@docker01 sshd.service]# <span class="built_in">echo</span> 64K &gt; memory.limit_in_bytes </span><br><span class="line">æ‰§è¡Œä¹‹åï¼Œsshå°±ç«‹é©¬ç«¯å£è¿æ¥äº†ï¼Œåªå†™1ä¸ªå­—èŠ‚ï¼Œæ ¹æœ¬å°±è¿ä¸ä¸Šssh</span><br><span class="line"></span><br><span class="line">5ã€åˆ°è™šæ‹Ÿæœºé‡Œé¢æŸ¥çœ‹æ—¥å¿—</span><br><span class="line">tailf /var/log/messages</span><br><span class="line"></span><br><span class="line">6ã€å¯ä»¥å‘ç°ï¼Œè¿œç¨‹è¿æ¥æ—¶ï¼Œä¼šæ€è¿›ç¨‹ï¼Œå› ä¸ºè¿œç¨‹è¿æ¥ä¼šäº§ç”Ÿä¸€ä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯sshè¢«åšäº†é™åˆ¶</span><br><span class="line">ï¼Œä¼šæ€æ‰è¿æ¥çš„è¿›ç¨‹</span><br><span class="line"></span><br><span class="line">Cgroupè°ƒç”¨å†…æ ¸å‚æ•°ï¼Œå¦‚æœåšé™åˆ¶ï¼Œå°±æ”¹memory.limit_in_bytesæ–‡ä»¶ï¼Œå†…æ ¸æ¥è¯»å–è¿™ä¸ªæ–‡ä»¶æ¥è¿›è¡Œé™åˆ¶</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240912151039561.png" alt="image-20240912151039561"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 sshd.service]# <span class="built_in">echo</span> 9223372036854771712 &gt; memory.limit_in_bytes</span><br><span class="line"></span><br><span class="line">[root@docker01 sshd.service]# <span class="built_in">cat</span> memory.limit_in_bytes</span><br><span class="line">9223372036854771712</span><br></pre></td></tr></table></figure><h3 id="2ã€OverlayFS">2ã€<strong>OverlayFS</strong></h3><p><strong>OverlayFS</strong> <strong>å®ç°æ–¹å¼</strong></p><p>OverlayFSé€šè¿‡ä¸‰ä¸ªç›®å½•ï¼šlowerç›®å½•ã€upperç›®å½•ã€ä»¥åŠworkç›®å½•å®ç°,å…¶ä¸­lowerç›®å½•å¯ä»¥æ˜¯å¤šä¸ª,upperç›®å½•ä¸ºå¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œçš„ç›®å½•, workç›®å½•ä¸ºå·¥ä½œåŸºç¡€ç›®å½•,æŒ‚è½½åå†…å®¹ä¼šè¢«æ¸…ç©º,ä¸”åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å…¶å†…å®¹ç”¨æˆ·ä¸å¯è§,æœ€åè”åˆæŒ‚è½½å®Œæˆç»™ç”¨æˆ·å‘ˆç°çš„ç»Ÿä¸€è§†å›¾ç§°ä¸ºmergedç›®å½•ã€‚</p><p><img src="../image/study_img/image-20240913170119816.png" alt="image-20240913170119816"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ¨¡æ‹Ÿoverlayfså­˜å‚¨æ–¹å¼</span></span><br><span class="line">1.åˆ›å»ºæ–‡ä»¶</span><br><span class="line">[root@k8s01 ~]# <span class="built_in">mkdir</span> /lower&#123;1..3&#125;</span><br><span class="line">[root@k8s01 ~]# <span class="built_in">mkdir</span> /upper /work /merged</span><br><span class="line"></span><br><span class="line">2.æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">[root@k8s01 ~]# mount -t overlay overlay -o</span><br><span class="line">lowerdir=/lower1:/lower2:/lower3,upperdir=/upper,workdir=/work /merged</span><br><span class="line"></span><br><span class="line">3.æŸ¥çœ‹æŒ‚è½½</span><br><span class="line">[root@k8s01 ~]# mount | grep merged</span><br><span class="line"></span><br><span class="line">4.åœ¨/upper ç›®å½•ä¸­å†™å…¥æ–‡ä»¶,åœ¨mergedä¸­å¯ä»¥æ˜¾ç¤º</span><br><span class="line">[root@k8s01 /]# <span class="built_in">touch</span> /upper/upper.txt</span><br><span class="line">[root@k8s01 /]# ll /merged/</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar 14 02:17 upper.txt</span><br><span class="line"></span><br><span class="line">5. åœ¨mergedä¸­å†™å…¥æ–‡ä»¶, å®é™…å­˜å‚¨åˆ°äº†/uppper</span><br><span class="line">[root@k8s01 /]# <span class="built_in">touch</span> /merged/d.txt</span><br><span class="line">[root@k8s01 /]# ll /upper/</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar 14 02:19 d.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ³¨:å¦‚æœæ²¡æœ‰upperdirï¼Œ mergedæ˜¯åªè¯»çš„</span><br><span class="line">[root@node-2 overlay2]# umount /merged</span><br><span class="line">[root@node-2 overlay2]# mount -t overlay overlay -o lowerdir=/lower1:/lower2 /merged</span><br><span class="line">[root@k8s01 /]# <span class="built_in">touch</span> /merged/c.txt</span><br><span class="line"><span class="built_in">touch</span>: cannot <span class="built_in">touch</span> â€˜/merged/c.txtâ€™: Read-only file system</span><br></pre></td></tr></table></figure><h3 id="3ã€æ‰©å±•æ·»åŠ ç£ç›˜å’Œæ›´æ”¹dockeré»˜è®¤æ•°æ®ç›®å½•">3ã€<strong>æ‰©å±•æ·»åŠ ç£ç›˜å’Œæ›´æ”¹dockeré»˜è®¤æ•°æ®ç›®å½•</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1ã€å…ˆå…³æœº</span><br><span class="line"></span><br><span class="line">2ã€æ·»åŠ ç£ç›˜</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240913172422996.png" alt="image-20240913172422996"></p><p><img src="../image/study_img/image-20240913172442557.png" alt="image-20240913172442557"></p><p><img src="../image/study_img/image-20240913172500576.png" alt="image-20240913172500576"></p><p><img src="../image/study_img/image-20240913172538917.png" alt="image-20240913172538917"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">3ã€æŸ¥çœ‹æ·»åŠ çš„ç£ç›˜</span><br><span class="line">[root@docker01 ~]# fdisk -l</span><br><span class="line">Disk /dev/sda: 21.5 GB, 21474836480 bytes, 41943040 sectors</span><br><span class="line">......</span><br><span class="line">.....</span><br><span class="line"><span class="comment">#/dev/sdbæ˜¯æ–°æ·»åŠ çš„ç£ç›˜</span></span><br><span class="line">Disk /dev/sdb: 10.7 GB, 10737418240 bytes, 20971520 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line">4ã€åˆ›å»ºåˆ†åŒº</span><br><span class="line">[root@docker01 ~]# fdisk /dev/sdb</span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition <span class="built_in">type</span>: <span class="comment">## é€‰æ‹©ä¸»åˆ†åŒºè¿˜æ˜¯æ‰©å±•åˆ†åŒº</span></span><br><span class="line">    p primary (0 primary, 0 extended, 4 free)</span><br><span class="line">    e extended</span><br><span class="line">Select (default p): p <span class="comment"># ä¸»åˆ†åŒº</span></span><br><span class="line">Partition number (1-4, default 1): 1 <span class="comment"># ä¸€ä¸ªåˆ†åŒº</span></span><br><span class="line">First sector (2048-104857599, default 2048): <span class="comment">## è®¾ç½®å¼€å¤´æ‰‡åŒºå¤§å°ï¼Œæˆ‘é€‰æ‹©é»˜è®¤</span></span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (2048-104857599, default 104857599): <span class="comment">## è®¾ç½®æœ€åæ‰‡åŒºå¤§å°ï¼Œæˆ‘é€‰æ‹©é»˜è®¤</span></span><br><span class="line">Partition 1 of <span class="built_in">type</span> Linux and of size 50 GiB is <span class="built_in">set</span>  <span class="comment">## åˆ†åŒºæˆåŠŸ</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w <span class="comment">## é€€å‡º</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€å†æ¬¡æŸ¥çœ‹ç£ç›˜</span><br><span class="line">[root@docker01 ~]# fdisk -l</span><br><span class="line">.....</span><br><span class="line">Disk /dev/sdb: 10.7 GB, 10737418240 bytes, 20971520 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0x481c9cdc</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sdb1            2048    20971519    10484736   83  Linux</span><br><span class="line"><span class="comment">#æ–°åˆ†åŒº /dev/sdb1 </span></span><br><span class="line"></span><br><span class="line">5ã€æ ¼å¼åŒ–åˆ†åŒº</span><br><span class="line">[root@docker01 ~]# mkfs.xfs /dev/sdb1</span><br><span class="line"></span><br><span class="line">6ã€æŸ¥çœ‹åˆ†åŒºçš„UUID</span><br><span class="line">[root@docker01 ~]# blkid /dev/sdb1</span><br><span class="line">/dev/sdb1: UUID=<span class="string">&quot;65cdcede-223b-40ad-aa68-6165b7606b71&quot;</span> TYPE=<span class="string">&quot;xfs&quot;</span> </span><br><span class="line"></span><br><span class="line">7ã€#è®¾ç½®æ°¸ä¹…æŒ‚è½½</span><br><span class="line">æ–¹æ³•ä¸€ï¼šè¿™ä¸ªæ–¹æ³•å¦‚æœå†™é”™ä¸€ä¸ªå­—æ¯ï¼Œå¾ˆå¯èƒ½é€ æˆç³»ç»Ÿèµ·ä¸æ¥ï¼Œæ‰€ä»¥å†™å®Œäº†è¦ä»”ç»†æ£€æŸ¥</span><br><span class="line">[root@docker01 ~]# vim /etc/fstab </span><br><span class="line"><span class="comment">#æŠŠå†…å®¹åŠ å…¥æœ€åä¸€è¡Œ</span></span><br><span class="line">UUID=65cdcede-223b-40ad-aa68-6165b7606b71   /docker_data  xfs     defaults        0 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ–¹æ³•äºŒï¼šå†™å…¥è‡ªå¯åŠ¨æ–‡ä»¶   è¿™ä¸ªå†™é”™äº†ä¸ä¼šé€ æˆç³»ç»Ÿèµ·ä¸æ¥çš„æƒ…å†µ</span><br><span class="line">vim /root/.bashrc </span><br><span class="line">mount -t xfs /dev/sdb1 /docker_data </span><br><span class="line">ä¸è¦å½±å“æ–‡ä»¶åŸå…ˆçš„å†…å®¹</span><br><span class="line"></span><br><span class="line">8ã€ä¸´æ—¶æŒ‚è½½</span><br><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> /docker_data</span><br><span class="line">[root@docker01 ~]# mount -a</span><br><span class="line"></span><br><span class="line">9ã€æŸ¥çœ‹ç£ç›˜åˆ†åŒº</span><br><span class="line">[root@docker01 ~]# <span class="built_in">df</span> -Th</span><br><span class="line">Filesystem              Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/centos-root xfs        19G   14G  5.1G  73% /</span><br><span class="line">devtmpfs                devtmpfs  1.6G     0  1.6G   0% /dev</span><br><span class="line">tmpfs                   tmpfs     1.6G     0  1.6G   0% /dev/shm</span><br><span class="line">tmpfs                   tmpfs     1.6G   12M  1.6G   1% /run</span><br><span class="line">tmpfs                   tmpfs     1.6G     0  1.6G   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1               xfs       497M  126M  372M  26% /boot</span><br><span class="line">tmpfs                   tmpfs     318M     0  318M   0% /run/user/0</span><br><span class="line">/dev/sdb1               xfs        10G   33M   10G   1% /docker_data</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹æ­¥éª¤å¯ä»¥ä¸éœ€è¦æ“ä½œï¼Œå¦‚æœä¸æ›´æ”¹dockeré»˜è®¤æ•°æ®ç›®å½•çš„è¯ï¼Œä¸éœ€è¦æ“ä½œï¼Œå¦‚æœæ›´æ”¹äº†æ•°æ®ç›®å½•ï¼Œä¹‹å‰æ‹‰çš„é•œåƒå°±éœ€è¦é‡æ–°æ‹‰å–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¿®æ”¹dockeré»˜è®¤æ•°æ®ç›®å½•çš„æ“ä½œ</span></span><br><span class="line"></span><br><span class="line">1ã€åœ¨é…ç½®æ–‡ä»¶é‡Œé¢æ·»åŠ ç›®å½•ä¿¡æ¯</span><br><span class="line">[root@docker01 docker_data]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.105&quot;</span>,<span class="string">&quot;http://172.16.1.101:5000&quot;</span>],</span><br><span class="line"><span class="string">&quot;data-root&quot;</span>: <span class="string">&quot;/docker_data&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">[root@docker01 docker_data]# systemctl daemon-reload</span><br><span class="line">[root@docker01 docker_data]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹dockerä¿¡æ¯</span><br><span class="line">[root@docker01 docker_data]# docker info</span><br><span class="line">Docker Root Dir: /docker_data</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">dockeråšèµ„æºé™åˆ¶çš„æ–¹æ³•</summary>
    
    
    
    <category term="docker" scheme="https://www.fomal.cc/categories/docker/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ¡åã€å®¹å™¨åŒ–ç›‘æ§Prometheus</title>
    <link href="https://www.fomal.cc/posts/f75a8470.html"/>
    <id>https://www.fomal.cc/posts/f75a8470.html</id>
    <published>2024-09-22T06:12:54.000Z</published>
    <updated>2024-10-02T07:53:51.074Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å®¹å™¨åŒ–ç›‘æ§Promethues">å®¹å™¨åŒ–ç›‘æ§Promethues</h2><h3 id="1ã€Dockerè‡ªå¸¦çš„ç›‘æ§å‘½ä»¤">1ã€<strong>Dockerè‡ªå¸¦çš„ç›‘æ§å‘½ä»¤</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 ~]# docker ps</span><br><span class="line">[root@docker02 ~]# docker top mysql80</span><br><span class="line">[root@docker02 ~]# docker top jenkins</span><br><span class="line">[root@docker02 ~]# docker stats</span><br></pre></td></tr></table></figure><p>æœ‰äº†ä¸Šé¢çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨zabbixæ¥ç›‘æ§dockerå®¹å™¨äº†ï¼Œä½†æ˜¯é—®é¢˜å°±æ˜¯ï¼Œ zabbix-agent çš„ç«¯å£ï¼Œæˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Šåªèƒ½æ˜ å°„å‡ºæ¥ä¸€ä¸ªã€‚<br><strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>1.èµ·å¤šå—ç½‘å¡<br>2.æ¯ä¸ªå®¹å™¨è£…ä¸€ä¸ªzabbix-server<br>3.ä¿®æ”¹ä¸åŒå®¹å™¨çš„agentç«¯å£<br>4.æ˜ å°„å®¹å™¨çš„ç›¸å…³æ–‡ä»¶ï¼Œç„¶åç›‘æ§å®¿ä¸»æœºä¸Šçš„å¯¹åº”æ–‡ä»¶<br>5.ä¸ç”¨zabbix</p><h3 id="2ã€ç›‘æ§è½¯ä»¶çš„ä»‹ç»">2ã€<strong>ç›‘æ§è½¯ä»¶çš„ä»‹ç»</strong></h3><p><em>æœåŠ¡ç«¯</em></p><p>prometheusï¼šç±»ä¼¼äºzabbix-serveræœåŠ¡ç«¯ï¼Œè´Ÿè´£æ”¶é›†å®¢æˆ·ç«¯ç›‘æ§æŒ‡æ ‡(Metrics)</p><p><em>å®¢æˆ·ç«¯</em></p><p>cAdvisorï¼šç±»ä¼¼ zabbix-agent å®¢æˆ·ç«¯ï¼Œç”¨æ¥æ”¶é›†å®¹å™¨é‡Œé¢çš„ç›‘æ§æŒ‡æ ‡<br>node_exporterï¼šç±»ä¼¼ zabbix-agent å®¢æˆ·ç«¯ï¼Œç”¨æ¥æ”¶é›†å®¿ä¸»æœºçš„ç›‘æ§æŒ‡æ ‡</p><p><em>ç»„ä»¶</em></p><p>Grafanaï¼šå‡ºå›¾å·¥å…·</p><p>1ã€cAdvisorä»‹ç»     å‡¯å¾—æ­ªçƒ­å„¿</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cAdvisorä»‹ç»</span><br><span class="line">cAdvisoræ˜¯è°·æ­Œå¼€å‘çš„å®¹å™¨ç›‘æ§å·¥å…·ï¼ŒcAdvisorä¼šæ˜¾ç¤ºå½“å‰hostèµ„æºä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬CPUã€å†…å­˜ã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç­‰ã€‚</span><br><span class="line"></span><br><span class="line">ä¸è¿‡cAdvisoræä¾›çš„æ“ä½œç•Œé¢ç•¥æ˜¾ç®€é™‹ï¼Œè€Œä¸”è¦åœ¨ä¸åŒçš„é¡µé¢ä¹‹é—´è·³è½¬ï¼Œå¹¶ä¸”åªèƒ½ç›‘æ§ä¸€ä¸ªhostï¼Œä¸å…è®©äººè´¨ç–‘å®ƒçš„å®ç”¨æ€§ï¼Œä½†æ˜¯cAdvisoræœ‰ä¸€ä¸ªäº®ç‚¹ï¼Œå°±æ˜¯å°†ç›‘æ§æ•°æ®å¯¼å‡ºç»™å…¶ä»–ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œè€Œä¸”å®ƒå…¼å®¹å¾ˆå¤šç¬¬ä¸‰æ–¹å·¥å…·ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒå®šä½æˆæ˜¯ä¸€ä¸ª ç›‘æ§æ•°æ®æ”¶é›†å™¨ ï¼Œæ”¶é›†å’Œå¯¼å‡ºæ˜¯å®ƒçš„å¼ºé¡¹ï¼Œè€Œéå±•ç¤º</span><br><span class="line"></span><br><span class="line">dokcer stats å¯ä»¥æŸ¥çœ‹è¿è¡Œçš„ Docker é•œåƒçš„è¿è¡ŒçŠ¶æ€ï¼Œä¾‹å¦‚ï¼šè¿™ç§æ–¹å¼æ¯”è¾ƒåŸå§‹ï¼Œå› ä¸ºä½ æ— æ³•é€šè¿‡http çš„æ–¹å¼æ¥è·å–æ•°æ®ï¼Œè€Œä¸”æ²¡æœ‰ç•Œé¢ï¼Œæ•°æ®å¯è§†åŒ–è¿˜éœ€è¦åšå¤§é‡çš„å·¥ä½œã€‚</span><br><span class="line"></span><br><span class="line">ç”±äº dokcer stats æœ‰è¿™äº›é—®é¢˜ï¼Œæ‰€ä»¥ cadvisor è¯ç”Ÿäº†ã€‚ cadvisor ä¸ä»…å¯ä»¥æœé›†ä¸€å°æœºå™¨ä¸Šæ‰€æœ‰è¿è¡Œçš„å®¹å™¨ä¿¡æ¯è¿˜æä¾›åŸºç¡€æŸ¥è¯¢ç•Œé¢å’Œ http æ¥å£ï¼Œæ–¹ä¾¿ Prometheus è¿›è¡Œæ•°æ®æŠ“å–ã€‚</span><br></pre></td></tr></table></figure><p>2ã€grafanaä»‹ç»<br>grafanaæ˜¯ä¸€ä¸ªæ”¯æŒå¤šç§æ•°æ®æºçš„å›¾å½¢å±•ç¤ºå·¥å…·</p><p>3ã€prometheusä»‹ç»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">promethueså®˜ç½‘ï¼šhttps://prometheus.io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">prometheusæ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„ç›‘æ§å·¥å…·ï¼Œæä¾›äº†ç›‘æ§æ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€å¤„ç†ã€å¯è§†åŒ–ã€å’Œå‘Šè­¦ç­‰ä¸€ç³»åˆ—å®Œæ•´çš„ç›‘æ§ä½“ç³»ã€‚</span><br><span class="line"></span><br><span class="line">ç»„ä»¶åŒ…å«ï¼š</span><br><span class="line">Node Exporterï¼šè´Ÿè´£æ”¶é›†hostç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿæ•°æ®ï¼Œä»¥å®¹å™¨çš„å½¢å¼è¿è¡Œåœ¨æ‰€æœ‰çš„hostä¸Šã€‚</span><br><span class="line">cAdvisorï¼šè´Ÿè´£æ”¶é›†å®¹å™¨æ•°æ®ï¼Œä»¥å®¹å™¨çš„å½¢å¼è¿è¡Œåœ¨æ‰€æœ‰çš„hostä¸Šã€‚</span><br><span class="line"></span><br><span class="line">zabbixæ˜¯åœ¨å®¢æˆ·ç«¯é…æœåŠ¡ç«¯çš„åœ°å€ï¼Œæ‰€ä»¥æ•°æ®èƒ½ä»å®¢æˆ·ç«¯æ¨é€ç»™æœåŠ¡ç«¯</span><br><span class="line"></span><br><span class="line">prometheusæ•°æ®è·å–çš„æ¥æºï¼š</span><br><span class="line">æœåŠ¡ç«¯é…å®¢æˆ·ç«¯çš„åœ°å€ï¼Œprometheus-serverå»å…¶ä»–å®¢æˆ·ç«¯æ‹‰è¿‡æ¥çš„æ•°æ®ï¼Œåªæœ‰å‘Šè­¦æ˜¯æ¨çš„</span><br><span class="line">è®¾ç½®è§¦å‘å™¨å‡ºç°å‘Šè­¦äº†ï¼Œå‡ºå‘å‘Šè­¦æ–¹å¼ï¼Œæ‰ä¼šæ¨é€æ•°æ®</span><br></pre></td></tr></table></figure><p>æ”¯æŒï¼š<br>1ã€MySQLã€Oracleã€Postgreã€esç­‰æ•°æ®åº“<br>2ã€zabbixã€prometheusç­‰ç›‘æ§ç³»ç»Ÿ</p><h3 id="3ã€Prometheusæ¶æ„">3ã€<strong>Prometheusæ¶æ„</strong></h3><p><img src="../image/study_img/image-20240911085025512.png" alt="image-20240911085025512"></p><p>TSDBï¼šæ—¶åºæ•°æ®åº“ï¼Œå’Œæ—¶é—´è½´æœ‰å…³çš„</p><p>influxDBï¼šæ—¶åºæ•°æ®åº“</p><h3 id="4ã€éƒ¨ç½²Prometheus">4ã€<strong>éƒ¨ç½²Prometheus</strong></h3><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th><th>åº”ç”¨</th></tr></thead><tbody><tr><td>docker01</td><td>10.0.0.101  /  172.16.1.101</td><td>è¢«ç›‘æ§ç«¯</td><td>cadvisorã€node_exporter</td></tr><tr><td>docker02</td><td>10.0.0.102  /  172.16.1.102</td><td>è¢«ç›‘æ§ç«¯</td><td>cadvisorã€node_exporter</td></tr><tr><td>docker03</td><td>10.0.0.103  /  172.16.1.103</td><td>è¢«ç›‘æ§ç«¯</td><td>cadvisorã€node_exporter</td></tr><tr><td>elk01</td><td>10.0.0.76  /  172.16.1.76</td><td>ç›‘æ§ç«¯ã€æœåŠ¡ç«¯</td><td>prometheusã€grafanaã€cadvisor</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## docker runå‘½ä»¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨node-exporter</span></span><br><span class="line">docker run -d -p 9100:9100 -v <span class="string">&quot;/:/host:ro,rslave&quot;</span> --name=node_exporter</span><br><span class="line">quay.io/prometheus/node-exporter --path.rootfs /host</span><br><span class="line"></span><br><span class="line">-v <span class="string">&quot;/:/hostï¼šç›¸å½“äºç›‘æ§å®¿ä¸»æœº</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># å¯åŠ¨cadvisor</span></span><br><span class="line"><span class="string">docker run --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --</span></span><br><span class="line"><span class="string">volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro -p 8080:8080 -d --name=cadvisor google/cadvisor:latest</span></span><br></pre></td></tr></table></figure><p>1ã€elkæœºå™¨ éƒ¨ç½²docker compose</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">1ã€å‡†å¤‡å·¥ä½œç›®å½•</span><br><span class="line">[root@elk1 ~]# <span class="built_in">mkdir</span> prometheus &amp;&amp; <span class="built_in">cd</span> prometheus/</span><br><span class="line"></span><br><span class="line">2ã€å‡†å¤‡promethuesé…ç½®æ–‡ä»¶</span><br><span class="line">[root@elk1 prometheus]# vim prometheus.yml</span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: cadvisor</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.101:8080</span><br><span class="line">    - 10.0.0.102:8080</span><br><span class="line">    - 10.0.0.103:8080</span><br><span class="line"></span><br><span class="line">- job_name: prometheus</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.76:9090</span><br><span class="line"></span><br><span class="line">- job_name: node_exporter</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.101:9100</span><br><span class="line">    - 10.0.0.102:9100</span><br><span class="line">    - 10.0.0.103:9100</span><br><span class="line"></span><br><span class="line">3ã€ç¼–å†™docker-compose</span><br><span class="line">[root@elk1 prometheus]# vim pro-docker-compose.yml </span><br><span class="line">version: <span class="string">&#x27;3.2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  prometheus:</span><br><span class="line">    image: prom/prometheus:latest</span><br><span class="line">    container_name: prometheus</span><br><span class="line">    ports:</span><br><span class="line">      - 9090:9090</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - --config.file=/etc/prometheus/prometheus.yml</span><br><span class="line">    volumes:</span><br><span class="line">      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">  grafana:</span><br><span class="line">    image: grafana/grafana:latest</span><br><span class="line">    container_name: grafana</span><br><span class="line">    ports:</span><br><span class="line">      - 3000:3000</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">  cadvisor:</span><br><span class="line">    image: google/cadvisor:latest</span><br><span class="line">    container_name: cadvisor</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">    volumes:</span><br><span class="line">      - /:/rootfs:ro</span><br><span class="line">      - /var/run:/var/run:rw</span><br><span class="line">      - /sys:/sys:ro</span><br><span class="line">      - /var/lib/docker:/var/lib/docker:ro</span><br><span class="line">    restart: always</span><br><span class="line">      </span><br><span class="line">  node-exporter:</span><br><span class="line">    image: prom/node-exporter:latest</span><br><span class="line">    container_name: node_exporter</span><br><span class="line">    ports:</span><br><span class="line">      - 9100:9100</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">[root@elk1 promethenus]# docker-compose -f pro-docker-compose.yml up -d</span><br></pre></td></tr></table></figure><p>2ã€docker01 02 03</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 node]# <span class="built_in">mkdir</span> node &amp;&amp; <span class="built_in">cd</span> node</span><br><span class="line">[root@docker01 node]# vim node-docker-compose.yml </span><br><span class="line">version: <span class="string">&#x27;3.2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  node-exporter:</span><br><span class="line">    image: prom/node-exporter:latest</span><br><span class="line">    container_name: node_exporter</span><br><span class="line">    ports:</span><br><span class="line">      - 9100:9100</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">  cadvisor:</span><br><span class="line">    image: google/cadvisor:latest</span><br><span class="line">    container_name: cadvisor</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">    volumes:</span><br><span class="line">      - /:/rootfs:ro</span><br><span class="line">      - /var/run:/var/run:rw</span><br><span class="line">      - /sys:/sys:ro</span><br><span class="line">      - /var/lib/docker:/var/lib/docker:ro</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">[root@docker02 node]# docker-compose -f node-docker-compose.yml up</span><br></pre></td></tr></table></figure><p>3ã€è®¿é—®ç½‘é¡µ 10.0.0.76:9090ï¼Œå¯ä»¥çœ‹åˆ°ç›‘æ§çš„å…¶ä»–å®¢æˆ·ç«¯</p><p><img src="../image/study_img/image-20240911093304356.png" alt="image-20240911093304356"></p><p><img src="../image/study_img/image-20240911163131170.png" alt="image-20240911163131170"></p><p>æ”¶é›†åˆ°çš„æ•°æ®æŒ‡æ ‡æ˜¯Key:valueçš„æ ¼å¼</p><p>æ•°æ®æŸ¥è¯¢æ“ä½œ</p><p><img src="../image/study_img/image-20240911163606439.png" alt="image-20240911163606439"></p><p><img src="../image/study_img/image-20240911163702757.png" alt="image-20240911163702757"></p><p>å¦‚æœåªæƒ³çœ‹101çš„æ•°æ®  ï¼š  å°±ç”¨{ }èŠ±æ‹¬å·é‡Œé¢å†™æƒ³è¦æŸ¥çœ‹çš„å­—æ®µ  èŠ±æ‹¬å·é‡Œé¢çš„å­—æ®µç›¸å½“äºè¿‡æ»¤</p><p><img src="../image/study_img/image-20240911170150515.png" alt="image-20240911170150515"></p><p>4ã€è®¿é—®cadvisoré¡µé¢ 10.0.0.101:8080</p><p><img src="../image/study_img/image-20240911165134739.png" alt="image-20240911165134739"></p><p><img src="../image/study_img/image-20240911165240850.png" alt="image-20240911165240850"></p><p><img src="../image/study_img/image-20240911165311636.png" alt="image-20240911165311636"></p><p>5ã€grafanaæ¨¡ç‰ˆå‡ºå›¾</p><p>ç™»å½•è‡ªå·±æ­å»ºçš„grafana ï¼š10.0.0.76:3000/</p><p><img src="../image/study_img/image-20240911160356809.png" alt="image-20240911160356809"></p><p>è¿›å…¥grafanaå®˜ç½‘ï¼š<a href="https://grafana.com/">https://grafana.com/</a>     è¿›å…¥å®˜ç½‘é¦–é¡µï¼Œæ¥åˆ°é¦–é¡µçš„é¡µé¢æœ€åº•ä¸‹</p><p><img src="../image/study_img/image-20240911170835247.png" alt="image-20240911170835247"></p><p><img src="../image/study_img/image-20240911171206521.png" alt="image-20240911171206521"></p><p>é€‰æ‹©ä¸€ä¸ªè‡ªå·±æƒ³è¦çš„æ¨¡ç‰ˆç‚¹å‡»è¿›å»ï¼Œè‡ªåŠ¨ä»–çš„IDï¼Œä¹‹åæ·»åŠ </p><p><img src="../image/study_img/image-20240911171354848.png" alt="image-20240911171354848"></p><p>â‘ ã€å›åˆ°è‡ªå·±æ­å»ºçš„grafana</p><p><img src="../image/study_img/image-20240911171850344.png" alt="image-20240911171850344"></p><p>â‘¡ã€æ‰¾åˆ°prometheusçš„å›¾æ ‡ï¼ŒåŒå‡»è¿›å»ï¼Œæ·»åŠ prometheusçš„URL,ç„¶åç‚¹å‡»æœ€ä¸‹é¢çš„save &amp; test  å¯çœ‹åˆ°Successfullyæ·»åŠ æˆåŠŸçš„ä¿¡æ¯</p><p><img src="../image/study_img/image-20240911172651580.png" alt="image-20240911172651580"></p><p>â‘¢æµ‹è¯•ï¼š  å†ç‚¹å‡»å·¦è¾¹çš„æ•°æ®æºæ  å¯çœ‹åˆ°æ·»åŠ æˆåŠŸï¼Œä¹‹åæ·»åŠ æ¨¡ç‰ˆ</p><p><img src="../image/study_img/image-20240911173117487.png" alt="image-20240911173117487"></p><p><img src="../image/study_img/image-20240911173228995.png" alt="image-20240911173228995"></p><p><img src="../image/study_img/image-20240911173445043.png" alt="image-20240911173445043"></p><p>æ¨¡ç‰ˆé‡Œé¢å¯ä»¥ç‚¹å‡»è¿›å»çœ‹çœ‹ï¼Œæœ‰çš„æœ‰æ•°æ®ï¼Œæœ‰çš„æ²¡æœ‰æ•°æ®</p><p><img src="../image/study_img/image-20240911173624110.png" alt="image-20240911173624110"></p><p>å…¶å®å¯ä»¥æŠŠåˆšåˆšæ·»åŠ çš„3ä¸ªæ¨¡ç‰ˆåˆ é™¤ï¼Œå› ä¸ºä¸æ˜¯æˆ‘éœ€è¦çš„ï¼Œæ¥ä¸‹æ¥ä¼šæ·»åŠ éœ€è¦çš„æ¨¡ç‰ˆ</p><p>â‘£ã€æ·»åŠ cAdcisorçš„æ¨¡ç‰ˆ</p><p><img src="../image/study_img/image-20240911174519155.png" alt="image-20240911174519155"></p><p>8919    11277  è¿™ä¸¤ä¸ªIDæ¯”è¾ƒå¸¸ç”¨</p><p><img src="../image/study_img/image-20240911174945815.png" alt="image-20240911174945815"></p><p><img src="../image/study_img/image-20240911175011030.png" alt="image-20240911175011030"></p><p><img src="../image/study_img/image-20240911175141393.png" alt="image-20240911175141393"></p><p>å¯ä»¥çœ‹åˆ°æ•°æ®ï¼Œä½†æ˜¯ç›®å‰é»˜è®¤æ˜¯çœ‹101çš„æ•°æ®ï¼Œé¡¹ç›®å’Œä¸»æœºéƒ½æ˜¯ç©ºçš„ï¼Œæƒ³çœ‹æŒ‡å®šä¸»æœºçš„æ•°æ®æ²¡æœ‰ï¼Œæ‰€ä»¥éœ€è¦æ”¹æ¨¡ç‰ˆ</p><p><img src="../image/study_img/image-20240911175238626.png" alt="image-20240911175238626"></p><p><em>6ã€ä¿®æ”¹æ¨¡ç‰ˆ</em></p><p>éœ€è¦ä½¿ç”¨prometheusæŸ¥è¯¢æ•°æ®çš„è¯­å¥ ï¼špromeQL</p><p><img src="../image/study_img/image-20240911181443564.png" alt="image-20240911181443564"></p><p><img src="../image/study_img/image-20240911181734944.png" alt="image-20240911181734944"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1ã€project</span><br><span class="line">label_values(container_last_seen, project)</span><br><span class="line"></span><br><span class="line">2ã€server</span><br><span class="line">label_values(container_last_seen&#123;project=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>&#125;, server)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€instance</span><br><span class="line">label_values(container_last_seen&#123;project=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>,server=~<span class="string">&quot;<span class="variable">$server</span>&quot;</span>&#125;, instance)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1ã€project</span><br><span class="line">label_values(container_last_seen, project)</span><br><span class="line">è·å–çš„æ˜¯container_last_seené‡Œé¢çš„projectï¼Œå»prometheusé‡Œé¢å»æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰è¿™ä¸ªå€¼</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240911192227950.png" alt="image-20240911192227950"></p><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªç‰ˆæœ¬çš„projecté¡¹ç›®åå«jobï¼Œæ‰€ä»¥projectåº”è¯¥æ”¹æˆjob</p><p><img src="../image/study_img/image-20240911194340683.png" alt="image-20240911194340683"></p><p>æŠŠprojectä¿®æ”¹æˆjobæˆåŠŸ</p><p><img src="../image/study_img/image-20240911194429236.png" alt="image-20240911194429236"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2ã€server</span><br><span class="line">label_values(container_last_seen&#123;project=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>&#125;, server)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢åªè¦instanceå’Œjob,æ²¡æœ‰server,æ‰€ä»¥æŠŠserveråˆ é™¤</p><p><img src="../image/study_img/image-20240911194700416.png" alt="image-20240911194700416"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">3ã€instance</span><br><span class="line">label_values(container_last_seen&#123;project=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>,server=~<span class="string">&quot;<span class="variable">$server</span>&quot;</span>&#125;, instance)</span><br><span class="line">serveræ²¡æœ‰ï¼Œä¸è¦ï¼Œå¯ä»¥åˆ é™¤</span><br><span class="line"></span><br><span class="line">label_values(container_last_seen&#123;job=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>&#125;, instance)</span><br><span class="line"></span><br><span class="line"><span class="variable">$project</span>è¿™ä¸ªè¡¨ç¤ºè·å–projecté‡Œé¢çš„å˜é‡</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240911200218534.png" alt="image-20240911200218534"></p><p><img src="../image/study_img/image-20240911195320041.png" alt="image-20240911195320041"></p><p>ä¿®æ”¹å®Œæˆï¼Œä¿å­˜</p><p><img src="../image/study_img/image-20240911195411815.png" alt="image-20240911195411815"></p><p><img src="../image/study_img/image-20240911200333043.png" alt="image-20240911200333043"></p><p>æŸ¥çœ‹æ²¡æœ‰æ•°æ®ï¼Œæ·»åŠ æ•°æ®</p><p><img src="../image/study_img/image-20240911200507280.png" alt="image-20240911200507280"></p><p><img src="../image/study_img/image-20240911200625330.png" alt="image-20240911200625330"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">count(container_last_seen&#123;project=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>,instance=~<span class="string">&quot;<span class="variable">$instance</span>&quot;</span>,image!=<span class="string">&quot;&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">æŠŠå˜é‡å’Œjobæ¢ä¸€ä¸‹</span><br><span class="line">count(container_last_seen&#123;job=~<span class="string">&quot;cadvisor&quot;</span>,instance=~<span class="string">&quot;10.0.0.101:8080&quot;</span>,image!=<span class="string">&quot;&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><p>å¯ä»¥è·å–åˆ°æ•°æ®</p><p><img src="../image/study_img/image-20240911200945018.png" alt="image-20240911200945018"></p><p><img src="../image/study_img/image-20240911201650404.png" alt="image-20240911201650404"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å› ä¸ºprometheusé‡Œé¢æŸ¥å‡ºæ¥çš„æ²¡æœ‰projectæ ‡ç­¾ï¼Œåªæœ‰jobæ ‡ç­¾</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">container_last_seen&#123;<span class="built_in">id</span>=<span class="string">&quot;/&quot;</span>, instance=<span class="string">&quot;10.0.0.101:8080&quot;</span>, job=<span class="string">&quot;cadvisor&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>ç›®å‰åªæ”¹äº†ä¸€ä¸ªæ•°æ®ï¼Œä½†æ˜¯ä¸å¯èƒ½ä¸€ä¸ªä¸€ä¸ªå»ä¿®æ”¹ï¼Œæ‰€ä»¥éœ€è¦æ‰¹é‡ä¿®æ”¹</p><p><img src="../image/study_img/image-20240911201813116.png" alt="image-20240911201813116"></p><p>è¿™ä¸ªjsonæ–‡ä»¶å°±æ˜¯æ¨¡ç‰ˆï¼Œä½†å¾€ä¸‹çœ‹ï¼Œè¿™ä¸ªjsonæ–‡ä»¶é‡Œé¢è¿˜æ˜¯projectï¼Œå¯ä»¥å¤åˆ¶å‡ºæ¥ï¼Œæ‰¹é‡æ›¿æ¢æˆjob</p><p><img src="../image/study_img/image-20240911201937730.png" alt="image-20240911201937730"></p><p><img src="../image/study_img/image-20240911202129508.png" alt="image-20240911202129508"></p><p>æŠŠæ›¿æ¢åçš„jsonæ–‡ä»¶ç²˜è´´</p><p><img src="../image/study_img/image-20240911202309412.png" alt="image-20240911202309412"></p><p>ä¿å­˜ä¹‹åï¼Œé‡æ–°è¿›å…¥ï¼ŒæŸ¥çœ‹æ•°æ®</p><p><img src="../image/study_img/image-20240911202434264.png" alt="image-20240911202434264"></p><p><img src="../image/study_img/image-20240911202449993.png" alt="image-20240911202449993"></p><p>â‘¤ã€æ·»åŠ node_exporterçš„æ¨¡ç‰ˆ</p><p>åœ¨å®˜ç½‘æœç´¢æ¨¡ç‰ˆID</p><p><img src="../image/study_img/image-20240911215221833.png" alt="image-20240911215221833"></p><p><img src="../image/study_img/image-20240911215237958.png" alt="image-20240911215237958"></p><p>å›åˆ°è‡ªå·±å®‰è£…çš„grafanaï¼Œæ·»åŠ æ¨¡ç‰ˆ</p><p><img src="../image/study_img/image-20240911215341094.png" alt="image-20240911215341094"></p><p><img src="../image/study_img/image-20240911215432195.png" alt="image-20240911215432195"></p><p><img src="../image/study_img/image-20240911215458213.png" alt="image-20240911215458213"></p><p>æ•°æ®ç”Ÿæˆ</p><p><img src="../image/study_img/image-20240911215516206.png" alt="image-20240911215516206"></p><p><img src="../image/study_img/image-20240911215800737.png" alt="image-20240911215800737"></p><p><img src="../image/study_img/image-20240911215816266.png" alt="image-20240911215816266"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">node_filesystem_size_bytes&#123;instance=<span class="string">&quot;<span class="variable">$node</span>&quot;</span>,job=<span class="string">&quot;<span class="variable">$job</span>&quot;</span>,mountpoint=<span class="string">&quot;/&quot;</span>,fstype!=<span class="string">&quot;rootfs&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">æƒ³è¦å±•ç¤ºæ•°æ®å°±æŠŠ,fstype!=<span class="string">&quot;rootfs&quot;</span>åˆ æ‰</span><br><span class="line">node_filesystem_size_bytes&#123;instance=<span class="string">&quot;<span class="variable">$node</span>&quot;</span>,job=<span class="string">&quot;<span class="variable">$job</span>&quot;</span>,mountpoint=<span class="string">&quot;/&quot;</span>,fstype!=<span class="string">&quot;rootfs&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240911215845909.png" alt="image-20240911215845909"></p><p>æƒ³è¦å±•ç¤ºæ•°æ®å°±æŠŠ,fstype!=&quot;rootfs&quot;åˆ æ‰</p><p><img src="../image/study_img/image-20240911220402516.png" alt="image-20240911220402516"></p><p><img src="../image/study_img/image-20240911220531172.png" alt="image-20240911220531172"></p><p>å†æŸ¥çœ‹æ²¡æ•°æ®çš„æ¡†ï¼ŒæŸ¥çœ‹æ²¡æ•°æ®çš„åŸå› ï¼Œå¹¶ä¿®æ”¹</p><p><img src="../image/study_img/image-20240911220656392.png" alt="image-20240911220656392"></p><p>æ— æ³•æŸ¥è¯¢æ•°æ®ï¼ŒCPUæ²¡æœ‰ç­‰å¾…æ—¶é—´ï¼ŒæŸ¥è¯¢ä¸å‡ºæ•°æ®ï¼Œæ‰€ä»¥æ²¡æœ‰æ•°æ®æ²¡å…³ç³»</p><p><img src="../image/study_img/image-20240911221251157.png" alt="image-20240911221251157"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irate(node_pressure_cpu_waiting_seconds_total&#123;instance=<span class="string">&quot;<span class="variable">$node</span>&quot;</span>,job=<span class="string">&quot;<span class="variable">$job</span>&quot;</span>&#125;[<span class="variable">$__rate_interval</span>])</span><br></pre></td></tr></table></figure><p>å†ç»§ç»­æ’æŸ¥ä¸‹ä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„åŸå› ï¼Œå¹¶ä¿®æ”¹</p><p><img src="../image/study_img/image-20240911221454957.png" alt="image-20240911221454957"></p><p><img src="../image/study_img/image-20240911221632432.png" alt="image-20240911221632432"></p><p><img src="../image/study_img/image-20240911222204013.png" alt="image-20240911222204013"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æ²¡æœ‰æ•°æ®å°±å»prometheusé‡Œé¢æŸ¥ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ç›¸å…³å­—æ®µ</span><br><span class="line"></span><br><span class="line">æ¯”è¾ƒå¥½ç”¨çš„æ¨¡ç‰ˆæœ‰</span><br><span class="line">11277</span><br><span class="line">8919</span><br></pre></td></tr></table></figure><p>8919çš„æ¨¡ç‰ˆå›¾</p><p><img src="../image/study_img/image-20240911224138667.png" alt="image-20240911224138667"></p>]]></content>
    
    
    <summary type="html">ä¸ä»…ä¸šåŠ¡æœåŠ¡å™¨å¯ä»¥ç›‘æ§ï¼Œå®¹å™¨ä¹Ÿå¯ä»¥ç›‘æ§ï¼Œæœ¬æ–‡ä½¿ç”¨Promethueså¯¹å®¹å™¨è¿›è¡Œç›‘æ§ï¼Œå·²ç»ä½¿ç”¨Grafanaå‡ºå¥½çœ‹çš„</summary>
    
    
    
    <category term="docker" scheme="https://www.fomal.cc/categories/docker/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ¡ä¹ã€dockerçš„èµ„æºé™åˆ¶</title>
    <link href="https://www.fomal.cc/posts/79ab352e.html"/>
    <id>https://www.fomal.cc/posts/79ab352e.html</id>
    <published>2024-09-22T06:03:04.000Z</published>
    <updated>2024-10-02T07:53:38.824Z</updated>
    
    <content type="html"><![CDATA[<h2 id="dockerçš„èµ„æºé™åˆ¶">dockerçš„èµ„æºé™åˆ¶</h2><h3 id="1ã€dockerèµ„æºé™åˆ¶ä»‹ç»"><strong>1ã€dockerèµ„æºé™åˆ¶ä»‹ç»</strong></h3><p>å®˜ç½‘ï¼š <a href="https://docs.docker.com/engine/containers/resource_constraints/">https://docs.docker.com/engine/containers/resource_constraints/</a></p><p>å¸¦æœ‰å†…å­˜ã€CPU å’Œ GPU çš„è¿è¡Œæ—¶é€‰é¡¹<br>é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨æ²¡æœ‰èµ„æºé™åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ä¸»æœºå†…æ ¸è°ƒåº¦ç¨‹åºå…è®¸çš„å°½å¯èƒ½å¤šçš„ç»™å®šèµ„æºã€‚Docker æä¾›äº†æ§åˆ¶å®¹å™¨å¯ä»¥ä½¿ç”¨å¤šå°‘å†…å­˜æˆ– CPU çš„æ–¹æ³•ï¼Œè®¾ç½®docker runå‘½ä»¤çš„è¿è¡Œæ—¶é…ç½®æ ‡å¿—ã€‚æœ¬èŠ‚æä¾›æœ‰å…³ä½•æ—¶åº”è¯¥è®¾ç½®æ­¤ç±»é™åˆ¶ä»¥åŠè®¾ç½®è¿™äº›é™åˆ¶çš„å¯èƒ½å½±å“çš„è¯¦ç»†ä¿¡æ¯ã€‚</p><p>å…¶ä¸­è®¸å¤šåŠŸèƒ½éœ€è¦æ‚¨çš„å†…æ ¸æ”¯æŒ Linux åŠŸèƒ½ã€‚è¦æ£€æŸ¥æ”¯æŒï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¥ docker infoå‘½ä»¤ã€‚å¦‚æœæ‚¨çš„å†…æ ¸ä¸­ç¦ç”¨äº†æŸä¸ªåŠŸèƒ½ï¼Œæ‚¨å¯èƒ½ä¼šåœ¨è¾“å‡ºçš„æœ«å°¾çœ‹åˆ°å¦‚ä¸‹è­¦å‘Šï¼š<br>WARNING: no swap limit support</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">é˜¿é‡Œäº‘ä¸Šé¢æ²¡æœ‰swapç©ºé—´ï¼Œå› ä¸ºswapæ˜¯è™šæ‹Ÿçš„ï¼Œé˜¿é‡Œäº‘ä¹Ÿæ˜¯è™šæ‹Ÿçš„</span><br><span class="line">docker k8séƒ½ä¸è¦æswap,æœ¬æ¥å°±æ˜¯è™šæ‹ŸåŒ–çš„äº§å“ï¼ŒæŠŠè™šæ‹Ÿç£ç›˜å†å˜æˆè™šæ‹Ÿå†…å­˜ï¼Œæ€§èƒ½æ›´ä½</span><br><span class="line"></span><br><span class="line">å½“ç£ç›˜è¢«æ²¾æ»¡äº†ï¼Œä¼šå†…å­˜æº¢å‡ºï¼Œä¼šå¯åŠ¨OOM <span class="built_in">kill</span>,ä¼šæ€è¿›ç¨‹</span><br></pre></td></tr></table></figure><h4 id="Dokcerå†…å­˜é™åˆ¶"><strong>Dokcerå†…å­˜é™åˆ¶</strong></h4><p>Dockeré™åˆ¶å†…å­˜çš„ç›¸å…³å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–å‹æµ‹å·¥å…·çš„é•œåƒ</span><br><span class="line">[root@docker03 ~]# docker pull akarshes/docker-stress-ng:latest</span><br><span class="line"></span><br><span class="line">2ã€# å†…å­˜é™åˆ¶æµ‹è¯•</span><br><span class="line"><span class="comment"># æ²¡æœ‰å†…å­˜é™åˆ¶</span></span><br><span class="line">[root@docker02 ~]# docker run --name mem_test -it --<span class="built_in">rm</span> akarshes/docker-stress-ng --vm 8</span><br><span class="line">[root@docker03 ~]# docker stats</span><br><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O         BLOCK I/O         PIDS</span><br><span class="line">9450d02cb9a1   mem_test          234.65%   2.006GiB / 2.885GiB   69.55%    586B / 0B       5.55MB / 0B       17</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯¹å®¹å™¨åšèµ„æºé™åˆ¶</span></span><br><span class="line">[root@docker03 ~]# docker run --name mem_test -it --<span class="built_in">rm</span>  -m 200m akarshes/docker-stress-ng --vm 8</span><br><span class="line">[root@docker03 ~]# docker stats</span><br><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O          BLOCK I/O         PIDS</span><br><span class="line">7870345de325   mem_test          136.94%   193.2MiB / 200MiB     96.59%    656B / 0B        59.7MB / 7.41GB   15</span><br><span class="line"></span><br><span class="line">-mï¼šå…è®¸å®¹å™¨ä½¿ç”¨çš„æœ€å¤§å†…å­˜ï¼Œå•ä½ï¼škã€mã€g</span><br><span class="line">--oom-kill-disable</span><br><span class="line"><span class="comment">#æŸ¥çœ‹å‘½ä»¤çš„å¸®åŠ©</span></span><br><span class="line">docker run --name mem_test -it --<span class="built_in">rm</span> akarshes/docker-stress-ng --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Example: stress-ng --cpu 8 --io 4 --vm 2 --vm-bytes 128M --fork 4 --<span class="built_in">timeout</span> 10s</span><br></pre></td></tr></table></figure><h4 id="Dokceré™åˆ¶CPU"><strong>Dokceré™åˆ¶CPU</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ²¡åšCPUé™åˆ¶</span></span><br><span class="line">[root@docker02 ~]# docker run --name mem_test -it --<span class="built_in">rm</span> akarshes/docker-stress-ng --cpu 4</span><br><span class="line">[root@docker03 ~]# docker stats</span><br><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O         BLOCK I/O         PIDS</span><br><span class="line">3c74f649be1e   mem_test          214.19%   25.6MiB / 2.885GiB    0.87%     656B / 0B       0B / 0B           9</span><br><span class="line"><span class="comment">#cpuæ•°æ®ä¸€ç›´å¢åŠ ï¼Œåœ¨è¶…è½½</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é™åˆ¶CPU</span></span><br><span class="line">[root@docker02 ~]# docker run --name mem_test -it --<span class="built_in">rm</span> --cpus 0.5 akarshes/docker-stress-ng -cpu 8</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬èµ„æºé™åˆ¶ä¸æ˜¯ç›®çš„ï¼Œç›®çš„æ˜¯æˆ‘ä»¬è¦éšæ—¶ç›‘æ§åˆ°æˆ‘ä»¬çš„èµ„æºï¼Œèƒ½çœ‹åˆ°å®¹å™¨å¯¹å®¿ä¸»æœºèµ„æºçš„ä½¿ç”¨ï¼Œæ‰èƒ½æ›´å¥½çš„åšé™åˆ¶ï¼Œä¸è¦ç›²ç›®é™åˆ¶ï¼Œä¸çŸ¥é“èµ„æºä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œå°±å¯¹å®¹å™¨èµ„æºé™åˆ¶ï¼Œæ˜¯å¾ˆå±é™©çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å¯¹å®¹å™¨è¿›è¡Œç›‘æ§ï¼Œå¦‚æœä¸ç›‘æ§ã€‚å®¹å™¨è¶…è½½äº†å°±ä¼šå‡ºç°OMMå†…å­˜æº¢å‡ºï¼Œæ€è¿›ç¨‹çš„æƒ…å†µ</p>]]></content>
    
    
    <summary type="html">dockerèµ„æºé™åˆ¶ä»‹ç»</summary>
    
    
    
    <category term="docker" scheme="https://www.fomal.cc/categories/docker/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ¡å…«ã€dockerå®¹å™¨è·¨ä¸»æœºé€šä¿¡</title>
    <link href="https://www.fomal.cc/posts/f36f1204.html"/>
    <id>https://www.fomal.cc/posts/f36f1204.html</id>
    <published>2024-09-22T05:57:59.000Z</published>
    <updated>2024-10-02T07:53:12.591Z</updated>
    
    <content type="html"><![CDATA[<h2 id="dockerå®¹å™¨è·¨ä¸»æœºé€šä¿¡">dockerå®¹å™¨è·¨ä¸»æœºé€šä¿¡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">èµ·é‚£ä¹ˆå¤šå°dockerï¼Œæƒ³åšé›†ç¾¤ï¼Œå°±è¦è®©å®¹å™¨ä¹‹é—´äº’ç›¸é€šä¿¡ï¼Œç„¶ååšæˆä¸€ä¸ªæ¶æ„</span><br><span class="line"></span><br><span class="line"><span class="comment">#docker-composå¤šæœºç¼–æ’ï¼Œéœ€è¦é…åˆdocker-swarm</span></span><br><span class="line"></span><br><span class="line">ç°åœ¨èµ·ä¸€ä¸ªå®¹å™¨è‡ªå·±å†³å®šèµ·åœ¨å“ªä¸€å°ä¸Šï¼Œæ²¡æœ‰å¯¹è¿™å°çš„èµ„æºè¿›è¡Œè®¡ç®—</span><br><span class="line">å¤šæœºç¼–æ’å·¥å…·å¯ä»¥è®¡ç®—å“ªå°æœºå™¨é€‚åˆæŠŠæœåŠ¡èµ·åœ¨å“ªå°æœºå™¨</span><br></pre></td></tr></table></figure><p><strong>Dockerè·¨ä¸»æœºç½‘ç»œç±»å‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1ã€é™æ€è·¯ç”±</span><br><span class="line">2ã€flannel (k8sé‡Œé¢ç”¨çš„æ¯”è¾ƒå¤š)</span><br><span class="line">3ã€overlay</span><br><span class="line">4ã€macvlan</span><br><span class="line">5ã€calico</span><br></pre></td></tr></table></figure><h3 id="1ã€é™æ€è·¯ç”±æ¨¡å¼"><strong>1ã€é™æ€è·¯ç”±æ¨¡å¼</strong></h3><p><img src="C:%5CUsers%5CMac%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240910090901456.png" alt="image-20240910090901456"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">é™æ€è·¯ç”±åšèµ·æ¥ç®€å•ï¼Œä½†æ˜¯é˜¿é‡Œäº‘ä¸è®©æ·»åŠ è·¯ç”±</span><br><span class="line"></span><br><span class="line">1. æ·»åŠ ä¸€æ¡åˆ°è¾¾ç½‘ç»œ192.168.1.0/24çš„è·¯ç”±ï¼Œç½‘å…³ä¸º192.168.0.1ï¼Œè·ç¦»å€¼ä¸º10ï¼š</span><br><span class="line">route add -net 192.168.1.0 netmask 255.255.255.0 gw 192.168.0.1 metric 10</span><br><span class="line"></span><br><span class="line">2. æ·»åŠ ä¸€æ¡åˆ°è¾¾ä¸»æœº192.168.1.100çš„è·¯ç”±ï¼Œç½‘å…³ä¸º192.168.0.1ï¼š</span><br><span class="line">route add -host 192.168.1.100 gw 192.168.0.1</span><br><span class="line"></span><br><span class="line">3. æ·»åŠ ä¸€æ¡åˆ°è¾¾ç½‘ç»œ192.168.0.0/16çš„è·¯ç”±ï¼Œç½‘å…³ä¸º192.168.1.1ï¼Œè·ç¦»å€¼ä¸º20ï¼Œç»è¿‡eth0æ¥å£ï¼š</span><br><span class="line">route add -net 192.168.0.0 netmask 255.255.0.0 gw 192.168.1.1 metric 20 dev eth0</span><br></pre></td></tr></table></figure><p>2ã€flannel (k8sé‡Œé¢ç”¨çš„æ¯”è¾ƒå¤š)</p><p><img src="C:%5CUsers%5CMac%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240910091610337.png" alt="image-20240910091610337"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flannelå›¾å½¢åŒ–ç•Œé¢éœ€è¦é…ç½®è¯ä¹¦</span><br></pre></td></tr></table></figure><h3 id="2ã€flanneç½‘ç»œæ¨¡å¼çš„éƒ¨ç½²"><strong>2ã€flanneç½‘ç»œæ¨¡å¼çš„éƒ¨ç½²</strong></h3><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th><th>åº”ç”¨</th></tr></thead><tbody><tr><td>docker01</td><td>10.0.0.101  /  172.16.1.101</td><td>äº’ç›¸é€šä¿¡çš„å®¹å™¨</td><td>flanne</td></tr><tr><td>docker02</td><td>10.0.0.102  /  172.16.1.102</td><td>äº’ç›¸é€šä¿¡çš„å®¹å™¨</td><td>flanne</td></tr><tr><td>docker03</td><td>10.0.0.103  /  172.16.1.103</td><td>äº’ç›¸é€šä¿¡çš„å®¹å™¨</td><td>flanne</td></tr><tr><td>elk01</td><td>10.0.0.76  /  172.16.1.76</td><td>å‚¨å­˜æ•°æ®çš„ä¸­ä»‹</td><td>ETCD</td></tr></tbody></table><p>1ã€éƒ¨ç½²ETCD</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1ã€å®‰è£…etcd</span><br><span class="line">[root@elk1 ~]# yum -y install etcd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ä¿®æ”¹etcdé…ç½®æ–‡ä»¶</span><br><span class="line">[root@elk1 ~]# vim /etc/etcd/etcd.conf </span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=default</span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://172.16.1.76:2379,http://127.0.0.1:2379&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://172.16.1.76:2379&quot;</span></span><br><span class="line"></span><br><span class="line">3ã€å¯åŠ¨etcdå¹¶åŠ å…¥å¼€æœºè‡ªå¯</span><br><span class="line">[root@elk1 ~]# systemctl start etcd</span><br><span class="line">[root@elk1 ~]# systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">æŸ¥çœ‹ç«¯å£ 2380æ˜¯å›¾å½¢åŒ–ç•Œé¢è¿æ¥çš„ç«¯å£</span><br></pre></td></tr></table></figure><p>ETCDçš„åŸºç¡€æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-c  è°ƒæ¥å£</span><br><span class="line"></span><br><span class="line">1ã€æ£€æŸ¥é›†ç¾¤çš„å¥åº·çŠ¶æ€</span><br><span class="line">[root@elk1 ~]# etcdctl -C http://127.0.0.1:2379 cluster-health</span><br><span class="line"></span><br><span class="line">2ã€å†™å…¥æ•°æ®</span><br><span class="line">[root@elk1 ~]# etcdctl -C http://127.0.0.1:2379 <span class="built_in">set</span> /testdir/testkey <span class="string">&quot;hello world&quot;</span></span><br><span class="line"></span><br><span class="line">3ã€æŸ¥çœ‹æ•°æ®</span><br><span class="line">[root@elk1 ~]# etcdctl -C http://127.0.0.1:2379 get /testdir/testkey </span><br></pre></td></tr></table></figure><p>2ã€3å°æœºå™¨å®‰è£…é…ç½®flannel</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1ã€3å°æœºå™¨å®‰è£…flannel</span><br><span class="line">[root@docker01 ~]# yum -y install flannel</span><br><span class="line">[root@docker02 ~]# yum -y install flannel</span><br><span class="line">[root@docker02 ~]# yum -y install flannel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€3å°æœºå™¨ä¿®æ”¹flannleé…ç½®æ–‡ä»¶</span><br><span class="line">[root@docker02 ~]# vim /etc/sysconfig/flanneld</span><br><span class="line"><span class="comment">#å†™etcdç«¯çš„ip</span></span><br><span class="line">FLANNEL_ETCD_ENDPOINTS=<span class="string">&quot;http://172.16.1.76:2379&quot;</span></span><br><span class="line"><span class="comment">#è¿™æ®µæ˜¯é»˜è®¤çš„ï¼Œä¸éœ€è¦ä¿®æ”¹ï¼Œä¸€ä¼šè¦åœ¨æ”¹ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶</span></span><br><span class="line">FLANNEL_ETCD_PREFIX=<span class="string">&quot;/atomic.io/network&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€åˆ›å»ºflannelæ•°æ®å†etcdä¸­</span><br><span class="line">[root@elk1 ~]# etcdctl mk /atomic.io/network/config <span class="string">&#x27;&#123;&quot;Network&quot;:&quot;192.168.0.0/16&quot;&#125;&#x27;</span></span><br><span class="line">&#123;<span class="string">&quot;Network&quot;</span>:<span class="string">&quot;192.168.0.0/16&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">[root@elk1 ~]# etcdctl -C http://127.0.0.1:2379 <span class="built_in">set</span> /atomic.io/network/config <span class="string">&#x27;&#123;&quot;Network&quot;:&quot;192.168.0.0/16&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">4ã€3å°æœºå™¨å¯åŠ¨flannel</span><br><span class="line">[root@docker01 ~]# systemctl start flanneld &amp;&amp; systemctl <span class="built_in">enable</span> flanneld</span><br><span class="line"></span><br><span class="line">5ã€3å°æœºå™¨æŸ¥çœ‹flannel0ç½‘å¡ä¿¡æ¯</span><br><span class="line">[root@docker01 ~]# ifconfig</span><br><span class="line">flannel0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1472</span><br><span class="line">        inet 192.168.54.0  netmask 255.255.0.0  destination 192.168.54.0</span><br></pre></td></tr></table></figure><p>3ã€å…³è”flannelå’Œdocker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">1ã€3å°æœºå™¨æŸ¥çœ‹æ”¹æ–‡ä»¶ï¼Œä¸€ä¼šä¼šåœ¨å¯åŠ¨è„šæœ¬é‡Œé¢åŠ ä¿¡æ¯</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> /run/flannel/docker </span><br><span class="line">DOCKER_OPT_BIP=<span class="string">&quot;--bip=192.168.22.1/24&quot;</span></span><br><span class="line">DOCKER_OPT_IPMASQ=<span class="string">&quot;--ip-masq=true&quot;</span></span><br><span class="line">DOCKER_OPT_MTU=<span class="string">&quot;--mtu=1472&quot;</span></span><br><span class="line">DOCKER_NETWORK_OPTIONS=<span class="string">&quot; --bip=192.168.22.1/24 --ip-masq=true --mtu=1472&quot;</span></span><br><span class="line"></span><br><span class="line">2ã€3å°æœºå™¨ä¿®æ”¹dockerå¯åŠ¨è„šæœ¬</span><br><span class="line">[root@docker02 ~]# vim /usr/lib/systemd/system/docker.service</span><br><span class="line">[Service]</span><br><span class="line"><span class="comment">#æ·»åŠ è¿™è¡Œè¯»å–ç¯å¢ƒå˜é‡æ–‡ä»¶</span></span><br><span class="line">EnviromentFile=/run/flannel/docker </span><br><span class="line"><span class="comment">#åœ¨æœ€åé¢æ·»åŠ å˜é‡</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line"></span><br><span class="line">[root@docker03 ~]# systemctl daemon-reload &amp;&amp; systemctl restart flanneld</span><br><span class="line"></span><br><span class="line">3ã€3å°æœºå™¨å¼€å¯å†…æ ¸è½¬å‘</span><br><span class="line">[root@docker03 ~]# <span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.ip_forward=1&#x27;</span>  &gt;&gt; /etc/sysctl.conf </span><br><span class="line"></span><br><span class="line">4ã€3å°æœºå™¨å¼€åšå¦‚ä¸‹æ“ä½œ</span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line">[root@docker01 ~]# systemctl start firewalld</span><br><span class="line">[root@docker01 ~]# systemctl stop firewalld</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# systemctl start firewalld &amp;&amp; systemctl stop firewalld</span><br><span class="line">[root@docker01 ~]#  systemctl restart network</span><br><span class="line">[root@docker01 ~]#  systemctl restart flanneld </span><br><span class="line">[root@docker01 ~]#  systemctl restart docker</span><br><span class="line"></span><br><span class="line">------------æ³¨æ„---------------------</span><br><span class="line">1ã€# æ‰§è¡Œdocker info å‡ºç°è­¦å‘Š</span><br><span class="line"><span class="comment">#éœ€è¦é…ç½®å†…æ ¸è½¬å‘æ”¯æŒiptables</span></span><br><span class="line">WARNING: bridge-nf-call-iptables is disabled</span><br><span class="line">WARNING: bridge-nf-call-ip6tables is disabled</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/docker.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">[root@docker01 ~]#  systemctl restart network</span><br><span class="line">[root@docker01 ~]#  systemctl restart flanneld </span><br><span class="line">[root@docker01 ~]#  systemctl restart docker</span><br></pre></td></tr></table></figure><p>3ã€æµ‹è¯•æ˜¯å¦å¯ä»¥é€šä¿¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1ã€è¿›å»æŸ¥çœ‹3å°æœºå™¨çš„ip,ç„¶åå†äº’ç›¸ping  IPï¼Œå¦‚æœå¯ä»¥pingé€šåˆ™ok</span><br><span class="line">[root@docker01 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:C0:A8:36:02  </span><br><span class="line">          inet addr:192.168.54.2  Bcast:192.168.54.255  Mask:255.255.255.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@docker02 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:C0:A8:16:05  </span><br><span class="line">          inet addr:192.168.22.5  Bcast:192.168.22.255  Mask:255.255.255.0</span><br><span class="line">          </span><br><span class="line">[root@docker03 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:C0:A8:39:05  </span><br><span class="line">          inet addr:192.168.57.5  Bcast:192.168.57.255  Mask:255.255.255.0</span><br></pre></td></tr></table></figure><h3 id="3ã€overlayè·¨ä¸»æœºé€šä¿¡"><strong>3ã€overlayè·¨ä¸»æœºé€šä¿¡</strong></h3><p><img src="C:%5CUsers%5CMac%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240910144826332.png" alt="image-20240910144826332"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">http://www.cnblogs.com/CloudMan6/p/7270551.html</span><br><span class="line"></span><br><span class="line">docker03ä¸Šï¼š consulå­˜å‚¨ipåœ°å€çš„åˆ†é…</span><br><span class="line">docker run -d -p 8500:8500 -h consul --name consul progrium/consul -server -bootstrap</span><br><span class="line"></span><br><span class="line">è®¾ç½®å®¹å™¨çš„ä¸»æœºå</span><br><span class="line">consulï¼škvç±»å‹çš„å­˜å‚¨æ•°æ®åº“ï¼ˆkey:valueï¼‰</span><br><span class="line">docker01ã€02ä¸Šï¼š</span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;cluster-store&quot;</span>: <span class="string">&quot;consul://10.0.0.13:8500&quot;</span>,</span><br><span class="line"><span class="string">&quot;cluster-advertise&quot;</span>: <span class="string">&quot;10.0.0.11:2376&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vim /usr/lib/systemd/system/docker.service</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line">2ï¼‰åˆ›å»ºoverlayç½‘ç»œ</span><br><span class="line">docker network create -d overlay --subnet 172.16.2.0/24 --gateway 172.16.2.254 ol1</span><br><span class="line"></span><br><span class="line">3ï¼‰å¯åŠ¨å®¹å™¨æµ‹è¯•</span><br><span class="line">docker run -it --network ol1 --name oldboy01 busybox /bin/sh</span><br><span class="line">æ¯ä¸ªå®¹å™¨æœ‰ä¸¤å—ç½‘å¡,eth0å®ç°å®¹å™¨é—´çš„é€šè®¯,eth1å®ç°å®¹å™¨è®¿é—®å¤–ç½‘</span><br></pre></td></tr></table></figure><h3 id="4ã€macvlan"><strong>4ã€macvlan</strong></h3><p>é»˜è®¤ä¸€ä¸ªç‰©ç†ç½‘å¡ï¼Œåªæœ‰ä¸€ä¸ªç‰©ç†macåœ°å€ï¼Œè™šæ‹Ÿå¤šä¸ªmacåœ°å€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ›å»ºmacvlanç½‘ç»œ</span></span><br><span class="line">docker network create --driver macvlan --subnet 10.0.0.0/24 --gateway 10.0.0.254 -o parent=eth0 macvlan_1</span><br><span class="line"></span><br><span class="line"><span class="comment">## è®¾ç½®eth0çš„ç½‘å¡ä¸ºæ··æ‚æ¨¡å¼</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 promisc on</span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ›å»ºä½¿ç”¨macvlanç½‘ç»œçš„å®¹å™¨</span></span><br><span class="line">docker run -it --network macvlan_1 --ip=10.0.0.200 busybox</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Dockerè·¨ä¸»æœºç½‘ç»œæ¨¡å¼çš„ä»‹ç»</summary>
    
    
    
    <category term="docker" scheme="https://www.fomal.cc/categories/docker/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ¡ä¸ƒã€Dockerå•æœºç¼–æ’å·¥å…·</title>
    <link href="https://www.fomal.cc/posts/c7b1e5e1.html"/>
    <id>https://www.fomal.cc/posts/c7b1e5e1.html</id>
    <published>2024-09-22T05:54:39.000Z</published>
    <updated>2024-10-02T07:54:30.234Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Dockerå•æœºç¼–æ’å·¥å…·">Dockerå•æœºç¼–æ’å·¥å…·</h2><h3 id="1ã€docker-composeçš„ä»‹ç»">1ã€<strong>docker-composeçš„ä»‹ç»</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Composeæ˜¯ç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨Dockeråº”ç”¨å·¥å…·é€šè¿‡Compose å¯ä»¥ä½¿ç”¨YMLæ–‡ä»¶æ¥é…ç½®åº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„æ‰€æœ‰æœåŠ¡ï¼Œç”¨æ¥ç®¡ç†å®¹å™¨çš„èµ·åœï¼ŒæŸ¥çœ‹å®¹å™¨çš„æ—¥å¿—ï¼Œæ¯”è¾ƒæ–¹ä¾¿</span><br><span class="line">ä¸åƒdocker runå‘½ä»¤æ¯”è¾ƒé•¿ï¼Œè€Œä¸”æ˜¯ä¸´æ—¶æ‰§è¡Œçš„</span><br><span class="line"></span><br><span class="line">DockerComposeä½¿ç”¨çš„ä¸‰æ­¥:</span><br><span class="line">1.ä½¿ç”¨docker file å®šä¹‰åº”ç”¨ç¨‹åºçš„ç¯å¢ƒé•œåƒ</span><br><span class="line">2.docker-composeå®šä¹‰æ„æˆåº”ç”¨ç¨‹åºçš„æœåŠ¡</span><br><span class="line">3.å¯åŠ¨Composeï¼Œå°±ç›¸å½“äºå¯åŠ¨åº”ç”¨</span><br></pre></td></tr></table></figure><p><strong>ç‰ˆæœ¬</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">composeæ–‡ä»¶ç‰ˆæœ¬ï¼šversion: <span class="string">&#x27;2.3&#x27;</span></span><br><span class="line"></span><br><span class="line">docker-composeç¨‹åºå®‰è£…çš„ç‰ˆæœ¬ï¼š</span><br><span class="line">[root@harbor harbor]# docker-compose --version</span><br><span class="line">docker-compose version 1.18.0, build 8dd22a9</span><br><span class="line"></span><br><span class="line">dockerç‰ˆæœ¬ï¼š</span><br><span class="line">[root@harbor harbor]# docker --version</span><br><span class="line">Docker version 26.1.4, build 5650f9b</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240909134745384.png" alt="image-20240909134745384"></p><h3 id="2ã€å®‰è£…bocker-compose">2ã€<strong>å®‰è£…bocker-compose</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ–¹æ³•ä¸€ï¼šç‰ˆæœ¬ä¸å¯æ§ï¼Œå®‰è£…çš„ç‰ˆæœ¬ç¨å¾®åè€  1.18çš„</span></span><br><span class="line">1ã€å®‰è£…bocker-compose </span><br><span class="line">[root@docker01 ~]# yum install -y docker-compose</span><br><span class="line">[root@docker01 ~]# docker-compose --version</span><br><span class="line">docker-compose version 1.18.0, build 8dd22a9</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€æ–¹æ³•äºŒ  å¯èƒ½è¦å¼€ä»£ç†ä¸‹è½½</span><br><span class="line">[root@docker02 bin]# curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/v2.29.2/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/2.29.2/dockercompose-Linux-x86_64&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# <span class="built_in">mv</span> docker-compose-linux-x86_64\ \(2\)  docker-compose</span><br><span class="line">[root@docker01 ~]# <span class="built_in">mv</span> docker-compose /usr/local/bin/</span><br><span class="line">[root@docker01 ~]# <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose    </span><br><span class="line">[root@docker01 ~]# docker-compose  --version</span><br><span class="line">Docker Compose version v2.29.2</span><br><span class="line"></span><br><span class="line"><span class="comment">#æƒ³è¦å…¶ä»–æœºå™¨èƒ½å¤Ÿä½¿ç”¨docker-composeå‘½ä»¤,å¯ä»¥æŠŠè¿™ä¸ªæ–‡ä»¶scpè¿‡å»</span></span><br><span class="line">scp /usr/local/bin/docker-compose 10.0.0.102:/usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="3ã€docker-composeçš„æ¨¡ç‰ˆ">3ã€<strong>docker-composeçš„æ¨¡ç‰ˆ</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;ç‰ˆæœ¬å·&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  æœåŠ¡åç§°1:</span><br><span class="line">    image: å®¹å™¨é•œåƒ</span><br><span class="line">    container_name: å®¹å™¨åç§°(å®¹å™¨åç§°å’ŒæœåŠ¡åç§°ä¿æŒä¸€è‡´)</span><br><span class="line">    environment:</span><br><span class="line">      - ç¯å¢ƒå˜é‡1=å€¼1</span><br><span class="line">      - ç¯å¢ƒå˜é‡2=å€¼2</span><br><span class="line">    volumes:</span><br><span class="line">      - å®¿ä¸»æœºæ•°æ®ç›®å½•:å®¹å™¨å†…æ•°æ®ç›®å½•</span><br><span class="line">    ports:</span><br><span class="line">      - å®¿ä¸»æœºç«¯å£:å®¹å™¨å†…æ˜ å°„ç«¯å£</span><br><span class="line">    networks:</span><br><span class="line">      - è‡ªå®šä¹‰ç½‘ç»œåç§°</span><br><span class="line">    links:</span><br><span class="line">      - namenode</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - æ•°æ®åº“ä½¿ç”¨å­—ç¬¦é›†å˜é‡æ—¶å¯ä»¥ç”¨</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  æœåŠ¡åç§°2:</span><br><span class="line">    image: å®¹å™¨é•œåƒ</span><br><span class="line">    container_name: å®¹å™¨åç§°(å®¹å™¨åç§°å’ŒæœåŠ¡åç§°ä¿æŒä¸€è‡´)</span><br><span class="line">    environment:</span><br><span class="line">      - ç¯å¢ƒå˜é‡1=å€¼1</span><br><span class="line">      - ç¯å¢ƒå˜é‡2=å€¼2</span><br><span class="line">    user: å®¿ä¸»æœºç”¨æˆ·:å®¹å™¨ç”¨æˆ·</span><br><span class="line">    volumes:</span><br><span class="line">      - å®¿ä¸»æœºæ•°æ®ç›®å½•:å®¹å™¨å†…æ•°æ®ç›®å½•</span><br><span class="line">    ports:</span><br><span class="line">      - å®¿ä¸»æœºç«¯å£:å®¹å™¨å†…æ˜ å°„ç«¯å£</span><br><span class="line">    networks:</span><br><span class="line">      - è‡ªå®šä¹‰ç½‘ç»œåç§°</span><br><span class="line">    links:</span><br><span class="line">      - namenode</span><br><span class="line">    depends_on:</span><br><span class="line">      - ä¾èµ–æœåŠ¡</span><br><span class="line">    restart: always</span><br><span class="line"> </span><br><span class="line"><span class="comment">#å¦‚æœæ²¡æœ‰ç½‘ç»œï¼Œå°±ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">networks:</span><br><span class="line">  default:</span><br><span class="line">  externnal: <span class="literal">true</span></span><br><span class="line">  name: è‡ªå®šä¹‰ç½‘ç»œåç§°</span><br></pre></td></tr></table></figure><h3 id="4ã€docker-composeâ€”â€”å•æœºç¼–æ’mysql">4ã€<strong>docker-composeâ€”â€”å•æœºç¼–æ’mysql</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">1ã€#æ‰¾åˆ°è¿è¡Œmysqlçš„å‘½ä»¤</span><br><span class="line">docker run \</span><br><span class="line">--name mysql80 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=zabbix \</span><br><span class="line">-e MYSQL_USER=zabbix \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:8.0 \</span><br><span class="line">--character-set-server=utf8mb4 \</span><br><span class="line">--collation-server=utf8mb4_bin \</span><br><span class="line">--log_bin_trust_function_creators</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#ç¼–å†™docker-compose</span><br><span class="line">å¦‚æœä¹‹å‰è¿è¡Œæœ‰å…¶ä»–ç‰ˆæœ¬çš„mysqlï¼Œéœ€è¦æ¸…é™¤ç›®å½•</span><br><span class="line">[root@docker01 mysql]# <span class="built_in">rm</span> -rf /data/</span><br><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> mysql</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cd</span> mysql/</span><br><span class="line">[root@docker01 mysql]# vim mysql-compose.yml    (åå­—æœ€å¥½å«docker-compose.yml)</span><br><span class="line">version: <span class="string">&#x27;2.0&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  mysql80:</span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    container_name: mysql80</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=123</span><br><span class="line">      - MYSQL_DATABASE=zabbix</span><br><span class="line">      - MYSQL_USER=zabbix</span><br><span class="line">      - MYSQL_PASSWORD=123</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/mysql:/var/lib/mysql</span><br><span class="line">    ports:</span><br><span class="line">      - 3306:3306</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - --character-set-server=utf8mb4</span><br><span class="line">      - --collation-server=utf8mb4_bin</span><br><span class="line">      - --log_bin_trust_function_creators</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€#ç¬¬ä¸€æ¬¡å¯åŠ¨ä½¿ç”¨up,ä¼šåˆ›å»ºå®¹å™¨å¹¶å¯åŠ¨å®¹å™¨,å‰å°è¾“å‡ºæ—¥å¿—</span><br><span class="line">å¦‚æœåˆ›å»ºçš„æ–‡ä»¶åå«docker-compose.ymlï¼Œå¯åŠ¨å‘½ä»¤æ˜¯ï¼š</span><br><span class="line">      docker-compose up</span><br><span class="line">      </span><br><span class="line">å¦‚æœåˆ›å»ºçš„æ–‡ä»¶åä¸å«docker-compose.ymlï¼Œå¯åŠ¨å‘½ä»¤æ˜¯ï¼š</span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml up</span><br><span class="line"></span><br><span class="line">æ£€æŸ¥æ²¡é—®é¢˜å°±ctrl+c</span><br></pre></td></tr></table></figure><p>docker-composeçš„æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€æ¬¡å¯åŠ¨åˆ›å»ºå®¹å™¨å¹¶å‰å°è¾“å‡ºæ—¥å¿—</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml up</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœæ—¥å¿—æ²¡æœ‰æŠ¥é”™ï¼Œç›´æ¥åå°å¯åŠ¨</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœæ­¢å®¹å™¨</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨å®¹å™¨</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml start</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯å®¹å™¨</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¯¥composeä¸­çš„æ‰€æœ‰å®¹å™¨è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">[root@docker01 mysql]# docker-compose -f mysql-compose.yml ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤composeä¸­çš„å®¹å™¨</span></span><br><span class="line">[root@docker01 mysql]# docker-compose <span class="built_in">rm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ—¥å¿—</span></span><br><span class="line">[root@docker01 mysql]# docker-compose logs</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šæœåŠ¡å¯åœ</span></span><br><span class="line">[root@harbor harbor]# docker-compose start proxy</span><br></pre></td></tr></table></figure><h3 id="5ã€docker-composeâ€”â€”å•æœºç¼–æ’zabbix">5ã€<strong>docker-composeâ€”â€”å•æœºç¼–æ’zabbix</strong></h3><p>1ã€æ‰¾åˆ°è¿è¡Œzabbixçš„dockerå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">mysqlè¦åˆå§‹åŒ–ã€‚æ‰€ä»¥web-serverè¦åå¯åŠ¨  å†™æˆ=å¦‚æœæŠ¥é”™ã€‚å°±è¦å†™æˆkey: value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€#æ‰¾åˆ°è¿è¡Œmysqlçš„å‘½ä»¤</span><br><span class="line">docker run \</span><br><span class="line">--name mysql80 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=zabbix \</span><br><span class="line">-e MYSQL_USER=zabbix \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:8.0 \</span><br><span class="line">--character-set-server=utf8mb4 \</span><br><span class="line">--collation-server=utf8mb4_bin \</span><br><span class="line">--log_bin_trust_function_creators</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œå®¹å™¨åŒ–zabbix-server</span><br><span class="line">docker run \</span><br><span class="line">--<span class="built_in">link</span> mysql80 \</span><br><span class="line">--name zabbix-server \</span><br><span class="line">-p 10051:10051 \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">&quot;mysql80&quot;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&quot;123&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-server-mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€å®¹å™¨åŒ–zabbix-web</span><br><span class="line">docker run \</span><br><span class="line">--<span class="built_in">link</span> zabbix-server \</span><br><span class="line">--<span class="built_in">link</span> mysql80 \</span><br><span class="line">--name zabbix-web \</span><br><span class="line">-p 80:8080 \</span><br><span class="line">-p 8443:8443 \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">&quot;mysql80&quot;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&quot;123&quot;</span> \</span><br><span class="line">-e ZBX_SERVER_HOST=<span class="string">&quot;zabbix-server&quot;</span> \</span><br><span class="line">-e PHP_TZ=<span class="string">&quot;Asia/Shanghai&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-web-nginx-mysql</span><br></pre></td></tr></table></figure><p>2ã€ç¼–å†™zabbixçš„docker-compose</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# <span class="built_in">rm</span> -rf /data/</span><br><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> zabbix</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cd</span> zabbix/</span><br><span class="line">[root@docker01 zabbix]# vim docker-compose.yml</span><br><span class="line">version: <span class="string">&#x27;2.0&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  mysql80:</span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    container_name: mysql80</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=123</span><br><span class="line">      - MYSQL_DATABASE=zabbix</span><br><span class="line">      - MYSQL_USER=zabbix</span><br><span class="line">      - MYSQL_PASSWORD=123</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/mysql:/var/lib/mysql</span><br><span class="line">    ports:</span><br><span class="line">      - 3306:3306</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - --character-set-server=utf8mb4</span><br><span class="line">      - --collation-server=utf8mb4_bin</span><br><span class="line">      - --log_bin_trust_function_creators</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  zabbix-server:</span><br><span class="line">    image: zabbix/zabbix-server-mysql</span><br><span class="line">    container_name: zabbix-server</span><br><span class="line">    environment:</span><br><span class="line">      - DB_SERVER_HOST=mysql80</span><br><span class="line">      - MYSQL_USER=zabbix</span><br><span class="line">      - MYSQL_PASSWORD=123</span><br><span class="line">    ports:</span><br><span class="line">      - 10051:10051</span><br><span class="line">    links:</span><br><span class="line">      - mysql80</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">  zabbix-web:</span><br><span class="line">    image: zabbix/zabbix-web-nginx-mysql</span><br><span class="line">    container_name: zabbix-web</span><br><span class="line">    environment:</span><br><span class="line">      - DB_SERVER_HOST=mysql80</span><br><span class="line">      - MYSQL_USER=zabbix</span><br><span class="line">      - MYSQL_PASSWORD=123</span><br><span class="line">      - ZBX_SERVER_HOST=zabbix-server</span><br><span class="line">      - PHP_TZ=Asia/Shanghai</span><br><span class="line">    ports:</span><br><span class="line">      - 80:8080</span><br><span class="line">      - 443:8443</span><br><span class="line">    links:</span><br><span class="line">      - mysql80</span><br><span class="line">      - zabbix-server</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line"><span class="comment">#  networks:</span></span><br><span class="line"><span class="comment">#    default:</span></span><br><span class="line"><span class="comment">#      externnal: true</span></span><br><span class="line"><span class="comment">#      name: zabbix-net</span></span><br><span class="line"><span class="comment">#åŸºäºé»˜è®¤çš„default-bridgeç±»å‹åˆ›å»ºä¸€ä¸ªbridgeç±»å‹çš„ç½‘æ¡¥</span></span><br></pre></td></tr></table></figure><p>####æŠ¥é”™</p><p><img src="../image/study_img/image-20240909153932154.png" alt="image-20240909153932154"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## å¦‚æœæœ‰ç¯å¢ƒå˜é‡çš„æŠ¥é”™ï¼Œå°±å–æ¶ˆå•å¼•å·è¯•ä¸€ä¸‹ï¼Œä¸è¡Œå†æ¢æˆkey:valueæ ¼å¼</span></span><br><span class="line">environment:</span><br><span class="line">- DB_SERVER_HOST: <span class="string">&#x27;mysql80&#x27;</span></span><br><span class="line">- MYSQL_USER: <span class="string">&#x27;zabbix&#x27;</span></span><br><span class="line">- MYSQL_PASSWORD: <span class="string">&#x27;zabbix&#x27;</span></span><br></pre></td></tr></table></figure><p>3ã€å¯åŠ¨zabbix</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1ã€å‰å°æ£€æŸ¥æ˜¯å¦æœ‰æŠ¥é”™</span><br><span class="line">[root@docker01 zabbix]# docker-compose up </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€æ²¡æœ‰æŠ¥é”™å°±æ”¾åå°è¿è¡Œ</span><br><span class="line">[root@docker01 zabbix]# docker-compose up -d</span><br><span class="line"></span><br><span class="line">3ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.101</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240909154947402.png" alt="image-20240909154947402"></p><h3 id="6ã€docker-composeâ€”â€”å•æœºç¼–æ’jenkins">6ã€<strong>docker-composeâ€”â€”å•æœºç¼–æ’jenkins</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">1ã€gitlabé•œåƒ</span><br><span class="line">docker run \</span><br><span class="line">--hostname 10.0.0.102 \</span><br><span class="line">--<span class="built_in">env</span> GITLAB_OMNIBUS_CONFIG=<span class="string">&quot;external_url &#x27;http://10.0.0.102&#x27;&quot;</span> \</span><br><span class="line">-p 443:443 -p 80:80 -p 2222:22 \</span><br><span class="line">--name gitlab \</span><br><span class="line">--restart always \</span><br><span class="line">-v /data/gitlab/config:/etc/gitlab \</span><br><span class="line">-v /data/gitlab/logs:/var/log/gitlab \</span><br><span class="line">-v /data/gitlab/data:/var/opt/gitlab \</span><br><span class="line">-d gitlab/gitlab-ce</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œjenkinså®¹å™¨</span><br><span class="line">docker run \</span><br><span class="line">--name jenkins \</span><br><span class="line">--privileged \</span><br><span class="line">--user=root \</span><br><span class="line">--restart=always \</span><br><span class="line">-v /data/jenkins/:/var/jenkins_home \</span><br><span class="line">-v /usr/bin/docker:/usr/bin/docker \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">-v /root/.ssh/:/root/.ssh/ \</span><br><span class="line">-v /root/.docker/config.json:/root/.docker/config.json \</span><br><span class="line">-p 8080:8080 \</span><br><span class="line">-p 5000:5000 \</span><br><span class="line">-d jenkins/jenkins:2.422</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> jenkins &amp;&amp; <span class="built_in">cd</span> jenkins</span><br><span class="line">[root@docker01 jenkins]# vim jenkins-docker-compose.yml</span><br><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    image: gitlab/gitlab-ce</span><br><span class="line">    container_name: gitlab</span><br><span class="line">    hostname: 10.0.0.102</span><br><span class="line">    environment:</span><br><span class="line">      GITLAB_OMNIBUS_CONFIG: |</span><br><span class="line">        external_url <span class="string">&#x27;http://10.0.0.102</span></span><br><span class="line"><span class="string">        gitlab_rails[&#x27;</span>gitlab_shell_ssh_port<span class="string">&#x27;] = 2222 </span></span><br><span class="line"><span class="string">        alertmanager[&#x27;</span><span class="built_in">enable</span><span class="string">&#x27;] = false</span></span><br><span class="line"><span class="string">        node_exporter[&#x27;</span><span class="built_in">enable</span><span class="string">&#x27;] = false</span></span><br><span class="line"><span class="string">        redis_exporter[&#x27;</span><span class="built_in">enable</span><span class="string">&#x27;] = false</span></span><br><span class="line"><span class="string">        postgres_exporter[&#x27;</span><span class="built_in">enable</span><span class="string">&#x27;] = false</span></span><br><span class="line"><span class="string">    volumes:</span></span><br><span class="line"><span class="string">      - /data/gitlab/config:/etc/gitlab </span></span><br><span class="line"><span class="string">      - /data/gitlab/logs:/var/log/gitlab </span></span><br><span class="line"><span class="string">      - /data/gitlab/data:/var/opt/gitlab</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - 443:443 </span></span><br><span class="line"><span class="string">      - 80:80 </span></span><br><span class="line"><span class="string">      - 2222:22</span></span><br><span class="line"><span class="string">    restart: always</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">  jenkins:</span></span><br><span class="line"><span class="string">    image: jenkins/jenkins:2.422</span></span><br><span class="line"><span class="string">    container_name: jenkins</span></span><br><span class="line"><span class="string">    user: root</span></span><br><span class="line"><span class="string">    privileged: ture</span></span><br><span class="line"><span class="string">    volumes:</span></span><br><span class="line"><span class="string">      - /data/jenkins/:/var/jenkins_home</span></span><br><span class="line"><span class="string">      - /usr/bin/docker:/usr/bin/docker</span></span><br><span class="line"><span class="string">      - /var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line"><span class="string">      - /root/.ssh/:/root/.ssh/</span></span><br><span class="line"><span class="string">      - /root/.docker/config.json:/root/.docker/config.json</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">      - 8080:8080 </span></span><br><span class="line"><span class="string">      - 5000:5000 </span></span><br><span class="line"><span class="string">    restart: always</span></span><br></pre></td></tr></table></figure><h3 id="7ã€docker-composeâ€”â€”å•æœºç¼–æ’wordpress">7ã€<strong>docker-composeâ€”â€”å•æœºç¼–æ’wordpress</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œwordpresså®¹å™¨</span></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wp_db \</span><br><span class="line">-d wordpress-df:v1 </span><br></pre></td></tr></table></figure><p>2ã€ç¼–å†™docker-compos</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> wp</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cd</span> wp/</span><br><span class="line">[root@docker01 wp]# vim wp-docker-compose.yml</span><br><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  mysql57:</span><br><span class="line">    image: mysql:5.7.44</span><br><span class="line">    container_name: mysql57</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=123</span><br><span class="line">      - MYSQL_DATABASE=wp_db</span><br><span class="line">      - MYSQL_USER=wp_user</span><br><span class="line">      - MYSQL_PASSWORD=123</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/mysql:/var/lib/mysql</span><br><span class="line">    ports:</span><br><span class="line">      - 3306:3306</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  wp:</span><br><span class="line">    image:  wordpress-df:v2</span><br><span class="line">    container_name: wp</span><br><span class="line">    environment:</span><br><span class="line">      - WORDPRESS_DB_HOST=mysql57</span><br><span class="line">      - WORDPRESS_DB_USER=wp_user</span><br><span class="line">      - WORDPRESS_DB_PASSWORD=123</span><br><span class="line">      - WORDPRESS_DB_NAME=wp_db</span><br><span class="line">    ports:</span><br><span class="line">      - 80:80</span><br><span class="line">    links:</span><br><span class="line">      - mysql57</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">[root@docker01 wp]# docker-compose -f wp-docker-compose.yml up -d</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ä½¿ç”¨docker-composeç†å®¹å™¨çš„èµ·åœ</summary>
    
    
    
    <category term="docker" scheme="https://www.fomal.cc/categories/docker/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ¡å…­ã€dockerçš„å®¹å™¨åŒ–ä»£ç ä¸Šçº¿</title>
    <link href="https://www.fomal.cc/posts/93124e7b.html"/>
    <id>https://www.fomal.cc/posts/93124e7b.html</id>
    <published>2024-09-22T05:24:52.000Z</published>
    <updated>2024-10-02T07:53:01.124Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å®¹å™¨åŒ–ä»£ç ä¸Šçº¿">å®¹å™¨åŒ–ä»£ç ä¸Šçº¿</h2><h3 id="1ã€å®¹å™¨åŒ–gitlab"><strong>1ã€å®¹å™¨åŒ–gitlab</strong></h3><p>ç¯å¢ƒå‡†å¤‡  å…ˆæ£€æŸ¥å¯ä»¥å†…å­˜Avail(æœ€å°‘è¿˜æœ‰10G)æ¯”è¾ƒå¤šçš„æœºå™¨ï¼Œå»æ‹‰å–gitlabï¼Œä¸ç„¶ä¼šæ‹‰å–å¤±è´¥</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th><th>å†…å­˜</th></tr></thead><tbody><tr><td>docker03</td><td>10.0.0.102  /  172.16.1.102</td><td>éƒ¨ç½²å®¹å™¨åŒ–gitlab</td><td>8G</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®¹å™¨åŒ–ä»£ç ä¸Šçº¿å‘ï¼š</span></span><br><span class="line">1.gitlabå¦‚ä½•ä½¿ç”¨é22ç«¯å£æ‹‰ä»£ç </span><br><span class="line">2.jenkinså®¹å™¨å¦‚ä½•ä½¿ç”¨dockerå‘½ä»¤</span><br><span class="line">3.jenkinsçš„å¯†é’¥ä¸Šä¼ åˆ°gitlab</span><br><span class="line">4.jenkinså¦‚ä½•ç™»å½• harbor</span><br><span class="line"></span><br><span class="line">å¼€å‘æŠŠä»£ç æäº¤åˆ°gitlabï¼Œjekinså»æ‹‰å–ä»£ç åˆ°å®¹å™¨é‡Œé¢</span><br></pre></td></tr></table></figure><p>å®¹å™¨åŒ–ä»£ç ä¸Šçº¿æµç¨‹å›¾</p><p><img src="../image/study_img/image-20240905093733661.png" alt="image-20240905093733661"></p><p>1ã€å»å®˜ç½‘æŸ¥æ‰¾è¿è¡Œå®¹å™¨çš„ä»£ç   <a href="https://about.gitlab.com/">https://about.gitlab.com/</a></p><p><img src="../image/study_img/image-20240907130711368.png" alt="image-20240907130711368"></p><p>å¾€ä¸‹æ»‘ æ‰¾åˆ°å®¹å™¨å®‰è£…</p><p><img src="../image/study_img/image-20240907130745739.png" alt="image-20240907130745739"></p><p><img src="../image/study_img/image-20240907131037286.png" alt="image-20240907131037286"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–é•œåƒ   Git-ce æ˜¯ç¤¾åŒºç‰ˆï¼Œgitlab-eeæ˜¯ä¼ä¸šç‰ˆï¼Œæ”¶è´¹çš„ã€‚</span><br><span class="line">[root@docker02 ~]# docker pull gitlab/gitlab-ce:latest</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œé•œåƒ</span><br><span class="line">docker run \</span><br><span class="line">--hostname 10.0.0.102 \</span><br><span class="line">--<span class="built_in">env</span> GITLAB_OMNIBUS_CONFIG=<span class="string">&quot;external_url &#x27;http://10.0.0.102&#x27;&quot;</span> \</span><br><span class="line">-p 443:443 -p 80:80 -p 2222:22 \</span><br><span class="line">--name gitlab \</span><br><span class="line">--restart always \</span><br><span class="line">-v /data/gitlab/config:/etc/gitlab \</span><br><span class="line">-v /data/gitlab/logs:/var/log/gitlab \</span><br><span class="line">-v /data/gitlab/data:/var/opt/gitlab \</span><br><span class="line">-d gitlab/gitlab-ce</span><br><span class="line"></span><br><span class="line">-p 2222:22  å®¿ä¸»æœºçš„22ç«¯å£è¢«å ç”¨äº†ï¼Œæ‰€æœ‰ä½¿ç”¨å®¿ä¸»æœºçš„2222ç«¯å£</span><br><span class="line">--detach=-d</span><br><span class="line"></span><br><span class="line">3ã€è¿è¡Œä¹‹åï¼Œæ‰§è¡Œ</span><br><span class="line">[root@docker02 ~]# docker ps</span><br><span class="line">å¯èƒ½ä¸€å¼€å§‹çœ‹ä¸åˆ°è¿è¡Œç»“æœï¼Œå› ä¸ºé•œåƒæ¯”è¾ƒå¤§ï¼Œè¿è¡Œèµ·æ¥æ¯”è¾ƒæ…¢ï¼Œåé¢è¿˜è¦åšä¼˜åŒ–ï¼Œå…ˆè¿›å…¥å®¹å™¨é‡Œé¢ï¼ŒæŸ¥çœ‹å¯åŠ¨çŠ¶æ€</span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it gitlab /bin/bash</span><br><span class="line">root@10:/# gitlab-ctl status</span><br><span class="line">run: alertmanager: (pid 1281) 314s; run: <span class="built_in">log</span>: (pid 1008) 429s</span><br><span class="line">run: gitaly: (pid 1231) 318s; run: <span class="built_in">log</span>: (pid 559) 642s</span><br><span class="line">run: gitlab-exporter: (pid 1219) 319s; run: <span class="built_in">log</span>: (pid 939) 448s</span><br><span class="line">run: gitlab-kas: (pid 751) 626s; run: <span class="built_in">log</span>: (pid 768) 623s</span><br><span class="line">run: gitlab-workhorse: (pid 1155) 321s; run: <span class="built_in">log</span>: (pid 885) 461s</span><br><span class="line">run: logrotate: (pid 502) 655s; run: <span class="built_in">log</span>: (pid 514) 653s</span><br><span class="line">run: nginx: (pid 1169) 320s; run: <span class="built_in">log</span>: (pid 917) 455s</span><br><span class="line">run: postgres-exporter: (pid 1289) 314s; run: <span class="built_in">log</span>: (pid 1032) 420s</span><br><span class="line">run: postgresql: (pid 583) 632s; run: <span class="built_in">log</span>: (pid 594) 631s</span><br><span class="line">run: prometheus: (pid 1238) 318s; run: <span class="built_in">log</span>: (pid 984) 437s</span><br><span class="line">run: puma: (pid 835) 474s; run: <span class="built_in">log</span>: (pid 842) 473s</span><br><span class="line">run: redis: (pid 519) 649s; run: <span class="built_in">log</span>: (pid 532) 647s</span><br><span class="line">run: redis-exporter: (pid 1221) 319s; run: <span class="built_in">log</span>: (pid 968) 441s</span><br><span class="line">run: sidekiq: (pid 852) 468s; run: <span class="built_in">log</span>: (pid 860) 467s</span><br><span class="line">run: sshd: (pid 37) 676s; run: <span class="built_in">log</span>: (pid 36) 676s</span><br><span class="line"></span><br><span class="line">4ã€çœ‹åˆ°nginxæœåŠ¡èµ·æ¥äº†ï¼Œå°±å¯ä»¥è®¿é—®ç½‘é¡µ</span><br><span class="line">10.0.0.102</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907152247060.png" alt="image-20240907152247060"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç™»å½•çš„ç”¨æˆ·åæ˜¯root</span><br><span class="line"></span><br><span class="line">5ã€æŸ¥çœ‹gitlabçš„åˆå§‹å¯†ç </span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it gitlab grep <span class="string">&#x27;Password:&#x27;</span> /etc/gitlab/initial_root_password</span><br><span class="line">Password: dUs0tOCn+nDOkWoShlwCvYYWlnIZUwaiBujL9BkO2TU=</span><br></pre></td></tr></table></figure><p>6ã€åˆ›å»ºä¸€ä¸ªé¡¹ç›®</p><p><img src="../image/study_img/image-20240907153032437.png" alt="image-20240907153032437"></p><p><img src="../image/study_img/image-20240907153123588.png" alt="image-20240907153123588"></p><p><img src="../image/study_img/image-20240907155134996.png" alt="image-20240907155134996"></p><p>7ã€æ‹‰å–ä»£ç ï¼šç›®å‰é¡¹ç›®åˆ›å»ºå®Œæˆåï¼Œä½¿ç”¨å…¶ä»–æœºå™¨æ‹‰å–ä»£ç ï¼Œæ— æ³•æ‹‰å–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–ä»£ç çš„æœºå™¨éœ€è¦å®‰è£…git</span><br><span class="line">[root@docker01 ~]# yum -y install git</span><br><span class="line"></span><br><span class="line">2ã€ç”Ÿæˆå¯†é’¥å¯¹ï¼Œé…ç½®åˆ°gitlabä»“åº“</span><br><span class="line">[root@docker01 ~]# ssh-keygen</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cat</span> ~/.ssh/id_rsa.pub </span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDQrHuOoZahkYpkUthbzbVLMH3ijST4TSPGuKWm77QBIredxGGKpoq2TN71pysOPUiGUKpBQnttyfo5AOealp0knNFuxqiShcRa8IlJQMX6mJfVFrY6jI5g/AnDvIayurVVBsf6T7h6sQNV8Pj4bzGpO8PXi8Z8GGslZ2LbmqA+LsfLLX/KR3BJce4JC/0PsK4DqAVO/WVYd7H0qeSUK5arrnpt7ncYVx02k63KI47Tb4W+nyqhlChwxD55V3ArzbvVpQy3BnRoOQQ5cr7le6HP+kl27jHTxCNJ7bf5uU1O4Polc3ODBkq2gZC9JaN6O8RuyB2UeCe5odVYOmxb5IKJ root@docker01</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907154118623.png" alt="image-20240907154118623"></p><p><img src="../image/study_img/image-20240907154153334.png" alt="image-20240907154153334"></p><p><img src="../image/study_img/image-20240907154228630.png" alt="image-20240907154228630"></p><p>ä¿®æ”¹ä¸ºä¸­æ–‡å­—ä½“ï¼Œå†åˆ·æ–°</p><p><img src="../image/study_img/image-20240907154846257.png" alt="image-20240907154846257"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä½¿ç”¨è¿™ä¸ªå‘½ä»¤æ‹‰å–ä»£ç æ—¶ï¼Œè¿˜éœ€è¦è¾“å…¥å¯†ç ï¼Œæ‰€ä»¥é…ç½®çš„sshå¯†é’¥å¯¹åˆ°gitlabæ—¶æ˜¯ä¸å¤ªè¡Œçš„</span><br><span class="line">[root@docker01 ~]# git <span class="built_in">clone</span> git@10.0.0.102:root/web.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#gitlabä½¿ç”¨é22ç«¯å£æ‹‰ä»£ç </span><br><span class="line">[root@docker01 ~]# git <span class="built_in">clone</span> ssh://git@10.0.0.102:2222/root/web.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€ç”±äºæ¯æ¬¡æ‹‰å–ä»£ç éƒ½è¦è¾“å…¥åè®®å’Œç«¯å£ï¼Œæ•ˆç‡ä¸é«˜ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶è®¾ç½®è‡ªåŠ¨å‡ºç°åè®®å’Œç«¯å£ï¼Œç›´æ¥å¤åˆ¶</span><br><span class="line"><span class="comment">#ä¿®æ”¹é…ç½®æ–‡ä»¶å’Œåšgitlabçš„ä¼˜åŒ–</span></span><br><span class="line">ç”±äºé…ç½®æ–‡ä»¶å·²ç»æ˜ å°„å‡ºæ¥äº†ï¼Œç›´æ¥ä¿®æ”¹</span><br><span class="line">[root@docker02 ~]# vim /data/gitlab/config/gitlab.rb</span><br><span class="line"><span class="comment">#32è¡Œï¼šurlçš„é…ç½®</span></span><br><span class="line">external_url <span class="string">&#x27;http://10.0.0.102&#x27;</span>  </span><br><span class="line"><span class="comment"># 698è¡Œï¼šç«¯å£çš„é…ç½®</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 2222 </span><br><span class="line"><span class="comment">###ä¼˜åŒ–å†…å®¹  æŠŠè¿™å‡ è¡ŒåŠ å…¥é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">#å‘Šè­¦å…³é—­</span></span><br><span class="line">alertmanager[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"><span class="comment">#å…³é—­å‰ç«¯çš„nodeåŠŸèƒ½</span></span><br><span class="line">node_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"><span class="comment">#å…³é—­redisåŠŸèƒ½</span></span><br><span class="line">redis_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"><span class="comment">#å…³é—­postgreåŠŸèƒ½</span></span><br><span class="line">postgres_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€é‡æ–°åŠ è½½gitlabé…ç½®æ–‡ä»¶ï¼Œéœ€è¦ç­‰å¾…3åˆ†é’Ÿå·¦å³</span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it gitlab gitlab-ctl reconfigure</span><br><span class="line">reconfigureç›¸å½“äºnginxçš„reloadï¼Œè¿˜æ˜¯å¯ä»¥æ­£å¸¸è®¿é—®ç½‘é¡µçš„</span><br><span class="line"></span><br><span class="line">5ã€å†æ¬¡è®¿é—®ç½‘é¡µï¼Œåˆ·æ–°é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°æä¾›çš„åœ°å€æ˜¯ç›´æ¥å¯ä»¥ä½¿ç”¨çš„åœ°å€</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907162925699.png" alt="image-20240907162925699"></p><h3 id="2ã€å®¹å™¨åŒ–jenkins"><strong>2ã€å®¹å™¨åŒ–jenkins</strong></h3><p>è®¿é—®å®˜ç½‘ï¼Œæ‰¾åˆ°å¯åŠ¨å®¹å™¨çš„å‘½ä»¤ï¼š<a href="https://www.jenkins.io/">https://www.jenkins.io/</a></p><p><img src="../image/study_img/image-20240907163455778.png" alt="image-20240907163455778"></p><p><img src="../image/study_img/image-20240907163613722.png" alt="image-20240907163613722"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">--name jenkins-docker \</span><br><span class="line">--<span class="built_in">rm</span> \</span><br><span class="line">--detach \</span><br><span class="line">--privileged \</span><br><span class="line">--network jenkins \    <span class="comment">#ç½‘ç»œæ²¡æœ‰é…ç½®ï¼Œéœ€è¦åˆ é™¤</span></span><br><span class="line">--network-alias docker \ <span class="comment">#ç½‘ç»œæ²¡æœ‰é…ç½®ï¼Œéœ€è¦åˆ é™¤</span></span><br><span class="line">--<span class="built_in">env</span> DOCKER_TLS_CERTDIR=/certs \  <span class="comment">#æ²¡æœ‰è¯ä¹¦ï¼Œéœ€è¦åˆ é™¤</span></span><br><span class="line">--volume jenkins-docker-certs:/certs/client \ <span class="comment">#æ²¡æœ‰è¯ä¹¦ï¼Œéœ€è¦åˆ é™¤</span></span><br><span class="line">--volume jenkins-data:/var/jenkins_home \  <span class="comment">#æ˜ å°„çš„jenkinsç›®å½•</span></span><br><span class="line">--publish 2376:2376 \</span><br><span class="line">docker:dind \</span><br><span class="line">--storage-driver overlay2</span><br></pre></td></tr></table></figure><p>åˆ°dockerå®˜ç½‘ï¼Œæ‰¾åˆ°jenkinsé•œåƒ  <a href="https://hub.docker.com/">https://hub.docker.com/</a></p><p><img src="../image/study_img/image-20240907164947184.png" alt="image-20240907164947184"></p><p><img src="../image/study_img/image-20240907165448303.png" alt="image-20240907165448303"></p><p><img src="../image/study_img/image-20240907165642490.png" alt="image-20240907165642490"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–2.422ç‰ˆæœ¬çš„é•œåƒ</span><br><span class="line">[root@docker02 ~]# docker pull jenkins/jenkins:2.422</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œjenkinså®¹å™¨</span><br><span class="line">docker run \</span><br><span class="line">--name jenkins \</span><br><span class="line">--privileged \</span><br><span class="line">--user=root \</span><br><span class="line">--restart=always \</span><br><span class="line">-v /data/jenkins/:/var/jenkins_home \</span><br><span class="line">-v /usr/bin/docker:/usr/bin/docker \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">-v /root/.ssh/:/root/.ssh/ \</span><br><span class="line">-v /root/.docker/config.json:/root/.docker/config.json \</span><br><span class="line">-p 8080:8080 \</span><br><span class="line">-p 5000:5000 \</span><br><span class="line">-d jenkins/jenkins:2.422</span><br><span class="line"></span><br><span class="line">--<span class="built_in">rm</span>ï¼šåªè¦å®¹å™¨åœæ­¢å°±ä¼šåˆ æ‰</span><br><span class="line">--user=rootï¼šjenkinséœ€è¦rootç”¨æˆ·å»å¯åŠ¨ï¼Œä¸ç„¶è¿è¡Œä¹‹ådocker <span class="built_in">log</span> -f jenkinsæŸ¥çœ‹æ—¥å¿—éƒ½ä¼šæ²¡æœ‰æƒé™</span><br><span class="line">--privilegedï¼šç›¸å½“äºzabbixéœ€è¦ç›‘æ§å®¿ä¸»æœºï¼Œæƒ³è¦æœ‰æƒé™å°±éœ€è¦è¿™ä¸ªå‚æ•°ï¼Œè¿˜å¯ä»¥è®©å®¹å™¨æœ‰æƒé™èƒ½ä½¿ç”¨å®¿ä¸»æœºä¸Šçš„dockerå‘½ä»¤</span><br><span class="line">dockerå®¹å™¨æƒ³è¦ä½¿ç”¨å®¿ä¸»æœºçš„å‘½ä»¤å°±æ˜¯docker <span class="keyword">in</span> docker</span><br><span class="line">-v /usr/bin/dockerï¼šå°†å®¿ä¸»æœºçš„dockerå‘½ä»¤æ˜ å°„ï¼Œå®¹å™¨é‡Œé¢å°±å¯ä»¥æ‰§è¡Œdocker ps..</span><br><span class="line">-v /var/run/docker.sockï¼šdockerçš„å‘½ä»¤é€šè¿‡socktè¿æ¥çš„ï¼Œéœ€è¦æ˜ å°„sockæ–‡ä»¶ï¼Œç”±äºå®¹å™¨é‡Œé¢æ²¡æœ‰sockæ–‡ä»¶ï¼Œä¸ç„¶æ‰§è¡Œdockerå‘½ä»¤ä¼šæŠ¥é”™</span><br><span class="line"><span class="comment">#è§£å†³jenkinsç”Ÿæˆå¯†é’¥åˆ°gitlab,å¦‚æœåœ¨å®¹å™¨é‡Œé¢ç”Ÿæˆå¯†é’¥å¯¹ï¼Œä¸‡ä¸€jenkinså®•æœºäº†ï¼Œåœ¨é‡æ–°ç”Ÿæˆå¯†é’¥å¯¹ï¼Œä¹‹å‰æ”¾åˆ°gitlabé‡Œé¢çš„å¯†é’¥å¯¹å°±ä¸èƒ½ä½¿ç”¨äº†ï¼Œä¸ºäº†å¯†é’¥å¯¹æŒä¹…åŒ–ï¼Œéœ€è¦åœ¨å®¿ä¸»æœºä¸Šç”Ÿæˆå¯†é’¥å¯¹ï¼Œæ˜ å°„åˆ°å®¹å™¨</span></span><br><span class="line">[root@docker02 ~]# ssh-keygen</span><br><span class="line">-v /root/.sshï¼šå°†å®¿ä¸»æœºçš„å¯†é’¥å¯¹æ˜ å°„åˆ°å®¹å™¨</span><br><span class="line">-v /root/.docker/config.jsonï¼šå°†ç™»å½•harborçš„è®¤è¯ä¿¡æ¯æ˜ å°„ï¼Œå®¹å™¨å°±å¯ä»¥æ¨é€é•œåƒåˆ°harbor</span><br><span class="line"></span><br><span class="line">3ã€ä¸Šä¼ æ’ä»¶</span><br><span class="line"></span><br><span class="line">4ã€è§£å‹æ’ä»¶</span><br><span class="line">[root@docker02 ~]# tar xf jenkins_plugins_2.422.tgz -C /data/jenkins/</span><br><span class="line"></span><br><span class="line">5ã€å†é‡æ–°å¯åŠ¨jenkins</span><br><span class="line">[root@docker02 ~]# docker restart jenkins</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6ã€æµè§ˆå™¨è®¿é—®ç½‘é¡µ</span><br><span class="line">10.0.0.102:8080</span><br><span class="line"></span><br><span class="line">7ã€æŸ¥çœ‹å¯†ç </span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it jenkins <span class="built_in">cat</span> /var/jenkins_home/secrets/initialAdminPassword</span><br><span class="line">3766efc193fe418f9256897f39840929</span><br><span class="line"></span><br><span class="line">ç”±äº/var/jenkins_homeç›®å½•å·²ç»æ˜ å°„å‡ºæ¥åœ¨å®¿ä¸»æœºä¸Šå·²ç»æŒä¹…åŒ–äº†ï¼Œè¿˜å¯ä»¥è¿™æ ·æŸ¥çœ‹å¯†ç æ–‡ä»¶</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> /data/jenkins/secrets/initialAdminPassword </span><br><span class="line">3766efc193fe418f9256897f39840929</span><br><span class="line"></span><br><span class="line">ç„¶åå‡ºç°å®‰è£…jenkinsæ’ä»¶çš„é¡µé¢ä¹‹é—´ï¼Œä¸è¦å®‰è£…æ’ä»¶ï¼Œç›´æ¥ç‚¹å‡»å³ä¸Šè§’çš„Ã—â€”â€”&gt;ç‚¹å‡»å¼€å§‹ä½¿ç”¨jenkins</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907175615967.png" alt="image-20240907175615967"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">8ã€å°†æ­å»ºäº†jenkinsæœåŠ¡å™¨çš„å…¬é’¥æ”¾åˆ°gitlabæœåŠ¡å™¨</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> .ssh/id_rsa.pub </span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDPOMkDhGerkcJCwv55/6B4vTtzY0gxDKDYibzGUHX18AKgN8eZUBQVyub/mLmhBYlPWBIlb8x1xzNqH6N+kt/aIp03KheYAJBk26Npc8vtVEh009kf9DU3q4QopDrbKOmaF21/0LZ+ZVsAT0AmPKVH8pWodOv9O8aoXoVZe+uxAD+nItopJ6bnDzalKLEeVadtGZqm4k+AZRY2W7bZFUlss6WEKB2DLWfnf4FkIkDBQqLTPOS8ovB4U9gEBqN0vRFGI9qa1dDE4I9bK3ISKWBLR1yzV5wA4ARszXuj4t/nEP71qWfdi3vi9xdYvWStGdWa487nIFgi7s96ix9g8QBD root@docker02</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907182329531.png" alt="image-20240907182329531"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">9ã€jenkinsæœºå™¨æ‹‰å–gitlabé‡Œé¢çš„ä»£ç </span><br><span class="line">è¿›å…¥jenkinså®¹å™¨</span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it jenkins /bin/bash</span><br><span class="line"></span><br><span class="line">10ã€æ‹‰å–ä»£ç </span><br><span class="line">root@126b61b9d225:/# git <span class="built_in">clone</span> ssh://git@10.0.0.102:2222/root/web.git</span><br><span class="line">è¾“å…¥<span class="built_in">yes</span>ï¼Œä¸éœ€è¦è¾“å…¥å¯†ç ï¼Œç›´æ¥å…å¯†æ‹‰å–ä»£ç </span><br></pre></td></tr></table></figure><h3 id="3ã€æµ‹è¯•å°†jenkinsé‡Œé¢çš„é•œåƒæ¨é€åˆ°Harborå›¾å½¢åŒ–é•œåƒä»“åº“"><strong>3ã€æµ‹è¯•å°†jenkinsé‡Œé¢çš„é•œåƒæ¨é€åˆ°Harborå›¾å½¢åŒ–é•œåƒä»“åº“</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">1ã€è¿›å…¥jenkinså®¹å™¨</span><br><span class="line">[root@docker02 ~]# docker <span class="built_in">exec</span> -it jenkins /bin/bash</span><br><span class="line">root@126b61b9d225:/# docker images</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€å°†é•œåƒæ”¹å</span><br><span class="line">root@126b61b9d225:/# docker tag wordpress:v7 172.16.1.76/wordpress/wordpress-jenkins-harbor:v7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€æ¨é€é•œåƒ   æŠ¥é”™ï¼Œæ˜¯å› ä¸ºéœ€è¦ç™»å½•ï¼Œä½†æ˜¯æ¯æ¬¡é‡å¯éƒ½éœ€è¦ç™»å½•</span><br><span class="line">root@126b61b9d225:/# docker push 172.16.1.76/wordpress/wordpress-jenkins-harbor:v7</span><br><span class="line">unauthorized: unauthorized to access repository: wordpress/wordpress-jenkins-harbor, action: push: unauthorized to access repository: wordpress/wordpress-jenkins-harbor, action: push</span><br><span class="line"></span><br><span class="line">4ã€æ£€æŸ¥å®¿ä¸»æœºæ˜¯å¦èƒ½å¤Ÿæ¨é€</span><br><span class="line">[root@docker02 ~]# docker push 172.16.1.76/wordpress/wordpress-jenkins-harbor:v7</span><br><span class="line">unauthorized: unauthorized to access repository: wordpress/wordpress-jenkins-harbor, action: push: unauthorized to access repository: wordpress/wordpress-jenkins-harbor, action: push</span><br><span class="line"></span><br><span class="line">5ã€å®¿ä¸»æœºä¸èƒ½æ¨é€ï¼Œéœ€è¦ç™»å½•harbor</span><br><span class="line">[root@docker01 ~]# docker login 172.16.1.76</span><br><span class="line">Username: admin</span><br><span class="line">Password:  <span class="comment">#å¯†ç ï¼šHarbor12345</span></span><br><span class="line">......</span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">6ã€å®¿ä¸»æœºæ­£å¸¸æ¨é€  æ¨é€æˆåŠŸ</span><br><span class="line">[root@docker02 ~]# docker push 172.16.1.76/wordpress/wordpress-jenkins-harbor:v7</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240907210452739.png" alt="image-20240907210452739"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">7ã€å®¿ä¸»æœºèƒ½å¤Ÿæ¨é€é•œåƒï¼Œä½†æ˜¯å®¹å™¨ä¸ä¸€å®šèƒ½æ¨ï¼Œå› ä¸ºå®¹å™¨ä¹Ÿæ˜¯éœ€è¦loginç™»å½•çš„ï¼Œä½†æ˜¯è¿™é‡Œä¸éœ€è¦å®¹å™¨ç™»å½•</span><br><span class="line">å®¿ä¸»æœºç™»å½•äº†ä¹‹åï¼Œä¼šæœ‰ä¸€ä¸ªè®¤è¯ä¿¡æ¯åšå‡ºä¸€ä¸ªæ–‡ä»¶ä¿å­˜åˆ°~/.docker/config.json</span><br><span class="line">[root@docker02 ~]# ll -a ~/.docker/config.json </span><br><span class="line">-rw------- 1 root root 139 Sep  7 21:02 /root/.docker/config.json</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> ~/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;auths&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;10.0.0.76&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;auth&quot;</span>: <span class="string">&quot;YWRtaW46SGFyYm9yMTIzNDU=&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;172.16.1.76&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;auth&quot;</span>: <span class="string">&quot;YWRtaW46SGFyYm9yMTIzNDU=&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">#æ‰€ä»¥ï¼Œæ˜¯éœ€è¦åœ¨å¯åŠ¨jenkinsçš„æ—¶å€™ï¼Œå°†è®¤è¯ä¿¡æ¯çš„æ–‡ä»¶æ˜ å°„ï¼Œè¿™æ ·jenkinså®¹å™¨å°±å¯ä»¥æ¨é€é•œåƒåˆ°Harborä»åº“ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™æˆ‘å·²ç»åŠ ä¸Šè¿™ä¸ªæ–‡ä»¶æ˜ å°„äº†çš„ï¼Œåªè¦æˆ‘çš„å®¿ä¸»æœºç™»å½•è¿‡ï¼Œæˆ‘çš„jenkinså®¹å™¨å¯ä»¥æ¨é€</span></span><br></pre></td></tr></table></figure><h3 id="4ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”è‡ªç”±é£æ ¼"><strong>4ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”è‡ªç”±é£æ ¼</strong></h3><p>1ã€æµ‹è¯•æ„å»º</p><p><img src="../image/study_img/image-20240907230455222.png" alt="image-20240907230455222"></p><p><img src="../image/study_img/image-20240907234349843.png" alt="image-20240907234349843"></p><p>å¤åˆ¶ä»£ç åœ°å€</p><p><img src="../image/study_img/image-20240907234446792.png" alt="image-20240907234446792"></p><p><img src="../image/study_img/image-20240907234558247.png" alt="image-20240907234558247"></p><p><img src="../image/study_img/image-20240908000318150.png" alt="image-20240908000318150"></p><p>æ‰§è¡Œæ„å»ºï¼Œæ„å»ºæˆåŠŸ</p><p><img src="../image/study_img/image-20240908000821406.png" alt="image-20240908000821406"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1ã€#æ‹‰å–åä»£ç å­˜æ”¾çš„ç›®å½•</span><br><span class="line">[root@docker02 ~]# ll /data/jenkins/workspace/web-frestlye/</span><br><span class="line">-rw-r--r-- 1 root root    7 Sep  8 00:06 index.html</span><br><span class="line">-rw-r--r-- 1 root root 6141 Sep  8 00:06 README.md</span><br><span class="line"></span><br><span class="line">2ã€#å…å¯†webæœåŠ¡å™¨</span><br><span class="line">[root@docker02 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.101</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;WORKSPACE&#125;</span></span><br><span class="line">/var/jenkins_home/workspace/web-frestlye</span><br></pre></td></tr></table></figure><p>2ã€å†™è„šæœ¬æ„å»º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">harbor_ip=172.16.1.76</span><br><span class="line">web_ip=172.16.1.101</span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$&#123;WORKSPACE&#125;</span>/Dockerfile &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">FROM nginx:alpine</span></span><br><span class="line"><span class="string">#å°†ç½‘é¡µä»£ç å¤åˆ¶åˆ°nginxçš„ç«™ç‚¹ç›®å½•ä¸‹</span></span><br><span class="line"><span class="string">COPY index.html /usr/share/nginx/html/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">#è¿›å…¥å·¥ä½œç›®å½•æ„å»ºé•œåƒ</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;WORKSPACE&#125;</span> &amp;&amp; \</span><br><span class="line">docker build -t <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:v1 .</span><br><span class="line"><span class="comment">#æ‰“å®Œé•œåƒåæ¨é€åˆ°Harborä»“åº“</span></span><br><span class="line">docker push <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:v1</span><br><span class="line"><span class="comment">#è¿æ¥åˆ°webæœåŠ¡å™¨æŠŠé•œåƒä»harboræ‹‰ä¸‹æ¥,æ³¨æ„jenkinsæœºå™¨è¦å’Œwebå…å¯†</span></span><br><span class="line">ssh root@<span class="variable">$&#123;web_ip&#125;</span> <span class="string">&quot;docker pull <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:v1&quot;</span></span><br><span class="line"><span class="comment">#åˆ é™¤ä¹‹å‰æ—§çš„webé•œåƒ</span></span><br><span class="line">ssh root@<span class="variable">$&#123;web_ip&#125;</span> <span class="string">&quot;docker rm -f web&quot;</span></span><br><span class="line"><span class="comment">#åœ¨webæœåŠ¡å™¨éƒ¨ç½²nginxç½‘é¡µä»£ç </span></span><br><span class="line">ssh root@<span class="variable">$&#123;web_ip&#125;</span> <span class="string">&quot;docker run --name web -p 80:80 -d <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:v1&quot;</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240908230050715.png" alt="image-20240908230050715"></p><p><img src="../image/study_img/image-20240908230246558.png" alt="image-20240908230246558"></p><h3 id="5ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”å‚æ•°åŒ–æ„å»º"><strong>5ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”å‚æ•°åŒ–æ„å»º</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¬¬ä¸€ç‰ˆ</span><br><span class="line">[root@docker02 ~]# <span class="built_in">mkdir</span> /web</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cd</span> /web</span><br><span class="line">[root@docker02 web]# git init /web</span><br><span class="line">[root@docker02 web]# vim index.html</span><br><span class="line">[root@docker02 web]# vim src.js</span><br><span class="line">[root@docker02 web]# git add .</span><br><span class="line">[root@docker02 web]#  git config --global user.email <span class="string">&quot;you@example.com&quot;</span></span><br><span class="line">[root@docker02 web]# git config --global user.name <span class="string">&quot;Your Name&quot;</span></span><br><span class="line">[root@docker02 web]# git commit -m <span class="string">&#x27;å®˜ç½‘v1.0&#x27;</span></span><br><span class="line">[root@docker02 web]#  git tag -a <span class="string">&#x27;v1&#x27;</span>  -m <span class="string">&quot;å®˜ç½‘v1.0&quot;</span></span><br><span class="line">[root@docker02 web]# git remote add origin ssh://git@10.0.0.102:2222/root/web-website.git</span><br><span class="line">[root@docker02 web]# git push --all</span><br><span class="line">[root@docker02 web]# git push --tag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€ç¬¬äºŒç‰ˆ</span><br><span class="line">[root@docker02 web]# vim src.js</span><br><span class="line">[root@docker02 web]# git add .</span><br><span class="line">[root@docker02 web]# git commit -m <span class="string">&#x27;å®˜ç½‘v2.0&#x27;</span></span><br><span class="line">[root@docker02 web]# git tag -a <span class="string">&#x27;v2&#x27;</span>  -m <span class="string">&quot;å®˜ç½‘v2.0&quot;</span></span><br><span class="line">[root@docker02 web]# git push --all</span><br><span class="line">[root@docker02 web]# git push --tag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ä»£ç ä¸éœ€è¦è½¯è¿æ¥äº†ã€‚å·²ç»å®¹å™¨éƒ¨ç½²äº†ï¼Œä»£ç å¯ä»¥éšä¾¿åˆ é™¤</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240909172701792.png" alt="image-20240909172701792"></p><p><img src="../image/study_img/image-20240909224852871.png" alt="image-20240909224852871"></p><p><img src="../image/study_img/image-20240909224914742.png" alt="image-20240909224914742"></p><p><img src="../image/study_img/image-20240909224936189.png" alt="image-20240909224936189"></p><p><img src="../image/study_img/image-20240909225006620.png" alt="image-20240909225006620"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">harbor_ip=172.16.1.76</span><br><span class="line">project_name=<span class="string">&#x27;wordpress&#x27;</span></span><br><span class="line">pkg_name=<span class="string">&#x27;$&#123;harbor_ip&#125;/$&#123;project_name&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$&#123;WORKSPACE&#125;</span>/Dockerfile &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">FROM nginx:alpine</span></span><br><span class="line"><span class="string">#å°†ç½‘é¡µä»£ç å¤åˆ¶åˆ°nginxçš„ç«™ç‚¹ç›®å½•ä¸‹</span></span><br><span class="line"><span class="string">COPY ./* /usr/share/nginx/html/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿›å…¥å·¥ä½œç›®å½•æ„å»ºé•œåƒ</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;WORKSPACE&#125;</span> &amp;&amp; \</span><br><span class="line">docker build -t <span class="variable">$&#123;pkg_name&#125;</span>/web-frestlye:<span class="variable">$&#123;git_tag&#125;</span> .</span><br><span class="line"><span class="comment">#æ‰“å®Œé•œåƒåæ¨é€åˆ°Harborä»“åº“</span></span><br><span class="line">docker push <span class="variable">$pkg_name</span>&#125;/web-frestlye:<span class="variable">$&#123;git_tag&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">deploy</span></span> () &#123;</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="variable">$@</span> ;<span class="keyword">do</span></span><br><span class="line"><span class="comment">#è¿æ¥åˆ°webæœåŠ¡å™¨æŠŠé•œåƒä»harboræ‹‰ä¸‹æ¥,æ³¨æ„jenkinsæœºå™¨è¦å’Œwebå…å¯†</span></span><br><span class="line">ssh root@172.16.1.<span class="variable">$&#123;n&#125;</span> <span class="string">&quot;docker pull <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:<span class="variable">$&#123;git_tag&#125;</span>&quot;</span></span><br><span class="line"><span class="comment">#åˆ é™¤ä¹‹å‰æ—§çš„webé•œåƒ</span></span><br><span class="line">ssh root@172.16.1.<span class="variable">$&#123;n&#125;</span> <span class="string">&quot;docker rm -f web&quot;</span></span><br><span class="line"><span class="comment">#åœ¨webæœåŠ¡å™¨éƒ¨ç½²nginxç½‘é¡µä»£ç </span></span><br><span class="line">ssh root@172.16.1.<span class="variable">$&#123;n&#125;</span> <span class="string">&quot;docker run --name web -p 80:80 -d <span class="variable">$&#123;harbor_ip&#125;</span>/wordpress/web-frestlye:<span class="variable">$&#123;git_tag&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$env</span> <span class="keyword">in</span></span><br><span class="line">dev)</span><br><span class="line"><span class="comment">#ç»™å‡½æ•°ä¼ å‚æ•° ä¼ é€’æœºå™¨çš„ip</span></span><br><span class="line">   deploy 101</span><br><span class="line">   ;;</span><br><span class="line">prod)</span><br><span class="line">   deploy 103</span><br><span class="line">   ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240909225041225.png" alt="image-20240909225041225"></p><h3 id="6ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”MAVENé¡¹ç›®æ„å»º"><strong>6ã€jenkinså®¹å™¨æ„å»ºä»£ç ä¸Šçº¿â€”â€”MAVENé¡¹ç›®æ„å»º</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1ã€å“ªå°æœºå™¨éœ€è¦éƒ¨ç½²javaä»£ç ï¼Œåˆ°dockerå®˜ç½‘æ‹‰å–tomcat</span><br><span class="line">docker pull tomcat:alpine </span><br><span class="line">éœ€è¦å…ˆæ‰‹åŠ¨ç¼–è¯‘ä»£ç ï¼Œä¸‹è½½maven</span><br><span class="line">yum -y install maven</span><br><span class="line"></span><br><span class="line">2ã€ä¸‹è½½javaä»£ç helloword</span><br><span class="line"></span><br><span class="line">3ã€è¿è¡Œtmocat</span><br><span class="line">docker run -p 8080:8080 -d tomcat:alpine </span><br><span class="line"></span><br><span class="line">æ”¹Mavenæºã€‚æ¢æˆé˜¿é‡Œäº‘çš„æº</span><br><span class="line">vim</span><br><span class="line"></span><br><span class="line">æ„å»º  æ„å»ºå®Œæˆä¹‹åä¼šç”Ÿæˆä¸€ä¸ªtargetç›®å½•</span><br><span class="line">maven pakage</span><br><span class="line"><span class="built_in">cd</span> target/hellowrd</span><br><span class="line">tar zcf hello-1.0.0.tgz</span><br><span class="line"></span><br><span class="line">vim Dockerfile</span><br><span class="line">FROM tomcat:alpine </span><br><span class="line">RUN <span class="built_in">rm</span> -rf /usr/local/tomcat/webapps/ROOT/*</span><br><span class="line">ADD hello-1.0.0.tgz /usr/local/tomcat/webapps/ROOT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker build -t 172.16.1.76/wordpress/hello:v1 .</span><br><span class="line">docker run -p 8080:8080 -d 172.16.1.76/wordpress/hello:v1</span><br><span class="line"></span><br><span class="line">ç›®å‰è®¿é—®çš„æ—¶å€™è¦åŠ ä¸Šç›®å½•ï¼Œtomcatå‰é¢ä¼šåŠ ä¸Šnginxåšä»£ç†ï¼Œä»£ç†è¿™ä¸ªç›®å½•</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240909092954321.png" alt="image-20240909092954321"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#jenkinsæœºå™¨</span></span><br><span class="line">èµ·å®¿ä¸»æœºæŠŠmavenæ˜ å°„è¿›å»  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Jenkinsæ—¶åŒºä¸å¯¹ï¼Œå·®8ä¸ªå°æ—¶ï¼Œè§£å†³æ–¹æ¡ˆ</span><br><span class="line"><span class="comment"># è¿›å…¥å®¹å™¨</span></span><br><span class="line">docker <span class="built_in">exec</span> -it -u root jenkins bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹å®¹å™¨æ—¶åŒº</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">&#x27;Asia/Shanghai&#x27;</span> &gt; /etc/timezone</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¿®æ”¹åçš„å®¹å™¨æ—¶åŒº</span></span><br><span class="line"><span class="built_in">cat</span> /etc/timezone</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯jenkinså®¹å™¨</span></span><br><span class="line">docker restart jenkins</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¦‚æœè§‰å¾—Jenkinså ç”¨å†…å­˜è¿‡å¤§,æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸‹é¢çš„æ–¹å¼é™åˆ¶ienkinså ç”¨å†…å­˜å¤§å°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># dockeré™åˆ¶å†…å­˜å¤§å°</span></span><br><span class="line">docker update jenkins -m 3g --memory-swap -1</span><br><span class="line"></span><br><span class="line">--memory æˆ–-m é™åˆ¶å®¹å™¨çš„å†…å­˜ä½¿ç”¨é‡</span><br><span class="line">--memory-swap é™åˆ¶å†…å­˜å’Œswapçš„æ€»å’Œï¼Œä¸è®¾ç½®çš„è¯é»˜è®¤ä¸º--memoryçš„ä¸¤å€</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ä½¿ç”¨å®¹å™¨åŒ–çš„jenkinséƒ¨ç½²ä»£ç ï¼Œå¤šç§æ–¹æ³•ä»£ç ä¸Šçº¿</summary>
    
    
    
    <category term="docker" scheme="https://www.fomal.cc/categories/docker/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ¡äº”ã€Dockerçš„å›¾å½¢åŒ–Portainer</title>
    <link href="https://www.fomal.cc/posts/812941c2.html"/>
    <id>https://www.fomal.cc/posts/812941c2.html</id>
    <published>2024-09-22T05:20:28.000Z</published>
    <updated>2024-10-02T07:55:10.638Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Dockerçš„å›¾å½¢åŒ–Portainer">Dockerçš„å›¾å½¢åŒ–Portainer</h3><p>å¯åŠ¨Portainer     å¡æ³°äº†</p><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th></tr></thead><tbody><tr><td>elk1</td><td>10.0.0.76  /  172.16.1.76</td><td>å›¾å½¢åŒ–portainer</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@elk1 harbor]# docker run -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock --restart=always --name portainer portainer/portainer</span><br><span class="line"></span><br><span class="line">2ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">http://10.0.0.76:9000/</span><br><span class="line"></span><br><span class="line">3ã€ç™»å½•è¿›å»å¯èƒ½å›æç¤ºportainerè¶…æ—¶ï¼Œéœ€è¦é‡å¯</span><br><span class="line">[root@elk1 harbor]# docker restart  portainer</span><br><span class="line">portainer</span><br><span class="line"></span><br><span class="line">4ã€é‡å¯ä¹‹åå†è®¿é—®é¡µé¢ï¼Œè¿›å»åˆ·æ–°ï¼Œè®¾ç½®åˆå§‹å¯†ç  12ä½çš„</span><br><span class="line">aaaaaa111111</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240906175708573.png" alt="image-20240906175708573"></p><p>5ã€æŸ¥çœ‹æœ¬åœ°çš„docker</p><p><img src="../image/study_img/image-20240906175929805.png" alt="image-20240906175929805"></p><p><img src="../image/study_img/image-20240906180028688.png" alt="image-20240906180028688"></p><p>æ­¤å¤„å¯ä»¥å¯åŠ¨å®¹å™¨</p><p><img src="../image/study_img/image-20240906180212414.png" alt="image-20240906180212414"></p><p>6ã€æµ‹è¯•æ‹‰å–ä¸€ä¸ªé•œåƒå¹¶å¯åŠ¨</p><p><img src="../image/study_img/image-20240906180900453.png" alt="image-20240906180900453"></p><p><img src="../image/study_img/image-20240906180924462.png" alt="image-20240906180924462"></p><p>ç­‰å¾…ä¸€ä¼šï¼Œæ˜¾ç¤ºæ‹‰å–é•œåƒå¹¶å¯åŠ¨æˆåŠŸï¼Œè·³è½¬åˆ°å®¹å™¨å¯åŠ¨çš„é¡µé¢ï¼Œå¹¶ä¸”åœ¨å‘½ä»¤è¡Œä¸»å¯ä»¥æŸ¥çœ‹åˆ°å·²æ‹‰å–æˆåŠŸï¼Œå¯åŠ¨æˆåŠŸ</p><p><img src="../image/study_img/image-20240906181242551.png" alt="image-20240906181242551"></p><p><img src="../image/study_img/image-20240906181309969.png" alt="image-20240906181309969"></p><p>7ã€æŸ¥çœ‹æ‰€æœ‰é•œåƒ</p><p><img src="../image/study_img/image-20240906181607353.png" alt="image-20240906181607353"></p><p>8ã€æµ‹è¯•æ‹‰å–é•œåƒ</p><p><img src="../image/study_img/image-20240906181951743.png" alt="image-20240906181951743"></p><p>9ã€æŒ‚è½½ç›®å½•çš„é¡µé¢</p><p><img src="../image/study_img/image-20240906182154901.png" alt="image-20240906182154901"></p><p>10ã€äº‹ä»¶çš„æŸ¥çœ‹ï¼Œå“ªä¸ªå®¹å™¨é€€å‡ºäº†ï¼ŒæŸ¥çœ‹æ—¥å¿—</p><p><img src="../image/study_img/image-20240906182246878.png" alt="image-20240906182246878"></p><p>12ã€æŸ¥çœ‹ç‰©ç†æœºçš„ä¿¡æ¯</p><p><img src="../image/study_img/image-20240906182322538.png" alt="image-20240906182322538"></p><p>13ã€æ·»åŠ è‡ªå·±çš„é•œåƒä»“åº“ã€‚æ‹‰å–å®¹å™¨çš„æ—¶å€™å°±å»è‡ªå·±åˆ›å»ºçš„ä»“åº“é‡Œé¢æ‹‰å–</p><p><img src="../image/study_img/image-20240906182455490.png" alt="image-20240906182455490"></p><p><img src="../image/study_img/image-20240906182652673.png" alt="image-20240906182652673"></p><p>æ·»åŠ ä¹‹åï¼Œå¦‚æœæƒ³æ‹‰å–è‡ªå·±ä»“åº“é‡Œé¢çš„å®¹å™¨ï¼Œå°±è¿™æ ·é€‰æ‹©</p><p><img src="../image/study_img/image-20240906182823018.png" alt="image-20240906182823018"></p><p>æ‹‰å–harboré‡Œé¢çš„å®¹å™¨</p><p><img src="../image/study_img/image-20240906182929405.png" alt="image-20240906182929405"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#portaineréœ€è¦ä¿¡ä»»harborçš„åœ°å€</span></span><br><span class="line">[root@elk1 harbor]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>, <span class="string">&quot;https://hub.rat.dev/&quot;</span>, <span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>],</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.76&quot;</span>,<span class="string">&quot;http://172.16.1.101:5000&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@elk1 harbor]# systemctl restart docker</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240906183541971.png" alt="image-20240906183541971"></p><p>14ã€ç®¡ç†docker01 ~ 03æœºå™¨çš„é•œåƒ</p><p><img src="../image/study_img/image-20240906183926754.png" alt="image-20240906183926754"></p><p><img src="../image/study_img/image-20240906184008628.png" alt="image-20240906184008628"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åœ¨æƒ³è¦ç®¡ç†çš„dockeræœºå™¨æ‰§è¡Œè¿™ä¸ªå‘½ä»¤</span></span><br><span class="line">docker run -d \</span><br><span class="line">  -p 9001:9001 \</span><br><span class="line">  --name portainer_agent \</span><br><span class="line">  --restart=always \</span><br><span class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  -v /var/lib/docker/volumes:/var/lib/docker/volumes \</span><br><span class="line">  portainer/agent:2.16.2</span><br><span class="line">  </span><br><span class="line"><span class="comment">#é‡å¯docker</span></span><br><span class="line">  systemctl restart docker</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240906185043251.png" alt="image-20240906185043251"></p><p><img src="../image/study_img/image-20240906185302712.png" alt="image-20240906185302712"></p>]]></content>
    
    
    <summary type="html">éƒ¨ç½²Dockerçš„å›¾å½¢åŒ–Portainer</summary>
    
    
    
    <category term="docker" scheme="https://www.fomal.cc/categories/docker/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ¡å››ã€dockerçš„ç½‘ç»œä¸Harboré•œåƒä»“åº“</title>
    <link href="https://www.fomal.cc/posts/5c6d7d69.html"/>
    <id>https://www.fomal.cc/posts/5c6d7d69.html</id>
    <published>2024-09-22T05:07:23.000Z</published>
    <updated>2024-10-02T07:55:03.510Z</updated>
    
    <content type="html"><![CDATA[<h2 id="dockerçš„ç½‘ç»œä¸Harboré•œåƒä»“åº“">dockerçš„ç½‘ç»œä¸Harboré•œåƒä»“åº“</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">101ä¸Šèµ·çš„å®¹å™¨å’Œ103ä¸Šèµ·çš„å®¹å™¨ä¸èƒ½é€šä¿¡</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å®¹å™¨çš„ip</span></span><br><span class="line"><span class="comment">#101èµ·centos</span></span><br><span class="line">[root@docker01 ~]# docker run --<span class="built_in">link</span> mysql80 -it centos:7 /bin/bash</span><br><span class="line">[root@56db98b318bb /]# ping mysql80</span><br><span class="line">PING mysql80 (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from mysql80 (172.17.0.2): icmp_seq=1 ttl=64 time=0.271 ms</span><br><span class="line"></span><br><span class="line">mysql80å®¹å™¨çš„ipæ˜¯ï¼š172.17.0.2</span><br><span class="line"></span><br><span class="line"><span class="comment">#102èµ·centos</span></span><br><span class="line">[root@bdc4ac174cb6 /]# ping 172.17.0.2</span><br><span class="line">PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">å¯ä»¥å‘ç°æ˜¯pingä¸é€šçš„ï¼Œå¦‚æœå¼€å¯å†…æ ¸è½¬ï¼Œå°±å¯ä»¥é€šä¿¡ï¼ŒAè™šæ‹Ÿæœºé‡Œé¢èµ·çš„å®¹å™¨å°±ä¸Bè™šæ‹Ÿæœºå¯ä»¥é€šä¿¡</span><br></pre></td></tr></table></figure><h3 id="1ã€Bridgeæ¡¥æ¥æ¨¡å¼-docker-é»˜è®¤çš„ç½‘ç»œæ¨¡å¼"><strong>1ã€Bridgeæ¡¥æ¥æ¨¡å¼  (docker é»˜è®¤çš„ç½‘ç»œæ¨¡å¼)</strong></h3><p>Bridgeï¼šDockerè®¾è®¡çš„NATç½‘ç»œæ¨¡å‹ é»˜è®¤ç±»å‹ï¼Œç±»ä¼¼äºè™šæ‹Ÿæœºé‡Œé¢çš„NATæ¨¡å¼</p><p><img src="../image/study_img/image-20240905150011381.png" alt="image-20240905150011381"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">ä½ çš„å®¹å™¨æ¡¥æ¥åˆ°docker0é‚£ä¸ªç½‘å¡ï¼Œå®¹å™¨çš„ç½‘å¡å’Œdocker0é‚£ä¸ªç½‘å¡åœ¨åŒä¸€ç½‘æ®µ</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å½“å‰è™šæ‹Ÿæœºçš„ç½‘ç»œç±»å‹</span></span><br><span class="line">[root@docker02 ~]# docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">870935df49b1   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">a7fce1fe694d   host      host      <span class="built_in">local</span></span><br><span class="line">d7fe2c2b78e7   none      null      <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ¡¥æ¥æ¨¡å¼çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">[root@docker01 ~]# docker network inspect bridge</span><br><span class="line"></span><br><span class="line"><span class="comment">## å®‰è£…bridge-utils æŸ¥çœ‹</span></span><br><span class="line">[root@docker01 ~]# brctl show</span><br><span class="line">bridge name bridge <span class="built_in">id</span> STP enabled interfaces</span><br><span class="line">docker0 8000.0242eca7bc4c no</span><br><span class="line"></span><br><span class="line"><span class="comment">#è°ƒè¯•ç½‘ç»œä¸“ç”¨é•œåƒ</span></span><br><span class="line">[root@docker01 ~]# docker run -it -d  busybox  /bin/sh</span><br><span class="line"></span><br><span class="line">å…¬å¸æœ‰è§„å®š å†…ç½‘çš„ipè§„å®š192æˆ–è€…168çš„ç½‘æ®µ</span><br><span class="line"><span class="comment">#ä¿®æ”¹æ¡¥æ¥æ¨¡å¼çš„ç½‘æ®µ</span></span><br><span class="line">æ–¹æ³•1ï¼šä¿®æ”¹dockerçš„å¯åŠ¨è„šæœ¬</span><br><span class="line">[root@docker01 ~]# vim /lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line">--bip=192.168.10.1/24</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# systemctl daemon-reload</span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0 Link encap:Ethernet HWaddr 02:42:C0:A8:0A:03</span><br><span class="line">     inet addr:192.168.10.3 Bcast:192.168.10.255 Mask:255.255.255.0</span><br><span class="line">     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">     RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">     TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">     collisions:0 txqueuelen:0</span><br><span class="line">     RX bytes:656 (656.0 B) TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">[root@docker02 ~]# docker run -it busybox /bin/sh</span><br><span class="line"><span class="comment">#è¿™ä¸ªæ˜¯ä¸“é—¨çš„ç½‘ç»œå·¥å…·ï¼Œç½‘ç»œç›¸å…³çš„å‘½ä»¤éƒ½æ”¯æŒ</span></span><br><span class="line"></span><br><span class="line">æ–¹æ³•2ï¼šä¿®æ”¹dockerçš„é…ç½®æ–‡ä»¶</span><br><span class="line">[root@docker01 ~]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;bip&quot;</span>: <span class="string">&quot;192.168.30.1/24&quot;</span>,</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>,<span class="string">&quot;https://hub.rat.dev/&quot;</span>,</span><br><span class="line"><span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">## æˆ–è€…</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>,<span class="string">&quot;https://hub.rat.dev/&quot;</span>,</span><br><span class="line"><span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>],</span><br><span class="line"><span class="string">&quot;bip&quot;</span>: <span class="string">&quot;192.168.30.1/24&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# systemctl daemon-reload</span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line">[root@docker01 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0 Link encap:Ethernet HWaddr 02:42:C0:A8:14:03</span><br><span class="line">     inet addr:192.168.20.3 Bcast:192.168.20.255 Mask:255.255.255.0</span><br><span class="line">     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">     RX packets:6 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">     TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">     collisions:0 txqueuelen:0</span><br><span class="line">     RX bytes:516 (516.0 B) TX bytes:0 (0.0 B)</span><br><span class="line">     </span><br><span class="line">è¿™æ ·å­å°±å¯ä»¥å®šä¹‰å®¹å™¨çš„ç½‘æ®µäº†</span><br></pre></td></tr></table></figure><h3 id="2ã€Hostæ¨¡å¼">**2ã€Hostæ¨¡å¼   **</h3><p>hostï¼šä¸å®¿ä¸»æœºå…±äº«Network Namespaceï¼Œâ€“network=host æ€§èƒ½æœ€é«˜</p><p><img src="../image/study_img/image-20240905151204236.png" alt="image-20240905151204236"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# docker run --network=host -d nginx:alpine</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker run -it --network=host nginx:alpine /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">docker0 Link encap:Ethernet HWaddr 02:42:77:C6:BE:B9</span><br><span class="line">        inet addr:192.168.20.1 Bcast:192.168.20.255 Mask:255.255.255.0</span><br><span class="line">        inet6 addr: fe80::42:77ff:fec6:beb9/64 Scope:Link</span><br><span class="line">        UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">        RX packets:3150 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">        TX packets:2794 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">        collisions:0 txqueuelen:0</span><br><span class="line">        RX bytes:7792958 (7.4 MiB) TX bytes:1119887 (1.0 MiB)</span><br><span class="line"></span><br><span class="line">eth0    Link encap:Ethernet HWaddr 00:0C:29:1A:2F:80</span><br><span class="line">        inet addr:10.0.0.101 Bcast:10.0.0.255 Mask:255.255.255.0</span><br><span class="line">        inet6 addr: fe80::20c:29ff:fe1a:2f80/64 Scope:Link</span><br><span class="line"></span><br><span class="line">å’Œä¸»æœºå…±äº«ç½‘å¡çš„æ¨¡å¼ï¼Œä¸€èˆ¬èµ·å®¹å™¨ä¸ä¼šç”¨åˆ°è¿™ä¸ªæ¨¡å¼</span><br></pre></td></tr></table></figure><h3 id="3ã€containeræ¨¡å¼"><strong>3ã€containeræ¨¡å¼</strong></h3><p>Containerï¼šä¸å¦ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨å…±äº«Network Namespaceï¼Œâ€“net=container:containerIDï¼ˆK8Sï¼‰</p><p><img src="../image/study_img/image-20240905114345031.png" alt="image-20240905114345031"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# docker run -it busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0 Link encap:Ethernet HWaddr 02:42:C0:A8:14:03</span><br><span class="line">     inet addr:192.168.20.3 Bcast:192.168.20.255 Mask:255.255.255.0</span><br><span class="line">     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">     RX packets:6 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">     TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">     collisions:0 txqueuelen:0</span><br><span class="line">     RX bytes:516 (516.0 B) TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker run -it --network=container:763cd9e2da94 centos:7 /bin/bash</span><br><span class="line">[root@docker01 ~]# docker run -it --network=container:763cd9e2da94 nginx:alpine /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0 Link encap:Ethernet HWaddr 02:42:C0:A8:14:03</span><br><span class="line">     inet addr:192.168.20.3 Bcast:192.168.20.255 Mask:255.255.255.0</span><br><span class="line">     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">     RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">     TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">     collisions:0 txqueuelen:0</span><br><span class="line">     RX bytes:656 (656.0 B) TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure><h3 id="4ã€Noneæ¨¡å¼"><strong>4ã€Noneæ¨¡å¼</strong></h3><p>None:ä¸ä¸ºå®¢å™¨é…ç½®ä»»ä½•ç½‘ç»œåŠŸèƒ½ï¼Œâ€“net=none   æ²¡æœ‰ç½‘ç»œçš„æ¨¡å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å¯åŠ¨çš„æ—¶å€™æŒ‡å®š  </span><br><span class="line">[root@docker01 ~]# docker run -it --network=none busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">lo   Link encap:Local Loopback</span><br><span class="line">     inet addr:127.0.0.1 Mask:255.0.0.0</span><br><span class="line">     inet6 addr: ::1/128 Scope:Host</span><br><span class="line">     UP LOOPBACK RUNNING MTU:65536 Metric:1</span><br><span class="line">     RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">     TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">     collisions:0 txqueuelen:1000</span><br><span class="line">     RX bytes:0 (0.0 B) TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905113318250.png" alt="image-20240905113318250"></p><h3 id="5ã€Dockerè‡ªå®šä¹‰ç½‘ç»œæ¨¡å¼"><strong>5ã€Dockerè‡ªå®šä¹‰ç½‘ç»œæ¨¡å¼</strong></h3><p>åŸºäºä»¥ä¸Š4ç§æ¨¡å¼åˆ›å»ºç½‘ç»œ</p><p><img src="../image/study_img/image-20240905113509543.png" alt="image-20240905113509543"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è‡ªå®šä¹‰ç½‘ç»œ</span></span><br><span class="line">docker network create -d &lt;mode&gt; --subnet &lt;CIDR&gt; --gateway &lt;ç½‘å…³&gt; &lt;è‡ªå®šä¹‰ç½‘è·¯åç§°&gt;</span><br><span class="line">åˆ›å»º</span><br><span class="line">docker network create -d bridge --subnet 192.168.100.0/24 --gateway 192.168.100.1 abc-net</span><br><span class="line"></span><br><span class="line"><span class="comment">## å¼•ç”¨è‡ªå®šä¹‰ç½‘ç»œ</span></span><br><span class="line">[root@docker01 ~]# docker run -it --network=abc-net busybox /bin/sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å°±ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªäº¤æ¢æœº</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è‡ªå®šä¹‰ç½‘ç»œ</span></span><br><span class="line">[root@docker01 ~]# docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID NAME DRIVER SCOPE</span><br><span class="line">2b0a232f6643 bridge bridge <span class="built_in">local</span></span><br><span class="line">168f91213e19 host host <span class="built_in">local</span></span><br><span class="line">4de4c2edcb74 none null <span class="built_in">local</span></span><br><span class="line">7a7b8742e475 abc-net bridge <span class="built_in">local</span></span><br><span class="line">[root@docker01 ~]# docker network <span class="built_in">rm</span> abc-net</span><br><span class="line">abc-net</span><br><span class="line">[root@docker01 ~]# docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID NAME DRIVER SCOPE</span><br><span class="line">2b0a232f6643 bridge bridge <span class="built_in">local</span></span><br><span class="line">168f91213e19 host host <span class="built_in">local</span></span><br><span class="line">4de4c2edcb74 none null <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">åˆ›å»ºäº†ç½‘ç»œå°±åˆ›å»ºäº†ä¸€ä¸ªæ¡¥æ¥çš„ç½‘å¡ï¼Œç›¸å½“äºä¸€ä¸ªç½‘å¡å°±æ˜¯ä¸€ä¸ªäº¤æ¢æœº</span><br><span class="line">dockeré»˜è®¤å°±æ˜¯bridgeæ¨¡å¼ï¼Œå½“æœ‰ä¸åŒçš„Â·é¡¹ç›®å°±è¦è‡ªå·±åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼ŒæŠŠä¸åŒé¡¹ç›®çš„ä¸»æœºæ”¾åˆ°è¿™ä¸ªæ¨¡å¼é‡Œé¢</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905113639559.png" alt="image-20240905113639559"></p><h3 id="6ã€Dockerç§æœ‰åˆ›å»ºHarbor">6ã€<strong>Dockerç§æœ‰åˆ›å»ºHarbor</strong></h3><p>Harbor æ˜¯ä¸ºä¼ä¸šç”¨æˆ·è®¾è®¡çš„å®¹å™¨é•œåƒä»“åº“å¼€æºé¡¹ç›®ï¼ŒåŒ…æ‹¬äº†æƒé™ç®¡ç†(RBAC)ã€+DAPã€å®¡è®¡ã€å®‰å…¨æ¼æ´æ‰«æã€é•œåƒéªŒçœŸã€ç®¡ç†ç•Œé¢ã€è‡ªæˆ‘æ³¨å†Œã€HA ç­‰ä¼ä¸šå¿…éœ€çš„åŠŸèƒ½ï¼ŒåŒæ—¶é’ˆå¯¹ä¸­å›½ç”¨æˆ·çš„ç‰¹ç‚¹ï¼Œè®¾è®¡é•œåƒå¤åˆ¶å’Œä¸­æ–‡æ”¯æŒç­‰åŠŸèˆ±   <a href="https://goharbor.io/">https://goharbor.io/</a></p><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th></tr></thead><tbody><tr><td>elk1</td><td>10.0.0.76  /  172.16.1.76</td><td>Harborå›¾å½¢åŒ–ä»“åº“</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">harbor å›¾å½¢åŒ–ç•Œé¢çš„  https://goharbor.io/</span><br><span class="line">registry å‘½ä»¤è¡Œæ“ä½œçš„</span><br><span class="line"></span><br><span class="line">ä¸‹è½½harborå¸¦offlineæ ‡ç­¾çš„ï¼Œæ‰€æœ‰çš„é•œåƒï¼Œå®‰è£…åŒ…é‡Œé¢éƒ½åœ¨ä¸€èµ·çš„æ‰€ä»¥æ¯”è¾ƒå¤§</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€#å®‰è£…dockerç¯å¢ƒ</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">sed -i <span class="string">&quot;s@http://mirrors.aliyun.com@https://mirrors.huaweicloud.com@g&quot;</span> /etc/yum.repos.d/epel.repo</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/docker-ce.repo &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[docker-ce-stable]</span></span><br><span class="line"><span class="string">name=Docker CE Stable - $basearch</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.huaweicloud.com/docker-ce/linux/centos/7/x86_64/stable</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.huaweicloud.com/docker-ce/linux/centos/gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sed -i <span class="string">&#x27;s+download.docker.com+mirrors.huaweicloud.com/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">yum install -y docker-ce docker-ce-cli containerd.io</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;ï¼š[&quot;https://docker.1panel.live&quot;,&quot;https://hub.rat.dev/&quot;,&quot;https://docker.chenby.cn&quot;, &quot;https://docker.m.daocloud.io&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.ä¸‹è½½harbor</span><br><span class="line">[root@harbor ~]# wget https://github.com/goharbor/harbor/releases/download/v2.11.1/harbor-offline-installer-v2.11.1.tgz</span><br><span class="line"></span><br><span class="line"> 3.è§£å‹</span><br><span class="line">[root@harbor ~]# tar xf harbor-offline-installer-v2.11.1.tgz </span><br><span class="line"></span><br><span class="line">4.è¿›å…¥harborç›®å½•</span><br><span class="line">[root@harbor harbor]# <span class="built_in">cd</span> /root/harbor/</span><br><span class="line">[root@elk1 harbor]# ll</span><br><span class="line">total 646848</span><br><span class="line">-rw-r--r-- 1 root root      3646 Aug 15 18:07 common.sh</span><br><span class="line">-rw-r--r-- 1 root root 662330539 Aug 15 18:07 harbor.v2.11.1.tar.gz#harborçš„æ‰€æœ‰é•œåƒ</span><br><span class="line">-rw-r--r-- 1 root root     14270 Aug 15 18:07 harbor.yml.tmpl</span><br><span class="line">-rwxr-xr-x 1 root root      1975 Aug 15 18:07 install.sh</span><br><span class="line">-rw-r--r-- 1 root root     11347 Aug 15 18:07 LICENSE</span><br><span class="line">-rwxr-xr-x 1 root root      1882 Aug 15 18:07 prepare</span><br><span class="line"></span><br><span class="line">5.æ”¹é…ç½®æ–‡ä»¶å</span><br><span class="line">[root@harbor harbor]# <span class="built_in">cp</span> /root/harbor/harbor.yml.tmpl /root/harbor/harbor.yml</span><br><span class="line"></span><br><span class="line">6.ä¿®æ”¹é…ç½®æ–‡ä»¶ (æ³¨é‡ŠHTTPSçš„é…ç½®)</span><br><span class="line">[root@harbor harbor]# vim harbor.yml</span><br><span class="line">ç¬¬5è¡Œ æ”¹æˆå½“å‰ä¸»æœºçš„ip</span><br><span class="line">hostname: 10.0.0.105</span><br><span class="line">47è¡Œï¼šå…ˆè®°å½•harborçš„å¯†ç </span><br><span class="line">harbor_admin_password: Harbor12345</span><br><span class="line"></span><br><span class="line">7.æ‰§è¡Œå®‰è£…è„šæœ¬</span><br><span class="line">[root@harbor harbor]# ./install.sh</span><br><span class="line">âœ” ----Harbor has been installed and started successfully.----#å‡ºç°è¿™ä¸ªå°±å®‰è£…æˆåŠŸ</span><br><span class="line"></span><br><span class="line">[root@harbor harbor]# docker images</span><br><span class="line">ä¼šçœ‹åˆ°harborè‡ªåŠ¨å®‰è£…çš„é•œåƒ</span><br><span class="line">[root@harbor harbor]# netstat -lntup</span><br><span class="line">ä¼šçœ‹åˆ°80ç«¯å£</span><br><span class="line"></span><br><span class="line">8ã€æµè§ˆå™¨è®¿é—®å½“å‰ä¸»æœºçš„IP</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905171032747.png" alt="image-20240905171032747"></p><p>1ã€åˆ›å»ºé¡¹ç›®     -1 å°±æ˜¯æ— é™å¤§</p><p><img src="../image/study_img/image-20240905171320050.png" alt="image-20240905171320050"></p><p>2ã€ä¸Šä¼ é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¸Šä¼ é•œåƒçš„éœ€æ±‚</span></span><br><span class="line">éœ€è¦ä¿®æ”¹é•œåƒåç§°ï¼šå‘½åè§„åˆ™</span><br><span class="line">harborçš„IPåœ°å€/é¡¹ç›®åç§°/é•œåƒåç§°:æ ‡ç­¾</span><br><span class="line"></span><br><span class="line">1ã€å°†é•œåƒé‡æ–°å‘½å</span><br><span class="line">[root@docker02 ~]# docker tag wordpress:v7 10.0.0.76/wordpress/wordpress:v7</span><br><span class="line"></span><br><span class="line">2ã€æ¨é€é•œåƒ  æŠ¥é”™</span><br><span class="line">[root@docker02 ~]# docker push 10.0.0.76/wordpress/wordpress:v7</span><br><span class="line">The push refers to repository [10.0.0.76/wordpress/wordpress]</span><br><span class="line">Get <span class="string">&quot;https://10.0.0.76/v2/&quot;</span>: dial tcp 10.0.0.76:443: connect: connection refused</span><br><span class="line">åŸå› æ˜¯æ²¡æœ‰ä¿¡ä»»ä¸å®‰å…¨çš„è¿æ¥</span><br><span class="line"></span><br><span class="line">3ã€ä¿®æ”¹dockeré…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ä¿¡ä»»ä¸å®‰å…¨çš„é•œåƒä»“åº“é…ç½®</span><br><span class="line">[root@docker02 ~]# vim /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>, <span class="string">&quot;https://hub.rat.dev/&quot;</span>, <span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>],</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.76&quot;</span>]#å°±æ˜¯åŠ è¿™ä¸ªé…ç½®ï¼Œæ³¨æ„ï¼Œéœ€è¦åœ¨ä¸Šä¸€è¡Œç»“æŸä½ç½®åŠ ,é€—å·</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">é‡å¯docker</span><br><span class="line">[root@docker02 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">4ã€å†æ¬¡æ¨é€ æŠ¥é”™</span><br><span class="line">[root@docker02 ~]# docker push 10.0.0.76/wordpress/wordpress:v7</span><br><span class="line">unauthorized: unauthorized to access repository: wordpress/wordpress, action: push: unauthorized to access repository: wordpress/wordpress, action: push</span><br><span class="line">ä»“åº“æ²¡æœ‰åšè®¤è¯</span><br><span class="line"></span><br><span class="line">5ã€å‘½ä»¤è¡Œç™»å½•Harborè¿›è¡Œè®¤è¯</span><br><span class="line">[root@docker02 ~]# docker login 10.0.0.76</span><br><span class="line">Username: admin</span><br><span class="line">Password:  <span class="comment">#å¯†ç ï¼šHarbor12345</span></span><br><span class="line">......</span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">6ã€è¿™æ¬¡æ¨é€é•œåƒæˆåŠŸï¼Œè¿›å…¥webé¡µé¢ï¼Œåˆ·æ–°ä¸€ä¸‹æŸ¥çœ‹</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905173214933.png" alt="image-20240905173214933"></p><p><img src="../image/study_img/image-20240905173246328.png" alt="image-20240905173246328"></p><p><img src="../image/study_img/image-20240905173324730.png" alt="image-20240905173324730"></p><p>3ã€ä¸‹è½½Harborä»“åº“é‡Œé¢çš„é•œåƒ</p><p><img src="../image/study_img/image-20240905181051876.png" alt="image-20240905181051876"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨10.0.0.101ä¸‹è½½é•œåƒ</span><br><span class="line"><span class="comment">#10.0.0.101æ“ä½œå¦‚ä¸‹</span></span><br><span class="line">1ã€ä¿®æ”¹dockeré…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ä¿¡ä»»ä¸å®‰å…¨çš„é•œåƒä»“åº“é…ç½®</span><br><span class="line">[root@docker01 ~]# vim /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>, <span class="string">&quot;https://hub.rat.dev/&quot;</span>, <span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>],</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.76&quot;</span>]#å°±æ˜¯åŠ è¿™ä¸ªé…ç½®ï¼Œæ³¨æ„ï¼Œéœ€è¦åœ¨ä¸Šä¸€è¡Œç»“æŸä½ç½®åŠ ,é€—å·</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">2ã€ç™»å½•harbor</span><br><span class="line">[root@docker01 ~]# docker login 10.0.0.76</span><br><span class="line">Username: admin</span><br><span class="line">Password:  <span class="comment">#å¯†ç ï¼šHarbor12345</span></span><br><span class="line">......</span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">3ã€ä¸‹è½½é•œåƒ</span><br><span class="line">[root@docker01 ~]# docker pull 10.0.0.76/wordpress/wordpress@sha256:c23f172bdd40059652c0a45affd4c0d1740fa8578c56e0209316e43516560050</span><br><span class="line">æˆ–è€…</span><br><span class="line">[root@docker01 ~]# docker pull 10.0.0.76/wordpress/wordpress:v7</span><br></pre></td></tr></table></figure><h3 id="7ã€é•œåƒä»“åº“registry">7ã€<strong>é•œåƒä»“åº“registry</strong></h3><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th></tr></thead><tbody><tr><td>docker01</td><td>10.0.0.101  /  172.16.1.101</td><td>registryå‘½ä»¤è¡Œä»“åº“</td></tr></tbody></table><p>1ã€ä½¿ç”¨10.0.0.101åœ°å€çš„æœºå™¨æ­å»ºä»“åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ­å»ºä»“åº“</span><br><span class="line">[root@docker01 ~]# docker run -d -p 5000:5000 --restart=always --name registry -v /opt/myregistry:/var/lib/registry registry</span><br><span class="line"></span><br><span class="line">[root@docker01 wordpress]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS         PORTS                                                  NAMES</span><br><span class="line">356673cd10da   registry          <span class="string">&quot;/entrypoint.sh /etcâ€¦&quot;</span>   11 seconds ago   Up 9 seconds   0.0.0.0:5000-&gt;5000/tcp, :::5000-&gt;5000/tcp              registry</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™ä¸ªæ˜¯httpçš„80ç«¯å£ï¼Œä¸€èˆ¬åœ¨ä¼ä¸šä¸­ï¼Œä¼šåœ¨ä»–å‰é¢åŠ nginxä»£ç†ï¼Œç”¨nginx80ä»£ç†ä»–çš„5000ç«¯å£ï¼Œnginxä¸Šé…ç½®åŸŸåæˆ–è€…ip</span></span><br><span class="line">regsitryåšé›†ç¾¤å¯ä»¥æŒ‚è½½è¿™ä¸ªç›®å½•/opt/myregistry/docker/registry/v2/repositories/</span><br><span class="line"></span><br><span class="line">Harborï¼šä»–æœ¬æ¥å°±æ˜¯http,å¦‚æœæƒ³ç»™harboråšé›†ç¾¤,å¯ä»¥å¤šèµ·å‡ ä¸ªharbor,å‰é¢åŠ ä¸ªè´Ÿè½½å‡è¡¡ï¼Œè™½ç„¶æ•°æ®ä¸æ˜¯ç»Ÿä¸€çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨NFSæŒ‚è½½ï¼Œnginxè´Ÿè½½å‡è¡¡å¯ä»¥è§£å†³æ•°æ®ç»Ÿä¸€çš„é—®é¢˜ï¼Œä¸€å°ä¸Šé¢å®‰è£…rsyncï¼Œå…¶ä»–2å°å®æ—¶åŒæ­¥ä¹Ÿå¯ä»¥ï¼Œæ‰€æœ‰æœºå™¨éƒ½è¦å®‰è£…rsync,seysync</span><br><span class="line"></span><br><span class="line">registryå¯ä»¥ä½¿ç”¨nginxä»£ç†</span><br><span class="line">haborä¸å¯ä»¥ä½¿ç”¨nginxä»£ç†</span><br></pre></td></tr></table></figure><p>2ã€ä¸Šä¼ é•œåƒåˆ°ä»“åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç»™é•œåƒæ‰“tagæ ‡ç­¾ï¼Œè¦å†™å…¨ä»“åº“åœ°å€    åœ°å€:ç«¯å£/é•œåƒå:ç‰ˆæœ¬å·</span><br><span class="line">[root@docker02 ~]# docker tag wordpress-manual:v1 172.16.1.101:5000/wordpress-manual:v1</span><br><span class="line">[root@docker02 ~]# docker tag nginx:alpine 172.16.1.101:5000/nginx:alpine</span><br><span class="line">[root@docker02 ~]# docker tag busybox:latest  172.16.1.101:5000/busybox:latest</span><br><span class="line"></span><br><span class="line">2ã€å…¶ä»–æœºå™¨éœ€è¦å°†ä»£ç ä¸Šä¼ åˆ°ä»“åº“çš„æœºå™¨é…ç½®æ–‡ä»¶ï¼Œæ”¹æœºå™¨å°±è¦ä¿¡ä»»ä»“åº“åœ°å€</span><br><span class="line">[root@docker03 ~]# vim /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.1panel.live&quot;</span>, <span class="string">&quot;https://hub.rat.dev/&quot;</span>, <span class="string">&quot;https://docker.chenby.cn&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>],</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.76&quot;</span>,<span class="string">&quot;http://172.16.1.101:5000&quot;</span>]#å°±æ˜¯åŠ è¿™ä¸ªé…ç½®ï¼Œæ³¨æ„ï¼Œéœ€è¦åœ¨ä¸Šä¸€è¡Œç»“æŸä½ç½®åŠ ,é€—å·ï¼Œåœ°å€å†™å†…å¤–æ¨é€ä¼šæ¯”è¾ƒå¿«ï¼Œå¦‚æœå†™å†…å¤–ï¼Œå‘½åå°±è¦ç”¨å†…å¤–å‘½å</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">3ã€é‡å¯Docker</span><br><span class="line">[root@docker03 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">4ã€æ¨é€é•œåƒ</span><br><span class="line">[root@docker02 ~]# docker push 172.16.1.101:5000/wordpress-manual:v1</span><br><span class="line">[root@docker02 ~]# docker push 172.16.1.101:5000/nginx:alpine</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3ã€æŸ¥çœ‹ç§æœ‰æŸ¥çœ‹é•œåƒåˆ—è¡¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1ã€éšä¾¿åœ¨å“ªå°æœºå™¨æŸ¥çœ‹éƒ½è¡Œï¼Œåªè¦å’ŒregistreæŸ¥çœ‹çš„æœºå™¨é€šï¼ŒæŸ¥çœ‹æ‰€æœ‰é•œåƒä»“åº“</span><br><span class="line">[root@docker02 ~]# curl http://172.16.1.101:5000/v2/_catalog</span><br><span class="line">&#123;<span class="string">&quot;repositories&quot;</span>:[<span class="string">&quot;busybox&quot;</span>,<span class="string">&quot;nginx&quot;</span>,<span class="string">&quot;wordpress-manual&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹æŒ‡å®šä»“åº“çš„tagæ ‡ç­¾</span><br><span class="line">[root@docker02 ~]# curl http://172.16.1.101:5000/v2/nginx/tags/list</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;nginx&quot;</span>,<span class="string">&quot;tags&quot;</span>:[<span class="string">&quot;alpine&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line">3ã€æ ¼å¼åŒ–è¾“å‡ºjsonæ ¼å¼ä¿¡æ¯</span><br><span class="line">[root@docker02 ~]# yum -y install jq</span><br><span class="line">[root@docker02 ~]#  curl -s http://172.16.1.101:5000/v2/_catalog|jq</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;repositories&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;busybox&quot;</span>,</span><br><span class="line">    <span class="string">&quot;nginx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wordpress-manual&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4ã€åˆ é™¤ç§æœ‰ä»“åº“ä¸­çš„é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">1ã€æŸ¥çœ‹æ˜ å°„çš„ç›®å½•</span><br><span class="line">[root@docker01 ~]# docker inspect registry</span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/opt/myregistry&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/var/lib/registry&quot;</span>,</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹/opt/myregistryç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šä¼ åˆ°çš„é•œåƒ</span><br><span class="line">[root@docker01 ~]# ll /opt/myregistry/docker/registry/v2/repositories/</span><br><span class="line">drwxr-xr-x 5 root root 55 Sep  6 16:40 busybox</span><br><span class="line">drwxr-xr-x 5 root root 55 Sep  6 16:32 nginx</span><br><span class="line">drwxr-xr-x 5 root root 55 Sep  6 16:17 wordpress-manual</span><br><span class="line"></span><br><span class="line">3ã€ç”±äºåšäº†æ˜ å°„ï¼Œå°±ä¸éœ€è¦è¿åˆ°å®¹å™¨é‡Œé¢ï¼Œç›´æ¥åœ¨å®¿ä¸»æœºä¸Šåˆ é™¤</span><br><span class="line">[root@docker01 ~]# <span class="built_in">rm</span> -rf /opt/myregistry/docker/registry/v2/repositories/busybox</span><br><span class="line">[root@docker01 ~]# ll /opt/myregistry/docker/registry/v2/repositories/</span><br><span class="line">drwxr-xr-x 5 root root 55 Sep  6 16:32 nginx</span><br><span class="line">drwxr-xr-x 5 root root 55 Sep  6 16:17 wordpress-manual</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# curl -s http://172.16.1.101:5000/v2/_catalog|jq</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;repositories&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;nginx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wordpress-manual&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">4ã€æŸ¥çœ‹æ˜¯å¦ç”ŸæˆblobäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚æœæœ‰å°±åˆ é™¤ï¼Œæ²¡æœ‰ç”Ÿæˆå°±ä¸ç”¨ç®¡</span><br><span class="line">[root@docker01 ~]# ll /etc/docker</span><br><span class="line">-rw-r--r-- 1 root root 219 Sep  6 16:52 daemon.json</span><br><span class="line"></span><br><span class="line">åˆ é™¤æ–¹æ³•ï¼š</span><br><span class="line">registry garbage-collect /etc/docker/registry/config.yml</span><br></pre></td></tr></table></figure><p>5ã€æ‹‰å–é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@docker03 ~]# docker pull 172.16.1.101:5000/wordpress-manual:v1</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ±‡æ€»dockerçš„ç½‘ç»œçš„æ¨¡å¼ï¼Œéƒ¨ç½²å›¾å½¢åŒ–çš„é•œåƒä»“åº“Harborï¼Œå¯¹ä»“åº“è¿›è¡Œä¸€äº›åŸºæœ¬æ“ä½œï¼›éƒ¨ç½²å‘½ä»¤è¡Œçš„ç§æœ‰ä»“åº“registry</summary>
    
    
    
    <category term="docker" scheme="https://www.fomal.cc/categories/docker/"/>
    
    
  </entry>
  
  <entry>
    <title>ğŸ¡ä¸‰ã€Dockeråˆ¶ä½œé•œåƒ</title>
    <link href="https://www.fomal.cc/posts/eb54e23d.html"/>
    <id>https://www.fomal.cc/posts/eb54e23d.html</id>
    <published>2024-09-22T05:00:48.000Z</published>
    <updated>2024-10-02T07:54:37.239Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Dockeråˆ¶ä½œé•œåƒ">Dockeråˆ¶ä½œé•œåƒ</h2><p>Docker å®¹å™¨æ“ä½œçš„é€‰é¡¹</p><table><thead><tr><th>é€‰é¡¹</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>â€“name</td><td>è‡ªå®šä¹‰å®¹å™¨å</td></tr><tr><td>-d</td><td>å°†å®¹å™¨æ”¾åå°å¯åŠ¨</td></tr><tr><td>-it   (input   TTY)</td><td>åˆ†é…ä¸€ä¸ªäº¤äº’å¼çš„ç»ˆç«¯</td></tr><tr><td>-p</td><td>ç«¯å£æ˜ å°„</td></tr><tr><td>-P</td><td>æ˜ å°„éšæœºç«¯å£</td></tr><tr><td>-v</td><td>æ•°æ®å·æ˜ å°„</td></tr><tr><td>-e</td><td>env  æŒ‡å®šç¯å¢ƒå˜é‡</td></tr><tr><td>â€“restart=always</td><td>è®¾ç½®å®¹å™¨å¼€æœºè‡ªå¯ï¼Œdockerå¯åŠ¨å°±è·Ÿç€è‡ªåŠ¨å¯åŠ¨</td></tr><tr><td>â€“link=mysql57</td><td>æŒ‡å®šå¦ä¸€ä¸ªå®¹å™¨çš„åå­—ï¼Œå°±å¯ä»¥å’ŒæŒ‡å®šçš„å®¹å™¨é€šä¿¡</td></tr></tbody></table><p>è¿è¡Œmysqlå®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–mysql5.7.44é•œåƒ</span><br><span class="line">root@docker01 ~]# docker pull mysql:5.7.44</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹å·¥ä½œç›®å½•å’Œç«¯å£</span><br><span class="line">[root@docker01 ~]# docker inspect mysql:5.7.44</span><br><span class="line">            <span class="string">&quot;ExposedPorts&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;3306/tcp&quot;</span>: &#123;&#125;,</span><br><span class="line">                <span class="string">&quot;33060/tcp&quot;</span>: &#123;&#125;</span><br><span class="line">                </span><br><span class="line">            <span class="string">&quot;Volumes&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;/var/lib/mysql&quot;</span>: &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="comment">#rootå¯†ç </span></span><br><span class="line">MYSQL_ROOT_PASSWORD</span><br><span class="line"></span><br><span class="line"><span class="comment"># å»ºåº“</span></span><br><span class="line">MYSQL_DATABASE</span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ›å»ºç”¨æˆ·</span></span><br><span class="line">MYSQL_USER</span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ›å»ºæ™®é€šç”¨æˆ·çš„å¯†ç </span></span><br><span class="line">MYSQL_PASSWORD</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œé•œåƒ</span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wordpress \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line">-v <span class="comment">#æ˜ å°„é…ç½®æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run \</span><br><span class="line">-name some-mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=my-secret-pw \</span><br><span class="line">-d mysql:tag \</span><br><span class="line">--character-set-server=utf8mb4 \</span><br><span class="line">--collation-server=utf8mb4_unicode_ci</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-v /data/wp:/var/www/html \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wordpress \</span><br><span class="line">-d wordpress</span><br><span class="line">ä¸€èˆ¬éƒ½æ˜¯åˆ›å»ºæ™®é€šç”¨æˆ·ï¼Œåšäº†ç«¯å£æ˜ å°„å®¿ä¸»æœºä¹Ÿèƒ½è¿æ¥</span><br><span class="line"></span><br><span class="line">3ã€è¿æ¥è¿›å»</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">exec</span> -it eedc00b /bin/bash</span><br><span class="line">bash-4.2# </span><br><span class="line">bash-4.2# mysql -uroot -p123</span><br><span class="line"></span><br><span class="line">4ã€æŸ¥çœ‹åˆ›å»ºçš„åº“å’Œç”¨æˆ·</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wordpress          |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host from mysql.user;</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| root          | %         |</span><br><span class="line">| wp_user       | %         | <span class="comment">#å®¹å™¨çš„ipæ˜¯å†…å¤–ip,ä¸æŠŠç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šå°±æ²¡äº‹</span></span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">+---------------+-----------+</span><br><span class="line"></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> wp_user@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> wp_user@%                                   |</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;wp_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                    |</span><br><span class="line">| GRANT ALL PRIVILEGES ON `wordpress`.* TO <span class="string">&#x27;wp_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+--------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">4ã€æ˜ å°„çš„ç›®å½•é‡Œé¢æœ‰æ•°æ®</span><br><span class="line">[root@docker01 ~]# ll /data/mysql/</span><br></pre></td></tr></table></figure><h3 id="1ã€æ‰‹åŠ¨åˆ¶ä½œWordPressé•œåƒ">1ã€<strong>æ‰‹åŠ¨åˆ¶ä½œWordPressé•œåƒ</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¸‹è½½wordpressä»£ç åŒ…</span><br><span class="line">[root@docker01 ~]# wget https://cn.wordpress.org/wordpress-5.9.10-zh_CN.tar.gz</span><br><span class="line"></span><br><span class="line">2ã€è¿è¡Œä¸€ä¸ªåŸºç¡€å®¹å™¨</span><br><span class="line">[root@docker01 ~]# docker run --name wp_base -it  centos:7 /bin/bash</span><br><span class="line"></span><br><span class="line">3ã€æ¢æº</span><br><span class="line">[root@3dcd1060f3ab /]#  curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo</span><br><span class="line">[root@3dcd1060f3ab /]#  curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">[root@3dcd1060f3ab /]#sed -i <span class="string">&quot;s@http://mirrors.aliyun.com@https://mirrors.huaweicloud.com@g&quot;</span> /etc/yum.repos.d/epel.repo</span><br><span class="line"></span><br><span class="line">4ã€æ¢phpæº</span><br><span class="line">[root@3dcd1060f3ab /]# <span class="built_in">cat</span> &gt; /etc/yum.repos.d/php.repo &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[php-webtatic]</span></span><br><span class="line"><span class="string">name = PHP Repository</span></span><br><span class="line"><span class="string">baseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/</span></span><br><span class="line"><span class="string">gpgcheck = 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> -e  <span class="string">&quot;[php-webtatic]\nname = PHP Repository\nbaseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/\ngpgcheck = 0&quot;</span>&gt; /etc/yum.repos.d/php.repo</span><br><span class="line"></span><br><span class="line">5ã€å®‰è£…phpã€mysqlã€nginx</span><br><span class="line">[root@nginx ~]# yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb mariadb-server nginx</span><br><span class="line"></span><br><span class="line">6ã€åˆ›å»ºnginxå¯åŠ¨ç”¨æˆ·</span><br><span class="line">[root@3dcd1060f3ab code]# groupadd -g 666 www</span><br><span class="line">[root@3dcd1060f3ab code]# useradd -u 666 -g 666 -s /sbin/nologin -M www</span><br><span class="line"></span><br><span class="line">7ã€ä¼˜åŒ–nginx  php ç»Ÿä¸€ç”¨æˆ·</span><br><span class="line">ä¸»é…ç½®æ–‡ä»¶   (å¦‚æœæ˜¯nginxXå®˜æ–¹æºä¸‹è½½çš„nginxï¼Œå°±ä¸ç”¨ä¼˜åŒ–)</span><br><span class="line">[root@3dcd1060f3ab /]# vi /etc/nginx/nginx.conf</span><br><span class="line">user www;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 4096;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@3dcd1060f3ab ~]# sed -i <span class="string">&#x27;s#user = apache#user = www#g&#x27;</span> /etc/php-fpm.d/www.conf</span><br><span class="line">[root@3dcd1060f3ab ~]# sed -i <span class="string">&#x27;s#group = apache#group = www#g&#x27;</span> /etc/php-fpm.d/www.conf </span><br><span class="line"></span><br><span class="line">8ã€ç¼–å†™ç½‘ç«™ä¸»é…ç½®æ–‡ä»¶</span><br><span class="line">[root@3dcd1060f3ab /]# vi /etc/nginx/conf.d/wp.conf</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name _;</span><br><span class="line">        root /code/wordpress;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">        </span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">             fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">             fastcgi_param SCRIPT_FILENAME $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">             include fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">9ã€åˆ›å»ºç«™ç‚¹ç›®å½•ï¼Œå®¿ä¸»æœºæ–°å¼€çª—å£ä¸Šä¼ ä»£ç åˆ°ç«™ç‚¹ç›®å½•ï¼Œå¹¶è§£å‹ï¼Œæˆæƒ</span><br><span class="line">[root@3dcd1060f3ab /]# <span class="built_in">mkdir</span> /code</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> wordpress-5.9.10.tar.gz  wp_base:/code</span><br><span class="line"></span><br><span class="line">[root@3dcd1060f3ab /]# <span class="built_in">cd</span> /code</span><br><span class="line">[root@3dcd1060f3ab code]# tar xf wordpress-5.9.10.tar.gz </span><br><span class="line">[root@3dcd1060f3ab code]# <span class="built_in">chown</span> -R  www.www /code/</span><br><span class="line"></span><br><span class="line">10ã€å¯åŠ¨æ•°æ®åº“</span><br><span class="line">è™½ç„¶æ˜¯ä¸èƒ½systemdå¯åŠ¨ï¼Œä½†æ˜¯mariadbçš„å¯åŠ¨è„šæœ¬è¿˜æ˜¯åœ¨çš„</span><br><span class="line">[root@3dcd1060f3ab code]# <span class="built_in">cat</span> /usr/lib/systemd/system/mariadb.service </span><br><span class="line"> 35è¡Œï¼šå¯åŠ¨ä¹‹å‰è¦åšåˆå§‹åŒ–ï¼Œæ‰¾åˆ°åˆå§‹åŒ–å‘½ä»¤ </span><br><span class="line"> ExecStartPre=/usr/libexec/mariadb-prepare-db-dir %n</span><br><span class="line"> 38è¡Œï¼šå¯åŠ¨å‘½ä»¤</span><br><span class="line"> ExecStart=/usr/bin/mysqld_safe --basedir=/usr   (å¯ä»¥å¡ä¸»)</span><br><span class="line"> </span><br><span class="line"> [root@3dcd1060f3ab code]# /usr/libexec/mariadb-prepare-db-dir %n</span><br><span class="line"> [root@3dcd1060f3ab code]# /usr/bin/mysqld_safe --basedir=/usr &amp;</span><br><span class="line"> </span><br><span class="line"> 11ã€è¿›å»æ•°æ®åº“åˆ›å»ºåº“ ç”¨æˆ·</span><br><span class="line">[root@3dcd1060f3ab code]# mysql</span><br><span class="line">MariaDB [(none)]&gt; create database wordpress;</span><br><span class="line">MariaDB [(none)]&gt; grant all on *.* to wp_user@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line">12ã€æµ‹è¯•ç”¨æˆ·æ˜¯å¦å¯ä»¥è¿æ¥</span><br><span class="line">[root@3dcd1060f3ab code]# mysql -uwp_user -p123 -h127.0.0.1</span><br><span class="line"></span><br><span class="line">13ã€å¯åŠ¨nginx</span><br><span class="line">[root@3dcd1060f3ab code]# nginx</span><br><span class="line"></span><br><span class="line">14ã€å¯åŠ¨php</span><br><span class="line">æ‰¾åˆ°å¯åŠ¨è„šæœ¬é‡Œé¢çš„å¯åŠ¨å‘½ä»¤</span><br><span class="line">[root@3dcd1060f3ab code]# vi /usr/lib/systemd/system/php-fpm.service </span><br><span class="line"> 9è¡Œ</span><br><span class="line"> ExecStart=/usr/sbin/php-fpm --nodaemonize --fpm-config /etc/php-fpm.conf</span><br><span class="line"> </span><br><span class="line"> --nodaemonizeï¼šå¯ä»¥å¡ä½ï¼Œä¸åŠ å°±æ”¾åå°</span><br><span class="line">[root@3dcd1060f3ab code]# /usr/sbin/php-fpm  --fpm-config /etc/php-fpm.conf</span><br><span class="line"> </span><br><span class="line"> 15ã€curlä¸€ä¸‹ï¼Œèƒ½å¤Ÿæ­£å¸¸è®¿é—®</span><br><span class="line"> [root@3dcd1060f3ab code]# curl -L 127.0.0.1</span><br><span class="line"> ....</span><br><span class="line"> &lt;p&gt;Welcome to WordPress. Before getting started, we need some information on the database. You will need to know the following items before proceeding.&lt;/p&gt;</span><br><span class="line">&lt;ol&gt;</span><br><span class="line">        &lt;li&gt;Database name&lt;/li&gt;     <span class="comment">#å¡«å†™æ•°æ®åº“ä¿¡æ¯çš„é¡µé¢</span></span><br><span class="line">        &lt;li&gt;Database username&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;Database password&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;Database host&lt;/li&gt;</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">16ã€å°†3ä¸ªæœåŠ¡å†™è„šæœ¬å¯åŠ¨ï¼Œå°±ä¸ç”¨ä¸€ä¸ªä¸€ä¸ªå¯åŠ¨äº†</span><br><span class="line">[root@3dcd1060f3ab code]# <span class="built_in">cd</span> ~</span><br><span class="line">[root@3dcd1060f3ab ~]# vi start.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">/sbin/nginx</span><br><span class="line">/usr/sbin/php-fpm  --fpm-config /etc/php-fpm.conf</span><br><span class="line"><span class="comment">#è„šæœ¬é‡Œé¢éœ€è¦å¡ä¸»ä¸€ä¸ªå°±å¯ä»¥ï¼ŒæŠŠmysqlå¡ä½</span></span><br><span class="line">/usr/bin/mysqld_safe --basedir=/usr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">17ã€è¾“å…¥æ­¤æ—¶å¯ä»¥æ‰“åŒ…äº†ï¼Œä½†æ˜¯æ‰“åŒ…å‡ºæ¥çš„é•œåƒå¾ˆå¤§ï¼Œéœ€è¦ä¼˜åŒ–ä¸€ä¸‹</span><br><span class="line">[root@3dcd1060f3ab ~]# <span class="built_in">rm</span> -rf /code/wordpress-5.9.10.tar.gz</span><br><span class="line">[root@3dcd1060f3ab ~]# yum clean all</span><br><span class="line">åˆ é™¤æ‰€æœ‰yumæºï¼Œä»¥åç”¨ä¸åˆ°çš„ï¼Œè¿™ä¸ªå°±æ˜¯wordpress</span><br><span class="line">[root@3dcd1060f3ab ~]# <span class="built_in">rm</span> -rf /etc/yum.repos.d/* </span><br><span class="line">å¦‚æœæœ‰ä¸‹è½½wgetä¸‹è½½ä¸œè¥¿ï¼Œéƒ½è¦å¸è½½æ‰ï¼Œä»¥åç”¨ä¸åˆ°çš„</span><br><span class="line"></span><br><span class="line">18ã€æ‰“å¼€æ–°çª—å£ï¼Œå°†å®¹å™¨æ‰“åŒ…</span><br><span class="line">[root@docker01 ~]# docker commit wp_base wordpress:v1</span><br><span class="line">[root@docker01 ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">wordpress    v1        26586db1eda4   9 seconds ago   615MB</span><br><span class="line"></span><br><span class="line">19ã€è¿è¡Œè¿™ä¸ªå®¹å™¨ï¼Œæµ‹è¯•æ˜¯å¦èƒ½å¤Ÿåœ¨ç½‘é¡µé‡Œé¢è®¿é—®</span><br><span class="line">[root@docker01 ~]# docker run -p 80:80 -d wordpress:v1  /bin/sh ~/start.sh</span><br><span class="line">è„šæœ¬åœ¨å®¹å™¨é‡Œé¢çš„ç»å¯¹è·¯å¾„</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS        PORTS                               NAMES</span><br><span class="line">720febe29da7   wordpress:v1   <span class="string">&quot;/bin/sh /root/startâ€¦&quot;</span>   2 seconds ago   Up 1 second   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   hopeful_wing</span><br><span class="line"></span><br><span class="line">20ã€æµè§ˆå™¨è®¿é—®10.0.0.101</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240904155106974.png" alt="image-20240904155106974"></p><p><img src="../image/study_img/image-20240905192409386.png" alt="image-20240905192409386"></p><p><img src="../image/study_img/image-20240904160154137.png" alt="image-20240904160154137"></p><p><img src="../image/study_img/image-20240904160307363.png" alt="image-20240904160307363"></p><p><img src="../image/study_img/image-20240904160327203.png" alt="image-20240904160327203"></p><p><img src="../image/study_img/image-20240904160430589.png" alt="image-20240904160430589"></p><p><img src="../image/study_img/image-20240904162155815.png" alt="image-20240904162155815"></p><h3 id="2ã€ä½¿ç”¨å®˜æ–¹çš„wordpresså®¹å™¨">2ã€<strong>ä½¿ç”¨å®˜æ–¹çš„wordpresså®¹å™¨</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–wordpresså®¹å™¨</span><br><span class="line">[root@docker02 ~]# docker pull wordpress</span><br><span class="line"></span><br><span class="line">2ã€æ‹‰å–æ•°æ®åº“</span><br><span class="line">[root@docker02 ~]# docker pull mysql:5.7.44</span><br><span class="line"></span><br><span class="line">3ã€#å®˜æ–¹wpå®¹å™¨çš„å¯åŠ¨æ–¹æ³•</span><br><span class="line">[root@docker02 ~]# docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-v /data/wp:/var/www/html \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wordpress \</span><br><span class="line">-d wordpress</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®˜æ–¹mysqlå®¹å™¨çš„å¯åŠ¨æ–¹æ³•</span></span><br><span class="line">[root@docker02 ~]# docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wordpress \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line">4ã€æµè§ˆå™¨è®¿é—®10.0.0.102</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240904164056259.png" alt="image-20240904164056259"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰å¡«å†™æ•°æ®åº“ä¿¡æ¯çš„é˜¶æ®µï¼Œå› ä¸ºåœ¨å¯åŠ¨æ•°æ®åº“ä¹‹å‰å·²ç»ä½¿ç”¨å‚æ•°ä¼ é€’è¿›å»äº†ï¼Œè€Œä¸”ä¸ä¼šå‡ºç°é”™è¯¯ï¼Œä¸ä¼šå‡ºç°ç ´å›¾ï¼Œè¿™ä¸ªæ‰æ˜¯ç”Ÿäº§ä¸­éœ€è¦çš„æ•ˆæœï¼Œéœ€è¦å˜é‡ä¼ é€’å‚æ•°</p><p><img src="../image/study_img/image-20240904164144932.png" alt="image-20240904164144932"></p><h3 id="3ã€æ„å»ºå¯ä»¥ä¼ é€’å‚æ•°çš„é•œåƒ-ï¼ˆæ¨¡æ‹Ÿå®˜æ–¹æ‰“wordpressé•œåƒï¼‰">3ã€<strong>æ„å»ºå¯ä»¥ä¼ é€’å‚æ•°çš„é•œåƒ    ï¼ˆæ¨¡æ‹Ÿå®˜æ–¹æ‰“wordpressé•œåƒï¼‰</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å…ˆäº†è§£è¯»å–ç³»ç»Ÿç¯å¢ƒå˜é‡çš„å‘½ä»¤ï¼šenvsubst</span></span><br><span class="line">[root@docker02 ~]# <span class="built_in">export</span> wp_db_name=wp</span><br><span class="line">[root@docker02 ~]# <span class="built_in">export</span> wp_db_user=wp_user</span><br><span class="line">[root@docker02 ~]# <span class="built_in">echo</span> <span class="variable">$wp_db_name</span></span><br><span class="line">wp</span><br><span class="line">[root@docker02 ~]# <span class="built_in">echo</span> <span class="variable">$wp_db_user</span></span><br><span class="line">wp_user</span><br><span class="line">[root@docker02 ~]# vim 1.txt</span><br><span class="line">define( <span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;$wp_db_name&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;$wp_db_user&#x27;</span> );</span><br><span class="line"></span><br><span class="line">æ‹¿ç¯å¢ƒå˜é‡å»æ¸²æŸ“è¿™ä¸ªæ–‡ä»¶,1.txtä¼šå˜æˆç©ºæ–‡ä»¶</span><br><span class="line">envsubstè¯»å–1.txté‡Œé¢çš„å˜é‡ï¼ŒåŒ¹é…ç¯å¢ƒå˜é‡é‡Œé¢æœ‰æ²¡æœ‰ï¼Œæœ‰çš„è¯ï¼Œè¾“å‡ºæ¸²æŸ“åˆ°2.txt</span><br><span class="line">[root@docker02 ~]# envsubst &lt; 1.txt &gt; 2.txt</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> 2.txt </span><br><span class="line">define( <span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;wp&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;wp_user&#x27;</span> );</span><br><span class="line"></span><br><span class="line">æŒ‡å®šåªæ¸²æŸ“ä¸€ä¸ªå˜é‡ï¼Œæ²¡è¢«æ¸²æŸ“çš„å˜é‡å°±æ˜¯é»˜è®¤çš„</span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> 1.txt </span><br><span class="line">define( <span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;$wp_db_name&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;$wp_db_user&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_PASS&#x27;</span>, <span class="string">&#x27;$wp_db_pass&#x27;</span> );</span><br><span class="line">[root@docker02 ~]# envsubst <span class="string">&#x27;$wp_db_name&#x27;</span> &lt; 1.txt &gt;2.txt </span><br><span class="line">[root@docker02 ~]# <span class="built_in">cat</span> 2.txt </span><br><span class="line">define( <span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;wp&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;$wp_db_user&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_PASS&#x27;</span>, <span class="string">&#x27;$wp_db_pass&#x27;</span> );</span><br><span class="line"></span><br><span class="line">å®¹å™¨é‡Œé¢æ²¡æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œå…ˆæŸ¥è¯¢ä¸€ä¸ªå±äºå“ªä¸ªåŒ…ï¼Œåœ¨å®¹å™¨é‡Œé¢å®‰è£…æœåŠ¡çš„æ—¶å€™ä¸€èµ·å®‰è£…</span><br><span class="line">[root@docker02 ~]# yum provides envsbet</span><br><span class="line">gettext-0.19.8.1-3.el7.x86_64 : GNU libraries and utilities <span class="keyword">for</span> producing multi-lingual messages</span><br></pre></td></tr></table></figure><p>åœ¨docker02    10.0.0.102 æ„å»º     éœ€è¦æŠŠä¹‹å‰å…è®¸çš„å®¹å™¨å…³é—­ï¼Œéœ€è¦æ‰“nginxã€php</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¸‹è½½wordpressä»£ç åŒ…</span><br><span class="line">[root@docker01 ~]# wget https://cn.wordpress.org/wordpress-5.9.10-zh_CN.tar.gz</span><br><span class="line"></span><br><span class="line">1ã€è¿è¡Œä¸€ä¸ªåŸºç¡€å®¹å™¨</span><br><span class="line">[root@docker01 ~]# docker run --name wp_base -it  centos:7 /bin/bash</span><br><span class="line"></span><br><span class="line">2ã€æ¢æº</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">sed -i <span class="string">&quot;s@http://mirrors.aliyun.com@https://mirrors.huaweicloud.com@g&quot;</span> /etc/yum.repos.d/epel.repo</span><br><span class="line"></span><br><span class="line">3ã€æ¢phpæº</span><br><span class="line">[root@3dcd1060f3ab /]# <span class="built_in">cat</span> &gt; /etc/yum.repos.d/php.repo &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[php-webtatic]</span></span><br><span class="line"><span class="string">name = PHP Repository</span></span><br><span class="line"><span class="string">baseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/</span></span><br><span class="line"><span class="string">gpgcheck = 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> -e  <span class="string">&quot;[php-webtatic]\nname = PHP Repository\nbaseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/\ngpgcheck = 0&quot;</span>&gt; /etc/yum.repos.d/php.repo</span><br><span class="line"></span><br><span class="line">4ã€å®‰è£…phpã€nginxã€envsubstå‘½ä»¤</span><br><span class="line">[root@nginx ~]# yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb nginx  gettext</span><br><span class="line"></span><br><span class="line">5ã€åˆ›å»ºnginxå¯åŠ¨ç”¨æˆ·</span><br><span class="line">groupadd -g 666 www</span><br><span class="line">useradd -u 666 -g 666 -s /sbin/nologin -M www</span><br><span class="line"></span><br><span class="line">6ã€ä¼˜åŒ–nginx  php ç»Ÿä¸€ç”¨æˆ·</span><br><span class="line">ä¸»é…ç½®æ–‡ä»¶   (å¦‚æœæ˜¯nginxXå®˜æ–¹æºä¸‹è½½çš„nginxï¼Œå°±ä¸ç”¨ä¼˜åŒ–)</span><br><span class="line">[root@3dcd1060f3ab /]# vi /etc/nginx/nginx.conf</span><br><span class="line">user www;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 4096;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@3dcd1060f3ab ~]# sed -i <span class="string">&#x27;s#user = apache#user = www#g&#x27;</span> /etc/php-fpm.d/www.conf</span><br><span class="line">sed -i <span class="string">&#x27;s#group = apache#group = www#g&#x27;</span> /etc/php-fpm.d/www.conf </span><br><span class="line"></span><br><span class="line">7ã€ç¼–å†™ç½‘ç«™ä¸»é…ç½®æ–‡ä»¶</span><br><span class="line">[root@3dcd1060f3ab /]# vi /etc/nginx/conf.d/wp.conf</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name _;</span><br><span class="line">        root /code/wordpress;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">        </span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">             fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">             fastcgi_param SCRIPT_FILENAME $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">             include fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">8ã€åˆ›å»ºç«™ç‚¹ç›®å½•ï¼Œå®¿ä¸»æœºæ–°å¼€çª—å£ä¸Šä¼ ä»£ç åˆ°ç«™ç‚¹ç›®å½•ï¼Œå¹¶è§£å‹ï¼Œæˆæƒ</span><br><span class="line">[root@3dcd1060f3ab /]# <span class="built_in">mkdir</span> /code</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> wordpress-5.9.10.tar.gz  wp_base:/code</span><br><span class="line">[root@3dcd1060f3ab code]# <span class="built_in">cd</span> /code</span><br><span class="line">[root@3dcd1060f3ab code]# tar xf wordpress-5.9.10.tar.gz </span><br><span class="line">[root@3dcd1060f3ab code]# <span class="built_in">chown</span> -R  www.www /code/</span><br><span class="line"><span class="built_in">chown</span> -R www.www /var/lib/nginx/</span><br><span class="line"></span><br><span class="line">9ã€å¯åŠ¨nginx</span><br><span class="line">[root@3dcd1060f3ab code]# nginx</span><br><span class="line"></span><br><span class="line">10ã€å¯åŠ¨php</span><br><span class="line">æ‰¾åˆ°å¯åŠ¨è„šæœ¬é‡Œé¢çš„å¯åŠ¨å‘½ä»¤</span><br><span class="line">[root@3dcd1060f3ab code]# vi /usr/lib/systemd/system/php-fpm.service </span><br><span class="line"> 9è¡Œ</span><br><span class="line"> ExecStart=/usr/sbin/php-fpm --nodaemonize --fpm-config /etc/php-fpm.conf</span><br><span class="line"> </span><br><span class="line"> --nodaemonizeï¼šå¯ä»¥å¡ä½ï¼Œä¸åŠ å°±æ”¾åå°</span><br><span class="line">[root@3dcd1060f3ab code]# /usr/sbin/php-fpm  --fpm-config /etc/php-fpm.conf</span><br><span class="line"> </span><br><span class="line"> 11ã€curlä¸€ä¸‹ï¼Œèƒ½å¤Ÿæ­£å¸¸è®¿é—®</span><br><span class="line"> [root@3dcd1060f3ab code]# curl -L 127.0.0.1</span><br><span class="line"> ....    <span class="comment">#å¯ä»¥çœ‹åˆ°é€‰ä¸­è¯­è¨€çš„ç•Œé¢</span></span><br><span class="line">&lt;option value=<span class="string">&quot;zh_HK&quot;</span> lang=<span class="string">&quot;zh&quot;</span> data-continue=<span class="string">&quot;ç¹¼çºŒ&quot;</span>&gt;é¦™æ¸¯ä¸­æ–‡&lt;/option&gt;</span><br><span class="line">&lt;option value=<span class="string">&quot;zh_CN&quot;</span> lang=<span class="string">&quot;zh&quot;</span> data-continue=<span class="string">&quot;ç»§ç»­&quot;</span>&gt;ç®€ä½“ä¸­æ–‡&lt;/option&gt;</span><br><span class="line">&lt;option value=<span class="string">&quot;zh_TW&quot;</span> lang=<span class="string">&quot;zh&quot;</span> data-continue=<span class="string">&quot;ç¹¼çºŒ&quot;</span>&gt;ç¹é«”ä¸­æ–‡&lt;/option&gt;</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">12ã€ä¼ å‚ï¼Œä¸è¦æ•°æ®çš„é¡µé¢ï¼Œéœ€è¦ä½¿ç”¨è¯»å–ç³»ç»Ÿç¯å¢ƒå˜é‡çš„å‘½ä»¤envsubst</span><br><span class="line">å°†é…ç½®æ–‡ä»¶æ”¹æˆæ¨¡ç‰ˆæ–‡ä»¶</span><br><span class="line">[root@1925f5794372 code]# vi /code/wordpress/wp-config-sample.php</span><br><span class="line">......</span><br><span class="line"><span class="comment">#æŠŠè¿™å‡ è¡Œæ”¹æˆå˜é‡</span></span><br><span class="line">     23 define( <span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;$WORDPRESS_DB_NAME&#x27;</span> );</span><br><span class="line">     24 </span><br><span class="line">     25 /** Database username */</span><br><span class="line">     26 define( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;$WORDPRESS_DB_USER&#x27;</span> );</span><br><span class="line">     27 </span><br><span class="line">     28 /** Database password */</span><br><span class="line">     29 define( <span class="string">&#x27;DB_PASSWORD&#x27;</span>, <span class="string">&#x27;$WORDPRESS_DB_PASSWORD&#x27;</span> );</span><br><span class="line">     30 </span><br><span class="line">     31 /** Database hostname */</span><br><span class="line">     32 define( <span class="string">&#x27;DB_HOST&#x27;</span>, <span class="string">&#x27;$WORDPRESS_DB_HOST&#x27;</span> );</span><br><span class="line">     </span><br><span class="line"> </span><br><span class="line">sed -i <span class="string">&#x27;s#database_name_here#$WORDPRESS_DB_NAME#g&#x27;</span> /code/wordpress/wp-config-sample.php</span><br><span class="line">sed -i <span class="string">&#x27;s#username_here#$WORDPRESS_DB_USER#g&#x27;</span> /code/wordpress/wp-config-sample.php</span><br><span class="line">sed -i <span class="string">&#x27;s#password_here#$WORDPRESS_DB_PASSWORD#g&#x27;</span> /code/wordpress/wp-config-sample.php</span><br><span class="line">sed -i <span class="string">&#x27;s#localhost#$WORDPRESS_DB_HOST#g&#x27;</span> /code/wordpress/wp-config-sample.php</span><br><span class="line"></span><br><span class="line">13ã€å°†2ä¸ªæœåŠ¡å†™è„šæœ¬å¯åŠ¨ï¼Œå°±ä¸ç”¨ä¸€ä¸ªä¸€ä¸ªå¯åŠ¨äº†</span><br><span class="line">[root@3dcd1060f3ab ~]# vi /start.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#æ¸²æŸ“å˜é‡åˆ°wp-config.php</span></span><br><span class="line">envsubst <span class="string">&#x27;$WORDPRESS_DB_NAME $WORDPRESS_DB_USER $WORDPRESS_DB_PASSWORD $WORDPRESS_DB_HOST&#x27;</span> &lt; /code/wordpress/wp-config-sample.php &gt; /code/wordpress/wp-config.php</span><br><span class="line"><span class="built_in">chown</span> -R  www.www /code/</span><br><span class="line">/usr/sbin/php-fpm  --fpm-config /etc/php-fpm.conf</span><br><span class="line"><span class="comment">#è„šæœ¬é‡Œé¢å¿…é¡»æœ‰ä¸€ä¸ªå¡åœ¨ï¼Œå“ªä¸ªå¡åœ¨éƒ½å¯ä»¥</span></span><br><span class="line">/sbin/nginx -g <span class="string">&#x27;daemon off;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">14ã€è¾“å…¥æ­¤æ—¶å¯ä»¥æ‰“åŒ…äº†ï¼Œä½†æ˜¯æ‰“åŒ…å‡ºæ¥çš„é•œåƒå¾ˆå¤§ï¼Œéœ€è¦ä¼˜åŒ–ä¸€ä¸‹</span><br><span class="line">[root@3dcd1060f3ab ~]# <span class="built_in">rm</span> -rf /code/wordpress-5.9.10.tar.gz</span><br><span class="line">[root@3dcd1060f3ab ~]# yum clean all</span><br><span class="line">åˆ é™¤æ‰€æœ‰yumæºï¼Œä»¥åç”¨ä¸åˆ°çš„ï¼Œè¿™ä¸ªå°±æ˜¯wordpress</span><br><span class="line">[root@3dcd1060f3ab ~]# <span class="built_in">rm</span> -rf /etc/yum.repos.d/* </span><br><span class="line">å¦‚æœæœ‰ä¸‹è½½wgetä¸‹è½½ä¸œè¥¿ï¼Œéƒ½è¦å¸è½½æ‰ï¼Œä»¥åç”¨ä¸åˆ°çš„</span><br><span class="line"></span><br><span class="line">15ã€æ‰“å¼€æ–°çª—å£ï¼Œå°†å®¹å™¨æ‰“åŒ…</span><br><span class="line">[root@docker01 ~]# docker commit wp_base wordpress:v1</span><br><span class="line">[root@docker02 ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">wordpress    v1        23e066cac691   2 seconds ago   586MB</span><br><span class="line"></span><br><span class="line">16ã€åˆ é™¤æ•°æ®åº“æ•°æ®ç›®å½•ï¼Œä¸ç„¶ç¬¬äºŒæ¬¡å¯åŠ¨ä¸èƒ½å»ºåº“ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡çš„æ•°æ®å·²ç»æŒä¹…åŒ–äº†</span><br><span class="line">[root@docker02 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line"></span><br><span class="line">17ã€è¿è¡Œå¸¦å˜é‡çš„å®¹å™¨</span><br><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œwordpresså®¹å™¨</span></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wp_db \</span><br><span class="line">-d wordpress:v3 /bin/sh /start.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„é•œåƒ</span></span><br><span class="line">[root@docker02 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED             STATUS             PORTS                                                  NAMES</span><br><span class="line">71439bdb8066   wordpress:v5   <span class="string">&quot;/bin/sh /start.sh&quot;</span>      5 seconds ago       Up 4 seconds       0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp                      wp</span><br><span class="line">c6eefe3b5358   mysql:5.7.44   <span class="string">&quot;docker-entrypoint.sâ€¦&quot;</span>   49 minutes ago      Up 49 minutes      0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp   mysql57</span><br><span class="line">4f798d07ace2   centos:7       <span class="string">&quot;/bin/bash&quot;</span>              About an hour ago   Up About an hour                                                          wp_base</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">18ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.102</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240904193619359.png" alt="image-20240904193619359"></p><p>é€šè¿‡å¡«å†™æ•°æ®åº“ä¿¡æ¯çš„é¡µé¢ï¼Œç›´æ¥æ¥çš„ä¸»ä»é¡µé¢</p><p><img src="../image/study_img/image-20240904194031698.png" alt="image-20240904194031698"></p><p><strong>æŠ¥é”™é—®é¢˜</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1ã€dockeræ­£å¸¸å¯åŠ¨ï¼Œå®¹å™¨é‡Œé¢çš„æœåŠ¡éƒ½æ­£å¸¸å¯åŠ¨,ç«¯å£æ˜ å°„ä¹Ÿæ²¡é—®é¢˜ï¼Œè®¿é—®ç½‘é¡µæ‰¾ä¸åˆ°é¡µé¢</span></span><br><span class="line">æ˜¯å› ä¸ºå¤–é¢çš„è¯·æ±‚ä¸èƒ½åˆ°åº•å®¹å™¨</span><br><span class="line"></span><br><span class="line"><span class="comment">#è§£å†³åŠæ³•ï¼š</span></span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line">systemctl restart network</span><br><span class="line"></span><br><span class="line"><span class="comment">#2ã€wpç ´å›¾</span></span><br><span class="line">1ã€æŸ¥çœ‹é”™è¯¯æ—¥å¿—</span><br><span class="line">[root@1a60046efc86 wordpress]# tailf /var/log/nginx/error.log </span><br><span class="line">2024/09/05 12:45:49 [crit] 16#16: *432 open() <span class="string">&quot;/var/lib/nginx/tmp/fastcgi/8/01/0000000018&quot;</span> failed (13: Permission denied) <span class="keyword">while</span> reading upstream, client: 10.0.0.1, server: _, request: <span class="string">&quot;GET /wp-admin/site-editor.php?postType=wp_template&amp;postId=twentytwentytwo%2F%2Fhome HTTP/1.1&quot;</span>, upstream: <span class="string">&quot;fastcgi://127.0.0.1:9000&quot;</span>, host: <span class="string">&quot;10.0.0.102&quot;</span>, referrer: <span class="string">&quot;http://10.0.0.102/&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Nginx ä¿®æ”¹äº†é»˜è®¤é…ç½®ï¼Œä¸æ˜¯ä»¥ nginx æˆ– root ç”¨æˆ·æ¥è¿è¡Œ Nginxï¼ˆä¸»è¦çš„åŸå› ï¼‰</span><br><span class="line">è¿™ä¸ªç›®å½•æ²¡æœ‰æƒé™å»è®¿é—®ï¼š/var/lib/nginx/tmp ç›®å½•ä¸»è¦æ˜¯ç”¨æ¥å­˜æ”¾ä¸´æ—¶çš„ç¼“å­˜æ–‡ä»¶ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯ Nginx çš„åå‘ä»£ç†ï¼Œå½“æˆ‘ä»¬ä¸Šä¼ æ–‡ä»¶çš„æ—¶å€™ä¼šå…ˆæŠŠæ–‡ä»¶å†™å…¥ Nginx çš„ /var/lib/nginx/tmp/client_body ç›®å½•ï¼Œç„¶åå†é€šè¿‡ä»£ç†è½¬å‘åˆ°ç›®æ ‡ç³»ç»Ÿã€‚</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹ /var/lib/nginx/tmp çš„æƒé™ï¼Œä¼šå‘ç°è¿™ä¸ªç›®å½•é»˜è®¤çš„æ‰€æœ‰è€…æ˜¯ nginx:</span><br><span class="line">[root@1a60046efc86 wordpress]# ll /var/lib</span><br><span class="line">.....</span><br><span class="line">drwxr-xr-x 2 root root   6 Apr 11  2018 misc</span><br><span class="line">drwxrwx--- 3 nginx root  17 Sep  5 11:52 nginx <span class="comment">#æƒé™ä¸å¯¹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€ä¿®æ”¹æƒé™</span><br><span class="line">[root@1a60046efc86 wordpress]# <span class="built_in">chown</span> -R www.www /var/lib/nginx/</span><br><span class="line">[root@1a60046efc86 wordpress]# ll /var/lib</span><br><span class="line">......</span><br><span class="line">drwxrwx--- 1 www  www   17 Sep  5 11:52 nginx</span><br><span class="line"></span><br><span class="line">4ã€å†æ¬¡è®¿é—®ï¼Œåˆ·æ–°æ…¢ä¸€ç‚¹ï¼ŒåŠ é‡ä¸€ä¸‹ï¼Œå°±ä¸ä¼šç ´å›¾äº†</span><br></pre></td></tr></table></figure><h3 id="4ã€Dockerè‡ªåŠ¨åŒ–æ„å»ºé•œåƒ">4ã€<strong>Dockerè‡ªåŠ¨åŒ–æ„å»ºé•œåƒ</strong></h3><p>æ‰‹åŠ¨æ„å»ºé•œåƒçš„ç¼ºé™·<br>1.ä½“ç§¯å¤ªå¤§<br>2.å¯åŠ¨ä¸æ–¹ä¾¿<br>3.æ— æ³•ç›´æ¥ä¿®æ”¹CMD<br>4.æ²¡æœ‰å£°æ˜ç«¯å£<br>5ã€æ²¡æœ‰å£°æ˜å¯æ˜ å°„ç›®å½•</p><h3 id="5ã€Dockerfileçš„ä»‹ç»">5ã€<strong>Dockerfileçš„ä»‹ç»</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Dockerile æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºé•œåƒçš„æ–‡æœ¬æ–‡ä»¶ï¼Œæ–‡æœ¬å†…å®¹åŒ…å«äº†ä¸€æ¡æ¡æ„å»ºé•œåƒæ‰€éœ€çš„æŒ‡ä»¤å’Œè¯´æ˜ã€‚å£°æ˜å¼çš„è„šæœ¬ï¼Œå°†é•œåƒæ„å»ºå†…å®¹ï¼Œå†™å…¥è„šæœ¬ä¸­å³å¯ã€‚</span><br><span class="line"></span><br><span class="line">é•œåƒ:ä¸­è¯</span><br><span class="line">dockerfileï¼šé…æ–¹</span><br><span class="line">dockerfileï¼šå¸¸ç”¨æŒ‡ä»¤</span><br></pre></td></tr></table></figure><p>dockerfileçš„æŒ‡ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FROMï¼šæŒ‡å®šä¸€ä¸ªåŸºç¡€é•œåƒ</span><br><span class="line">RUNï¼š æŒ‡å®šç³»ç»Ÿå‘½ä»¤</span><br><span class="line">CMDï¼š æŒ‡å®šè¿è¡Œå®¹å™¨PIDä¸º1çš„è¿›ç¨‹å‘½ä»¤   </span><br><span class="line">ENTRYPOINTï¼šæŒ‡å®šè¿è¡Œå®¹å™¨PIDä¸º1çš„è¿›ç¨‹å‘½ä»¤ /bin/sh /start.sh</span><br><span class="line"></span><br><span class="line">ADDï¼š å°†å®¿ä¸»æœºä¸Šé¢çš„æ–‡ä»¶docker <span class="built_in">cp</span>åˆ°å®¹å™¨ä¸­(ä¼šè‡ªåŠ¨è§£å‹ï¼Œä¸€èˆ¬ä¼ å‹ç¼©åŒ…,é‡Œé¢ä¸ä¼šä¼ å‹ç¼©åŒ…ï¼Œä¹‹åä¼ è§£å‹åçš„åŒ…)</span><br><span class="line">COPYï¼šå°†å®¿ä¸»æœºä¸Šé¢çš„æ–‡ä»¶docker <span class="built_in">cp</span>åˆ°å®¹å™¨ä¸­(ä¸ä¼šè‡ªåŠ¨å‹ï¼Œä¸€èˆ¬ä¼ é…ç½®æ–‡ä»¶)</span><br><span class="line">WORKDIRï¼šæŒ‡å®šä¸€ä¸ªå·¥ä½œç›®å½•ï¼Œdocker <span class="built_in">exec</span>è¿æ¥è¿›å»æ—¶ï¼Œè‡ªåŠ¨è¿›å…¥è¯¥ç›®å½•ä¸‹</span><br><span class="line">EXPOSEï¼šå£°æ˜é•œåƒè¦æš´éœ²çš„ç«¯å£</span><br><span class="line">VOLUMEï¼š å£°æ˜å¯æ˜ å°„çš„æ•°æ®å·</span><br><span class="line">ENVï¼šå£°æ˜é»˜è®¤ç¯å¢ƒå˜é‡(sshçš„å¯†ç ,æ•°æ®åº“çš„å¯†ç )é•œåƒçš„å±æ€§æ ‡ç­¾</span><br><span class="line"></span><br><span class="line">LABELï¼šæ‰“æ ‡ç­¾</span><br><span class="line">MAINTAINERï¼šå£°æ˜ç®¡ç†è€…æ ‡è¯†</span><br></pre></td></tr></table></figure><h3 id="6ã€è‡ªåŠ¨åŒ–æ„å»ºwordpress">6ã€<strong>è‡ªåŠ¨åŒ–æ„å»ºwordpress</strong></h3><p>1ã€å‡†å¤‡éœ€è¦çš„é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1ã€è¿è¡Œå¸¦æœ‰é…ç½®æ–‡ä»¶çš„å®¹å™¨ï¼Œè¿›å…¥å®¹å™¨ï¼Œå°†éœ€è¦çš„é…ç½®æ–‡ä»¶æ‹‰å‡ºå»</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">exec</span> -it 40b99669a1 /bin/bash</span><br><span class="line"></span><br><span class="line">2ã€åˆ›å»ºæ‰€éœ€æ–‡ä»¶å­˜æ”¾çš„ç›®å½•</span><br><span class="line">[root@docker01 ~]# <span class="built_in">mkdir</span> -p /code/wordpress/</span><br><span class="line"></span><br><span class="line">3ã€æ‹‰å–å®¹å™¨é‡Œé¢çš„é…ç½®æ–‡ä»¶</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> 40b99669a160:/etc/nginx/nginx.conf /code/wordpress/</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> 40b99669a160:/etc/nginx/conf.d/wp.conf /code/wordpress/ </span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> 40b99669a160:/etc/php-fpm.d/www.conf /code/wordpress/</span><br><span class="line">[root@docker01 ~]# docker <span class="built_in">cp</span> 40b99669a160:/code/wordpress/wp-config-sample.php /code/wordpress/</span><br><span class="line"></span><br><span class="line">4ã€å‡†å¤‡è¿™äº›æ–‡ä»¶,æ£€æŸ¥é…ç½®æ–‡ä»¶éƒ½å®‰è£…æ‰€éœ€è¦æ±‚æ›´æ”¹ok</span><br><span class="line">[root@docker01 ~]# ll /code/wordpress/</span><br><span class="line">-rw-r--r-- 1 root root  724 Sep  5 23:31 nginx.conf</span><br><span class="line">-rw-r--r-- 1 root root  278 Sep  5 20:12 start.sh</span><br><span class="line">-rw-rw-rw- 1 root root  18M Sep  5 23:24 wordpress-5.9.10.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root  324 Sep  5 19:53 wp.conf</span><br><span class="line">-rw-r--r-- 1 root root 3.0K Sep  5 21:39 wp-config-sample.php</span><br><span class="line">-rw-r--r-- 1 root root  18K Sep  5 23:32 www.conf</span><br></pre></td></tr></table></figure><p>2ã€ç¼–å†™Dockerfile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">1ã€ç¼–å†™DockerFile</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cd</span> /code/wordpress/</span><br><span class="line">[root@docker01 wordpress]# vim Dockerfile</span><br><span class="line">FROM centos:7</span><br><span class="line">RUN  curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo</span><br><span class="line">RUN  curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">RUN  sed -i <span class="string">&quot;s@http://mirrors.aliyun.com@https://mirrors.huaweicloud.com@g&quot;</span> /etc/yum.repos.d/epel.repo</span><br><span class="line">RUN  <span class="built_in">echo</span> -e  <span class="string">&quot;[php-webtatic]\nname = PHP Repository\nbaseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/\ngpgcheck = 0&quot;</span>&gt; /etc/yum.repos.d/php.repo</span><br><span class="line">RUN  yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb nginx  gettext</span><br><span class="line">RUN  groupadd -g 666 www</span><br><span class="line">RUN  useradd -u 666 -g 666 -s /sbin/nologin -M www</span><br><span class="line">RUN  <span class="built_in">mkdir</span> /code</span><br><span class="line">COPY nginx.conf /etc/nginx/nginx.conf</span><br><span class="line">COPY www.conf /etc/php-fpm.d/www.conf</span><br><span class="line">COPY wp.conf /etc/nginx/conf.d/wp.conf</span><br><span class="line">ADD  wordpress-5.9.10.tar.gz  /code</span><br><span class="line">COPY wp-config-sample.php /code/wordpress/wp-config-sample.php</span><br><span class="line">RUN  <span class="built_in">chown</span> -R  www.www /code</span><br><span class="line">RUN  <span class="built_in">chown</span> -R www.www /var/lib/nginx</span><br><span class="line">COPY start.sh /start.sh</span><br><span class="line">RUN  <span class="built_in">rm</span> -rf /code/wordpress-5.9.10.tar.gz</span><br><span class="line">RUN  yum clean all</span><br><span class="line">RUN  <span class="built_in">rm</span> -rf /etc/yum.repos.d/* </span><br><span class="line">CMD  [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;/start.sh&quot;</span>]</span><br><span class="line">EXPOSE 80/tcp 8080/tcp</span><br><span class="line">WORKDIR /code/wordpress</span><br><span class="line">VOLUME  /code/wordpress</span><br><span class="line">ENV  WORDPRESS_DB_NAME=wp_db</span><br><span class="line">ENV  WORDPRESS_DB_USER=wp_user</span><br><span class="line">ENV  WORDPRESS_DB_PASSWORD=123</span><br><span class="line">ENV  WORDPRESS_DB_HOST=localhost</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#æ„å»º</span><br><span class="line">[root@docker01 wordpress]# docker build -t wordpress-df:v1 .</span><br><span class="line">[root@docker01 ~]# docker images</span><br><span class="line">REPOSITORY                      TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">wordpress-df                    v1        e389c28d9b3b   14 hours ago    831MB</span><br><span class="line"></span><br><span class="line">3ã€åˆ é™¤æ•°æ®åº“æ•°æ®ç›®å½•ï¼Œä¸ç„¶ç¬¬äºŒæ¬¡å¯åŠ¨ä¸èƒ½å»ºåº“ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡çš„æ•°æ®å·²ç»æŒä¹…åŒ–äº†</span><br><span class="line">[root@docker02 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line"></span><br><span class="line">4ã€è¿è¡Œå¸¦å˜é‡çš„å®¹å™¨</span><br><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œwordpresså®¹å™¨</span></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wp_db \</span><br><span class="line">-d wordpress-df:v1 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.101</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240906135218039.png" alt="image-20240906135218039"></p><p>3ã€ä¼˜åŒ–Dockerfileçš„åŸåˆ™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¼˜åŒ–åŸåˆ™:æ„å»ºçš„é•œåƒå°½å¯èƒ½å°,æ„å»ºé€Ÿåº¦å°½å¯èƒ½å¿«</span></span><br><span class="line">a: ä½¿ç”¨ä½“ç§¯å°çš„linuxé•œåƒalpineä½œä¸ºåŸºç¡€é•œåƒ</span><br><span class="line">bï¼šå°½å¯èƒ½çš„æ¸…ç†æ— ç”¨çš„ç¼“å­˜æ–‡ä»¶ï¼ˆå°½å¯èƒ½æŠŠå¤šä¸ªRUNåˆå¹¶ï¼‰</span><br><span class="line">cï¼šä¿®æ”¹dockerfileçš„æ—¶å€™ï¼Œå°½å¯èƒ½æŠŠä¿®æ”¹çš„å†…å®¹æ”¾åœ¨æœ€å</span><br><span class="line">dï¼šä½¿ç”¨.dockerignoreå¿½ç•¥æ„å»ºdockeré•œåƒæ—¶ï¼Œä¸éœ€è¦çš„æ–‡ä»¶</span><br><span class="line">f:ä½¿ç”¨\å‡å°‘ä¸å¿…è¦çš„æ–‡ä»¶RUNæˆ–ADD</span><br><span class="line"></span><br><span class="line">å±‚æ•°å¤šä¸ä»£è¡¨ä½“ç§¯å¤§ï¼Œå±‚æ•°å¤šå’Œé•œåƒé‡Œé¢çš„æœåŠ¡ï¼Œå‘½ä»¤ï¼Œå®‰è£…åŒ…æœ‰å…³ï¼Œå±‚æ•°å¤šæ˜¯å‘½ä»¤å¤šï¼Œä¸ä¼šè®©æ–‡ä»¶æ•°é‡ï¼Œæ–‡ä»¶å¤§å°å¢åŠ </span><br></pre></td></tr></table></figure><p>4ã€ä¼˜åŒ–Dockerfile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">1ã€ä¼˜åŒ–DockerFile</span><br><span class="line">[root@docker01 ~]# <span class="built_in">cd</span> /code/wordpress/</span><br><span class="line">[root@docker01 wordpress]# vim Dockerfile</span><br><span class="line">FROM centos:7</span><br><span class="line">RUN  curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo &amp;&amp; \</span><br><span class="line">sed -i <span class="string">&quot;s@http://mirrors.aliyun.com@https://mirrors.huaweicloud.com@g&quot;</span> /etc/yum.repos.d/epel.repo &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> -e  <span class="string">&quot;[php-webtatic]\nname = PHP Repository\nbaseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/\ngpgcheck = 0&quot;</span>&gt; /etc/yum.repos.d/php.repo &amp;&amp; \</span><br><span class="line">yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb nginx  gettext &amp;&amp; \</span><br><span class="line">groupadd -g 666 www &amp;&amp; \</span><br><span class="line">useradd -u 666 -g 666 -s /sbin/nologin -M www &amp;&amp; \</span><br><span class="line"><span class="built_in">mkdir</span> /code &amp;&amp; \</span><br><span class="line">yum clean all &amp;&amp; \</span><br><span class="line"><span class="built_in">rm</span> -rf /etc/yum.repos.d/*</span><br><span class="line">COPY nginx.conf /etc/nginx/nginx.conf</span><br><span class="line">COPY www.conf /etc/php-fpm.d/www.conf</span><br><span class="line">COPY wp.conf /etc/nginx/conf.d/wp.conf</span><br><span class="line">ADD  wordpress-5.9.10.tar.gz  /code</span><br><span class="line">COPY wp-config-sample.php /code/wordpress/wp-config-sample.php</span><br><span class="line">RUN  <span class="built_in">chown</span> -R  www.www /code &amp;&amp; \</span><br><span class="line"><span class="built_in">chown</span> -R www.www /var/lib/nginx</span><br><span class="line">COPY start.sh /start.sh</span><br><span class="line">CMD  [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;/start.sh&quot;</span>]</span><br><span class="line">EXPOSE 80/tcp 8080/tcp</span><br><span class="line">WORKDIR /code/wordpress</span><br><span class="line">VOLUME  /code/wordpress</span><br><span class="line">ENV  WORDPRESS_DB_NAME=wp_db</span><br><span class="line">ENV  WORDPRESS_DB_USER=wp_user</span><br><span class="line">ENV  WORDPRESS_DB_PASSWORD=123</span><br><span class="line">ENV  WORDPRESS_DB_HOST=localhost</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2ã€#æ„å»º</span><br><span class="line">[root@docker01 wordpress]# docker build -t wordpress-df:v1 .</span><br><span class="line">[root@docker01 ~]# docker images</span><br><span class="line">REPOSITORY                      TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">wordpress-df                    v2        1a14add5916b   11 seconds ago   530MB</span><br><span class="line"></span><br><span class="line">3ã€åˆ é™¤æ•°æ®åº“æ•°æ®ç›®å½•ï¼Œä¸ç„¶ç¬¬äºŒæ¬¡å¯åŠ¨ä¸èƒ½å»ºåº“ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡çš„æ•°æ®å·²ç»æŒä¹…åŒ–äº†</span><br><span class="line">[root@docker02 ~]# <span class="built_in">rm</span> -rf /data</span><br><span class="line"></span><br><span class="line">4ã€è¿è¡Œå¸¦å˜é‡çš„å®¹å™¨</span><br><span class="line"><span class="comment">#è¿è¡Œæ•°æ®åº“</span></span><br><span class="line">docker run \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=wp_db \</span><br><span class="line">-e MYSQL_USER=wp_user \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:5.7.44</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œwordpresså®¹å™¨</span></span><br><span class="line">docker run \</span><br><span class="line">--name wp \</span><br><span class="line">--<span class="built_in">link</span> mysql57 \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-e WORDPRESS_DB_HOST=mysql57 \</span><br><span class="line">-e WORDPRESS_DB_USER=wp_user \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=123 \</span><br><span class="line">-e WORDPRESS_DB_NAME=wp_db \</span><br><span class="line">-d wordpress-df:v2 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5ã€æµè§ˆå™¨è®¿é—®</span><br><span class="line">10.0.0.101</span><br></pre></td></tr></table></figure><h3 id="7ã€åˆ¶ä½œzabbixé•œåƒ">7ã€<strong>åˆ¶ä½œzabbixé•œåƒ</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">1ã€æ‹‰å–ç›¸å…³é•œåƒ</span><br><span class="line">[root@docker01 ~]#  docker pull zabbix/zabbix-server-mysql</span><br><span class="line">[root@docker01 ~]#  docker pull zabbix/zabbix-web-nginx-mysql</span><br><span class="line">[root@docker01 ~]#  docker pull mysql:8.0</span><br><span class="line"></span><br><span class="line">2ã€#è¿è¡Œæ•°æ®åº“</span><br><span class="line">æ³¨æ„ï¼šå†æ¬¡å¯åŠ¨æ•°æ®åº“ä¹‹å‰å…ˆæ¸…ç©ºdataç›®å½•</span><br><span class="line"><span class="built_in">rm</span> -rf /data/mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run \</span><br><span class="line">--name mysql80 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123 \</span><br><span class="line">-e MYSQL_DATABASE=zabbix \</span><br><span class="line">-e MYSQL_USER=zabbix \</span><br><span class="line">-e MYSQL_PASSWORD=123 \</span><br><span class="line">--restart=always \</span><br><span class="line">-d mysql:8.0 \</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--character-set-server=utf8mb4 </span><br><span class="line">--collation-server=utf8mb4_bin </span><br><span class="line">--log_bin_trust_function_creators</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3ã€yunxå®¹å™¨åŒ–zabbix-server</span><br><span class="line">docker run \</span><br><span class="line">--<span class="built_in">link</span> mysql80 \</span><br><span class="line">--name zabbix-server \</span><br><span class="line">-p 10051:10051 \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">&quot;mysql80&quot;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&quot;123&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-server-mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4ã€å®¹å™¨åŒ–zabbix-web</span><br><span class="line">docker run \</span><br><span class="line">--<span class="built_in">link</span> zabbix-server \</span><br><span class="line">--<span class="built_in">link</span> mysql80 \</span><br><span class="line">--name zabbix-web \</span><br><span class="line">-p 80:8080 \</span><br><span class="line">-p 8443:8443 \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">&quot;mysql80&quot;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&quot;123&quot;</span> \</span><br><span class="line">-e ZBX_SERVER_HOST=<span class="string">&quot;zabbix-server&quot;</span> \</span><br><span class="line">-e PHP_TZ=<span class="string">&quot;Asia/Shanghai&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-web-nginx-mysql</span><br><span class="line"></span><br><span class="line">5ã€æ£€æŸ¥3ä¸ªå®¹å™¨æ˜¯å¦èµ·æ¥</span><br><span class="line">[root@docker01 ~]# docker ps </span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905101309249.png" alt="image-20240905101309249"></p><p><img src="../image/study_img/image-20240905100315171.png" alt="image-20240905100315171"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å‡ºç°ä»¥ä¸ŠæŠ¥é”™å°±æ˜¯mysql8.0å¯åŠ¨å‘½ä»¤åŠ å‚æ•°</span><br><span class="line">--log_bin_trust_funetion</span><br></pre></td></tr></table></figure><p><img src="../image/study_img/image-20240905143325160.png" alt="image-20240905143325160"></p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡æ±‡æ€»å¯¹é•œåƒçš„å¤šç§åˆ¶ä½œæ–¹æ³•ï¼Œè¿˜æ±‡æ€»ä½¿ç”¨dockerfileæ„å»ºé•œåƒï¼Œå¯¹é•œåƒçš„ä¼˜åŒ–</summary>
    
    
    
    <category term="docker" scheme="https://www.fomal.cc/categories/docker/"/>
    
    
  </entry>
  
</feed>
